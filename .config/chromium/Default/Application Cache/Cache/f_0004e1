/*
 * Copyright (c) 2014 Amazon.com, Inc. All rights reserved.
 */
function KindleModuleManagerFactory(){function h(a,c){if(r[a])throw"Duplicate registration of module "+a;if(!c)throw"Module is not initialized with an object "+a;r[a]=c;o[a].resolve(c)}function j(a){if(r.hasOwnProperty(a))throw"Duplicate registration of module "+a;r[a]=void 0}function e(a,c){o[a]||(o[a]=new jQuery.Deferred);h(a,c)}function d(a,c){j(a);o[a]||(o[a]=new jQuery.Deferred);c(o[a]);o[a].done(function(c){h(a,c)})}function c(a,c){d(a,function(a){c.done(a.resolve).fail(a.reject)})}function b(a){o[a]||
(o[a]=new jQuery.Deferred);return o[a].promise()}function f(a){if(!r[a])throw"Trying to get uninitialized module "+a;return r[a]}function a(a){return r.hasOwnProperty(a)}function g(a,c){r[a]=c}function k(a){var c=r[a];return{done:function(a){a(c)},fail:function(){},when:function(a){a(c)}}}function m(a){for(var c={},b=0;b<a.length;b++)c[name]=r[a];return{done:function(a){a(c)},fail:function(){},when:function(a){a(c)}}}function l(){r={}}var n={CONSTANTS:"Constants",DB_CLIENT:"DBClient",RESOURCE_BUNDLE:"ResourceBundle",
METRICS_MANAGER:"metrics_manager",SERVICE_CLIENT:"ServiceClient",APP_REGISTRATION:"Registration",JOURNAL_MANAGER:"JournalManager",BOOK_METADATA:"book_metaData",BOOK_FRAGMAP:"book_fragmap",EMBEDDED_HOSTINTERFACE:"embeddedHostInterface",CONTENT_MIGRATION:"contentMigration",NETWORK:"network",LINK_URLS:"linkUrls"},r={},o={};return{CONSTANTS:n.CONSTANTS,DB_CLIENT:n.DB_CLIENT,RESOURCE_BUNDLE:n.RESOURCE_BUNDLE,METRICS_MANAGER:n.METRICS_MANAGER,SERVICE_CLIENT:n.SERVICE_CLIENT,APP_REGISTRATION:n.APP_REGISTRATION,
JOURNAL_MANAGER:n.JOURNAL_MANAGER,BOOK_METADATA:n.BOOK_METADATA,BOOK_FRAGMAP:n.BOOK_FRAGMAP,EMBEDDED_HOSTINTERFACE:n.EMBEDDED_HOSTINTERFACE,CONTENT_MIGRATION:n.CONTENT_MIGRATION,NETWORK:n.NETWORK,LINK_URLS:n.LINK_URLS,ERROR_CODE_CANCEL:"canceled",registerModule:e,registerModuleList:function(a){for(var c in a)e(c,a[c])},registerModuleWithInitializer:d,registerModuleWithDeferred:c,detachModule:function(a){var c=r[a],b=o[a];b&&!b.isResolved()&&b.reject("canceled");delete r[a];delete o[a];return c},getModule:b,
getModuleList:function(a){var c=new jQuery.Deferred,g,f=[];for(g=0;g<a.length;g++)f.push(b(a[g]));$.when.apply($,f).done(function(){var b,g={};for(b=0;b<a.length;b++)g[a[b]]=arguments[b];c.resolve(g)}).fail(c.reject);return c.promise()},getModuleSync:f,isModuleInitialized:function(a){return r[a]!==void 0},isModuleRegistered:a,switchToTestMode:function(){this.registerModuleTest=g;this.getModule=k;this.getModuleSync=f;this.getModuleList=m;this.clear=l;delete this.registerModuleWithDeferred;delete this.registerModuleWithInitializer},
define:function(g,f,d){if(!a(g)){var k=[],e=$.Deferred();c(g,e);f&&f.length&&f.forEach(function(a){k.push(a&&$.isFunction(a.promise)?a:b(a))});$.when.apply($,k).then(function(){var a;typeof d==="function"?(a=$.makeArray(arguments),a=d.apply(d,a)):a=d;a&&$.isFunction(a.promise)?a.then(e.resolve,function(){e.reject()}):e.resolve(a)},function(){e.reject()})}},require:function(a,c){$.isArray(a)||(a=[a]);var g,f,d=[];a.forEach(function(a){d.push(a&&$.isFunction(a.promise)?a:b(a))});c||(f=$.Deferred(),
g=f.promise());$.when.apply($,d).then(function(){var a=$.makeArray(arguments);c?c.apply(c,a):f.resolve.apply(f,a)},function(){f&&f.reject()});return g}}}var KindleModuleManager=KindleModuleManagerFactory();
(function(){var h=Handlebars.template,j=Handlebars.templates=Handlebars.templates||{};j["Embedded/KindleReaderHeaderBar"]=h(function(e,d,c,b,f){this.compilerInfo=[2,">= 1.0.0-rc.3"];var c=c||e.helpers,f=f||{},e="",a,g=c.helperMissing,k=this.escapeExpression;e+="<div id='kindleReader_header' class='immersive_slide_area'>\n    <div id='kindleReader_header_left'>\n        <div id=\"kindleReader_kindleLogo_embedded\" class=\"kindleReader_kindleLogo\"\n            tabindex = 1;\n            data-action='reader_open_full_kcr'\n            title='";b=
{hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_R_embedded_logo_tooltip",b):g.call(d,"str","k_R_embedded_logo_tooltip",b)))+"'\n        ></div>\n\n        <div class=\"readerControls\">\n\n            <div\n                id='kindleReader_button_goto'\n                class='header_bar_icon disabled'\n                title='";b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_R_menuButton_goto_tooltip",b):g.call(d,"str","k_R_menuButton_goto_tooltip",b)))+"'\n                tabindex = 1;\n                data-action='reader_show_goto'\n            ></div>\n\n            <div\n                id='kindleReader_button_controlPanel'\n                class='header_bar_icon disabled'\n                title='";
b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_R_menuButton_controlPane_tooltip",b):g.call(d,"str","k_R_menuButton_controlPane_tooltip",b)))+"'\n                tabindex = 1;\n                data-action='reader_show_settings'\n            ></div>\n\n            <div\n                id='kindleReader_bookmark'\n                class='header_bar_icon disabled'\n                title='";b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_R_menuButton_bookmark_tooltip",b):g.call(d,"str","k_R_menuButton_bookmark_tooltip",
b)))+"'\n                tabindex = 1;\n                data-action='reader_bookmark'\n            ></div>\n\n            <div\n                id='kindleReader_button_note'\n                class='header_bar_icon disabled'\n                title='";b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_R_menuButton_notesAndMarks_tooltip",b):g.call(d,"str","k_R_menuButton_notesAndMarks_tooltip",b)))+"'\n                tabindex = 1;\n                data-action='reader_show_notes'\n            ></div>\n        </div>\n    </div>\n    <div id='kindleReader_header_right'>\n        <div id='readerControlsRight' class='readerControls'>\n            <div id='kindleReader_sitb' class='disabled'>\n                <div id='kindleReader_input_sitb'>\n                    <input id='kindleReader_input_sitb_box' type='text' tabindex = 1 />\n                    <div id='kindleReader_input_sitb_clear'></div>\n                </div>\n                <button id='kindleReader_button_sitb' class='header_bar_button' tabindex = 1 value='' data-action='reader_search'/>\n            </div>\n        </div>\n    </div>\n</div>";
return e});j.KindleAnnotationComponentFactory=h(function(e,d,c,b,f){this.compilerInfo=[2,">= 1.0.0-rc.3"];var c=c||e.helpers,f=f||{},e="",a,g=this.escapeExpression,k=c.helperMissing;e+="<div id='";(b=c.id)?b=b.call(d,{hash:{},data:f}):(b=d.id,b=typeof b==="function"?b.apply(d):b);e+=g(b)+'\' class="kindleReader_annotation_pane_notes clearfix" >\n    <p class="kindleReader_annotation_pane_notes_context">     \n    </p>\n    <p>\n    <textarea\n        id="kindleReader_annotation_pane_edit_textArea"\n        rows="10"\n        maxlength="';
(b=c.maxNoteChars)?b=b.call(d,{hash:{},data:f}):(b=d.maxNoteChars,b=typeof b==="function"?b.apply(d):b);e+=g(b)+'"\n        >';(b=c.context)?b=b.call(d,{hash:{},data:f}):(b=d.context,b=typeof b==="function"?b.apply(d):b);e+=g(b)+'</textarea>\n    </p>\n    <div class="kindleReader_annotation_pane_notes_metadata_container clearfix">\n        <div class="kindleReader_annotation_pane_icon"></div>\n        <label class="kindleReader_annotation_pane_notes_pageLabel">';(b=c.pageLabel)?b=b.call(d,{hash:{},
data:f}):(b=d.pageLabel,b=typeof b==="function"?b.apply(d):b);e+=g(b)+'</label>\n        <input type="hidden" name="kindleReader_annotation_pane_notes_start" value=';(b=c.start)?b=b.call(d,{hash:{},data:f}):(b=d.start,b=typeof b==="function"?b.apply(d):b);e+=g(b)+'/>\n        \n        <span class="kindleReader_annotation_pane_notes_trashcan kindleReader_annotation_pane_action_btn" title=\'';a={hash:{},data:f};e+=g((b=c.str,b?b.call(d,"k_R_annotation_pane_delete",a):k.call(d,"str","k_R_annotation_pane_delete",
a)))+"'></span>\n        <span class=\"kindleReader_annotation_pane_notes_goto kindleReader_annotation_pane_action_btn\" title='";a={hash:{},data:f};e+=g((b=c.str,b?b.call(d,"k_R_annotation_pane_goto",a):k.call(d,"str","k_R_annotation_pane_goto",a)))+"'></span>\n        <span class=\"kindleReader_annotation_pane_notes_edit kindleReader_annotation_pane_action_btn\" title='";a={hash:{},data:f};e+=g((b=c.str,b?b.call(d,"k_R_annotation_pane_edit",a):k.call(d,"str","k_R_annotation_pane_edit",a)))+"'></span>\n        <div class=\"kindleReader_annotation_pane_notes_save kindleReader_annotation_pane_notes_button kindleReader_annotation_pane_action_btn\" title='";
a={hash:{},data:f};e+=g((b=c.str,b?b.call(d,"k_R_annotation_pane_save",a):k.call(d,"str","k_R_annotation_pane_save",a)))+"'>";a={hash:{},data:f};e+=g((b=c.str,b?b.call(d,"k_R_dialog_editNote_save",a):k.call(d,"str","k_R_dialog_editNote_save",a)))+'</div>\n        <div class="kindleReader_annotation_pane_notes_cancel kindleReader_annotation_pane_notes_button kindleReader_annotation_pane_action_btn" title=\'';a={hash:{},data:f};e+=g((b=c.str,b?b.call(d,"k_R_annotation_pane_cancel",a):k.call(d,"str",
"k_R_annotation_pane_cancel",a)))+"'>";a={hash:{},data:f};e+=g((b=c.str,b?b.call(d,"k_R_dialog_editNote_cancel",a):k.call(d,"str","k_R_dialog_editNote_cancel",a)))+'</div>\n        <div class="kindleReader_annotation_pane_notes_yes kindleReader_annotation_pane_notes_button kindleReader_annotation_pane_action_btn" title=\'';a={hash:{},data:f};e+=g((b=c.str,b?b.call(d,"k_R_annotation_pane_delete",a):k.call(d,"str","k_R_annotation_pane_delete",a)))+"'>";a={hash:{},data:f};e+=g((b=c.str,b?b.call(d,"k_R_annotation_pane_yes",
a):k.call(d,"str","k_R_annotation_pane_yes",a)))+'</div>\n        <div class="kindleReader_annotation_pane_notes_no kindleReader_annotation_pane_notes_button kindleReader_annotation_pane_action_btn" title=\'';a={hash:{},data:f};e+=g((b=c.str,b?b.call(d,"k_R_annotation_pane_dont_delete",a):k.call(d,"str","k_R_annotation_pane_dont_delete",a)))+"'>";a={hash:{},data:f};e+=g((b=c.str,b?b.call(d,"k_R_annotation_pane_no",a):k.call(d,"str","k_R_annotation_pane_no",a)))+'</div>\n        <span class="kindleReader_annotation_notes_delete_confirm">';
a={hash:{},data:f};e+=g((b=c.str,b?b.call(d,"k_R_annotation_pane_delete_confirm",a):k.call(d,"str","k_R_annotation_pane_delete_confirm",a)))+'</span>\n    </div>\n        \n\n</div>\n<div class="kindleReader_annotation_pane_notes_divider_top"></div>\n<div class="kindleReader_annotation_pane_notes_divider_bottom"></div>';return e});j.KindleImageViewer=h(function(e,d,c,b,f){this.compilerInfo=[2,">= 1.0.0-rc.3"];c=c||e.helpers;f=f||{};e="";b=this.escapeExpression;e+='<div class="imageViewerBackdrop">\n    <img class="imageViewerImage" src=';
(c=c.imageSource)?c=c.call(d,{hash:{},data:f}):(c=d.imageSource,c=typeof c==="function"?c.apply(d):c);e+=b(c)+"></img>\n</div>";return e});j.KindleReaderAnnotationsPane=h(function(e,d,c,b,f){this.compilerInfo=[2,">= 1.0.0-rc.3"];var c=c||e.helpers,f=f||{},e="",a,g=c.helperMissing,k=this.escapeExpression;e+='<div id="kindleReader_annotations_pane">\n    <div id="kindleReader_annotations_pane_header">';b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_R_dialog_annotation_pane_title",b):g.call(d,"str",
"k_R_dialog_annotation_pane_title",b)))+'</div>\n    <div id="kindleReader_annotations_pane_scrollWrapper">\n        <div id="kindleReader_annotations_pane_container"></div>\n    </div>\n    <div id="kindleReader_annotations_pane_notes_empty">';b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_R_annotation_pane_empty_note",b):g.call(d,"str","k_R_annotation_pane_empty_note",b)))+"</div>\n</div>";return e});j.KindleReaderBookmarkOverlay=h(function(){this.compilerInfo=[2,">= 1.0.0-rc.3"];return'<div id=\'bookmark_overlay_div\' class="immersive_slide_area" data-action="reader_bookmark" ></div>'});
j.KindleReaderBuyButton=h(function(e,d,c,b,f){this.compilerInfo=[2,">= 1.0.0-rc.3"];var c=c||e.helpers,f=f||{},e="",a,b=c.helperMissing,g=this.escapeExpression;e+='<div id="kindleReader_Buy_Full_Button" tabindex="2" data-action=\'reader_buy_full_book\'>\n\t';f={hash:{},data:f};e+=g((a=c.str,a?a.call(d,"k_endOfSample_buy_button",f):b.call(d,"str","k_endOfSample_buy_button",f)))+"\n</div>";return e});j.KindleReaderContextMenu=h(function(){this.compilerInfo=[2,">= 1.0.0-rc.3"];return'<div id="kindleReader_menu_contextMenu">\n    <div id="kindle_menu_loading" class="dictionary_loading"/>\n    <div id="kindle_menu_border"/>\n</div>'});
j.KindleReaderContextMenuDictionaryDotCom=h(function(e,d,c,b,f){this.compilerInfo=[2,">= 1.0.0-rc.3"];var c=c||e.helpers,f=f||{},e="",a=this.escapeExpression;e+='<div class="dictionary"> \n    <div class="term"> \n        <span class="entry">';(b=c.entry)?b=b.call(d,{hash:{},data:f}):(b=d.entry,b=typeof b==="function"?b.apply(d):b);e+=a(b)+'</span><span class="audio" id="dictionary_audio"></span><span class="pronunciation">';(b=c.pronunciation)?b=b.call(d,{hash:{},data:f}):(b=d.pronunciation,b=typeof b===
"function"?b.apply(d):b);if(b||b===0)e+=b;e+='</span><br/>\n    </div> \n    <div class="definition">';(b=c.definition)?b=b.call(d,{hash:{},data:f}):(b=d.definition,b=typeof b==="function"?b.apply(d):b);if(b||b===0)e+=b;e+='</div>  \n    <div class="reference"><a class="view_full_link" href="';(b=c.view_full_url)?b=b.call(d,{hash:{},data:f}):(b=d.view_full_url,b=typeof b==="function"?b.apply(d):b);e+=a(b)+'" target="_blank"><span class="view_full">';(b=c.view_full)?b=b.call(d,{hash:{},data:f}):(b=
d.view_full,b=typeof b==="function"?b.apply(d):b);e+=a(b)+'</span><span class="view_full_logo"></span></a></div>\n</div>';return e});j.KindleReaderDictionary=h(function(e,d,c,b,f){this.compilerInfo=[2,">= 1.0.0-rc.3"];var c=c||e.helpers,f=f||{},e="",a=this.escapeExpression;if((b=c["if"].call(d,d.isForContextMenu,{hash:{},inverse:this.program(3,function(){return'\n    <div class="dictionary i18n full_definition">\n'},f),fn:this.program(1,function(){return'\n    <div class="dictionary i18n">\n'},f),
data:f}))||b===0)e+=b;e+='\n        <div id="dictionaryList" class="dictionaryList">';(b=c.dictionaryUsed)?b=b.call(d,{hash:{},data:f}):(b=d.dictionaryUsed,b=typeof b==="function"?b.apply(d):b);if(b||b===0)e+=b;e+="\n            ";if((b=c["if"].call(d,d.dictionaryListMenuEnabled,{hash:{},inverse:this.noop,fn:this.program(5,function(){return'\n            <span class="downArrow"></span>\n            '},f),data:f}))||b===0)e+=b;e+="\n        </div>\n\n        ";if((b=c["if"].call(d,d.isForContextMenu,
{hash:{},inverse:this.program(9,function(){return'\n            <div id="kindleReader_dictionary_scrollWrapper">\n                <div id="kindleReader_full_definition_scrollContainer" class="dictionaryMain"/>\n            </div>\n        '},f),fn:this.program(7,function(){return'\n            <div class="dictionaryMain contextMenu"/>\n        '},f),data:f}))||b===0)e+=b;e+="\n        \n        ";if((b=c["if"].call(d,d.view_full,{hash:{},inverse:this.noop,fn:this.program(11,function(b,f){var d="",
e;d+='\n        <div class="reference"><a class="view_full_link" href="" target="_blank"><span class="view_full">';(e=c.view_full)?e=e.call(b,{hash:{},data:f}):(e=b.view_full,e=typeof e==="function"?e.apply(b):e);d+=a(e)+'</span><span class="rightArrow"></span></a></div>\n        ';return d},f),data:f}))||b===0)e+=b;e+="\n    </div>";return e});j.KindleReaderDictionaryDefinitions=h(function(e,d,c,b,f){function a(a,b){var f="",d;f+="\n                ";if((d=c["if"].call(a,a.partOfSpeech,{hash:{},
inverse:G.noop,fn:G.program(3,g,b),data:b}))||d===0)f+=d;f+="\n                ";if((d=c["if"].call(a,a.ipa,{hash:{},inverse:G.noop,fn:G.program(5,k,b),data:b}))||d===0)f+=d;f+='\n                <ul class="definitions_list content">\n                    ';if((d=c.each.call(a,a.definitions,{hash:{},inverse:G.noop,fn:G.program(7,m,b),data:b}))||d===0)f+=d;f+="\n                </ul>\n            ";return f}function g(a){var r;var c="",b;c+='\n                <span class="word_type">';if((r=(b=a.partOfSpeech,
typeof b===J?b.apply(a):b),a=r)||a===0)c+=a;c+="</span>\n                ";return c}function k(a){var r;var c="",b;c+='\n                <span class="ipa">';if((r=(b=a.ipa,typeof b===J?b.apply(a):b),a=r)||a===0)c+=a;c+="</span>\n                ";return c}function m(a,b){var f="",g,d;f+="\n                        ";if((g=c["if"].call(a,a.context,{hash:{},inverse:G.noop,fn:G.program(8,l,b),data:b}))||g===0)f+=g;f+="\n                        <li>";if((d=(g=a.definition,typeof g===J?g.apply(a):g))||
d===0)f+=d;f+="</li>\n                        ";if((d=c["if"].call(a,a.info,{hash:{},inverse:G.noop,fn:G.program(10,n,b),data:b}))||d===0)f+=d;f+="\n\n                        ";if((d=c["if"].call(a,a.subDefinitions,{hash:{},inverse:G.noop,fn:G.program(12,h,b),data:b}))||d===0)f+=d;f+="\n                        ";if((d=c["if"].call(a,a.orthography,{hash:{},inverse:G.noop,fn:G.program(15,q,b),data:b}))||d===0)f+=d;f+="\n                        ";if((d=c["if"].call(a,a.morphology,{hash:{},inverse:G.noop,
fn:G.program(17,t,b),data:b}))||d===0)f+=d;f+="\n                    ";return f}function l(a){var r;var c="",b;c+="\n                        <li>\n                            <ul>        \n                                <li>";if((r=(b=a.context,typeof b===J?b.apply(a):b),a=r)||a===0)c+=a;c+="</li>\n                            </ul>\n                        </li>\n                        ";return c}function n(a){var r;var c="",b;c+="\n                        <li>\n                            <ul>        \n                                <li>";
if((r=(b=a.info,typeof b===J?b.apply(a):b),a=r)||a===0)c+=a;c+="</li>\n                            </ul>\n                        </li>\n                        ";return c}function h(a,b){var f="",g;f+="\n                        <li>\n                            <ul>\n                                ";if((g=c.each.call(a,a.subDefinitions,{hash:{},inverse:G.noop,fn:G.program(13,o,b),data:b}))||g===0)f+=g;f+="\n                            </ul>\n                        </li>\n                        ";
return f}function o(a){var c="";c+="\n                                <li>";if((a=typeof a===J?a.apply(a):a)||a===0)c+=a;c+="</li>\n                                ";return c}function q(a){var r;var c="",b;c+="\n                        <li>\n                            <ul>        \n                                <li>";if((r=(b=a.orthography,typeof b===J?b.apply(a):b),a=r)||a===0)c+=a;c+="</li>\n                            </ul>\n                        </li>\n                        ";return c}
function t(a){var r;var c="",b;c+="\n                        <li>\n                            <ul>        \n                                <li>";if((r=(b=a.morphology,typeof b===J?b.apply(a):b),a=r)||a===0)c+=a;c+="</li>\n                            </ul>\n                        </li>\n                        ";return c}function s(a,b){var f="",g;f+="\n            ";if((g=c["if"].call(a,a.origin,{hash:{},inverse:G.noop,fn:G.program(20,u,b),data:b}))||g===0)f+=g;f+="\n\n            ";if((g=c["if"].call(a,
a.derivatives,{hash:{},inverse:G.noop,fn:G.program(26,j,b),data:b}))||g===0)f+=g;f+="\n\n            ";if((g=c["if"].call(a,a.usage,{hash:{},inverse:G.noop,fn:G.program(28,C,b),data:b}))||g===0)f+=g;f+="\n\n            ";if((g=c["if"].call(a,a.ipa,{hash:{},inverse:G.noop,fn:G.program(30,I,b),data:b}))||g===0)f+=g;f+="\n            \n            ";if((g=c["if"].call(a,a.relatedWords,{hash:{},inverse:G.noop,fn:G.program(32,z,b),data:b}))||g===0)f+=g;f+="\n            \n            ";if((g=c["if"].call(a,
a.morphology,{hash:{},inverse:G.noop,fn:G.program(35,w,b),data:b}))||g===0)f+=g;f+="\n\n            ";if((g=c["if"].call(a,a.phrases,{hash:{},inverse:G.noop,fn:G.program(37,E,b),data:b}))||g===0)f+=g;f+="\n        ";return f}function u(a,b){var f="",g,d;f+="\n                \n                <div>"+V((g=(g=a.labels,g==null||g===!1?g:g.Origin),typeof g===J?g.apply(a):g))+"</div>\n                ";if((d=c["if"].call(a,(g=a.origin,g==null||g===!1?g:g.origin),{hash:{},inverse:G.noop,fn:G.program(21,
y,b),data:b}))||d===0)f+=d;f+="\n\n                ";if((d=c["if"].call(a,(g=a.origin,g==null||g===!1?g:g.notes),{hash:{},inverse:G.noop,fn:G.program(23,v,b),data:b}))||d===0)f+=d;f+="\n\n            ";return f}function y(a){var r;var c="",b;c+='\n                    <div class="origin content">';if((r=(b=(b=a.origin,b==null||b===!1?b:b.origin),typeof b===J?b.apply(a):b),a=r)||a===0)c+=a;c+="</div>\n                ";return c}function v(a,b){var g="",f,d;g+='\n                    <div class="origin content">'+
V((f=(f=a.labels,f==null||f===!1?f:f.Notes),typeof f===J?f.apply(a):f))+'\n                        <ul class="phrase_list content">\n                            ';if((d=c.each.call(a,(f=a.origin,f==null||f===!1?f:f.notes),{hash:{},inverse:G.noop,fn:G.program(24,x,b),data:b}))||d===0)g+=d;g+="\n                        </ul>\n                    </div>\n                ";return g}function x(a){var c="";c+="\n                                <li>";if((a=typeof a===J?a.apply(a):a)||a===0)c+=a;c+="</li>\n                            ";
return c}function j(a){var r;var c="",b;c+="\n            \n            <div>"+V((b=(b=a.labels,b==null||b===!1?b:b.Derivatives),typeof b===J?b.apply(a):b))+'</div>\n            <div class="derivatives content">';if((r=(b=a.derivatives,typeof b===J?b.apply(a):b),a=r)||a===0)c+=a;c+="</div>\n            ";return c}function C(a){var r;var c="",b;c+="\n            \n            <div>"+V((b=(b=a.labels,b==null||b===!1?b:b.Usage),typeof b===J?b.apply(a):b))+'</div>\n            <div class="usage content">';
if((r=(b=a.usage,typeof b===J?b.apply(a):b),a=r)||a===0)c+=a;c+="</div>\n            ";return c}function I(a){var r;var b="",c;b+="\n            \n            <div>"+V((c=(c=a.labels,c==null||c===!1?c:c.Ipa),typeof c===J?c.apply(a):c))+'</div>\n            <div class="ipa content">';if((r=(c=a.ipa,typeof c===J?c.apply(a):c),a=r)||a===0)b+=a;b+="</div>\n            ";return b}function z(a,b){var f="",g,d;f+="\n            \n            <div>";if((d=(g=(g=a.labels,g==null||g===!1?g:g.RelatedWords),
typeof g===J?g.apply(a):g))||d===0)f+=d;f+='</div>\n            <div class="relatedWords">\n                <ul class="list content">\n                    ';if((d=c.each.call(a,a.relatedWords,{hash:{},inverse:G.noop,fn:G.program(33,B,b),data:b}))||d===0)f+=d;f+="\n                </ul>\n            </div>\n            ";return f}function B(a){var c="";c+="\n                    <li>";if((a=typeof a===J?a.apply(a):a)||a===0)c+=a;c+="</li>\n                    ";return c}function w(a){var r;var c="",
b;c+='\n            \n            <div class="morphology content">';if((r=(b=a.morphology,typeof b===J?b.apply(a):b),a=r)||a===0)c+=a;c+="</div>\n            ";return c}function E(a,b){var f="",g,d;f+="\n            \n            <div>";if((d=(g=(g=a.labels,g==null||g===!1?g:g.Phrases),typeof g===J?g.apply(a):g))||d===0)f+=d;f+='</div>\n            <div class="phrases">\n                <ul class="list content">\n                    ';if((d=c.each.call(a,a.phrases,{hash:{},inverse:G.noop,fn:G.program(38,
K,b),data:b}))||d===0)f+=d;f+="\n                </ul>\n            </div>\n            ";return f}function K(a,b){var g="",f,d;g+="\n                    <li>";if((d=(f=a.phrase,typeof f===J?f.apply(a):f))||d===0)g+=d;g+="\n                        ";if((d=c["if"].call(a,a.definitions,{hash:{},inverse:G.noop,fn:G.program(39,D,b),data:b}))||d===0)g+=d;g+="\n                    </li>\n                    ";return g}function D(a,b){var g="",f;g+='\n                            <ul class="definitions_list content">';
if((f=c.each.call(a,a.definitions,{hash:{},inverse:G.noop,fn:G.program(40,M,b),data:b}))||f===0)g+=f;g+="\n                            </ul>\n                        ";return g}function M(a,b){var g="",f,d;g+="\n                                    ";if((f=c["if"].call(a,a.context,{hash:{},inverse:G.noop,fn:G.program(41,N,b),data:b}))||f===0)g+=f;g+="\n                                    <li>";if((d=(f=a.definition,typeof f===J?f.apply(a):f))||d===0)g+=d;g+="</li>\n                                    ";
if((d=c["if"].call(a,a.info,{hash:{},inverse:G.noop,fn:G.program(43,F,b),data:b}))||d===0)g+=d;g+="\n            \n                                    ";if((d=c["if"].call(a,a.subDefinitions,{hash:{},inverse:G.noop,fn:G.program(45,L,b),data:b}))||d===0)g+=d;g+="\n                                    ";if((d=c["if"].call(a,a.orthography,{hash:{},inverse:G.noop,fn:G.program(48,A,b),data:b}))||d===0)g+=d;g+="\n                                    ";if((d=c["if"].call(a,a.morphology,{hash:{},inverse:G.noop,
fn:G.program(50,O,b),data:b}))||d===0)g+=d;g+="\n                                ";return g}function N(a){var r;var b="",c;b+="\n                                    <li>\n                                        <ul>        \n                                            <li>";if((r=(c=a.context,typeof c===J?c.apply(a):c),a=r)||a===0)b+=a;b+="</li>\n                                        </ul>\n                                    </li>\n                                    ";return b}function F(a){var r;
var b="",c;b+="\n                                    <li>\n                                        <ul>        \n                                            <li>";if((r=(c=a.info,typeof c===J?c.apply(a):c),a=r)||a===0)b+=a;b+="</li>\n                                        </ul>\n                                    </li>\n                                    ";return b}function L(a,b){var g="",f;g+="\n                                    <li>\n                                        <ul>\n                                            ";
if((f=c.each.call(a,a.subDefinitions,{hash:{},inverse:G.noop,fn:G.program(46,P,b),data:b}))||f===0)g+=f;g+="\n                                        </ul>\n                                    </li>\n                                    ";return g}function P(a){var b="";b+="\n                                            <li>";if((a=typeof a===J?a.apply(a):a)||a===0)b+=a;b+="</li>\n                                            ";return b}function A(a){var r;var b="",c;b+="\n                                    <li>\n                                        <ul>        \n                                            <li>";
if((r=(c=a.orthography,typeof c===J?c.apply(a):c),a=r)||a===0)b+=a;b+="</li>\n                                        </ul>\n                                    </li>\n                                    ";return b}function O(a){var r;var b="",c;b+="\n                                    <li>\n                                        <ul>        \n                                            <li>";if((r=(c=a.morphology,typeof c===J?c.apply(a):c),a=r)||a===0)b+=a;b+="</li>\n                                        </ul>\n                                    </li>\n                                    ";
return b}this.compilerInfo=[2,">= 1.0.0-rc.3"];var c=c||e.helpers,f=f||{},e="",J="function",G=this,V=this.escapeExpression;if((d=c.each.call(d,d.results,{hash:{},inverse:G.noop,fn:G.programWithDepth(function(b,g,f){var d="",k;d+='\n    <div class="dictionary_result">\n        <div class="term">\n            <span class="entry">'+V((k=b.headword,typeof k===J?k.apply(b):k))+'</span><br/>\n        </div>\n        <div class="definition">\n            ';if((k=c.each.call(b,b.definitionsGroups,{hash:{},
inverse:G.noop,fn:G.program(2,a,g),data:g}))||k===0)d+=k;d+="\n        </div>\n        \n        ";if((k=c["if"].call(b,f.isFullDefPane,{hash:{},inverse:G.noop,fn:G.program(19,s,g),data:g}))||k===0)d+=k;d+="\n    </div>\n";return d},f,d),data:f}))||d===0)e+=d;e+="\n";return e});j.KindleReaderEditNoteDialog=h(function(e,d,c,b,f){this.compilerInfo=[2,">= 1.0.0-rc.3"];var c=c||e.helpers,f=f||{},e="",a=this.escapeExpression,g=c.helperMissing;e+='<div id="kindleReader_dialog_editNote">\n    <label id="kindleReader_dialog_editNote_title" class="kindle_dialog_title_text"></label>\n    <p>\n    <textarea\n        id="kindleReader_dialog_editNote_noteText"\n        cols="60"\n        rows="10"\n        maxlength="';
(b=c.maxNoteChars)?b=b.call(d,{hash:{},data:f}):(b=d.maxNoteChars,b=typeof b==="function"?b.apply(d):b);e+=a(b)+"\"\n        placeholder='";f={hash:{},data:f};e+=a((b=c.str,b?b.call(d,"k_R_dialog_editNote_placeholder",f):g.call(d,"str","k_R_dialog_editNote_placeholder",f)))+"'\n        ></textarea>\n    </p>\n</div>";return e});j.KindleReaderEmbeddedError=h(function(){this.compilerInfo=[2,">= 1.0.0-rc.3"];return'<div id="kindleReader_embeddedError">\n    <div id="kindleReader_embeddedError_icon"></div>\n    <div id="kindleReader_embeddedError_text"></div>\n</div>'});
j.KindleReaderFreeTrialExpiredDialog=h(function(e,d,c,b,f){this.compilerInfo=[2,">= 1.0.0-rc.3"];var c=c||e.helpers,f=f||{},e="",a,g=c.helperMissing,k=this.escapeExpression;e+="<div id='kindleReader_dialog_freeTrialExpired'>\n    <label id='kindleReader_dialog_freeTrialExpired_title' class='kindle_dialog_title_text'>";b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_endOfFreeTrial_Title",b):g.call(d,"str","k_endOfFreeTrial_Title",b)))+"</label>\n    <p id='kindleReader_dialog_freeTrialExpired_label' class='kindle_dialog_text'></p>\n    <label id='kindleReader_dialog_freeTrialExpired_text' class='kindle_dialog_text'>";
b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_endOfFreeTrial_Text",b):g.call(d,"str","k_endOfFreeTrial_Text",b)))+'</label>\n    <p id=\'kindleReader_dialog_freeTrialExpired_label\' class=\'kindle_dialog_text\'></p>\n    <div class=\'button-area\'>\n        <button id="kindleReader_dialog_buyFullVersion_btn" type="button" class="ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only" role="button" aria-disabled="false">\n            <span class="ui-button-text">';b={hash:{},data:f};
e+=k((a=c.str,a?a.call(d,"k_endOfFreeTrial_buyfullversion_button",b):g.call(d,"str","k_endOfFreeTrial_buyfullversion_button",b)))+"</span>\n        </button>\n        ";if((d=c["if"].call(d,d._isRemovalForFreeTrialsEnabled,{hash:{},inverse:this.noop,fn:this.program(1,function(a,b){var f="",d,e;f+='\n        <button id="kindleReader_dialog_removeBook_btn" type="button" class="ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only" role="button" aria-disabled="false">\n            <span class="ui-button-text">';
e={hash:{},data:b};f+=k((d=c.str,d?d.call(a,"k_endOfFreeTrial_removebook_button",e):g.call(a,"str","k_endOfFreeTrial_removebook_button",e)))+"</span>\n        </button>\n        ";return f},f),data:f}))||d===0)e+=d;e+="\n    </div>\n</div>";return e});j.KindleReaderFreeTrialMessageBar=h(function(){this.compilerInfo=[2,">= 1.0.0-rc.3"];return"<div id='freeTrial_message_container'>\n    <div id='freeTrial_expiration_message'></div>\n</div>\n"});j.KindleReaderFullDefinitionPane=h(function(e,d,c,b,f){this.compilerInfo=
[2,">= 1.0.0-rc.3"];var c=c||e.helpers,f=f||{},e="",a,b=c.helperMissing,g=this.escapeExpression;e+='<div id="kindleReader_full_definition_pane">\n    <div id="kindleReader_full_definition_header">';f={hash:{},data:f};e+=g((a=c.str,a?a.call(d,"k_R_dictionary_view_full_i18n",f):b.call(d,"str","k_R_dictionary_view_full_i18n",f)))+'</div>\n    <div id="kindleReader_full_definition_content">\n        <div id="kindleReader_full_definition_loading" class="dictionary_loading"/>\n    </div>\n</div>';return e});
j.KindleReaderGoToDialog=h(function(e,d,c,b,f){this.compilerInfo=[2,">= 1.0.0-rc.3"];var c=c||e.helpers,f=f||{},e="",a,g=c.helperMissing,k=this.escapeExpression;e+="<div id='kindleReader_dialog_goto'>\n    <label id='kindleReader_dialog_gotoTitle' class='kindle_dialog_title_text'>";b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_R_goto_menu_goto_location_title",b):g.call(d,"str","k_R_goto_menu_goto_location_title",b)))+"</label>\n\t<p>\n\t    <div id='kindleReader_dialog_gotoLabel' for='kindleReader_dialog_gotoField'  class='kindle_dialog_text'>";
b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_R_goto_menu_goto_message",b):g.call(d,"str","k_R_goto_menu_goto_message",b)))+"</div>\n        <div class=\"goto_from\">\n            <input type='number' name='name' size='7' id='kindleReader_dialog_gotoField'>\n        </div>\n        <div id='kindleReader_dialog_gotoLocation' for='kindleReader_dialog_gotoField' class='kindle_dialog_text'>";b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_R_goto_menu_goto_location",b):g.call(d,"str","k_R_goto_menu_goto_location",
b)))+"</div>\n    </p>\n</div>";return e});j.KindleReaderGoToPageDialog=h(function(e,d,c,b,f){this.compilerInfo=[2,">= 1.0.0-rc.3"];var c=c||e.helpers,f=f||{},e="",a,g=c.helperMissing,k=this.escapeExpression;e+="<div id='kindleReader_dialog_goto_page'>\n    <label id='kindleReader_dialog_gotoPageTitle' class='kindle_dialog_title_text'>";b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_R_goto_menu_goto_page_title",b):g.call(d,"str","k_R_goto_menu_goto_page_title",b)))+"</label>\n\t<p>\n\t    <div id='kindleReader_dialog_gotoPageLabel' for='kindleReader_dialog_gotoPageField'  class='kindle_dialog_text'>";
b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_R_goto_menu_goto_page_message",b):g.call(d,"str","k_R_goto_menu_goto_page_message",b)))+"</div>\n        <div class=\"goto_from\">\n            <input type='text' name='name' size='7' id='kindleReader_dialog_gotoPageField'>\n        </div>\n        <div id='kindleReader_dialog_gotoPage' for='kindleReader_dialog_gotoPageField'  class='kindle_dialog_text'>";b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_R_goto_menu_goto_page",b):g.call(d,"str","k_R_goto_menu_goto_page",
b)))+"</div>\n    </p>\n</div>";return e});j.KindleReaderHeaderBar=h(function(e,d,c,b,f){this.compilerInfo=[2,">= 1.0.0-rc.3"];var c=c||e.helpers,f=f||{},e="",a,g=c.helperMissing,k=this.escapeExpression;e+="<div id='kindleReader_header' class='immersive_slide_area'>\n    <div id='kindleReader_header_left'>\n        <div class=\"kindleReader_kindleLogo\" />\n        <div class=\"readerControls\">\n            <div\n                id='kindleReader_button_close'\n                class='kbtn header_bar_icon'\n                title='";
b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_R_toolbar_library_button_tooltip",b):g.call(d,"str","k_R_toolbar_library_button_tooltip",b)))+"'\n                tabindex = 1;\n                data-action='reader_close'\n            ></div>\n\n            <div\n                id='kindleReader_button_goto'\n                class='header_bar_icon disabled'\n                title='";b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_R_menuButton_goto_tooltip",b):g.call(d,"str","k_R_menuButton_goto_tooltip",
b)))+"'\n                tabindex = 1;\n                data-action='reader_show_goto'\n            ></div>\n\n            <div\n                id='kindleReader_button_controlPanel'\n                class='header_bar_icon disabled'\n                title='";b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_R_menuButton_controlPane_tooltip",b):g.call(d,"str","k_R_menuButton_controlPane_tooltip",b)))+"'\n                tabindex = 1;\n                data-action='reader_show_settings'\n            ></div>\n\n            <div\n                id='kindleReader_bookmark'\n                class='header_bar_icon disabled'\n                title='";
b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_R_menuButton_bookmark_tooltip",b):g.call(d,"str","k_R_menuButton_bookmark_tooltip",b)))+"'\n                tabindex = 1;\n                data-action='reader_bookmark'\n            ></div>\n\n            <div\n                id='kindleReader_button_note'\n                class='header_bar_icon disabled'\n                title='";b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_R_menuButton_notesAndMarks_tooltip",b):g.call(d,"str","k_R_menuButton_notesAndMarks_tooltip",
b)))+"'\n                tabindex = 1;\n                data-action='reader_show_notes'\n            ></div>\n\n            <div\n                id='kindleReader_button_sync'\n                class='header_bar_icon disabled'\n                title='";b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_R_menuButton_sync_tooltip",b):g.call(d,"str","k_R_menuButton_sync_tooltip",b)))+"'\n                tabindex = 1;\n                data-action='reader_sync'\n            ></div>\n        </div>\n    </div>\n    <div id='kindleReader_header_right'>\n        <div id='readerControlsRight' class='readerControls'>\n            <div id='kindleReader_sitb' class='disabled'>\n                <div id='kindleReader_input_sitb'>\n                    <input id='kindleReader_input_sitb_box' type='text' tabindex = 1 />\n                    <div id='kindleReader_input_sitb_clear'></div>\n                </div>\n                <button id='kindleReader_button_sitb' class='header_bar_button' tabindex = 1 value='' data-action='reader_search'/>\n            </div>\n        </div>\n    </div>\n</div>";
return e});j.KindleReaderImmersiveModeExit=h(function(){this.compilerInfo=[2,">= 1.0.0-rc.3"];return"<div class='immersive_exit header'></div>\n<div class='immersive_exit footer'></div>"});j.KindleReaderLocationBar=h(function(e,d,c,b,f){this.compilerInfo=[2,">= 1.0.0-rc.3"];var c=c||e.helpers,f=f||{},e="",a=c.helperMissing,g=this.escapeExpression;e+="<div id='kindleReader_footer' class=\"immersive_slide_area\">\n    ";if((d=c["if"].call(d,d.isRtl,{hash:{},inverse:this.program(3,function(b,f){var d=
"",e,h;d+="\n        <div id=\"kindleReader_footer_readerControls_left\">\n            <div\n                id='kindleReader_button_back'\n                tabindex = 1;\n                class='disabled'\n                title='";h={hash:{},data:f};d+=g((e=c.str,e?e.call(b,"k_R_menuButton_back_tooltip",h):a.call(b,"str","k_R_menuButton_back_tooltip",h)))+"'\n                data-action='reader_back'\n            ></div>\n        </div>\n\n        <div id=\"kindleReader_footer_readerControls_middle\">\n            <div id='kindleReader_progressbar_div'></div>\n            <div id='kindleReader_footer_message' class='message'></div>\n            <div id='kindleReader_download_progress' class='kindleReader_footer_fading message'>\n                <span id=\"kindleReader_checkmark\"></span>\n                <span id=\"kindleReader_download_progress_message\"></span>\n            </div>\n        </div>\n\n        <div id=\"kindleReader_footer_readerControls_right\"/>\n\n        <div id='kindleReader_locationPopup_div'>\n            <div id='kindleReader_locationPopup_labelDiv' class='ui-helper-clearfix ui-corner-all'></div>\n        </div>\n    ";
return d},f),fn:this.program(1,function(b,f){var d="",e,h;d+="\n        <div id=\"kindleReader_footer_readerControls_left\" />\n\n        <div id=\"kindleReader_footer_readerControls_middle\">\n            <div id='kindleReader_progressbar_div'></div>\n            <div id='kindleReader_footer_message' class='message'></div>\n            <div id='kindleReader_download_progress' class='kindleReader_footer_fading message'>\n                <span id=\"kindleReader_checkmark\"></span>\n                <span id=\"kindleReader_download_progress_message\"></span>\n            </div>\n        </div>\n\n        <div id=\"kindleReader_footer_readerControls_right\">\n            <div\n                id='kindleReader_button_back'\n                tabindex = 1;\n                class='disabled rtl'\n                title='";
h={hash:{},data:f};d+=g((e=c.str,e?e.call(b,"k_R_menuButton_back_tooltip",h):a.call(b,"str","k_R_menuButton_back_tooltip",h)))+"'\n                data-action='reader_back'\n            ></div>\n        </div>\n\n        <div id='kindleReader_locationPopup_div'>\n            <div id='kindleReader_locationPopup_labelDiv' class='ui-helper-clearfix ui-corner-all'></div>\n        </div>\n    ";return d},f),data:f}))||d===0)e+=d;e+="\n</div>";return e});j.KindleReaderPageArrow=h(function(e,d,c,b,f){function a(a,
b){var g="",f,d;g+="\n        <div class='kindleReader_arrowBtn' title='";d={hash:{},data:b};g+=m((f=c.str,f?f.call(a,"k_R_pageArrow_next",d):k.call(a,"str","k_R_pageArrow_next",d)))+"'></div>\n        ";return g}function g(a,b){var g="",f,d;g+="\n        <div class='kindleReader_arrowBtn' title='";d={hash:{},data:b};g+=m((f=c.str,f?f.call(a,"k_R_pageArrow_prev",d):k.call(a,"str","k_R_pageArrow_prev",d)))+"'></div>\n        ";return g}this.compilerInfo=[2,">= 1.0.0-rc.3"];var c=c||e.helpers,f=f||
{},e="",k=c.helperMissing,m=this.escapeExpression;e+="<div id=\"kindleReader_sideMargin\">\n    <div id='kindleReader_pageTurnAreaLeft' class='kindleReader_pageTurnArea'>\n        ";if((b=c["if"].call(d,d.rtlPageAdvance,{hash:{},inverse:this.program(3,g,f),fn:this.program(1,a,f),data:f}))||b===0)e+=b;e+="\n    </div>\n    <div id='kindleReader_pageTurnAreaRight' class='kindleReader_pageTurnArea'>\n        ";if((b=c["if"].call(d,d.rtlPageAdvance,{hash:{},inverse:this.program(1,a,f),fn:this.program(3,
g,f),data:f}))||b===0)e+=b;e+="\n    </div>\n</div>";return e});j.KindleReaderSampleEnd=h(function(){this.compilerInfo=[2,">= 1.0.0-rc.3"];return'<div id=\'kindle_sample_end_message\'>\n    <p id="kindle_sample_end_title_text" class="kindle_dialog_title_text"></p>\n    <p id="kindle_sample_end_message_text" class="kindle_dialog_text"> </p>\n</div>'});j.KindleReaderSettingsDialog=h(function(e,d,c,b,f){this.compilerInfo=[2,">= 1.0.0-rc.3"];var c=c||e.helpers,f=f||{},e="",a,g=c.helperMissing,k=this.escapeExpression;
e+="<div id='kindleReader_controlPanel'>\n    <div id='kindleReader_controlPanel_preview'></div>\n    <\!-- text size --\>\n    <div id='kindleReader_controlPanel_fontSize' class=\"kindleReader_settings_section\">\n        <label class='kindleReader_controlPanel_fieldLabel'>";b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_R_settings_fontSize_label",b):g.call(d,"str","k_R_settings_fontSize_label",b)))+"</label>\n        <div class=\"kindleReader_controlPanel_optionButtons\">\n            <div id=\"kindleReader_controlPanel_xSmallFont\" class='kindleReader_controlPanel_5button'></div>\n            <div id=\"kindleReader_controlPanel_smallFont\"  class='kindleReader_controlPanel_5button'></div>\n            <div id=\"kindleReader_controlPanel_mediumFont\" class='kindleReader_controlPanel_5button'></div>\n            <div id=\"kindleReader_controlPanel_largeFont\"  class='kindleReader_controlPanel_5button'></div>\n            <div id=\"kindleReader_controlPanel_xLargeFont\" class='kindleReader_controlPanel_5button'></div>\n        </div>\n        <div class=\"kindleReader_controlPanel_buttonIndicators\">\n            <div id='kindleReader_controlPanel_xSmallFontSelected' class='kindleReader_controlPanel_5selectedDot'></div>\n            <div id='kindleReader_controlPanel_smallFontSelected'  class='kindleReader_controlPanel_5selectedDot'></div>\n            <div id='kindleReader_controlPanel_mediumFontSelected' class='kindleReader_controlPanel_5selectedDot'></div>\n            <div id='kindleReader_controlPanel_largeFontSelected'  class='kindleReader_controlPanel_5selectedDot'></div>\n            <div id='kindleReader_controlPanel_xLargeFontSelected' class='kindleReader_controlPanel_5selectedDot'></div>\n        </div>\n    </div>\n\n    <\!-- margins --\>\n    <div id='kindleReader_controlPanel_margin' class=\"kindleReader_settings_section\">\n        <label class='kindleReader_controlPanel_fieldLabel'>";
b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_R_settings_margins_label",b):g.call(d,"str","k_R_settings_margins_label",b)))+"</label>\n        <div class=\"kindleReader_controlPanel_optionButtons\">\n            <div id='kindleReader_controlPanel_xSmallMargin' class='kindleReader_controlPanel_5button'></div>\n            <div id='kindleReader_controlPanel_smallMargin'  class='kindleReader_controlPanel_5button'></div>\n            <div id='kindleReader_controlPanel_mediumMargin' class='kindleReader_controlPanel_5button'></div>\n            <div id='kindleReader_controlPanel_largeMargin'  class='kindleReader_controlPanel_5button'></div>\n            <div id='kindleReader_controlPanel_xLargeMargin' class='kindleReader_controlPanel_5button'></div>\n        </div>\n        <div class=\"kindleReader_controlPanel_buttonIndicators\">\n            <div id='kindleReader_controlPanel_xSmallMarginSelected' class='kindleReader_controlPanel_5selectedDot'></div>\n            <div id='kindleReader_controlPanel_smallMarginSelected'  class='kindleReader_controlPanel_5selectedDot'></div>\n            <div id='kindleReader_controlPanel_mediumMarginSelected' class='kindleReader_controlPanel_5selectedDot'></div>\n            <div id='kindleReader_controlPanel_largeMarginSelected'  class='kindleReader_controlPanel_5selectedDot'></div>\n            <div id='kindleReader_controlPanel_xLargeMarginSelected' class='kindleReader_controlPanel_5selectedDot'></div>\n        </div>\n    </div>\n    \n    <\!-- color mode --\>\n    <div id='kindleReader_controlPanel_colorMode' class=\"kindleReader_settings_section\">\n        <label class='kindleReader_controlPanel_fieldLabel'>";
b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_R_settings_colorMode_label",b):g.call(d,"str","k_R_settings_colorMode_label",b)))+"</label>\n        <div class=\"kindleReader_controlPanel_optionButtons\">\n            <div id='kindleReader_controlPanel_colorWhite' class='kindleReader_controlPanel_3button'>";b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_R_settings_colorMode_white",b):g.call(d,"str","k_R_settings_colorMode_white",b)))+"</div>\n            <div id='kindleReader_controlPanel_colorSepia' class='kindleReader_controlPanel_3button'>";
b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_R_settings_colorMode_sepia",b):g.call(d,"str","k_R_settings_colorMode_sepia",b)))+"</div>\n            <div id='kindleReader_controlPanel_colorBlack' class='kindleReader_controlPanel_3button'>";b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_R_settings_colorMode_black",b):g.call(d,"str","k_R_settings_colorMode_black",b)))+"</div>\n        </div>\n        <div class=\"kindleReader_controlPanel_buttonIndicators\">\n            <div id='kindleReader_controlPanel_colorWhiteSelected' class='kindleReader_controlPanel_3selectedDot'></div>\n            <div id='kindleReader_controlPanel_colorSepiaSelected' class='kindleReader_controlPanel_3selectedDot'></div>\n            <div id='kindleReader_controlPanel_colorBlackSelected' class='kindleReader_controlPanel_3selectedDot'></div>\n        </div>\n    </div>\n\n    <\!-- multi-column mode --\>\n    <div id='kindleReader_controlPanel_multiColumn' class=\"kindleReader_settings_section\">\n        <label class='kindleReader_controlPanel_fieldLabel'>";
b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_R_settings_multiColumnMode_label",b):g.call(d,"str","k_R_settings_multiColumnMode_label",b)))+"</label>\n        <div class=\"kindleReader_controlPanel_optionButtons\">\n            <div id='kindleReader_controlPanel_columnButton_on' class='kindleReader_controlPanel_switch'>";b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_R_settings_column_on_button",b):g.call(d,"str","k_R_settings_column_on_button",b)))+"</div>\n            <div id='kindleReader_controlPanel_columnButton_off' class='kindleReader_controlPanel_switch'>";
b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_R_settings_column_off_button",b):g.call(d,"str","k_R_settings_column_off_button",b)))+"</div>\n        </div>\n        <div id='kindleReader_controlPanel_optionButtons_msg' class='kindleReader_controlPanel_optionButtons_msg'>";b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_R_settings_column_disabled_msg",b):g.call(d,"str","k_R_settings_column_disabled_msg",b)))+"</div>\n    </div>\n\n    <\!-- show reading location mode --\>\n    <div id='kindleReader_controlPanel_showLocation' class=\"kindleReader_settings_showLocation kindleReader_settings_section\">\n        <label class='kindleReader_controlPanel_fieldLabel'>";
b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_R_settings_showLocation_label",b):g.call(d,"str","k_R_settings_showLocation_label",b)))+"</label>\n        <div class=\"kindleReader_controlPanel_optionButtons\">\n            <div id='kindleReader_controlPanel_showLocationButton_on' class='kindleReader_controlPanel_switch'>";b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_R_settings_column_on_button",b):g.call(d,"str","k_R_settings_column_on_button",b)))+"</div>\n            <div id='kindleReader_controlPanel_showLocationButton_off' class='kindleReader_controlPanel_switch'>";
b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_R_settings_column_off_button",b):g.call(d,"str","k_R_settings_column_off_button",b)))+"</div>\n        </div>\n    </div>\n        \n</div>";return e});j.KindleReaderSitbPane=h(function(e,d,c,b,f){this.compilerInfo=[2,">= 1.0.0-rc.3"];var c=c||e.helpers,f=f||{},e="",a,b=c.helperMissing,g=this.escapeExpression;e+='<div id="kindleReader_sitb_pane">\n    <div id="kindleReader_sitb_pane_header">\n        <div id="kindleReader_sitb_pane_title"></div>\n        <div id="kindleReader_sitb_pane_close_btn" class="closeButtonDark"></div>\n    </div>\n    <div id="kindleReader_sitb_pane_scrollWrapper">\n        <div id="kindleReader_sitb_pane_container" tabindex="-1"></div>\n        \n        <div id="kindleReader_sitb_message">';
f={hash:{},data:f};e+=g((a=c.str,a?a.call(d,"k_R_dialog_sitb_message_indexing",f):b.call(d,"str","k_R_dialog_sitb_message_indexing",f)))+'</div>\n    </div>\n    <div id="kindleReader_sitb_pane_beak"></div>\n</div>';return e});j.KindleReaderSitbResult=h(function(){this.compilerInfo=[2,">= 1.0.0-rc.3"];var e="";e+='<div class="kindleReader_sitb_result_container">\n    <div class="kindleReader_sitb_result_context_body"></div>\n    <div class="kindleReader_sitb_context_footer">\n        \n        \n        \n        <span class="kindleReader_sitb_location"></span>\n    </div>\n</div>';
return e});j.KindleReaderSitbResultCurLocMarker=h(function(){this.compilerInfo=[2,">= 1.0.0-rc.3"];return'<div id="kindleReader_sitb_pane_cur_loc_marker" class="kindleReader_sitb_result_container marker">\n    <div class="kindleReader_sitb_result_cur_loc_marker"></div>\n</div>'});j.KindleReaderStatusMessage=h(function(){this.compilerInfo=[2,">= 1.0.0-rc.3"];return'<div id=\'kindleReader_statusMessage_div\' class=\'ui-helper-clearfix ui-corner-all\'>\n    <div class="spinner">\n        <div class="bar1"></div>\n        <div class="bar2"></div>\n        <div class="bar3"></div>\n        <div class="bar4"></div>\n        <div class="bar5"></div>\n        <div class="bar6"></div>\n        <div class="bar7"></div>\n        <div class="bar8"></div>  \n        <div class="bar9"></div>      \n        <div class="bar10"></div>         \n        <div class="bar11"></div>             \n        <div class="bar12"></div>                 \n    </div>                                          \n    <span id=\'kindleReader_statusMessage_text\'></span>\n</div>'});
j.KindleReaderStorageViewer=h(function(){this.compilerInfo=[2,">= 1.0.0-rc.3"];return'<div id="kindleReader_storage_viewer" class="kindleReader_storage_viewer">\n  <div id="kindleReader_storage_viewer_panel">\n\n    <form id="kindleReader_storage_viewer_header">\n        <select name="stores" id="kindleReader_storage_viewer_stores">\n            <option selected="selected">Display table\u2026</option>\n        </select>\n\n        <div id="kindleReader_storage_viewer_query">\n            <input type="search" autocomplete="on" form="queryForm" name="kindleReader_storage_viewer_query" id="q" size="75" placeholder="Query text" />\n            <select id="kindleReader_storage_viewer_queryDB" name="queryDB" onchange="SV.runQuery(this.options[this.selectedIndex].value)">\n                <option>on</option>\n            </select>\n        </div>\n\n        <div id="kindleReader_storage_viewer_clearStorageDiv">\n            <input type="button" id="kindleReader_storage_viewer_clearStorageButton" name="clearStorageDiv" value="Clear HTML5 storage">\n        </div>\n        <div id="kindleReader_storage_viewer_close_btn" class="closeButtonDark"></div>\n    </form>\n\n    <div id="kindleReader_storage_viewer_results_section">\n        <table id="kindleReader_storage_viewer_results">\n        </table>\n    </div>\n  </div>\n</div>'});
j.KindleReaderSyncPositionDialog=h(function(e,d,c,b,f){this.compilerInfo=[2,">= 1.0.0-rc.3"];var c=c||e.helpers,f=f||{},e="",a,g=c.helperMissing,k=this.escapeExpression;e+="<div id='kindleReader_dialog_syncPosition'>\n    <label id='kindleReader_dialog_syncPosition_title' class='kindle_dialog_title_text'>";b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_R_syncPosition_title",b):g.call(d,"str","k_R_syncPosition_title",b)))+'</label>\n    <p id=\'kindleReader_dialog_syncPosition_label\' class=\'kindle_dialog_text\'></p>\n    <div class=\'button-area\'>\n        <button id="kindleReader_dialog_syncPosition_sync_btn" type="button" class="ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only" role="button" aria-disabled="false">\n        \t<span class="ui-button-text">';
b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_R_syncPosition_sync",b):g.call(d,"str","k_R_syncPosition_sync",b)))+'</span>\n        </button>\n        <button id="kindleReader_dialog_syncPosition_reset_btn" type="button" class="ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only" role="button" aria-disabled="false">\n        \t<span class="ui-button-text">';b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_R_syncPosition_reset",b):g.call(d,"str","k_R_syncPosition_reset",b)))+"</span>\n        </button>\n    </div>\n</div>";
return e});j["Metro/KindleMetroReaderButtonOverlay"]=h(function(e,d,c,b,f){this.compilerInfo=[2,">= 1.0.0-rc.3"];var c=c||e.helpers,f=f||{},e="",a,g=c.helperMissing,k=this.escapeExpression;e+="<div class='reader_button_overlay'>\n    <div class='reader_button_overlay_left'>\n        <div\n            id='reader_button_overlay_library'\n            class='overlay_button'\n            title='";b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_R_toolbar_library_button_tooltip",b):g.call(d,"str","k_R_toolbar_library_button_tooltip",
b)))+"'\n            tabindex = 1;\n            data-action='reader_close'\n        ></div>\n    </div>\n    <div class='reader_button_overlay_right'>\n        <div\n            id='reader_button_overlay_bookmark'\n            class='overlay_button'\n            title='";b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_R_menuButton_bookmark_tooltip",b):g.call(d,"str","k_R_menuButton_bookmark_tooltip",b)))+"'\n            tabindex = 1;\n            data-action='reader_bookmark'\n        ></div>\n    </div>\n</div>";
return e});j["Metro/KindleMetroReaderFooterBar"]=h(function(e,d,c,b,f){this.compilerInfo=[2,">= 1.0.0-rc.3"];var c=c||e.helpers,f=f||{},e="",a,g=c.helperMissing,k=this.escapeExpression;e+="<div id='kindleReader_footer' class=\"immersive_slide_area\">\n    <div id='readerControlsLeft' class=\"readerControls\">\n         <div\n            id='kindleReader_button_note'\n            class='header_bar_icon'\n            btnLbl='";b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_R_menuButton_notesAndMarks",
b):g.call(d,"str","k_R_menuButton_notesAndMarks",b)))+"'\n            title='";b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_R_menuButton_notesAndMarks_tooltip",b):g.call(d,"str","k_R_menuButton_notesAndMarks_tooltip",b)))+"'\n            tabindex = 1;\n            data-action='reader_show_notes'>\n                <div></div>\n                <span>";b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_R_menuButton_notesAndMarks",b):g.call(d,"str","k_R_menuButton_notesAndMarks",b)))+"</span>\n         </div>\n         <div\n            id='kindleReader_button_controlPanel'\n            class='header_bar_icon'\n            btnLbl='";
b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_R_menuButton_controlPane",b):g.call(d,"str","k_R_menuButton_controlPane",b)))+"'\n            title='";b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_R_menuButton_controlPane_tooltip",b):g.call(d,"str","k_R_menuButton_controlPane_tooltip",b)))+"'\n            tabindex = 1;\n            data-action='reader_show_settings'>\n                <div></div>\n                <span>";b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_R_menuButton_controlPane",b):g.call(d,
"str","k_R_menuButton_controlPane",b)))+"</span>\n        </div>\n        <div\n            id='kindleReader_button_back'\n            class='header_bar_icon'\n            btnLbl='";b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_R_menuButton_back",b):g.call(d,"str","k_R_menuButton_back",b)))+"'\n            title='";b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_R_menuButton_back_tooltip",b):g.call(d,"str","k_R_menuButton_back_tooltip",b)))+"'\n            tabindex = 1;\n            data-action='reader_back'>\n                <div></div>\n                <span>";
b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_R_menuButton_back",b):g.call(d,"str","k_R_menuButton_back",b)))+"</span>\n        </div>\n    </div>\n    <div id='readerControlsMiddle' class=\"readerControls\">\n        <div id='kindleReader_progressbar_div'></div>\n        <div id='kindleReader_footer_message' class='kindleReader_footer_fading message'></div>\n        <div id='kindleReader_download_progress' class='kindleReader_footer_fading message'>\n            <span id=\"kindleReader_checkmark\"></span>\n            <span id=\"kindleReader_download_progress_message\"></span>\n        </div>\n    \n        <div id='kindleReader_locationPopup_div'>\n            <div id='kindleReader_locationPopup_labelDiv' class='ui-helper-clearfix ui-corner-all'></div>\n        </div>\n    </div>\n    <div id='readerControlsRight' class=\"readerControls\">\n        <div\n            id='kindleReader_button_goto'\n            class='header_bar_icon'\n            btnLbl='";
b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_R_menuButton_goto",b):g.call(d,"str","k_R_menuButton_goto",b)))+"'\n            title='";b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_R_menuButton_goto_tooltip",b):g.call(d,"str","k_R_menuButton_goto_tooltip",b)))+"'\n            tabindex = 1;\n            data-action='reader_show_goto'>\n                <div></div>\n                <span>";b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_R_menuButton_goto",b):g.call(d,"str","k_R_menuButton_goto",b)))+
"</span>\n        </div>\n        <div\n            id='kindleReader_button_sync'\n            class='header_bar_icon'\n            btnLbl='";b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_R_menuButton_sync",b):g.call(d,"str","k_R_menuButton_sync",b)))+"'\n            title='";b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_R_menuButton_sync_tooltip",b):g.call(d,"str","k_R_menuButton_sync_tooltip",b)))+"'\n            tabindex = 1;\n            data-action='reader_sync'>\n                <div></div>\n                <span>";
b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_R_menuButton_sync",b):g.call(d,"str","k_R_menuButton_sync",b)))+"</span>\n        </div>\n        <div\n            id='kindleReader_button_pin_start_metro'\n            class='header_bar_icon'\n            btnLbl='";b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_R_menuButton_pin_start_metro",b):g.call(d,"str","k_R_menuButton_pin_start_metro",b)))+"'\n            title='";b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_R_menuButton_pin_start_metro_tooltip",
b):g.call(d,"str","k_R_menuButton_pin_start_metro_tooltip",b)))+"'\n            tabindex = 1;\n            data-action='reader_pin_metro'>\n                <div></div>\n                <span>";b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_R_menuButton_pin_start_metro",b):g.call(d,"str","k_R_menuButton_pin_start_metro",b)))+"</span>\n        </div>\n    </div>\n</div>";return e});j["Metro/KindleMetroReaderHeaderBar"]=h(function(e,d,c,b,f){this.compilerInfo=[2,">= 1.0.0-rc.3"];var c=c||e.helpers,f=
f||{},e="",a,g=c.helperMissing,k=this.escapeExpression;e+="<div id='kindleReader_header' class='immersive_slide_area'>\n    <div id='kindleReader_header_left'>\n        <div id='readerControlsLeft' class='readerControls'>\n            <div\n                id='kindleReader_button_library'\n                class='header_bar_icon'\n                btnLbl='";b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_R_toolbar_library_button",b):g.call(d,"str","k_R_toolbar_library_button",b)))+"'\n                title='";
b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_R_toolbar_library_button_tooltip",b):g.call(d,"str","k_R_toolbar_library_button_tooltip",b)))+"'\n                tabindex = 1;\n                data-action='reader_close_appbar'>\n                <div></div>\n            </div>      \n        </div>\n    </div>\n    <div id='kindleReader_header_middle'>\n        <div id='kindleReader_header_bar_title_author' class='kindleReader_header_bar_title_author'>\n            <div id='kindleReader_header_bar_title' class='kindleReader_header_bar_title'></div>\n            <div id='kindleReader_header_bar_author' class='kindleReader_header_bar_author'></div>\n        </div>  \n    </div>\n    <div id='kindleReader_header_right'>\n        <div id='readerControlsRight' class='readerControls'>\n           <div id='searchArea' class='disabled'>\n                <input id='kindleReader_search_field' type='text'/>\n                <div id='kindleReader_search_submit' class='header_bar_button' type='button' value='' data-action='reader_search'>\n                    <div></div>\n                </div>\n            </div>\n        </div>\n    </div>\n</div>";
return e});j["Metro/KindleMetroReaderViewSettings"]=h(function(e,d,c,b,f){this.compilerInfo=[2,">= 1.0.0-rc.3"];var c=c||e.helpers,f=f||{},e="",a,g=c.helperMissing,k=this.escapeExpression;e+="<div id='kindleReader_viewSettings'>\n    <div id='kindleReader_viewSettings_title' class='kindleReader_settings_title_section'>\n        <label class='kindleReader_viewSettings_titleLabel'>";b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_R_settings_title_metro",b):g.call(d,"str","k_R_settings_title_metro",b)))+
"</label>\n    </div>\n\n    <\!-- Font Size --\>\n    <div id='kindleReader_viewSettings_fontSize' class='kindleReader_settings_section'>\n        <label class='kindleReader_viewSettings_fieldLabel'>";b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_R_settings_fontSize_label_metro",b):g.call(d,"str","k_R_settings_fontSize_label_metro",b)))+"</label>\n        <div id=\"kindleReader_viewSettings_slider_tooltip_wrapper\">\n            <\!-- This wrapper div helps to align the tooltip to the bottom of the wrapper, otherwise it align to the top --\>\n            <span id='kindleReader_viewSettings_fontSize_slider_tooltip' class='kindleReader_viewSettings_slider_tooltip'>";
b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_R_settings_fontSize_tooltip_metro",b):g.call(d,"str","k_R_settings_fontSize_tooltip_metro",b)))+"</span>\n        </div>\n        <input tabindex=10 id='kindleReader_viewSettings_fontSize_slider' class='kindleReader_viewSettings_slider' type='range' step='1' min='0' max='4'/>\n    </div>\n\n    <\!-- margins --\>\n    <div id='kindleReader_viewSettings_margin' class='kindleReader_settings_section'>\n        <label class='kindleReader_viewSettings_fieldLabel'>";
b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_R_settings_margins_label_metro",b):g.call(d,"str","k_R_settings_margins_label_metro",b)))+"</label>\n        <input tabindex=20 id='kindleReader_viewSettings_margin_slider' class='kindleReader_viewSettings_slider' type='range' step='1' min='0' max='4'/>\n    </div>\n    \n    <\!-- color mode --\>\n    <div id='kindleReader_viewSettings_colorMode' class='kindleReader_settings_section'>\n        <label class='kindleReader_viewSettings_fieldLabel'>";b=
{hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_R_settings_colorMode_label_metro",b):g.call(d,"str","k_R_settings_colorMode_label_metro",b)))+"</label>\n        <div class='kindleReader_viewSettings_controls'>\n            <div id=\"kindleReader_viewSettings_optionButtons\">\n                <div tabindex=30 id='kindleReader_viewSettings_colorWhite' class='kindleReader_viewSettings_3button'>";b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_R_settings_colorMode_white",b):g.call(d,"str","k_R_settings_colorMode_white",
b)))+"</div>\n                <div tabindex=40 id='kindleReader_viewSettings_colorSepia' class='kindleReader_viewSettings_3button'>";b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_R_settings_colorMode_sepia",b):g.call(d,"str","k_R_settings_colorMode_sepia",b)))+"</div>\n                <div tabindex=50 id='kindleReader_viewSettings_colorBlack' class='kindleReader_viewSettings_3button'>";b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_R_settings_colorMode_black",b):g.call(d,"str","k_R_settings_colorMode_black",
b)))+"</div>\n            </div>\n        </div>\n    </div>\n\n    <\!-- multi-column mode --\>\n    <div id='kindleReader_viewSettings_multiColumn' class='kindleReader_settings_section'>\n        <label class='kindleReader_viewSettings_fieldLabel'>";b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_R_settings_multiColumnMode_label_metro",b):g.call(d,"str","k_R_settings_multiColumnMode_label_metro",b)))+'</label>\n        <div class=\'kindleReader_viewSettings_controls\'>\n            <div id=\'kindleReader_viewSettings_column_toggle_wrapper\'>\n                <div id=\'kindleReader_viewSettings_column_toggle_label\' class=\'kindleReader_viewSettings_control_label\'></div>\n                <div class="onoffswitch">\n                    <input type="checkbox" name="onoffswitch" class="onoffswitch-checkbox" id="kindleReader_viewSettings_column_toggle" checked>\n                    <label tabindex=60 id="kindleReader_viewSettings_column_toggle_switch" class="onoffswitch-label" for="kindleReader_viewSettings_column_toggle">\n                        <div class="onoffswitch-inner"></div>\n                        <div class="onoffswitch-switch"></div>\n                    </label>\n                </div>\n            </div>\n            <div id=\'kindleReader_viewSettings_optionButtons_msg\' class=\'kindleReader_controlPanel_optionButtons_msg\'>';
b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_R_settings_column_disabled_msg",b):g.call(d,"str","k_R_settings_column_disabled_msg",b)))+"</div>\n        </div>\n    </div>\n\n    <\!-- show reading location mode --\>\n    <div id='kindleReader_viewSettings_showLocation' class='kindleReader_settings_section'>\n        <label class='kindleReader_viewSettings_fieldLabel'>";b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_R_settings_showLocation_label_metro",b):g.call(d,"str","k_R_settings_showLocation_label_metro",
b)))+'</label>\n        <div class=\'kindleReader_viewSettings_controls\'>\n            <div id=\'kindleReader_viewSettings_showLocation_toggle_wrapper\'>\n                <div id=\'kindleReader_viewSettings_showLocation_toggle_label\' class=\'kindleReader_viewSettings_control_label\'></div>\n                <div class="onoffswitch">\n                    <input type="checkbox" name="onoffswitch" class="onoffswitch-checkbox" id="kindleReader_viewSettings_showLocation_toggle" checked>\n                    <label tabindex=60 id="kindleReader_viewSettings_showLocation_toggle_switch" class="onoffswitch-label" for="kindleReader_viewSettings_showLocation_toggle">\n                        <div class="onoffswitch-inner"></div>\n                        <div class="onoffswitch-switch"></div>\n                    </label>\n                </div>\n            </div>\n        </div>\n    </div>\n        \n\n</div>';
return e});j["Metro/KindleReaderGoToDialog"]=h(function(e,d,c,b,f){this.compilerInfo=[2,">= 1.0.0-rc.3"];var c=c||e.helpers,f=f||{},e="",a,g=c.helperMissing,k=this.escapeExpression;e+="<div id='kindleReader_dialog_goto' xmlns=\"http://www.w3.org/1999/html\" xmlns=\"http://www.w3.org/1999/html\">\n    <div class=\"goto_titleDiv\">\n        <label id='kindleReader_dialog_gotoTitle' class='kindle_dialog_title_text'>";b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_R_goto_menu_goto_location_metro_title",
b):g.call(d,"str","k_R_goto_menu_goto_location_metro_title",b)))+"</label>\n    </div>\n    <br>\n    <div class=\"goto_from\">\n        <input type='text' name='name' id='kindleReader_dialog_gotoField'>\n        <button id=\"kindle_reader_goto_location_button\">";b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_R_goto_menu_goto_button",b):g.call(d,"str","k_R_goto_menu_goto_button",b)))+'</button>\n        <button id="kindle_reader_cancel_goto_location_button">';b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,
"k_common_cancel_button",b):g.call(d,"str","k_common_cancel_button",b)))+"</button>\n    </div>\n    <br>\n    <div class=\"dialogErrorText\" id=\"kindleReader_dialog_gotoError\">\n        <label id='kindleReader_dialog_gotoErrorText' class='kindle_dialog_title_text'></label>\n    </div>\n</div>";return e});j["Metro/KindleReaderGoToPageDialog"]=h(function(e,d,c,b,f){this.compilerInfo=[2,">= 1.0.0-rc.3"];var c=c||e.helpers,f=f||{},e="",a,g=c.helperMissing,k=this.escapeExpression;e+="<div id='kindleReader_dialog_goto_page' xmlns=\"http://www.w3.org/1999/html\" xmlns=\"http://www.w3.org/1999/html\">\n    <div class=\"goto_titleDiv\">\n        <label id='kindleReader_dialog_gotoPageTitle' class='kindle_dialog_title_text'>";
b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_R_goto_menu_goto_page_title_metro",b):g.call(d,"str","k_R_goto_menu_goto_page_title_metro",b)))+"</label>\n    </div>\n    <br>\n    <div class=\"goto_from\">\n        <input type='text' name='name' id='kindleReader_dialog_gotoPageField'>\n        <button id=\"kindle_reader_goto_page_button\">";b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_R_goto_menu_goto_page_button",b):g.call(d,"str","k_R_goto_menu_goto_page_button",b)))+'</button>\n        <button id="kindle_reader_cancel_goto_page_button">';
b={hash:{},data:f};e+=k((a=c.str,a?a.call(d,"k_common_cancel_button",b):g.call(d,"str","k_common_cancel_button",b)))+"</button>\n    </div>\n    <br>\n    <div class=\"dialogErrorText\" id=\"kindleReader_dialog_gotoPageError\">\n        <label id='kindleReader_dialog_gotoPageErrorText' class='kindle_dialog_title_text'></label>\n    </div>\n</div>";return e});j.ReaderImmersiveModeIcon=h(function(){this.compilerInfo=[2,">= 1.0.0-rc.3"];return"<div class='immersive_icon_tap_target' data-action=\"immersive_icon\"><div id='immersive_icon'></div></div>"})})();
var BookChunk=function(){var h=Object.freeze?function(c){return Object.freeze(c)}:function(c){return c},j=["fragment","glyph","skeleton","resource","locationMap"],e={};j.forEach(function(c){e[c]={}});e.resource.huge=!0;var d={types:h(j),properties:h(e),getId:function(c){if(c.fragmentMetadata!==void 0)return c.fragmentMetadata.id;else if(c.skeletonMetadata!==void 0)return c.skeletonMetadata.id;else if(c.glyphFragmentMetadata!==void 0)return c.glyphFragmentMetadata.id;else if(c.metadata!==void 0)return c.metadata.id;
else KindleAssert(!1,"Can't get id from book chunk: unrecognizable metadata.")}};j.forEach(function(c){d[c.toUpperCase()+"_TYPE"]=c});return h(d)}(),BookDownloadController=function(){function h(e){if(!this instanceof h)return new h(e);var d={downloading:!1,waiting:!1,total:0,remaining:0,scaleFactor:1};Object.defineProperty(this,"downloading",{get:function(){return d.downloading},set:function(b){d.downloading=!!b},enumerable:!0});Object.defineProperty(this,"waiting",{get:function(){return d.waiting},
set:function(b){d.waiting=!!b},enumerable:!0});Object.defineProperty(this,"total",{get:function(){return d.total},set:function(b){d.total=b},enumerable:!0});Object.defineProperty(this,"scaledTotal",{get:function(){return d.total*d.scaleFactor},enumerable:!0});Object.defineProperty(this,"remaining",{get:function(){return d.remaining},set:function(b){d.remaining=b},enumerable:!0});Object.defineProperty(this,"scaledRemaining",{get:function(){return d.remaining*d.scaleFactor},enumerable:!0});Object.defineProperty(this,
"scaleFactor",{get:function(){return d.scaleFactor},set:function(b){d.scaleFactor=b},enumerable:!0});var e=e||{},c;for(c in e)e[c]!==void 0&&e.hasOwnProperty(c)&&d.hasOwnProperty(c)&&(d[c]=e[c])}var j={glyph:7,resource:20,sidecar:10,valueFor:function(e){return j.hasOwnProperty(e)?j[e]:1}};return{create:function(e){function d(){function a(b){if(m[b].waiting)return m[b].waiting=!1,m[b].downloading=!0,m[b].start(),!0}var b=!1,c=!1,g=!1;BookChunk.types.forEach(function(a){b=b||m[a].downloading;g=g||m[a].waiting});
l.forEach(function(a){b=b||m[a].downloading;c=c||m[a].waiting});g?BookChunk.types.some(a):!b&&!c?(KindleDebug.log("done downloading"),k.resolve()):!b&&c&&l.some(a)}function c(a){var c=new $.Deferred;if(m[a].remaining<=0)return f(a),c.resolve();a=e.downloaders[a];a.addEventListener("onProgress",b);a.addEventListener("onCompleted",function(a){f(a);c.resolve()});a.addEventListener("onFailed",function(a,b,f){m[a].waiting=!1;g(b,f);c.reject()});a.start();return c.promise()}function b(a,b){if(b!==m[a].remaining){m[a].remaining=
b;var c=0,g=0;BookChunk.types.forEach(function(a){c+=m[a].scaledRemaining;g+=m[a].scaledTotal});l.forEach(function(a){c+=m[a].scaledRemaining;g+=m[a].scaledTotal});k.notify(c,g)}}function f(a){m[a].downloading=!1;m[a].waiting=!1;d()}function a(a){function c(){KindleDebug.log("Finished downloading sidecar: "+a);m[f].downloading=!1;b(f,0);d()}function g(c){KindleDebug.error("Error downloading sidecar '"+a+"': "+c);m[f].downloading=!1;b(f,0);d()}var f="SC:"+a;l.push(f);m[f]=new h({scaleFactor:j.valueFor("sidecar"),
total:1,remaining:1,waiting:!0});m[f].start=function(){KindleDebug.log("Downloading sidecar: "+a);e.sidecarManager.download(a).then(c,g)}}function g(a,b){a=a||Kindle.ERROR.CANCELLED;BookChunk.types.forEach(function(a){if(m[a].downloading)e.downloaders[a].cancel(),m[a].downloading=!1});k.reject(a,b)}var k=$.Deferred(),m={},l=[];BookChunk.types.forEach(function(a){m[a]=new h({scaleFactor:j.valueFor(a)})});return{startDownload:function(){var b=e.downloadingContentProvider;$.when(b.getBookinfo(),b.computeCacheQuota(),
KindleModuleManager.getModule(Kindle.MODULE.SidecarManager)).done(function(b){var g=b.context.cacheState||b.cacheState;if(g===Kindle.BookInfo.CachedState.CACHED||g===Kindle.BookInfo.CachedState.PINNED)k.resolve();else{var f={skeleton:(Number(b.fragmap.fragmentMetadata.numberOfSkeletons)||1)-1,fragment:Number(b.fragmap.fragmentMetadata.numberOfFragments)-1,glyph:(Number(b.metadata.numOfGlyphFragments)||0)-1,resource:b.manifest&&b.manifest.resourceManifest?Number(Math.max.apply(Math,Object.keys(b.manifest.resourceManifest))):
-1,locationMap:b.metadata.locationsInfo&&b.metadata.locationsInfo.numOfLocations?Math.floor((Number(b.metadata.locationsInfo.numOfLocations)-1)/Number(b.metadata.locationsInfo.mapSize)):-1};BookChunk.types.forEach(function(a){var b=e.downloaders[a];b.init(f[a],e.fast);m[a].waiting=!0;m[a].remaining=m[a].total=b.getNumIds();m[a].start=function(){c(a)}});Object.keys(e.sidecarManager.names).forEach(a);d()}})},failDownload:g,cancelDownload:g,pauseDownload:function(){BookChunk.types.forEach(function(a){m[a].downloading&&
e.downloaders[a].pause()})},resumeDownload:function(){BookChunk.types.forEach(function(a){m[a].downloading&&e.downloaders[a].resume()})},whenDownloadComplete:function(){return k.promise()}}}}}();
function KindleBookDownloaderFactory(h){var j=5E3,e=0,d=1E3,c=$.Deferred().resolve(),b={};h.downloader=b;b.type=h.type;b.cache=h.cache;b.throttle=h.throttle;b.readAheadActive=!1;b.readAheadPauseCount=0;b.dbPutter=h.dbPutter;b.dbGetIdList=h.dbGetIdList;b.dbOosHandler=h.dbOosHandler;b.dbCheckCache=h.dbCheckCache;b.dbIsCached=h.dbIsCached;b.dbIsOos=h.dbIsOos;b.netGetter=h.netGetter;b.urlGetter=h.urlGetter;b.fileGetter=h.fileGetter;b.fileProgress=h.fileProgress;b.downloadError=h.downloadError;b.isIdRequired=
h.isIdRequired||function(){return!0};b.numIds=0;b.pauseReadAhead=function(){this.readAheadPauseCount++};b.resumeReadAhead=function(){this.readAheadPauseCount=Math.max(0,--this.readAheadPauseCount)};b.setNextId=function(b){if(b!==void 0&&this.readAheadActive)this.nextReadAheadId=b};b.removeIdFromReadAhead=function(b){if(this.readAheadActive){var a;for(a=0;a<this.readAheadIds.length;a++)if(this.readAheadIds[a]===b){this.readAheadIds.splice(a,1);break}for(a=0;a<this.readAheadUrls.length;a++)if(this.readAheadUrls[a].id===
b){this.readAheadUrls.splice(a,1);break}}};b.freeDbSpace=function(){var b=this;if(c&&c.state()==="pending")return c.promise();c=new $.Deferred;b.dbCheckCache();b.dbOosHandler(c.resolve,function(){if(b.readAheadActive)b.readAheadActive=!1,b.dbIsOos();c.reject()});return c.promise()};b.isStillActive=function(b){return!this.readAheadActive||this.readAheadGeneration!==b?!1:!0};b.readAheadOne=function(b){function a(){l.isStillActive(b)&&(l.numReadAheadNetRequests--,l.readAheadUrls.length===0?l.numReadAheadNetRequests===
0&&setTimeout(function(){l.getReadAheadUrls(b)},l.interReadWait):setTimeout(function(){l.readAheadOne(b)},l.interReadWait))}function g(a){var b=l.numReadAhead,a=a&&(a.data||JSON.stringify(a)).length||0,c=Math.max(Date.now()-n,1),c=(a/c*1E3).toFixed(),g=l.readAheadThroughput;a>4E4&&(g=(l.readAheadThroughput*0.8+c*0.2).toFixed(),c>1E5?b=Math.min(b+1,l.maxReadAhead):c<1E4&&(b=Math.max(b-1,1)));b>l.numReadAhead?l.numReadAheadIncreased++:b<l.numReadAhead&&l.numReadAheadDecreased++;l.highestReadAhead=Math.max(l.highestReadAhead,
b);l.numReadAhead=b;l.readAheadThroughput=g}function d(c,k){if(l.isStillActive(b)){if(k==="timeout")l.throttle?g(null):l.numReadAhead>1&&l.numReadAhead--;else if(k==="error"&&KindleModuleManager.getModuleSync(KindleModuleManager.NETWORK).isOnline()===!1){l.downloadError(Kindle.ERROR.NETWORK,Kindle.ERROR_CODE.OFFLINE);l.readAheadActive=!1;return}a()}}function e(d){function k(){l.isStillActive(b)&&(l.readAheadRemaining--,l.fileProgress(l.readAheadRemaining),a())}function m(g){function d(){if(l.readAheadActive)l.readAheadActive=
!1,l.dbIsOos();c.reject()}function e(){l.readAheadActive&&(KindleHostDeviceDetector.isIE()||l.dbPutter(h,k,d),k())}l.isStillActive(b)&&(g=g||{},!(g.code===Kindle.DB.CONSTRAINT_ERR||g.message==="constraint failed")&&g.code===Kindle.DB.QUOTA_ERR?l.freeDbSpace().then(e):a())}if(l.isStillActive(b)){l.throttle&&g(d);var n=BookChunk.getId(d),h=[];h[n]=d;$.when(c).then(function(){l.dbPutter(h,k,m)})}}var l=this,n=Date.now();if(l.isStillActive(b))if(l.readAheadStillAlive++,this.readAheadPauseCount>0)setTimeout(function(){l.readAheadOne(b)},
l.startReadWait);else if(l.readAheadUrls.length===0&&l.numReadAheadNetRequests===0)l.getReadAheadUrls(b);else for(;l.numReadAheadNetRequests<l.numReadAhead&&l.readAheadUrls.length>0;){l.numReadAheadNetRequests++;var h=l.readAheadUrls.shift();l.fileGetter(h,e,d)}};b.getReadAheadUrls=function(b){function a(a){e.readAheadUrls=a;setTimeout(function(){e.isStillActive(b)&&e.readAheadOne(b)},e.interReadWait)}function c(){e.downloadError(Kindle.ERROR.NETWORK,Kindle.ERROR_CODE.NO_URL)}function d(){if(e.dbCheckCache())e.getReadAheadUrls(b);
else if(e.isStillActive(b))e.readAheadActive=!1,e.dbIsOos()}var e=this;if(e.isStillActive(b))if(e.dbCheckCache()){e.readAheadStillAlive++;for(var l=[],h=0;h<e.readAheadIds.length&&e.readAheadIds[h]<e.nextReadAheadId;)h++;h===e.readAheadIds.length&&(h=0);l=e.readAheadIds.splice(h,e.numReadAheadUrls);l.length===0?e.refreshReadAheadList(b):(e.nextReadAheadId=h<e.readAheadIds.length?e.readAheadIds[h]:0,e.urlGetter(l,a,c))}else e.freeDbSpace().then(d)};b.refreshReadAheadList=function(c){function a(a){function g(){d.readAheadActive&&
d.getReadAheadUrls(c)}if(d.readAheadActive){var h=e.createSubTimer("success");d.readAheadStillAlive++;var o,q=[];for(o in a)q[a[o]]=!0;d.readAheadIds=[];for(o=0;o<=d.maxReadAheadId;o++)!q[o]&&b.isIdRequired(o)&&d.readAheadIds.push(o);h.addCount("needed",d.readAheadIds.length);h.addCount("total",d.maxReadAheadId+1);h.endTimer();e.endTimer();e.log();if(d.readAheadIds.length>0){if(d.readAheadRemaining=d.readAheadIds.length,d.readAheadRemaining!==d.readAheadRemainingPrev)d.readAheadRemainingPrev=d.readAheadRemaining,
setTimeout(g,d.startReadWait)}else d.readAheadActive=!1,d.dbIsCached()}}function g(){e.endTimer();d.downloadError(Kindle.ERROR.UNKNOWN_DB_ERROR)}var d=this;if(c===this.readAheadGeneration){var e;this.readAheadActive&&(e=KindleMetricsProfiler("bookDownloader.getIdList"),this.dbGetIdList(a,g))}};b.readAheadWatchdog=function(){var b=this;if(this.readAheadActive){if(this.readAheadStillAlive===0&&(this.readAheadPauseCount===0||this.readAheadGeneration===0))this.readAheadGeneration++,this.readAheadRemaining<
this.generationReadAheadRemaining?(this.numReadAheadNetRequests=0,this.generationReadAheadRemaining=this.readAheadRemaining,this.readAheadRemainingPrev=this.readAheadRemaining+1,this.watchDogTimeout=3E4,this.refreshReadAheadList(this.readAheadGeneration)):this.timeoutRetry?(this.generationReadAheadRemaining=this.readAheadRemaining+1,this.watchDogTimeout=12E4):this.downloadError(Kindle.ERROR.TIMEOUT);setTimeout(function(){b.readAheadWatchdog()},this.watchDogTimeout)}this.readAheadStillAlive=0};b.initialize=
function(c,a){if(this.cache){this.fastest=a;this.readAheadUrls=[];this.readAheadIds=[];this.numReadAheadNetRequests=this.nextReadAheadId=0;this.maxReadAheadId=c;this.readAheadActive=!0;this.readAheadGeneration=this.readAheadStillAlive=0;this.watchDogTimeout=3E4;for(var g=this.numIds=0;g<=c;g++)b.isIdRequired(g)&&this.numIds++;this.readAheadRemaining=this.numIds+1;this.readAheadRemainingPrev=this.readAheadRemaining+1;this.generationReadAheadRemaining=this.numIds+2;this.fastest?(this.startReadWait=
this.interReadWait=this.startReadAheadWait=0,this.numReadAhead=8,this.numReadAheadUrls=200):(this.startReadAheadWait=j,this.interReadWait=e,this.startReadWait=d,this.numReadAhead=4,this.numReadAheadUrls=20,this.timeoutRetry=!0);if(this.throttle)this.maxReadAhead=this.numReadAhead,this.highestReadAhead=1,this.numReadAheadDecreased=this.numReadAheadIncreased=0,this.numReadAhead=1,this.readAheadThroughput=0,this.numReadAheadUrls=40;this.debugCounter=15}else this.readAheadActive=!1;this.initialized=!0};
b.startReadAhead=function(){var b=this;KindleAssert(b.initialized,"Failed to call initialize before startReadAhead");b.cache?setTimeout(function(){b.readAheadWatchdog()},b.startReadAheadWait):b.readAheadActive=!1};b.cancelReadAhead=function(){this.readAheadActive=!1;this.readAheadGeneration=-1;this.readAheadIds=this.readAheadUrls=null};b.setReadAheadTimersForTestMode=function(){d=e=j=0};return b}
function KindleReaderBookInfoProviderFactory(){var h="book_context",j="book_metaData",e="book_manifest",d="book_key",c="book_fragmap",b="book_ok_to_download",f="book_skeleton_builder",a="book_resource_urls";return{BookInfo:function(g,k){function m(a,b){Aa&&Aa(b-a,b)}function l(){var a=new jQuery.Deferred;KindleLibraryBookCover.getOfflineCover(L).then(function(b){A.getModuleSync(KindleModuleManager.DB_CLIENT).getBookDb().getTable("covers").insertRecord({asin:L,coverData:b}).then(a.resolve,a.reject)},
a.reject);return a.promise()}function n(a){function b(){var c=A.getModuleSync(h);w.updateBookinfo({cacheState:a,context:c}).then(g.resolve,g.reject)}function c(){g.reject(Kindle.ERROR.NETWORK,Kindle.ERROR_CODE.CACHED_STATE)}var g=new jQuery.Deferred;H().done(function(){var f;A.isModuleInitialized(h)?(f=A.getModuleSync(h),f.isSample?b():(f={asin:L,kindleSessionId:f.kindleSessionId,isOffline:a===Kindle.BookInfo.CachedState.PINNED},A.getModuleSync(A.SERVICE_CLIENT).setOfflineStatus(f).then(b,c))):g.reject()});
return g.promise()}function r(){Ga&&(Ga.endTimer(),Ga.log(),Ga=null);var a=W!==Ba&&W!==Kindle.BookInfo.CachedState.PINNED?n(Ba):!0;$.when(a).then(function(){l().then(aa.resolve,aa.resolve)},function(a){a===Kindle.ERROR.NETWORK?aa.reject(a,Kindle.ERROR_CODE.CACHED_STATE):aa.reject(Kindle.ERROR.UNKNOWN_DB_ERROR)});var b=[];if(a=F.getBookType())b.push("::"+a),a===Kindle.BookInfo.BookType.MOBI8&&(F.isContentScrambled()===!0?b.push("::mobi8::scrambled"):F.isContentScrambled()===!1&&b.push("::mobi8::unscrambled"));
w.getBookStatistics().then(function(a){M&&(a.fragments!==void 0&&(O.increaseSubCounter(M,"fragmentCount",a.fragments.count),O.increaseSubCounter(M,"fragmentsSize",a.fragments.size)),a.glyphs!==void 0&&(O.increaseSubCounter(M,"glyphCount",a.glyphs.count),O.increaseSubCounter(M,"glyphsSize",a.glyphs.size)),O.endMetrics(M,b))},function(){M&&O.endMetrics(M,b)})}function o(){function a(){KindleModuleManager.getModuleSync(Kindle.MODULE.DB_CLIENT).removeEventListener(Kindle.ERROR.DB_LINGERING_WRITE,c);r()}
function b(a){KindleModuleManager.getModuleSync(Kindle.MODULE.DB_CLIENT).removeEventListener(Kindle.ERROR.DB_LINGERING_WRITE,c);aa.reject(a)}function c(a){a.type===Kindle.ERROR.DB_LINGERING_WRITE&&(a.stalled?D.downloadController.pauseDownload():D.downloadController.resumeDownload())}D.downloadController?(KindleModuleManager.getModuleSync(Kindle.MODULE.DB_CLIENT).addEventListener(Kindle.ERROR.DB_LINGERING_WRITE,c),D.downloadController.startDownload(),D.downloadController.whenDownloadComplete().then(a,
b,[m,aa.progress])):ha?b():aa.reject(Kindle.CACHING.DISABLED)}function q(){if(!A.isModuleRegistered(c)){O.startSubTimer(Y,"getFragMap");var a=B.getFragmap();a.done(function(){O.endSubTimer(Y,"getFragMap")});A.registerModuleWithDeferred(c,a)}return A.getModule(c)}function t(a){var b;a.cpr!==void 0&&(b={},KindleCompression.lzAddStringsToDictionary(a.cpr,b),KindleCompression.lzAddNumbersToDictionary(b),ca=KindleCompression.lzGetDecompressionDictionary(b));a.cprJson!==void 0&&(b={},KindleCompression.lzAddStringsToDictionary(a.cprJson,
b,256),KindleCompression.lzAddNumbersToDictionary(b,256),ea=KindleCompression.lzGetDecompressionDictionary(b))}function s(){function a(b){B.getMetadata().then(function(a){O.endSubTimer(Y,"getMetadata");t(a);b.resolve(a)},b.reject)}A.isModuleRegistered(j)||(O.startSubTimer(Y,"getMetadata"),A.registerModuleWithInitializer(j,a));return A.getModule(j)}function u(){if(!A.isModuleRegistered(e)){O.startSubTimer(Y,"getManifest");var a=B.getManifest();a.done(function(){O.endSubTimer(Y,"getManifest")});A.registerModuleWithDeferred(e,
a)}return A.getModule(e)}function y(){var a,b;b={resource:{isIdRequired:function(b){return b in a}}};var c={bookinfo:F,moduleManager:A,contentCache:w,kcrFree:g.kcrFree};K=A.getModuleSync(Kindle.MODULE.SidecarManager).create(c);B=NetworkContentProvider.create({context:A.getModuleSync(h),bookInfo:F,asin:L});u().done(function(b){a=b.resourceManifest||{}});ha?(b={asin:L,source:B,cache:w,tweaks:b,readAheadAgressively:Oa,sidecarManager:K},D=E=DownloadingContentProvider.create(b),KindleLocalStorage.getItem(Kindle.CACHING.CACHING)!==
Kindle.CACHING.ENABLED&&(O.emit([{name:z.ENABLED,params:{breakdown:["Browser"]}}]),KindleLocalStorage.setItem(Kindle.CACHING.CACHING,Kindle.CACHING.ENABLED))):(D=B,KindleLocalStorage.getItem(Kindle.CACHING.CACHING)!==Kindle.CACHING.DISABLED&&(O.emit([{name:z.DISABLED,params:{breakdown:["Browser"]}}]),KindleLocalStorage.setItem(Kindle.CACHING.CACHING,Kindle.CACHING.DISABLED)));$.when(u(),q()).done(function(a,b){ContentPrefetchOptimizations.modify(D,a,b);v();x()})}function v(){function a(b){A.getModuleList([j,
e]).done(function(a){a=KindleBookSkeletonBuilderFactory(D[BookChunk.SKELETON_TYPE],D[BookChunk.RESOURCE_TYPE],a[e],ca);O.endSubTimer(Y,"getSkeletonBuilder");b.resolve(a)}).fail(b.fail)}A.isModuleRegistered(f)||(O.startSubTimer(Y,"getSkeletonBuilder"),A.registerModuleWithInitializer(f,a))}function x(){function b(a){A.getModule(e).done(function(b){b=KindleBookResourceUrlTranslator(D[BookChunk.RESOURCE_TYPE],b,F);O.endSubTimer(Y,"getResourceUrlTranslator");a.resolve(b)}).fail(a.fail)}A.isModuleRegistered(a)||
(O.startSubTimer(Y,"getResourceUrlTranslator"),A.registerModuleWithInitializer(a,b))}function H(){function a(b){var g=b.context&&b.metadata&&b.fragmap?b:null;if(b.cacheState){W=b.cacheState;if(W===Kindle.BookInfo.CachedState.PINNING)Ba=Kindle.BookInfo.CachedState.PINNED;Kindle.BookInfo.CachedState.isFullyDownloaded(W)&&A.registerModule(d,!0)}b.context!==void 0&&A.registerModule(h,b.context);b.metadata!==void 0&&(t(b.metadata),A.registerModule(j,b.metadata));b.manifest!==void 0?A.registerModule(e,
b.manifest):A.registerModule(e,{});b.fragmap!==void 0&&A.registerModule(c,b.fragmap);da.resolve(g)}function b(a){function c(){window.location.reload(!0)}a&&a.code===Kindle.DB.DATABASE_ERR&&a.message.indexOf("no such table")>=0&&O.emit("App::DatabaseGoneOnGetBookInfo",{breakdown:["Browser"]}).then(c,c);da.resolve()}if(!da){da=new jQuery.Deferred;if(g.contentProvider)w=g.contentProvider;else{var f=A.getModuleSync(A.DB_CLIENT);f.getBookDb()&&(f=f.getBookDb().BookInfoDB(L),w=DatabaseContentCache.create({bookinfoDb:f,
asin:L}))}w?w.queryBookinfo().then(a,b):(ha=!1,b())}return da.promise()}function C(){M=O.startMetrics("BookDownload::Reading",{breakdown:["Browser"]});A.getModuleList([h,j,e,c,b]).done(function(a){var b=$.extend({},a[h]);delete b.kindleSessionId;a={metadata:a[j],manifest:a[e],fragmap:a[c],context:b,cacheState:Ua};ha?(E.putBookinfo(a),KindleLocalStorage.getItem(Kindle.CACHING.CACHING)!==Kindle.CACHING.ENABLED&&(O.emit([{name:z.ENABLED,params:{breakdown:["Browser"]}}]),KindleLocalStorage.setItem(Kindle.CACHING.CACHING,
Kindle.CACHING.ENABLED))):KindleLocalStorage.getItem(Kindle.CACHING.CACHING)!==Kindle.CACHING.DISABLED&&(O.emit([{name:z.DISABLED,params:{breakdown:["Browser"]}}]),KindleLocalStorage.setItem(Kindle.CACHING.CACHING,Kindle.CACHING.DISABLED))})}function I(k){function l(b){var g,k=new jQuery.Deferred,m=O.createTimer();if(b)W=Kindle.BookInfo.CachedState.PARTIAL,g=Kindle.ERROR.FORCE_DELETE;else if(W===Kindle.BookInfo.CachedState.PINNED)Ua=W=Kindle.BookInfo.CachedState.PINNING,Ba=Kindle.BookInfo.CachedState.PINNED,
g=Kindle.ERROR.PINNED_CONTENT_UPGRADE;else if(W===Kindle.BookInfo.CachedState.CACHED)W=Kindle.BookInfo.CachedState.PARTIAL,g=Kindle.ERROR.CONTENT_UPGRADE;(w?w.deleteBooksData():$.Deferred().resolve()).fail(k.reject).done(function(){A.detachModule(d);A.detachModule(c);A.detachModule(j);A.detachModule(e);A.detachModule(h);A.detachModule(f);A.detachModule(a);x=null;m.emit(b?"BookDownload::ForceDelete":"BookDownload::ContentUpgrade");k.resolve(g)});return k.promise()}function m(a){function f(){var k;
if(a.downloadRestrictionReason)pa=a.downloadRestrictionReason.reasonCode,ua=a,N.reject(F);else{k=r.createSubTimer("finishStartReading");g.contentProvider&&g.contentProvider.initMetadata({version:a.contentVersion,acr:a.formatVersion});if(A.isModuleInitialized(h)){var l=A.getModuleSync(h),m=!1;if(l.originType==="FreeTrial"&&l.expirationDate!==a.expirationDate)l.expirationDate=a.expirationDate,m=!0;if(l.contentVersion===a.contentVersion&&l.lastPageReadData&&a.lastPageReadData&&l.lastPageReadData.position!==
a.lastPageReadData.position)l.lastPageReadData=a.lastPageReadData,m=!0;if(l.isOwned===void 0)l.isOwned=a.isOwned!==void 0?a.isOwned:!0,m=!0;if(l.contentType===void 0)l.contentType=a.contentType||(l.isSample?Kindle.CONTENT_TYPE.EBSP:Kindle.CONTENT_TYPE.EBOK),m=!0;m&&w.updateBookinfo({context:l});l.kindleSessionId=a.kindleSessionId;ua=l}else ua=a,A.registerModule(h,a);if(a.originType==="FreeTrial"&&(KindleBadging.pushAsinForBadgeUpdate(F.getAsin()),a.expirationDate<=Date.now())){pa=Kindle.ERROR.FREE_TRIAL_EXPIRED;
N.reject(F);return}if(a.contentType===Kindle.CONTENT_TYPE.EBSP)!P&&!a.isOwned&&(ha=!1,w=null),A.isModuleInitialized(d)||A.registerModule(d,!0);else if(g.isSample){k.endTimer();r.endTimer();r.log();pa=Kindle.ERROR.UNKNOWN_ERR;N.reject(F);return}a.contentChecksum&&!A.isModuleInitialized(d)&&A.registerModule(d,a.contentChecksum);x||(B=!0,y(),C());$.when(s(),u(),q()).done(function(){k.endTimer();k=r.createSubTimer("resolve");N.resolve(F);k.endTimer();r.endTimer();r.log()}).fail(function(){pa=Kindle.ERROR.OPEN_BOOK_LOAD_FAILURE;
N.reject(F)});K.getPageNumbers().done(function(a){a&&(V=a,V.arePageNumbersAvailable()&&typeof KindleReaderUI!=="undefined"&&KindleReaderUI.initializePageNumbers(V))});A.getModuleList([h,j,e,c,b]).done(o).fail(aa.reject)}}Pa=!0;I.endTimer();O.endSubTimer(Y,"StartReading");var k=x&&a.contentVersion&&a.contentVersion!==x.context.contentVersion,n=x&&a.formatVersion&&a.formatVersion!==x.context.formatVersion,v=a.downloadRestrictionReason&&a.downloadRestrictionReason.reasonCode,v=v===Kindle.ERROR.CONTENT_LOAN_ENDED||
v===Kindle.ERROR.CONTENT_RENTAL_EXPIRED;J=k||n;k||n||v?l(v).then(f,function(a){pa=a;N.reject(F)}):f()}function n(a){Pa=!1;O.endSubTimer(Y,"StartReading");x?(ua=x.context,N.resolve(F)):(pa=a,N.reject(F));Kindle.BookInfo.CachedState.isFullyDownloaded(W)?(K.getPageNumbers().done(function(a){a&&(V=a,V.arePageNumbersAvailable()&&typeof KindleReaderUI!=="undefined"&&KindleReaderUI.initializePageNumbers(V))}),aa.resolve()):aa.reject(Kindle.ERROR.NETWORK,Kindle.ERROR_CODE.START_READING)}function v(a){t.endTimer();
x=a;O.endSubTimer(Y,"CheckDB");O.startMetrics("Reader::StartReading");I=r.createSubTimer("startReading");a=$.extend({asin:L},g);if(x&&x.context&&W===Kindle.BookInfo.CachedState.PINNED)a.kindleSessionId=x.context.kindleSessionId;O.startSubTimer(Y,"MetadataLoaded");N.always(function(){O.endSubTimer(Y,"MetadataLoaded");O.renameSubTimer(Y,"MetadataLoaded","MetadataLoaded::"+(B?"RemoteContent":"LocalContent"))});O.startSubTimer(Y,"StartReading");z=sa(a);x&&y();z.then(m,n)}var x,r,t,I,z;aa=new jQuery.Deferred;
Y=k;r=KindleMetricsProfiler("bookInfo.startReading");t=r.createSubTimer("getInfoFromDB");O.startSubTimer(Y,"CheckDB");if(g.kcrFree==="only")g.isSample=!0;var B=!1;g.isSample&&!P?(ha=!1,v(null)):H().done(v);return N.promise()}var z={DISABLED:"Book::Caching::Disabled",ENABLED:"Book::Caching::Enabled"},B=null,w=null,E=null,K=null,D=null,M,N=$.Deferred(),F,L=g.asin,P=g.cacheSample,A=k||KindleModuleManager,O=A.getModuleSync(A.METRICS_MANAGER),J,G=null,V=null,da=null,W=null,ca=null,ea=null,ha=!0,aa=null,
Aa=null,Ba=Kindle.BookInfo.CachedState.CACHED,Oa=!1,Ua=Kindle.BookInfo.CachedState.PARTIAL,Ga=null,Y=null,Pa,pa,ua,Va=!1,Z=!1,sa=function(a){var b=new jQuery.Deferred;A.getModuleSync(A.SERVICE_CLIENT).startReading(a).pipe(function(b){var c=b.downloadRestrictionReason&&b.downloadRestrictionReason.reasonCode,g=[Kindle.ERROR.CONTENT_LOANED,Kindle.ERROR.CONTENT_LOAN_ENDED,Kindle.ERROR.CONTENT_LICENSE_EXCEEDED,Kindle.ERROR.CONTENT_RENTAL_EXPIRED,Kindle.ERROR.SESSION_LIMIT_EXCEEDED];return a.kcrFree&&b&&
b.contentType!==Kindle.CONTENT_TYPE.EBSP&&g.indexOf(c)>=0?(a.isSample=!0,A.getModuleSync(A.SERVICE_CLIENT).startReading(a)):b}).pipe(function(c){var g=c.isSample||!1;if(c.isOwned===void 0)c.isOwned=!g;if(c.contentType===void 0)c.contentType=g?Kindle.CONTENT_TYPE.EBSP:Kindle.CONTENT_TYPE.EBOK;if(a.kcrFree)c.kcrFree=!0;b.resolve(c)},function(){b.reject("timeout")});return b.promise()};return F={getBookInfoDfd:function(){return N.promise()},getAsin:function(){return L},getRefEmId:function(){var a=A.getModuleSync(j);
return a.refEmId||a.referenceEmbeddedId||a.guid},isOpenedOnline:function(){return Pa},getOpenError:function(){return pa},getContext:function(){return ua},startReading:function(a,c){A.registerModuleWithDeferred(b,c);return I(a)},doneReading:function(){D.close(Kindle.ERROR.USER_CLOSED_BOOK)},getImageBaseUrl:function(){return A.getModuleSync(h).imageBaseUrl+"/"},getKindleSessionId:function(){return A.getModuleSync(h).kindleSessionId},getFragmentMap:function(a,b){setTimeout(function(){A.getModule(c).then(a,
b)},15)},getBookType:function(){return A.getModuleSync(c).fragmentMetadata.bookType},getBookSkeleton:function(a,b,c){A.getModule(f).then(function(g){g.buildSkeleton(c).then(a,b)},b)},getBookFragments:function(a,b,c){D[BookChunk.FRAGMENT_TYPE].getChunks(c,function(b){if(b.fragmentMetadata.compression===1||b.fragmentMetadata.compression===2){b.fragmentData=KindleCompression.lzExpandWithStaticDictionary(b.fragmentData,ca);if(b.paraData!==void 0&&typeof b.paraData==="string"){var c=KindleCompression.lzExpandWithStaticDictionary(b.paraData,
ea,256);b.paraData=JSON.parse(c)}delete b.fragmentMetadata.compression}a(b)},b)},getGlyphFragments:function(a,b,c){D[BookChunk.GLYPH_TYPE].getChunks(c,function(b){if(b.glyphFragmentMetadata.compression===1||typeof b.glyphData==="string"){var c=KindleCompression.lzExpandWithStaticDictionary(b.glyphData,ea,256);b.glyphData=JSON.parse(c);delete b.glyphFragmentMetadata.compression}a(b)},b)},getMetadata:function(a,b){return A.getModule(j).then(a,b)},getResourceUrls:function(b,c,g){A.getModule(a).then(function(a){a.getResourceUrls(g,
b,c)},c)},UNKNOWN_FPR:-1,getFurthestPositionReadData:function(){return A.getModuleSync(h).lastPageReadData||{}},getLocationConverter:function(){function a(b){var c=jQuery.Deferred();D[BookChunk.LOCATIONMAP_TYPE].getChunks([b],c.resolve,c.reject);return c}if(G===null){var b={},g=A.getModuleSync(c),f=A.getModuleSync(j);b.locationsInfo=f.locationsInfo;b.minPosition=g.fragmentArray[0].cPos;b.maxPosition=g.fragmentArray[g.fragmentArray.length-1].ePos;b.mapGetter=a;G=KindleUserLocationConverter.getLocationConverter(g.fragmentMetadata.bookType,
b)}return G},getPageNumberConverter:function(){return V},hasCover:function(a,b){var c=$.Deferred();A.getModuleSync(h).manifestUrl?A.getModule(e).then(function(a){a=a.coverResource;c.resolve(a!==void 0&&a!==null)},c.reject):c.resolve(!1);return c.promise().then(a,b)},isContentScrambled:function(){return Va},updateContentScrambledFlag:function(a){a.metadata.map&&(Va=!0)},setNetworkAccessed:function(a){Z=a},isNetworkAccessed:function(){return Z},getCoverUrl:function(a,b){var c=$.Deferred();A.getModuleSync(h).manifestUrl?
A.getModule(e).then(function(a){a=a.coverResource;a!==void 0&&a!==null&&D[BookChunk.RESOURCE_TYPE].getChunks(a,function(a){c.resolve(a)},c.reject)},c.reject):c.resolve(null);return c.promise().then(a,b)},getCachedAnnotations:function(){return!w?$.Deferred().reject():w.getAnnotations()},cacheAnnotations:function(a){return!w?$.Deferred().reject():w.putAnnotations(a)},getCachedPageNumbers:function(){return!w?$.Deferred().reject():w.getPageNumbers()},cachePageNumbers:function(a){return!w?$.Deferred().reject():
w.putPageNumbers(a)},getBookPositions:function(){var a=new jQuery.Deferred;A.getModule(j).then(function(b){var c=KindleModuleManager.getModuleSync(h);a.resolve({toc:b.positions.toc,srl:c.srl||b.positions.srl,cover:b.positions.cover})},a.reject);return a.promise()},getSearchIndex:function(){return K.getSearchIndex()},startDownloading:function(a,c){[Kindle.MODULE.SidecarManager,Kindle.MODULE.SearchIndexManager,Kindle.MODULE.PageNumberManager].forEach(function(a){A.isModuleRegistered(a)||(KindleDebug.log("Copying registration of "+
a),A.registerModule(a,KindleModuleManager.getModuleSync(a)))});KindleReaderAnnotationManager.clear();Ba=Kindle.BookInfo.CachedState.PINNED;Oa=!0;A.registerModuleWithDeferred(b,c);var g=I(a);aa.always(KindleReaderAnnotationManager.clear);return g},cancelDownloading:function(a){D.downloadController&&D.downloadController.failDownload(a||Kindle.ERROR.CANCELLED)},pauseDownloading:function(){E&&E.downloadController.pauseDownload()},resumeDownloading:function(){E&&E.downloadController.resumeDownload()},
getDownloadComplete:function(a){Aa=a;return aa.promise()},isBookDownloaded:function(){return W===Kindle.BookInfo.CachedState.CACHED||W===Kindle.BookInfo.CachedState.PINNED},setCachedState:n,getSizeInfo:function(){var a=new jQuery.Deferred;$.when(A.getModule(j),w.computeQuota()).then(function(b,c){a.resolve({bookSize:b.bookSize,quota:c})},a.reject);return a.promise()},isUpdated:function(){return!!J}}}}}var KindleReaderBookInfoProvider=KindleReaderBookInfoProviderFactory();
function KindleBookSkeletonBuilderFactory(h,j,e,d){function c(a,b){b&&(a=a.replace(/\burl\s*\(\s*(?:'([^']*)'|"([^"]*)")\s*\)/gi,function(a,c,g){return(c=b[c||g])?'url("'+c+'")':c===null?"none":a}));return a}function b(a,b,c,f){a=a.includes;if(a!==void 0){for(var d,e=0;e<a.length;e++){var h=f[a[e]],q=b[h.metadata.id];if(q.type==="text/css")d=d||{},d[q.name]=h.data}if(d)c.skeletonData=c.skeletonData.replace(/<link\s(?:[^\/>'"]|'[^']*'|"[^"]*")*href\s*=\s*(?:'([^']*)'|"([^"]*)")(?:[^\/>'"]|'[^']*'|"[^"]*")*(?:\/>|>\s*<\/link>)/gi,
function(a,b,c){return(b=d[b||c])?'<style type="text/css">'+b+"</style>":a})}}function f(a,f,d,e){if(d!==null){var h=a.resourceManifest,a=a.skeletonManifest[f.skeletonMetadata.id],r;for(r in d){var o=d[r],q=h[o.metadata.id].includes;if(q!==void 0){for(var t={},s=0;s<q.length;s++){var u=d[q[s]];t[h[q[s]].name]=u===void 0?null:u.data}o.data=c(o.data,t)}}b(a,h,f,d);d=a.depends;if(d!==void 0){r=[];for(a=0;a<d.length;a++)o=h[d[a]],o.resInfo!==void 0&&r.push(o.resInfo);f.resourceInfo=r}}e.resolve(f)}var a=
{};a.skeletonManager=h;a.resourceManger=j;a.manifest=e;a.dictionary=d;a.buildSkeleton=function(a){function b(a){a.data=c(a.data,a.resList);t[a.metadata.id]=a;r++;q!==null&&r>=h&&f(s,q,t,d)}var d=new jQuery.Deferred,e=this.dictionary,h=0,r=0,o=[];if(this.manifest.skeletonManifest!==void 0&&this.manifest.skeletonManifest[a]!==void 0&&this.manifest.skeletonManifest[a].depends!==null)o=this.manifest.skeletonManifest[a].depends.slice(),h=o.length;var q=null,t=null,s=this.manifest;this.skeletonManager.getChunks([a],
function(a){if(a.skeletonMetadata.compression===1)a.skeletonData=KindleCompression.lzExpandWithStaticDictionary(a.skeletonData,e),delete a.skeletonMetadata.compression;r>=h?f(s,a,t,d):q=a},d.reject);h>0&&(t={},this.resourceManger.getChunks(o,b,d.reject));return d.promise()};return a}
var KindleCompression=function(){function h(a,c,g){var f,g=g>0?g:b;for(f in c)c[f]>=g&&(g=c[f]+1);f=g;for(var d in a)for(var g=a[d],e=2;e<=g.length;e++){var h=g.substr(0,e);c.hasOwnProperty(h)||(c[h]=f++)}return c}function j(c,e){var l,h=b;l="";for(var r=0;r<e.length;){var o=e.charAt(r);r++;o.charCodeAt(0)<=d?c.hasOwnProperty(l+o)?l+=o:(l.length>0&&h<f&&(c[l+o]=h,h++,h===a&&(h=g)),l=o):l=""}return c}function e(){if(defaultDictionary===void 0||defaultDictionary==={})defaultDictionary=j({},defaultDictionaryString);
return defaultDictionary}var d=9983,c=d+1,b=c+100+1,f=65533,a=55295,g=57344;return{lzCompress:function(k){var e={},l=[],h,r=b,o,q,t;o=h="";for(var s=0;s<k.length;){var u=k.charAt(s);s++;if(u.charCodeAt(0)<=d){for(;o.length>0;){q=Math.min(100,o.length);t=o.substr(0,q);o=o.substr(q);l.push(c+q);for(q=0;q<t.length;q++)l.push(t.charCodeAt(q))}e.hasOwnProperty(h+u)?h+=u:(h.length>0&&(l.push(h.length===1?h.charCodeAt(0):e[h]),r<f&&(e[h+u]=r,r++,r===a&&(r=g))),h=u)}else h.length>0&&(l.push(h.length===1?
h.charCodeAt(0):e[h]),h=""),o+=u}for(h.length>0&&l.push(h.length===1?h.charCodeAt(0):e[h]);o.length>0;){q=Math.min(100,o.length);t=o.substr(0,q);o=o.substr(q);l.push(c+q);for(q=0;q<t.length;q++)l.push(t.charCodeAt(q))}for(i=0;i<l.length;i++)l[i]=String.fromCharCode(l[i]);return l.join("")},lzExpand:function(k){for(var e={},l=[],h,r=b,o="",q,t=0;t<k.length;){h=k.charCodeAt(t);t++;if(h<=d)h=String.fromCharCode(h);else if(h>=b)(h=e[h])||(h=o+q);else{o=h-c;l.push(k.substr(t,o));t+=o;o="";continue}l.push(h);
q=h.charAt(0);r<f&&o.length>0&&(e[r]=o+q,r++,r===a&&(r=g));o=h}return l.join("")},lzBuildDictionary:j,lzGetDecompressionDictionary:function(a){var b=[],c;for(c in a)b[a[c]]=c;return b},lzAddStringsToDictionary:h,lzAddNumbersToDictionary:function(a,b){for(var c=[],g=100;g<1E3;g++)c.push(""+g);return h(c,a,b)},lzCompressWithStaticDictionary:function(a,b){if(b===void 0||b==={})b=e();var g=[],f,h,o,q;h=f="";for(var t=0;t<a.length;){var s=a.charAt(t);t++;if(s.charCodeAt(0)<=d){for(;h.length>0;){o=Math.min(100,
h.length);q=h.substr(0,o);h=h.substr(o);g.push(c+o);for(o=0;o<q.length;o++)g.push(q.charCodeAt(o))}b.hasOwnProperty(f+s)?f+=s:(f.length>0&&g.push(f.length===1?f.charCodeAt(0):b[f]),f=s)}else f.length>0&&(g.push(f.length===1?f.charCodeAt(0):b[f]),f=""),h+=s}for(f.length>0&&g.push(f.length===1?f.charCodeAt(0):b[f]);h.length>0;){o=Math.min(100,h.length);q=h.substr(0,o);h=h.substr(o);g.push(c+o);for(o=0;o<q.length;o++)g.push(q.charCodeAt(o))}for(i=0;i<g.length;i++)g[i]=String.fromCharCode(g[i]);return g.join("")},
lzExpandWithStaticDictionary:function(a,g,f){if(g===void 0||g===[]){if(defaultDeDictionary===void 0||defaultDeDictionary===[]){e();defaultDeDictionary=[];for(var h in defaultDictionary)defaultDeDictionary[defaultDictionary[h]]=h}g=defaultDeDictionary}h=d;var r=b;f!==void 0&&(h=f-1,r=f);for(var f=[],o=0;o<a.length;){var q=a.charCodeAt(o);o++;q<=h?f.push(String.fromCharCode(q)):q>=r?f.push(g[q]):(q-=c,f.push(a.substr(o,q)),o+=q)}return f.join("")}}}(),ContentMigration=function(){function h(c){function b(a){var b=
"get"+(a.substr(0,1).toUpperCase()+a.substr(1))+"Ids";return c.source[b]().pipe(function(b){function g(){var k=b.splice(0,100);if(k.length===0)f.then(d.resolve,d.reject);else{var e="get"+(a.substr(0,1).toUpperCase()+a.substr(1))+"s",k=c.source[e](k);$.when(k,f).then(function(b){var d={};b.forEach(function(a,b){d[b]=a});f=c.target("putChunksNonT",c.asin,a,d);setTimeout(g,100)},d.reject)}}var f=$.Deferred().resolve(),d=$.Deferred();g();return d.promise()})}function f(){var c=BookChunk.types[g++];c?
b(c).then(f,a.reject):a.resolve()}var a=$.Deferred(),g=0,d=c.timer.createSubTimer("chunks");f();a.done(function(){d.endTimer()});return a.promise()}function j(c){var b=$.Deferred(),f=c.timer.createSubTimer("annotations");c.source.getAnnotations().then(function(a){c.target("putAnnotations",c.asin,a).then(b.resolve,b.reject)},b.reject);b.done(function(){f.endTimer()});return b.promise()}function e(c){var b=$.Deferred(),f=c.timer.createSubTimer("pageNumbers");c.source.getPageNumbers().then(function(a){c.target("putPageNumbers",
c.asin,a).then(b.resolve,b.reject)},b.reject);b.done(function(){f.endTimer()});return b.promise()}function d(c){var b=$.Deferred(),f=c.timer.createSubTimer("bookinfo");c.source.getBookInfo().then(function(a){c.target("putBookinfo",c.asin,a).then(b.resolve,b.reject)},b.reject);b.done(function(){f.endTimer()});return b.promise()}return{initialize:function(){KindleModuleManager.define(KindleModuleManager.CONTENT_MIGRATION,[Kindle.MODULE.DB_CLIENT,KindleModuleManager.EMBEDDED_HOSTINTERFACE],function(c,
b){return{moveBook:function(f){var a=$.Deferred(),g=c.getBookDb();if(!f)return a.reject("Need ASIN as param").promise();var k={timer:KindleMetricsProfiler("Migrate "+f),asin:f,target:b.contentProvider,source:g.BookInfoDB(f)},f=$.when(h(k),j(k),e(k),d(k));f.then(function(){k.timer.endTimer();k.timer.log()});f.then(a.resolve,a.reject);return a.promise()},notifyMigrationStatus:function(b){var a=$.Deferred();if(!b||!b.status)return a.reject("Need param.status as param").promise();b.status==="done"?c.getBookDb().dropTables().then(a.resolve,
a.reject):a.reject("this status is not handled");return a.promise()}}})}}}(),DatabaseContentCache=function(){return{create:function(h){var j=$.Deferred(),e=h.bookinfoDb,d={};BookChunk.types.forEach(function(c){var b=c.substr(0,1).toUpperCase()+c.substr(1);d[c]={getChunks:function(c,a,g){e["get"+b+"s"](c).then(a,g)},putChunks:function(c,a,g){e["put"+b+"s"](c).then(a,g)},getCachedIds:function(c,a){e["get"+b+"Ids"]().then(c,a)}}});d.queryBookinfo=function(){return e.getBookInfo().pipe(function(c){j.resolve(c);
return c})};d.getBookinfo=function(){return j.promise()};d.putBookinfo=function(c){j.resolve(c);return e.insertBookInfo(c)};d.updateBookinfo=e.updateBookInfo;d.getAnnotations=e.getAnnotations;d.putAnnotations=e.putAnnotations;d.getPageNumbers=e.getPageNumbers;d.putPageNumbers=e.putPageNumbers;d.getSearchIndex=e.getSearchIndex;d.putSearchIndex=e.putSearchIndex;d.computeQuota=function(){return e.computeCacheQuota()};d.getBookStatistics=e.getBookStatistics;d.checkCache=function(){return!0};d.deleteOldestBook=
function(c,b){e.deleteOldestBookData(h.asin).then(c,b)};d.deleteBooksData=function(){bookInfo=void 0;j.state()!=="pending"&&(j=$.Deferred());return e.deleteBooksData([h.asin])};return d}}}(),DownloadingContentProvider=function(){function h(e){function d(g,d,e){function h(b){var c;if(!a){for(c in b)d(b[c]),f.removeId(c);var g=[],e;for(e=0;e<s.length;e++)c=s[e],b[c]===void 0&&(y=c,g.push(c));s=g;g.length>0?t(g):q()}}function n(){a||t(s)}function r(c){function g(){a||d(c)}if(!a){var f=BookChunk.getId(c);
if(b){var e=[];e[f]=c;b.putChunks(e,g,g);--u===0&&q()}else d(c)}}function o(b,g,f,d){var k;a||(Object.prototype.toString.call(d)==="[object Array]"?(k=d,d="list"):k=[d],v[d]=v[d]+1||1,v[d]<=2?c.getChunks(k,r,o):(e(b,g,f),--u===0&&q()))}function q(){f.setNextId(y);setTimeout(flowControl.resume,0)}function t(a){u=a.length;c.getChunks(a,r,o)}Object.prototype.toString.call(g)!=="[object Array]"&&(g=[g]);var s=g.slice(0),u=0,y=Math.max.apply(Math,s)+1,v=[];b?(flowControl.pause(),b.getChunks(g,h,n)):t(g)}
var c,b,f,a=!1;c=e.source;b=e.cache;f=e.downloader;flowControl=e.flowControl;return{getChunks:d,getPieces:function(a,b,c){return d(a,b,c)},close:function(){a=!0}}}function j(e,d){var c=KindleBookDownloaderFactory({type:d,cache:!0,throttle:BookChunk.properties[d].huge,netGetter:e.source[d].getChunks,urlGetter:e.source[d].getUrls,fileGetter:e.source[d].getChunkFromUrl,dbPutter:e.cache[d].putChunks,dbGetIdList:e.cache[d].getCachedIds,dbCheckCache:e.cache.checkCache,dbOosHandler:e.cache.deleteOldestBook,
fileProgress:function(c){b.callEventListeners("onProgress",d,c)},dbIsCached:function(){b.callEventListeners("onCompleted",d)},dbIsOos:function(){b.callEventListeners("onFailed",d,Kindle.ERROR.OUT_OF_SPACE)},downloadError:function(c,a){b.callEventListeners("onFailed",d,c,a)},isIdRequired:e.tweaks&&e.tweaks[d]&&e.tweaks[d].isIdRequired}),b=ListenerManager();return{init:function(b,a){c.initialize(b,a)},start:function(){c.startReadAhead()},cancel:function(){c.cancelReadAhead()},pause:function(){c.pauseReadAhead()},
resume:function(){c.resumeReadAhead()},setNextId:function(b){c.setNextId(b)},removeId:function(b){c.removeIdFromReadAhead(b)},getNumIds:function(){return c.numIds},addEventListener:function(c,a){b.addEventListener(c,a)}}}return{create:function(e){var d={},c={},b={},f={},a={pause:function(){f.pauseDownload()},resume:function(){f.resumeDownload()}};BookChunk.types.forEach(function(b){c[b]=j(e,b);d[b]=h({type:b,source:e.source[b],cache:e.cache[b],downloader:c[b],flowControl:a})});b={downloadingContentProvider:d,
fast:e.readAheadAgressively,downloaders:c,sidecarManager:e.sidecarManager};f=BookDownloadController.create(b);d.queryBookinfo=e.cache.queryBookinfo;d.getBookinfo=e.cache.getBookinfo;d.putBookinfo=e.cache.putBookinfo;d.computeCacheQuota=e.cache.computeQuota;d.downloadController={startDownload:f.startDownload,failDownload:f.failDownload,cancelDownload:f.failDownload,pauseDownload:f.pauseDownload,resumeDownload:f.resumeDownload,whenDownloadComplete:f.whenDownloadComplete};d.close=function(a){e.source.close();
f.failDownload(a);BookChunk.types.forEach(function(a){d[a].close()})};return d}}}(),ContentPrefetchOptimizations=function(){function h(c,g,d){function e(c){function k(b){for(ix=0;ix<a.length;ix++)if(a[ix].skeleton===b)return a[ix];return null}var h=k(c);h&&h.getSkeleton()!=="rejected"?h.getSkeleton().then(b(g),d):(a.splice(0,a.length-f),h=j(c),h.getSkeleton().then(b(g),d),a.push(h),++c<n.fragmentMetadata.numberOfSkeletons&&((h=k(c))||a.push(j(c))))}c.length>1||c[0]===0?m(c,g,d):e(c[0])}function j(a){var b=
e(a),g=b.fragmentIds,b=b.resourceIds,f=$.Deferred(),k={},h={};g.forEach(function(a){k[a]=$.Deferred()});b.forEach(function(a){h[a]=$.Deferred()});m(a,function(a){f.resolve(a)},function(a,b,c,g){f.reject(a,b,c,g)});d(g,function(a){k[a.fragmentMetadata.id].resolve(a)},function(a,b,c,g){k[g].reject(a,b,c,g)});c(b,function(a){h[a.metadata.id].resolve(a)},function(a,b,c,g){h[g].reject(a,b,c,g)});return{skeleton:a,getSkeleton:function(){return f},getFragmentById:function(a){return k[a]},getResourceById:function(a){return h[a]}}}
function e(a){var b=function(){return n.fragmentArray.filter(function(b){return b.sId===a}).map(function(a){return a.fId})}(),c=l.skeletonManifest[a].depends;l.fragmentManifest&&b.forEach(function(a){l.fragmentManifest[a]&&l.fragmentManifest[a].includes&&c.push.apply(c,l.fragmentManifest[a].includes)});return{fragmentIds:b,resourceIds:c}}function d(c,g,f){$.isArray(c)||(c=[c]);c=c.filter(function(c){for(var d=0;d<a.length;d++){var k=a[d].getFragmentById(c);if(k&&k.state!=="rejected")return k.then(b(g),
f),!1}return!0});c.length>0&&k(c,g,f)}function c(c,f,d){$.isArray(c)||(c=[c]);c=c.filter(function(c){for(var g=0;g<a.length;g++){var k=a[g].getResourceById(c);if(k&&k.state!=="rejected")return k.then(b(f),d),!1}return!0});c.length>0&&g(c,f,d)}function b(a){return function(b){b=jQuery.extend(!0,{},b);a(b)}}var f=40,a=[],g,k,m,l,n;return{modify:function(a,b,f){l=b;n=f;m=a[BookChunk.SKELETON_TYPE].getChunks;k=a[BookChunk.FRAGMENT_TYPE].getChunks;g=a[BookChunk.RESOURCE_TYPE].getChunks;a[BookChunk.SKELETON_TYPE].getChunks=
h;a[BookChunk.FRAGMENT_TYPE].getChunks=d;a[BookChunk.RESOURCE_TYPE].getChunks=c}}}(),KindleO_Aaa=function(){function h(b){for(var a=[],c,k,e,h,n,r,o=0;o<b.length;)e=b.charCodeAt(o++)&255,c=b.charCodeAt(o++),h=c&255,k=b.charCodeAt(o++),n=k&255,r=e>>2,e=(e&3)<<4|h>>4,h=(h&15)<<2|n>>6,n&=63,isNaN(c)?h=n=64:isNaN(k)&&(n=64),a.push(d.charAt(r)+d.charAt(e)+d.charAt(h)+d.charAt(n));return a.join("")}function j(b){for(var a=[],g,d,e,h,n,r=0;r<b.length;)g=c[b.charCodeAt(r++)],d=c[b.charCodeAt(r++)],h=c[b.charCodeAt(r++)],
n=c[b.charCodeAt(r++)],g=g<<2|d>>4,d=(d&15)<<4|h>>2,e=(h&3)<<6|n,a.push(String.fromCharCode(g)),h!==64&&a.push(String.fromCharCode(d)),n!==64&&a.push(String.fromCharCode(e));return a.join("")}function e(b,a){var c=[];c.length=256;for(var d=0;d<256;d++)c[d]=d;for(var e=0,h,d=0;d<256;d++)e=e+c[d]+a[d%a.length]&255,h=c[d],c[d]=c[e],c[e]=h;for(var e=d=0,n=[],r=0;r<b.length;r++)d=d+1&255,e=e+c[d]&255,h=c[d],c[d]=c[e],c[e]=h,n.push(String.fromCharCode(b.charCodeAt(r)^c[c[d]+c[e]&255]));return n.join("")}
for(var d="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",c=[],b=0;b<d.length;b+=1)c[d.charCodeAt(b)]=b;return{o_aaa:h,o_aag:j,o_aac:function(c,a){var g;g=c.replace(/\x0d\x0a/g,"\n");for(var d=[],m=0;m<g.length;m++){var l=g.charCodeAt(m);l<128?d.push(String.fromCharCode(l)):(l>127&&l<2048?d.push(String.fromCharCode(l>>6|192)):(d.push(String.fromCharCode(l>>12|224)),d.push(String.fromCharCode(l>>6&63|128))),d.push(String.fromCharCode(l&63|128)))}g=d.join("");d=a;d+="00000000000000000000000000000000".substring(0,
32-d.length);m=[];for(b=0;b<d.length;b+=2)m.push(parseInt(d.substring(b,b+2),16));return h(e(g,m))},o_aad:function(b,a){for(var c=j(b),d=[],h=0;h<a.length;h++)d.push(a.charCodeAt(h));for(var c=e(c,d),d=[],h=0,l,n,r;h<c.length;)l=c.charCodeAt(h),l<128?(d.push(String.fromCharCode(l)),h++):l>191&&l<224?(n=c.charCodeAt(h+1),d.push(String.fromCharCode((l&31)<<6|n&63)),h+=2):(n=c.charCodeAt(h+1),r=c.charCodeAt(h+2),d.push(String.fromCharCode((l&15)<<12|(n&63)<<6|r&63)),h+=3);return d.join("")}}}(),KindleReaderAnnotationManager=
function(){function h(a,b){return a.start-b.start}function j(a){for(var b=0;b<a.length;b++)if(a[b].guid&&!a[b].refEmId)a[b].refEmId=a[b].guid}function e(a){function b(){d(a).then(g.resolve,g.reject)}function c(){r(a).then(b,g.reject)}var g=new jQuery.Deferred;g.then(function(){for(var b=0;b<a.length;b++)A.emit(f(a[b]))},function(){for(var b=0;b<a.length;b++)A.emit(f(a[b],"Fail"))});k(a);for(var e=0;e<a.length;e++){if(a[e].asin===void 0||a[e].refEmId===void 0||a[e].start===void 0||a[e].type===void 0)return A.emit(f(a[e],
"Invalid")),KindleDebug.error("Tried to delete an invalid annotation."),g.reject().promise();if(a[e].note)a[e].note=q(a[e].note)}J.acquire().done(function(){O=Date.now();P.saveToJournal(a).then(c,g.reject);g.then(J.release,J.release)});return g.promise()}function d(a){function b(){for(var d,f=!1,e,k=0;k<a.length;k++)e=a[k],d=c(e.type,e.start),e.action===C?d===-1&&(F.push(e),f=!0):e.action===I?d!==-1&&(F.splice(d,1),F.push(e),f=!0):e.action===z&&d!==-1&&F.splice(d,1);f&&F.sort(h);g.resolve();K.cacheAnnotations(F)}
var g=new jQuery.Deferred;s().then(b,b);return g.promise()}function c(a,b){for(var c in F){var g=F[c];if(g.type===a&&g.start===b)return c}return-1}function b(a,b){return F[c(a,Number(b))]||null}function f(a,b){var c="Reader::"+w[a.action]+w[a.type];b&&(c+=b);return c}function a(a){for(var b=(new Date).getTime(),c=0;c<a.length;c++)a[c].asin=D,a[c].refEmId=M,a[c].action=C,a[c].modifiedTimestamp=b;return a}function g(a){for(var b=(new Date).getTime(),c=0;c<a.length;c++)a[c].action=z,a[c].modifiedTimestamp=
b;return a}function k(a){for(var b=0;b<a.length;b++)a[b].positionType=N;return a}function m(b){a(b);return e(b)}function l(a){for(var b=(new Date).getTime(),c=0;c<a.length;c++)a[c].action=I,a[c].modifiedTimestamp=b;return e(a)}function n(a){g(a);return e(a)}function r(a){function b(){function d(a){k.context=a;b()}for(var f,e,k;g<a.length&&!(a[g].action===C&&(a[g].type===v||a[g].type===H));)++g;if(g<a.length){k=a[g++];switch(k.type){case v:f=k.position;e=k.position+B;break;case H:f=k.start,e=k.end}o(f,
e).then(d,b)}else c.resolve()}var c=new jQuery.Deferred,g=0;b();return c.promise()}function o(a,b){G===null&&(G=KindleRenderer.createWordIterator());return G.getText(a,b)}function q(a){a.length>Kindle.opt.maxNoteChars&&(A.emit("Reader::NoteLengthLimitExceeded",{submetrics:[{name:"ResultSize",value:a.length}]}),a=a.substr(0,Kindle.opt.maxNoteChars));return a}function t(b,c,d,f){var k=KindleReaderAnnotationManager.getAnnotationsInRange(b,c,H),h=k.length,l={type:H,start:b,position:d,end:c},m=[];f&&m.push.apply(m,
a([{type:x,start:c,position:d,end:c,note:f}]));if(k.length===1&&b>=k[0].start&&c<=k[0].end){if(m.length===0)return(new jQuery.Deferred).resolve([k[0]])}else{if(h>0)l.start=Math.min(b,k[0].start),l.end=Math.max(c,k[h-1].end),m.push.apply(m,g(k));m.push.apply(m,a([l]))}return e(m)}function s(){var a=new jQuery.Deferred;K.getCachedAnnotations().then(function(b){b&&b.length!==void 0&&(F=b,j(F));a.resolve()},a.reject);return a.promise()}function u(){function a(){c.resolve()}function b(){c.resolve()}var c=
new jQuery.Deferred;L.getAnnotations(D,M).then(function(c){F=c.annotations;j(F);K.cacheAnnotations(F).then(a,b)},c.reject);return c.promise()}function y(){function a(){s().then(c.reject,c.reject)}function b(){u().then(c.resolve,a)}var c=new jQuery.Deferred;P.uploadJournal().then(b,b);return c.promise()}var v="kindle.bookmark",x="kindle.note",H="kindle.highlight",C="create",I="modify",z="delete",B=100,w={};w[v]="Bookmark";w[x]="Note";w[H]="Highlight";w[C]="Create";w[I]="Modify";w[z]="Delete";var E,
K=null,D=null,M=null,N=null,F=null,L=null,P=null,A,O=Date.now(),J=Lock(),G=null;return{BOOKMARK:v,NOTE:x,NOTE_ICON:"kindle.note.icon",HIGHLIGHT:H,POPULAR_HIGHLIGHT:"kindle.popular",getLastUpdateTime:function(){return O},deferredInitialize:function(a,b){function c(){E.resolve(d)}function g(a){L=a[b.SERVICE_CLIENT];P=a[b.JOURNAL_MANAGER];A=a[b.METRICS_MANAGER];y().then(c,c)}var d,f;E||(b=b||KindleModuleManager,E=$.Deferred(),d=this,f=[b.SERVICE_CLIENT,b.JOURNAL_MANAGER,b.METRICS_MANAGER],F=[],a.then(function(a){K=
a;D=K.getAsin();M=K.getRefEmId();N=K.getBookType();K.getContext().isOwned?b.getModuleList(f).then(g,E.reject):E.reject()},E.reject));return E.promise()},clear:function(){var a=E;E=null;F=[];D=M=N=null;a&&a.reject()},getAnnotation:b,getAllAnnotations:function(){return F.slice()},getAnnotationsInRange:function(a,b,c){var g=[],d;for(d in F){var f=F[d];(f.start<=b&&f.end>=a||f.start>=a&&f.start<=b)&&(!c||c===f.type)&&g.push(f)}return g},createBookmark:function(a){return m([{type:v,start:a,position:a,
end:a,context:""}])},createNote:t,modifyNote:function(a,c,g){var d=new jQuery.Deferred;(a=b(x,a))?(a.note=g,a.position=c,l([a]).then(d.resolve,d.reject)):d.reject();return d.promise()},createHighlight:function(a,b,c){return t(a,b,c,null)},deleteAnnotations:n,getContext:o,updateAnnotations:function(a){for(var b,c=[],g=[],d=[],f=[],e=0;e<a.length;e++)switch(b=a[e],b.action){case C:c.push(b);break;case I:d.push(b);break;case z:g.push(b)}c.length>0&&f.push(m(c));d.length>0&&f.push(l(d));g.length>0&&f.push(n(g));
return $.when.apply($,f)}}}(),NetworkContentProvider=function(){var h=3E4;return{create:function(j){function e(a,b){var c=new jQuery.Deferred;$.jsonp({url:a,callback:b,cache:!0,timeout:h,error:function(a,b){c.reject(a,b)},success:function(a){c.resolve(a)}});return c.promise()}function d(a,b,c){function d(a,b,c){var g,f;if(a&&a.length)for(g=0;g<a.length;g++)f=b+a[g].id,c(a[g].signedUrl,f,a[g].id)}j.bookInfo.setNetworkAccessed(!0);d(a.skeletonUrls,"loadSkeleton",function(a,d,f){e(a,d).then(function(a){if(a.skeletonMetadata!==
void 0&&a.skeletonMetadata.encryption===1){var c=KindleO_Aaa.o_aad(a.skeletonData,g);a.skeletonData=c;delete a.skeletonMetadata.encryption}b(a)},function(a,b){c(null,b,null,f)})});d(a.fragmentUrls,"loadFragment",function(a,d,f){e(a,d).then(function(a){if(a.fragmentMetadata!==void 0&&a.fragmentMetadata.encryption===1){var c=KindleO_Aaa.o_aad(a.fragmentData,g);a.fragmentData=c;delete a.fragmentMetadata.encryption}b(a)},function(a,b){c(null,b,null,f)})});d(a.glyphUrls,"loadGlyphFragment",function(a,
g,d){e(a,g).then(function(a){if(a.glyphFragmentMetadata!==void 0)a.glyphFragmentMetadata.id=d;b(a)},function(a,b){c(null,b,null,d)})});d(a.resourceUrls,"loadResource",function(a,g,d){e(a,g).then(function(a){j.bookInfo.updateContentScrambledFlag(a);b(a)},function(a,b){c(null,b,null,d)})});d(a.locationMapUrls,"loadMobiLocationMap",function(a,g,d){e(a,g).then(b,function(a,b){c(null,b,null,d)})})}function c(b,c){var g={asin:j.asin,contentVersion:a.contentVersion,formatVersion:a.formatVersion,isSample:a.isSample};
if(a.kindleSessionId)g.kindleSessionId=a.kindleSessionId;if(a.kcrFree)g.kcrFree=!0;g[b+"Ids"]=c;return f.getFileUrl(g)}function b(a,b,g,f){Object.prototype.toString.call(b)!=="[object Array]"&&(b=[b]);c(a,b).then(function(a){k||d(a,g,f)},function(a,c,g){f(a,c,g,b)})}var f,a,g,k=!1;a=j.context;g=a.contentChecksum;f=KindleModuleManager.getModuleSync(Kindle.MODULE.SERVICE_CLIENT);var m={};BookChunk.types.forEach(function(a){m[a]={getChunks:function(c,g,d){b(a,c,g,d)},getUrls:function(b,g,d){c(a,b).then(function(b){g(b[a+
"Urls"])},d)},getChunkFromUrl:function(b,c,g){var f={};f[a+"Urls"]=[b];d(f,c,g)}}});m.getFragmap=function(){var b=$.Deferred();e(a.fragmentMapUrl,"loadFragmap").then(function(a){b.resolve(a)},function(a,c){b.reject(c)});return b.promise()};m.getMetadata=function(){var b=$.Deferred();e(a.metadataUrl,"loadMetadata").then(function(a){b.resolve(a)},function(a,c){b.reject(c)});return b.promise()};m.getManifest=function(){function b(a){g.resolve(a)}function c(){g.resolve({})}var g=$.Deferred();a.manifestUrl?
e(a.manifestUrl,"loadManifest").then(b,c):g.resolve({});return g.promise()};m.close=function(){k=!0};return m}}}(),RemoteContentCache=function(){return{create:function(h){function j(a){f=a;if(!e||e.state!=="pending")e=$.Deferred();e.resolve(f)}var e=$.Deferred(),d=h.asin,c=h.contentProvider,b=h.contentRemover,f,a={};BookChunk.types.forEach(function(b){a[b]={getChunks:function(a,f,e){c("getChunks",d,b,a).then(f,e)},putChunks:function(a,f,e){var h={};a.forEach(function(a,b){h[b]=a});c("putChunks",d,
b,h).then(f,e)},getCachedIds:function(a,f){c("getChunkIds",d,b).then(a,f)}}});a.queryBookinfo=function(){return c("getBookinfo",d).pipe(function(a){j(a);return a})};a.getBookinfo=function(){return e.promise()};a.putBookinfo=function(a){j(a);return c("putBookinfo",d,a)};a.updateBookinfo=function(a){if(!f)return $.Deferred().reject("bad state");$.extend(f,a);return c("updateBookinfo",d,a)};a.getAnnotations=function(){return c("getAnnotations",d)};a.putAnnotations=function(a){return c("putAnnotations",
d,a)};a.getPageNumbers=function(){return c("getPageNumbers",d)};a.putPageNumbers=function(a){return c("putPageNumbers",d,a)};a.computeQuota=function(){return $.Deferred().resolve(0)};a.getBookStatistics=function(){return $.Deferred().reject()};a.checkCache=function(){return!0};a.deleteOldestBook=function(a,b){b()};a.deleteBooksData=function(){f=void 0;e.state()!=="pending"&&(e=$.Deferred());return b({asin:d})};a.downloadSearchIndex=function(a){return c("getSearchIndexReader",d,a)};a.initMetadata=
function(a){return c("initMetadata",d,a)};return a}}}();
function KindleBookResourceUrlTranslator(h,j,e){var d={};d.bookInfo=e;d.resourceManger=h;d.resourceManifest=j.resourceManifest;d.reverseLookup={};for(var c in d.resourceManifest)d.reverseLookup[d.resourceManifest[c].name]=c;d.getResourceUrls=function(b,c,a){function g(a){var b=n[a.metadata.id].name;d.bookInfo.updateContentScrambledFlag(a);var g={};g[b]=a.data;if(a.metadata)g.metadata=a.metadata;c(g)}for(var e=[],h=0;h<b.length;h++){var l=this.reverseLookup[b[h]];l!==void 0&&e.push(l)}var n=this.resourceManifest;
e.length!==b.length&&a();e.length>0?this.resourceManger.getChunks(e,g,a):c({})};return d}
(function(){function h(e){function d(){return KindleDebug.assert.apply(KindleDebug,arguments)}function c(){return KindleDebug.log.apply(KindleDebug,arguments)}function b(){return $.Deferred().reject.apply($,arguments)}function f(a){for(var a=new Uint8Array(e[a]),b=[],c=0;c<a.byteLength;c++)b.push(String.fromCharCode(a[c]));a=b.join("");return $.Deferred().resolve(a)}function a(a,c,g,f,e){a=a.cloneStream();a.seek(c);return a.readAsync(g).pipe(function(c){function g(){switch(f){case 1:return k.readByte()+
e;case 2:return k.readInt16()+e;case 3:return(k.readByte()<<16)+k.readUInt16()+e;case 4:return k.readInt32()+e;default:d("Got unexpected bytes-per-entity:"+f)}}try{for(var k=c,c=[];k.unconsumedBufferLength>0;)c.push(g());k.close();a.close();return c}catch(h){return a.close(),b(h)}},a.close)}function g(b,c){var g=b.directory.BytesPerEntity;return a(b.positionsStream,b.directory.Positions.offset+c.o*g,c.n*g,g,b.directory.MinimumTitleEntityValue)}var k={magicLength:4,magic:"AZSA",headerOffset:-28,directoryOffset:-24,
stringEntries:["Magic","WhereIndexed","IndexerHelperClassName"],wordsFilename:"index.words",positionsFilename:"index.positions",propertiesFilename:"index.properties"},h=$.Deferred();(function(a){var c,g,d,f=a.positionsStream,e=Math.min(f.size,Math.abs(k.headerOffset));f.seek(Math.max(0,f.size+k.headerOffset));return a.positionsStream.readAsync(e).pipe(function(c){try{var f=c.readInt32();g=c.readInt32();d=c.readInt32();c.close();if(f!==a.positionsStream.size)return b("bad header size");a.positionsStream.seek(g);
return a.positionsStream.readAsync(d)}catch(e){return b(e)}}).pipe(function(g){try{c={Magic:{offset:0,length:k.magicLength,isString:!0}};for(var d,f,e,h;g.unconsumedBufferLength>0;)if(d=g.readInt32(),f=g.readInt32(),e=g.readByte(),h=g.readString(e),c[h]={offset:d,length:f},k.stringEntries.indexOf(h)>=0)c[h].isString=!0;g.close();var m=c.SearchBoundaryPositions.offset;a.positionsStream.seek(0);return a.positionsStream.readAsync(m)}catch(o){return b(o)}}).pipe(function(g){function d(a){for(var b=Object.keys(c),
g=0;g<b.length;++g)if(c[b[g]].offset===a)return b[g]}try{for(var f,e=0;g.unconsumedBufferLength>0;){f=d(e);if(!f)return g.close(),b("Can't read directory entries");e+=c[f].length;if(c[f].isString)c[f]=g.readString(c[f].length);else if(c[f].length===1)c[f]=g.readByte();else if(c[f].length===4)c[f]=g.readInt32();else return g.close(),b("Bad size for numeric entry")}g.close();if(c.Magic!==k.magic)return b("bad magic");a.directory=c;return a}catch(h){return b(h)}})})({getPositionsForWord:function(a){var b=
$.Deferred(),d=this.wordList[a],f={word:a,searchBoundaryPositions:this.searchBoundaryPositions,positions:[]};d?g(this,d).pipe(function(g){c('Word "'+a+'" has '+g.length+" occurances");f.positions=g;b.resolve(f)},function(){b.reject(Kindle.ERROR.SITB_INDEX_UNREADABLE)}):b.resolve(f);return b.promise()},getProperty:function(a){return this.properties[a]},close:function(){this.positionsStream=null},positionsStream:new j(e.positions)}).pipe(function(a){return f("words").pipe(function(b){var c={};b.split("\n").forEach(function(a){a=
a.split(":");c[a[2]]={o:a[0],n:a[1]}});a.wordList=c;return a})}).pipe(function(a){return f("properties").pipe(function(b){var c={},g=/(.*?)=(.*)/;b.split("\n").forEach(function(a){a&&(a=g.exec(a),a.length===3&&(c[a[1]]=a[2]))});a.properties=c;return a})}).pipe(function(b){return a(b.positionsStream,b.directory.SearchBoundaryPositions.offset,b.directory.SearchBoundaryPositions.length,b.directory.BytesPerEntity,b.directory.MinimumTitleEntityValue).pipe(function(a){b.searchBoundaryPositions=a;return b})}).pipe(h.resolve,
function(){h.reject(Kindle.ERROR.SITB_INDEX_UNREADABLE)});return h.promise()}var j;KindleModuleManager.define("SearchIndexParser",["SearchIndexUtilities"],function(e){j=e.Stream;return{openSearchIndex:h}})})();
(function(){function h(a){function b(d){for(var f={},e,k=0;k<d.length;k++)if(e=d[k].filename,e.endsWith(l.words))f.words=d[k].data;else if(e.endsWith(l.properties))f.properties=d[k].data;else if(e.endsWith(l.positions))f.positions=d[k].data;f.asin=a.asin;g.endTimer();g.log();c.notify("finished");c.resolve(f)}var c=new $.Deferred,g=KindleMetricsProfiler("unzip search index");if(a.length>1)return KindleDebug.error("Cannot Unzip: We have too many array buffers"),c.reject("Index too large");KindleZip.unzip(a[0]).pipe(b,
b);return c.promise()}function j(a,b){for(var c=KindleMetricsProfiler("decrypt search index"),g=b.decryptionIV,d=b.decryptionKey,f=[],e,k=0;k<a.length;k++)e=KindleCrypto.decrypt(a[k],d,g),e=e.buffer,f.push(e);f.asin=b.asin;c.endTimer();c.log();return f}function e(a){function c(b){function d(){r.endTimer();D.push(z.response);E+=B;E<K?(w-=Date.now(),w<k?B*=2:w>m&&(B/=2),l()):(I.endTimer(),I.log(),M.resolve(D,v))}function f(a){a.lengthComputable?(a=Math.floor(100*a.loaded/a.total),a!==x&&(x=a)):KindleDebug.log("progress unknown")}
function e(){KindleDebug.error("An error occurred while transferring the file.");M.reject("failed")}function h(){KindleDebug.error("The transfer has been canceled by the user.");M.reject("cancelled")}function l(){w=Date.now();r=I.createSubTimer("@"+E);var a=Math.min(E+B-1,K);z=new XMLHttpRequest;z.open("GET",j);z.setRequestHeader("Range","bytes="+E+"-"+a);z.responseType="arraybuffer";z.addEventListener("progress",f,!1);z.addEventListener("load",d,!1);z.addEventListener("error",e,!1);z.addEventListener("abort",
h,!1);z.send(null)}var v=b;if(v.s3Url===null)return $.Deferred().reject(Kindle.ERROR.SITB_INDEX_NOT_AVAILABLE);v.asin=a.asin;var x=-1,j=v.s3Url.replace(/http:\/\//,"https://"),r,I=KindleMetricsProfiler("download search index"),z,B=g,w,E=0,K=v.indexSize-1,D=[],M=$.Deferred();l();return M}return KindleHostDeviceDetector.isOnline()?b.getSearchIndexInfo(a).pipe(c,function(a){return a.status===0?$.Deferred().reject(Kindle.ERROR.SITB_OFFLINE):$.Deferred().reject(Kindle.ERROR.SITB_COMMON_ERROR)}):$.Deferred().reject(Kindle.ERROR.SITB_OFFLINE)}
function d(b){function c(a){return!b.contentCache?$.Deferred().resolve(a):b.contentCache.putSearchIndex(a)}if(!KindleDeviceCapabilities.searchInTheBook())return $.Deferred().reject("Unsupported OS");if(a[b.asin])return a[b.asin];a={};a[b.asin]=(!b.contentCache?$.Deferred().reject("no db"):b.contentCache.getSearchIndex()).pipe(null,function(){return e(b).pipe(j).pipe(h).pipe(c)}).pipe(f.openSearchIndex);return a[b.asin]}function c(a){return a.contentCache.downloadSearchIndex({asin:a.asin})}var b,f,
a={},g=16777216,k=1E4,m=2E4,l={words:".words",positions:".positions",properties:".properties"};KindleModuleManager.define(Kindle.MODULE.SearchIndexManager,[Kindle.MODULE.SERVICE_CLIENT,Kindle.MODULE.DB_CLIENT,"SearchIndexParser"],function(a,g,e){b=a;f=e;return{getSearchIndex:KindleHostDeviceDetector.isMetro()?c:d}})})();
(function(){function h(e){if(!(this instanceof h)){var d=Object.create(h.prototype);return h.apply(d,arguments)}this.bytes=new Uint8Array(e);this.position=0;this.size=this.bytes.length;return this}function j(e,d,c){if(!(this instanceof j)){var b=Object.create(j.prototype);return j.apply(b,arguments)}this.uBytes=e.bytes;this.bytes=new Int8Array(this.uBytes);this.base=d!==void 0?d:0;this.position=0;this.unconsumedBufferLength=this.size=c!==void 0?c:this.uBytes.length-this.base;return this}if(!Uint8Array.prototype.subarray)Uint8Array.prototype.subarray=
function(e,d){for(var e=e===void 0?0:e,d=d===void 0||d>copy.length?copy.length:d,c=new Uint8Array(d-e),b=0;b<c.length;b++)c[b]=this[b+e];return c};h.prototype.seek=function(e){this.position=Math.min(Math.max(e,0),this.size)};h.prototype.readAsync=function(e){return $.Deferred().resolve(new j(this,this.position,Math.min(e,this.size-this.position)))};h.prototype.cloneStream=function(){var e=new h(this.bytes);e.position=this.position;return e};h.prototype.close=function(){this.bytes=null};j.prototype.seek=
function(e){this.position=Math.min(Math.max(e,0),this.size);this.unconsumedBufferLength=this.size-this.position};j.prototype.getPosition=function(){return this.position};j.prototype.readByte=function(){if(this.unconsumedBufferLength<1)throw Error("Out of data");var e=this.uBytes[this.base+this.position];this.position++;this.unconsumedBufferLength--;return e};j.prototype.readInt8=function(){if(this.unconsumedBufferLength<1)throw Error("Out of data");var e=this.bytes[this.base+this.position];this.position++;
this.unconsumedBufferLength--;return e};j.prototype.readInt16=function(){if(this.unconsumedBufferLength<2)throw Error("Out of data");var e=this.base+this.position,e=(this.bytes[e]<<8)+this.uBytes[e+1];this.position+=2;this.unconsumedBufferLength-=2;return e};j.prototype.readUInt16=function(){if(this.unconsumedBufferLength<2)throw Error("Out of data");var e=this.base+this.position,e=(this.uBytes[e]<<8)+this.uBytes[e+1];this.position+=2;this.unconsumedBufferLength-=2;return e};j.prototype.readInt32=
function(){return(this.readInt16()<<16)+this.readUInt16()};j.prototype.readUInt32=function(){return(this.readUInt16()<<16)+this.readUInt16()};j.prototype.readString=function(e){if(this.unconsumedBufferLength<e)throw Error("Out of data");var d=this.base+this.position,c;try{c=String.fromCharCode.apply(null,this.uBytes.subarray(d,d+e))}catch(b){c=[];for(var f=d;f<d+e;f++)c.push(String.fromCharCode(this.uBytes[f]));c=c.join("")}this.position+=e;this.unconsumedBufferLength-=e;return c};j.prototype.close=
function(){this.unconsumedBufferLength=0;this.uBytes=this.bytes=null};KindleModuleManager.define("SearchIndexUtilities",null,{Stream:h,Buffer:j})})();
(function(){function h(d){function c(){if(!a)if(q.seek(0),f=q.readInt16(),f!==1)KindleDebug.warn("Unsupported page numbering file format version "+f);else if(g=q.readInt16(),g===0)KindleDebug.log("PageNumbers File for this book is revoked by the service"),a=Kindle.ERROR.PN_REVOKED;else{k=[];for(var b=0;b<g;b++)k[b]=q.readUInt32();b=q.readUInt32();a=b>0?q.readString(b):"";h=[];r=[];l=[];n=[]}}function b(a){c();var b;a>=g||a<=-1?(KindleDebug.log("The requested page numbering edition at index "+a+" is out of bounds for the available count of editions "+
g),b=!1):b=!0;if(b&&!n[a])if(q.seek(k[a]),b=q.readInt16(),b!==1)KindleDebug.log("Unsupported edition pagination format "+b+" for edition "+a);else{b=q.readInt16();var d=q.readInt16(),f=q.readInt16();if(f>32)KindleDebug.log("Unsupported pagination format position width "+f+" for edition "+a);else{var e;b>0&&(e=q.readString(b));h[a]=parseInt(q.getPosition(),10);r[a]=d;l[a]=f;n[a]=e;return!0}}}var f,a,g,k,h,l,n,r,o=[],d=new e(d),q=new j(d,0,d.size);return{getHeaderMetadata:function(){c();return a},getEditionMetadata:function(a){return b(a)?
n[a]:!1},getOrdinalPagePositions:function(a){b(a);var c=r[a],g=l[a]/8;o.length=c+1;q.seek(h[a]);for(a=1;a<=c;a++){var d=g===2?q.readUInt16():g===4?q.readUInt32():0;o[a]=parseInt(d,10)}for(c=1;c<o.length;c++)o[c-1]>o[c]&&KindleDebug.log("Invalid position value at index "+c+": "+o[c]+", previous position: "+o[c-1]);return o},getEditionCount:function(){return g},getTotalPageCount:function(a){return r[a]}}}var j,e;KindleModuleManager.define("BinaryPageLabelSidecarReader",["SearchIndexUtilities"],function(d){j=
d.Buffer;e=d.Stream;return{openReader:h}})})();
var PageLabelIndexer=function(){return{create:function(h,j){function e(a){var c=0,g;for(g in b)b[g].getPageLabelType()===a&&b[g].getEndingOrdinalPageNumber()>c&&(c=b[g].getEndingOrdinalPageNumber());return c}function d(c){var g,d;c<1||c>a?d=void 0:(d=PageNumberUtilities.binarySearchPosition(f,c),d=b[f[d]]);d&&(c-=d.getStartingOrdinalPageNumber(),c=d.getStartingPageLabel()+c,g=d.getPageLabelAtSeriesIndex(c));return g}var c="",b,f,a;if(h==="")KindleDebug.log("pageLabelIndexString cannot be blank, pageLabelIndexString = "+c);
else if(j<0)KindleDebug.log("TotalPages cannot be less than 0, total pages = "+j);else{c=h.toString();a=j;var g=0,k=null;for(b={};g<c.length;){if(c.charAt(g)!=="("){KindleDebug.log("Each page number scheme must start with '('; was given: "+c.substring(g));return}var m=c.indexOf(")",g);if(m<0)break;g=c.substring(g+1,m);g=PageLabelSeq.create(g);k!==null&&k.setEndingOrdinalPageNumber(g.getStartingOrdinalPageNumber()-1);k=b[parseInt(g.getStartingOrdinalPageNumber(),10)]=g;g=m+1;g<c.length&&c.charAt(g)===
","&&g++}k.setEndingOrdinalPageNumber(j);f=[];var c=0,l;for(l in b)b.hasOwnProperty(l)&&(f[c]=b[l].getStartingOrdinalPageNumber(),c++);f.sort(function(a,b){return a-b});return{getLabelSequences:function(){return b},getOrdinalPageForPageLabelText:function(a){var c=null,g=0,d;for(d in b){var f=b[d];if(f.isLabeled()){f.getStartingOrdinalPageNumber()<=g&&(c=null);var e=f.getOrdinalPageForPageLabelText(a);e>=0&&(c=f,g=e)}}return c===null||g>j?0:g},getPageLabelTextForOrdinalPage:d,getHighestPageLabel:function(){var a=
e("a");a===0&&(a=e("r"));var b="";a>0&&(b=d(a));return b},getPageNumberRanges:function(){var a={},c;for(c in b){var g=b[c],d=PageLabelType[g.getPageLabelType()],f=a[d];f?(f.minPage=Math.min(f.minPage,g.getStartingPageLabel()),f.maxPage=Math.max(f.maxPage,g.getEndingPageLabel())):(f={},f.minPage=g.getStartingPageLabel(),f.maxPage=g.getEndingPageLabel());a[d]=f}return a}}}}}}(),PageLabelSeq=function(){return{create:function(h){function j(){return c}function e(){return b}function d(){return b+g-c}var c,
b,f,a,g,h=h.split(",");g=c=parseInt(h[0],10);f=h[1].charAt(0);if(f===null)console.error("Unknown Page Numbering scheme");else return b=0,a=null,f==="c"?(a=h[2].split("|"),b=1):f!=="i"?b=parseInt(h[2],10):h[2]&&(b=parseInt(h[2],10)),{getStartingPageLabel:e,getStartingOrdinalPageNumber:j,getPageLabelType:function(){return f},getEndingPageLabel:d,getDisplayPageRange:function(){return[b,d()]},getEndingOrdinalPageNumber:function(){return g},setEndingOrdinalPageNumber:function(a){g<c&&console.error("ending ordinal page number must be >= than starting ordinal page number,endingOrdinalPageNumber  = "+
g+", startingOrdinalPageNumber = "+c);g=a},isLabeled:function(){return f!=="i"},getPageLabelAtSeriesIndex:function(b){var c;f==="a"?c=b.toString():f==="r"?c=PageNumberUtilities.toRomanNumeral(b).toString().toLowerCase():f==="i"?c="":f==="c"&&(b-=1,c=b<a.length?a[b]:"");return c},getOrdinalPageForPageLabelText:function(g){var d=0,e=!1;if(f==="a")try{d=parseInt(g,10),e=d>=b}catch(h){d=0,e=!1}f==="r"&&PageNumberUtilities.isValidRomanNumeral(g)&&(d=PageNumberUtilities.parseRomanNumeral(g),e=d>=b);f===
"c"&&a!==null&&(a[g]&&(d=a[g]+1),d>0&&(e=!0));return!e?-1:c+(d-b)}}}}}();
(function(){function h(b){function c(){d.endTimer();e.emit("Service::GetPageNumber");h.resolve(q.response)}function g(){KindleDebug.error("An error occurred while transferring the file.");h.reject(Kindle.ERROR.PN_DOWNLOAD_FAIL)}var d,e,h,q;return function(b){h=$.Deferred();q=new XMLHttpRequest;q.open("GET",b);q.responseType="arraybuffer";q.addEventListener("load",c,!1);q.addEventListener("error",g,!1);d=a.createSubTimer("download page numbers");e=f.createTimer();q.send(null);return h.promise()}(b)}
function j(a){var b=$.Deferred();a.getCachedPageNumbers().then(function(a){a?b.resolve(a):b.reject()},b.reject);return b.promise()}function e(a){var b=a.getContext().pageNumberUrl;return!b?(f.emit("PageNumber::Unavailable"),$.Deferred().resolve()):j(a).pipe(null,function(){return h(b).pipe(c).done(a.cachePageNumbers)}).pipe(function(a){f.emit("PageNumber::Success");return a},function(a){a===Kindle.ERROR.PN_DOWNLOAD_FAIL&&f.emit("PageNumber::DownloadFailure");f.emit("PageNumber::Fail")})}function d(b){var c=
b.getAsin();if(!g[c]){if(!KindleDeviceCapabilities.showPageNumbers())return $.Deferred().reject("Unsupported OS");a=KindleMetricsProfiler("get page numbers");g={};g[c]=e(b).pipe(function(b){var c;b&&(c=PageNumberProvider.create(b));a.endTimer();a.log();return c})}return g[c]}function c(c){function g(a){a===Kindle.ERROR.PN_REVOKED?f.emit("PageNumber::RevokedData"):f.emit("PageNumber::CorruptData");return $.Deferred().reject()}var d=f.createTimer(),e=a.createSubTimer("parse page number file"),c=b.openReader(c),
h=c.getHeaderMetadata();if(h){if(h===Kindle.ERROR.PN_REVOKED)return g(Kindle.ERROR.PN_REVOKED)}else return KindleDebug.log("Corrupt Header Data for Page Number."),g();if(!JSON.parse(h).fileRevisionId)return KindleDebug.log("Page number sidecar header doesn't contain appropriate metadata (missing fileRevisionId)."),g();if(c.getEditionCount()>0){h=c.getEditionMetadata(0);if(!h)return KindleDebug.log("Edition Header corrupted for Page Number."),g();h=JSON.parse(h);if(!h.pageMap)return KindleDebug.log("Page number sidecar edition doesn't contain appropriate metadata (missing pageMap)."),
g();c={oPNToPosition:c.getOrdinalPagePositions(0),pageMapString:h.pageMap,totalPages:c.getTotalPageCount(0)};d.emit("PageNumber::FileParse");e.endTimer();return c}else return g()}var b,f,a,g={};KindleModuleManager.define(Kindle.MODULE.PageNumberManager,[Kindle.MODULE.DB_CLIENT,Kindle.MODULE.METRICS_MANAGER,"BinaryPageLabelSidecarReader"],function(a,c,g){f=c;b=g;return{getPageNumbers:d}})})();
var PageNumberProvider=function(){return{create:function(h){var j=!1,e,d=[],c=-1,b=0;if(h){d=h.oPNToPosition;b=h.totalPages;e=PageLabelIndexer.create(h.pageMapString,b);var h=e.getLabelSequences(),f=b=null,a;for(a in h){if(h[a]===null){KindleDebug.log("Page number sidecar edition doesn't contain a valid page label index");return}b===null&&(b=h[a]);f=h[a]}j=!0;c=b.getStartingOrdinalPageNumber();f.getEndingOrdinalPageNumber()}return{arePageNumbersAvailable:function(){return j},pageNumberFromPosition:function(a){var b;
if(a>=d[c]){a=PageNumberUtilities.binarySearchPosition(d,a);a<c&&(a=c);var f;a>=1&&(f=e.getPageLabelTextForOrdinalPage(a));b=f}return b},positionFromPageNumber:function(a){var b=e.getOrdinalPageForPageLabelText(a);b<=0&&parseInt(a,10);if(b<=0)return-1;b>=d.length&&(b=d.length-1);return d[b]},getMaxPageNumberLabel:function(){return e.getHighestPageLabel()},getPageNumberRanges:function(){return e.getPageNumberRanges()}}}}}(),PageLabelType={r:"roman",a:"arabic",c:"custom",i:"insert"},PageNumberUtilities=
function(){var h={M:1E3,CM:900,D:500,CD:400,C:100,XC:90,L:50,XL:40,X:10,IX:9,V:5,IV:4,I:1},j=["M","CM","D","CD","C","XC","L","XL","X","IX","V","IV","I"];return{toRomanNumeral:function(e){for(var d="",e=parseInt(e,10),c=0;c<j.length;c++)for(var b=j[c];e>=h[b];)d+=b,e-=h[b];return d},parseRomanNumeral:function(e){for(var e=e.toUpperCase(),d=0,c=0;c<e.length-1;)h[e.charAt(c)]<h[e.charAt(c+1)]?d-=h[e.charAt(c)]:d+=h[e.charAt(c)],c++;d+=h[e[c]];return d},binarySearchPosition:function(e,d){for(var c=0,
b=e.length-1,f;c<=b;)if(f=Math.floor((c+b)/2),e[f]<d)c=f+1;else if(e[f]>d)b=f-1;else return f;return b>=0?b:c},isValidRomanNumeral:function(e){return/^M{0,4}(CM|CD|D?C{0,3})(XC|XL|L?X{0,3})(IX|IV|V?I{0,3})$/.exec(e.toString().toUpperCase())?!0:!1}}}();
(function(){function h(b){function f(){return KindleReaderAnnotationManager.deferredInitialize(b.bookinfo.getBookInfoDfd(),b.moduleManager)}function a(){var a;return b.bookinfo.getBookInfoDfd().pipe(function(b){a=b;return a.getMetadata()}).pipe(function(c){var g=a.getContext(),f=a.getAsin();return c.headerMetadata&&(c.headerMetadata.bookType===Kindle.BookInfo.PublisherMetadata.COMIC||c.headerMetadata.bookType===Kindle.BookInfo.PublisherMetadata.CHILDREN)?$.Deferred().resolve():d.getSearchIndex({asin:f,
formatVersion:g.formatVersion,contentVersion:g.contentVersion,contentCache:b.contentCache,kcrFree:b.kcrFree})})}function g(){return b.bookinfo.getBookInfoDfd().pipe(c.getPageNumbers)}return{names:Object.freeze(e),getAnnotations:f,getSearchIndex:a,getPageNumbers:g,download:function(b){switch(b){case "annotations":return f();case "searchIndex":return a();case "pageNumbers":return g();default:return $.Deferred().reject("Unknown sidecar")}}}}var j={annotations:{},pageNumbers:{},searchIndex:{}},e={};Object.keys(j).forEach(function(b){j[b].name=
b;e[b]=b});var d,c;KindleModuleManager.define(Kindle.MODULE.SidecarManager,[Kindle.MODULE.SearchIndexManager,Kindle.MODULE.PageNumberManager],function(b,f){d=b;c=f;return{create:h}})})();function AssertionError(h){Error.call(this,h)}AssertionError.prototype=Error();AssertionError.prototype.name="AssertionError";function KindleAssert(){}
var KindleAuthor=function(){var h=["phd","md","sir"];return{getDisplayableString:function(j){for(var e="",d=j.length,c=0;c<d;c++){for(var b=j[c].split(","),f=[],a=[],g=0;g<b.length;g++){var k=$.trim(b[g]);h.indexOf(k.toLowerCase())>-1?f.push(k):a.unshift(k)}if(a.length===2){e+=a[0]+" "+a[1];for(b=0;b<f.length;b++)e+=", ",e+=f[b]}else e+=j[c];d>1&&(c===d-2?e+=ResourceBundle.getLocalizedString("k_author_conjunction"):c<d-2&&(e+=", "))}return e},getLegacyDisplayableString:function(h){for(var e="",d=
h.length,c=0;c<d;c++)e+=h[c],c<d-1&&(e+="; ");return e}}}(),KindleDebug=function(){return{error:function(){},log:function(){},warn:function(){},saveLogs:function(){saveLog=!0}}}(),KindleDeviceCapabilities=function(){function h(){return KindleHostDeviceDetector.isMetro()||KindleHostDeviceDetector.isIE()?!0:!1}var j;return{searchInTheBook:function(){return!KindleHostDeviceDetector.isiOS_4x()},showPageNumbers:function(){return!KindleHostDeviceDetector.isiOS_4x()},multiColumnMode:function(){return!0},
useNativeSelection:h,useCSSRegions:function(){return h()},useLocaleCompare:function(){if(j===void 0){try{"a".localeCompare("b","i")}catch(e){return j=e.name==="RangeError"}j=!1}return j},showFirstRunDialog:function(){return!KindleHostDeviceDetector.isMSEdge()},hasPageResizeIssues:function(){return KindleHostDeviceDetector.isiOS_9x()?!0:!1},hasSplitView:function(){return KindleHostDeviceDetector.isiOS()&&KindleHostDeviceDetector.getOSMajorVersion()>=9}}}(),KindleHostDeviceDetector=function(){function h(){return navigator.platform.indexOf("iPad")!==
-1}function j(){return navigator.platform.indexOf("iPhone")!==-1||navigator.platform.indexOf("iPod")!==-1}function e(){return h()||j()||k()}function d(){var a=-1;e()&&(a=navigator.userAgent.match(/OS (\d+)_/)[1]);return a}function c(){return(h()||j())&&parseInt(d(),10)===7}function b(){return(h()||j())&&parseInt(d(),10)>=8}function f(){return(h()||j())&&parseInt(d(),10)>=9}function a(){return navigator.userAgent.indexOf("Firefox")!==-1&&navigator.userAgent.indexOf("Trident")<0}function g(a){var b=
navigator.userAgent.match(/Version\/(\d+\.\d+)(?:\.\d+)*(?: Mobile\/\S+)? Safari/);return!b?!1:!a?!0:Number(b[1])>=Number(a)}function k(){return navigator.userAgent.indexOf("Cloud9")!==-1}function m(){return navigator.userAgent.indexOf("MSAppHost")!==-1}function l(){return m()&&n()}function n(){return!!/arm/i.test(navigator.cpuClass)}function r(){return a()?navigator.onLine:KindleModuleManager.getModuleSync(KindleModuleManager.NETWORK).isOnline()}function o(){return navigator.userAgent.indexOf("MSIE")!==
-1||navigator.userAgent.indexOf("Trident")!==-1}function q(){return navigator.userAgent.indexOf("Chrome")!==-1&&navigator.userAgent.indexOf("Safari")!==-1&&navigator.userAgent.indexOf("Edg")!==-1}function t(){return"standalone"in navigator&&navigator.standalone}function s(){return window.chrome&&Kindle.top.chrome.app&&Kindle.top.chrome.app.isInstalled}function u(){return window.navigator.msMaxTouchPoints>=1}return{isiOS:e,isiPad:h,isiPhone:j,isiOS_4x:function(){return(h()||j())&&navigator.userAgent.indexOf("OS 4")!==
-1},isiOS_5xOrGreater:function(){return(h()||j())&&parseInt(d(),10)>=5},isiOS_7x:c,isiOS_8x:b,isiOS_9x:f,hasiOSInnerHeightBug:function(){return!f()&&(c()||b())},hasCanvasSizeLimitProblem:function(){return e()},isMacintosh:function(){return navigator.userAgent.indexOf("(Macintosh;")!==-1},isFirefox:a,hasHangingDbPrompt:function(){if(!a())return!1;var b=/Firefox\/(\d+)/.exec(navigator.userAgent);return b.length>=1&&b[1]>=17},isSafari:g,isMetro:m,isMetroArm:l,isMetroSnappedView:function(){return m()&&
window.outerWidth===320},isIE:o,isIE10:function(){return o()&&navigator.userAgent.indexOf("Trident/6.0")!==-1},isIE11:function(){return o()&&(navigator.userAgent.indexOf("Trident/7.0")!==-1||navigator.userAgent.indexOf("Trident/8.0")!==-1)},isMSEdge:q,isArm:n,isCloud9:k,isTablet:function(){return h()||m()},isOnline:r,isPageVisibilityApiSupported:function(){var a;typeof document.hidden!=="undefined"?a="hidden":typeof document.msHidden!=="undefined"?a="msHidden":typeof document.webkitHidden!=="undefined"&&
(a="webkitHidden");return a!==void 0&&typeof document.addEventListener!=="undefined"},getPageVisibilityApiTerms:function(){var a,b;typeof document.hidden!=="undefined"?(a="hidden",b="visibilitychange"):typeof document.msHidden!=="undefined"?(a="msHidden",b="msvisibilitychange"):typeof document.webkitHidden!=="undefined"&&(a="webkitHidden",b="webkitvisibilitychange");return{hidden:a,visibilityChange:b}},isNetworkAvailable:function(){if(!r())return(new jQuery.Deferred).reject().promise();var a=$.Deferred();
$.ajax({url:"/ping",error:function(){a.reject()},timeout:5E3}).then(a.resolve,a.reject);return a.promise()},isNetworkAvailableSync:function(){if(!r())return!1;var a=!0;$.ajax({url:"/ping",error:function(){a=!1},timeout:50,async:!1});return a},isChrome:function(){return window.chrome&&!q()},isiOSAppMode:t,isChromeApp:s,isFirefoxAppSupported:function(){return!!KindleHostDeviceDetector.isFirefox()&&window.navigator.mozApps},isInAppMode:function(){return t()||s()},isCookieEnabled:function(){return navigator.cookieEnabled},
areWebWorkersSupported:function(){return typeof Worker!=="undefined"},isLocalStorageEnabled:function(){return KindleLocalStorage.isLocalStorageEnabled()},hasArrayLikeApply:function(){return!e()||parseInt(KindleHostDeviceDetector.getOSMajorVersion(),10)>=6},isWebSQLSupported:function(){return!!window.openDatabase},isIndexedDBSupported:function(){return!!window.mozIndexedDB||!!window.indexedDB},isMSTouchEnabledDevice:u,isTouchDevice:function(){return e()||u()},getDevicePlatform:function(){return h()?
"iPad":j()?"iPhone":k()?"otter":l()?"metroArm":m()?"metro":"desktop"},hasCanvasPerformanceProblem:function(){return h()&&KindleHostPadDetector.isPad1(t())||l()},hasMissingImgOnLoadProblem:function(){return g()||t()||a()},hasImageRenderingProblem:function(){return g()||t()},getDeviceType:function(){return m()?Kindle.DeviceType.Metro:Kindle.DeviceType.KCR},getClientName:function(){return m()?Kindle.ClientName.Metro:Kindle.ClientName.KCR},getOSMajorVersion:d,getOSMinorVersion:function(){var a=-1;e()&&
(a=navigator.userAgent.match(/OS (\d+)_(\d+_?(\d+)?)/)[2]);return a},getBrowserLanguage:function(){return navigator.language||navigator.userLanguage}}}(),KindleHostPadDetector=function(){return{isPad1:function(h){if(KindleLocalStorage.getItem("definitelyNotPad1"))return!1;var j=0,e=1E3,d=0,c;for(i=0;i<3;i++)c=SunSpiderBenchmark.get3DSpeed(),c>j?j=c:c<e&&(e=c),d+=c;j=d/3;if(j>=200&&h)return!0;if(j>=100&&!h)return!0;KindleLocalStorage.setItem("definitelyNotPad1","true");return!1}}}();
function KindleInterfacesFactory(){function h(h,e){for(var d in e)if(e.hasOwnProperty(d)&&typeof h[d]!==typeof e[d])return!1;return!0}return{IKindleLibrary:{onReaderOpenStatus:function(){},onReaderClose:function(){},onStoreOpenStatus:function(){},libraryUpdateNeeded:function(){}},IKindleReader:{openBook:function(){},unloadReader:function(){},onStoreOpenStatus:function(){},pauseReader:function(){},resumeReader:function(){},setToolbarVisible:function(){},downloadBook:function(){},removeBook:function(){}},
IKindleAppForLibrary:{storeIsTOS:function(){},openStore:function(){},openBook:function(){},onLibraryLoaded:function(){},getQueryParameters:function(){}},IKindleAppForReader:{onReaderReady:function(){},closeReader:function(){},onStartReadingStatus:function(){},onRendererLoaded:function(){},openStore:function(){},pinBookToStart:function(){},onReaderTapped:function(){},onUserAction:function(){},hideAppBar:function(){}},checkImplements:h,assertImplements:function(j,e){h(j,e)||KindleAssert(!1,"Object fails to provide all properties of interface prototype")}}}
var KindleInterfaces=KindleInterfacesFactory(),KindlJournalManager=function(){function h(a){var b=[],c;for(c in a){var d=a[c].entry;d.guid=d.guid||d.refEmId;delete d.refEmId;d&&b.push(d)}return b}function j(a){var g=[],d;for(d in a)g.push({entry:a[d]});return b.getAppDb().getTable(c).insertList(g)}function e(a){function c(){var n,j=KindleModuleManager.getModuleSync(KindleModuleManager.RESOURCE_BUNDLE).getLocalTimeOffset();e<a.length?(l=Math.min(e+100,a.length),n=Array.prototype.slice.call(a,e,l),
e=l,f.updateAnnotations(h(n),j).then(function(){b.getAppDb().deleteJournalEntries(n).then(c,d.reject)},d.reject)):d.resolve()}var d=new jQuery.Deferred,e=0,l;c();return d.promise()}function d(){var a=new jQuery.Deferred;b.getAppDb().getTable(c).getRecord().then(function(b){b.length>0?e(b).then(a.resolve,a.reject):a.resolve()},a.reject);return a.promise()}var c="journal",b=null,f=null;return{initialize:function(){var a=new jQuery.Deferred,c=this;KindleModuleManager.getModuleList([KindleModuleManager.SERVICE_CLIENT,
KindleModuleManager.DB_CLIENT]).then(function(d){f=d[KindleModuleManager.SERVICE_CLIENT];b=d[KindleModuleManager.DB_CLIENT];a.resolve(c)},a.reject);return a.promise()},saveToJournal:function(a){var b=new jQuery.Deferred;j(a).then(function(){d().then(b.resolve,b.resolve)},b.reject);return b.promise()},uploadJournal:d}}(),KindleLegacyDeviceTokenStorage=function(){return{hasDeviceTokenFromStorage:function(){return KindleLocalStorage.getItem("kindleDeviceToken")!==null},getDeviceTokenFromStorage:function(){return KindleLocalStorage.getItem("kindleDeviceToken")},
setDeviceToken:function(h){KindleLocalStorage.setItem("kindleDeviceToken",h)},clearDeviceTokenFromStorage:function(){KindleLocalStorage.removeItem("kindleDeviceToken")}}}(),KindleMetricsProfiler=function(h){function j(d){for(var c=0,b=0;b<d.length;b+=1)c+=d[b].end-d[b].start;return c}var e={};e.name=h;e.counters=null;e.subTimers=null;e.runs=[{start:(new Date).getTime(),end:null}];e.endTimer=function(){var d=this.runs[this.runs.length-1];if(d.end===null)d.end=(new Date).getTime()};e.addCount=function(d,
c){if(this.counters===null)this.counters={};this.counters[d]===void 0?this.counters[d]=c:this.counters[d]+=c};e.createSubTimer=function(d){if(this.subTimers===null)this.subTimers={};this.subTimers[d]===void 0?this.subTimers[d]=KindleMetricsProfiler(d):this.subTimers[d].runs.push({start:(new Date).getTime(),end:null});return this.subTimers[d]};e.log=function(){this.logAsPercentageOfTime("",j(this.runs))};e.logAsPercentageOfTime=function(d,c){var b=d+":"+this.name,f,a=j(this.runs);KindleDebug.log(b+
":Time: "+a+"ms - ("+(c?a/c*100:100).toFixed(2)+"%)");for(f in this.counters)KindleDebug.log(b+":"+f+" : "+this.counters[f]);for(f in this.subTimers)this.subTimers[f].logAsPercentageOfTime(b,c)};return e},KindleRemoteClient=function(){return{uploadFeedback:function(h){if(!h)return(new $.Deferred.reject).promise();var j=KindleLibrarySetting.getSettings(),j={DevicePlatform:KindleHostDeviceDetector.getDevicePlatform(),UserAgent:navigator.userAgent,WindowHeight:window.innerHeight,WindowWidth:window.innerWidth,
AppCached:!!KindleLocalStorage.getItem("cached"),AppCacheStatus:window.applicationCache.status,TouchEnabled:KindleHostDeviceDetector.isTouchDevice(),ApplicationMode:KindleHostDeviceDetector.isInAppMode(),Language:navigator.language,LocalStorageEnabled:KindleHostDeviceDetector.isLocalStorageEnabled(),LibrarySort:j.sortParam,LibraryView:j.viewState,TLD:Kindle.URL.getAmazonDomain()||"unknown"};return function(e){return KindleModuleManager.getModule(KindleModuleManager.DB_CLIENT).pipe(function(d){try{var c=
d.getAppDb(),b=c.getCachedAsins(Kindle.BookInfo.CachedState.FULLY_DOWNLOADED),f=c.getAllBooks();e.info.OfflineStorageEnabled=!!d.bookDbEnabled();return $.when(b,f)}catch(a){return $.Deferred.reject()}}).pipe(function(d,c){$.extend(e.info,{TotalBookCount:c.length,TotalBookDownloaded:d.length});return e.eid?e.eid:KindleModuleManager.getModuleSync(Kindle.MODULE.SERVICE_CLIENT).getEID()}).pipe(function(d){e.eid=d;return e},function(){return $.Deferred().resolve(e)})}({version:KindleVersion.getVersionString(),
message:h.text,deviceType:KindleHostDeviceDetector.getDeviceType(),info:j}).pipe(function(e){e={url:"/remote/feedback",type:"POST",processData:!1,contentType:"application/json",data:JSON.stringify(e)};return $.ajax(e)})}}}(),KindleTemplateManager=function(){return{initialize:function(){Handlebars.registerHelper("str",function(h){return ResourceBundle.getLocalizedString(h)})}}}(),KindleUserAgentMetricsInfo=function(){function h(){function a(){var a=/MSAppHost\/([0-9\.]+)/.exec(navigator.userAgent);
if(a)return a[1]}var b;if(!(b=function(){var a;if(["ipad","iphone"].indexOf(e)!==-1&&(e="ios",(a=/CPU OS ([0-9_]+) /.exec(navigator.userAgent))&&a.length>=2))return a[1]}())){var c;KindleHostDeviceDetector.isIE()&&(c=KindleHostDeviceDetector.isIE10()?"10":KindleHostDeviceDetector.isIE11()?"11":"unknown");b=c||a()||GoogleUserAgent.browserVersionString.toLowerCase()}return b}var j,e,d,c,b,f={chrome:14,firefox:7,safari:5,metro:1,ie:10,ios:4,edge:16};return{browserWithVersionString:function(){if(!j){e=
GoogleUserAgent.browserName.toLowerCase();d=h();a:{if(d){var a=/^0*([0-9]+)/.exec(d);if(a&&a.length>=2){c=parseInt(a[1],10);break a}else KindleDebug.error("Bad regex on versionString: "+d)}c=void 0}b="undefined"===typeof c?"other":f[e]?[e,c].join("@"):"other";j=!0}return b}}}(),KindleVersion=function(){var h="011213999";window.location.hostname==="k4w-dev.aka.amazon.com"&&(h="999999998");if(h.length!==9)throw{name:"BadVersion",message:"bad version number. got: "+h};var j=null,e=null;return{getMetricsVersionString:function(){e||
(e=parseInt(h.slice(0,2),10),e+=".",e+=parseInt(h.slice(2,4),10),e+=".",e+=parseInt(h.slice(4,6),10));return e},getVersionString:function(){j||(j=parseInt(h.slice(0,2),10),j+=".",j+=parseInt(h.slice(2,4),10),j+=".",j+=parseInt(h.slice(4,6),10),j+=".",j+=parseInt(h.slice(6),10));return j},getVersionNumber:function(){return Number(h)},parseVersionString:function(d){return d&&(d=/(\d{1,2})\.(\d{1,2})\.(\d{1,2})\.(\d{1,3})/.exec(d))?Number(d[1])*1E7+Number(d[2])*1E5+Number(d[3])*1E3+Number(d[4]):NaN}}}(),
KindleReaderArrhythmicHeartBeatHandler=function(){function h(){return n!==void 0}function j(){}function e(){}function d(){c();navigator.onLine&&(l=setTimeout(b,g))}function c(){clearTimeout(l);clearTimeout(n)}function b(){var a=m();u&&(r?r:KindleModuleManager.getModuleSync(KindleModuleManager.SERVICE_CLIENT)).stillReading({asin:o,position:a,positionType:q,localTimeOffset:v,countryCode:y,refEmId:t,kindleSessionId:s}).then(j,e);l=void 0;KindleModuleManager.getModuleSync(KindleModuleManager.METRICS_MANAGER).uploadMetrics();
navigator.onLine&&(n=setTimeout(f,k))}function f(){n=void 0}function a(){clearTimeout(l);l=void 0;clearTimeout(n);q=t=o=n=void 0}var g=5E3,k=6E5,m,l,n,r,o,q,t,s,u,y="US",v=-(new Date).getTimezoneOffset();return{onReadingStart:function(c,g,f,e,k,l){if(c!==o)return h()&&a(),o=c,q=l,t=g,s=f,m=e,u=k,b(),d},onReadingEnd:a,isStillReading:h,setNetworkModule:function(a){r=a},handleHeartBeat:d,cancelCurrentHeartBeat:c}}(),KindleReaderControls=function(){function h(c){return function(){var b=c.attr("data-action");
b&&!c.hasClass(d)&&KindleEventBroker.fire(b)}}function j(c){return function(b){switch(b.keyCode||b.which){case 32:if(b.shiftKey||b.ctrlKey||b.metaKey)break;(b=c.attr("data-action"))&&!c.hasClass(d)&&KindleEventBroker.fire(b);break;case 13:(b=c.attr("data-action"))&&!c.hasClass(d)&&KindleEventBroker.fire(b)}}}var e=[],d="disabled";return{DataActions:Object.freeze({Close:"reader_close",Back:"reader_back",ShowGoTo:"reader_show_goto",ShowSettings:"reader_show_settings",Bookmark:"reader_bookmark",ShowNotes:"reader_show_notes",
Sync:"reader_sync",PinToStart:"reader_pin_metro",OpenFullKCR:"reader_open_full_kcr",BuyFullBook:"reader_buy_full_book",ImmersiveIcon:"immersive_icon"}),registerComponent:function(c){var b=c.find("[data-action]");c.attr("data-action")&&b.push(c);for(var d=0;d<b.length;d++){var a=$(b[d]);a.tap(h(a));a.on("keyup",j(a))}e.push(c)},setDataActionEnabled:function(c,b){for(var f,a=0;a<e.length;a++)f=e[a].find("[data-action='"+c+"']"),f.toggleClass(d,!b)},setDataActionVisible:function(c,b){for(var d,a=0;a<
e.length;a++)d=e[a].find("[data-action='"+c+"']"),d.toggle(b)},clickElementWithID:function(c){var c=$("#"+c),b=c.attr("data-action");c&&b&&KindleEventBroker.fire(b)}}}(),KindleReaderLPRManager=function(){function h(c){d.getAppDb().updateLastReadTime(j,(new Date).getTime(),c,function(){})}var j,e,d;return{NEVER:-1,initialize:function(c){var b=new jQuery.Deferred,f=this;j=c;KindleModuleManager.getModule(KindleModuleManager.DB_CLIENT).done(function(a){d=a;d.getAppDb().getBook(j,function(a){e={lastPositionRead:a.lastPositionRead,
lastTimeRead:a.lastTimeRead?a.lastTimeRead:-1,lastSyncTime:a.lastFPRSyncTime};b.resolve(f)})});return b.promise()},clear:function(){e=j=void 0},getLastPositionRead:function(){return e.lastPositionRead},onReadingStart:function(c,b,d,a){$.when(d.locationFromPosition(b.currentTopOfPage),d.locationFromPosition(c.position)).done(function(d,f){c.position>b.currentBottomOfPage&&e.lastTimeRead!==-1&&c.syncTime!==e.lastSyncTime&&a({currentLocation:d,currentPosition:b.currentTopOfPage,fprPosition:c.position,
fprLocation:f,fprDevice:c.deviceName,fprDateTime:c.syncTime});h(c.syncTime)})},onPageChange:function(c){e.lastPositionRead=c;e.lastTimeRead=(new Date).getTime();d.getAppDb().updateLastPositionRead(j,e.lastPositionRead,e.lastTimeRead,function(b){function c(){window.location.reload(!0)}b&&(b.code===Kindle.DB.DATABASE_ERR||b.code===Kindle.DB.SYNTAX_ERR)&&b.message.indexOf("no such table")>=0&&_metricsManager.emitNow("App::DatabaseGoneOnUpdateLPR",{breakdown:["Browser"]}).then(c,c)})},onReadingEnd:function(){j=
null;e=void 0},getStartReadingPosition:function(){return e},updateFprSyncTime:function(c){c.syncTime!==e.lastSyncTime&&d.getAppDb().updateLastFPRSyncTime(j,c.syncTime,function(){})}}}(),KindleReaderMetrics=function(){function h(a){if(a)switch(a.toLowerCase()){case "loadfailure":return Kindle.ERROR.OPEN_BOOK_LOAD_FAILURE;case "abort":case "timeout":case "error":return Kindle.ERROR.OPEN_BOOK_NETWORK_ERROR;case "contentloaned":case "contentloanended":case "contentlicenseexceeded":case "contentunsupported":case "formatunsupported":case "contentnotowned":case "contentrentalexpired":case "sessionlimitexceeded":return Kindle.ERROR.OPEN_BOOK_CONTENT_UNAVAILABLE;
case "geolocationnotallowed":return Kindle.ERROR.GEOLOCATION_NOT_ALLOWED;default:return Kindle.ERROR.OPEN_BOOK_UNKNOWN}}function j(){u||(u=KindleModuleManager.getModuleSync(KindleModuleManager.METRICS_MANAGER));return u}var e=!1,d,c,b,f,a,g,k,m,l,n="",r="",o=1,q,t=null,s=null,u;return{NEXT_PAGE:0,PREV_PAGE:1,startBookOpenTimer:function(){c=j().createTimer();return b=j().startMetrics("Reader::Open")},reportBookOpenSuccess:function(a){var d={breakdown:["Browser"]},g=a.bookType,f=[{name:"Library::ReaderOpen::"+
g,params:d}];a.publisherBookType&&f.push({name:"Library::ReaderOpen::"+g+"::"+a.publisherBookType,params:d});var e=a.isNetworkAccessed?"::RemoteContent":"::LocalContent",k="";g===Kindle.BookInfo.BookType.MOBI8&&(k=a.isContentScrambled?"::scrambled":"::unscrambled",f.push({name:"Library::ReaderOpen::"+g+k,params:d}),a.publisherBookType&&f.push({name:"Library::ReaderOpen::"+g+"::"+a.publisherBookType+k,params:d}));a.clickToGlassTimer&&(g="Library::ReaderOpen::"+g+k,e=[{name:g+"::ClickToGlass"+e,params:{time:a.clickToGlassTimer.time,
breakdown:["Browser"]}},{name:g+"::RendererLoaded"+e,params:{time:a.rendererLoadedTimer.time,breakdown:["Browser"]}},{name:g+"::MetadataLoaded"+e,params:{time:a.metadataLoadedTimer.time,breakdown:["Browser"]}}],j().emit(e));a.isOnline||f.push({name:"Library::ReaderOpenOffline",params:d});a.screenOrientation&&f.push({name:"Library::ReaderOpen::Orientation::"+a.screenOrientation});f.push({name:"Library::ReaderOpen::ContentType::"+a.contentType,params:d});a.contentType===Kindle.CONTENT_TYPE.EBSP&&(a.isOwned?
f.push({name:"Library::ReaderOpen::ContentType::"+a.contentType+"::Owned",params:d}):f.push({name:"Library::ReaderOpen::ContentType::"+a.contentType+"::NotOwned",params:d}));c.emit(f);j().endMetrics(b);j().uploadMetrics()},reportBookOpenFailure:function(a){var d=[],g=h(a.errorCode);d.push({name:"Library::ReaderOpenFail"});g&&(d.push({name:"Library::ReaderOpenFail::"+g}),g===Kindle.ERROR.OPEN_BOOK_CONTENT_UNAVAILABLE&&(d.push({name:"Library::ReaderOpenFail::"+g+"::"+a.errorCode}),a&&a.contentType===
Kindle.CONTENT_TYPE.EBSP&&j().emit("zzz::SampleTitleNotAvailable::"+a.asin)));c.emit(d);j().modifyMetricsMethod(b,"Reader::OpenFail");j().endMetrics(b);j().uploadMetrics()},setBookType:function(a,b){n=a;r="";a===Kindle.BookInfo.BookType.MOBI8&&(r=b?"::scrambled":"::unscrambled")},setColumnCount:function(a){o=Number(a)||1},startGoToMetrics:function(){f=j().createTimer()},endGoToMetrics:function(){if(f){var a="Reader::GoToPosition::"+n,b={breakdown:["Browser"]},c=[{name:a,params:b}];r&&c.push({name:a+
r,params:b});f.emit(c);f=null}},startPageTurnTimer:function(b,c){e||(e=!0,q=c,b===0&&!a?(a=j().createTimer(),d=b):b===1&&!g&&(g=j().createTimer(),d=b))},endPageTurnTimer:function(b){var c,f=[],k={breakdown:["Browser"],submetrics:[{name:"columnCount",value:o}]};if(e){var h=b?"::RemoteContent":"::LocalContent",l;d===0&&a?(c="Reader::NextPage::",l=a):d===1&&g&&(c="Reader::PrevPage::",l=g);c&&(b=c+n,f=[{name:b,params:k},{name:b+h,params:k}],d===0&&f.push({name:"Reader::NextPage:Version",params:{breakdown:["Version"]}}),
r&&(f=f.concat([{name:b+r,params:k},{name:b+r+h,params:k}])),l.emit(f),q&&j().emit(c+q));g=a=null;e=!1}},startSpinnerTimer:function(){e&&(d===0&&!k?k=j().createTimer():d===1&&!m&&(m=j().createTimer()))},endSpinnerTimer:function(a){var b,c=[],g={breakdown:["Browser"],submetrics:[{name:"columnCount",value:o}]};if(e){var f;d===0&&k?(b="Reader::NextPageSpinner::",f=k):d===1&&m&&(b="Reader::PrevPageSpinner::",f=m);b&&(b+=n,c=[{name:b,params:g}],r&&(c=c.concat([{name:b+r,params:g},{name:b+r+(a?"::RemoteContent":
"::LocalContent"),params:g}])),f.emit(c));m=k=null}},reportContentNotAvailableMetrics:function(){j().emit("Reader::ContentNotAvailableOffline")},reportTimeOutMetrics:function(){var a="Reader::PageTurnTimeOut::"+n,b=[{name:a}];r&&b.push({name:a+r});j().emit(b)},reportBackButtonUsage:function(){j().emit("Reader::BackButton")},reportGoToAnnotationUsage:function(){j().emit("Reader::AnnotationsPane::GoToLocation")},reportScrubberUsage:function(){j().emit("Reader::ScrubberBar::GoToLocation")},notifyAnnotationsReady:function(){l=
j().createTimer()},reportAnnotationsPaneOpened:function(){j().emit("Reader::OpenAnnotationsPane");l&&(l.emit("Reader::OpenAnnotationsPane::Time"),l=null)},reportFirefoxPromptingDialogOpen:function(){j().emit("Reader::FirefoxPrompting::Open")},reportFirefoxPromptingDialogClose:function(a){var b="Reader::FirefoxPrompting::Close::";b+=a.writeOk?"ok":"no";j().emit(b)},reportOrientationChange:function(a){s!==null?(clearTimeout(s),s=null,t.emit("Reader::OrientationChange::Unintentional::"+a),t=null):(t=
j().createTimer(),s=setTimeout(function(){s=t=null;j().emit("Reader::OrientationChange::Intentional::"+a)},6E4))}}}(),KindleReaderOverlayManager=function(){function h(b){b.oldValue&&c.callEventListeners(d,{type:d,overlay:{type:j,start:b.oldValue.start,end:b.oldValue.end}});b.newValue&&c.callEventListeners(e,{type:e,overlay:{type:j,start:b.newValue.start,end:b.newValue.end}})}var j="kindle.selection",e="overlayAdded",d="overlayRemoved",c=new ListenerManager,b;return{OVERLAY_ADDED_EVENT:e,OVERLAY_REMOVED_EVENT:d,
SELECTION:j,SEARCH_RESULT:"kindle.search",addSearchResult:function(b){c.callEventListeners(e,{type:e,overlay:{type:"kindle.search",start:b,end:b}})},removeSearchResult:function(b){c.callEventListeners(d,{type:d,overlay:{type:"kindle.search",start:b,end:b}})},setSelectionManager:function(c){b=c;b.addEventListener(b.SELECTION_CHANGED_EVENT,h)},getOverlaysInRange:function(c,a){var d=[],e=KindleReaderAnnotationManager.getAnnotationsInRange(c,a,KindleReaderAnnotationManager.NOTE),h=KindleReaderAnnotationManager.getAnnotationsInRange(c,
a,KindleReaderAnnotationManager.HIGHLIGHT),l=b.getSelection(),n=ReaderSitbHighlight.get();e&&Array.prototype.push.apply(d,e);h&&Array.prototype.push.apply(d,h);l&&c<=l.end&&l.start<=a&&d.push({type:j,start:l.start,end:l.end});if(n&&n.length>0)for(e=0;e<n.length;e++)d.push({type:"kindle.search",start:n[e],end:n[e]});return d},addEventListener:c.addEventListener,removeEventListener:c.removeEventListener}}(),KindleReaderSelectionRenderer=function(){var h=null,j=null,e=null,d=KindleHostDeviceDetector.isTouchDevice();
return{initialize:function(c){e=c;d&&(h=document.createElement("DIV"),$(h).addClass("amazon-grabHandleBegin"),$(h).hide(),$("body").append(h),j=document.createElement("DIV"),$(j).addClass("amazon-grabHandleEnd"),$(j).hide(),$("body").append(j))},getGrabHandleBegin:function(){return h},getGrabHandleEnd:function(){return j},setSelection:function(c){if(c.touchSelected&&d){var b=KindleListUtilities.first(e.getBounds(c.start)),c=KindleListUtilities.last(e.getBounds(c.end)),f=$("#kindleReader_content");
h.style.top=KindleHostDeviceDetector.isMSTouchEnabledDevice()?b.bottom+f.offset().top+"px":b.top+f.offset().top+"px";h.style.left=b.left+f.offset().left+"px";j.style.top=c.bottom+f.offset().top+"px";j.style.left=c.right+f.offset().left+"px";$(h).show();$(j).show()}},clearSelection:function(){d&&($(h).hide(),$(j).hide())}}}(),KINDLE_READER_SETTINGS_COLOR_MODE={WHITE:{id:"#kindleReader_controlPanel_colorWhite",persistedValue:0},SEPIA:{id:"#kindleReader_controlPanel_colorSepia",persistedValue:1},BLACK:{id:"#kindleReader_controlPanel_colorBlack",
persistedValue:2}},KINDLE_READER_SETTINGS_FONT_SIZE={XSMALL:{id:"#kindleReader_controlPanel_xSmallFont",size:14},SMALL:{id:"#kindleReader_controlPanel_smallFont",size:16},MEDIUM:{id:"#kindleReader_controlPanel_mediumFont",size:20},LARGE:{id:"#kindleReader_controlPanel_largeFont",size:28},XLARGE:{id:"#kindleReader_controlPanel_xLargeFont",size:44}},KINDLE_READER_SETTINGS_GLYPH_SCALE={14:1,16:1.25,20:1.5,28:2,44:3},KINDLE_READER_SETTINGS_MARGIN={XSMALL:{id:"#kindleReader_controlPanel_xSmallMargin",
size:0},SMALL:{id:"#kindleReader_controlPanel_smallMargin",size:10},MEDIUM:{id:"#kindleReader_controlPanel_mediumMargin",size:18},LARGE:{id:"#kindleReader_controlPanel_largeMargin",size:20},XLARGE:{id:"#kindleReader_controlPanel_xLargeMargin",size:22}},KINDLE_READER_SETTINGS_COLUMN_MODE={OFF:{id:"#kindleReader_controlPanel_columnButton_off",persistedValue:"true"},ON:{id:"#kindleReader_controlPanel_columnButton_on",persistedValue:"false"}},KINDLE_READER_SETTINGS_SHOW_LOCATION_MODE={OFF:{id:"#kindleReader_controlPanel_showLocationButton_off",
persistedValue:"false"},ON:{id:"#kindleReader_controlPanel_showLocationButton_on",persistedValue:"true"}},KindleReaderSettings=function(){function h(){var L,P,A,O,J,G,V,da,W,ca,ea,ha,aa;this.copy=function(a){L=a.getFontSize();P=a.getMargin();this.setColorMode(a.getColorMode());ha=a.getShowColumns();aa=a.getShowLocations()};this.reset=function(){L=j;P=d;this.setColorMode(c);ha=b;aa=f};this.getFontSize=function(){return L};this.getGlyphScale=function(){return KINDLE_READER_SETTINGS_GLYPH_SCALE[L]};
this.setFontSize=function(a){L=a};this.getMargin=function(){return P};this.setMargin=function(a){P=a};this.getLineHeight=function(){return e};this.getBGColor=function(){return O};this.getFGColor=function(){return J};this.getBodyColor=function(){return G};this.getTitleColor=function(){return V};this.getHighlightColor=function(){return da};this.getSearchBGColor=function(){return W};this.getSearchBorderColor=function(){return ca};this.getSelectionColor=function(){return selectionColor};this.getColorMode=
function(){return A};this.getInsertBGColor=function(){return ea};this.setColorMode=function(b){b===KINDLE_READER_SETTINGS_COLOR_MODE.WHITE?(O=a,J=g,G=r,V=o,da=k,selectionColor=m,ea=q,W=l,ca=n):b===KINDLE_READER_SETTINGS_COLOR_MODE.SEPIA?(O=t,J=s,G=H,V=C,da=u,selectionColor=y,ea=I,W=v,ca=x):b===KINDLE_READER_SETTINGS_COLOR_MODE.BLACK&&(O=z,J=B,G=M,V=N,da=w,selectionColor=E,ea=F,W=K,ca=D);A=b};this.getShowColumns=function(){return ha};this.setShowColumns=function(a){ha=a};this.getShowLocations=function(){return aa};
this.setShowLocations=function(a){aa=a};this.save=function(){try{KindleLocalStorage.setItem("KindleReaderSettings.fontSize",L),KindleLocalStorage.setItem("KindleReaderSettings.margin",P),KindleLocalStorage.setItem("KindleReaderSettings.colorMode",A.persistedValue),KindleLocalStorage.setItem("KindleReaderSettings.showColumns",ha),KindleLocalStorage.setItem("KindleReaderSettings.showLocations",aa)}catch(a){}};this.load=function(){KindleLocalStorage.getItem("KindleReaderSettings.fontSize")&&(L=parseInt(KindleLocalStorage.getItem("KindleReaderSettings.fontSize"),
10));KindleLocalStorage.getItem("KindleReaderSettings.margin")&&(P=parseInt(KindleLocalStorage.getItem("KindleReaderSettings.margin"),10));if(KindleLocalStorage.getItem("KindleReaderSettings.colorMode")){var a=parseInt(KindleLocalStorage.getItem("KindleReaderSettings.colorMode"),10),b;for(b in KINDLE_READER_SETTINGS_COLOR_MODE)KINDLE_READER_SETTINGS_COLOR_MODE[b].persistedValue===a&&this.setColorMode(KINDLE_READER_SETTINGS_COLOR_MODE[b])}KindleLocalStorage.getItem("KindleReaderSettings.showColumns")&&
(ha=KindleLocalStorage.getItem("KindleReaderSettings.showColumns")==="false"?"false":"true");KindleLocalStorage.getItem("KindleReaderSettings.showLocations")&&(aa=KindleLocalStorage.getItem("KindleReaderSettings.showLocations")==="false"?"false":"true")};this.equal=function(a){return a?a instanceof h?this.getFontSize()===a.getFontSize()&&this.getMargin()===a.getMargin()&&this.getColorMode()===a.getColorMode()&&this.getShowColumns()===a.getShowColumns()&&this.getShowLocations()===a.getShowLocations():
!1:!1}}var j=KINDLE_READER_SETTINGS_FONT_SIZE.MEDIUM.size,e=1.4,d=KINDLE_READER_SETTINGS_MARGIN.MEDIUM.size,c=KINDLE_READER_SETTINGS_COLOR_MODE.WHITE,b=KINDLE_READER_SETTINGS_COLUMN_MODE.OFF.persistedValue,f=KINDLE_READER_SETTINGS_SHOW_LOCATION_MODE.ON.persistedValue,a="#ffffff",g="#111111",k="#fff5ad",m="#cdd0d4",l="#fffbde",n="#ccc9b2",r=a,o="#999999",q="#cccccc",t="#FBF0D9",s="#5F4B32",u="#fff5ad",y="#d7d0c0",v="#fef4b5",x="#cbc391",H=t,C="#84725B",I="#d8c69f",z="#000000",B="#FFFFFF",w="#60abeb",
E="#6d6d6d",K="#1f384d",D="#366185",M=z,N="#999999",F="#333333";return h}(),KindleReaderZoomableManager=function(){function h(){b=KindleRenderer.getZoomableList();f=!!b;b&&b.length>0&&(a===d.PREV?(c=b.length-1,b[c].activate()):a===d.NEXT&&(c=0,b[c].activate()),a=null)}function j(){f&&(b&&b.length>0&&b[c].deactivate(),c=null,f=!1)}function e(){b=null}var d={NEXT:"next",PREV:"prev"},c=null,b=null,f=!1,a=null;return{activateZoomableAtPosition:function(a,d){var e=KindleRenderer.getZoomableAt(a,d);j();
if(e&&e.activate){b||(b=KindleRenderer.getZoomableList(),f=!!b);a:{for(var h=0;h<b.length;h++)if(b[h].isSame(e)){c=h;break a}c=void 0}b[c].activate();f=!0}},gotoNextZoomable:function(){function g(){e();if(KindleRenderer.hasNextScreen())a=d.NEXT;KindleReaderUI.nextPage()&&h()}b&&(b.length===0?g():(b[c].deactivate(),c<b.length-1?b[++c].activate():g()))},gotoPreviousZoomable:function(){function g(){e();if(KindleRenderer.hasPreviousScreen())a=d.PREV,KindleReaderUI.prevPage()&&h()}b&&(b.length===0?g():
(b[c].deactivate(),c>0?b[--c].activate():g()))},isZoomed:function(){return f},activateZoomableOnPageTurn:h,deactivateZoomable:j,clearZoomables:e}}(),KindleReaderClippingManager=function(){function h(j,e,d,c,b){for(var f=!0;f;){if(e<=0){b.resolve(c+"...");return}f=j.getItem();if(f.pos>d){b.resolve(c);return}e--;c+=f.text;f=j.next()}j.getLoadingDfd().then(function(a){a?h(j,e,d,c,b):b.resolve(c)},b.reject)}return{getSelectedText:function(j){var e=KindleReaderUI.getSelection();if(!e)return(new jQuery.Deferred).reject().promise();
var d=$.Deferred(),c=KindleRenderer.createWordIterator(),b,f=$.Deferred();j?(b=$.Deferred(),c.gotoPosition(e.start).then(function(){h(c,j,e.end,"",b)},b.reject),b.then(function(){var a=c.getItem().pos;f.resolve((a-e.start)/KindleReaderUI.getMaxPosition()*100)},f.reject)):(b=c.getText(e.start,e.end),f.resolve((e.end-e.start)/KindleReaderUI.getMaxPosition()*100));$.when(b,f).then(function(a,b){d.resolve({text:a,percent:b})},d.reject);return d.promise()}}}(),KindleSelectionEvents=function(){function h(a){if(!a.pageX&&
!a.pageY){var b=a.target.getBoundingClientRect();return{x:b.left+a.clientX,y:b.top+a.clientY}}return{x:a.pageX,y:a.pageY}}function j(a){if(!u&&!y&a.which!==3){var b=h(a),b=I(b.x,b.y,z);E=!1;b>=0&&(v=!0,C=H=!1,x=b,B.setSelection(null),a.preventDefault())}}function e(a){if(v&&x&&a.which!==3){var b=h(a);v=!1;H&&B.getSelection()&&(b=I(b.x,b.y),B.setSelection({start:Math.min(x,b),end:Math.max(x,b)}),B.processSelection());a.stopPropagation()}H=!1}function d(a){H=!0;if(v&&x){var b=h(a),b=I(b.x,b.y);B.setSelection({start:Math.min(x,
b),end:Math.max(x,b)});C=!0}else C=!1;a.stopPropagation()}function c(a){if(w)return!1;var b=h(a),b=I(b.x,b.y,z);b>=0&&(B.setSelection({start:b,end:b}),B.processSelection(),a.stopPropagation())}function b(){C||(B.setSelection(null),E=!1)}function f(a){u=!0;y=!1;x=B.getSelection().end;a.stopPropagation();return!1}function a(a){u=!1;y=!0;x=B.getSelection().start;a.stopPropagation();return!1}function g(){!u&&!y&&B.setSelection(null)}function k(a){(u||y)&&l(a)}function m(a){(u||y)&&n(a)}function l(a){B.getSelection()&&
(B.processSelection(),y=u=!1,x=null,a.stopPropagation())}function n(a){function b(){var c=B.getSelection(),d,g;a.originalEvent&&a.originalEvent.touches?(d=a.originalEvent.touches[0].pageX,g=a.originalEvent.touches[0].pageY):(g=h(a),console.log("move:"+g.x+","+g.y),d=g.x,g=g.y);d=I(d,g);u?B.setSelection({start:Math.min(x,d),end:c.end,touchSelected:!0}):y&&B.setSelection({start:c.start,end:Math.max(x,d),touchSelected:!0},!0);a.preventDefault()}if(x&&(u||y))b(),a.stopPropagation()}function r(a){var b=
I(a.startX,a.startY,z);b>=0&&(B.setSelection({start:b,end:b,touchSelected:!0}),B.processSelection(),C=!0,a.stopPropagation&&a.stopPropagation())}function o(){if(!this.isTouchEvent||E)E=!1;else{var a=I(this.x,this.y,z);a>=0&&(B.setSelection({start:a,end:a,touchSelected:!0}),B.processSelection(),E=C=!0)}}function q(a,b){for(var c=a.length,d=0;d<c;d+=1){var g=a[d],f=$(g).offset();if(f.top-10<b.y&&b.y<f.top+$(g).height()+10&&f.left-10<b.x&&b.x<f.left+$(g).width()+10)return!0}return!1}function t(a){return function(b){if(b.pointerType===
b.MSPOINTER_TYPE_MOUSE||b.pointerType===b.MSPOINTER_TYPE_PEN)w=!1,a(b)}}function s(a){return function(b){b.pointerType===b.MSPOINTER_TYPE_TOUCH&&(w=!0,a(b))}}var u=!1,y=!1,v=!1,x,H=!1,C=!1,I,z=225,B,w=!1,E=!1;return{initialize:function(u){I=u.getBookPositionAt;B=u.selectionStateManager;KindleHostDeviceDetector.isMSTouchEnabledDevice()?(u.mouseDownEventSource&&($(u.mouseClickOutsideEventSource).click(b),$(u.mouseDownEventSource).dblclick(c),u.mouseEventSource.addEventListener("MSPointerMove",t(d)),
u.mouseEventSource.addEventListener("MSPointerDown",t(function(a){!q($(".ui-dialog:visible"),h(a))&&j(a)})),u.mouseEventSource.addEventListener("MSPointerUp",t(function(a){!q($(".ui-dialog:visible"),h(a))&&e(a)}))),u.touchEventSource&&(u.selectionHandleLeft.addEventListener("MSPointerDown",s(f)),u.selectionHandleRight.addEventListener("MSPointerDown",s(a)),u.selectionHandleLeft.addEventListener("MSPointerUp",s(l)),u.selectionHandleRight.addEventListener("MSPointerUp",s(l)),u.touchEventSource.addEventListener("MSPointerMove",
s(n)),u.touchEventSource.addEventListener("MSPointerUp",s(l)),u.touchEventSource.addEventListener("MSPointerDown",s(g)),$(u.touchEventSource).tap(o))):(u.mouseDownEventSource&&($(u.mouseDownEventSource).dblclick(c),$(u.mouseDownEventSource).mousedown(j),$(u.mouseEventSource).mousemove(d),$(u.mouseEventSource).mouseup(e),$(u.mouseClickOutsideEventSource).click(b)),u.touchEventSource&&($(u.selectionHandleLeft).bind("touchstart",f),$(u.selectionHandleLeft).bind("touchmove",n),$(u.selectionHandleLeft).bind("touchend",
l),$(u.selectionHandleRight).bind("touchstart",a),$(u.selectionHandleRight).bind("touchmove",n),$(u.selectionHandleRight).bind("touchend",l),$(u.touchEventSource).bind("touchstart",g),$(u.touchEventSource).bind("touchmove",m),$(u.touchEventSource).bind("touchend",k),$(u.touchEventSource).tapHold(r)))},resetTap:function(){E=!1}}}();
KindleSelectionHelper=function(h){return{getBookPositionAt:function(j,e,d){var c=h(),d=d||Infinity,b=-1,f;for(f in c)for(var a=c[f],g=0;g<a.length;g++){var k;k=a[g];var m=void 0,l=void 0,m=j<k.left?k.left-j:j<k.right?0:j-k.right,l=e<k.top?k.top-e:e<k.bottom?0:e-k.bottom;k=m*m+l*l;if(k<d&&(d=k,b=f,k<=0))break}return+b},getBounds:function(j){return h()[j]||null}}};
var KindleSelectionStateManagerFactory=function(){function h(){return e?{start:e.start,end:e.end,touchSelected:e.touchSelected}:null}var j=ListenerManager(),e=null,d=0;j.setEventProperties("selectionChanged",{vetoable:!0});return{SELECTION_CHANGED_EVENT:"selectionChanged",PROCESS_SELECTION_EVENT:"processSelection",addEventListener:j.addEventListener,setSelection:function(c){if(!d&&(!c||c.start&&c.end)){if(c&&(c.start=Number(c.start),c.end=Number(c.end),c.start>c.end)){var b=c.start;c.start=c.end;
c.end=b}c===null&&e===null||c!==null&&e!==null&&c.start===e.start&&c.end===e.end||(b=h(),j.callEventListeners("selectionChanged",{type:"selectionChanged",oldValue:b,newValue:c})&&(e=c))}},processSelection:function(){d||e&&j.callEventListeners("processSelection",{type:"processSelection",selection:h()})},getSelection:h,enable:function(){d--;KindleAssert(d>=0,"Mismatched selection disable/enable")},disable:function(){d++;e=null}}},KindleUserLocationConverter;
KindleUserLocationConverter=function(){function h(){return{locationFromPosition:function(b){return $.Deferred().resolve(Math.floor(b*2/300+1))},positionFromLocation:function(b){b*=100;b<100&&(b=100);return $.Deferred().resolve(Math.floor((b-100)*3/2))},flavor:function(){return d}}}function j(){return{locationFromPosition:function(c){return $.Deferred().resolve(Math.floor((c*b+100)/100))},positionFromLocation:function(c){c*=100;c<100&&(ASSERT(0),c=100);return $.Deferred().resolve(Math.floor((c-100)/
b))},flavor:function(){return c}}}function e(b){function a(a){if(u[a])return u[a].deferred;var b,d,f;b=t(a);b.done(c);y++;u[a]={deferred:b,cacheEntrySeq:y};if(y>v){a=y;for(d in u)if(u[d].cacheEntrySeq<a)f=d,a=u[d].cacheEntrySeq;a!==y&&delete u[f]}return b}function c(a){var b=a.metadata.id;if(!s[b]||!s[b].firstPos){s[b]=s[b]||{};var d,g,f=a.metadata.id;try{$.isArray(a.locations)?(d=a.locations[0],g=a.locations[a.locations.length-1]):(d=a.locations[f*q+h],g=a.locations[Math.min((f+1)*q+h-1,o)])}catch(e){d=
Number.MAX_VALUE;g=-1;for(var k in a.locations)a.locations.hasOwnProperty(k)&&a.locations[k]&&(d=Math.min(a.locations[k],d),g=Math.max(a.locations[k],g))}a={firstPos:d,lastPos:g};if(!s[b].lastPos)s[b].lastPos=a.lastPos;if(!s[b].firstPos&&(s[b].firstPos=a.firstPos,b>0))s[b-1]=s[b-1]||{},s[b-1].lastPos=a.firstPos-1}}function d(a){var b,c,g=a.metadata.id;try{$.isArray(a.locations)?(b=0,c=a.locations.length-1,offset=g*q+h):(b=g*q+h,c=Math.min((g+1)*q+h-1,o),offset=0)}catch(f){b=Number.MAX_VALUE;c=-1;
for(var e in a.locations)a.locations.hasOwnProperty(e)&&a.locations[e]&&(b=Math.min(e,b),c=Math.max(e,c))}return{firstIx:b,lastIx:c,offset:offset}}function e(b){function c(d,g){if(d===g)a(d).then(k.resolve,k.reject);else{var f=Math.floor((d+g)/2);f===d&&g===d+1&&(f=g);a(f).done(function(a){var e=s[a.metadata.id];e.firstPos>b?c(d,f-1):e.lastPos>=b?k.resolve(a):c(f,g)}).fail(k.reject)}}var d,g,f;g=0;f=Math.floor((o-h)/q);for(d=0;d<s.length;d++)if(s[d])if(s[d].firstPos){if(s[d].firstPos<=b&&s[d].lastPos>=
b)return a(d);if(s[d].firstPos>b){f=d-1;break}else g=d}else if(s[d].lastPos){if(s[d].lastPos===b)return a(d);if(s[d].lastPos>b){f=d;break}else g=d+1}var k=new jQuery.Deferred;c(g,f);return k.promise()}var h=1,n=b.minPosition,j=b.maxPosition,o=b.locationsInfo.numOfLocations,q=b.locationsInfo.mapSize,t=b.mapGetter,s=[],u={},y=1,v=Math.max(5,Math.floor(2E4/q));return{locationFromPosition:function(a){var b=new jQuery.Deferred;e(a).done(function(c){function g(c,d,e){var k=Math.floor((c+d)/2);e[k]===a?
b.resolve(k+f.offset):e[k]>a?g(c,k-1,e):k===d||e[k+1]>a?b.resolve(k+f.offset):g(k+1,d,e)}var f=d(c);g(f.firstIx,f.lastIx,c.locations)}).fail(function(){a<=n?b.resolve(h):a>=j?b.resolve(o-1+h):b.resolve(Math.floor((a-n)/(j-n)*(o-h)+h))});return b},positionFromLocation:function(b){var c=new jQuery.Deferred;a(Math.floor((b-h)/q)).done(function(a){var d,g;try{$.isArray(a.locations)?(d=(b-h)%q,g=a.locations[d]):g=a.locations[b]}catch(f){g=1}c.resolve(g)}).fail(function(){b<=h?c.resolve(n):b>=o-1+h?c.resolve(j):
(p=(b-h)/o,c.resolve(Math.floor(p*(j-n)+n)))});return c.promise()}}}var d="mobi",c="topaz",b=3;return{MOBI_FLAVOR:d,TOPAZ_FLAVOR:c,mobiLocationConverter:h,topazLocationConverter:j,getLocationConverter:function(b,a){return b==="topaz"?j():b==="mobi8"?e(a):h()}}}();
var ReaderAnnotationsDisplay=function(){function h(b){KindleReaderAnnotationsPane.loadAnnotations(b,d,function(b){e.goToPosition(b.start);KindleReaderMetrics.reportGoToAnnotationUsage()},function(b){j.deleteAnnotations([b]).done(e.onAnnotationsUpdated)},function(b,a){b?j.modifyNote(a.start,a.position,b):j.deleteAnnotations([a]).done(e.onAnnotationsUpdated)})}var j,e,d,c=KindleHostDeviceDetector.isMetro();return{initialize:function(b){e=b.readerControls;d=b.pageLabelConverter;j=b.annotationManager},
show:function(b,d){KindleReaderMetrics.reportAnnotationsPaneOpened();var a=j.getAllAnnotations(),g=j.getLastUpdateTime();c?e.hostShowAnnotations({annotations:a,lastUpdateTime:g,position:b,filter:d}):(KindleReaderAnnotationsPane.open(),h(a),KindleReaderAnnotationsPane.scrollToPosition(b))}}}(),ReaderSitbHighlight=function(){function h(){var c;if(j){for(var b=0;b<j.length;b++)c=j[b],e.removeSearchResult(c);j=null}}var j=null,e=null,d;return{initialize:function(c){e=c},get:function(){return j},set:function(c){h();
j=c;d=!0},clear:h,render:function(){if(j&&d){for(var c=0;c<j.length;c++)pos=j[c],e.addSearchResult(pos);d=!1}}}}(),ReaderSitbManager=function(){function h(){d++;a=f=b=null}function j(e){function h(a,b){if(b===d)if(a>=n.length)KindleReaderSitbPane.setViewState(c.Complete,n.length>0?n.length-1:0);else{var g=n[a];g.isMarker?(KindleReaderSitbPane.addLocationMarker(g),h(a+1,b)):g.getContext("mark").then(function(a){b===d&&KindleReaderSitbPane.addItem({context:a.context,location:a.location,position:g.positions[0],
searchHighlights:g.positions,pageNumber:a.pageNumber})}).always(function(){h(a+1,b)})}}k.emit("SITB::Search");var n=e&&e.results||[];e&&e.isCached&&k.emit("SITB::SearchCached");n.length<=0&&g.emit("SITB::NoResults");KindleReaderSitbPane.setViewState(c.Searching);(function(){var c=0,d,g={isMarker:!0,position:b,location:f,pageNumber:a};if(n.length!==0){for(;c<n.length;){d=n[c].positions[0];if(b<=d){n.splice(c,0,g);return}c++}n.push(g)}})();h(0,++d)}$.Deferred();var e=null,d=0,c,b,f,a,g,k;return{initialize:function(a){c=
KindleReaderSitbPane.States;g=a},searchContent:function(d){function l(){e.search(d.queryText).then(j,KindleReaderSitbPane.showErrorMessage)}function n(a){var b=SearchContextProvider.getContextProvider({pageLabelConverter:d.pageLabelConverter,locationConverter:d.locationConverter}).getContext;e=SitbHelperFactory(SearchTermStemmer,b).create(a);e===Kindle.SITB.LANGUAGE_NOT_SUPPORTED?KindleReaderSitbPane.showErrorMessage(Kindle.ERROR.SITB_LANGUAGE_NOT_SUPPORTED):e===Kindle.SITB.LANGUAGE_UNDEFINED?(KindleReaderSitbPane.showErrorMessage(Kindle.ERROR.SITB_LANGUAGE_UNDEFINED),
g.emit("SITB::LanguageUnd")):l()}function r(a){a==="finished"&&q.emit("SITB::AwaitingIndex")}function o(a){a===Kindle.ERROR.SITB_OFFLINE?g.emit("SITB::NoIndexOffline"):a===Kindle.ERROR.SITB_COMMON_ERROR?g.emit("SITB::IndexFailure"):a===Kindle.ERROR.SITB_INDEX_NOT_AVAILABLE&&g.emit("SITB::IndexNotAvailable");KindleReaderSitbPane.showErrorMessage(a)}k=g.createTimer();var q=g.createTimer();KindleReaderSitbPane.show(d.goToPosition).done(h);KindleReaderSitbPane.setViewState(c.Indexing);b=d.curPosition;
f=d.curLocation;a=d.curPageNumber;e?l():d.bookInfo.getSearchIndex(d.asin).done(n).progress(r).fail(o)}}}();
function ReaderOptions(h){if(!this instanceof ReaderOptions)return new ReaderOptions(h);Object.defineProperty(this,"PORTRAIT",{value:"portrait"});Object.defineProperty(this,"LANDSCAPE",{value:"landscape"});Object.defineProperty(this,"AUTO",{value:"auto"});var j=!0,e=!0,d=!0,c=!0,b=this.AUTO,f=!0,a=!0,g=KindleDeviceCapabilities.multiColumnMode()?2:1,k=!0,m=!0,l=!1,n=KindleDeviceCapabilities.searchInTheBook(),r=!0;Object.defineProperty(this,"bookmarks",{get:function(){return j},set:function(a){j=!!a},
enumerable:!0});Object.defineProperty(this,"annotations",{get:function(){return e},set:function(a){e=!!a},enumerable:!0});Object.defineProperty(this,"selection",{get:function(){return d},set:function(a){d=!!a},enumerable:!0});Object.defineProperty(this,"trackLpr",{get:function(){return c},set:function(a){c=!!a},enumerable:!0});Object.defineProperty(this,"fontSize",{get:function(){return f},set:function(a){f=!!a},enumerable:!0});Object.defineProperty(this,"margins",{get:function(){return a},set:function(b){a=
!!b},enumerable:!0});Object.defineProperty(this,"colors",{get:function(){return k},set:function(a){k=!!a},enumerable:!0});Object.defineProperty(this,"orientation",{get:function(){return b},set:function(a){if(a===this.PORTRAIT||a===this.LANDSCAPE||a===this.AUTO)b=a},enumerable:!0});Object.defineProperty(this,"columns",{get:function(){return g},set:function(a){a=Math.round(a);a>0&&(g=a)},enumerable:!0});Object.defineProperty(this,"viewSettings",{get:function(){return m},set:function(a){m=!!a},enumerable:!0});
Object.defineProperty(this,"rtlPageAdvance",{get:function(){return l},set:function(a){l=!!a},enumerable:!0});Object.defineProperty(this,"searchable",{get:function(){return n},set:function(a){n=!!a},enumerable:!0});Object.defineProperty(this,"showTitle",{get:function(){return r},set:function(a){r=!!a},enumerable:!0});var h=h||{},o;for(o in h)h.hasOwnProperty(o)&&this.hasOwnProperty(o)&&(this[o]=h[o])}
var SearchContextProvider=function(){return{getContextProvider:function(h){function j(d){function e(a){var b;b="";var d=c?1:a.text.length;for(b=KindleStringUtilities.escapeForHTML(a.text);j<n.length&&n[j]<a.pos;)j++;return b=j<n.length&&n[j]>=a.pos&&n[j]<a.pos+d?h+b+l:b}var h,l,n=d.highlightPositions,j=0,o=d;o.context="";d.tagName?(h="<"+d.tagName,d.className&&(h+=' class="'+d.className+'"'),h+=">",l="</"+d.tagName+">"):h=l="";if(c)d.firstPosition=Math.max(Math.min.apply(null,d.highlightPositions)-
b,0),d.lastPosition=Math.max.apply(null,d.highlightPositions)+b;return a.gotoPosition(d.firstPosition,d.firstPosition+250).pipe(function(){function b(){var f;do if(f=a.getItem(),f.pos<=d.firstPosition){c.resolve();return}while(a.previous());a.getLoadingDfd().then(function(a){a?b():c.resolve()},c.reject)}var c=$.Deferred();b();return c.promise()}).pipe(function(){function b(){var f;do{f=a.getItem();if(f.pos>d.lastPosition){c.resolve(o);return}o.context+=e(f)}while(a.next());a.getLoadingDfd().then(function(a){a?
b():c.resolve(o)},c.reject)}var c=$.Deferred();b();return c.promise()}).pipe(function(){return f(d.highlightPositions[0]).pipe(function(a){o.location=a.loc;o.pageNumber=a.pageNumber;return o})})}function e(a){function b(){a.length===0?d.resolve(c):j(a.shift()).then(function(a){c.push(a);b()},d.reject)}var c=[],d=$.Deferred();b();return d.promise()}var d=h.locationConverter,c=d.flavor&&d.flavor()===KindleUserLocationConverter.TOPAZ_FLAVOR,b=c?15:100,f=h.pageLabelConverter,a;return{getContext:function(b){a=
a||KindleRenderer.createWordIterator();return $.isArray(b)?e(b):j(b)}}}}}(),SitbHelperFactory=function(h,j){function e(c){this.positions=c}function d(c){return c.every(function(b){return b.length>0})}e.prototype.getContext=function(c,b){var d=Math.max(Math.min.apply(null,this.positions)-100,0),a=Math.max.apply(null,this.positions)+100;return j({firstPosition:d,lastPosition:a,highlightPositions:this.positions,tagName:c,className:b}).pipe(function(a){return{context:a.context,location:a.location,pageNumber:a.pageNumber}})};
return{create:function(c){function b(a){var b=[];a.split(/\s+/).forEach(function(a){Array.prototype.push.apply(b,m.stem(a))});return b}function f(a){return c.getPositionsForWord(a).pipe(function(a){return a.positions})}function a(a){var b={},c=[],d=[],g=!0;a.forEach(function(a,e){g=g&&k[a];d.push($.when(k[a]||f(a)).pipe(function(d){b[a]=d;c[e]=d.slice(0)}))});return $.when.apply($,d).pipe(function(){k=b;return{results:c,isCached:!!g}},function(){return Kindle.ERROR.SITB_COMMON_ERROR})}function g(c){c=
b(c);return c.length<=0?$.Deferred().resolve([]):a(c).pipe(function(a){function b(a){return a[0]}function c(a,b,d){return b===0||d[b-1]<a}function g(a){a.shift()}function f(a){a[0]===m&&a.shift()}for(var k=a&&a.results||[],h=k.length*20,l=[],m;d(k);){var n=k.map(b),j=n.every(c),I=Math.max.apply(null,n);m=Math.min.apply(null,n);j&&I-m<=h?(k.forEach(g),l.push(new e(n))):k.forEach(f)}return{results:l,isCached:!(!a||!a.isCached)}})}var k={},m,l=c.getProperty("LanguageId");if(l==="und")return Kindle.SITB.LANGUAGE_UNDEFINED;
l&&(l=l.split("-")[0].split("_")[0].toLowerCase());m=h.getStemmer(l);return!m?Kindle.SITB.LANGUAGE_NOT_SUPPORTED:{search:g}}}},KindleCrypto=function(){return{decrypt:function(h,j,e){j=CryptoJS.enc.Base64.parse(j);e=CryptoJS.enc.Base64.parse(e);h=new Uint8Array(h);h=CryptoJS.lib.WordArray.create(h);h=CryptoJS.lib.CipherParams.create({ciphertext:h,algorithm:CryptoJS.algo.AES,mode:CryptoJS.mode.CBC,padding:CryptoJS.pad.PKCS5});return function(d){for(var c=d.words,b=d.sigBytes,f=new Uint8Array(b),a=0;a<
b;a++)d=c[a>>>2]>>>24-a%4*8&255,f[a]=d;return f}(CryptoJS.AES.decrypt(h,j,{iv:e}))}}}(),KindleZip=function(){if(zip.workerScriptsPath==="")zip.workerScriptsPath="./js/Worker/";zip.useWebWorkers=KindleHostDeviceDetector.areWebWorkersSupported()&&!KindleHostDeviceDetector.isiOS();if(!ArrayBuffer.prototype.slice)ArrayBuffer.prototype.slice=function(h,j){for(var e=new Uint8Array(this),h=h===void 0?0:h,j=j===void 0?e.length:j,d=new ArrayBuffer(j-h),c=new Uint8Array(d),b=0;b<c.length;b++)c[b]=e[b+h];return d};
return{unzip:function(h){var j=$.Deferred(),e=[],h=new zip.ArrayBufferReader(h);zip.createReader(h,function(d){d.getEntries(function(c){function b(a){return function(b){f++;e.push({filename:c[a].filename,data:b});f===c.length&&d.close(function(){j.resolve(e)})}}for(var f=0,a=0;a<c.length;a++)c[a].getData(new zip.ArrayBufferWriter,b(a))})},function(d){KindleDebug.error("createReader failed when trying to unzip: "+d);j.reject(d)});return j.promise()}}}(),KindleEventUtil=function(){return{preventKeyScroll:function(h){var h=
h.originalEvent&&h.originalEvent.detail?h.originalEvent.detail:h,j=h.target&&h.target.tagName!=="INPUT",e=[32,33,34,35,36,37,38,39,40].indexOf(h.which)>-1;j&&e&&h.preventDefault()}}}(),SearchTermStemmer=function(){function h(c){return d[c]&&!!ResourceBundle.getLocalizedSearchStopWords(c)}function j(c){var b=d[c].name,f=ResourceBundle.getLocalizedSearchStopWords(c).map(function(a){return KindleStringUtilities.replaceAccentedChars(a,c).replace(/[^A-Za-z0-9 .@'\-]/g,"")}),a=new Snowball(b);return{stem:function(b){var d=
[],e=[],b=b.toLowerCase();b.length>0&&(b.split("@").forEach(function(a){d=d.concat(a.split("-"))}),d.forEach(function(b){if(!(b.length<1)){var d=KindleStringUtilities.replaceAccentedChars(b,c).replace(/[^A-Za-z0-9 .@'\-]/g,"");f.indexOf(d)>=0||(a.setCurrent(b),a.stem(),b=a.getCurrent(),d=KindleStringUtilities.replaceAccentedChars(b,c),e.push(d))}}));return e}}}var e,d={en:{getStemmer:function(){var c=ResourceBundle.getLocalizedSearchStopWords("en");return{stem:function(b){var d=[],a=[],b=KindleStringUtilities.replaceAccentedChars(b).replace(/[^A-Za-z0-9 .@'\-]/g,
"").toLowerCase();b.length>0&&(b=b.split("@"),b.forEach(function(b){a=a.concat(b.split("-"))}),a.forEach(function(a){var b=a.length;b>1&&a.indexOf("'s",b-2)!==-1&&(a=a.substring(0,b-2));a=a.replace(/'/g,"");a=a.replace(/\.(?!\d)/g,"");a.length>0&&c.indexOf(a)===-1&&(a=PorterStemmer.stemmer(a,!1),d.push(a))}));return d}}}},da:{name:"danish"},de:{name:"german"},es:{name:"spanish"},fi:{name:"finnish"},fr:{name:"french"},hu:{name:"hungarian"},it:{name:"italian"},nl:{name:"dutch"},no:{name:"norwegian"},
pt:{name:"portuguese"},ro:{name:"romanian"},sv:{name:"swedish"},tr:{name:"turkish"}};return{getStemmer:function(c){var b=null,c=c||"UNKNOWN";if(h(c))if(d[c].getStemmer)b=d[c].getStemmer();else try{b=j(c)}catch(f){}e||(e=KindleModuleManager.getModuleSync([KindleModuleManager.METRICS_MANAGER]));b?(e.emit("SITB::Language::Supported"),e.emit("SITB::Language::"+c.toUpperCase())):(e.emit("SITB::Language::Unsupported"),e.emit("SITB::Language::Unsupported::"+c.toUpperCase()));return b},isLanguageSupported:h}}(),
KindleErrorMap=function(){var h,j;return{getErrorText:function(e){if(!h){var d=KindleModuleManager.getModuleSync(KindleModuleManager.LINK_URLS);h={};h[Kindle.ERROR.OUT_OF_SPACE]={title:"k_L_saveBookOutOfSpace_Title",text:"k_L_saveBookOutOfSpace_Text",textParams:{linkStart:"<a href='"+d.getIncreaseOfflineStorageUrl()+"' target='_blank'>",linkEnd:"</a>"}};h[Kindle.ERROR.TIMEOUT]={title:"k_L_openBookTimeoutError_Title",text:"k_L_openBookTimeoutError_Text"};h[Kindle.ERROR.LOAD_FAILURE]={title:"k_L_openBookLoadFailure_Title",
text:"k_L_openBookLoadFailure_Text"};h[Kindle.ERROR.REMOVE_FAILURE]={title:"k_L_removeBookError_Title",text:"k_L_removeBookError_Text"};h[Kindle.ERROR.REMOVE_NETWORK_FAILURE]={title:"k_L_removeBookNetworkError_Title",text:"k_L_removeBookNetworkError_Text"};h[Kindle.ERROR.CONTENT_LOANED]={title:"k_L_openBookContentLoanedError_Title",text:"k_L_openBookContentLoanedError_Text"};h[Kindle.ERROR.CONTENT_LOAN_ENDED]={title:"k_L_openBookContentLoanEndedError_Title",text:"k_L_openBookContentLoanEndedError_Text"};
h[Kindle.ERROR.CONTENT_LICENSE_EXCEEDED]={title:"k_L_openBookContentLicenseExceededError_Title",text:"k_L_openBookContentLicenseExceededError_Text"};h[Kindle.ERROR.CONTENT_UNSUPPORTED]={title:"k_L_openBookContentUnsupportedError_Title",text:"k_L_openBookContentUnsupportedError_Text"};h[Kindle.ERROR.CONTENT_UNSUPPORTED_METRO]={title:"k_L_openBookContentUnsupportedErrorMetro_Title",text:"k_L_openBookContentUnsupportedErrorMetro_Text"};h[Kindle.ERROR.CONTENT_RENTAL_EXPIRED]={title:"k_L_openBookContentRentalExpiredError_Title",
text:"k_L_openBookContentRentalExpiredError_Text"};h[Kindle.ERROR.CONTENT_RENTAL_EXPIRED_METRO]={title:"k_L_openBookContentRentalExpiredErrorMetro_Title",text:"k_L_openBookContentRentalExpiredErrorMetro_Text",textParams:{link:"<a href='http://kindle.amazon.com/' target='_blank'>http://kindle.amazon.com/</a>"}};h[Kindle.ERROR.OPEN_BOOK_ASIN_NOT_SPECIFIED]={title:"k_L_openBookAsinNotSpecified_Title",text:"k_L_openBookAsinNotSpecified_Text"};h[Kindle.ERROR.GEOLOCATION_NOT_ALLOWED]={title:"k_L_openBookGeoLocationNotAllowed_Title",
text:"k_L_openBookGeoLocationNotAllowed_Text"};h[Kindle.ERROR.FREE_TRIAL_EXPIRED]={title:"k_endOfFreeTrial_Title",text:"k_endOfFreeTrial_Text"};h[Kindle.ERROR.CONTENT_UPGRADE]={title:"k_L_openBookContentUpgrade_Title",text:"k_L_openBookContentUpgrade_Text"};h[Kindle.ERROR.SESSION_LIMIT_EXCEEDED]={title:"k_L_openBookSessionLimitExceededError_Title",text:"k_L_openBookSessionLimitExceededError_Text"};h[Kindle.ERROR.BOOK_NOT_AVAILABLE]={title:"k_L_bookNotAvailable_Title",text:"k_L_bookNotAvailable_Text"};
h[Kindle.ERROR.REVOKE_FAILED]={title:"k_L_revokeFailed_Title",text:"k_L_revokeFailed_Text"};h[Kindle.ERROR.STORE_NOT_AVAILABLE]={title:"k_L_storeNotAvailable_Title",text:"k_L_storeNotAvailable_Text"};h[Kindle.ERROR.STORE_OPEN_FAILED]={title:"k_store_open_failed_Error_Title",text:"k_store_open_failed_Error_Text"};h[Kindle.ERROR.STORE_OPEN_OFFLINE_FAILED]={title:"k_store_open_failed_offline_Error_Title",text:"k_store_open_failed_offline_Error_Text"};h[Kindle.ERROR.SYNC_FAILED]={title:"k_L_syncFailedError_Title",
text:"k_L_syncFailedError_Text"};h[Kindle.ERROR.SYNC_FAILED_OFFLINE]={title:"k_L_syncFailedOfflineError_Title",text:"k_L_syncFailedOfflineError_Text"};h[Kindle.ERROR.NOT_IMPLEMENTED]={title:"k_lib_unimplementedFeature_Error_Title",text:"k_lib_unimplementedFeature_Error_Text"};h[Kindle.ERROR.LIBRARY_LOAD_FAILED]={title:"k_L_loadFailedError_Title",text:"k_L_loadFailedError_Text"};h[Kindle.ERROR.NETWORK]={title:"k_L_openBookNetworkError_Title",text:"k_L_openBookNetworkError_Text"};h[Kindle.ERROR.UNKNOWN_ERR]=
{title:"k_L_unknownError_Title",text:"k_L_unknownError_Text"};h[Kindle.ERROR.OUTDATED_CHROME]={title:"k_L_outdatedChrome_Title",text:"k_L_outdatedChrome_Text",textParams:{linkStart:"<a href='https://www.google.com/chrome/' target='_blank'>",linkEnd:"</a>"}};h[Kindle.ERROR.SITB_OFFLINE]={title:"k_R_sitb_error_offline_title",text:"k_R_sitb_error_offline_message"};h[Kindle.ERROR.SITB_LANGUAGE_NOT_SUPPORTED]={title:"k_R_sitb_error_language_not_supported_title",text:"k_R_sitb_error_language_not_supported_message"};
h[Kindle.ERROR.SITB_INDEX_NOT_AVAILABLE]={title:"k_R_sitb_error_index_not_available_title",text:"k_R_sitb_error_index_not_available_message"};h[Kindle.ERROR.SITB_COMMON_ERROR]={title:"k_R_sitb_error_common_title",text:"k_R_sitb_error_common_message"};h[Kindle.ERROR.SITB_LANGUAGE_UNDEFINED]={title:"k_R_sitb_error_language_undefined_title",text:"k_R_sitb_error_language_undefined_message"};j={};j[Kindle.ERROR.CONTENT_UNSUPPORTED]=Kindle.ERROR.CONTENT_UNSUPPORTED_METRO;j[Kindle.ERROR.CONTENT_RENTAL_EXPIRED]=
Kindle.ERROR.CONTENT_RENTAL_EXPIRED_METRO}KindleHostDeviceDetector.isMetro()&&(e=j[e]||e);(e=h[e])||(e=h[Kindle.ERROR.UNKNOWN_ERR]);return{title:ResourceBundle.getLocalizedString(e.title,e.titleParams),text:ResourceBundle.getLocalizedString(e.text,e.textParams)}}}}(),KindleIOSScrollStopper={stopScroll:function(h){h.preventDefault()}},KindleListUtilities=function(){return{binarySearch:function(h,j,e){if(!h.length)return 0;for(var d=h.length-1,c=0,b=0,f=null,a=0;c<=d;)if(b=Math.floor((c+d)/2),f=h[b],
a=0,e===void 0?f>j?a=1:f<j&&(a=-1):a=e(j,f),a>0)d=b-1;else if(a<0)c=b+1;else return b;return b===0||a<0?b:b-1},first:function(h){return h[0]},last:function(h){return h[h.length-1]}}}(),KindleOffline=function(){function h(b){var a=new jQuery.Deferred;setTimeout(a.resolve,b);return a.promise()}function j(b,a,d){if(b.indexOf(c)>=0&&KindleHostDeviceDetector.hasCanvasPerformanceProblem()){var e=KindleModuleManager.getModuleSync(KindleModuleManager.METRICS_MANAGER),h=e.startMetrics("Reader::UnoptimizedBookOpen");
KindleUnoptimizedFormatDialog.openPinning(function(b){b?(e.increaseSubCounter(h,"Continue",1),e.endMetrics(h),e=null,a()):(e.increaseSubCounter(h,"Cancel",1),e.endMetrics(h),e=null,d())})}else a()}function e(b,a){if(a){var c=KindleModuleManager.getModuleSync(KindleModuleManager.METRICS_MANAGER),d="BookDownload::Fail::"+a,e=d;switch(b){case Kindle.ERROR.CANCELLED:e+="::Cancelled";break;case Kindle.ERROR.OUT_OF_SPACE:e+="::DBFull";break;case Kindle.ERROR.UNKNOWN_DB_ERROR:e+="::UnknownDBError";break;
case Kindle.ERROR.NETWORK:e+="::Network";break;case Kindle.ERROR.TIMEOUT:e+="::Timeout";break;case Kindle.ERROR.USER_CLOSED_BOOK:e+="::UserClosedBook";break;case Kindle.ERROR.USER_CANCELLED_PIN:e+="::UserCancelledPin";break;default:e+="::Unknown"}c.emit([{name:d,params:{breakdown:["Browser"]}},{name:e,params:{breakdown:["Browser"]}}])}}function d(){return window.localStorage.getItem("haveRun")?!1:!0}var c="topaz",b=null;return{isFirstTime:d,isEnabled:function(){return KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).bookDbEnabled()},
firstRunMessage:function(){var b=new jQuery.Deferred;KindleFirstRunDialog.open({continueCB:function(){KindleHostDeviceDetector.isIE()||KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).enableFullDb().then(b.resolve,b.reject);KindleLocalStorage.setItem(Kindle.App.HAVE_RUN,"true")},onDialogOpenCB:function(){KindleHostDeviceDetector.isIE()&&KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).enableFullDb().then(function(){b.resolve();var a=KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).getBookDb();
a&&d()&&a.BookInfoDB().reserveStorage(10)},b.reject)}});return b.promise()},enableOfflineMessage:function(){var b=new jQuery.Deferred;KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).enableFullDb().then(b.resolve,b.reject);setTimeout(function(){b.isRejected()&&KindleEnableOfflineDialog.open()},500);return b.promise()},pinBook:function(b,a){function c(a){if(a.type===Kindle.ERROR.DB_LINGERING_WRITE)if(a.stalled)KindleFirefoxPromptingDialog.open(),q.getModuleSync(q.METRICS_MANAGER).emit("Pinning::FirefoxPrompting::Open");
else{KindleFirefoxPromptingDialog.close();var b="Pinning::FirefoxPrompting::Close::";b+=a.writeOk?"ok":"no";q.getModuleSync(q.METRICS_MANAGER).emit(b)}}function d(){q.getModuleSync(Kindle.MODULE.DB_CLIENT).removeEventListener(Kindle.ERROR.DB_LINGERING_WRITE,c);q.getModuleSync(q.METRICS_MANAGER).cancelMetrics(s);s=null;t.cancelDownloading(Kindle.ERROR.USER_CANCELLED_PIN);KindleLibraryProgressDialog.close();r.reject()}function m(){q.getModuleSync(Kindle.MODULE.DB_CLIENT).removeEventListener(Kindle.ERROR.DB_LINGERING_WRITE,
c);q.getModuleSync(q.METRICS_MANAGER).endMetrics(s);KindleLibraryProgressDialog.updateValue(100);$.when(o,h(200)).then(function(){KindleLibraryProgressDialog.close();r.resolve(t.getBookType(),t.isContentScrambled())})}function l(b,d){var f=!1;q.getModuleSync(Kindle.MODULE.DB_CLIENT).removeEventListener(Kindle.ERROR.DB_LINGERING_WRITE,c);s&&q.getModuleSync(q.METRICS_MANAGER).endMetrics(s);KindleLibraryProgressDialog.close();b&&(b.getContext&&b.getContext().downloadRestrictionReason&&(f=!0),b.getOpenError&&
(b=b.getOpenError()));b!==Kindle.ERROR.USER_CANCELLED_PIN&&b!==Kindle.ERROR.CANCELLED&&b!==Kindle.ERROR.USER_CLOSED_BOOK&&a(b,d);f||e(b,"Library");r.reject(b)}function n(){function a(b,c){var d=Math.round(100*Math.min(b,c)/Math.max(1,c)),d=Math.max(1,d);KindleLibraryProgressDialog.updateValue(d)}t.getSizeInfo().then(function(b){b.bookSize*1.53>b.quota?(u.reject(),l(Kindle.ERROR.OUT_OF_SPACE)):t.getBookInfoDfd().then(function(){var b=t.getBookType();j(b,function(){q.getModuleSync(Kindle.MODULE.DB_CLIENT).addEventListener(Kindle.ERROR.DB_LINGERING_WRITE,
c);u.resolve(!0);t.getDownloadComplete(a).then(m,l)},function(){u.reject();d()})})})}var r,o,q,t,s,u;Date.now();r=new jQuery.Deferred;if(!KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).bookDbEnabled())return r.reject(),r.promise();q=KindleModuleManagerFactory();window.parent.KindleApp.getSharedModules().done(function(a){q.registerModuleList(a);s=q.getModuleSync(q.METRICS_MANAGER).startMetrics("Pin");t=KindleReaderBookInfoProvider.BookInfo(b,q);o=h(1500);u=new jQuery.Deferred;KindleLibraryProgressDialog.open(d);
t.startDownloading(s,u).then(n,l)});return r.promise()},downloadBook:function(c,a,d,k){function m(){q.getModuleSync(q.METRICS_MANAGER).endMetrics(t);$.when(o,h(200)).then(function(){j.resolve();d()})}function l(a){var b=!1;q.getModuleSync(q.METRICS_MANAGER).cancelMetrics(t);a&&(a.getContext&&a.getContext().downloadRestrictionReason&&(b=!0),a.getOpenError&&(a=a.getOpenError()));if(a!==Kindle.ERROR.CANCELLED){if(a===Kindle.ERROR.CONTENT_UNSUPPORTED&&KindleHostDeviceDetector.isMetro())a=Kindle.ERROR.CONTENT_UNSUPPORTED_METRO;
var c=KindleErrorMap.getErrorText(a);c.code=a;k(c)}b||e(a,"Library");j.reject(a)}function n(){function c(b,d){a(Math.round(100*Math.min(b,d)/Math.max(1,d)))}b.getSizeInfo().then(function(a){a.quota>0&&a.bookSize*1.53>a.quota?l(Kindle.ERROR.OUT_OF_SPACE):(s.resolve(!0),b.getDownloadComplete(c).then(m,l))})}var j,o,q,t,s;j=new jQuery.Deferred;if(!KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).bookDbEnabled())return j.reject(),j.promise();q=KindleModuleManagerFactory();window.parent.KindleApp.getSharedModules().done(function(a){q.registerModuleList(a);
t=q.getModuleSync(q.METRICS_MANAGER).startMetrics("Pin");b=KindleReaderBookInfoProvider.BookInfo(c,q);o=h(1500);s=new jQuery.Deferred;b.startDownloading(t,s).then(n,l)});return j.promise()},removeBook:function(b,a,c){function d(a){j.endMetrics(o);c(a)}function e(){j.endMetrics(o);a()}function h(a){a.cacheState!==Kindle.BookInfo.CachedState.PINNED||a.context.isSample?a=!0:KindleHostDeviceDetector.isOnline()?(a={asin:b.asin,kindleSessionId:a.context.kindleSessionId,isOffline:!1},a=KindleModuleManager.getModuleSync(KindleModuleManager.SERVICE_CLIENT).setOfflineStatus(a)):
a=(new $.Deferred).reject(Kindle.ERROR.NETWORK).promise();return a}var n,j,o;j=KindleModuleManager.getModuleSync(KindleModuleManager.METRICS_MANAGER);o=j.startMetrics("Unpin");n=KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).getBookDb();n.getRecord("bookinfo",{asin:b.asin},{cacheState:!0,context:!0}).then(function(a){a&&a.length>0?$.when(h(a[0])).fail(d).done(function(){n.deleteBooksData([b.asin]).then(e,d)}):e()},d)},cancelBookDownload:function(){b.cancelDownloading()},sendDownloadFailMetric:e}}(),
KindleKatakana=function(){function h(c){var b=c.substring(0,1);return e[b]?b+e[b].v:c}var j={"\u3042":"\u30a2","\u3044":"\u30a4","\u3046":"\u30a6","\u3048":"\u30a8","\u304a":"\u30aa","\u304b":"\u30ab","\u304d":"\u30ad","\u304f":"\u30af","\u3051":"\u30b1","\u3053":"\u30b3","\u3055":"\u30b5","\u3057":"\u30b7","\u3059":"\u30b9","\u305b":"\u30bb","\u305d":"\u30bd","\u305f":"\u30bf","\u3061":"\u30c1","\u3064":"\u30c4","\u3066":"\u30c6","\u3068":"\u30c8","\u306a":"\u30ca","\u306b":"\u30cb","\u306c":"\u30cc",
"\u306d":"\u30cd","\u306e":"\u30ce","\u306f":"\u30cf","\u3072":"\u30d2","\u3075":"\u30d5","\u3078":"\u30d8","\u307b":"\u30db","\u307e":"\u30de","\u307f":"\u30df","\u3080":"\u30e0","\u3081":"\u30e1","\u3082":"\u30e2","\u3084":"\u30e4","\u3086":"\u30e6","\u3088":"\u30e8","\u3089":"\u30e9","\u308a":"\u30ea","\u308b":"\u30eb","\u308c":"\u30ec","\u308d":"\u30ed","\u308f":"\u30ef","\u3092":"\u30f2","\u3093":"\u30f3","\u304c":"\u30ac","\u304e":"\u30ae","\u3050":"\u30b0","\u3052":"\u30b2","\u3054":"\u30b4",
"\u3056":"\u30b6","\u3058":"\u30b8","\u305a":"\u30ba","\u305c":"\u30bc","\u305e":"\u30be","\u3060":"\u30c0","\u3062":"\u30c2","\u3065":"\u30c5","\u3067":"\u30c7","\u3069":"\u30c9","\u3070":"\u30d0","\u3073":"\u30d3","\u3076":"\u30d6","\u3079":"\u30d9","\u307c":"\u30dc","\u3071":"\u30d1","\u3074":"\u30d4","\u3077":"\u30d7","\u307a":"\u30da","\u307d":"\u30dd","\u3094":"\u30f4","\u3041":"\u30a1","\u3043":"\u30a3","\u3045":"\u30a5","\u3047":"\u30a7","\u3049":"\u30a9","\u3063":"\u30c3","\u3083":"\u30e3",
"\u3085":"\u30e5","\u3087":"\u30e7","\u308e":"\u30ee"},e={"\u30a2":{v:"\u30a2"},"\u30a4":{v:"\u30a4"},"\u30a6":{v:"\u30a6"},"\u30a8":{v:"\u30a8"},"\u30aa":{v:"\u30aa"},"\u30ab":{v:"\u30a2"},"\u30ad":{v:"\u30a4"},"\u30af":{v:"\u30a6"},"\u30b1":{v:"\u30a8"},"\u30b3":{v:"\u30aa"},"\u30b5":{v:"\u30a2"},"\u30b7":{v:"\u30a4"},"\u30b9":{v:"\u30a6"},"\u30bb":{v:"\u30a8"},"\u30bd":{v:"\u30aa"},"\u30bf":{v:"\u30a2"},"\u30c1":{v:"\u30a4"},"\u30c4":{v:"\u30a6"},"\u30c6":{v:"\u30a8"},"\u30c8":{v:"\u30aa"},"\u30ca":{v:"\u30a2"},
"\u30cb":{v:"\u30a4"},"\u30cc":{v:"\u30a6"},"\u30cd":{v:"\u30a8"},"\u30ce":{v:"\u30aa"},"\u30cf":{v:"\u30a2"},"\u30d2":{v:"\u30a4"},"\u30d5":{v:"\u30a6"},"\u30d8":{v:"\u30a8"},"\u30db":{v:"\u30aa"},"\u30de":{v:"\u30a2"},"\u30df":{v:"\u30a4"},"\u30e0":{v:"\u30a6"},"\u30e1":{v:"\u30a8"},"\u30e2":{v:"\u30aa"},"\u30e4":{v:"\u30a2"},"\u30e6":{v:"\u30a6"},"\u30e8":{v:"\u30aa"},"\u30e9":{v:"\u30a2"},"\u30ea":{v:"\u30a4"},"\u30eb":{v:"\u30a6"},"\u30ec":{v:"\u30a8"},"\u30ed":{v:"\u30aa"},"\u30ef":{v:"\u30a2"},
"\u30f0":{v:"\u30a4"},"\u30f1":{v:"\u30a8"},"\u30f2":{v:"\u30aa"},"\u30f3":{v:"\u30a2"},"\u30ac":{v:"\u30a2",nq:"\u30ab"},"\u30ae":{v:"\u30a4",nq:"\u30ad"},"\u30b0":{v:"\u30a6",nq:"\u30af"},"\u30b2":{v:"\u30a8",nq:"\u30b1"},"\u30b4":{v:"\u30aa",nq:"\u30b3"},"\u30b6":{v:"\u30a2",nq:"\u30b5"},"\u30b8":{v:"\u30a4",nq:"\u30b7"},"\u30ba":{v:"\u30a6",nq:"\u30b9"},"\u30bc":{v:"\u30a8",nq:"\u30bb"},"\u30be":{v:"\u30aa",nq:"\u30bd"},"\u30c0":{v:"\u30a2",nq:"\u30bf"},"\u30c2":{v:"\u30a4",nq:"\u30c1"},"\u30c5":{v:"\u30a6",
nq:"\u30c4"},"\u30c7":{v:"\u30a8",nq:"\u30c6"},"\u30c9":{v:"\u30aa",nq:"\u30c8"},"\u30d0":{v:"\u30a2",nq:"\u30cf"},"\u30d3":{v:"\u30a4",nq:"\u30d2"},"\u30d6":{v:"\u30a6",nq:"\u30d5"},"\u30d9":{v:"\u30a8",nq:"\u30d8"},"\u30dc":{v:"\u30aa",nq:"\u30db"},"\u30d1":{v:"\u30a2",nq:"\u30cf"},"\u30d4":{v:"\u30a4",nq:"\u30d2"},"\u30d7":{v:"\u30a6",nq:"\u30d5"},"\u30da":{v:"\u30a8",nq:"\u30d8"},"\u30dd":{v:"\u30aa",nq:"\u30db"},"\u30f4":{v:"\u30af",nq:"\u30a6"},"\u30f7":{v:"\u30a2",nq:"\u30ef"},"\u30f8":{v:"\u30a4",
nq:"\u30f0"},"\u30f9":{v:"\u30a8",nq:"\u30f1"},"\u30fa":{v:"\u30aa",nq:"\u30f2"},"\u30a1":{v:"\u30a2"},"\u30a3":{v:"\u30a4"},"\u30a5":{v:"\u30a6"},"\u30a7":{v:"\u30a8"},"\u30a9":{v:"\u30aa"},"\u30c3":{v:"\u30a6"},"\u30e3":{v:"\u30a2"},"\u30e5":{v:"\u30a6"},"\u30e7":{v:"\u30aa"},"\u30ee":{v:"\u30a2"}},d=/.\u30fc/g;return{normalizeKatakana:function(c){c=c.replace(/[\u3040-\u30ff]/g,function(b){b=j[b]||b;return b=e[b]&&e[b].nq||b});return c=c.replace(d,h)},hasHiraganaKatakana:function(c){return c.search(/[\u3040-\u30ff]/)>=
0}}}(),KindleImageUtil=function(){return{getDataUriFromImage:function(h,j){var e=$.Deferred(),d=new Image;d.crossOrigin="Anonymous";d.onload=function(){var c;c=document.createElement("CANVAS");c.height=this.height;c.width=this.width;ctx=c.getContext("2d");ctx.drawImage(this,0,0);c=c.toDataURL(j);e.resolve(c)};d.onerror=e.reject;d.src=h;return e.promise()}}}(),KindleStringUtilities=function(){var h={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"},j=RegExp("["+Object.keys(h).join("")+
"]","g"),e={"\u2019":"'","\uff07":"'","'":"'","\u00e0":"a","\u00e1":"a","\u00e2":"a","\u00e3":"a","\u00e4":"a","\u00e5":"a","\u00c0":"a","\u00c1":"a","\u00c2":"a","\u00c3":"a","\u00c4":"a","\u00c5":"a","\u0100":"a","\u0101":"a","\u0102":"a","\u0103":"a","\u0104":"a","\u0105":"a","\u00e8":"e","\u00e9":"e","\u00ea":"e","\u00eb":"e","\u00c8":"e","\u00c9":"e","\u00ca":"e","\u00cb":"e","\u0112":"e","\u0113":"e","\u0114":"e","\u0115":"e","\u0116":"e","\u0117":"e","\u0118":"e","\u0119":"e","\u011a":"e",
"\u011b":"e","\u00ec":"i","\u00ed":"i","\u00ee":"i","\u00ef":"i","\u00cc":"i","\u00cd":"i","\u00ce":"i","\u00cf":"i","\u0128":"i","\u0129":"i","\u012a":"i","\u012b":"i","\u012c":"i","\u012d":"i","\u012e":"i","\u012f":"i","\u0130":"i","\u00f2":"o","\u00f3":"o","\u00f4":"o","\u00f5":"o","\u00f6":"o","\u00d2":"o","\u00d3":"o","\u00d4":"o","\u00d5":"o","\u00d6":"o","\u014c":"o","\u014d":"o","\u014e":"o","\u014f":"o","\u0150":"o","\u0151":"o","\u00f9":"u","\u00fa":"u","\u00fb":"u","\u00fc":"u","\u00d9":"u",
"\u00da":"u","\u00db":"u","\u00dc":"u","\u0168":"u","\u0169":"u","\u016a":"u","\u016b":"u","\u016c":"u","\u016d":"u","\u016e":"u","\u016f":"u","\u0170":"u","\u0171":"u","\u0172":"u","\u0173":"u","\u00fd":"y","\u00ff":"y","\u00dd":"y","\u0176":"y","\u0177":"y","\u0178":"y","\u00e7":"c","\u00c7":"c","\u0106":"c","\u0107":"c","\u0108":"c","\u0109":"c","\u010a":"c","\u010b":"c","\u010c":"c","\u010d":"c","\u00d0":"d","\u010e":"d","\u010f":"d","\u00f0":"d","\u011c":"g","\u011d":"g","\u011e":"g","\u011f":"g",
"\u0120":"g","\u0121":"g","\u0122":"g","\u0123":"g","\u0124":"h","\u0125":"h","\u0134":"j","\u0135":"j","\u0136":"k","\u0137":"k","\u0139":"l","\u013a":"l","\u013b":"l","\u013c":"l","\u013d":"l","\u013e":"l","\u00f1":"n","\u00d1":"n","\u0143":"n","\u0144":"n","\u0145":"n","\u0146":"n","\u0147":"n","\u0148":"n","\u0154":"r","\u0155":"r","\u0156":"r","\u0157":"r","\u0158":"r","\u0159":"r","\u015a":"s","\u015b":"s","\u015c":"s","\u015d":"s","\u015e":"s","\u015f":"s","\u0160":"s","\u0161":"s","\u0162":"t",
"\u0163":"t","\u0164":"t","\u0165":"t","\u0174":"w","\u0175":"w","\u0179":"z","\u017a":"z","\u017b":"z","\u017c":"z","\u017d":"z","\u017e":"z","\u00df":"s","\u00e6":"a","\u00c6":"a","\u00de":"t","\u00fe":"t","\u00d8":"o","\u00f8":"o"},d={'"':"","'":"","\u00b4":"","\u2018":"","\u2019":"","\u201c":"","\u201d":""},c={fr:{},de:{"\u00df":"ss"},it:{},es:{"\u00d1":"OAAAAA","\u00f1":"oaaaaa"},en:e};return{replaceAccentedChars:function(b,d){var a,g=c[d]||[];a=b.replace(/[^A-Za-z0-9 ]/g,function(a){return g[a]||
e[a]||a});KindleKatakana.hasHiraganaKatakana(a)&&(a=KindleKatakana.normalizeKatakana(a));return a},removeQuotes:function(b){return b=b.replace(/[^A-Za-z0-9 ]/g,function(b){var a=d[b];return a===""?a:b})},escapeForHTML:function(b){return b.replace(j,function(b){return h[b]})},substitute:function(b,c){return b.replace(/\{\{([A-Za-z0-9\_]+)\}\}/g,function(a,b){return b in c?c[b]:a})}}}(),KindleTouchEventsToggler=function(){function h(a){if(f)for(var c=$(":hasTouchEvent"),d=0;d<c.length;d++){var e=c[d];
if((!a||!a(e))&&e._listeners)for(var h=e._listeners.slice(0),n=0;n<h.length;n++){var j=h[n][0];if(j==="touchstart"||j==="touchmove"||j==="touchend")j={element:e,type:j,func:h[n][1],useCapture:h[n][2]},b.push(j),e.removeEventListener(j.type,j.func,j.useCapture)}}}function j(){if(f){for(var a=0;a<b.length;a++){var c=b[a];c.element.addEventListener(c.type,c.func,c.useCapture)}b=[]}}var e=null,d=null,c=!1,b=[],f=!1;return{initialize:function(){if(!c)e=HTMLElement.prototype.addEventListener,HTMLElement.prototype.addEventListener=
function(){if(!this._listeners)this._listeners=[];this._listeners.push(arguments);e.apply(this,arguments)},d=HTMLElement.prototype.removeEventListener,HTMLElement.prototype.removeEventListener=function(){function a(a,b){try{return typeof a==="function"&&typeof b==="function"?a===b:a.handleEvent===b.handleEvent}catch(c){}return!1}if(this._listeners)for(var b=0;b<this._listeners.length;++b)if(this._listeners[b][0]===arguments[0]&&a(this._listeners[b][1],arguments[1])){this._listeners.splice(b,1);break}d.apply(this,
arguments)},f=c=!0,$.expr[":"].hasTouchEvent=function(a){if(a._listeners)for(var b=0;b<a._listeners.length;b++){var c=a._listeners[b][0];if(c==="touchstart"||c==="touchmove"||c==="touchend")return!0}return!1},$.expr[":"].hasListeners=function(a){return a._listeners!==void 0}},deInitialize:function(){if(c){var a=0;$(":hasListeners").each(function(b,c){for(var d=c._listeners.slice(0),f=0;f<d.length;f++)c.removeEventListener(d[f][0],d[f][1]),a++});HTMLElement.prototype.addEventListener=e;HTMLElement.prototype.removeEventListener=
d;b=[];c=!1}},on:j,off:h,disallowTouchEvents:function(){f=!0;h();f=!1},allowTouchEvents:function(){f=!0;j()},isRequired:function(){return KindleHostDeviceDetector.isiOS()&&!KindleHostDeviceDetector.isiOS_7x()&&!KindleHostDeviceDetector.isiOS_8x()}}}();
(function(h){var j=["tap","tapHold","swipeLeft","swipeRight","activate","pinch","zoom","doubletap"];h.each(j,function(e,d){h.fn[d]=function(c,b){b=b||{};return d==="tap"?KindleHostDeviceDetector.isTouchDevice()?c?gt(this).on(d,c,h.extend(b,{expire:700,moveThreshold:10})):this.trigger(d):c?this.click(c):this.trigger("click"):c?gt(this).on(d,c,b):this.trigger(d)};h.attrFn[d]=!0});h.each(j,function(e,d){var c="unbind"+d.slice(0,1).toUpperCase()+d.slice(1);h.fn[c]=function(b){return d==="tap"&&!KindleHostDeviceDetector.isTouchDevice()?
b?this.unbind("click",b):this.unbind("click"):gt(this).off(d,b)};h.attrFn[c]=!0})})(jQuery);
var KindleUXComponentManager=function(){function h(a){if(a.callbacks.onDialogOpen)a.callbacks.onDialogOpen(a.component);a.callbacks.onOverlayClicked&&$(".ui-widget-overlay").tap(a.callbacks.onOverlayClicked).bind("contextmenu",function(b){a.callbacks.onOverlayClicked();b.preventDefault()})}function j(a,b,c){f(a,function(){var d;d=$(Handlebars.templates[a](c));k[a]={component:d};b(d)})}function e(a){a.stopPropagation()}function d(a,b,d,g){var f=k[a];f.callbacks=d;if(d.onInitializationDone)d.onInitializationDone(b);
if(d.getDialogSettings)f.dialogSettings=d.getDialogSettings();if(f.dialogSettings.width===void 0){if(KindleHostDeviceDetector.isiPad())a=l;else if(KindleHostDeviceDetector.isMetro()){if(a=r,f.dialogSettings.dialogClass="wide-dialog",!g)f.dialogSettings.k4w_transparent_modal_overlay=!1}else a=n;f.dialogSettings.width=a}f.dialogSettings.modal&&b.keydown(e).keyup(e);if(KindleHostDeviceDetector.isiOS_5xOrGreater()){a=f.dialogSettings;if(a.modal)a.modal=!1,a.k4w_modal=!0;b=b.dialog(a)}else b=b.dialog(f.dialogSettings);
f.component=b;if(!g&&!KindleHostDeviceDetector.isiOS_5xOrGreater()){var m=b.dialog("option","position");$(window).resize(function(){b.dialog("option","position",m)})}b.bind("dialogopen",function(){h(f)});b.bind("dialogclose",function(){if(f.callbacks.onDialogClose)f.callbacks.onDialogClose(f.component);f.dialogSettings.k4w_modal&&KindleDialogOverlay.removeOverlay()});b.bind("dialogbeforeclose",function(){$(".ui-widget-overlay").unbindTap();f.dialogSettings.modal&&o&&o(!0);f.callbacks.beforeDialogClose&&
f.callbacks.beforeDialogClose(f.component)});c(f)}function c(a){a.component.dialog("isOpen")||(a.dialogSettings.k4w_transparent_modal_overlay?$("body").addClass(m):$("body").removeClass(m),a.callbacks.beforeDialogOpen&&a.callbacks.beforeDialogOpen(a.component),a.dialogSettings.modal&&o&&o(!1),a.dialogSettings.k4w_modal&&KindleDialogOverlay.showOverlay(a),a.component.dialog("open"))}function b(a){k[a]&&k[a].component.dialog("isOpen")&&k[a].component.dialog("close")}function f(b,c){a(b).then(function(){g[b]||
c()},function(){KindleDebug.error("Template "+b+" is missing")})}function a(a){var b=$.Deferred();(a=Handlebars.templates[a])?b.resolve(a):b.reject();return b.promise()}function g(a){return!!Handlebars.templates[a]}var k=[],m="transparent_overlay",l=475,n=400,r="100%",o;return{initializeTemplate:f,hasTemplate:g,renderTemplate:function(a,b){if(!Handlebars.templates[a])throw{name:"initializationError",message:"Please call KindleUXComponentManager.initializeTemplate function first"};return $(Handlebars.templates[a](b))},
initializeComponent:j,openDialog:function(a,b,g){var f=k[a];f?c(f):f!==null&&(k[a]=null,j(a,function(c){d(a,c,b)},g))},closeDialog:b,isVisible:function(a){return k[a]&&k[a].component.dialog("isOpen")?!0:!1},showMenu:function(a,b){var g;b||(g=k[a.componentName]);g?(a.buttonID||KindlePopupMenu.updatePosition(a.componentName,a.position),a.enabledFlags&&KindlePopupMenu.updateMenu(g.component,a.enabledFlags,a.componentName),c(g)):(a.doneCallback=function(b,c){a.enabledFlags&&KindlePopupMenu.updateMenu(b,
a.enabledFlags,a.componentName);k[a.componentName]={component:b};d(a.componentName,b,c,!0)},KindlePopupMenu.initialize(a))},updateMenu:function(a,b){var c=k[a];c&&KindlePopupMenu.updateMenu(c.component,b,a)},hideMenu:b,registerKeyEventsEnabledCallback:function(a){o=a}}}(),KindleWindowSizeWatcher=function(){function h(){n||(n=!0,t.emit(g+"::"+k+"::"+q))}function j(){o||(o=!0,t.emit(g+"::"+m+"::"+q))}function e(){var d=$(window).width();0<d&&d<b?!n&&!o&&KindleSmallWindowDialog.open({onDialogIgnoreCB:j,
onDialogOpenCB:h}):n&&(KindleSmallWindowDialog.close(),n=!1);r&&c(a)}function d(){l!==null&&(clearTimeout(l),l=null)}function c(){var a=f;d();l=setTimeout(e,a)}var b=720,f=200,a=500,g="SmallWindowDialog",k="Shown",m="Ignored",l=null,n=!1,r=!1,o=!1,q,t;return{setMetricsContext:function(a){t||(t=KindleModuleManager.getModuleSync(KindleModuleManager.METRICS_MANAGER));q=a},onWindowResized:c,startPolling:function(){r=!0;var b=a;d();l=setTimeout(e,b)},stopPolling:function(){r=!1}}}(),KindleDialogOverlay=
function(){return{showOverlay:function(h){$("body").append("<div class='ui-widget-overlay ui-widget-overlay-kcr-ios-hack'></div>");$(".ui-widget-overlay-kcr-ios-hack").attr("style","z-index: 1000;");(function(){var j=h.component.dialog("option","position");$("body",Kindle.top.document).bind("orientationchange.dialog",function(){h.dialogSettings.k4w_transparent_modal_overlay&&$(".ui-widget-overlay-kcr-ios-hack").css({width:0,height:0});h.component.dialog("option","position",j)})})();(function(){h.callbacks.onOverlayClicked&&
$(".ui-widget-overlay-kcr-ios-hack").tap(function(h){h.preventDefault()})})()},removeOverlay:function(){$(".ui-widget-overlay-kcr-ios-hack").remove();$("body",Kindle.top.document).unbind("orientationchange.dialog")}}}(),KindleEnableOfflineDialog=function(){function h(){KindleUXComponentManager.closeDialog(j)}var j="KindleEnableOfflineDialog",e={BUTTON_TEXT:"k_dialog_enableOffline_button_text",OFFLINE_TITLE:"k_dialog_enable_offline_title",FIREFOX_MSG:"k_dialog_enable_offline_firefox_msg"},d={DIALOG:"kindle_dialog_enableOffline",
CONTENT:"kindle_dialog_enableOffline_content",BUTTON:"kindle_dialog_enableOffline_button"},c={TITLE:"enable_offline_title",TOP_MSG:"enable_offline_top_msg"},b,f={getDialogSettings:function(){return{autoOpen:!1,width:626,modal:!0,draggable:!1,resizable:!1,dialogClass:"enableOfflineDialog"}},beforeDialogOpen:function(a){b=a;var g,f;KindleHostDeviceDetector.isFirefox()&&(g=ResourceBundle.getLocalizedString(e.OFFLINE_TITLE),f=ResourceBundle.getLocalizedString(e.FIREFOX_MSG,{linkStart:"<a href='"+LinkUrls.getOfflineReadingUrl()+
"' target='_blank'>",linkEnd:"</a>"}));a={title:g,topInstruction:f,topInstructionClass:void 0};b.find("#"+c.TITLE).html(a.title);b.find("#"+c.TOP_MSG).html(a.topInstruction);a.topInstructionClass&&b.find("#"+c.TOP_MSG).addClass(a.topInstructionClass);a=b.find("#"+d.BUTTON);a.html(ResourceBundle.getLocalizedString(e.BUTTON_TEXT));a.one("click",h)},onDialogOpen:function(){var a=$("#"+d.DIALOG);a.parents(".ui-dialog:first").removeClass("ui-widget ui-widget-content ui-corner-all");a.removeClass("ui-dialog-content ui-widget-content")}};
return{open:function(){KindleUXComponentManager.openDialog(j,f)},close:function(){KindleUXComponentManager.closeDialog(j)}}}(),KindleFirefoxPromptingDialog=function(){function h(){KindleHostDeviceDetector.hasHangingDbPrompt()&&KindleUXComponentManager.closeDialog(j)}var j="KindleFirefoxPromptingDialog",e={CLOSE_BUTTON:"k_common_close_button",MESSAGE:"k_dialog_ffPrompting_Text"},d={DIALOG:"kindle_dialog_ffPrompting",IMAGE:"ffPrompting_img",MESSAGE:"kindle_dialog_ffPrompting_text"},c,b={getDialogSettings:function(){return{autoOpen:!1,
modal:!0,draggable:!1,resizable:!1,k4w_transparent_modal_overlay:!1}},beforeDialogOpen:function(b){var a={linkStart:"<a href='"+LinkUrls.getIncreaseOfflineStorageUrl()+"' target='_blank'>",linkEnd:"</a>"};c=b;c.find("#kindle_dialog_ffPrompting_url").text(parent.window.location);c.find("#kindle_dialog_ffPrompting_tab_title").text(parent.document.title);b={};a=ResourceBundle.getLocalizedString(e.MESSAGE,a);c.find("#"+d.MESSAGE).html(a);b[ResourceBundle.getLocalizedString(e.CLOSE_BUTTON)]=h;c.dialog("option",
"buttons",b)}};return{open:function(){KindleHostDeviceDetector.hasHangingDbPrompt()&&KindleUXComponentManager.openDialog(j,b)},close:h}}(),KindleFirstRunDialog=function(){function h(){KindleUXComponentManager.closeDialog(d);g&&g()}function j(){var a,b;if(KindleHostDeviceDetector.isChromeApp())return null;else if(KindleHostDeviceDetector.isChrome())a=ResourceBundle.getLocalizedString(c.OFFLINE_TITLE),b=ResourceBundle.getLocalizedString(c.CHROME_MSG);else if(KindleHostDeviceDetector.isiOS())a=ResourceBundle.getLocalizedString(c.OFFLINE_TITLE),
b=ResourceBundle.getLocalizedString(c.IOS_PROMPT_MSG);else if(KindleHostDeviceDetector.isFirefox())return null;else KindleHostDeviceDetector.isIE()?(a=ResourceBundle.getLocalizedString(c.OFFLINE_TITLE),b=ResourceBundle.getLocalizedString(c.IE_PROMPT_MSG)):(a=ResourceBundle.getLocalizedString(c.OFFLINE_TITLE),b=ResourceBundle.getLocalizedString(c.SAFARI_PROMPT_MSG));return{title:a,topInstruction:b}}function e(){KindleUXComponentManager.closeDialog(d)}var d="KindleFirstRunDialog",c={BUTTON_TEXT:"k_dialog_firstRun_button_text",
BUTTON_TEXT_CHROME:"k_dialog_firstRun_button_text_chrome",CRX_BUTTON_TEXT:"k_dialog_firstRun_button_crx_text",INSTALLING_BUTTON_TEXT:"k_dialog_firstRun_button_installing_text",INSTALLED_BUTTON_TEXT:"k_dialog_firstRun_button_installed_text",CONTINUE_BUTTON_TEXT:"k_dialog_firstRun_button_text_chrome_done",OFFLINE_TITLE:"k_dialog_firstRun_offline_title",CHROME_APP_TITLE:"k_dialog_firstRun_chrome_app_title",CHROME_APP_MSG:"k_dialog_firstRun_chrome_app_msg",CHROME_MSG:"k_dialog_firstRun_chrome_msg",FIREFOX_MSG:"k_dialog_firstRun_firefox_msg",
IOS_PROMPT_MSG:"k_dialog_firstRun_ios_prompt_msg",SAFARI_PROMPT_MSG:"k_dialog_firstRun_safari_prompt_msg",IE_PROMPT_MSG:"k_dialog_firstRun_ie_prompt_msg"},b={DIALOG:"kindle_dialog_firstRun",CONTENT:"kindle_dialog_firstRun_content",BUTTON:"kindle_dialog_firstRun_button",CRX_BUTTON:"kindle_dialog_firstRun_button_crx"},f={TITLE:"first_run_title",TOP_MSG:"first_run_top_msg",TOP_IMG:"first_run_top_img",BOTTOM_IMG:"first_run_bottom_img"},a,g,k,m,l={getDialogSettings:function(){return{autoOpen:!1,width:626,
modal:!0,draggable:!1,resizable:!1,dialogClass:"firstRunDialog"}},beforeDialogOpen:function(a){function d(){KindleChromeInstaller.install();e()}k=a;k.find("#"+f.TITLE).html(m.title);k.find("#"+f.TOP_MSG).html(m.topInstruction);a=k.find("#"+b.BUTTON);a.html(ResourceBundle.getLocalizedString(c.BUTTON_TEXT));a.one("click",h);KindleHostDeviceDetector.isChrome()&&!KindleHostDeviceDetector.isChromeApp()&&(a.removeClass("primary_btn").addClass("chrome_btn").html(ResourceBundle.getLocalizedString(c.BUTTON_TEXT_CHROME)),
a=k.find("#"+b.CRX_BUTTON),a.removeClass("disabled").html(ResourceBundle.getLocalizedString(c.CRX_BUTTON_TEXT)),a.unbind("click"),a.one("click",d),a.show())},onDialogOpen:function(){var c=$("#"+b.DIALOG);c.parents(".ui-dialog:first").removeClass("ui-widget ui-widget-content ui-corner-all");c.removeClass("ui-dialog-content ui-widget-content");a&&a()}};return{open:function(b){(m=j())?(g=b&&b.continueCB,a=b&&b.onDialogOpenCB,KindleUXComponentManager.openDialog(d,l)):b&&b.continueCB&&b.continueCB()},
close:e}}(),KindleMessageDialog=function(){function h(a){if((a.keyCode||a.which)===27)return g(),a.stopImmediatePropagation(),!1}var j={TITLE_ID:"kindle_dialog_message_title_text",TEXT_ID:"kindle_dialog_message_text"},e={dismiss:"k_dialog_message_dismissButton_text"},d,c,b,f,a,g=function(){KindleUXComponentManager.closeDialog("KindleMessageDialog")},k={getDialogSettings:function(){return{autoOpen:!1,modal:!0,draggable:!1,resizable:!1,k4w_transparent_modal_overlay:!0}},beforeDialogOpen:function(d){function k(a){return function(){g();
"function"===typeof a.callback&&a.callback()}}var m={};if(a)for(var o=0;o<a.length;o++){var q=a[o];m[q.buttonText]=k(q)}else f=f?f:ResourceBundle.getLocalizedString(e.dismiss),m[f]=g;d.dialog("option","buttons",m);d.find("#"+j.TITLE_ID).empty().append(b);d.find("#"+j.TEXT_ID).empty().append(c);if(KindleHostDeviceDetector.isMetro())$(".ui-dialog").on("keydown",h)},beforeDialogClose:function(){KindleHostDeviceDetector.isMetro()&&$(".ui-dialog").off("keydown")},onDialogClose:function(){d&&d()}},m=function(g,
e,h,m,j){b=g;c=e;d=h;f=m;a=j;KindleUXComponentManager.openDialog("KindleMessageDialog",k)};return{open:m,close:g,showError:function(a,b,c,d){var g=a;if(a&&a.name)g=a.name;g=KindleErrorMap.getErrorText(g);a&&a.code&&(g.text+=" ["+a.code+"]");m(g.title,g.text,b,c,d)}}}(),KindleNotificationDialog=function(){function h(a){$(window).unbind("touchstart.notification mousedown.notification");KindleHostDeviceDetector.isiOS_5xOrGreater()?$("body",top.document).unbind("orientationchange.notification"):$(window).unbind("resize.notification");
a.removeClass(k.SHOWN);setTimeout(function(){a.remove()},o)}function j(b){function c(d){var g,f,e,h;if(g=a[d.optionProperty])if(typeof g==="string"?f=g:(f=g.id,e=g.localizationParams,h=g.htmlClass),g=ResourceBundle.getLocalizedString(f,e))d=$(d.tag).addClass(d.htmlClass).html(g),h&&d.addClass(h),b.find("."+k.CONTAINER).append(d)}b.find("."+k.CONTAINER).empty();c(k.PRETITLE);c(k.TITLE);c(k.BODY);c(k.LEGAL)}function e(a,b){var c=$("#kindleNotificationArrow"),d=$("#"+b.targetElementId),g=0,f=0;b.targetAlignment===
"right"?(g=d.offset().left+d.outerWidth(),g-=a.outerWidth()):(g=d.offset().left+d.outerWidth()/2,g-=a.outerWidth()/2);(function(){var b=$("body").outerWidth();g+a.outerWidth()>b&&(g=b-a.outerWidth());g<0&&(g=0)})();(function(){var a=b.targetBeakOffset||0;f=d.offset().left-g+d.outerWidth()/2+a})();a.css("left",g+"px");c.css("left",f+"px")}function d(b){function c(){e(b,a);KindleHostDeviceDetector.isiOS()&&b.show();f=null}function d(){f?clearTimeout(f):KindleHostDeviceDetector.isiOS()&&b.hide();f=setTimeout(c,
q)}function g(){u=!0;s&&y.increment();h(b)}var f;$(window).bind("touchstart.notification mousedown.notification",function(b){(!b.srcElement||!b.srcElement.id||!a.clickIdsToIgnore||!a.clickIdsToIgnore[b.srcElement.id])&&setTimeout(g,r)});KindleHostDeviceDetector.isiOS_5xOrGreater()?$("body",top.document).bind("orientationchange.notification",d):$(window).bind("resize.notification",d);setTimeout(g,n)}function c(b){d(b);$("body").append(b);e(b,a);setTimeout(function(){u||(b.addClass(k.SHOWN),setTimeout(function(){s=
!0},l))},m)}function b(a){j(a);c(a)}function f(a){var b=$("<canvas id='kindleNotificationArrow' width='32' height='32'></canvas>"),c=b[0].getContext("2d");c.beginPath();c.moveTo(0,24);c.lineTo(0,25);c.lineTo(32,25);c.lineTo(32,24);c.lineTo(16,0);c.closePath();c.fillStyle="#eee";c.fill();c.beginPath();c.moveTo(0,24);c.lineTo(16,0);c.lineTo(32,24);c.strokeStyle="rgba(32,32,32,0.8)";c.stroke();b.css("top","-24px");b.css("left","50%");b.css("margin-left","-16px");b.css("position","absolute");a.prepend(b);
t.resolve(a)}var a={},g={},k={BODY:{htmlClass:"notificationBodyText",tag:"<div></div>",optionProperty:"bodyId"},LEGAL:{htmlClass:"notificationLegalText",tag:"<div></div>",optionProperty:"legalId"},TITLE:{htmlClass:"notificationTitleText",tag:"<span></span>",optionProperty:"titleId"},PRETITLE:{htmlClass:"notificationPreTitleText",tag:"<span></span>",optionProperty:"preTitleId"},CONTAINER:"notificationContainer",SHOWN:"shown"},m=2E3,l=1E3,n=2E4,r=250,o=3E3,q=100,t=null,s=!1,u=!1,y;return{show:function(c){a=
$.extend({},g,c);y=LocalStorageCounter("kcrNotifications."+a.notificationId);c=a.notificationCount|1;y.getValue()<c&&(t||(t=new jQuery.Deferred,KindleUXComponentManager.initializeComponent("KindleNotificationDialog",f)),t.done(b))},hide:function(){var a=$("#kindleNotification");h(a)}}}(),KindlePopupMenu=function(){function h(b){var c=KindleUXComponentManager.renderTemplate(g),d=c.find(m),f=x[b].menuItems,e=!0,h,k=r;if(x[b].isAppBarMenu){k+=" "+q;var l=x[b].title;if(l){var o=document.createElement("div"),
l=document.createTextNode(l);o.appendChild(l);o.setAttribute("class",t);d.append(o)}}for(var n in f)h=$(document.createElement("div")).addClass(k).addClass(s).text(f[n].content).attr("id",f[n].elementId),e&&(h.addClass(u),e=!1),h.tap(j(h,f[n].clickHandler)),KindleEventBroker.subscribe(f[n].elementId,f[n].clickHandler),d.append(h);h.addClass(y);KindleHostDeviceDetector.isiOS()&&"onorientationchange"in window&&$("body",Kindle.top.document).bind("orientationchange",function(){KindleUXComponentManager.hideMenu(b)});
x[b].doneCallback(c,a(b))}function j(a,b){return function(){a.hasClass(s)&&b()}}function e(a,b,c){var d=[];b?(b=$("#"+b),c==="down"?(c=b.offset(),b=c.top+b.outerHeight(),d[0]=KindleHostDeviceDetector.isMetro()?c.left+23:c.left,d[1]=KindleHostDeviceDetector.isMetro()?b+10:b):(d[0]="right",d[1]="bottom")):d=c;a.dialog("option","position",d)}function d(){C&&(C.removeClass(v),C=null)}function c(a,b,c){var a=a.find(m).children(),d=b;do{if(c==="next")d?(d=d.next(),d.length<=0&&(d=a.first())):d=a.first();
else if(c==="prev")d?(d=d.prev(),d.length<=0&&(d=a.last())):d=a.last();else break;if(d===b)break}while(!d.hasClass(s));return d}function b(a,b){e(a,x[b].buttonID,x[b].position);$(".ui-dialog").on("keydown",function(g){var f=g.keyCode||g.which;KindleEventUtil.preventKeyScroll(g);switch(f){case 38:C&&C.removeClass(v);C=c(a,C,"prev");C.addClass(v);g.stopPropagation();break;case 40:C&&C.removeClass(v);C=c(a,C,"next");C.addClass(v);g.stopPropagation();break;case 13:C&&(g.stopPropagation(),C.removeClass(v),
g=C.attr("id"),KindleEventBroker.fire(g),d());break;case 9:d();H&&KindleUXComponentManager.hideMenu(b);break;case 27:d(),KindleUXComponentManager.hideMenu(b),g.preventDefault(),g.stopPropagation()}});a.find(m).children().each(function(a,b){$(b).on("mouseover",function(a){a=$(a.currentTarget);a.hasClass(s)&&(C?C!==a&&(C.removeClass(v),C=a,a.addClass(v)):(C=a,C.addClass(v)))})})}function f(a){$(".ui-dialog").off("keydown");a.find(m).children().each(function(a,b){$(b).off("mouseover")})}function a(a){return{getDialogSettings:function(){var b=
x[a],c=k;b.isAppBarMenu&&(c+=" "+o);b.buttonID&&(c+=" "+(b.position==="down"?l:n));return{autoOpen:!1,draggable:!1,resizable:!1,modal:!0,minHeight:0,width:"auto",dialogClass:c,k4w_transparent_modal_overlay:!0}},beforeDialogOpen:function(c){b(c,a)},beforeDialogClose:function(b){f(b,a)},onDialogOpen:function(){H=!0},onDialogClose:function(){H=!1},onOverlayClicked:function(){H&&KindleUXComponentManager.hideMenu(a);d()}}}var g="KindlePopupMenu",k="kindle_menu",m="#kindle_menu_border",l="down_menu",n=
"up_menu",r="kindle_menu_button",o="kindle_appbar_menu",q="appbar_menu_button",t="appbar_menu_title",s="button_enabled",u="ui-corner-top",y="ui-corner-bottom",v="selected",x={},H=!1,C=null;return{MENU_POSITION_CONSTANTS:{APPBAR_MENU_MARGIN_PX:5,APPBAR_HEIGHT_PX:102,APPBAR_HEIGHT_SNAPVIEW_PX:70},ITEM_ENABLED:0,ITEM_DISABLED:1,ITEM_HIDDEN:2,initialize:function(a){x[a.componentName]={menuItems:a.menuItems,doneCallback:a.doneCallback,buttonID:a.buttonID,position:a.position,title:a.title,isAppBarMenu:a.isAppBarMenu};
KindleUXComponentManager.hasTemplate(g)?h(a.componentName):KindleUXComponentManager.initializeTemplate(g,function(){h(a.componentName)})},updateMenu:function(a,b,c){for(var d,g,f=0;f<b.length;f++)b[f]!==2&&(d===void 0&&(d=f),g=f);var e=x[c].isAppBarMenu;a.find("."+r).each(function(a){var c=r;if(e||$(this).hasClass(q))c+=" "+q;$(this).attr("class",c);switch(b[a]){case 0:$(this).addClass(s);break;case 1:$(this).addClass("button_disabled");break;case 2:$(this).addClass("button_hidden")}a===d&&$(this).addClass(u);
a===g&&$(this).addClass(y)})},updatePosition:function(a,b){x[a].position=b}}}(),KindlePromptDialog=function(){var h={OK_BUTTON_STRING_ID:"k_common_confirm_button",CANCEL_BUTTON_STRING_ID:"k_common_cancel_button"},j={TEXT_LABEL_ID:"kindle_dialog_prompt_label"},e,d,c,b=function(){c="ok";KindleUXComponentManager.closeDialog("KindlePromptDialog")},f=function(){c="cancel";KindleUXComponentManager.closeDialog("KindlePromptDialog")},a={getDialogSettings:function(){var a={};a[ResourceBundle.getLocalizedString(h.CANCEL_BUTTON_STRING_ID)]=
f;a[ResourceBundle.getLocalizedString(h.OK_BUTTON_STRING_ID)]=b;return{autoOpen:!1,modal:!0,draggable:!1,resizable:!1,buttons:a,k4w_transparent_modal_overlay:!0}},beforeDialogOpen:function(a){var b=ResourceBundle.getLocalizedString(d);a.find("#"+j.TEXT_LABEL_ID).empty().append(b)},onDialogClose:function(){e(c)}};return{open:function(b,f){e=f;c=!1;d=b;KindleUXComponentManager.openDialog("KindlePromptDialog",a)}}}(),KindleSigningOutDialog=function(){var h={getDialogSettings:function(){return{autoOpen:!1,
modal:!0,draggable:!1,resizable:!1,width:"450px"}}};return{show:function(){KindleUXComponentManager.openDialog("KindleSigningOutDialog",h)},hide:function(){KindleUXComponentManager.closeDialog("KindleSigningOutDialog")}}}(),KindleSmallWindowDialog=function(){function h(){KindleUXComponentManager.closeDialog(j);b&&b()}var j="KindleSmallWindowDialog",e={BUTTON_TEXT:"k_dialog_smallWindow_button_ignore",TITLE:"k_dialog_smallWindow_title",DESCRIPTION:"k_dialog_smallWindow_msg"},d={DIALOG:"kindle_dialog_smallWindow",
CONTENT:"kindle_dialog_firstRun_content",TITLE:"small_window_title",DESCRIPTION:"small_window_description",BUTTON:"kindle_dialog_smallWindow_button"},c,b,f,a,g={getDialogSettings:function(){return{autoOpen:!1,width:"auto",modal:!0,draggable:!1,resizable:!1,dialogClass:"smallWindowDialog"}},beforeDialogOpen:function(b){f=b;f.find("#"+d.TITLE).html(a.title);f.find("#"+d.DESCRIPTION).html(a.description);b=f.find("#"+d.BUTTON);b.html(ResourceBundle.getLocalizedString(e.BUTTON_TEXT));b.one("click",h)},
onDialogOpen:function(){var a=$("#"+d.DIALOG);a.parents(".ui-dialog:first").removeClass("ui-widget ui-widget-content ui-corner-all");a.removeClass("ui-dialog-content ui-widget-content");c&&c()}};return{open:function(d){a={title:ResourceBundle.getLocalizedString(e.TITLE),description:ResourceBundle.getLocalizedString(e.DESCRIPTION)};b=d&&d.onDialogIgnoreCB;c=d&&d.onDialogOpenCB;KindleUXComponentManager.openDialog(j,g)},close:function(){KindleUXComponentManager.closeDialog(j)}}}(),KindleSpinner=function(){function h(){c||
(c=new jQuery.Deferred,KindleUXComponentManager.initializeComponent(e,j));return c.promise()}function j(b){d=b;c.resolve()}var e="KindleSpinner",d,c;return{show:function(){var b=h();$.when(b).then(function(){$("body").append(d);var b=window.innerWidth>1?window.innerWidth:window.outerWidth,a=parseInt(d.css("width"),10),c=window.innerHeight>1?window.innerHeight:window.outerHeight,e=parseInt(d.css("height"),10);d.css("top",(c-e)/2+"px").css("left",(b-a)/2+"px")})},hide:function(){var b=h();$.when(b).then(function(){$("#loading_spinner").detach()})}}}(),
KindleUnoptimizedFormatDialog=function(){var h={TEXT_LABEL_STRING_ID:"k_R_dialog_unoptimizedFormat_message",METRO_TEXT_LABEL_STRING_ID:"k_R_dialog_unoptimizedFormat_metro_message",CLOSE_BUTTON_STRING_ID:"k_R_dialog_unoptimizedFormat_close",STOP_BUTTON_STRING_ID:"k_R_dialog_unoptimizedFormat_stopSave",CONTINUE_BUTTON_STRING_ID:"k_R_dialog_unoptimizedFormat_continue"},j={TEXT_LABEL_ID:"kindleReader_dialog_unoptimizedFormat_message_id"},e,d,c,b=function(){KindleUXComponentManager.closeDialog("KindleUnoptimizedFormatDialog")},
f=function(){d=!0;KindleUXComponentManager.closeDialog("KindleUnoptimizedFormatDialog")},a={getDialogSettings:function(){var a={};a[ResourceBundle.getLocalizedString(h.CLOSE_BUTTON_STRING_ID)]=b;a[ResourceBundle.getLocalizedString(h.CONTINUE_BUTTON_STRING_ID)]=f;return{autoOpen:!1,modal:!0,draggable:!1,resizable:!1,buttons:a,k4w_transparent_modal_overlay:!0}},beforeDialogOpen:function(a){var b=KindleHostDeviceDetector.isMetro()?h.METRO_TEXT_LABEL_STRING_ID:h.TEXT_LABEL_STRING_ID,b=ResourceBundle.getLocalizedString(b,
{linkStart:"<a href='http://itunes.apple.com/us/app/kindle/id302584613?mt=8'>",linkEnd:"</a>"});a.find("#"+j.TEXT_LABEL_ID).empty().append(b);$(a[0].parentNode).find(".ui-button-text").first().text(c)},onDialogClose:function(){e(d)}};return{open:function(b){c=ResourceBundle.getLocalizedString(h.CLOSE_BUTTON_STRING_ID);e=b;d=!1;KindleUXComponentManager.openDialog("KindleUnoptimizedFormatDialog",a)},openPinning:function(b){c=ResourceBundle.getLocalizedString(h.STOP_BUTTON_STRING_ID);e=b;d=!1;KindleUXComponentManager.openDialog("KindleUnoptimizedFormatDialog",
a)}}}(),KindleReaderEmbeddedError=function(){var h={ErrorTextDiv:"kindleReader_embeddedError_text"},j={getDialogSettings:function(){return{autoOpen:!1,modal:!0,draggable:!1,resizable:!1,dialogClass:"embedded_error",k4w_transparent_modal_overlay:!0}}};return{open:function(e){KindleUXComponentManager.openDialog("KindleReaderEmbeddedError",j);var d=$("#"+h.ErrorTextDiv),e=KindleErrorMap.getErrorText(e);d.text(e&&e.text||ResourceBundle.getLocalizedString("k_L_unknownError_Text"))}}}(),KindleAnnotationComponentFactory=
function(){function h(a,b){return a.replace(".","_")+"_"+b}function j(a,b){a.find("."+o.CONTEXT).tap(function(){b(a)})}function e(a,b){var c=function(c){return function(){var d=b[r[c]];d&&d(a)}},d;for(d in n){var g=a.find("."+n[d]);b[r[d]]||g.remove();g.tap(c(d))}}function d(a,b){b.length>t?a.find("."+o.CONTEXT).text(b.substring(0,t)+" ..."):a.find("."+o.CONTEXT).text(b)}var c=0,b=c++,f=c++,a=c++,g=c++,k=c++,m=c++,l=c++,n={TRASH_CAN:"kindleReader_annotation_pane_notes_trashcan",EDIT:"kindleReader_annotation_pane_notes_edit",
GOTO:"kindleReader_annotation_pane_notes_goto",SAVE:"kindleReader_annotation_pane_notes_save",CANCEL:"kindleReader_annotation_pane_notes_cancel",YES:"kindleReader_annotation_pane_notes_yes",NO:"kindleReader_annotation_pane_notes_no"},r={TRASH_CAN:f,EDIT:b,GOTO:a,SAVE:g,CANCEL:k,YES:m,NO:l},o={CONTEXT:"kindleReader_annotation_pane_notes_context"},q={TEXT_AREA:"kindleReader_annotation_pane_edit_textArea"},t=430,s=function(){return KindleUserLocationConverter},u=function(){return KindleUXComponentManager},
y=function(){return KindleReaderAnnotationManager};return{EVENT_EDIT_CLICKED:b,EVENT_DELETE_CLICKED:f,EVENT_GOTO_CLICKED:a,EVENT_SAVE_CLICKED:g,EVENT_CANCEL_CLICKED:k,EVENT_YES_CLICKED:m,EVENT_NO_CLICKED:l,MAX_NOTE_CONTEXT_LENGTH:t,initialize:function(a){var b=s(),c=u();b.mobiLocationConverter();c.initializeTemplate("KindleAnnotationComponentFactory",a)},createAnnotationComponent:function(a,c,f,s){var n=new jQuery.Deferred,r=u(),B=y(),w,E={context:a.note||a.context,start:a.start,pageLabel:"",id:h(a.type,
a.start),maxContextLength:t};c(a.start).pipe(function(c){var h="",u=h="",y="";c.pageNumber&&(h=ResourceBundle.getLocalizedString("k_R_annotation_pane_notes_page",{page:c.pageNumber}));c.loc&&(h&&(u=" \u25cf "),y=ResourceBundle.getLocalizedString("k_R_annotation_pane_notes_location",{location:c.loc}));E.pageLabel=h+u+y;switch(a.type){case B.BOOKMARK:w=r.renderTemplate("KindleAnnotationComponentFactory",E);w.find(".kindleReader_annotation_pane_icon").addClass("kindleReader_annotation_pane_icon_bookmark");
s[b]=null;s[g]=null;s[k]=null;s[m]=null;s[l]=null;break;case B.HIGHLIGHT:w=r.renderTemplate("KindleAnnotationComponentFactory",E);w.find(".kindleReader_annotation_pane_icon").addClass("kindleReader_annotation_pane_icon_highlight");s[b]=null;s[g]=null;s[k]=null;s[m]=null;s[l]=null;break;case B.NOTE:w=r.renderTemplate("KindleAnnotationComponentFactory",$.extend({},E,{maxNoteChars:Kindle.opt.maxNoteChars})),w.find(".kindleReader_annotation_pane_icon").addClass("kindleReader_annotation_pane_icon_note"),
KindleHostDeviceDetector.isIE11()&&w.find("#"+q.TEXT_AREA).attr("spellcheck","false"),KindleTouchEventsToggler.isRequired()&&(w.find("#"+q.TEXT_AREA).focus(function(){KindleTouchEventsToggler.off()}),w.find("#"+q.TEXT_AREA).blur(function(){KindleTouchEventsToggler.on()}))}if(E.context){if(d(w,E.context),a.type===B.NOTE)c=w.find("."+o.CONTEXT)[0],c.innerHTML=c.innerHTML.replace(/\n/g,"<br />")}else w.find("."+o.CONTEXT).remove();j(w,f);e(w,s);n.resolve(w)});return n.promise()},setAnnotationContext:d,
getAnnotationID:h,setUserLocationConverter:function(a){s=a},setUXComponentManager:function(a){u=a},setAnnotationManager:function(a){y=a}}}(),KindleImageViewer=function(h){function j(){d=e.find(".imageViewerImage");$("<img/>").attr("src",d.attr("src")).load(function(){var b=this.width/this.height,c=h.parent.width()/h.parent.height();b>c?(d.css("height","auto"),d.css("width","100%")):(d.css("height","100%"),d.css("width","auto"));d.css("max-width",Math.min(this.width,$(window).width()));d.css("max-height",
Math.min(this.height,$(window).height()))})}var e,d,c=new jQuery.Deferred;KindleUXComponentManager.initializeTemplate("KindleImageViewer",function(){var b=KindleUXComponentManager.renderTemplate("KindleImageViewer",{imageSource:h.imageSource});e=$(b).hide();j();$("body",Kindle.top.document).bind("orientationchange",j);$(window).resize(j);$(d).bind("dragstart",function(){return!1});c.resolve({backdrop:e,image:d})});return c},KindleReaderAnnotationsPane=function(){function h(){z=I;I=Math.max(z-x,0);
d();l("bottom")}function j(){I=z;z=Math.min(I+x,C.length);d();l(0)}function e(a){a.appendTo(m())}function d(){m().empty();N.remove();D.add(M).remove();for(var a=I;a<z;++a)b(C[a]).done(e);c();g()}function c(){var a=m();I>0&&D.unbind("click.goPrev").bind("click.goPrev",h).add(M).prependTo(a);z<C.length&&N.unbind("click.goNext").bind("click.goNext",j).appendTo(a)}function b(d){function f(a){var h;jQuery.each(C,function(a,b){b.start===d.start&&b.end===d.end&&b.type===d.type&&(h=a)});a.remove();h!==-1&&
(h<I||z<=h?C.splice(h,1):(C.splice(h,1),a=z-1,a<C.length&&C.length>0&&(N.remove(),D.add(M).remove(),b(C[a]).done(e),c())));C.length===0&&K.find("#"+y.EMPTY_MESSAGE).show();g()}m();var h=O(),k={};k[h.EVENT_DELETE_CLICKED]=function(a){d.type===KindleReaderAnnotationManager.NOTE?(a.find("."+v.DELETE_ICON).hide(),a.find("."+v.EDIT_ICON).hide(),a.find("."+v.GOTO_ICON).hide(),a.find("."+v.CANCEL_BTN).hide(),a.find("."+v.SAVE_BTN).hide(),a.find("."+v.CONFIRMATION).show(),a.find("."+v.YES_BTN).show(),a.find("."+
v.NO_BTN).show()):(f(a),B(d))};k[h.EVENT_EDIT_CLICKED]=function(b){b.find("."+v.CONTEXT).hide();b.find("."+v.EDIT_ICON).hide();b.find("."+v.GOTO_ICON).hide();b.find("."+v.DELETE_ICON).hide();b.find("#"+y.EDIT_NOTE).show();b.find("."+v.CANCEL_BTN).show();b.find("."+v.SAVE_BTN).show();J().isiOS()||b.find("#"+y.EDIT_NOTE).focus();a()};k[h.EVENT_GOTO_CLICKED]=function(){n();E(d)};k[h.EVENT_SAVE_CLICKED]=function(a){var b=a.find("#"+y.EDIT_NOTE).val().trim();if(b){var c=a.find("."+v.CONTEXT);c.empty();
KindleAnnotationComponentFactory.setAnnotationContext(a,b);c=c[0];c.innerHTML=c.innerHTML.replace(/\n/g,"<br />");q(a)}else f(a);w(b,d)};k[h.EVENT_CANCEL_CLICKED]=function(a){a.find("#"+y.EDIT_NOTE).val(d.note);q(a)};k[h.EVENT_NO_CLICKED]=function(a){a.find("."+v.DELETE_ICON).show();a.find("."+v.EDIT_ICON).show();a.find("."+v.GOTO_ICON).show();a.find("."+v.CONFIRMATION).hide();a.find("."+v.YES_BTN).hide();a.find("."+v.NO_BTN).hide()};k[h.EVENT_YES_CLICKED]=function(a){f(a);B(d)};return h.createAnnotationComponent(d,
_pageLabelConverter,function(b){var c=d;if(A){var g=KindleAnnotationComponentFactory.getAnnotationID(A.type,A.start),g=m().find("#"+g);KindleAnnotationComponentFactory.setAnnotationContext(g,A.note||A.context)}A=c;c=c.note||c.context;b.find("."+v.CONTEXT).text(c);b=b.find("."+v.CONTEXT)[0];b.innerHTML=b.innerHTML.replace(/\n/g,"<br />");a()},k)}function f(a){a.stopPropagation()}function a(){if(L){var a=k();a.jScrollPane({showArrows:!0,verticalGutter:10});a.removeAttr("tabindex");$(".jspContainer").keypress(f).keyup(f).keydown(f)}else F&&
(P?P.refresh():P=new iScroll(y.SCROLL_WRAPPER,{vScrollbar:!1}))}function g(){var b=k(),c=K.height();J().isiOS()?K.find("#"+y.SCROLL_WRAPPER).height(c):b.height(c-6);$(b).animate({opacity:1},100);a()}function k(){return K.find("#"+y.CONTAINER)}function m(){return L?k().data("jsp").getContentPane():k()}function l(a){if(F)a==="bottom"&&(a=-9999),P.scrollTo(0,a);else if(L){var b=k().data("jsp");a==="bottom"?b.scrollToBottom():b.scrollToY(0)}else b=k(),a==="bottom"&&(a=b.height()),b.scrollTop(a)}function n(){t();
KindleUXComponentManager.closeDialog(s)}function r(a){A=null;K=a;var b;$(window).resize(function(){clearTimeout(b);b=setTimeout(g,50)});L?(k().jScrollPane({showArrows:!0,verticalGutter:10}),$(".jspContainer").keypress(f).keyup(f).keydown(f)):F||k().addClass("ie_scrollable");k().hover(function(){document.onmousewheel=function(){return!0}},function(){document.onmousewheel=function(){return!1}})}function o(a){var b=C.length;if(C.length===0)return-1;for(var c=0;c<b;c++)if(C[c].end>=a||C[c].start>=a)break;
return c}function q(b){b.find("."+v.CONTEXT).show();b.find("."+v.EDIT_ICON).show();b.find("."+v.GOTO_ICON).show();b.find("."+v.DELETE_ICON).show();b.find("#"+y.EDIT_NOTE).hide();b.find("."+v.CANCEL_BTN).hide();b.find("."+v.SAVE_BTN).hide();a()}function t(){C=A=null;z=I=0;m().empty();a()}var s="KindleReaderAnnotationsPane",u={CLOSE_BUTTON_STRING_ID:"k_common_close_button",CLICK_FOR_PREVIOUS:"k_R_annotation_pane_previous",CLICK_FOR_NEXT:"k_R_annotation_pane_next"},y={PANE:"kindleReader_annotations_pane",
HEADER:"kindleReader_annotations_pane_header",CONTAINER:"kindleReader_annotations_pane_container",SCROLL_WRAPPER:"kindleReader_annotations_pane_scrollWrapper",EMPTY_MESSAGE:"kindleReader_annotations_pane_notes_empty",EDIT_NOTE:"kindleReader_annotation_pane_edit_textArea"},v={SELECTED:"kindleReader_annotation_pane_notes_selected",CONTEXT:"kindleReader_annotation_pane_notes_context",EDIT_ICON:"kindleReader_annotation_pane_notes_edit",GOTO_ICON:"kindleReader_annotation_pane_notes_goto",CANCEL_BTN:"kindleReader_annotation_pane_notes_cancel",
SAVE_BTN:"kindleReader_annotation_pane_notes_save",YES_BTN:"kindleReader_annotation_pane_notes_yes",NO_BTN:"kindleReader_annotation_pane_notes_no",CONFIRMATION:"kindleReader_annotation_notes_delete_confirm",DELETE_ICON:"kindleReader_annotation_pane_notes_trashcan"},x=100,H=1/3,C=[],I,z,B,w,E,K,D,M,N,F=KindleHostDeviceDetector.isiOS(),L=!F&&!KindleHostDeviceDetector.isIE(),P,A,O=function(){return KindleAnnotationComponentFactory},J=function(){return KindleHostDeviceDetector},G={getDialogSettings:function(){var a=
{};a[ResourceBundle.getLocalizedString(u.CLOSE_BUTTON_STRING_ID)]=n;var b={},c,b={autoOpen:!1,width:"90%",height:c,modal:!0,draggable:!1,resizable:!1,buttons:a};c=J().isiOS()?$("body",Kindle.top.document).height()-80:KindleHostDeviceDetector.isMetro()?window.outerHeight-250:window.outerHeight-150;b.height=c;return b},onInitializationDone:r,onDialogOpen:function(){J().isiOS()&&($("#kindleReader_annotations_pane").height($("body",Kindle.top.document).height()-212),$("#kindleReader_annotations_pane_scrollWrapper").height($("body",
Kindle.top.document).height()-212))}};return{open:function(){O().initialize(function(){KindleUXComponentManager.openDialog(s,G)})},scrollToPosition:function(a){if(C&&(a=Math.min(o(a),C.length-1),$("#"+y.PANE).offset(),K.parent().height(),a!==-1)){I<=a&&a<z||(z=Math.min(Math.max(a-Math.floor(H*x),0)+x,C.length),I=Math.max(0,z-x),d());var b=C[a],a=0,b=KindleAnnotationComponentFactory.getAnnotationID(b.type,b.start),c=K.find("#"+b),a=a||0;F?P.scrollToElement("#"+b,a):L?k().data("jsp").scrollToElement(c,
!0,!!a):k().scrollTop(c.offset().top)}},loadAnnotations:function(a,b,c,g,f){a.length===0?(t(),K.find("#"+y.EMPTY_MESSAGE).show()):(K.find("#"+y.EMPTY_MESSAGE).hide(),E=c,B=g,w=f,m(),C=a.slice(),_pageLabelConverter=b,A=null,D=$("<div/>",{"class":"kindleReader_annotation_pane_notes_prev",text:ResourceBundle.getLocalizedString(u.CLICK_FOR_PREVIOUS)}),M=$("<div/>",{"class":"kindleReader_annotation_pane_notes_divider_top"}),M=M.add($("<div/>",{"class":"kindleReader_annotation_pane_notes_divider_bottom"})),
N=$("<div/>",{"class":"kindleReader_annotation_pane_notes_next",text:ResourceBundle.getLocalizedString(u.CLICK_FOR_NEXT)}),I=0,z=Math.min(x,C.length),d())},setUXComponentManager:function(){},setAnnotationComponentFactory:function(a){O=a},setHostDeviceDetector:function(a){J=a},onInitializationDone:r}}(),KindleReaderBookmarkOverlay=function(){function h(b){e=b;j();d(b)}function j(){c?e.addClass("preBookmark").addClass("hasBookmark").fadeIn(250):e.removeClass("hasBookmark").removeClass("preBookmark")}
var e,d,c;return{initialize:function(b){d=b;KindleUXComponentManager.initializeComponent("KindleReaderBookmarkOverlay",h)},setIsBookmarked:function(b){c=b;e&&j()},setImmersiveMode:function(b){b?e.addClass("immersiveBookmark"):e.removeClass("immersiveBookmark")},setVisible:function(b){e.css("visibility",b?"visible":"hidden")}}}(),ReaderImmersiveModeIcon=function(){function h(b){e=b;d(e);j()}function j(){switch(b){case KINDLE_READER_SETTINGS_COLOR_MODE.WHITE:e.find(c).removeClass("black");e.find(c).removeClass("sepia");
break;case KINDLE_READER_SETTINGS_COLOR_MODE.BLACK:e.find(c).removeClass("sepia");e.find(c).addClass("black");break;case KINDLE_READER_SETTINGS_COLOR_MODE.SEPIA:e.find(c).removeClass("black"),e.find(c).addClass("sepia")}}var e,d,c="#immersive_icon",b;return{initialize:function(b){d=b;KindleUXComponentManager.initializeComponent("ReaderImmersiveModeIcon",h)},setIconColor:function(c){b=c;e&&j()}}}();
function KindleReaderDictionaryViewer(h,j,e){function d(){var a={componentName:g,menuItems:function(a){function b(a){return function(){c();f();j.onDictChanged(a)}}var d={};a.forEach(function(a){var c=a.asin,g=b(a.asin);d[c]={elementId:"dict_"+a.asin,content:a.title,clickHandler:g}});return d}(e),buttonID:"dictionaryList",position:"down",isAppBarMenu:!1};KindleUXComponentManager.showMenu(a,!0)}function c(){KindleUXComponentManager.hideMenu(g)}function b(b,c){if(!h.is(":hidden")){f();c.noEscape=!0;
var g=KindleUXComponentManager.renderTemplate(a,c);g.find(".dictionaryMain").append(b);h.addClass("dictionary_enabled");h.prepend(g);setTimeout(function(){h.find(".dictionary").addClass("expanded")},50);h.prepend(g);h.find(".view_full_link").click(function(){j.viewFullLink(c.dictionaryAsin);return!1});c.isFullDefPane&&h.find(".link").addClass("clickableLink").click(j.linkClickHandler);c.dictionaryListMenuEnabled&&h.find(".dictionaryList").click(d)}}function f(){h&&h.hasClass("dictionary_enabled")&&
(h.find(".dictionary").remove(),h.find(".dictionary_loading").empty().hide(),h.find(".dictionary_error").remove(),h.find(".dictionaryMain").empty(),h.removeClass("dictionary_enabled"))}var a="KindleReaderDictionary",g="KindleReaderDictionaryListMenu",k=e.length>1,m={};e.forEach(function(a){m[a.asin]=a.localeFrom});return{showLoading:function(){var a=h.find(".dictionary_loading");a.show();h.addClass("dictionary_enabled");var b=Handlebars.templates.KindleSimpleSpinner({});a.append(b)},showError:function(a,
c){var d="";switch(a){case IDictionary.NOT_FOUND:d=ResourceBundle.getLocalizedString("k_R_dictionary_not_found");break;case IDictionary.OFFLINE:d=ResourceBundle.getLocalizedString("k_R_dictionary_offline");break;case IDictionary.LOOKUP_FAILED:d=ResourceBundle.getLocalizedString("k_R_dictionary_not_available");break;default:d=ResourceBundle.getLocalizedString("k_R_dictionary_not_available")}d='<div class="dictionary_error">{{error}}</div>'.replace("{{error}}",d);b(d,{dictionaryUsed:c||"Dictionary",
dictionaryListMenuEnabled:k,isForContextMenu:!0})},renderDefinition:function(a){a.results&&a.results.forEach(function(b){b.labels={Origin:ResourceBundle.getLocalizedString("k_R_dictionary_labels_Origin",null,m[a.dictionaryAsin]),Notes:ResourceBundle.getLocalizedString("k_R_dictionary_labels_Notes",null,m[a.dictionaryAsin]),Derivatives:ResourceBundle.getLocalizedString("k_R_dictionary_labels_Derivatives",null,m[a.dictionaryAsin]),Usage:ResourceBundle.getLocalizedString("k_R_dictionary_labels_Usage",
null,m[a.dictionaryAsin]),Ipa:ResourceBundle.getLocalizedString("k_R_dictionary_labels_Ipa",null,m[a.dictionaryAsin]),Phrases:ResourceBundle.getLocalizedString("k_R_dictionary_labels_Phrases",null,m[a.dictionaryAsin]),RelatedWords:ResourceBundle.getLocalizedString("k_R_dictionary_label_RelatedWords",null,m[a.dictionaryAsin])}});var c=KindleUXComponentManager.renderTemplate("KindleReaderDictionaryDefinitions",{results:a.results,isFullDefPane:a.isFullDefPane});$.extend(a,{dictionaryListMenuEnabled:k});
b(c,a)},removeDefinition:f,hideDictionaryListMenu:c}}
var KindleReaderFullDefinition=function(){function h(){f.hideDictionaryListMenu();KindleUXComponentManager.closeDialog(b)}function j(b){f.renderDefinition({results:b.definitions,dictionaryUsed:b.dictionaryName,dictionaryAsin:b.asin,isFullDefPane:!0});b=a.find("#kindleReader_full_definition_scrollContainer");l?b.jScrollPane({showArrows:!0,verticalGutter:10}):m?(n&&n.destroy(),n=new iScroll(k.FullDefWrapper,{vScrollbar:!1})):b.addClass("ie_scrollable")}function e(b,d,g,h){function k(a,b){a.lookup(b).then(function(a){var b=
a&&a.isKiDS?"::KiDS":"::Dictionary";o.emit("Reader"+b+"::FullDef::WordFound");a&&a.isKiDS&&o.emit("Reader"+b+"::FullDef::WordFound::"+a.dictionaryLanguage);j(a)},c)}f=new KindleReaderDictionaryViewer(a,{onDictChanged:function(a){KindleDebug.log("New search requested for this dictionary:"+a);KindleLocalStorage.setItem(Kindle.App.USER_DICT_ASIN,a);e(null,d,g,h);r.emit("Reader::DictionaryChanged::FullDef")},linkClickHandler:function(a){e(null,a.currentTarget.attributes.target?a.currentTarget.attributes.target.value:
a.currentTarget.textContent,g,h)}},h);b?j(b):(f.removeDefinition(),d&&(f.showLoading(),o=r.createTimer(),dictionary.getDictionary().done(function(a){var b={word:d},c=KindleLocalStorage.getItem(Kindle.App.USER_DICT_ASIN);if(c)b.dictionary=c;else if(g)b.dictionary=g;k(a,b)})))}function d(){g.dialog("option","height",window.innerHeight-50);g.dialog("option","position",{my:"center",at:"center",of:window});var b=a.find("#kindleReader_full_definition_scrollContainer");l?b.jScrollPane({showArrows:!0,verticalGutter:10}):
m?n?n.refresh():n=new iScroll(k.FullDefWrapper,{vScrollbar:!1}):b.addClass("ie_scrollable")}function c(a,b){var c=b&&b.isKiDS?"::KiDS":"::Dictionary",d="";switch(a){case IDictionary.NOT_FOUND:d="::FullDef::WordNotFound";break;case IDictionary.OFFLINE:d="::FullDef::Offline";break;case IDictionary.LOOKUP_FAILED:d="::FullDef::LookupFailed";break;default:d="::FullDef::LookupFailed"}o.emit("Reader"+c+d);b&&b.isKiDS&&o.emit("Reader"+c+d+"::"+b.dictionaryLanguage);f.showError(a,b.dictionaryName)}var b="KindleReaderFullDefinitionPane",
f,a,g,k={CLOSE_BUTTON_STRING_ID:"k_common_close_button",FullDefContainer:"kindleReader_full_definition_content",FullDefWrapper:"kindleReader_dictionary_scrollWrapper",FullDefPane:"kindleReader_full_definition_pane"},m=KindleHostDeviceDetector.isiOS(),l=!m&&!KindleHostDeviceDetector.isIE(),n,r,o,q={getDialogSettings:function(){var a={};a[ResourceBundle.getLocalizedString(k.CLOSE_BUTTON_STRING_ID)]=h;var b={},c,b={autoOpen:!1,width:"720px",height:c,modal:!0,draggable:!1,resizable:!1,buttons:a};c=KindleHostDeviceDetector.isiOS()?
$("body",Kindle.top.document).height()-80:KindleHostDeviceDetector.isMetro()?window.outerHeight-250:window.innerHeight-50;b.height=c;return b},onInitializationDone:function(){var a;$(window).resize(function(){clearTimeout(a);a=setTimeout(d,50)})}};return{open:function(c,d,f,h){r||(r=KindleModuleManager.getModuleSync([KindleModuleManager.METRICS_MANAGER]));KindleUXComponentManager.openDialog(b,q);a=$("#"+k.FullDefContainer);g=$("#"+k.FullDefPane);e(c,d,f,h)}}}(),KindleReaderContextMenu=function(){function h(){function a(c){v=
c.getDictionaryForLanguage("en-US")?KindleReaderContextMenuDictionary:KindleReaderContextMenuDictionaryDotCom;b.resolve()}var b=$.Deferred();u==="en-US"?dictionary.getDictionary().then(a):(v=KindleReaderContextMenuDictionary,b.resolve());return b.promise()}function j(a){a.dialog("option","position",q);a.parent().css("bottom","auto")}function e(){KindleUXComponentManager.isVisible(d)&&($(".ui-widget-overlay").show(),KindleUXComponentManager.closeDialog(d),y=Date.now())}var d="KindleReaderContextMenu",
c="kindle_menu_button",b="button_enabled",f={};f[KindlePopupMenu.ITEM_ENABLED]=b;f[KindlePopupMenu.ITEM_DISABLED]="button_disabled";f[KindlePopupMenu.ITEM_HIDDEN]="button_hidden";var a=["k_R_context_createHighlight","k_R_context_deleteHighlight","k_R_context_createNote","k_R_context_editNote"],g=0,k=g++,m=g++,l=g++,n=g++,r=g++,o,q,t,s,u,y,v,x={onInitializationDone:function(d){function g(d){var f=ResourceBundle.getLocalizedString(a[d]),h=$("<div></div>").addClass(c).addClass(b).text(f);h.tap(function(){h.hasClass(b)&&
(e(),v.hideDictionaryListMenu&&v.hideDictionaryListMenu(),t[d]())});return h}d=d.find("#kindle_menu_border");d.append(g(0));for(var f=1;f<a.length;f++)d.append('<div class="kindle_menu_separator"></div>'),d.append(g(f));v.initialize()},beforeDialogOpen:function(a){var b=a.find("#kindle_menu_border"),d,g,h;b.find("."+c).each(function(a){var b=$(this);b.removeClass().addClass(c);b.addClass(f[o[a]])});b.children().each(function(){var a=$(this);a.hasClass(c)?a.hasClass("button_hidden")||(d||(d=a),g=a,
h=null):a.hasClass("kindle_menu_separator")&&(!d||h?a.hide():(h=a,a.css("display","")))});d.addClass("ui-corner-left");g.addClass("ui-corner-right");h&&h.hide();o[r]===KindlePopupMenu.ITEM_ENABLED&&$(window).width()!==320&&(v.updateMenuWithDefinition(a,s,{language:u}),q[0]-=180);KindleHostDeviceDetector.isIE()||j(a);$(window).bind("resize",e)},getDialogSettings:function(){return{autoOpen:!1,draggable:!1,modal:!0,resizable:!1,minHeight:0,width:"auto",dialogClass:"kindle_menu",k4w_transparent_modal_overlay:!0}},
onDialogClose:function(){v.removeDefinition();$(window).unbind("resize",e)},onDialogOpen:function(a){var b=o[r]===KindlePopupMenu.ITEM_ENABLED,c=KindleHostDeviceDetector.isiOS()||KindleHostDeviceDetector.isMetro()||KindleHostDeviceDetector.isIE()?60:30,d=a.parent();KindleHostDeviceDetector.isIE()&&j(a);if(b&&q[1]>320||!b&&$(window).height()-q[1]<100)d.css("top","auto"),d.css("bottom",$(window).height()-q[1]+c);q[0]+380>$(window).width()&&d.css("left",$(window).width()-380-25);a.css("height","auto")}};
return{CREATE_HIGHLIGHT:k,CREATE_NOTE:l,EDIT_NOTE:n,DELETE_HIGHLIGHT:m,DEFINITION:r,show:function(a,b,c,g,f){o=a;q=b;t=c;s=g;u=f;h().then(function(){KindleUXComponentManager.openDialog(d,x);$(".ui-widget-overlay").hide()})},hide:e,wasVisible:function(){return Date.now()-y<500}}}(),KindleReaderContextMenuDictionary=function(){function h(a,g,k){function m(a,g){a.lookup(g).then(function(a){b=a;var g={results:a.definitions,dictionaryUsed:a.dictionaryName,dictionaryAsin:a.asin,view_full:ResourceBundle.getLocalizedString("k_R_dictionary_view_full"),
isForContextMenu:!0};c.renderDefinition(g);d.emit("Reader::KiDS::WordFound");d.emit("Reader::KiDS::WordFound::"+a.dictionaryLanguage)},j)}g.start===g.end&&(d=e.createTimer(),$.when(KindleReaderAnnotationManager.getContext(g.start,g.end),dictionary.getDictionary()).done(function(d,j){if(d){f=f||j.getDictionaryList();c=new KindleReaderDictionaryViewer(a,{onDictChanged:function(b){KindleDebug.log("New search requested for this dictionary:"+b);KindleLocalStorage.setItem(Kindle.App.USER_DICT_ASIN,b);h(a,
g,{dictionary:b});e.emit("Reader::DictionaryChanged::ShortDef")},viewFullLink:function(a){c.hideDictionaryListMenu();KindleReaderFullDefinition.open(b,d,a,f);KindleReaderContextMenu.hide();e.emit("Reader::KiDS::ViewFull")}},f);c.showLoading();var r={word:d},o=KindleLocalStorage.getItem(Kindle.App.USER_DICT_ASIN);if(o)r.dictionary=o;else if(k.dictionary)r.dictionary=k.dictionary;else if(k.language)r.language=k.language;m(j,r)}else c.removeDefinition()}))}function j(a,b){switch(a){case IDictionary.NOT_FOUND:d.emit("Reader::KiDS::WordNotFound");
d.emit("Reader::KiDS::WordNotFound::"+b.dictionaryLanguage);break;case IDictionary.OFFLINE:d.emit("Reader::KiDS::Offline");d.emit("Reader::KiDS::Offline::"+b.dictionaryLanguage);break;case IDictionary.LOOKUP_FAILED:d.emit("Reader::KiDS::LookupFailed");d.emit("Reader::KiDS::LookupFailed::"+b.dictionaryLanguage);break;default:d.emit("Reader::KiDS::LookupFailed"),d.emit("Reader::KiDS::LookupFailed::"+b.dictionaryLanguage)}c.showError(a,b.dictionaryName)}var e,d,c,b,f;return{initialize:function(){e=KindleModuleManager.getModuleSync([KindleModuleManager.METRICS_MANAGER])},
updateMenuWithDefinition:h,hideDictionaryListMenu:function(){c&&c.hideDictionaryListMenu()},removeDefinition:function(){return c&&c.removeDefinition()}}}(),KindleReaderContextMenuDictionaryDotCom=function(){function h(a){if(a.getPronunciationUrls()){var b,c;r===void 0&&(r=document.createElement("audio").canPlayType("audio/mpeg")!=="");c=r?a.getPronunciationUrls().mp3:a.getPronunciationUrls().wav;m.find("#dictionary_audio").tap(function(){b=b||new Audio(c);KindleHostDeviceDetector.isSafari()&&!KindleHostDeviceDetector.isiPad()&&
b.load();b.play();l.emit("Reader::Dictionary::SoundPlayed")});m.find(".view_full_link").click(function(){l.emit("Reader::Dictionary::ViewFull")})}}function j(d){if(!m.is(":hidden")){var g=d.getPronunciationUrls();c();m.addClass("dictionary_enabled");m.prepend(KindleUXComponentManager.renderTemplate(a,{entry:d.entry,pronunciation:f(d),audio_url_mp3:g?d.getPronunciationUrls().mp3:"",audio_url_wav:g?d.getPronunciationUrls().wav:"",definition:b(d),view_full:ResourceBundle.getLocalizedString("k_R_dictionary_view_full"),
view_full_url:"http://app.dictionary.com/click/3mlh2s?clkdest=http://dictionary.reference.com/browse/"+d.entry+"%3Fsplash=no"}));g||m.find("#dictionary_audio").hide();setTimeout(function(){m.find(".dictionary").addClass("expanded")},50)}}function e(){var a=m.find(".dictionary_loading");a.show();m.addClass("dictionary_enabled");var b=Handlebars.templates.KindleSimpleSpinner({});a.append(b)}function d(a){var b="";c();m.addClass("dictionary_enabled");switch(a){case IDictionary.NOT_FOUND:b=ResourceBundle.getLocalizedString("k_R_dictionary_not_found");
n.emit("Reader::Dictionary::WordNotFound");break;case IDictionary.OFFLINE:b=ResourceBundle.getLocalizedString("k_R_dictionary_offline");n.emit("Reader::Dictionary::Offline");break;case IDictionary.LOOKUP_FAILED:b=ResourceBundle.getLocalizedString("k_R_dictionary_not_available");n.emit("Reader::Dictionary::LookupFailed");break;default:b=ResourceBundle.getLocalizedString("k_R_dictionary_not_available"),n.emit("Reader::Dictionary::LookupFailed")}m.prepend(k.replace("{{error}}",b))}function c(){m&&m.hasClass("dictionary_enabled")&&
(m.find(".dictionary").remove(),m.find(".dictionary_loading").empty().hide(),m.find(".dictionary_error").remove(),m.removeClass("dictionary_enabled"))}function b(a,b){for(var c=0,d=[],f=a.getDefinitions(),b=b||g,e=0;e<f.length&&c<=b;e++){var h=f[e].definitions;f[e].partOfSpeech&&d.push('<span class="word_type">'+f[e].partOfSpeech+"</span>");d.push('<ol class="definitions_list">');for(var k=0;k<h.length&&c<=b;k++)d.push("<li>"+h[k]+"</li>"),c++;d.push("</ol>")}return d.join("").replace(/(<[\/]?a[^>]*>)/ig,
"")}function f(a){return(a=a.getPronunciation())?"["+a+"]":""}var a="KindleReaderContextMenuDictionaryDotCom",g=5,k='<div class="dictionary_error">{{error}}</div>',m,l,n,r;return{updateMenuWithDefinition:function(a,b){n=l.createTimer();m=a;b.start===b.end&&(e(),m.addClass("dictionary_enabled"),$.when(KindleReaderAnnotationManager.getContext(b.start,b.end),dictionary.getDictionary()).done(function(a,b){a?b.lookup(a).then(function(a){j(a);h(a);n.emit("Reader::Dictionary::WordFound")},d):c()}))},removeDefinition:c,
initialize:function(){KindleUXComponentManager.hasTemplate(a)||KindleUXComponentManager.initializeTemplate(a,function(){});l=KindleModuleManager.getModuleSync([KindleModuleManager.METRICS_MANAGER])}}}(),KindleReaderEditNoteDialog=function(){function h(){return k.find("#kindleReader_dialog_editNote_title")}function j(){return k.find("#kindleReader_dialog_editNote_noteText")}function e(a){return k.dialog("widget").find('.ui-button:contains("'+a+'")')}function d(){q=!0;a();l&&l(m)}function c(){q=!0;
a();n&&n()}function b(){q=!0;a();r&&r()}function f(){function a(){d&&(d=!1,b.val("").removeClass("hint"))}var b=j(),c=b.attr("placeholder");b.val(m);var d=!0;if(!m&&KindleHostDeviceDetector.isMetro())b.val(c).addClass("hint").on("click",a).on("keypress",a);KindleHostDeviceDetector.isMSEdge()&&(b.removeAttr("placeholder"),b.attr("placeholder",c));c=e(ResourceBundle.getLocalizedString("k_R_dialog_editNote_delete"));n?(h().text(ResourceBundle.getLocalizedString("k_R_dialog_editNote_title_edit")),c.show()):
(h().text(ResourceBundle.getLocalizedString("k_R_dialog_editNote_title_create")),c.hide());KindleHostDeviceDetector.isiOS()&&j().attr("tabindex","-1");k.find("#kindleReader_dialog_editNote_noteText").off("keydown",t);k.find("#kindleReader_dialog_editNote_noteText").on("keydown",t)}function a(){KindleUXComponentManager.closeDialog(g)}var g="KindleReaderEditNoteDialog",k,m,l,n,r,o,q=!1,t=function(a){a.which===27&&b()},s={getDialogSettings:function(){var a={};a[ResourceBundle.getLocalizedString("k_R_dialog_editNote_cancel")]=
b;a[ResourceBundle.getLocalizedString("k_R_dialog_editNote_delete")]=c;a[ResourceBundle.getLocalizedString("k_R_dialog_editNote_save")]=d;o=KindleHostDeviceDetector.isiOS()?"70%":"40%";return{width:o,autoOpen:!1,buttons:a,draggable:!1,modal:!0,resizable:!1,k4w_transparent_modal_overlay:!0}},beforeDialogOpen:f,onDialogOpen:function(){KindleHostDeviceDetector.isiOS()||(KindleHostDeviceDetector.isMetro()||KindleHostDeviceDetector.isIE()?(k.focus(),setTimeout(function(){var a=document.getElementById("kindleReader_dialog_editNote_noteText");
a.focus();if(m){var b=document.createRange();b.selectNodeContents(a);b.collapse(!1);a=window.getSelection();a.removeAllRanges();a.addRange(b)}},0)):j().focus())},onDialogClose:function(){!q&&r&&r();m=$.trim(j().val());if(KindleHostDeviceDetector.isMetro()){var a=j().parent(),b=a.html();j().detach();a.html(b)}},onInitializationDone:function(a){k=a;KindleTouchEventsToggler.isRequired()&&(j().focus(function(){KindleTouchEventsToggler.off()}),j().blur(function(){KindleTouchEventsToggler.on()}));f()}};
return{open:function(a,b,c,d){m=a||"";l=b;n=c;r=d;q=!1;KindleUXComponentManager.openDialog(g,s,{maxNoteChars:Kindle.opt.maxNoteChars})},close:a,isVisible:function(){return KindleUXComponentManager.isVisible(g)}}}(),KindleReaderGoToDialog=function(){function h(a){var b;/(^[0]*\d*$)/.exec(a)&&(b=parseInt(a,10));isNaN(b)&&(b=void 0);return b}var j=KindleHostDeviceDetector.isMetro()?"Metro/KindleReaderGoToDialog":"KindleReaderGoToDialog",e={DIALOG_TITLE_ID:"k_R_goto_menu_goto_location_title",DIALOG_TITLE_ID_METRO:"k_R_goto_menu_goto_location_metro_title",
DIALOG_TEXT_ID:"k_R_goto_menu_goto_message",DIALOG_LOCATION_TEXT_ID:"k_R_goto_menu_goto_location",DIALOG_OK_BTN_ID:"k_R_goto_menu_goto_button",DIALOG_CANCEL_BTN_ID:"k_common_cancel_button",DIALOG_LOCATION_RANGE:"k_R_goto_dialog_location_range",DIALOG_LOCATION_ERROR:"k_R_goto_dialog_error",DIALOG_LOCATION_ERROR_SNAPVIEW:"k_R_goto_dialog_error_snapview"},d={DIALOG_DIV_ID:"kindleReader_dialog_goto",TITLE_LABEL_ID:"kindleReader_dialog_gotoTitle",TEXT_LABEL_ID:"kindleReader_dialog_gotoLabel",LOCATION_LABEL_ID:"kindleReader_dialog_gotoLocation",
INPUT_FIELD_ID:"kindleReader_dialog_gotoField",OK_BUTTON_ID:"kindleReader_dialog_gotoGoButton",ERROR_DIV_ID:"kindleReader_dialog_gotoError",ERROR_TEXT_ID:"kindleReader_dialog_gotoErrorText",GOTO_BUTTON_ID:"kindle_reader_goto_location_button",CANCEL_BUTTON_ID:"kindle_reader_cancel_goto_location_button",LOCATION_HINT_ID:"kindleReader_dialog_gotoLocationHint"},c=[8,9,13,27,37,39,46],b="hint",f,a,g,k,m,l=function(){var b=m.find("#"+d.INPUT_FIELD_ID),c=h(b.val());if(c===void 0||c<a.minLocation||c>a.maxLocation)if(KindleHostDeviceDetector.isMetro())document.getElementById(d.ERROR_TEXT_ID).innerText=
KindleHostDeviceDetector.isMetroSnappedView()?ResourceBundle.getLocalizedString(e.DIALOG_LOCATION_ERROR_SNAPVIEW):ResourceBundle.getLocalizedString(e.DIALOG_LOCATION_ERROR,{minLocation:a.minLocation,maxLocation:a.maxLocation}),document.getElementById(d.ERROR_DIV_ID).style.display="block",b.focus();else{var f=m.find("#"+d.INPUT_FIELD_ID);f.addClass("invalid_input");f.val("");KindleHostDeviceDetector.isiOS()||b.focus();setTimeout(function(){f.removeClass("invalid_input")},2E3)}else g=!0,k=c,KindleUXComponentManager.closeDialog(j)},
n=function(){KindleUXComponentManager.closeDialog(j)},r=function(b){if(b.which===27)n();else if(KindleHostDeviceDetector.isMetro()&&t(b)&&(b=h(document.getElementById(d.INPUT_FIELD_ID).value))&&b>=a.minLocation&&b<=a.maxLocation)document.getElementById(d.ERROR_DIV_ID).style.display="none"},o=function(a){t(a)?a.which===13&&(m.focus(),$("#"+d.INPUT_FIELD_ID).blur(),l(),a.preventDefault()):a.preventDefault()},q=function(){document.getElementById(d.DIALOG_DIV_ID).style.left=KindleHostDeviceDetector.isMetroSnappedView()?
"7px":window.outerHeight>window.outerWidth?((window.outerWidth-267)/2).toString()+"px":((window.outerWidth-530)/2).toString()+"px";document.getElementById(d.ERROR_DIV_ID).style.display="none"},t=function(a){return c.indexOf(a.keyCode)>=0||a.keyCode>=48&&a.keyCode<=57||a.keyCode>=96&&a.keyCode<=105},s={onInitializationDone:function(a){m=a;KindleTouchEventsToggler.isRequired()&&(m.find("#"+d.INPUT_FIELD_ID).focus(function(){KindleTouchEventsToggler.off()}),m.find("#"+d.INPUT_FIELD_ID).blur(function(){KindleTouchEventsToggler.on()}))},
getDialogSettings:function(){var a=null,b,c,d={autoOpen:!1,modal:!0,draggable:!1,resizable:!1,k4w_transparent_modal_overlay:!0};if(!KindleHostDeviceDetector.isMetro())KindleHostDeviceDetector.isiPad()?(b=375,c=210):(b=325,c=155),a={},a[ResourceBundle.getLocalizedString(e.DIALOG_CANCEL_BTN_ID)]=n,a[ResourceBundle.getLocalizedString(e.DIALOG_OK_BTN_ID)]=l,d.width=b,d.height=c;d.buttons=a;return d},beforeDialogOpen:function(){function c(){f||(f=!0,h.val(""),h.removeClass(b))}var g,f=!1,h=m.find("#"+
d.INPUT_FIELD_ID);KindleHostDeviceDetector.isMetro()?(g=ResourceBundle.getLocalizedString(e.DIALOG_LOCATION_RANGE,{minLocation:a.minLocation,maxLocation:a.maxLocation}),h.attr("placeholder",g),h.attr("size",15),h.attr("maxlength",15),h.addClass(b),h.val(g),h.on("click",c).on("keypress",c)):(g=ResourceBundle.getLocalizedString(e.DIALOG_TITLE_ID),m.find("#"+d.TITLE_LABEL_ID).empty().append(g),g=ResourceBundle.getLocalizedString(e.DIALOG_TEXT_ID),m.find("#"+d.TEXT_LABEL_ID).empty().append(g),g=ResourceBundle.getLocalizedString(e.DIALOG_LOCATION_TEXT_ID,
{lastLocation:a.maxLocation}),m.find("#"+d.LOCATION_LABEL_ID).empty().append(g),h.val(""));h.bind("keyup",r);KindleHostDeviceDetector.isiOS()&&h.attr("tabindex","-1")},onDialogOpen:function(){KindleHostDeviceDetector.isiOS()||m.find("#"+d.INPUT_FIELD_ID).focus();if(KindleHostDeviceDetector.isMetro())document.getElementById(d.DIALOG_DIV_ID).style.left=KindleHostDeviceDetector.isMetroSnappedView()?"7px":window.outerHeight>window.outerWidth?(window.outerWidth-267)/2+"px":(window.outerWidth-530)/2+"px",
document.getElementById(d.GOTO_BUTTON_ID).addEventListener("click",l,!1),document.getElementById(d.CANCEL_BUTTON_ID).addEventListener("click",n,!1),document.getElementById(d.ERROR_DIV_ID).style.display="none",window.addEventListener("resize",q,!1);if(KindleHostDeviceDetector.isMetro()||KindleHostDeviceDetector.isIE())m.focus(),setTimeout(function(){m.find("#"+d.INPUT_FIELD_ID).focus()},0);document.getElementById(d.INPUT_FIELD_ID).addEventListener("keydown",o,!1)},onDialogClose:function(){var a=m.find("#"+
d.INPUT_FIELD_ID);a.blur();a.unbind("keyup",r);f(g,k);if(KindleHostDeviceDetector.isMetro()){var b=a.parent(),c=b.html();a.detach();b.html(c);document.getElementById(d.GOTO_BUTTON_ID).removeEventListener("click",l,!1);document.getElementById(d.CANCEL_BUTTON_ID).removeEventListener("click",n,!1);window.removeEventListener("resize",q,!1)}document.getElementById(d.INPUT_FIELD_ID).removeEventListener("keydown",o,!1)}};return{open:function(b,c){f=c;a=b;g=!1;k=-1;KindleUXComponentManager.openDialog(j,s)},
parseLocationString:h}}(),KindleReaderGoToPageDialog=function(){function h(a){var b,c;/(^[0]*\d*$)/.exec(a)?(g.range.arabic&&(c=parseInt(a,10),c>=g.range.arabic.minPage&&c<=g.range.arabic.maxPage&&(b=a)),g.range.custom&&(c=parseInt(a,10),c>=g.range.custom.minPage&&c<=g.range.custom.maxPage&&(b=a))):PageNumberUtilities.isValidRomanNumeral(a)&&g.range.roman&&(c=PageNumberUtilities.parseRomanNumeral(a),c>=g.range.roman.minPage&&c<=g.range.roman.maxPage&&(b=a));return b}function j(){var a="",b,c,d;for(d in g.range)if(d===
"roman")b=PageNumberUtilities.toRomanNumeral(g.range[d].minPage),c=PageNumberUtilities.toRomanNumeral(g.range[d].maxPage),a+="("+b+" - "+c+")";else if(d==="arabic")b=g.range[d].minPage,c=g.range[d].maxPage,a+="("+b+" - "+c+")";return a}var e=KindleHostDeviceDetector.isMetro()?"Metro/KindleReaderGoToPageDialog":"KindleReaderGoToPageDialog",d={DialogTitle:"k_R_goto_menu_goto_page_title",DialogTitleMetro:"k_R_goto_menu_goto_page_title_metro",DialogText:"k_R_goto_menu_goto_page_message",DialogPageText:"k_R_goto_menu_goto_page",
DialogOkBtn:"k_R_goto_menu_goto_page_button",DialogCancelBtn:"k_common_cancel_button",DialogPageRange:"k_R_goto_dialog_page_range",DialogPageError:"k_R_goto_page_dialog_error",DialogPageErrorSnapview:"k_R_goto_page_dialog_error_snapview"},c={DialogDiv:"kindleReader_dialog_goto_page",TitleLabel:"kindleReader_dialog_gotoPageTitle",TextLabel:"kindleReader_dialog_gotoPageLabel",PageLabel:"kindleReader_dialog_gotoPage",InputField:"kindleReader_dialog_gotoPageField",OkButton:"kindleReader_dialog_gotoGoButton",
ErrorDiv:"kindleReader_dialog_gotoPageError",ErrorText:"kindleReader_dialog_gotoPageErrorText",GotoButton:"kindle_reader_goto_page_button",CancelButton:"kindle_reader_cancel_goto_page_button",PageHint:"kindleReader_dialog_gotoPageHint"},b=[8,9,13,27,37,39,46,67,68,73,76,77,86,88,99,100,105,108,109,118,120],f="hint",a,g,k,m,l,n=function(){var a=l.find("#"+c.InputField),b=h(a.val());if(b)k=!0,m=b,KindleUXComponentManager.closeDialog(e);else if(KindleHostDeviceDetector.isMetro()){b=document.getElementById(c.ErrorText);
if(KindleHostDeviceDetector.isMetroSnappedView())b.innerText=ResourceBundle.getLocalizedString(d.DialogPageErrorSnapview);else{var g=j();b.innerText=ResourceBundle.getLocalizedString(d.DialogPageError,{range:g})}document.getElementById(c.ErrorDiv).style.display="block";a.focus()}else{var f=l.find("#"+c.InputField);f.addClass("invalid_input");f.val("");KindleHostDeviceDetector.isiOS()||a.focus();setTimeout(function(){f.removeClass("invalid_input")},2E3)}},r=function(){KindleUXComponentManager.closeDialog(e)},
o=function(a){if(a.which===27)r();else if(KindleHostDeviceDetector.isMetro()&&s(a)&&h(document.getElementById(c.InputField).value))document.getElementById(c.ErrorDiv).style.display="none"},q=function(a){s(a)?a.which===13&&(l.focus(),$("#"+c.InputField).blur(),n(),a.preventDefault()):a.preventDefault()},t=function(){document.getElementById(c.DialogDiv).style.left=KindleHostDeviceDetector.isMetroSnappedView()?"7px":window.outerHeight>window.outerWidth?((window.outerWidth-267)/2).toString()+"px":((window.outerWidth-
530)/2).toString()+"px";document.getElementById(c.ErrorDiv).style.display="none"},s=function(a){return b.indexOf(a.keyCode)>=0||a.keyCode>=48&&a.keyCode<=57||a.keyCode>=96&&a.keyCode<=105},u={onInitializationDone:function(a){l=a;KindleTouchEventsToggler.isRequired()&&(a=l.find("#"+c.InputField),a.focus(function(){KindleTouchEventsToggler.off()}),a.blur(function(){KindleTouchEventsToggler.on()}))},getDialogSettings:function(){var a=null,b,c,g={autoOpen:!1,modal:!0,draggable:!1,resizable:!1,k4w_transparent_modal_overlay:!0};
if(!KindleHostDeviceDetector.isMetro())KindleHostDeviceDetector.isiPad()?(b=375,c=210):(b=325,c=155),a={},a[ResourceBundle.getLocalizedString(d.DialogCancelBtn)]=r,a[ResourceBundle.getLocalizedString(d.DialogOkBtn)]=n,g.width=b,g.height=c;g.buttons=a;return g},beforeDialogOpen:function(a){function b(){h||(h=!0,k.val(""),k.removeClass(f))}var e,h=!1,k=a.find("#"+c.InputField);KindleHostDeviceDetector.isMetro()?(a=j(),k.attr("placeholder",a),k.attr("size",15),k.attr("maxlength",15),k.addClass(f),k.val(a),
k.on("click",b).on("keypress",b)):(e=ResourceBundle.getLocalizedString(d.DialogTitle),a.find("#"+c.TitleLabel).empty().append(e),e=ResourceBundle.getLocalizedString(d.DialogText),a.find("#"+c.TextLabel).empty().append(e),e=ResourceBundle.getLocalizedString(d.DialogPageText,{lastPage:g.maxPage}),a.find("#"+c.PageLabel).empty().append(e),k.val(""));k.bind("keyup",o);KindleHostDeviceDetector.isiOS()&&k.attr("tabindex","-1")},onDialogOpen:function(){KindleHostDeviceDetector.isiOS()||l.find("#"+c.InputField).focus();
if(KindleHostDeviceDetector.isMetro())document.getElementById(c.DialogDiv).style.left=KindleHostDeviceDetector.isMetroSnappedView()?"7px":window.outerHeight>window.outerWidth?(window.outerWidth-267)/2+"px":(window.outerWidth-530)/2+"px",document.getElementById(c.GotoButton).addEventListener("click",n,!1),document.getElementById(c.CancelButton).addEventListener("click",r,!1),document.getElementById(c.ErrorDiv).style.display="none",window.addEventListener("resize",t,!1);if(KindleHostDeviceDetector.isMetro()||
KindleHostDeviceDetector.isIE())l.focus(),setTimeout(function(){l.find("#"+c.InputField).focus()},0);document.getElementById(c.InputField).addEventListener("keydown",q,!1)},onDialogClose:function(b){b=b.find("#"+c.InputField);b.blur();b.unbind("keyup",o);a(k,m);if(KindleHostDeviceDetector.isMetro()){var d=b.parent(),g=d.html();b.detach();d.html(g);document.getElementById(c.GotoButton).removeEventListener("click",n,!1);document.getElementById(c.CancelButton).removeEventListener("click",r,!1);window.removeEventListener("resize",
t,!1)}document.getElementById(c.InputField).removeEventListener("keydown",q,!1)}};return{open:function(b,c){a=c;g=b;k=!1;m=-1;KindleUXComponentManager.openDialog(e,u)}}}(),KindleReaderGoToMenu=function(){function h(){return KindleHostDeviceDetector.isMetroSnappedView()?g:a}function j(a,b){a&&q.gotoUserLocation(b)}function e(a,b){a&&q.gotoPage(b)}function d(){var a={},b=0;(KindleHostDeviceDetector.isMetro()?KindleHostDeviceDetector.isMetroSnappedView()?[k.cover,k.beginning,k.page,k.location,k.toc]:
[k.cover,k.beginning,k.page,k.location,k.bookmark,k.toc]:[k.cover,k.toc,k.beginning,k.page,k.location]).forEach(function(c){var d=c.name,g=ResourceBundle.getLocalizedString(c.resource);a[d]={elementId:c.id,content:g,clickHandler:c.handler};l[c.name]=b++});return a}function c(){return KindleHostDeviceDetector.isMetroSnappedView()?(r||(r=d()),r):(n||(n=d()),n)}function b(a){function b(a,c){a!==void 0&&(s[a]=c)}var d=KindlePopupMenu.ITEM_ENABLED,g=KindlePopupMenu.ITEM_DISABLED;c();s=[];b(l.cover,d);
b(l.beginning,g);b(l.location,d);b(l.toc,g);b(l.page,g);b(l.bookmarks,g);o.cover=0;if(a!==void 0){if(a.cover!==void 0&&a.cover>=0)o.cover=a.cover;if(a.toc!==void 0&&a.toc>=0)o.toc=a.toc,b(l.toc,d);o.srp=a.srl!==void 0&&a.srl>=0?a.srl:o.cover;b(l.beginning,d)}KindleUXComponentManager.updateMenu(h(),s)}function f(){KindleUXComponentManager.hideMenu(h())}var a="KindleReaderGotoMenu",g="KindleReaderGotoMenuSnappedView",k={cover:{id:"kindleReader_goToMenuItem_goToCover",resource:"k_R_cover_title",handler:function(){q.gotoPosition(o.cover);
f();t.emit("Reader::GoToMenu::Cover")}},toc:{id:"kindleReader_goToMenuItem_goToTOC",resource:"k_R_table_of_contents_title",handler:function(){q.gotoPosition(o.toc);f();t.emit("Reader::GoToMenu::TableOfContents")}},beginning:{id:"kindleReader_goToMenuItem_goToBeginning",resource:"k_R_beginning_title",handler:function(){q.gotoPosition(o.srp);f();t.emit("Reader::GoToMenu::StartReadingPosition")}},page:{id:"kindleReader_goToMenuItem_goToPage",resource:"k_R_goto_page_title",handler:function(){f();var a=
{range:q.getPageNumberRanges(),maxPage:q.getMaxPage()};KindleReaderGoToPageDialog.open(a,e);t.emit("Reader::GoToMenu::Page")}},location:{id:"kindleReader_goToMenuItem_goToLocation",resource:"k_R_goto_location_title",handler:function(){f();var a={minLocation:1,maxLocation:q.getMaxUserLocation()};KindleReaderGoToDialog.open(a,j);t.emit("Reader::GoToMenu::Location")}},bookmark:{id:"kindleReader_goToMenuItem_goToBookmark",resource:"k_R_goto_bookmark_title",handler:function(){q.openBookmarks();f();t.emit("Reader::GoToMenu::Bookmarks")}}},
m={};Object.keys(k).forEach(function(a){m[a]=k[a].name=a});var l={},n,r,o={},q,t,s;return{MenuItemNames:m,show:function(){if(s){var a="down",b="kindleReader_button_goto",d=!1;if(KindleHostDeviceDetector.isMetro()){var b=null,d=!0,g=KindlePopupMenu.MENU_POSITION_CONSTANTS.APPBAR_MENU_MARGIN_PX,f,e=document.getElementById("kindleReader_footer");KindleHostDeviceDetector.isMetroSnappedView()?(a=g,f=273):(a=e.clientWidth-342-g,f=314);a=[a,e.offsetTop-f-g]}b={componentName:h(),menuItems:c(),buttonID:b,
position:a,title:ResourceBundle.getLocalizedString("k_R_goto_menu_title"),isAppBarMenu:d,enabledFlags:s};KindleUXComponentManager.showMenu(b)}},hide:f,onResize:function(){KindleHostDeviceDetector.isMetro()&&(KindleUXComponentManager.hideMenu(a),KindleUXComponentManager.hideMenu(g))},bookIsReady:function(a,c,d){q=a;t=d;c.getBookPositions().done(b)},disable:function(){s=void 0},updateGoToMenu:function(a){var b,c;if(s){for(b in a)c=l[b],c!==void 0&&(s[c]=a[b]);KindleUXComponentManager.updateMenu(h(),
s)}},extractPositionsFromMetadata:b,interestingPositions:o}}(),KindleReaderHeaderBar=function(){function h(f){c=f;b&&c.find("#"+e.BUTTON_CLOSE).html(b);d(f)}var j,e={BUTTON_CLOSE:"kindleReader_button_close"},d,c,b;return{initialize:function(b,a){j=a?"Embedded/KindleReaderHeaderBar":KindleHostDeviceDetector.isMetro()?"Metro/KindleMetroReaderHeaderBar":"KindleReaderHeaderBar";d=b;KindleUXComponentManager.initializeComponent(j,h)},setCloseButtonText:function(d){c?c.find("#"+e.BUTTON_CLOSE).html(d).attr("title",
d):b=d}}}(),KindleMetroReaderAppBarOverlay=function(){function h(){$("#"+j).remove();d();return!1}var j="appBarOverlay",e=null,d=null;return{show:function(c){e||(d=c,e=$("<div id='"+j+"'></div>"),e.appendTo($("#kindleReader_book_container")).on("mousedown",h).tap(h),KindleHostDeviceDetector.isiOS()&&(e.swipeLeft(h),e.swipeRight(h)))},remove:function(){e&&(e.remove(),e=null)}}}(),KindleMetroReaderButtonOverlay=function(){function h(c){e=c;j(c)}var j,e,d;return{initialize:function(c){j=c;KindleUXComponentManager.initializeComponent("Metro/KindleMetroReaderButtonOverlay",
h)},refreshBookmarkImage:function(c){e.find("#reader_button_overlay_bookmark").toggleClass("bookmarked",c)},setVisibleBookmark:function(c){e.find("#reader_button_overlay_bookmark").css("visibility",c?"visible":"hidden")},setColor:function(c){d=c;if(e)switch(d){case KINDLE_READER_SETTINGS_COLOR_MODE.WHITE:e.removeClass("black").removeClass("sepia");break;case KINDLE_READER_SETTINGS_COLOR_MODE.BLACK:e.removeClass("sepia").addClass("black");break;case KINDLE_READER_SETTINGS_COLOR_MODE.SEPIA:e.removeClass("black").addClass("sepia")}}}}(),
KindleMetroReaderViewSettings=function(){function h(){function a(){C&&clearTimeout(C);C=setTimeout(function(){$(z.FONT_SIZE_TOOLTIP).fadeOut()},1200);var b=B[this.value];v.setFontSize(b);j(b);o()}e();$(u.find(z.FONT_SIZE)).on("change",a).on("keydown",function(a){a.shiftKey&&a.keyCode===9?(a.stopPropagation(),$(".ui-dialog").find(":tabbable").last().focus(1)):a.keyCode===27&&t()}).on("MSPointerDown",a)}function j(a){var b=$(z.FONT_SIZE_TOOLTIP);b.css("font-size",a);b.show();var a=$(z.FONT_SIZE),c=
a.val()/(a.prop("max")-a.prop("min")),a=c===0?"0px":c===1?a.width()-b.outerWidth():a.width()*c-b.outerWidth()/2;b.css("left",a)}function e(){var a=$(u.find(z.FONT_SIZE)),b=B.indexOf(v.getFontSize());a.val(b)}function d(){b();var a=$(u.find(z.MARGIN));a.on("change",function(){var b=a.val();v.setMargin(w[b]);var b=E[b],c=$(".margin_preview_overlay");c.length===0?($(document.body).append('<div id="margin_preview_left" class="margin_preview_overlay"/><div id="margin_preview_right" class="margin_preview_overlay"/>'),
$(".margin_preview_overlay").css("width",b+"%").show()):c.css("width",b+"%").show();o()}).on("keydown",function(a){a.keyCode===27&&t()})}function c(){$(".margin_preview_overlay").hide()}function b(){var a=$(u.find(z.MARGIN)),b=w.indexOf(v.getMargin());a.val(b)}function f(){function b(a,d){var g=v.getColorMode().persistedValue;a!==g&&(c.eq(g).removeClass("selected"),$(d).addClass("selected"),v.setColorMode(K[a]),o())}a();var c=$(u.find(z.COLOR_MODE)).children(),d=c.length,g;c.each(function(a,f){$(f).tap(function(){b(a,
f)}).bind("keydown",function(e){e.keyCode===13||e.keyCode===32?b(a,f):e.keyCode===27?t():a===d-1&&!e.shiftKey&&e.keyCode===9?(e.stopPropagation(),e=$(".ui-dialog").find(":tabbable"),$(f).get(0)===e.last().get(0)&&e.first().focus(1)):e.keyCode===37?a!==0&&(g=c.get(a-1),b(a-1,g),g.focus(1)):e.keyCode===39&&a!==d-1&&(g=c.get(a+1),b(a+1,g),g.focus(1))})})}function a(){var a=$(u.find(z.COLOR_MODE)).children(),b=v.getColorMode().persistedValue;a.each(function(a,c){a===b?$(c).addClass("selected"):$(c).removeClass("selected")})}
function g(){function a(){var b=!d.attr("checked");v.setShowColumns(b.toString());b=b?I.ONE_COLUMN_OFF:I.ONE_COLUMN_ON;$(z.COLUMN_MODE_LABEL).text(ResourceBundle.getLocalizedString(b));o()}function b(c){switch(c.keyCode){case 37:d.attr("checked",!1);a();break;case 39:d.attr("checked",!0);a();break;case 32:d.attr("checked",!d.is(":checked"));a();break;case 9:var f=$(".ui-dialog").find(":tabbable");!c.shiftKey&&$(g).get(0)===f.last().get(0)&&(c.stopPropagation(),f.first().focus(1));break;case 27:t()}}
var c=$(u.find(z.COLUMN_MODE)),d=$(u.find(z.COLUMN_MODE_TOGGLE)),g=$(u.find(z.COLUMN_MODE_TOGGLE_LABEL)),f=$(u.find(z.COLUMN_MODE_MSG));y.columns&&y.columns!==1?(k(),g.on("keydown",b),d.on("change",a),c.show(),f.hide()):(c.hide(),f.show())}function k(){var a=$(u.find(z.COLUMN_MODE_TOGGLE));v.getShowColumns()==="false"?(a.attr("checked",!0),$(u.find(z.COLUMN_MODE_LABEL)).text(ResourceBundle.getLocalizedString(I.ONE_COLUMN_ON))):(a.removeAttr("checked"),$(u.find(z.COLUMN_MODE_LABEL)).text(ResourceBundle.getLocalizedString(I.ONE_COLUMN_OFF)))}
function m(){function a(){var c=b.prop("checked");v.setShowLocations(c.toString());c=c?I.ONE_COLUMN_ON:I.ONE_COLUMN_OFF;$(z.SHOW_LOCATION_MODE_LABEL).text(ResourceBundle.getLocalizedString(c));o()}$(u.find(z.SHOW_LOCATION_MODE));var b=$(u.find(z.SHOW_LOCATION_MODE_TOGGLE)),c=$(u.find(z.SHOW_LOCATION_MODE_TOGGLE_LABEL));l();c.on("keydown",function(d){switch(d.keyCode){case 37:b.attr("checked",!1);a();break;case 39:b.attr("checked",!0);a();break;case 32:b.attr("checked",!b.is(":checked"));a();break;
case 9:var g=$(".ui-dialog").find(":tabbable");!d.shiftKey&&$(c).get(0)===g.last().get(0)&&(d.stopPropagation(),g.first().focus(1));break;case 27:t()}});b.on("change",a)}function l(){var a=$(u.find(z.SHOW_LOCATION_MODE_TOGGLE));v.getShowLocations()==="true"?(a.attr("checked",!0),$(u.find(z.SHOW_LOCATION_MODE_LABEL)).text(ResourceBundle.getLocalizedString(I.ONE_COLUMN_ON))):(a.removeAttr("checked"),$(u.find(z.SHOW_LOCATION_MODE_LABEL)).text(ResourceBundle.getLocalizedString(I.ONE_COLUMN_OFF)))}function n(){e();
b();a();k();l()}function r(){H(v);q(!1);c()}function o(){x.equal(v)?q(!1):q(!0)}function q(a){a?$(z.APPLY_SETTINGS).removeAttr("disabled"):$(z.APPLY_SETTINGS).button("disable")}function t(){x.equal(v)||(v=x,n());KindleUXComponentManager.closeDialog(s);c()}var s="Metro/KindleMetroReaderViewSettings",u,y,v,x,H,C,I={APPLY_BUTTON:"k_R_settings_apply_button",ONE_COLUMN_ON:"k_R_settings_column_on_button",ONE_COLUMN_OFF:"k_R_settings_column_off_button"},z={FONT_SIZE:"#kindleReader_viewSettings_fontSize_slider",
FONT_SIZE_TOOLTIP:"#kindleReader_viewSettings_fontSize_slider_tooltip",MARGIN:"#kindleReader_viewSettings_margin_slider",COLOR_MODE:"#kindleReader_viewSettings_optionButtons",COLOR_WHITE:"#kindleReader_viewSettings_colorWhite",COLOR_SEPIA:"#kindleReader_viewSettings_colorSepia",COLOR_BLACK:"#kindleReader_viewSettings_colorBlack",COLUMN_MODE:"#kindleReader_viewSettings_column_toggle_wrapper",COLUMN_MODE_TOGGLE:"#kindleReader_viewSettings_column_toggle",COLUMN_MODE_TOGGLE_LABEL:"#kindleReader_viewSettings_column_toggle_switch",
COLUMN_MODE_LABEL:"#kindleReader_viewSettings_column_toggle_label",COLUMN_MODE_MSG:"#kindleReader_viewSettings_optionButtons_msg",SHOW_LOCATION_MODE:"#kindleReader_viewSettings_showLocation_toggle_wrapper",SHOW_LOCATION_MODE_TOGGLE:"#kindleReader_viewSettings_showLocation_toggle",SHOW_LOCATION_MODE_TOGGLE_LABEL:"#kindleReader_viewSettings_showLocation_toggle_switch",SHOW_LOCATION_MODE_LABEL:"#kindleReader_viewSettings_showLocation_toggle_label",APPLY_SETTINGS:"#kindleReader_viewSettings_apply",MARGIN_PREVIEW:"#kindleReader_margin_preview"},
B=[KINDLE_READER_SETTINGS_FONT_SIZE.XSMALL.size,KINDLE_READER_SETTINGS_FONT_SIZE.SMALL.size,KINDLE_READER_SETTINGS_FONT_SIZE.MEDIUM.size,KINDLE_READER_SETTINGS_FONT_SIZE.LARGE.size,KINDLE_READER_SETTINGS_FONT_SIZE.XLARGE.size],w=[KINDLE_READER_SETTINGS_MARGIN.XLARGE.size,KINDLE_READER_SETTINGS_MARGIN.LARGE.size,KINDLE_READER_SETTINGS_MARGIN.MEDIUM.size,KINDLE_READER_SETTINGS_MARGIN.SMALL.size,KINDLE_READER_SETTINGS_MARGIN.XSMALL.size],E=[8,10,12,20,30],K=[KINDLE_READER_SETTINGS_COLOR_MODE.WHITE,KINDLE_READER_SETTINGS_COLOR_MODE.SEPIA,
KINDLE_READER_SETTINGS_COLOR_MODE.BLACK],D={getDialogSettings:function(){return{autoOpen:!1,width:340,modal:!0,draggable:!1,resizable:!1,dialogClass:"settings_dialog",buttons:[{id:z.APPLY_SETTINGS.slice(1),text:ResourceBundle.getLocalizedString(I.APPLY_BUTTON),click:r}],k4w_transparent_modal_overlay:!0}},onInitializationDone:function(a){u=a;h();d();f();g();m()},beforeDialogOpen:function(){n();q(!1);$(z.APPLY_SETTINGS).attr("tabindex",70).off("keydown").on("keydown",function(a){switch(a.keyCode){case 9:a.shiftKey||
(a.stopPropagation(),$("#kindleReader_viewSettings_fontSize_slider").focus(1));break;case 13:$("#kindleReader_viewSettings_fontSize_slider").focus(1);break;case 27:t()}})},onOverlayClicked:t};return{open:function(a,b,c){x=a;v=new KindleReaderSettings;v.copy(a);H=c;y=b;KindleUXComponentManager.openDialog(s,D);a=document.getElementById("kindleReader_footer");document.getElementsByClassName("settings_dialog")[0].style.bottom=a.clientHeight+5+"px"}}}(),KindleReaderImmersiveModeExit=function(){function h(c){j=
c;j.tap(function(){d()});e(c)}var j,e,d;return{initialize:function(c,b){e=c;d=b;KindleUXComponentManager.initializeComponent("KindleReaderImmersiveModeExit",h)}}}(),KindleReaderSearchBox=function(){function h(b){function d(){q.removeClass(f)}function g(a){a.stopPropagation()}function e(){t.val("");u.hide()}function h(){if(k){var a=$(b.inputWrapperSelector).width();t.css({width:a})}}var q=$(b.searchDivSelector),t=$(b.inputElementSelector),s=$(b.searchButtonSelector);if(!a){var u=$(b.clearButtonSelector);
u.on("click",e);u.hide()}q.off("focusin").off("focusout").on("focusin",function(){q.addClass(f);if(c&&c.onfocus)c.onfocus()}).on("focusout",d);t.attr("placeholder",ResourceBundle.getLocalizedString(b.placeholderStringId));t.on("click",function(){t.focus()}).on("keydown",function(a){switch(a.keyCode){case 13:KindleEventBroker.fire("reader_search");a.stopPropagation();a.preventDefault();break;case 70:if(a[KindleHostDeviceDetector.isMacintosh()?"metaKey":"ctrlKey"])a.preventDefault(),a.stopPropagation()}}).on("keyup",
function(b){if(!a&&b.keyCode!==9){var c=t.val();c&&c.length?u.fadeIn(200):u.fadeOut(420)}b.stopPropagation()}).on("keypress",g);KindleTouchEventsToggler.isRequired()&&(t.focus(function(){KindleTouchEventsToggler.off()}),t.blur(function(){KindleTouchEventsToggler.on()}));b.inputWrapperSelector&&($(b.inputWrapperSelector).on("resize",h),h());s.on("keydown",function(a){switch(a.keyCode){case 9:a.shiftKey||(d(),$("#kindleReader_sitb_pane").length>0&&(a.preventDefault(),a.stopPropagation(),KindleReaderSitbPane.selectFirstSitbResult()));
break;case 13:a.stopPropagation();a.preventDefault();KindleEventBroker.fire("reader_search");break;case 70:if(a[KindleHostDeviceDetector.isMacintosh()?"metaKey":"ctrlKey"])a.preventDefault(),a.stopPropagation();break;default:a.stopPropagation()}}).on("keyup",g).on("keypress",g);j(b.enabled)}function j(a){var b=$(g.searchDivSelector);a?b.fadeIn():b.hide()}var e={searchDivSelector:"#kindleReader_sitb",searchButtonSelector:"#kindleReader_button_sitb",inputWrapperSelector:"#kindleReader_input_sitb",inputElementSelector:"#kindleReader_input_sitb_box",
placeholderStringId:"k_R_menuInput_sitb_placeholder",clearButtonSelector:"#kindleReader_input_sitb_clear",enabled:!1},d={searchDivSelector:"#searchArea",searchButtonSelector:"#kindleReader_search_submit",inputElementSelector:"#kindleReader_search_field",placeholderStringId:"k_R_search_placeholder",enabled:!0},c,b,f="active",a=KindleHostDeviceDetector.isMetro(),g=a?d:e,k=KindleHostDeviceDetector.isiOS();return{initialize:function(a){b=g.inputElementSelector;h(g);c=a},getSearchText:function(){return $(b).val()},
setActive:function(a){a||a===void 0?$(b).focus():$(b).blur()},setEnabled:j}}(),KindleReaderSitbPane=function(){function h(){return v.find("#"+y.Container)}function j(){$("#"+y.Dialog).css("height",e());var a=v.find("#"+y.IndexingMsg),b=v.find("#"+y.ScrollWrapper).height();a.css("margin-top",b/2-a.height()/2);KindleHostDeviceDetector.isiOS()||(a=$("#"+y.Search).offset().left-$("#"+y.Dialog).offset().left,a=$("#"+y.Search).width()-a+21,a<-13?$("#"+y.Beak).hide():$("#"+y.Beak).show().css({right:a+"px"}))}
function e(){var a=document.getElementById("kindleReader_header"),b=document.getElementById("kindleReader_footer"),a=a.getBoundingClientRect().bottom+12;return b.getBoundingClientRect().top-12-a}function d(b){function c(){return $(document.createElement("div")).addClass(y.Overlay).click(a).dblclick(a)}var d=[],g=b.getBoundingClientRect(),f=window.outerWidth||window.innerWidth,b=c();b.css({top:0,right:f-g.left});d.push(b);b=c();b.css({top:0,right:0,width:f-g.right});d.push(b);b=c();b.css({top:0,left:0,
height:g.top});d.push(b);b=c();b.css({top:g.top+g.height,bottom:0,height:"auto",left:0});d.push(b);return d}function c(){L=KindleHostDeviceDetector.isFirefox()||KindleHostDeviceDetector.isIE()}function b(){j();f()}function f(){if(w)K?K.refresh():K=new iScroll(y.ScrollWrapper,{vScrollbar:!1});else if(E){var a=$("#"+y.ScrollWrapper).height(),b=h();b.height(a);b.jScrollPane({showArrows:!0,verticalGutter:10});b.off("keydown").off("keyup").on("keydown",n).on("keyup",m)}}function a(){if(D){g();v.detach();
for(var a=0;a<x.length;a++)x[a].detach();window.removeEventListener("resize",j);D.resolve();D=null}}function g(){k();var a=h();a&&(w?(a.empty(),K&&K.scrollTo(0,0,0,!1)):E?a.data("jsp")&&a.data("jsp").getContentPane()&&a.data("jsp").getContentPane().empty():a.empty())}function k(){B&&(B.removeClass(F),B=null)}function m(a){a.stopPropagation()}function l(){if(E)h().data("jsp").scrollToElement(B);else if(!w){var a=B.get(0).offsetTop,b=B.get(0).offsetTop+B.get(0).clientHeight,c=h().scrollTop(),d=h().scrollTop()+
h().height();a<c?h().scrollTop(a):b>d&&h().scrollTop(b-h().height())}}function n(b){var c=b.keyCode||b.which;b.stopPropagation();KindleEventUtil.preventKeyScroll(b);switch(c){case 36:o();break;case 35:var d;E?d=h().data("jsp").getContentPane().children().last():w||(d=h().children().last());w||(d.length>0&&d.attr("id")===y.SpinnerContainer&&(d=d.prev()),d.length>0&&d.attr("id")!==y.SpinnerContainer&&(B&&B.removeClass(F),B=d,B.addClass(F),l(),h().focus()));break;case 38:B&&(b=B.prev(),b.length>0&&(B.removeClass(F),
B=b,B.addClass(F),l()));break;case 40:B&&(b=B.next(),b.length>0&&b.attr("id")!==y.SpinnerContainer&&(B.removeClass(F),B=b,B.addClass(F),l()));break;case 13:B&&(B.tap(),h().focus());break;case 9:k();b.shiftKey||(b.preventDefault(),document.getElementById(y.SearchBox).focus());break;case 27:a()}}function r(a){var a=$(a.currentTarget),b=L;L=!1;if(b)return!1;if(B)if(B===a)return;else B.removeClass(F),B=a,a.addClass(F);else B=a,B.addClass(F);h().focus()}function o(){var a;E?a=h().data("jsp").getContentPane().children().first():
w||(a=h().children().first());!w&&a.length>0&&a.attr("id")!==y.SpinnerContainer&&(B&&B.removeClass(F),B=a,B.addClass(F),l(),h().focus())}function q(){var a=$("#"+y.CurLocMarker),b="";(b=$.data(a[0],"page"))?b=ResourceBundle.getLocalizedString("k_R_dialog_sitb_result_current_page_past",{page:b}):(b=$.data(a[0],"location"),b=ResourceBundle.getLocalizedString("k_R_dialog_sitb_result_current_location_past",{location:b}));a.find("."+y.LocationMarker).text(b)}function t(){E?N.appendTo(h().data("jsp").getContentPane()):
N.appendTo(h())}var s={Searching:"Searching",NotAvailable:"NotAvailable",Indexing:"Indexing",Complete:"Complete"},u={Indexing:"k_R_dialog_sitb_pane_title_indexing",Searching:"k_R_dialog_sitb_pane_title_searching",ResultsFound:"k_R_dialog_sitb_pane_title_resultsFound",OneResultFound:"k_R_dialog_sitb_pane_title_oneResultFound",NotAvailable:"k_R_dialog_sitb_pane_title_notAvailable",Page:"k_R_dialog_sitb_result_page",Location:"k_R_dialog_sitb_result_location",CloseButton:"k_common_close_button"},y={Dialog:"kindleReader_sitb_pane",
Title:"kindleReader_sitb_pane_title",CloseButton:"kindleReader_sitb_pane_close_btn",Container:"kindleReader_sitb_pane_container",ScrollWrapper:"kindleReader_sitb_pane_scrollWrapper",Beak:"kindleReader_sitb_pane_beak",CurLocMarker:"kindleReader_sitb_pane_cur_loc_marker",SpinnerContainer:"kindleReader_sitb_spinner_container",Spinner:"kindleReader_sitb_spinner",Search:"kindleReader_sitb",SearchBox:"kindleReader_input_sitb_box",IndexingMsg:"kindleReader_sitb_message",Overlay:"kindleReader_sitb_pane_overlay",
ResultContainer:"kindleReader_sitb_result_container",ContextBody:"kindleReader_sitb_result_context_body",LocationMarker:"kindleReader_sitb_result_cur_loc_marker",ContextFooter:"kindleReader_sitb_context_footer",PageNumber:"kindleReader_sitb_pagenumber",Location:"kindleReader_sitb_location"},v=null,x=null,H=null,C=null,I=null,z=null,B=null,w=KindleHostDeviceDetector.isiOS(),E=!w&&!KindleHostDeviceDetector.isIE(),K=null,D=null,M=KindleHostDeviceDetector.isiOS(),N=$("<div id='kindleReader_sitb_spinner_container'><div id='kindleReader_sitb_spinner'></div></div>"),
F="selected",L=!1;return{States:s,show:function(f){if(D)return g(),t(),M&&h().focus(),D.promise();v||(v=$(Handlebars.templates.KindleReaderSitbPane()),v.find("#"+y.CloseButton).click(a));if(!x){var e=document.getElementById("kindleReader_sitb");x=d(e)}if(!H&&(H=$(Handlebars.templates.KindleReaderSitbResult()),!M))H.on("mouseover",r);if(!I&&(I=$(Handlebars.templates.KindleReaderSitbResultCurLocMarker()),!M))I.on("mouseover",r);C||(C=$(Handlebars.templates.KindleSimpleSpinner()),C.appendTo(N.find("#"+
y.Spinner)));z||(z=f);(function(){var a=$("body");a.append(v);for(var b=0;b<x.length;b++)a.append(x[b])})();j();w?h().focus():(E?h().jScrollPane({showArrows:!0,verticalGutter:10}):h().addClass("ie_scrollable"),h().off("keydown").off("keyup").on("keydown",n).on("keyup",m).on("scroll",c));t();window.addEventListener("resize",b,!1);D=$.Deferred();return D.promise()},close:a,selectFirstSitbResult:o,showErrorMessage:function(b){var c=ResourceBundle.getLocalizedString(u.CloseButton);a();switch(b){case Kindle.ERROR.SITB_OFFLINE:case Kindle.ERROR.SITB_LANGUAGE_NOT_SUPPORTED:case Kindle.ERROR.SITB_INDEX_NOT_AVAILABLE:case Kindle.ERROR.SITB_LANGUAGE_UNDEFINED:KindleMessageDialog.showError(b,
null,c);break;default:KindleMessageDialog.showError(Kindle.ERROR.SITB_COMMON_ERROR,null,c)}},setViewState:function(a,b){var c;switch(a){case s.Searching:v.find("#"+y.IndexingMsg).hide();c=ResourceBundle.getLocalizedString(u.Searching);v.find("#"+y.SpinnerContainer).show();break;case s.Indexing:v.find("#"+y.IndexingMsg).show();c=ResourceBundle.getLocalizedString(u.Indexing);break;case s.Complete:b=b?b:0,c=ResourceBundle.getLocalizedString(b!==1?u.ResultsFound:u.OneResultFound).replace("${numberResults}",
b),v.find("#"+y.SpinnerContainer).hide(),f()}v.find("#"+y.Title).text(c)},addItem:function(a){var b=H.clone(!0),c="",d=c="",g="";b.find("."+y.ContextBody).html(a.context);a.pageNumber&&(c=ResourceBundle.getLocalizedString("k_R_dialog_sitb_result_page",{page:a.pageNumber}));a.location&&(c!==""&&(d=" \u25cf "),g=ResourceBundle.getLocalizedString("k_R_dialog_sitb_result_location",{location:a.location}));b.find("."+y.Location).text(c+d+g);b.click(function(){z(a);q()});b.tap(function(){z(a);q()});b.insertBefore(N);
f()},addLocationMarker:function(a){var b=I.clone(!0),c="";a.pageNumber?(c=ResourceBundle.getLocalizedString("k_R_dialog_sitb_result_current_page",{page:a.pageNumber}),$.data(b[0],"page",a.pageNumber)):(c=ResourceBundle.getLocalizedString("k_R_dialog_sitb_result_current_location",{location:a.location}),$.data(b[0],"location",a.location));b.find("."+y.LocationMarker).text(c);b.click(function(){z(a);q()});b.insertBefore(N);f()}}}(),KindleReaderLocationBar=function(){function h(a){var b=x.find("#"+s.PROGRESS_BAR_ID),
c=x.find("#"+s.POPUP_LABEL_ID),d=c.outerWidth(),g=$(window).width(),f=b.width(),b=b.offset(),a=(a-H)/(C-H)*f,a=a<0?0:a,g=E?g-f-b.left:b.left;a+=g;c.css(E?"right":"left",(d/2+g>a?g:a+d/2>f+g?f+g-d:a-d/2)+"px")}function j(a,b){w=!0;KindleReaderUI.getPNLabelFromLocation(b.value).done(function(a){c(b.value,a);h(b.value,a)})}function e(a,b){w=!1;C>0&&v(b.value)}function d(){x&&C>0&&H>=0&&x.find("#"+s.PROGRESS_BAR_ID).slider("option","min",H).slider("option","max",C).slider("option","disabled",!1)}function c(a,
b){var c;c=b?ResourceBundle.getLocalizedString("k_R_slider_pageNumber_popup",{page:b})+" \u00b7 "+ResourceBundle.getLocalizedString("k_R_slider_loc_popup",{location:a}):ResourceBundle.getLocalizedString("k_R_slider_location_popup",{location:a});x.find("#"+s.POPUP_LABEL_ID).text(c);c=ResourceBundle.getLocalizedString("k_R_slider_percentage",{percent:Math.round(a/C*100)});var d=ResourceBundle.getLocalizedString("k_R_slider_location",{location:a,totalLocations:C}),g="";b&&b!==""&&I!==""&&(g=ResourceBundle.getLocalizedString("k_R_slider_pageNumber",
{page:b,totalPages:I})+" \u00b7 ");N.text(c+" \u00b7 "+g+d)}function b(){if(x&&z>=0){var a=z;x.find("#"+s.PROGRESS_BAR_ID).slider("option","value",a);c(z,B)}}function f(a){w||a<0?clearTimeout(D):D=setTimeout(function(){n()},a)}function a(a){w||a<0?clearTimeout(K):K=setTimeout(function(){n()},a)}function g(){M?x.find("#"+s.PROGRESS_BAR_ID).addClass("black"):x.find("#"+s.PROGRESS_BAR_ID).removeClass("black")}function k(a){var a=a.originalEvent,b=a.changedTouches[0],c="";switch(a.type){case "touchstart":c=
"mousedown";break;case "touchmove":c="mousemove";break;case "touchend":c="mouseup";break;default:return}var d=document.createEvent("MouseEvent");d.initMouseEvent(c,!0,!0,window,1,b.screenX,b.screenY,b.clientX,b.clientY,!1,!1,!1,!1,0,null);b.target.dispatchEvent(d);a.preventDefault()}function m(a){x=a;N=x.find("#"+s.MESSAGE_LABEL_ID);F=x.find("#"+s.DOWNLOAD_PROGRESS_ID);L=x.find("#"+s.DOWNLOAD_PROGRESS_MESSAGE_ID);F.prepend(Handlebars.templates.KindleSimpleSpinner({}));P=x.find(".spinner");P.attr("id",
s.DOWNLOAD_PROGRESS_SPINNER_ID);var c=a.find("#"+s.PROGRESS_BAR_ID);c.slider({range:"min",value:1,max:100,min:1,step:1,animate:!KindleHostDeviceDetector.isMetro(),disabled:!0,rtl:E,slide:j,stop:e});c.find("."+u.RANGE).addClass("ui-corner-left");c.find("."+u.HANDLE).removeAttr("href");c.find("."+u.HANDLE).attr("id",s.PROGRESS_BAR_HANDLE_ID);r();g();d();b();KindleHostDeviceDetector.isiPad()&&(x.bind("touchstart",k),x.bind("touchmove",k),x.bind("touchend",k),x.bind("touchmove",l),x.bind("touchend",n),
x.bind("touchcancel",n));y(a)}function l(){var a=x.find("#"+s.PROGRESS_BAR_ID),b=x.find("#"+s.POPUP_ID);C>0&&(b.show(),h(a.slider("option","value")))}function n(){x&&x.find("#"+s.POPUP_ID).hide()}function r(){function b(){C>0&&(a(-1),J&&q())}function c(){w&&x.mouseup();a(2E3)}!KindleHostDeviceDetector.isiOS()&&!KindleHostDeviceDetector.isMetro()&&(x.find("#"+s.PROGRESS_BAR_ID).find("."+u.HANDLE).hover(function(){C>0&&(f(-1),l())},function(){f(500)}),x.hover(b,c),a(2E3))}function o(a){function b(){x.removeClass("downloading").addClass("download_completed")}
P.removeClass("spinner");a>0&&(a=ResourceBundle.getLocalizedString("k_R_downloaded",{percent:100}),F.addClass("finished"),L.text(a));(KindleHostDeviceDetector.isiOS()?!G:L.is(":visible"))?b():J=b}function q(){setTimeout(function(){J&&(J(),J=null)},1E3)}var t=KindleHostDeviceDetector.isMetro()?"Metro/KindleMetroReaderFooterBar":"KindleReaderLocationBar",s={PROGRESS_BAR_ID:"kindleReader_progressbar_div",PROGRESS_BAR_HANDLE_ID:"kindleReader_progressbar_handle",MESSAGE_LABEL_ID:"kindleReader_footer_message",
POPUP_ID:"kindleReader_locationPopup_div",POPUP_LABEL_ID:"kindleReader_locationPopup_labelDiv",DOWNLOAD_PROGRESS_ID:"kindleReader_download_progress",DOWNLOAD_PROGRESS_MESSAGE_ID:"kindleReader_download_progress_message",DOWNLOAD_PROGRESS_SPINNER_ID:"kindleReader_download_spinner",FooterReaderControlsLeft:"kindleReader_footer_readerControls_left"},u={HANDLE:"ui-slider-handle",RANGE:"ui-slider-range"},y,v,x,H=-1,C=-1,I=-1,z=-1,B,w=!1,E=!1,K,D,M,N,F,L,P,A={IN_PROGRESS:"in_progress",COMPLETED:"completed",
DISK_ERROR:"disk_error",NETWORK_ERROR:"network_error"},O=-1,J,G=!1;return{DOWNLOAD_COMPLETED:A.COMPLETED,DOWNLOAD_IN_PROGRESS:A.IN_PROGRESS,DOWNLOAD_DISK_ERROR:A.DISK_ERROR,DOWNLOAD_NETWORK_ERROR:A.NETWORK_ERROR,initialize:function(a,b,c){y=a;v=b;E=c;KindleUXComponentManager.initializeComponent(t,m,{isRtl:c})},setMinMaxLocation:function(a,b){C=b;H=a;d()},setMinMaxPageNumber:function(a,b){I=b},updateLocation:function(a){z=a;b()},updatePageLabel:function(a){B=a.pageNumber;z=a.loc;b()},setLocationBarBlack:function(a){M=
a;x&&g()},hidePopup:n,updateDownloadProgress:function(a,b){N.is(":visible")||(F.hide(),P.removeClass("spinner"));switch(a){case A.COMPLETED:o(O);break;case A.IN_PROGRESS:O=b;if(x&&b>=0&&b<=100){var c=ResourceBundle.getLocalizedString("k_R_downloading",{percent:b});x.addClass("downloading");L.text(c);P.addClass("spinner")}break;case A.DISK_ERROR:case A.NETWORK_ERROR:var d=O,c=KindleModuleManager.getModuleSync(KindleModuleManager.LINK_URLS),d=d>0?d+"% ":"";x.removeClass("downloading").addClass("download_error");
if(a===A.DISK_ERROR){if(c=ResourceBundle.getLocalizedString("k_R_download_disk_error",{percent:d,url:c.getIncreaseOfflineStorageUrl()}),KindleHostDeviceDetector.isMetro()){var c=$("<div>").html(c),d=c.children("#kindleReader_download_disk_error"),g=$("<span>").attr("id",d.attr("id")).html(d.html());d.replaceWith(g);c=c.html()}}else c=ResourceBundle.getLocalizedString("k_R_download_network_error",{percent:d});L.html(c)}},setImmersiveMode:function(a){G=a;!G&&J&&q()}}}(),KindleReaderImmersiveFooter=
function(){function h(){var c="",d="";if(b){switch(a){case "location":g&&(d=ResourceBundle.getLocalizedString("k_R_slider_location_popup",{location:g}));break;case "page":k&&(d=ResourceBundle.getLocalizedString("k_R_slider_pageNumber_popup",{page:k}));break;case "noLabel":percentageLabel=d=""}d&&(c=d)}l.innerHTML=c}function j(){clearTimeout(m);do a=c[a].next;while(!c[a].enabled);h();m=setTimeout(function(){var b=a.charAt(0).toUpperCase()+a.slice(1);f.emit("Reader::Immersive::"+b);m=null},2E3)}function e(a){a===
"true"?(b=!0,l.style.cursor="pointer",f.emit("Reader::Immersive::Enable")):(b=!1,l.style.cursor="default",f.emit("Reader::Immersive::Disable"));h()}var d={IMMERSIVE_LABEL:"kindleReader_immersiveFooter"},c={page:{next:"location"},location:{next:"timeLeftInChapter",enabled:!0},timeLeftInChapter:{next:"timeLeftInBook"},timeLeftInBook:{next:"noLabel"},noLabel:{next:"page"}},b=!0,f,a="location",g,k,m,l;return{initialize:function(a,b){f=a;l=document.getElementById(d.IMMERSIVE_LABEL);l.addEventListener("click",
j,!1);e(b)},updateLabel:function(a){k=a.pageNumber;g=a.loc;h()},setMaxLocation:function(){},enableLabelType:function(b){a=b;c[b].enabled=!0},enable:e}}(),KindleReaderPageArrow=function(){function h(c){g=c;g.find("#"+d.LEFT_AREA_ID).click(b);g.find("#"+d.RIGHT_AREA_ID).click(f);g.find("#"+d.LEFT_AREA_ID).tap(b);g.find("#"+d.RIGHT_AREA_ID).tap(f);a(g);j();e()}function j(){k?g.find("#"+d.LEFT_AREA_ID).addClass("pageArrow"):g.find("#"+d.LEFT_AREA_ID).removeClass("pageArrow");m?g.find("#"+d.RIGHT_AREA_ID).addClass("pageArrow"):
g.find("#"+d.RIGHT_AREA_ID).removeClass("pageArrow")}function e(){switch(l){case KINDLE_READER_SETTINGS_COLOR_MODE.WHITE:g.find("."+c).removeClass("black");g.find("."+c).removeClass("sepia");break;case KINDLE_READER_SETTINGS_COLOR_MODE.BLACK:g.find("."+c).removeClass("sepia");g.find("."+c).addClass("black");break;case KINDLE_READER_SETTINGS_COLOR_MODE.SEPIA:g.find("."+c).removeClass("black"),g.find("."+c).addClass("sepia")}}var d={LEFT_AREA_ID:"kindleReader_pageTurnAreaLeft",RIGHT_AREA_ID:"kindleReader_pageTurnAreaRight"},
c="kindleReader_pageTurnArea",b,f,a,g,k,m,l;return{initialize:function(c,d,g,e){a=c;b=d;f=g;KindleUXComponentManager.initializeComponent("KindleReaderPageArrow",h,{rtlPageAdvance:e})},setArrowEnabled:function(a,b){k=a;m=b;g&&j()},setArrowColor:function(a){l=a;g&&e()}}}(),KindleReaderSampleEnd=function(){var h={TITLE_LABEL_STRING_ID:"k_endOfSample_Title",TEXT_LABEL_STRING_ID:"k_endOfSample_Text",BUY_BUTTON_STRING_ID:"k_endOfSample_buy_button",CANCEL_BUTTON_STRING_ID:"k_endOfSample_cancel_button"},
j={TITLE_LABEL_ID:"kindle_sample_end_title_text",TEXT_LABEL_ID:"kindle_sample_end_message_text"},e,d,c=function(){d="buy";KindleUXComponentManager.closeDialog("KindleReaderSampleEnd")},b=function(){d="cancel";KindleUXComponentManager.closeDialog("KindleReaderSampleEnd")},f={getDialogSettings:function(){var a={};a[ResourceBundle.getLocalizedString(h.CANCEL_BUTTON_STRING_ID)]=b;a[ResourceBundle.getLocalizedString(h.BUY_BUTTON_STRING_ID)]=c;return{autoOpen:!1,modal:!0,draggable:!1,resizable:!1,buttons:a,
width:460,k4w_transparent_modal_overlay:!1}},beforeDialogOpen:function(a){var b=ResourceBundle.getLocalizedString(h.TITLE_LABEL_STRING_ID),c=ResourceBundle.getLocalizedString(h.TEXT_LABEL_STRING_ID);a.find("#"+j.TITLE_LABEL_ID).empty().append(b);a.find("#"+j.TEXT_LABEL_ID).empty().append(c)},onDialogClose:function(){e(d)}};return{open:function(a){e=a;d=!1;KindleUXComponentManager.openDialog("KindleReaderSampleEnd",f)}}}(),KindleReaderSettingsDialog=function(){function h(){var a=s.find(v.FONT_SIZE_PANEL_ID).buttonset(),
b=function(a){return function(){var b=KINDLE_READER_SETTINGS_FONT_SIZE[a].size;o.getFontSize()!==b&&(o.setFontSize(b),n(),j(),q=!0)}},c;for(c in KINDLE_READER_SETTINGS_FONT_SIZE)a.find(KINDLE_READER_SETTINGS_FONT_SIZE[c].id).tap(b(c))}function j(){var a=o.getFontSize(),b;for(b in KINDLE_READER_SETTINGS_FONT_SIZE)a===KINDLE_READER_SETTINGS_FONT_SIZE[b].size?s.find(KINDLE_READER_SETTINGS_FONT_SIZE[b].id+"Selected").css("visibility","visible"):s.find(KINDLE_READER_SETTINGS_FONT_SIZE[b].id+"Selected").css("visibility",
"hidden")}function e(){var a=s.find(v.MARGIN_PANEL_ID).buttonset(),b=function(a){return function(){var b=KINDLE_READER_SETTINGS_MARGIN[a].size;o.getMargin()!==b&&(o.setMargin(b),d(),q=!0)}},c;for(c in KINDLE_READER_SETTINGS_MARGIN)a.find(KINDLE_READER_SETTINGS_MARGIN[c].id).tap(b(c))}function d(){var a=o.getMargin(),b;for(b in KINDLE_READER_SETTINGS_MARGIN)a===KINDLE_READER_SETTINGS_MARGIN[b].size?s.find(KINDLE_READER_SETTINGS_MARGIN[b].id+"Selected").css("visibility","visible"):s.find(KINDLE_READER_SETTINGS_MARGIN[b].id+
"Selected").css("visibility","hidden")}function c(){var a=s.find(v.COLUMN_MODE_PANEL_ID).buttonset(),c=function(a){return function(){var c=KINDLE_READER_SETTINGS_COLUMN_MODE[a].persistedValue;o.getShowColumns()!==c&&(o.setShowColumns(c),b(),q=!0)}},d;for(d in KINDLE_READER_SETTINGS_COLUMN_MODE)u.columns&&u.columns!==1&&a.find(KINDLE_READER_SETTINGS_COLUMN_MODE[d].id).tap(c(d))}function b(){var a=o.getShowColumns(),b;for(b in KINDLE_READER_SETTINGS_COLUMN_MODE)a===KINDLE_READER_SETTINGS_COLUMN_MODE[b].persistedValue?
s.find(KINDLE_READER_SETTINGS_COLUMN_MODE[b].id).addClass("on"):s.find(KINDLE_READER_SETTINGS_COLUMN_MODE[b].id).removeClass("on")}function f(){var b=s.find(v.SHOW_LOCATION_PANEL_ID).buttonset(),c=function(b){return function(){var c=KINDLE_READER_SETTINGS_SHOW_LOCATION_MODE[b].persistedValue;o.getShowLocations()!==c&&(o.setShowLocations(c),a(),q=!0)}},d;for(d in KINDLE_READER_SETTINGS_SHOW_LOCATION_MODE)b.find(KINDLE_READER_SETTINGS_SHOW_LOCATION_MODE[d].id).tap(c(d))}function a(){var a=o.getShowLocations(),
b;for(b in KINDLE_READER_SETTINGS_SHOW_LOCATION_MODE)a===KINDLE_READER_SETTINGS_SHOW_LOCATION_MODE[b].persistedValue?s.find(KINDLE_READER_SETTINGS_SHOW_LOCATION_MODE[b].id).addClass("on"):s.find(KINDLE_READER_SETTINGS_SHOW_LOCATION_MODE[b].id).removeClass("on")}function g(){var a=s.find(v.COLOR_MODE_PANEL_ID).buttonset(),b=function(a){return function(){var b=KINDLE_READER_SETTINGS_COLOR_MODE[a];o.getColorMode()!==b&&(o.setColorMode(b),n(),k(),q=!0)}},c;for(c in KINDLE_READER_SETTINGS_COLOR_MODE)a.find(KINDLE_READER_SETTINGS_COLOR_MODE[c].id).tap(b(c))}
function k(){var a=o.getColorMode(),b;for(b in KINDLE_READER_SETTINGS_COLOR_MODE)a===KINDLE_READER_SETTINGS_COLOR_MODE[b]?s.find(KINDLE_READER_SETTINGS_COLOR_MODE[b].id+"Selected").css("visibility","visible"):s.find(KINDLE_READER_SETTINGS_COLOR_MODE[b].id+"Selected").css("visibility","hidden");s.find(":not("+a.id+")").removeClass("selected");s.find(a.id).addClass("selected")}function m(){t=!0;KindleUXComponentManager.closeDialog(r)}function l(){KindleUXComponentManager.closeDialog(r)}function n(){var a=
s.find(v.PREVIEW_ID);o.getColorMode()===KINDLE_READER_SETTINGS_COLOR_MODE.BLACK?a.css({"box-shadow":"inset 0 0 10px #444444","-moz-box-shadow":"inset 0 0 10px #444444","-webkit-box-shadow":"inset 0 0 10px #444444","border-color":"#AAAAAA"}):a.css({"box-shadow":"inset 0 0 10px #666666","-moz-box-shadow":"inset 0 0 10px #666666","-webkit-box-shadow":"inset 0 0 10px #666666","border-color":"#000000"});a.css({color:o.getFGColor(),"font-size":o.getFontSize()+"px",backgroundColor:o.getBGColor()})}var r=
"KindleReaderSettingsDialog",o,q,t,s,u,y={SAMPLE_STRING_ID:"k_R_settings_sampleText",CANCEL_BUTTON_STRING_ID:"k_common_cancel_button",APPLY_BUTTON_STRING_ID:"k_R_settings_apply_button",COLUMN_MODE_ON_BUTTON_STRING_ID:"k_R_settings_column_on_button",COLUMN_MODE_OFF_BUTTON_STRING_ID:"k_R_settings_column_off_button"},v={PREVIEW_ID:"#kindleReader_controlPanel_preview",FONT_SIZE_PANEL_ID:"#kindleReader_controlPanel_fontSize",COLOR_MODE_PANEL_ID:"#kindleReader_controlPanel_colorMode",MARGIN_PANEL_ID:"#kindleReader_controlPanel_margin",
COLUMN_MODE_PANEL_ID:"#kindleReader_controlPanel_multiColumn",COLUMN_MODE_ON_ID:"#kindleReader_controlPanel_columnButton_on",COLUMN_MODE_OFF_ID:"#kindleReader_controlPanel_columnButton_off",COLUMN_MODE_MSG_ID:"#kindleReader_controlPanel_optionButtons_msg",SHOW_LOCATION_PANEL_ID:"#kindleReader_controlPanel_showLocation",SHOW_LOCATION_ON_ID:"#kindleReader_controlPanel_showLocationButton_on",SHOW_LOCATION_OFF_ID:"#kindleReader_controlPanel_showLocationButton_off"},x,H={getDialogSettings:function(){var a=
{};a[ResourceBundle.getLocalizedString(y.CANCEL_BUTTON_STRING_ID)]=l;a[ResourceBundle.getLocalizedString(y.APPLY_BUTTON_STRING_ID)]=m;return{autoOpen:!1,width:380,modal:!0,draggable:!1,resizable:!1,buttons:a,dialogClass:"settings_dialog"}},onInitializationDone:function(a){s=a;s.find(v.PREVIEW_ID).text(ResourceBundle.getLocalizedString(y.SAMPLE_STRING_ID));h();e();g();c();f()},beforeDialogOpen:function(c){s=c;n();j();d();k();b();a()},onDialogClose:function(){t&&q&&x(o)}};return{open:function(a,b,c){!/iPod/.test(navigator.userAgent)&&
!/iPhone/.test(navigator.userAgent)&&(o=new KindleReaderSettings,o.copy(a),q=!1,x=c,t=q=!1,u=b,KindleUXComponentManager.openDialog(r,H),KindleDeviceCapabilities.multiColumnMode()?b.columns&&b.columns!==1?$(v.COLUMN_MODE_MSG_ID).removeClass("show"):($(v.COLUMN_MODE_MSG_ID).addClass("show"),$(v.COLUMN_MODE_ON_ID).addClass("on"),$(v.COLUMN_MODE_ON_ID).unbind("tap"),$(v.COLUMN_MODE_OFF_ID).toggle(!1),$(v.COLUMN_MODE_OFF_ID).removeClass("on")):$(v.COLUMN_MODE_PANEL_ID).hide())}}}(),KindleReaderSyncPositionDialog=
function(){function h(b){var c=a.find("#"+e.SYNC_BUTTON_ID+" .ui-button-text"),d=a.find("#"+e.RESET_BUTTON_ID+" .ui-button-text");b==="page"?(c.text(ResourceBundle.getLocalizedString(j.SYNC_PAGE_BUTTON_STRING_ID)),d.text(ResourceBundle.getLocalizedString(j.RESET_PAGE_BUTTON_STRING_ID))):(c.text(ResourceBundle.getLocalizedString(j.SYNC_BUTTON_STRING_ID)),d.text(ResourceBundle.getLocalizedString(j.RESET_BUTTON_STRING_ID)))}var j={TEXT_LABEL_STRING_ID:"k_R_syncPosition_labelText",TEXT_LABEL_PN_STRING_ID:"k_R_syncPosition_PN_labelText",
TEXT_LABEL_STRING_ID_NO_DEVICE_NAME:"k_R_syncPosition_noDeviceName_labelText",TEXT_LABEL_PN_STRING_ID_NO_DEVICE_NAME:"k_R_syncPosition_noDeviceName_PN_labelText",CANCEL_BUTTON_STRING_ID:"k_R_syncPosition_cancelText",SYNC_BUTTON_STRING_ID:"k_R_syncPosition_sync",RESET_BUTTON_STRING_ID:"k_R_syncPosition_reset",SYNC_PAGE_BUTTON_STRING_ID:"k_R_syncPosition_page_sync",RESET_PAGE_BUTTON_STRING_ID:"k_R_syncPosition_page_reset"},e={TEXT_LABEL_ID:"kindleReader_dialog_syncPosition_label",CANCEL_BUTTON_ID:"kindleReader_syncPosition_cancel",
RESET_BUTTON_ID:"kindleReader_dialog_syncPosition_reset_btn",SYNC_BUTTON_ID:"kindleReader_dialog_syncPosition_sync_btn"},d={CANCEL:0,SYNC:1,RESET:2},c,b,f,a,g=function(){f=d.SYNC;KindleUXComponentManager.closeDialog("KindleReaderSyncPositionDialog")},k=function(){f=d.RESET;KindleUXComponentManager.closeDialog("KindleReaderSyncPositionDialog")},m=function(){f=d.CANCEL;KindleUXComponentManager.closeDialog("KindleReaderSyncPositionDialog")},l={getDialogSettings:function(){var a={};a[ResourceBundle.getLocalizedString(j.CANCEL_BUTTON_STRING_ID)]=
m;return{autoOpen:!1,modal:!0,draggable:!1,resizable:!1,buttons:a}},beforeDialogOpen:function(a){var c,d;if(b.fprDevice&&b.fprDevice!=="null"){d=new Date(b.fprDateTime);c=ResourceBundle.getLocalizedTime(d);var g=ResourceBundle.getLocalizedDate(d);b.currentPage?(c=ResourceBundle.getLocalizedString(j.TEXT_LABEL_PN_STRING_ID,{currentPage:b.currentPage,page:b.fprPage,deviceName:b.fprDevice,time:c,date:g}),h("page")):(d=b.fprLocation,b.fprPage&&(d+=" (Page "+b.fprPage+")"),c=ResourceBundle.getLocalizedString(j.TEXT_LABEL_STRING_ID,
{currentLocation:b.currentLocation,location:d,deviceName:b.fprDevice,time:c,date:g}),h("location"))}else b.currentPage?(c=ResourceBundle.getLocalizedString(j.TEXT_LABEL_PN_STRING_ID_NO_DEVICE_NAME,{currentPage:b.currentPage,page:b.fprPage}),h("page")):(c=ResourceBundle.getLocalizedString(j.TEXT_LABEL_STRING_ID_NO_DEVICE_NAME,{currentLocation:b.currentLocation,location:b.fprLocation}),h("location"));a.find("#"+e.TEXT_LABEL_ID).empty().append(c)},onDialogClose:function(){c(f)},onInitializationDone:function(b){a=
b;a.find("#"+e.SYNC_BUTTON_ID).click(g);a.find("#"+e.RESET_BUTTON_ID).click(k)}};return{open:function(a,g){c=g;f=d.CANCEL;b=a;KindleUXComponentManager.openDialog("KindleReaderSyncPositionDialog",l)},USER_RESPONSES:d}}(),KindleReaderTutorial=function(){function h(b){b?$(k[a].tutorialContainerId).fadeOut("slow",function(){$("#tutorialContainer").remove()}):$("#tutorialContainer").remove();$("#tutorialContainer").off("keyup",j);window.removeEventListener("resize",e,!1)}function j(a){a&&a.which&&a.which===
27&&h(!0);a.stopPropagation();a.preventDefault()}function e(){document.getElementById("tutorialContainer")&&(h(!1),d())}function d(){var d=KindleStringUtilities.substitute(k[a].template,{instruction1:k[a].instruction1,instruction2:k[a].instruction2,text:k[a].text,gestureTypeClass:k[a].gestureTypeClass});$("body").prepend(d);document.getElementById("tutorialContainer").focus();b();c();window.addEventListener("resize",e,!1);$(k[a].tutorialContainerId).hide().fadeIn("slow");$("#tutorialOverlay").click(function(){h(!0)}).focus();
$(".tutorialCloseBtn").click(function(){h(!0)});$("#tutorialContainer").on("keyup",j)}function c(){var b=window.innerWidth/2,c=window.innerHeight/2,d=$(k[a].tutorialContainerId),g=d.width()/2,f=d.height()/2;d.css({left:b-g,top:c-f})}function b(){var b=window.innerWidth,c=window.innerHeight,d=$(k[a].tutorialContainerId),g;g=a===k.children.name?$("#tutorialImagesContainer"):$(".comicTutorialImageContainer");var f=function(d){var g,f=d.height(),d=d.width();b<c||b<=d?d/b>k[a].maxWidthRatioWithScreen&&
(g=k[a].maxWidthRatioWithScreen*b/d):f/c>k[a].maxHeightRatioWithScreen&&(g=k[a].maxHeightRatioWithScreen*c/f);return g}(d);if(f)if(KindleHostDeviceDetector.isFirefox()?g.css("-moz-transform","scale("+f+","+f+")"):KindleHostDeviceDetector.isChrome()||KindleHostDeviceDetector.isSafari()?g.css("-webkit-transform","scale("+f+","+f+")"):g.css("transform","scale3d("+f+","+f+",1)"),a===k.children.name)d.css({width:g.width()*f+k.children.tutorialWidthMargin,height:g.height()*f+k.children.tutorialHeightMargin}),
$(".tutorialInstruction").css("font-size",function(a,b){return Math.floor(parseInt(b,10)*f)});else{var e=g.height()*(1-f);$("#comicTutorialInstruction2").css("top",function(a,b){return parseInt(b,10)-e});$("#comicTutorialImageContainer2").css("top",function(a,b){return parseInt(b,10)-e});$(".tutorialInstruction").css("font-size",function(a,b){return Math.floor(parseInt(b,10)*f)});d.css({width:d.width()-g.width()*(1-f),height:d.height()-g.height()*(1-f)*2})}}var f={comic:1,children:1},a,g,k={children:{name:"children",
tutorialContainerId:"#childrenTutorialContainer",tutorialWidthMargin:40,tutorialHeightMargin:70,maxHeightRatioWithScreen:0.8,maxWidthRatioWithScreen:0.7,instruction1:void 0,text:void 0,gestureTypeClass:g?"touchTutorialGesture":"clickTutorialGesture",template:'<div id="tutorialContainer" tabindex="-1"><div id="tutorialOverlay"> </div><div id="childrenTutorialContainer"><div id="childrenTutorialInstruction" class="tutorialInstruction">{{instruction1}}</div><div id="tutorialImagesContainer"><div id="childrenTutorialImageContainerLeft"><div class="childrenTutorialImage"></div><div id="tutorialChildrenText">{{text}}</div><div id="childrenTutorialGesture" class="{{gestureTypeClass}}"></div></div><div id="childrenTutorialImageContainerRight"><div class="childrenTutorialImage"></div><div id="tutorialChildrenTextZoomed">{{text}}</div></div></div><span class="tutorialCloseBtn">&#9447;</span></div></div>'},
comic:{name:"comic",tutorialContainerId:"#comicTutorialContainer",maxHeightRatioWithScreen:0.9,maxWidthRatioWithScreen:0.8,instruction1:void 0,instruction2:void 0,text:void 0,gestureTypeClass:g?"touchTutorialGesture":"clickTutorialGesture",template:'<div id="tutorialContainer" tabindex="-1"><div id="tutorialOverlay"> </div><div id="comicTutorialContainer"><div id="comicTutorialInstruction1" class="tutorialInstruction">{{instruction1}}</div><div id="comicTutorialImageContainer1" class="comicTutorialImageContainer"><div id="comicTutorialImage1"></div><div id="tutorialComicText">{{text}}</div><div id="comicTutorialGesture" class="{{gestureTypeClass}}"></div></div><div id="comicTutorialInstruction2" class="tutorialInstruction">{{instruction2}}</div><div id="comicTutorialImageContainer2" class="comicTutorialImageContainer"><div id="comicTutorialImage2"></div><div id="tutorialComicTextZoomed">{{text}}</div></div><span class="tutorialCloseBtn">&#9447;</span></div></div>'}};
return{show:function(b){$("#kindleReader_book_container");var c=LocalStorageCounter("kcrNotifications.zTutorial."+b);if(c.getValue()===0&&!KindleHostDeviceDetector.isMetro()){$("head").prepend("<style type=\"text/css\">@font-face {\n\tfont-family: 'Permanent Marker';\n\tfont-style: normal;\n\tfont-weight: 400;\n\tsrc: local('Permanent Marker'), local('PermanentMarker'), url(https://themes.googleusercontent.com/static/fonts/permanentmarker/v3/9vYsg5VgPHKK8SXYbf3sMmVSxyvLCPm9firj_jMeQtQ.woff) format('woff');\n}");
g=KindleHostDeviceDetector.isTouchDevice();a=b;if(a===Kindle.BookInfo.PublisherMetadata.COMIC)k[a].instruction1=g?ResourceBundle.getLocalizedString("metro_tutorial_comic_book_tap_instruction1"):ResourceBundle.getLocalizedString("metro_tutorial_comic_book_click_instruction1"),k[a].instruction2=g?ResourceBundle.getLocalizedString("metro_tutorial_comic_book_tap_instruction2"):ResourceBundle.getLocalizedString("metro_tutorial_comic_book_click_instruction2"),k[a].text=ResourceBundle.getLocalizedString("metro_tutorial_commic_book_dialogue");
else if(a===Kindle.BookInfo.PublisherMetadata.CHILDREN)k[a].instruction1=g?ResourceBundle.getLocalizedString("metro_tutorial_children_book_tap_instruction"):ResourceBundle.getLocalizedString("metro_tutorial_children_book_click_instruction"),k[a].text=ResourceBundle.getLocalizedString("metro_tutorial_children_book_text");else return;d();c.increment()}},getMaxShowCount:function(a){return f[a]||1}}}(),DictionaryMultiplexer=function(){function h(h,e){return{lookup:function(d){return typeof d==="string"||
d instanceof String?h.lookup(d):e.lookup(d)},getDictionaryList:function(){return e.getDictionaryList()},clearContext:function(){e.clearContext()},isLanguageSupported:function(d){return d.substring(0,2)==="en"||e.isLanguageSupported(d)},getDictionaryForLanguage:function(d){return e.getDictionaryForLanguage(d)}}}return{factory:function(){return $.when(dictionaryDotComFactory(),KindleDictionaryManager.initialize()).pipe(h)}}}(),dictionary=function(){var h=null;return{getDictionary:function(){return h=
h||DictionaryMultiplexer.factory()}}}(),IDictionary=function(){var h={lookup:function(){throw Error("Failed to implement lookup");}};Object.defineProperty(h,"NOT_WORD",{value:"Not a word",enumerable:!0});Object.defineProperty(h,"NOT_FOUND",{value:"No definition found",enumerable:!0});Object.defineProperty(h,"LOOKUP_FAILED",{value:"Word lookup failed",enumberable:!0});Object.defineProperty(h,"OFFLINE",{value:"Offline",enumberable:!0});return h}(),ILookup=function(){return{entry:"",getDefinitions:function(){throw Error("Failed to implement getDefinitions");
},getPronunciation:function(){throw Error("Failed to implement pronunciation");},getPronunciationUrls:function(){throw Error("Failed to implement pronunciationUrl");}}}();
function dictionaryDotComFactory(){function h(b){return(b=j.exec(b))&&b.length===2?b[1]:""}var j=/^\W*(\w+(?:-\w+)*(?:'\w+)?)\W*$/,e="https://app.dictionary.com/dictaudio/{audio_file}.mp3",d="https://app.dictionary.com/dictaudio/lunawav/{audio_file}.wav",c=Object.create(IDictionary);c.lookup=function(b){function c(a){function b(a,c){function d(a){$.each(a.definitions,function(a,b){b.content&&f.push(b.content)})}function g(a,b){b&&(b.type==="group"?d(b):b.definition.content&&f.push(b.definition.content))}
var f=[];a&&c&&($.each(c,g),f.length&&o.push({partOfSpeech:a,definitions:f}))}a&&a.result&&typeof a.result==="string"&&(a=JSON.parse(a.result));if(!a||!a.entries||!a.entries.length)g.reject(IDictionary.NOT_FOUND);else{var f=a.entries[0],a=f.entry,h=f.pronunciation_spell,j;if(f.audio_file)j={},j.mp3=encodeURI(e.replace("{audio_file}",f.audio_file)),j.wav=encodeURI(d.replace("{audio_file}",f.audio_file));var o=[];f.definitions&&$.each(f.definitions,b);f=Object.create(ILookup);Object.defineProperty(f,
"entry",{value:a,enumerable:!0});f.getDefinitions=function(){return o};f.getPronunciation=function(){return h};f.getPronunciationUrls=function(){return j};g.resolve(f)}}function a(a){g.reject(a.status?IDictionary.LOOKUP_FAILED:IDictionary.OFFLINE)}var g=new jQuery.Deferred,b=KindleStringUtilities.replaceAccentedChars(b);word=h(b);(b=word.replace("'","%27"))?KindleModuleManager.getModuleSync(KindleModuleManager.NETWORK).isOnline(6E4)!==!1?KindleModuleManager.getModuleSync(KindleModuleManager.SERVICE_CLIENT).getWordDefinition(b).then(c,
a):g.reject(IDictionary.OFFLINE):g.reject(IDictionary.NOT_FOUND);return g.promise()};return(new jQuery.Deferred).resolve(c).promise()}
var DictionaryListManager=function(){function h(e){try{var d=JSON.stringify(e);window.localStorage.setItem("DL",d);j=e}catch(c){}}var j;return{getDictionaryList:function(){if(j===void 0){var e=window.localStorage.getItem("DL");if(e===null)j=[];else try{j=JSON.parse(e)}catch(d){j=[]}}return j},setDictionaryList:h,increasePriority:function(e){var d=-1;if(j.some(function(b,c){if(b.asin===e)return d=c,!0})){var c=j[d];j.splice(d,1);j.unshift(c);h(j)}},lookupDictionary:function(e){var d;j.some(function(c){if(c.asin===
e)return d=c,!0});return d}}}(),KindleDictionaryService=function(){return{getDefinition:function(h){h.dictionary=h.dictionary||"B003WUYRGI";return $.ajax({url:"/dict/getDefinition?asin="+h.dictionary+"&word="+h.word,dataType:"json"})},getDictionaryList:function(){return $.ajax({url:"/dict/getDictionaries",dataType:"json"})}}}(),KindleDictionaryManager=function(){function h(b,c){var a=DictionaryListManager.lookupDictionary(c),d;a&&a.localeFrom?(d=a.localeFrom,a.localeTo&&a.localeFrom!==a.localeTo&&
(d+=":"+a.localeTo)):d="Unknown";b.dictionaryLanguage=d;b.dictionaryName=a?a.title:"Dictionary";return b}function j(b){var c,a=b.length>=5?5:2;DictionaryListManager.getDictionaryList().some(function(d){if(typeof d.localeFrom==="string"&&d.localeFrom.substr(0,a)===b)return c=d,!0});return c}var e,d={isKiDS:!0},c={lookup:function(b){return function(){var c=$.Deferred(),a={word:b.word},g;if(b.dictionary)a.dictionary=b.dictionary,h(d,a.dictionary),c.resolve(a);else{var e;if(e=b.language)g=b.language,
e=j(g),!e&&g.length>=5&&(e=j(g.substr(0,2))),e=g=e;e?(a.dictionary=g.asin,h(d,a.dictionary),c.resolve(a)):(h(d),c.reject(IDictionary.NOT_FOUND,d))}return c.promise()}().pipe(KindleDictionaryService.getDefinition).pipe(function(c){var a=$.Deferred();if(c&&c.asin){h(c,c.asin);if(!c.definitions||c.definitions.length<=0)h(d,c.asin),a.reject(IDictionary.NOT_FOUND,d);b.dictionary&&DictionaryListManager.increasePriority(b.dictionary);c.isKiDS=!0;a.resolve(c)}else a.reject(IDictionary.NOT_FOUND,d);return a.promise()},
function(b){return $.Deferred().reject(b,d)})},getDictionaryList:DictionaryListManager.getDictionaryList,isLanguageSupported:function(b){return!!j(b.substr(0,2))},getDictionaryForLanguage:j,clearContext:function(){}};return{initialize:function(){if(!e){e=$.Deferred();var b=DictionaryListManager.getDictionaryList();b.length&&e.resolve(c);KindleDictionaryService.getDictionaryList().then(function(d){var a=!1;b=DictionaryListManager.getDictionaryList();d.dictionaries.forEach(function(c){DictionaryListManager.lookupDictionary(c.asin)||
(b.push(c),a=!0)});a&&DictionaryListManager.setDictionaryList(b);e.resolve(c)},function(){e.resolve(c)})}return e.promise()},setGetContextCallback:function(){}}}(),KindleLibraryBookCover=function(){function h(){a||(a=KindleHostDeviceDetector.isiPad()?b:c);return a}function j(a){f||(f=d,f=f.replace("{width}",h().width),f=f.replace("{height}",h().height));var b=f;return b=b.replace("{asin}",a)}function e(a){var b=$.Deferred(),c=new XMLHttpRequest;c.open("GET",a);c.responseType="arraybuffer";c.onload=
function(){var a=c.response,d,g;if(a){if(KindleHostDeviceDetector.hasArrayLikeApply())try{d=[],g=new Uint8Array(a),d.push(String.fromCharCode.apply(null,g))}catch(f){d=null}if(!d){d=[];g=new Uint8Array(a);for(a=0;a<g.length;a++)d.push(String.fromCharCode(g[a]))}d="data:image/jpeg;base64,"+KindleO_Aaa.o_aaa(d.join(""));b.resolve(d)}else b.reject()};c.onerror=function(){b.reject(c)};c.send();return b.promise()}var d="https://images-na.ssl-images-amazon.com/images/P/{asin}.01._SX{width}_SY{height}_TTXW_SCLZZZZZZZ_.jpg",
c={width:255,height:255},b={width:255,height:255},f=null,a=null;return{getBookCoverUrl:j,getOfflineCover:function(a){a=j(a);return KindleHostDeviceDetector.isMSEdge()?KindleImageUtil.getDataUriFromImage(a,"image/jpeg"):e(a)}}}(),ResourceBundle;
function KindleReaderUIFactory(){function h(){var a=[{buttonText:ResourceBundle.getLocalizedString("k_R_feature_not_available_dialog_buy_btn"),callback:function(){Qa({from:Kindle.SampleToDetailPageButton.FeatureNotAvailable});R.emit("Reader::Sample::Buy::"+(qa?"Owned":"NotOwned")+"::FeatureUnavailable",{breakdown:["Partner"]})}},{buttonText:ResourceBundle.getLocalizedString("k_common_close_button"),callback:null}],b=ResourceBundle.getLocalizedString("k_R_feature_not_available_dialog_title"),c=ResourceBundle.getLocalizedString("k_R_feature_not_available_dialog_text");
KindleMessageDialog.open(b,c,null,null,a)}function j(){Ha||(Q.pauseDownloading(),Ha=!0)}function e(){Ha&&(Q.resumeDownloading(),Ha=!1)}function d(a){var b=s();KindleModuleManager.getModule(KindleModuleManager.DB_CLIENT).done(function(c){c.getAppDb().updateMaxPosition(Q.getAsin(),b,a)})}function c(a){if(!T.selection)return!1;KindleReaderSelectionRenderer.clearSelection();KindleReaderContextMenu.hide();ReaderSitbHighlight.clear();a.newValue!==null&&KindleReaderSelectionRenderer.setSelection(a.newValue)}
function b(){fa.setSelection(null);KindleSelectionEvents.resetTap();KindleReaderContextMenu.hide();KindleRenderer.clearSelection()}function f(){return Ca.bookType||va["book-type"]}function a(){return f()===Kindle.BookInfo.PublisherMetadata.COMIC}function g(){return f()===Kindle.BookInfo.PublisherMetadata.CHILDREN}function k(){return!(!Ca.fixedLayout&&!va["fixed-layout"])}function m(){l();F()}function l(){b();ReaderSitbHighlight.render();dictionary.getDictionary().done(function(a){a.clearContext()});
T.rtlPageAdvance?KindleReaderPageArrow.setArrowEnabled(KindleRenderer.hasNextScreen()||ra===Kindle.CONTENT_TYPE.EBSP,KindleRenderer.hasPreviousScreen()):KindleReaderPageArrow.setArrowEnabled(KindleRenderer.hasPreviousScreen(),KindleRenderer.hasNextScreen()||ra===Kindle.CONTENT_TYPE.EBSP);Y();if(T.trackLpr){var a=KindleRenderer.getPagePositionRange();a&&R.getKindleStreamsManager().consumeContent(a.currentTopOfPage,a.currentBottomOfPage);KindleReaderLPRManager.onPageChange(I());cb&&cb()}}function n(){clearTimeout(ia);
if(Ia.length>0){var a=I(),b=Ia.pop();t(a,b);KindleReaderMetrics.reportBackButtonUsage()}Ia.length===0&&KindleReaderControls.setDataActionEnabled(KindleReaderControls.DataActions.Back,!1)}function r(a){clearTimeout(ia);ka.positionFromLocation(a).done(q)}function o(a){clearTimeout(ia);a=Da.positionFromPageNumber(a);q(a)}function q(a){if(ra===Kindle.CONTENT_TYPE.EBSP&&a>=s())u();else{var b=I();b&&(Ia.push(b),Ia=Ia.slice(-8),KindleReaderControls.setDataActionEnabled(KindleReaderControls.DataActions.Back,
!0));t(b,a)}}function t(a,b){KindleReaderMetrics.startGoToMetrics();KindleReaderArrhythmicHeartBeatHandler.cancelCurrentHeartBeat();var c;try{KindleReaderZoomableManager.deactivateZoomable(),j(),c=KindleRenderer.gotoPosition(b)}catch(d){e()}c&&(l(),F(),e())}function s(){var a=0;try{a=KindleRenderer.getMaximumPosition()}catch(b){e(),a=-1}return a}function u(){KindleReaderSampleEnd.open(function(a){a==="buy"&&(Qa({from:Kindle.SampleToDetailPageButton.EndAction}),R.emit("Reader::Sample::Buy::"+(qa?"Owned":
"NotOwned"),{breakdown:["Partner"]}))});R.emit("Reader::Sample::End::"+(qa?"Owned":"NotOwned"),{breakdown:["Partner"]})}function y(a,b){a===(T.rtlPageAdvance?na.LEFT:na.RIGHT)?v(b):x(b)}function v(a){Q.setNetworkAccessed(!1);KindleHostDeviceDetector.isiOS()||Z(!0);ReaderSitbHighlight.clear();KindleReaderZoomableManager.isZoomed()?KindleReaderZoomableManager.gotoNextZoomable():H(a)}function x(a){Q.setNetworkAccessed(!1);KindleHostDeviceDetector.isiOS()||Z(!0);ReaderSitbHighlight.clear();KindleReaderZoomableManager.isZoomed()?
KindleReaderZoomableManager.gotoPreviousZoomable():C(a)}function H(a){function c(){KindleReaderMetrics.endPageTurnTimer(!1);e()}if(db){if(Ha)return!1;KindleHostDeviceDetector.isiOS()&&Z(!0);if((KindleHostDeviceDetector.isMetro()||KindleHostDeviceDetector.isIE())&&!la)U.hideAppBar(),Z(!0),b();if(!Ja){KindleReaderMetrics.startPageTurnTimer(KindleReaderMetrics.NEXT_PAGE,a);if(KindleRenderer.hasNextScreen())KindleReaderArrhythmicHeartBeatHandler.cancelCurrentHeartBeat();else if(ra===Kindle.CONTENT_TYPE.EBSP)return KindleReaderZoomableManager.deactivateZoomable(),
u(),!1;j();if(KindleRenderer.nextScreen())return setTimeout(c,0),l(),F(),KindleReaderZoomableManager.clearZoomables(),!0}return!1}}function C(a){function c(){KindleReaderMetrics.endPageTurnTimer(!1);e()}if(db){if(Ha)return!1;KindleHostDeviceDetector.isiOS()&&Z(!0);if((KindleHostDeviceDetector.isMetro()||KindleHostDeviceDetector.isIE())&&!la)U.hideAppBar(),Z(!0),b();return!Ja&&(KindleReaderMetrics.startPageTurnTimer(KindleReaderMetrics.PREV_PAGE,a),KindleRenderer.hasPreviousScreen()&&KindleReaderArrhythmicHeartBeatHandler.cancelCurrentHeartBeat(),
j(),KindleRenderer.previousScreen())?(setTimeout(c,0),l(),F(),KindleReaderZoomableManager.clearZoomables(),e(),!0):!1}}function I(){var a=KindleRenderer.getPagePositionRange();return a&&a.currentTopOfPage}function z(){function a(){b.resolve(0)}var b=new jQuery.Deferred;KindleModuleManager.getModuleList([X.BOOK_CONTEXT,X.BOOK_METADATA]).then(function(c){var d=c[X.BOOK_CONTEXT].srl||c[X.BOOK_METADATA].positions.srl;ba.position>=0?b.resolve(ba.position):ba.location>=0?ka.positionFromLocation(ba.location).done(b.resolve):
T.trackLpr?KindleModuleManager.getModule(X.LPR_MANAGER).then(function(a){a=a.getStartReadingPosition();a.lastTimeRead!==KindleReaderLPRManager.NEVER?(d=a.lastPositionRead,b.resolve(d)):Ka.done(function(){if(Q.getFurthestPositionReadData().position!==Q.UNKNOWN_FPR)d=Q.getFurthestPositionReadData().position;b.resolve(d)})},a):b.resolve(d)},a);return b.promise()}function B(){KindleSpinner.hide();l();F();Ja=!1;KindleReaderZoomableManager.clearZoomables();KindleReaderZoomableManager.isZoomed()&&KindleReaderZoomableManager.activateZoomableOnPageTurn()}
function w(a){function b(){if(wa.pageNumbers)return Da.getMaxPageNumberLabel()}function c(){if(wa.location)return e}function g(){if(wa.pageNumbers)return Da.getPageNumberRanges()}var e,h=KindleModuleManager.getModuleSync(X.BOOK_METADATA);ka=Q.getLocationConverter();KindleModuleManager.registerModule(Kindle.MODULE.LOCATION_CONVERTER,ka);KindleReaderMetrics.setBookType(a,Q.isContentScrambled());if(wa.location)h.locationsInfo&&h.locationsInfo.numOfLocations?(KindleReaderLocationBar.setMinMaxLocation(1,
h.locationsInfo.numOfLocations),e=h.locationsInfo.numOfLocations,KindleReaderImmersiveFooter.setMaxLocation(e),ka.locationFromPosition(KindleRenderer.getMinimumPosition()).done(function(a){KindleReaderLocationBar.setMinMaxLocation(a,h.locationsInfo.numOfLocations)})):$.when(ka.locationFromPosition(KindleRenderer.getMinimumPosition()),ka.locationFromPosition(KindleRenderer.getMaximumPosition())).done(function(a,b){KindleReaderLocationBar.setMinMaxLocation(a,b);e=b;KindleReaderImmersiveFooter.setMaxLocation(e)});
(function(){KindleReaderGoToMenu.bookIsReady({gotoUserLocation:r,gotoPosition:q,gotoPage:o,getMaxPage:b,getPageNumberRanges:g,getMaxUserLocation:c,openBookmarks:function(){ua(KindleReaderAnnotationManager.BOOKMARK)}},Q,R)})();KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).getAppDb();KindleReaderSearchBox.setEnabled(T.searchable);KindleReaderControls.setDataActionEnabled(KindleReaderControls.DataActions.ShowGoTo,!0);KindleReaderControls.setDataActionEnabled(KindleReaderControls.DataActions.ShowSettings,
T.viewSettings);KindleReaderControls.setDataActionEnabled(KindleReaderControls.DataActions.Back,!1);KindleReaderControls.setDataActionEnabled(KindleReaderControls.DataActions.Bookmark,T.bookmarks);KindleReaderControls.setDataActionEnabled(KindleReaderControls.DataActions.ShowNotes,T.annotations);KindleReaderControls.setDataActionEnabled(KindleReaderControls.DataActions.Sync,!0);KindleHostDeviceDetector.isMetro()&&KindleReaderControls.setDataActionEnabled(KindleReaderControls.DataActions.PinToStart,
!0);ra===Kindle.CONTENT_TYPE.EBOK&&KindleModuleManager.getModule(X.ANNOTATION_MANAGER).done(Tb);if(T.trackLpr){d(function(){});var k=KindleModuleManager.getModuleSync(X.LPR_MANAGER),l=R.getKindleStreamsManager(),m={};Q.getMetadata(function(a){var b=Q.getRefEmId();m={contentType:a.sample?Kindle.CONTENT_TYPE.EBSP:Kindle.CONTENT_TYPE.EBOK,metadata:{},asin:a.asin,embeddedId:b,srl:a.positions.srl,erl:a.endPosition,bookLength:a.endPosition}});l.openBook(m);Ka.done(function(){k.onReadingStart(Q.getFurthestPositionReadData(),
KindleRenderer.getPagePositionRange(),ka,Oa);cb=KindleReaderArrhythmicHeartBeatHandler.onReadingStart(Q.getAsin(),Q.getRefEmId(),Q.getKindleSessionId(),k.getLastPositionRead,T.trackLpr,Q.getBookType())})}Y();B();U.onRendererLoaded(qa);var s=(l=Q.isNetworkAccessed())?"RemoteContent":"LocalContent";R.endSubTimer(ma,"RendererLoaded");R.renameSubTimer(ma,"RendererLoaded","RendererLoaded::"+s);R.endSubTimer(ma,"ClickToGlass");R.renameSubTimer(ma,"ClickToGlass","ClickToGlass::"+s);a={screenOrientation:La,
contentType:ra,bookType:a,isOwned:qa,publisherBookType:f(),isOnline:Q.isOpenedOnline(),isContentScrambled:Q.isContentScrambled(),isNetworkAccessed:l,clickToGlassTimer:R.getSubTimer(ma,"ClickToGlass::"+s),metadataLoadedTimer:R.getSubTimer(ma,"MetadataLoaded::"+s),rendererLoadedTimer:R.getSubTimer(ma,"RendererLoaded::"+s)};KindleReaderMetrics.reportBookOpenSuccess(a);eb.resolve(!0)}function E(){R.startSubTimer(ma,"RendererLoaded");try{ka=Q.getLocationConverter();var a={version:"2.0",containerId:"kindleReader_content",
bookInfo:Q,startingPositionDfd:z()},b=J();$.extend(b,G());$.extend(b,V());$.extend(b,da());$.extend(b,W());$.extend(b,ca());$.extend(b,{});KindleRenderer.initialize(a,b,{statusCallback:D,pageChangeCallback:m,annotationEventCallback:Ub},KindleReaderOverlayManager)}catch(c){e()}}function K(){function a(){if(fb)gb=!0;else{gb=!1;var b=vb,c=ca();(!c.columns||!(c.columns.num===b.columns.num&&c.columns.gap===b.columns.gap))&&KindleRenderer.updateSettings(c);KindleRenderer.onWindowResize()}}(Wa.state()!==
"pending"||!KindleHostDeviceDetector.isMetro())&&Wa.done(a)}function D(a){var c=Q&&Q.isNetworkAccessed();if(a.status===KindleRenderer.STATUS_LOADING||a.status===KindleRenderer.STATUS_PAGINATING)Ja=!0,b(),KindleSpinner.show(),KindleReaderMetrics.startSpinnerTimer();else if(a.status===KindleRenderer.STATUS_DONE)KindleDeviceCapabilities.useNativeSelection()&&!wb&&!xa&&(Ob(),wb=!0),oa?(KindleReaderMetrics.endGoToMetrics(),KindleReaderMetrics.endSpinnerTimer(c),setTimeout(function(){KindleReaderMetrics.endPageTurnTimer(c)},
0),B(),e()):($.when(Q.getBookInfoDfd()).done(function(){w(Q.getBookType())}),oa=!0,Wa.resolve(),Y());else if(a.status===KindleRenderer.STATUS_ERROR)if(a.errorCode===KindleRenderer.ERROR_LOAD_FAILURE){var d=Kindle.ERROR_CODE.RENDERER_UNKNOWN;if(a&&a.errorMsg.indexOf("Init")>=0)d=Kindle.ERROR_CODE.RENDERER_INIT;else if(a&&a.errorMsg.indexOf("Metadata")>=0)d=Kindle.ERROR_CODE.RENDERER_METADATA;xb(Q,{openError:Kindle.ERROR.LOAD_FAILURE,openSubError:d,asin:ba.asin})}else KindleSpinner.hide(),Ja=!1,KindleReaderMetrics.endGoToMetrics(),
KindleReaderMetrics.endSpinnerTimer(c),setTimeout(function(){KindleReaderMetrics.endPageTurnTimer(c)},0),F(),KindleMessageDialog.open(ResourceBundle.getLocalizedString("k_R_pageLoadError_Title"),ResourceBundle.getLocalizedString("k_R_pageLoadError_Text"),Ra),a.errorCode===KindleRenderer.ERROR_TIMEOUT_WHILE_LOADING_BOOK_CONTENT?KindleReaderMetrics.reportTimeOutMetrics():KindleReaderMetrics.reportContentNotAvailableMetrics()}function M(){if(!KindleHostDeviceDetector.isiOS()||k()){var a=Vb-S.getMargin();
KindleHostDeviceDetector.isiOS()?a=0:k()&&(a=5);$(".kindleReader_pageTurnArea").css("width",a+"%");$("#kindleReader_pageTurnAreaRight").css("left",100-a+"%");$("#kindleReader_center").css("left",a+"%");$("#kindleReader_center").css("right",a+"%");(KindleHostDeviceDetector.isMetro()||KindleHostDeviceDetector.isiOS())&&$("#kindleReader_center").css("width",100-2*a+"%")}}function N(){$("#kindleReader_pageTurnAreaLeft").css("backgroundColor",S.getBodyColor());$("#kindleReader_pageTurnAreaRight").css("backgroundColor",
S.getBodyColor());$("#kindleReader_center").css("backgroundColor",S.getBGColor());$("#kindleReader_title").css("color",S.getTitleColor());$("#kindleReader_immersiveFooter").css("color",S.getTitleColor());ga.css("backgroundColor",S.getBGColor());ga.css("color",S.getFGColor());var a=S.getColorMode()===KINDLE_READER_SETTINGS_COLOR_MODE.BLACK;KindleReaderLocationBar.setLocationBarBlack(a);a=S.getColorMode();KindleReaderPageArrow.setArrowColor(a);KindleMetroReaderButtonOverlay.setColor(a);ReaderImmersiveModeIcon.setIconColor(a)}
function F(){if(!(s()<0)){var a=KindleRenderer.getPagePositionRange().currentTopOfPage;a<0&&(a=0);ya(a).done(function(a){KindleReaderLocationBar.updatePageLabel(a);KindleReaderImmersiveFooter.updateLabel(a)})}}function L(a){var b;if(hb){b=a.originalEvent.detail?a.originalEvent.detail:a;switch(b.which){case 70:if(b[KindleHostDeviceDetector.isMacintosh()?"metaKey":"ctrlKey"]&&T.searchable)Z(!1),KindleReaderSearchBox.setActive(!0),KindleHostDeviceDetector.isMetro()&&setTimeout(KindleReaderSearchBox.setActive,
200),a.preventDefault(),a.stopPropagation()}KindleEventUtil.preventKeyScroll(b)}}function P(a){var b;if(hb){b=a.originalEvent.detail?a.originalEvent.detail:a;if(KindleHostDeviceDetector.isMetro()&&!la)switch(b.which){case 90:KindleHostDeviceDetector.isMetro()&&Xa&&sa();break;case 18:case 164:case 165:case 93:KindleHostDeviceDetector.isMetro()&&sa()}else switch(b.which){case 13:(b=document.activeElement)&&b.id&&!la&&KindleReaderControls.clickElementWithID(b.id);break;case 32:a.shiftKey?x(ja.KEY):v(ja.KEY);
break;case 33:case 38:x(ja.KEY);break;case 37:y(na.LEFT,ja.KEY);break;case 34:case 40:v(ja.KEY);break;case 39:y(na.RIGHT,ja.KEY);break;case 27:KindleReaderZoomableManager.deactivateZoomable();break;case 90:KindleHostDeviceDetector.isMetro()&&Xa&&sa();break;case 18:case 164:case 165:case 93:KindleHostDeviceDetector.isMetro()&&sa()}a.stopPropagation();KindleReaderLocationBar.hidePopup();U.onUserAction()}}function A(a){function b(){x(ja.WHEEL)}function c(){v(ja.WHEEL)}var d=a.originalEvent.wheelDelta||
-1*a.originalEvent.detail;ib&&clearTimeout(ib);ib=d<0?setTimeout(c,100):setTimeout(b,100);a.preventDefault()}function O(){var a=KindleHostDeviceDetector.isMetro(),b=KindleHostDeviceDetector.isIE();KindleReaderPageArrow.initialize(function(a){$("#kindleReader_touchLayer").append(a)},function(c){if(typeof this.isTouchEvent==="undefined"||this.isTouchEvent&&!a&&!b)return y(na.LEFT,ja.ARROW),c&&c.stopImmediatePropagation&&c.stopImmediatePropagation(),!1},function(c){if(typeof this.isTouchEvent==="undefined"||
this.isTouchEvent&&!a&&!b)return y(na.RIGHT,ja.ARROW),c&&c.stopImmediatePropagation&&c.stopImmediatePropagation(),!1},T.rtlPageAdvance)}function J(){var a={},b=S.getFontSize();a.fontSizes=[b*0.5,b*0.75,b,b*1.2,b*1.4,b*1.6,b*1.8];KindleHostDeviceDetector.isMetro()&&!xa&&(a.fontSizes[0]=b,a.fontSizes[1]=b);a.fontSizeUnits="px";a.glyphScale=S.getGlyphScale();a.lineHeight=S.getLineHeight();return a}function G(){var a={};a.margin=S.getMargin();return a}function V(){var a={};a.backgroundColor=S.getBGColor();
a.fontColor=S.getFGColor();a.highlightColor=S.getHighlightColor();a.selectionColor=S.getSelectionColor();a.insertBgColor=S.getInsertBGColor();return a}function da(){var a={},b=S.getHighlightColor(),c=S.getSearchBGColor(),d=S.getSearchBorderColor();KindleDeviceCapabilities.useCSSRegions()&&!xa?(a[KindleReaderAnnotationManager.HIGHLIGHT]={htmlElementTag:"mark",className:"highlight",style:"color: inherit; background-color: "+b+";"},a[KindleReaderAnnotationManager.NOTE]={htmlElementTag:"mark",className:"note",
style:"position: relative; display: inline-block; width: 0; height: 0; vertical-align: text-top;"},a[KindleReaderAnnotationManager.NOTE_ICON]={className:"note-icon",style:"position: absolute; left: 0; top: 0; width: 30px; height: 30px; background: url("+yb+") no-repeat;"},KindleHostDeviceDetector.isMetro()||(a[KindleReaderOverlayManager.SEARCH_RESULT]={htmlElementTag:"mark",className:"search-result",style:"margin-left: -3px; padding-left: 2px; padding-right: 2px; border-radius: 6px; color: inherit; background-color: "+
c+"; border: 1px solid "+d+";"})):(a[KindleReaderAnnotationManager.NOTE]={className:"amazon-note",style:"position: absolute; width: 10px; height: 10px; background-image: url('"+yb+"'); cursor: pointer; margin-top: 0px; margin-left:-2px;",drawingType:KindleRendererAnnotationRenderer.DRAW_AFTER},a[KindleReaderAnnotationManager.HIGHLIGHT]={className:"amazon-highlight",style:"position: absolute; z-index: -10; background-color: "+b,drawingType:KindleRendererAnnotationRenderer.DRAW_OVER},b=S.getSelectionColor(),
a[KindleReaderOverlayManager.SELECTION]={className:"amazon-selection",style:"position: absolute; z-index: -9; background-color: "+b,drawingType:KindleRendererAnnotationRenderer.DRAW_OVER},a[KindleReaderOverlayManager.SEARCH_RESULT]={className:"amazon-search",style:"position: absolute; z-index: -9; border-radius: 6px; background-color: "+c+"; border: 1px solid "+d+"; margin-left: -2px; padding-right: 2px;",drawingType:KindleRendererAnnotationRenderer.DRAW_OVER});return{annotationStyles:a}}function W(){var a=
{};a[KindleReaderAnnotationManager.NOTE]={clickable:!0};a[KindleReaderAnnotationManager.HIGHLIGHT]={clickable:!1};a[KindleReaderAnnotationManager.POPULAR_HIGHLIGHT]={clickable:!0};a[KindleReaderOverlayManager.SELECTION]={clickable:!1};a[KindleReaderOverlayManager.SEARCH_RESULT]={clickable:!1};return{annotationClick:a}}function ca(){var a={};if(T.columns>1){var b=1,c=0;S.getShowColumns()==="true"?(KindleHostDeviceDetector.isTablet()?window.outerWidth===0&&window.outerHeight===0?window.innerWidth>window.innerHeight&&
(b=2):window.outerWidth>window.outerHeight&&(b=2):$("#kindleReader_content").width()>950&&(b=2),b=Math.min(b,T.columns),b=Math.max(b,1)):S.getShowColumns()==="on"&&(b=Math.min(2,T.columns));b>1&&(c=(22-S.getMargin())*0.666667+2,c=Math.round($("#kindleReader_content").width()*c/100));a.columns={num:b,gap:c};KindleReaderMetrics.setColumnCount(b)}else a.columns={num:1,gap:0};return vb=a}function ea(a){ha(a);S.save()}function ha(a){var b={},c=S.getFontSize()!==a.getFontSize(),d=S.getMargin()!==a.getMargin(),
g=S.getColorMode()!==a.getColorMode(),f=S.getShowColumns()!==a.getShowColumns(),e=S.getShowLocations()!==a.getShowLocations();S.copy(a);c&&$.extend(b,J());d&&($.extend(b,G()),M());g&&($.extend(b,V()),$.extend(b,da()),N());if(f){var h=S.getShowColumns()==="true";R.emit(h?"Reader::ColumnModeChanged::Auto":"Reader::ColumnModeChanged::One")}e&&KindleReaderImmersiveFooter.enable(a.getShowLocations());(f||d)&&$.extend(b,ca());if((KindleHostDeviceDetector.isMetro()||KindleHostDeviceDetector.isIE11())&&g&&
!c&&!d&&!f)document.getElementById("kindleReader_center").style.visibility="hidden",setTimeout(function(){document.getElementById("kindleReader_center").style.visibility="visible"},0);KindleRenderer.updateSettings(b)}function aa(){var a=R.startMetrics("Reader::UnoptimizedBookOpen");KindleUnoptimizedFormatDialog.open(function(b){b?(R.increaseSubCounter(a,"Continue",1),R.endMetrics(a),Sa.resolve(!0)):(R.increaseSubCounter(a,"Cancel",1),R.endMetrics(a),Sa.resolve(!1),KindleRenderer.shutdown(),jb())})}
function Aa(a){return xa=a.indexOf(Wb)>=0}function Ba(a){Aa(a)&&KindleHostDeviceDetector.hasCanvasPerformanceProblem()?aa(a):Sa.resolve(!0)}function Oa(a){function b(){KindleMessageDialog.showError(Kindle.ERROR.SYNC_FAILED)}KindleReaderSyncPositionDialog.open(a,function(c){switch(c){case KindleReaderSyncPositionDialog.USER_RESPONSES.SYNC:q(a.fprPosition);R.emit("Reader::SyncLPR");break;case KindleReaderSyncPositionDialog.USER_RESPONSES.RESET:Ea.resetLPR({asin:Q.getAsin(),kindleSessionId:Q.getKindleSessionId(),
position:a.currentPosition,positionType:Q.getBookType(),localTimeOffset:KindleModuleManager.getModuleSync(KindleModuleManager.RESOURCE_BUNDLE).getLocalTimeOffset(),refEmId:Q.getRefEmId()}).fail(b);R.emit("Reader::ResetLPR");break;case KindleReaderSyncPositionDialog.USER_RESPONSES.CANCEL:R.emit("Reader::SyncLPRCancel")}})}function Ua(){function a(b){var c=b.lastPageReadData,d=I();$.when(ya(d),ya(c.position)).done(function(a,b){b.loc>a.loc?(Oa({currentLocation:a.loc,currentPage:a.pageNumber,currentPosition:d,
fprPosition:c.position,fprLocation:b.loc,fprPage:b.pageNumber,fprDevice:c.deviceName,fprDateTime:c.syncTime}),KindleReaderLPRManager.updateFprSyncTime(c)):KindleMessageDialog.open(ResourceBundle.getLocalizedString("k_R_syncPosition_title"),ResourceBundle.getLocalizedString("k_R_syncPosition_alreadyFurthest_Text"))})}function b(){KindleMessageDialog.showError(Kindle.ERROR.SYNC_FAILED)}clearTimeout(ia);oa&&Ea&&(KindleModuleManager.getModuleSync(X.BOOK_METADATA),Ea.getLPR(Q.getAsin(),Q.getRefEmId()).then(a,
b))}function Ga(){KindleReaderBookmarkOverlay.initialize(function(a){ga.append(a);KindleReaderControls.registerComponent(a)})}function Y(){if(oa&&KindleModuleManager.isModuleInitialized(X.ANNOTATION_MANAGER)){var a=KindleModuleManager.getModuleSync(X.ANNOTATION_MANAGER);za=!1;var b=KindleRenderer.getPagePositionRange();if(b)for(var b=a.getAnnotationsInRange(b.currentTopOfPage,b.currentBottomOfPage),c=0;c<b.length;c+=1)if(b[c].type===a.BOOKMARK){za=!0;break}pa()}}function Pa(){function a(){}clearTimeout(ia);
if(T.bookmarks&&oa&&KindleModuleManager.isModuleInitialized(X.ANNOTATION_MANAGER)){var b=KindleModuleManager.getModuleSync(X.ANNOTATION_MANAGER),c=KindleRenderer.getPagePositionRange();if(za)for(var c=b.getAnnotationsInRange(c.currentTopOfPage,c.currentBottomOfPage),d=0;d<c.length;d+=1)c[d].type===KindleReaderAnnotationManager.BOOKMARK&&b.deleteAnnotations([c[d]]).done(a);else b.createBookmark(c.currentTopOfPage).done(a);za=!za;pa()}}function pa(){za?$("#kindleReader_bookmark").addClass("hasBookmark"):
$("#kindleReader_bookmark").removeClass("hasBookmark");KindleHostDeviceDetector.isMetro()?KindleMetroReaderButtonOverlay.refreshBookmarkImage(za):KindleReaderBookmarkOverlay.setIsBookmarked(za)}function ua(a){oa&&KindleModuleManager.isModuleInitialized(X.ANNOTATION_MANAGER)&&(Z(!1),clearTimeout(ia),ReaderAnnotationsDisplay.show(I(),a))}function Va(){ReaderImmersiveModeIcon.initialize(function(a){ga.append(a);KindleReaderControls.registerComponent(a);KindleReaderControls.setDataActionEnabled(KindleReaderControls.DataActions.ImmersiveIcon,
!0)})}function Z(a){function b(){Z(!0)}ia&&(clearTimeout(ia),ia=null);a===la||Fa===Kindle.AutoHideOption.Off||(la=!!a,Q&&(Q.pauseDownloading()||1)&&setTimeout(Q.resumeDownloading,2E3),ga.hasClass("immersive_mode")!==la&&ga.toggleClass("immersive_mode",la),KindleHostDeviceDetector.isiOS()&&(KindleReaderBookmarkOverlay.setImmersiveMode(la),KindleReaderLocationBar.setImmersiveMode(la)),la?(KindleMetroReaderAppBarOverlay.remove(),KindleFreeTrialHelper.freeTrialMessageImmersiveSlideUp()):(KindleMetroReaderAppBarOverlay.show(b),
KindleFreeTrialHelper.freeTrialMessageImmersiveSlideDown()),la&&KindleReaderSearchBox.setActive(!1))}function sa(){Z(!la)}function Ib(){function a(){Z(!1)}KindleReaderImmersiveModeExit.initialize(function(b){ga.append(b);$(".immersive_exit").hover(a)},a)}function Jb(){Ja||(Z(!1),clearTimeout(ia),KindleHostDeviceDetector.isMetro()?KindleMetroReaderViewSettings.open(S,T,ea):KindleReaderSettingsDialog.open(S,T,ea))}function Mb(){var a=$("#kindleReader_content");return function(b,c,d){return Ta.getBookPositionAt(b-
a.offset().left,c-a.offset().top,d)}}function Lb(){var a,b={};a=document.createElement("div");a.id="kindleReader_touchLayer";var c=$(a);ga.append(a);b.getBookPositionAt=Mb();b.selectionStateManager=fa;KindleHostDeviceDetector.isIE11()&&c.css("background-color","rgba(255,255,255,0.005)");KindleHostDeviceDetector.isMetro()?c.bind("mousedown",ab):window.oncontextmenu=function(){return!1};if(!KindleHostDeviceDetector.isiOS())c.click(Za),c.keyup(P),c.keydown(L),c.dblclick($a),c.bind("mousewheel",A),b.mouseDownEventSource=
a,b.mouseEventSource=a,b.mouseClickOutsideEventSource=document.getElementById("kindleReader_book_container");if(KindleHostDeviceDetector.isTouchDevice())c.swipeLeft(sb,{touchOnly:!0,distance:25}),c.swipeRight(qb,{touchOnly:!0,distance:25}),c.tap(rb),KindleHostDeviceDetector.isiOS()&&(c.doubletap(Rb),c.bind("touchstart",Nb)),b.touchEventSource=a,b.selectionHandleLeft=KindleReaderSelectionRenderer.getGrabHandleBegin(),b.selectionHandleRight=KindleReaderSelectionRenderer.getGrabHandleEnd();KindleSelectionEvents.initialize(b)}
function Kb(){window.oncontextmenu=function(){return!1};var a=$(document.createElement("div"));a.attr("id","kindleReader_touchArea");a.swipeLeft(sb,{touchOnly:!0,distance:25});a.swipeRight(qb,{touchOnly:!0,distance:25});var b=$(document.createElement("div"));b.attr("id","kindleReader_touchLayer");b.click(Za);b.bind("dblclick",$a);b.tap(rb);b.bind("mousewheel",A);b.bind("mousedown",ab);b.css("z-index",50);a.append(b);$("#kindleReader_center").appendTo(a);ga.append(a)}function Ob(){for(var a=document.getElementsByTagName("iframe"),
b,c=0;c<a.length;c++)b=$(a[c]),b.click(Za),b.bind("dblclick",$a),b.bind("mousewheel",A),b.bind("mousedown",ab),a[c].addEventListener("select",Qb,!1),a[c].contentWindow.document.addEventListener("selectionchange",Pb,!1)}function Pb(a){kb&&a.target.selection&&(a.target.selection.createRange().text.length!==0&&$(".kindle_menu").css("left","-1000px"),kb=!1)}function Sb(){var a=KindleRenderer.getPagePositionRange();return KindleReaderAnnotationManager.getContext(a.currentTopOfPage,a.currentBottomOfPage)}
function tb(a){function c(){b();KindleRenderer.reloadAnnotations()}function d(){KindleReaderAnnotationManager.deleteAnnotations(m).done(c)}function g(){KindleReaderAnnotationManager.createHighlight(l.start,l.end,I()).done(c)}function f(){KindleReaderEditNoteDialog.open(null,function(a){a&&KindleReaderAnnotationManager.createNote(l.start,l.end,I(),a).done(c)},null,function(){b()})}function e(){ub(s[0].start)}function k(){var b=KindlePopupMenu,c=m.length===1&&m[0].start<=l.start&&m[0].end>=l.end,u=
l&&!c?b.ITEM_ENABLED:b.ITEM_HIDDEN,n=c?b.ITEM_ENABLED:b.ITEM_HIDDEN,v=l&&s.length===0?b.ITEM_ENABLED:b.ITEM_HIDDEN,x=l&&s.length>0?b.ITEM_ENABLED:b.ITEM_HIDDEN,y=l.start===l.end?b.ITEM_ENABLED:b.ITEM_HIDDEN,b=[],c=[],q=ra===Kindle.CONTENT_TYPE.EBSP;c[KindleReaderContextMenu.CREATE_HIGHLIGHT]=q?h:g;c[KindleReaderContextMenu.CREATE_NOTE]=q?h:f;c[KindleReaderContextMenu.EDIT_NOTE]=e;c[KindleReaderContextMenu.DELETE_HIGHLIGHT]=d;b[KindleReaderContextMenu.CREATE_HIGHLIGHT]=u;b[KindleReaderContextMenu.CREATE_NOTE]=
v;b[KindleReaderContextMenu.EDIT_NOTE]=x;b[KindleReaderContextMenu.DELETE_HIGHLIGHT]=n;b[KindleReaderContextMenu.DEFINITION]=o&&y;var n=a,u=n.selection.lowerBounds||KindleListUtilities.first(Ta.getBounds(n.selection.end)),n=n.selection.upperBounds||KindleListUtilities.last(Ta.getBounds(n.selection.start)),v=$("#kindleReader_content").offset(),x=KindleHostDeviceDetector.isiOS()?80:0,t=KindleHostDeviceDetector.isiOS()||KindleHostDeviceDetector.isMetro()||KindleHostDeviceDetector.isIE()?25:0,y=KindleHostDeviceDetector.isiOS()||
KindleHostDeviceDetector.isMetro()||KindleHostDeviceDetector.isIE()?35:0,q=u.right+v.left,u=u.bottom+v.top+t;$(window).height()-u>x?u=[q,u]:(q=n.left+v.left-y,u=n.top+v.top-x-y,u=u>0?[q,u]:"center");KindleReaderContextMenu.show(b,u,c,l,j)}var l=fa.getSelection()||a.selection,m=l?KindleReaderAnnotationManager.getAnnotationsInRange(l.start,l.end,KindleReaderAnnotationManager.HIGHLIGHT):[],s=l?KindleReaderAnnotationManager.getAnnotationsInRange(l.start,l.end,KindleReaderAnnotationManager.NOTE):[],o,
j=KindleModuleManager.getModuleSync(KindleModuleManager.RESOURCE_BUNDLE).getUserLanguageCulture();dictionary.getDictionary().then(function(a){o=a.isLanguageSupported(j);k();KindleHostDeviceDetector.isiOS()?ga.bind("touchstart.contextMenu",function(){KindleReaderContextMenu.hide();ga.unbind("touchstart.contextMenu")}):ga.bind("mousedown.contextMenu",function(){KindleReaderContextMenu.hide();ga.unbind("mousedown.contextMenu")})})}function ub(a){function c(){b();KindleReaderAnnotationManager.deleteAnnotations([d]).done(KindleRenderer.reloadAnnotations);
g.resolve("Delete")}var d=KindleReaderAnnotationManager.getAnnotation(KindleReaderAnnotationManager.NOTE,a),g=new jQuery.Deferred;KindleReaderEditNoteDialog.open(d.note,function(a){a?(KindleReaderAnnotationManager.modifyNote(d.start,I(),a),g.resolve("Save")):c()},c,function(){b();g.resolve("Cancel")});return g.promise()}function sb(){fa.getSelection()||y(na.RIGHT,ja.SWIPE);U.onUserAction()}function qb(){fa.getSelection()||y(na.LEFT,ja.SWIPE);U.onUserAction()}function Za(a){U.onUserAction();if(KindleHostDeviceDetector.isMetro()&&
(U.hideAppBar(),!xa))return;var b=a.pageX-$("#kindleReader_content").offset().left,a=a.pageY-$("#kindleReader_content").offset().top;oa&&b>0&&a>0&&!fa.getSelection()&&(Z(!0),bb(b,a))}function $a(a){ta&&(clearTimeout(ta),ta=null);var b=a.pageX-$("#kindleReader_content").offset().left,a=a.pageY-$("#kindleReader_content").offset().top;oa&&b>0&&a>0&&!fa.getSelection()&&KindleReaderZoomableManager.activateZoomableAtPosition(b,a);U.onUserAction()}function Nb(a){var b=a.originalEvent.touches[0].pageX-$("#kindleReader_content").offset().left,
a=a.originalEvent.touches[0].pageY-$("#kindleReader_content").offset().top;if(!oa||!(b>0&&a>0&&!fa.getSelection())||!bb(b,a))U.onUserAction()}function Rb(){var a=this.x-$("#kindleReader_content").offset().left,b=this.y-$("#kindleReader_content").offset().top;oa&&a>0&&b>0&&!fa.getSelection()&&KindleReaderZoomableManager.activateZoomableAtPosition(a,b);ta&&(clearTimeout(ta),ta=null);U.onUserAction()}function rb(){function a(){if(g<=0)return y(na.LEFT,h),!0;else if(g>=e)return y(na.RIGHT,h),!0;return!1}
function b(){ta=null;if(!oa||!(g>0&&f>0)||!bb(g,f))if(!fa.getSelection()&&(!(!KindleHostDeviceDetector.isMetroSnappedView()&&KindleHostDeviceDetector.isMetro()||KindleHostDeviceDetector.isIE())||!xa))if(g<e/4)y(na.LEFT,h),KindleHostDeviceDetector.isMetro()&&U.hideAppBar();else if(g>e-e/4)y(na.RIGHT,h),KindleHostDeviceDetector.isMetro()&&U.hideAppBar();else if(!KindleReaderContextMenu.wasVisible()&&(sa(),KindleHostDeviceDetector.isMetro()))U.onReaderTapped()}if(!this.isTouchEvent||!(!KindleHostDeviceDetector.isMetroSnappedView()&&
KindleHostDeviceDetector.isMetro()||KindleHostDeviceDetector.isIE())||xa){var c=document.activeElement.id.indexOf("frame")!==-1,d=$("#kindleReader_content"),g=c?this.x:this.x-d.offset().left,f=c?this.y:this.y-d.offset().top,e=d.width(),h=this.isTouchEvent?ja.TAP:ja.ARROW;!ta&&(KindleHostDeviceDetector.isiOS()||KindleHostDeviceDetector.isMetroSnappedView())?ta=setTimeout(b,Xb):this.isTouchEvent?b():KindleHostDeviceDetector.isMetroSnappedView()&&a();U.onUserAction()}}function Qb(){KindleReaderSitbPane.close();
var a=KindleRenderer.getSelection(),b=KindleRenderer.getPagePositionRange();a.start=Math.max(a.start,b.currentTopOfPage);a.end=Math.min(a.end,b.currentBottomOfPage);KindleReaderContextMenu.hide();tb({selection:a});kb=!0}function ab(a){KindleHostDeviceDetector.isMetro()&&a.which===3&&(U.onReaderTapped(),sa());KindleReaderContextMenu.hide()}function bb(a,b){var c=!1;if(KindleDeviceCapabilities.useNativeSelection()&&!xa)return!1;if(KindleHostDeviceDetector.isIE()){var d=$("#kindleReader_touchLayer");
try{d.hide(),c=KindleRenderer.handleClick(a,b)}finally{d.show()}}else c=KindleRenderer.handleClick(a,b);return c}function Yb(){Z(!1);clearTimeout(ia);var a={};if(KindleModuleManager.isModuleInitialized(X.ANNOTATION_MANAGER)){var b=KindleModuleManager.getModuleSync(X.ANNOTATION_MANAGER),b=b.getAnnotationsInRange(0,KindleRenderer.getMaximumPosition(),b.BOOKMARK);a[KindleReaderGoToMenu.MenuItemNames.bookmark]=b.length>0?KindlePopupMenu.ITEM_ENABLED:KindlePopupMenu.ITEM_DISABLED}if(wa.pageNumbers)a[KindleReaderGoToMenu.MenuItemNames.page]=
KindlePopupMenu.ITEM_ENABLED;a&&KindleReaderGoToMenu.updateGoToMenu(a);KindleReaderGoToMenu.show()}function jb(a){R.emit("Reader::ClosedBy::"+(a||"Unknown"));qa||ba.returnToLibrary?zb():(Qa({from:Kindle.SampleToDetailPageButton.Close}),lb=!0)}function Zb(){jb("Reader")}function $b(){jb("AppBar")}function ac(){clearTimeout(ia);U.pinBookToStart(Q.getAsin())}function bc(){KindleReaderHeaderBar.initialize(function(a){ga.append(a);KindleReaderControls.registerComponent(a)},U.isEmbeddedInWebsite())}function cc(){KindleMetroReaderButtonOverlay.initialize(function(a){ga.append(a);
KindleReaderControls.registerComponent(a)})}function dc(){KindleReaderLocationBar.initialize(function(a){a.find("#kindleReader_progressbar_handle").mousedown(function(){clearTimeout(ia)});ga.append(a);KindleReaderControls.registerComponent(a)},function(a){r(a);KindleReaderMetrics.reportScrubberUsage()},T.rtlPageAdvance)}function Ab(){var a=$(Handlebars.templates.KindleReaderBuyButton());KindleReaderControls.registerComponent(a);ga.append(a);setTimeout(function(){var a=$("#kindleReader_Buy_Full_Button").outerWidth();
if(T.rtlPageAdvance){var b=T.rtlPageAdvance?56:0;$("#kindleReader_footer_readerControls_middle").css("right",a+16+69+"px");$("#kindleReader_footer_readerControls_right").css("right",a+b/2+"px")}else b=KindleHostDeviceDetector.isiOS()?30:35,$("#kindleReader_footer_readerControls_middle").css("right",a+b+"px")},0)}function ec(){function a(b){function c(){d?(clearTimeout(d),d=null,c()):d=setTimeout(function(){Xa=!1},200)}var d=null,b=b.originalEvent&&b.originalEvent.detail?b.originalEvent.detail:b;b.key===
"Win"&&(b.type==="keydown"?Xa=!0:b.type==="keyup"&&c())}KindleHostDeviceDetector.isMetro()?$(document).keyup(function(b){a(b);return P(b)}).keydown(function(b){a(b);return L(b)}):$(document).keydown(L).keyup(P);KindleUXComponentManager.registerKeyEventsEnabledCallback(function(a){hb=a})}function fc(){function a(b){clearTimeout(c);b?c=setTimeout(K,b):K();KindleHostDeviceDetector.isMetro()||($("#kindleReader_annotations_pane").height($("body",Kindle.top.document).height()-212),$("#kindleReader_annotations_pane_scrollWrapper").height($("body",
Kindle.top.document).height()-212))}var c;KindleWindowSizeWatcher.setMetricsContext(gc);KindleHostDeviceDetector.isiOS()&&"onorientationchange"in window?($("body",Kindle.top.document).bind("orientationchange",function(){Date.now();a(0)}),$("#kindleReader_content").on("resize",function(){a(0)}),KindleDeviceCapabilities.hasSplitView()&&KindleWindowSizeWatcher.startPolling()):window.onresize=KindleHostDeviceDetector.isMetro()?function(){if(!KindleHostDeviceDetector.isMetroSnappedView()){var c=Bb();La&&
La!==c&&(La=c,KindleReaderMetrics.reportOrientationChange(La))}KindleReaderGoToMenu.onResize();b();a(0)}:function(){a(200)}}function Ub(a,b){function c(){mb=!1;fa.enable()}KindleHostDeviceDetector.isiOS()&&Z(!1);a===KindleReaderAnnotationManager.NOTE&&!mb&&(mb=!0,fa.disable(),ub(b).then(function(a){c();R.emit("Reader::Icon::"+a)},c))}function Cb(){zb()}function Ra(){U.closeReader(Db)}function zb(){KindleRenderer.shutdown();R&&(R.getKindleStreamsManager().closeBook(),R.uploadMetrics(!0),Db=R.startMetrics("App::CloseReader"),
Ya&&(R.setMetricsUploadInterval(Ya),Ya=null));if(T.trackLpr){KindleReaderArrhythmicHeartBeatHandler.onReadingEnd();if(KindleModuleManager.isModuleInitialized(X.LPR_MANAGER)&&KindleModuleManager.isModuleInitialized(KindleModuleManager.SERVICE_CLIENT)){var a=KindleModuleManager.getModuleSync(X.LPR_MANAGER).getLastPositionRead();Ea.doneReading({asin:Q.getAsin(),kindleSessionId:Q.getKindleSessionId(),position:a,positionType:Q.getBookType(),localTimeOffset:KindleModuleManager.getModuleSync(KindleModuleManager.RESOURCE_BUNDLE).getLocalTimeOffset(),
countryCode:KindleModuleManager.getModuleSync(KindleModuleManager.RESOURCE_BUNDLE).getFormatRegion(),refEmId:Q.getRefEmId()})}Q.doneReading()}Ra()}function hc(a){a.queryText&&$("#kindleReader_search_field").val(a.queryText)}function ic(){KindleReaderSearchBox.initialize({onfocus:function(){clearTimeout(ia)}});ReaderSitbManager.initialize(R);ReaderSitbHighlight.initialize(KindleReaderOverlayManager)}function jc(){M();Ga();KindleHostDeviceDetector.isMetro()?cc():(Ib(),KindleHostDeviceDetector.isIE()&&
Va());bc();KindleReaderImmersiveFooter.initialize(R,S.getShowLocations());ic();N();ec();fc();KindleHostDeviceDetector.isiOS()||$(window).focus(function(){Ea.checkTokenConsistency()});if(KindleHostDeviceDetector.isPageVisibilityApiSupported()){var a=KindleHostDeviceDetector.getPageVisibilityApiTerms();document.addEventListener(a.visibilityChange,function(){document[a.hidden]?R.getKindleStreamsManager().hideBook():R.getKindleStreamsManager().showBook();KindleModuleManager.getModuleSync(KindleModuleManager.METRICS_MANAGER).uploadMetrics()},
!1)}else KindleHostDeviceDetector.isiOS()||($(window).focus(function(){R.getKindleStreamsManager().showBook();KindleModuleManager.getModuleSync(KindleModuleManager.METRICS_MANAGER).uploadMetrics()}),$(window).blur(function(){R.getKindleStreamsManager().hideBook();KindleModuleManager.getModuleSync(KindleModuleManager.METRICS_MANAGER).uploadMetrics()}))}function kc(){Q.getDownloadComplete(function(a,b){KindleReaderLocationBar.updateDownloadProgress(KindleReaderLocationBar.DOWNLOAD_IN_PROGRESS,Math.round(100*
Math.min(a,b)/Math.max(1,b)))}).then(function(){KindleReaderLocationBar.updateDownloadProgress(KindleReaderLocationBar.DOWNLOAD_COMPLETED);if(KindleHostDeviceDetector.isMetro())U.onBookDownloadComplete({asin:Q.getAsin()})},function(a){if(a)switch(a){case Kindle.ERROR.OUT_OF_SPACE:case Kindle.ERROR.UNKNOWN_DB_ERROR:KindleReaderLocationBar.updateDownloadProgress(KindleReaderLocationBar.DOWNLOAD_DISK_ERROR);break;case Kindle.ERROR.NETWORK:case Kindle.ERROR.TIMEOUT:KindleReaderLocationBar.updateDownloadProgress(KindleReaderLocationBar.DOWNLOAD_NETWORK_ERROR);
break;case Kindle.CACHING.DISABLED:return}KindleOffline.sendDownloadFailMetric(a,"Reader")})}function Eb(a){Ka.done(function(){if(Q.isUpdated()){var b=ResourceBundle.getLocalizedString("k_L_openBookContentUpgrade_ButtonText");KindleMessageDialog.showError(Kindle.ERROR.CONTENT_UPGRADE,a,b)}else a()})}function lc(b){function c(){Ma||(Ma=new KindleReaderSettings,Ma.reset());a()||g()?Ma.reset():Ma.load();T.showTitle||($("#kindleReader_title").hide(),$("#kindleReader_content").addClass("no_title"),$("#kindleReader_immersiveFooter").hide());
Fa===Kindle.AutoHideOption.Timed&&(ia=setTimeout(function(){Z(!0)},5E3))}if(b&&b.asin)if(b.asin===Kindle.ERROR.OPEN_BOOK_ASIN_NOT_SPECIFIED)U.isEmbeddedInWebsite()&&b.kcrFree?KindleReaderEmbeddedError.open(Kindle.ERROR.OPEN_BOOK_ASIN_NOT_SPECIFIED):KindleMessageDialog.showError(Kindle.ERROR.OPEN_BOOK_ASIN_NOT_SPECIFIED,Ra);else{ba=b;ma=KindleReaderMetrics.startBookOpenTimer();R.startSubTimer(ma,"initialize");KindleHostDeviceDetector.isMetro()&&(La=Bb());ba.readerClass&&!$("body").hasClass(ba.readerClass)&&
$("body").addClass(ba.readerClass);ba.readerAppBar&&ba.readerAppBar==="hide"&&Z(!0);Fa=ba.autoHide;var d;switch(Fa){case Kindle.AutoHideOption.Auto:case Kindle.AutoHideOption.Off:break;case Kindle.AutoHideOption.Timed:if(U.isEmbeddedInWebsite())Fa=Kindle.AutoHideOption.Auto;break;default:Fa=KindleHostDeviceDetector.isiOS()||KindleHostDeviceDetector.isMetro()||U.isEmbeddedInWebsite()?Kindle.AutoHideOption.Auto:Kindle.AutoHideOption.Timed,d="default"}d="Reader::Chrome::AutoHide::"+(d||Fa);R.emit(d,
{breakdown:["Partner"]});ba.closeButton===Kindle.Reader.CloseButtonNone&&KindleReaderControls.setDataActionVisible(KindleReaderControls.DataActions.Close,!1);KindleModuleManager.getModuleSync(Kindle.MODULE.DB_CLIENT).addEventListener(Kindle.ERROR.DB_LINGERING_WRITE,Fb);Gb=ba.standAlone;ba.kcrFree&&Ea.getAuthenticationState()!==Kindle.Service.AuthOK&&KindleReaderControls.setDataActionVisible(KindleReaderControls.DataActions.Sync,!1);Na&&KindleSpinner.show();Q=KindleReaderBookInfoProvider.BookInfo(ba,
KindleModuleManager);R.endSubTimer(ma,"initialize");R.startSubTimer(ma,"ClickToGlass");Ka=Q.startReading(ma,eb);Ka.done(function(b){Ya=R.setMetricsUploadInterval(ba.kcrFree?R.UploadInterval.Short:R.UploadInterval.Default);Q.isBookDownloaded()||kc();mc();nc(ba.asin).done(function(){var d=b.getContext(),e=f();d.canOpen=!0;d.errorCode=null;d.isOnline=b.isOpenedOnline();d.asin=b.getAsin();d.bookType=e&&e.toLowerCase();d.tutorialMaxShowCount=KindleReaderTutorial.getMaxShowCount(d.bookType);d.metadata=
KindleModuleManager.getModuleSync(X.BOOK_METADATA)||{};U.onStartReadingStatus(d);dc();c();d.isSample&&!KindleHostDeviceDetector.isMetro()&&Ab();d.originType==="FreeTrial"&&(KindleBadging.pushAsinForBadgeUpdate(b.getAsin()),KindleFreeTrialHelper.handleFreeTrialExpiration(d.expirationDate,b.getAsin()));KindleHostDeviceDetector.hasCanvasPerformanceProblem()?(Ba(Q.getBookType()),Sa.then(function(a){a&&Eb(E)})):Eb(E);(a()||g())&&(Ca.regionMagnification||va.RegionMagnification)&&setTimeout(function(){KindleReaderTutorial.show(f())},
3E3);ha(Ma)})}).fail(xb);KindleModuleManager.getModule(X.BOOK_METADATA).done(oc);setTimeout(window.focus,0);KindleTouchEventsToggler.isRequired()&&nb.done(function(){KindleTouchEventsToggler.allowTouchEvents()})}}function oc(a){a.title&&($("#kindleReader_title").text(a.title),$("#kindleReader_header_bar_title").text(a.title));a.authorList&&a.authorList.length>0&&(a=KindleAuthor.getDisplayableString(a.authorList),$("#kindleReader_header_bar_author").text(a))}function pc(a){function b(a,d){c.forEach(function(b){a.indexOf(b)!==
-1&&(d[b]=!0)})}var c=["page-spread-left","page-spread-right","facing-page-left","facing-page-right"],d=["RegionMagnification","book-type","cover","fixed-layout","orientation-lock","original-resolution","page-progression-direction","toc","zero-gutter","zero-margin","double-page-spread","facing-page"],g={},f={};a.publisherMetadata&&a.publisherMetadata.length>0&&a.publisherMetadata.forEach(function(a){typeof a!=="string"&&($.isArray(a)?a.forEach(function(a){if($.isArray(a)&&a.length>=2)a[0]==="meta"&&
a[1].hasOwnProperty("content")&&a[1].hasOwnProperty("name")?f[a[1].name]=a[1].content:a[0]==="itemref"&&a[1].hasOwnProperty("properties")&&b(a[1].properties,f)}):Object.keys(a).forEach(function(b){b.substring(0,6)!=="xmlns:"&&(f[b]=a[b])}))});if(f["page-spread-left"]||f["page-spread-right"])f["double-page-spread"]=!0;if(f["facing-page-left"]||f["page-spread-right"])f["facing-page"]=!0;for(var e in f)$.inArray(e,d)>=0&&(g[e]=f[e]);return g}function qc(a){var b=$.extend({},a);Object.keys(b).forEach(function(a){var c=
b[a];if(typeof c==="string"&&(c=c.toLowerCase(),c==="true"||c==="false"))b[a]=c==="true"});return b}function nc(b){var c=new $.Deferred;va={};Ca={};T=new ReaderOptions;$.when(KindleModuleManager.getModule(X.BOOK_CONTEXT),KindleModuleManager.getModule(X.BOOK_METADATA),Q.getBookInfoDfd()).done(function(d,f){var e=Q.getBookType();va=pc(f);f.headerMetadata&&$.extend(Ca,qc(f.headerMetadata));T.rtlPageAdvance=va["page-progression-direction"]==="rtl"||Ca.app_PrimaryWritingMode&&Ca.app_PrimaryWritingMode.endsWith("rl");
d.isSample&&!d.isOwned?T.trackLpr=!1:KindleModuleManager.registerModuleWithDeferred(X.LPR_MANAGER,KindleReaderLPRManager.initialize(b));KindleDeviceCapabilities.useNativeSelection()&&!g()&&!a()&&!Aa(e)?Kb():(Lb(),$("#kindleReader_touchLayer").css("z-index",200));KindleHostDeviceDetector.isiOS()||O();M();if(Aa(e)||k()||!KindleDeviceCapabilities.multiColumnMode())T.columns=1;if(a()||g())T.selection=!1,T.annotations=!1,T.bookmarks=!1,T.viewSettings=!1,T.searchable=!1,T.showTitle=!1;if(va["double-page-spread"]===
!0||va["facing-page"]===!0)T.columns=2;T.bookmarks||(KindleHostDeviceDetector.isMetro()?KindleMetroReaderButtonOverlay.setVisibleBookmark(!1):KindleReaderBookmarkOverlay.setVisible(!1));c.resolve()});return c.promise()}function rc(){function a(c){return function(){b();c.apply(this,arguments)}}var c=ra===Kindle.CONTENT_TYPE.EBSP;KindleEventBroker.subscribe("reader_close",Zb);KindleEventBroker.subscribe("reader_close_appbar",$b);KindleEventBroker.subscribe("reader_back",n);KindleEventBroker.subscribe("reader_show_goto",
a(Yb));KindleEventBroker.subscribe("reader_show_settings",a(Jb));KindleEventBroker.subscribe("reader_bookmark",a(c?h:Pa));KindleEventBroker.subscribe("reader_show_notes",a(c?h:ua));KindleEventBroker.subscribe("reader_sync",a(qa?Ua:h));KindleEventBroker.subscribe("reader_pin_metro",a(ac));KindleEventBroker.subscribe("reader_search",sc);KindleEventBroker.subscribe("reader_open_full_kcr",function(){U.openFullKCR({asin:Q.getAsin()});R.emit("App::Launch::Logo",{breakdown:["Partner"]})});KindleEventBroker.subscribe("reader_buy_full_book",
function(){Qa({from:Kindle.SampleToDetailPageButton.Buy});R.emit("Reader::Sample::Buy::"+(qa?"Owned":"NotOwned")+"::BuyFullVersionButton",{breakdown:["Partner"]})});KindleEventBroker.subscribe("immersive_icon",function(){Z(!1)})}function mc(){KindleModuleManager.getModule(X.BOOK_CONTEXT).done(function(a){qa=a.isOwned;ra=a.contentType;a="";ba.closeButton===Kindle.Reader.CloseButtonAuto&&(a=qa||ba.returnToLibrary?ResourceBundle.getLocalizedString("k_R_toolbar_library_button"):ResourceBundle.getLocalizedString("k_R_toolbar_iOS_sample_close_button"),
KindleReaderHeaderBar.setCloseButtonText(a));ra===Kindle.CONTENT_TYPE.EBOK&&(KindleModuleManager.registerModuleWithDeferred(X.ANNOTATION_MANAGER,KindleReaderAnnotationManager.deferredInitialize(Ka,KindleModuleManager)),KindleModuleManager.getModule(X.ANNOTATION_MANAGER).done(KindleReaderMetrics.notifyAnnotationsReady));rc()})}function xb(a,b){function c(){var b=a.getContext();b.canOpen=!1;b.errorCode=f.errorCode;b.subErrorCode=f.subErrorCode;b.isOnline=a.isOpenedOnline();b.asin=f.asin;U.onStartReadingStatus(b)}
function d(){var a=f.errorCode;f.subErrorCode&&(a={name:f.errorCode,code:f.subErrorCode});return a}var b=b||{},g=a.getContext(),f={errorCode:b.openError||a.getOpenError(),subErrorCode:b.openSubError,asin:b.asin||a.getAsin(),contentType:g&&g.contentType};KindleReaderMetrics.reportBookOpenFailure(f);if(!Hb&&f.errorCode!==KindleModuleManager.ERROR_CODE_CANCEL)if(Hb=!0,Gb){if(f.errorCode===Kindle.ERROR.CONTENT_UNSUPPORTED&&KindleHostDeviceDetector.isMetro())f.errorCode=Kindle.ERROR.CONTENT_UNSUPPORTED_METRO;
g=d();U.isHostControlled()?KindleMessageDialog.showError(g,Ra):U.isEmbeddedInWebsite()&&ba.kcrFree?KindleReaderEmbeddedError.open(f.errorCode):KindleMessageDialog.showError(g,c);KindleSpinner.hide()}else c()}function Fb(a){a.type===Kindle.ERROR.DB_LINGERING_WRITE&&(a.stalled?(KindleFirefoxPromptingDialog.open(),KindleReaderMetrics.reportFirefoxPromptingDialogOpen()):(KindleFirefoxPromptingDialog.close(),KindleReaderMetrics.reportFirefoxPromptingDialogClose(a)))}function Tb(){T.bookmarks&&(KindleReaderControls.setDataActionEnabled(KindleReaderControls.DataActions.Bookmark,
!0),Y());T.annotations&&KindleReaderControls.setDataActionEnabled(KindleReaderControls.DataActions.ShowNotes,!0);KindleRenderer.reloadAnnotations();var a={readerControls:{goToPosition:q,onAnnotationsUpdated:function(){Y();KindleRenderer.reloadAnnotations()},hostShowAnnotations:U.showAnnotations},annotationManager:KindleModuleManager.getModuleSync(X.ANNOTATION_MANAGER),pageLabelConverter:ya};ReaderAnnotationsDisplay.initialize(a)}function tc(){KindleTouchEventsToggler.isRequired()&&KindleTouchEventsToggler.deInitialize();
R.getKindleStreamsManager().closeBook();KindleModuleManager.getModuleSync(KindleModuleManager.METRICS_MANAGER).uploadMetrics(!0);KindleModuleManager.getModuleSync(Kindle.MODULE.DB_CLIENT).removeEventListener(Kindle.ERROR.DB_LINGERING_WRITE,Fb)}function uc(){fb=!0;KindleDeviceCapabilities.hasSplitView()&&KindleWindowSizeWatcher.stopPolling()}function vc(){fb=!1;gb&&K();KindleDeviceCapabilities.hasSplitView()&&KindleWindowSizeWatcher.startPolling()}function wc(a,b,c,d){return KindleOffline.downloadBook(a,
b,c,d)}function xc(){KindleOffline.cancelBookDownload()}function yc(a,b,c){KindleOffline.removeBook(a,b,c)}function sc(){var a={},b=KindleReaderSearchBox.getSearchText();if(b&&U.searchContent)a.queryText=b,a.curPosition=I(),a.asin=Q.getAsin(),ya(a.curPosition).then(function(b){a.curLocation=b.loc;a.curPageNumber=b.pageNumber;U.searchContent(a)});if(b&&!U.isHostControlled())a.goToPosition=function(a){a&&(a.searchHighlights&&ReaderSitbHighlight.set(a.searchHighlights),q(a.position),a.isMarker?R.emit("SITB::GotoCurrentLocation"):
R.emit("SITB::GotoResult"))},a.bookInfo=Q,a.pageLabelConverter=ya,a.locationConverter=ka,ReaderSitbManager.searchContent(a)}function zc(a){ob||(ob=SearchContextProvider.getContextProvider({pageLabelConverter:ya,locationConverter:ka}));return ob.getContext(a)}function Ac(a){function b(g){function f(a){var b=ya(a);b.done(function(b){d.location[a]=b.loc;d.page[a]=b.pageNumber});return b}if(g>=a.positions.length)c.resolve(d);else{var e;do e=f(a.positions[g++]);while(g<a.positions.length&&e.state()!==
"pending");e.done(function(){b(g)})}}var c=$.Deferred(),d={location:{},page:{}};b(0);return c.promise()}function Bc(){Na.setReaderInterface({goToPosition:q,goToLocation:r,goToPage:o,openBook:lc,unloadReader:tc,onStoreOpenStatus:Cc,pauseReader:uc,resumeReader:vc,setToolbarVisible:function(a){Z(!a)},toggleToolbar:sa,setFocus:function(){setTimeout(window.focus,0)},downloadBook:wc,cancelBookDownload:xc,removeBook:yc,getSelectedText:function(a){return KindleReaderClippingManager.getSelectedText(a)},hideContextMenu:function(){KindleReaderContextMenu.hide()},
getSearchContext:zc,convertPositions:Ac,updateAnnotations:function(a){a=KindleReaderAnnotationManager.updateAnnotations(a);a.done(function(){KindleRenderer.reloadAnnotations();Y()});return a},updateReaderChrome:hc})}function Cc(a){KindleSpinner.hide();a===Kindle.STORE.GENERIC_ERROR?lb?KindleMessageDialog.showError(Kindle.ERROR.STORE_OPEN_FAILED,Cb):KindleMessageDialog.showError(Kindle.ERROR.STORE_OPEN_FAILED):a===Kindle.STORE.OFFLINE_ERROR&&(lb?KindleMessageDialog.showError(Kindle.ERROR.STORE_OPEN_OFFLINE_FAILED,
Cb):KindleMessageDialog.showError(Kindle.ERROR.STORE_OPEN_OFFLINE_FAILED))}function Qa(a){KindleHostDeviceDetector.isMetro()||KindleSpinner.show();a.asin=Q.getAsin();U.openStore(a)}function Bb(){return KindleHostDeviceDetector.isMetroSnappedView()?pb.LANDSCAPE:window.outerHeight>window.outerWidth?pb.PORTRAIT:pb.LANDSCAPE}function ya(b){var c=$.Deferred(),d={};if(wa.pageNumbers)d.pageNumber=Da.pageNumberFromPosition(b);(function(){ka.locationFromPosition(b).done(function(b){(a()||g())&&b++;d.loc=b;
c.resolve(d)},function(){c.resolve(d)})})();return c.promise()}var Vb=30,Wb="topaz",Sa,Xb=300,yb="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAALCAYAAABGbhwYAAAASklEQVQYGWMUSd/dwMDAUA/E2EAjULDh9QwXBkagwv/YVCCJgRWzwARAupCBaMYeGBdsGzEmgjXgNBFmHMzkYWUiE9B3oAAlBBoBvxIeobfDoeQAAAAASUVORK5CYII=",gc="Reader",ba={},S,Ma,vb,nb,Q,Ka,T,va={},Ca={},za=null,ka,Da,ob,oa=!1,Wa,la=!1,ia=null,hb=!0,ib,ma,Db,Na,U,R,Ya,Ea,Ja=!0,lb=!1,Gb=!1,Hb=!1,fb=!1,gb=!1,Ia=[],fa=null,Ta=null,kb=!1,ga=null,cb,ta=null,wb=!1,
xa=!1,ra=null,qa=!1,La,Xa,eb=null,X={ANNOTATION_MANAGER:"annotation_manager",LPR_MANAGER:"lpr_manager",BOOK_METADATA:"book_metaData",BOOK_CONTEXT:"book_context",SearchIndexManager:"SearchIndexManager"},ja={KEY:"keyboard",ARROW:"arrow",TAP:"tap",SWIPE:"swipe",WHEEL:"wheel"},na={LEFT:"left",RIGHT:"right"},pb={LANDSCAPE:"Landscape",PORTRAIT:"Portrait"},Fa,Ha=!1,db=!0,wa={location:!0,percentage:!0,pageNumbers:!1},mb=!1;return{initialize:function(){nb=new jQuery.Deferred;Sa=new jQuery.Deferred;Na=window.parent.KindleApp;
Wa=new jQuery.Deferred;eb=new jQuery.Deferred;KindleTouchEventsToggler.isRequired()&&KindleTouchEventsToggler.initialize();Na&&(S=new KindleReaderSettings,S.reset(),S.load(),fa=KindleSelectionStateManagerFactory(),fa.addEventListener(fa.SELECTION_CHANGED_EVENT,c),fa.addEventListener(fa.PROCESS_SELECTION_EVENT,tb),Ta=KindleSelectionHelper(KindleRenderer.getPageSelectableItemBoundaries),KindleReaderSelectionRenderer.initialize(Ta),KindleReaderOverlayManager.setSelectionManager(fa),ga=$("#kindleReader_book_container"),
$("body").bind("touchmove.elastic",KindleIOSScrollStopper.stopScroll),KindleHostDeviceDetector.isMetro()&&($(ga).addClass("immersive_mode"),$("body").addClass("metro")),KindleHostDeviceDetector.hasiOSInnerHeightBug()&&$("body").addClass("iosInnerHeightBug"),KindleHostDeviceDetector.isiOSAppMode()&&$("body").addClass("iOSAppMode"),U=Na.getAppInterfaceForReader(),KindleInterfaces.assertImplements(U,KindleInterfaces.IKindleAppForReader),Na.getSharedModules().done(function(a){Kindle=a[KindleModuleManager.CONSTANTS];
ResourceBundle=a[KindleModuleManager.RESOURCE_BUNDLE];KindleTemplateManager.initialize();KindleModuleManager.registerModuleList(a);R=a[KindleModuleManager.METRICS_MANAGER];Ea=a[KindleModuleManager.SERVICE_CLIENT];jc();KindleDictionaryManager.setGetContextCallback(Sb);Bc();U.onReaderReady();a=KindleRenderer.PAGE_LOAD_INCOMPLETE_FLAG_NAME;KindleLocalStorage.getItem(a)&&(R.emit("Reader::PageLoadIncomplete"),KindleLocalStorage.removeItem(a))}),KindleTouchEventsToggler.isRequired()&&KindleTouchEventsToggler.disallowTouchEvents());
nb.resolve()},gotoPosition:q,openStoreDP:Qa,setDesktopImmersiveMode:Z,leaveDesktopImmersiveMode:function(){Z(!1)},nextPage:H,prevPage:C,register:function(a,b){return U.register(a,b)},deregister:function(a,b){return U.deregister(a,b)},closeReader:Ra,getMaxPosition:s,getSelection:function(){return fa.getSelection()||KindleRenderer.getSelection()},initializePageNumbers:function(a){wa.pageNumbers=!0;Da=a;a=Da.getMaxPageNumberLabel();KindleReaderLocationBar.setMinMaxPageNumber(1,a);KindleReaderImmersiveFooter.enableLabelType("page")},
getPNLabelFromLocation:function(a){var b=$.Deferred();return wa.pageNumbers?(ka.positionFromLocation(a).done(function(a){a=Da.pageNumberFromPosition(a);b.resolve(a)},function(){b.resolve()}),b.promise()):b.resolve()},createBuyFullVersionButton:Ab,disableBookReading:function(){db=!1}}}
var KindleReaderUI=KindleReaderUIFactory(),KindleX=KindleReaderUI,KindleReaderFreeTrialExpiredDialog=function(){function h(){KindleUXComponentManager.closeDialog(c);KindleReaderUI.closeReader()}function j(){(function(){var a=$.Deferred();KindleMessageDialog.open(ResourceBundle.getLocalizedString(k.TEXT_LABEL_DIALOG_DELETE_FREE_TRIAL_TITLE),ResourceBundle.getLocalizedString(k.TEXT_LABEL_DIALOG_DELETE_FREE_TRIAL_TEXT),null,null,[{buttonText:ResourceBundle.getLocalizedString(k.TEXT_LABEL_DIALOG_DELETE_CANCEL_BUTTON),
callback:a.reject},{buttonText:ResourceBundle.getLocalizedString(k.TEXT_LABEL_DIALOG_DELETE_BUTTON),callback:a.resolve}]);return a.promise()})().done(function(){f=KindleModuleManager.getModuleSync(KindleModuleManager.SERVICE_CLIENT);a=KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT);f.removeOwnership(b,g).done(function(){var c=[{asin:b}];a.getAppDb().updateBookData(c,[]).done(e)}).fail(function(){KindleMessageDialog.showError(Kindle.ERROR.REVOKE_FAILED,h)})}).fail(function(){d(b)})}
function e(){a.getAppDb().getAllBooks().done(function(b){var c=[];b.forEach(function(a,b,d){if(a.title===void 0||a.authors===void 0)c.push({operation:Kindle.DB.DELETE_RECORD_OPERATION,tableName:"bookdata",params:[{asin:a.asin}]}),delete d[b]});c.length>0&&a.getAppDb().batchTransaction(c)});h()}function d(a){b=a;$("#kindleReader_footer").css("display","none");KindleReaderUI.disableBookReading();KindleUXComponentManager.openDialog(c,q,{_isRemovalForFreeTrialsEnabled:n})}var c="KindleReaderFreeTrialExpiredDialog",
b=null,f,a,g="EBOK",k={TEXT_LABEL_CANCEL_BUTTON:"k_endOfFreeTrial_cancel_button",TEXT_LABEL_BUYFULLVERSION_BUTTON:"k_endOfFreeTrial_buyfullversion_button",TEXT_LABEL_REMOVEBOOK_BUTTON:"k_endOfFreeTrial_removebook_button",TEXT_LABEL_END_OF_FREE_TRIAL_TITLE:"k_endOfFreeTrial_Title",TEXT_LABEL_END_OF_FREE_TRIAL_TEXT:"k_endOfFreeTrial_Text",TEXT_LABEL_DIALOG_DELETE_FREE_TRIAL_TITLE:"k_L_dialog_deleteFreeTrial_prompt_title",TEXT_LABEL_DIALOG_DELETE_FREE_TRIAL_TEXT:"k_L_dialog_deleteFreeTrial_prompt_text",
TEXT_LABEL_DIALOG_DELETE_CANCEL_BUTTON:"k_L_dialog_delete_cancel",TEXT_LABEL_DIALOG_DELETE_BUTTON:"k_L_dialog_delete"},m={CANCEL_BUTTON_ID:"kindleReader_goToLibrary_cancel",REMOVE_BUTTON_ID:"kindleReader_dialog_removeBook_btn",BUY_BUTTON_ID:"kindleReader_dialog_buyFullVersion_btn",FREE_TRIAL_DIALOG_TITLE:"kindleReader_dialog_freeTrialExpired_title",FREE_TRIAL_DIALOG_TEXT:"kindleReader_dialog_freeTrialExpired_text"},l,n=!1,r=function(){KindleUXComponentManager.closeDialog(c);KindleReaderUI.openStoreDP()},
o=function(){KindleUXComponentManager.closeDialog(c);j()},q={getDialogSettings:function(){var a={};a[ResourceBundle.getLocalizedString(k.TEXT_LABEL_CANCEL_BUTTON)]=h;return{autoOpen:!1,modal:!0,draggable:!1,resizable:!1,buttons:a}},beforeDialogOpen:function(a){var b=ResourceBundle.getLocalizedString(k.TEXT_LABEL_END_OF_FREE_TRIAL_TITLE),c=ResourceBundle.getLocalizedString(k.TEXT_LABEL_END_OF_FREE_TRIAL_TEXT);a.find("#"+m.FREE_TRIAL_DIALOG_TITLE).empty().append(b);a.find("#"+m.FREE_TRIAL_DIALOG_TEXT).empty().append(c)},
onInitializationDone:function(a){l=a;l.find("#"+m.BUY_BUTTON_ID).click(r);l.find("#"+m.REMOVE_BUTTON_ID).click(o)}};return{open:d}}();
function KindleFreeTrialHelper(){function h(a,f){var l=(new Date).getTime();if(l>a)KindleReaderFreeTrialExpiredDialog.open(f),d&&(window.clearInterval(b),d=!1);else{$("#"+g.FREE_TRIAL_MESSAGE_CONTAINER).length===0&&e();var n=j(a,l);document.getElementById(g.FREE_TRIAL_EXPIRATION_MESSAGE).innerHTML=n;document.getElementById(g.FREE_TRIAL_MESSAGE_CONTAINER).style.display="block";d||(c=a-l,a>0&&(b=window.setInterval(function(){h(a,f)},c),d=!0))}}function j(b,c){var d=Math.floor((b-c)/f);return d===1?
ResourceBundle.getLocalizedString(a.FREE_TRIAL_EXPIRES_TEXT_DAY):d===0?ResourceBundle.getLocalizedString(a.FREE_TRIAL_EXPIRES_IN_LESS_THAN_A_DAY):ResourceBundle.getLocalizedString(a.FREE_TRIAL_EXPIRES_TEXT_DAYS,{days:d})}function e(){var a=$(Handlebars.templates.KindleReaderFreeTrialMessageBar());$("#"+g.KINDLE_READER_HEADER).append(a);KindleReaderUI.createBuyFullVersionButton()}var d=!1,c=null,b,f=864E5,a={FREE_TRIAL_EXPIRES_MESSAGE:"k_freeTrialExpires_Message",FREE_TRIAL_EXPIRES_TEXT_DAY:"k_freeTrialExpires_Day",
FREE_TRIAL_EXPIRES_TEXT_DAYS:"k_freeTrialExpires_Days",FREE_TRIAL_EXPIRES_IN_LESS_THAN_A_DAY:"k_freeTrialExpires_less_than_a_day"},g={FREE_TRIAL_MESSAGE_CONTAINER:"freeTrial_message_container",FREE_TRIAL_EXPIRATION_MESSAGE:"freeTrial_expiration_message",KINDLE_READER_BUY_FULL_BUTTON:"kindleReader_Buy_Full_Button",KINDLE_READER_FOOTER_READER_CONTROLS_MIDDLE:"kindleReader_footer_readerControls_middle",KINDLE_READER_DOWNLOAD_PROGRESS:"kindleReader_download_progress",KINDLE_READER_FOOTER_READER_CONTROL_RIGHT:"kindleReader_footer_readerControls_right",
KINDLE_READER_BOOK_CONTAINER:"kindleReader_book_container",KINDLE_READER_HEADER:"kindleReader_header"};return{handleFreeTrialExpiration:h,freeTrialMessageImmersiveSlideUp:function(){$("#"+g.FREE_TRIAL_MESSAGE_CONTAINER).length!==0&&$("#"+g.FREE_TRIAL_EXPIRATION_MESSAGE).slideUp(200)},freeTrialMessageImmersiveSlideDown:function(){$("#"+g.FREE_TRIAL_MESSAGE_CONTAINER).length!==0&&setTimeout(function(){$("#"+g.FREE_TRIAL_MESSAGE_CONTAINER).slideDown(200);$("#"+g.FREE_TRIAL_EXPIRATION_MESSAGE).slideDown(200)},
150)}}}KindleFreeTrialHelper=KindleFreeTrialHelper();
function KindleBadgingFactory(){return{drawBadge:function(h,j,e){var d=Math.PI/180,c=36/Math.sqrt(2),b=(c-10)/2,f=h.getContext("2d");f.fillStyle=e;f.beginPath();f.rotate(45*d);f.fillRect(0,0,500,-c);f.stroke();f.beginPath();f.fillStyle="#FFFFFF";f.font="10pt Helvetica";f.opacity=0.95;f.fillText(j,h.width/2-(j.length>5?(j.length-5)*4:0),-b);f.stroke()},createCanvasElement:function(){var h=document.createElement("canvas");h.className="canvas_for_badge";h.height=100;h.width=100;return h},pushAsinForBadgeUpdate:function(h){var j=
JSON.parse(KindleLocalStorage.getItem("listOfAsinsForBadging"));if(j){var e;a:{for(e in j)if(j[e]===h){e=!0;break a}e=!1}e||(j[j.length]=h,KindleLocalStorage.setItem("listOfAsinsForBadging",JSON.stringify(j)))}else j=[],j[0]=h,KindleLocalStorage.setItem("listOfAsinsForBadging",JSON.stringify(j))},addBadgeToBookContainer:function(h,j,e){e.find(".book_cover").append("<div class='book_image_container'></div>");e.find(".book_image").appendTo(e.find(".book_image_container"));var d=$("<div>").addClass("book_badge_container");
d.append(j);e.find(".book_image_container").append(d);e.find(".book_details").append(h);e.find(".canvas_for_badge").addClass("book_click_area")},adjustBadge:function(h){h.find(".book_image_container").find(".book_click_area").hasClass("book_image_wide")&&h.find(".book_image_container").addClass("wide")},cloneCanvasForBadge:function(h){var j=document.createElement("canvas"),e=j.getContext("2d");j.width=h.width;j.height=h.height;j.className=h.className;e.drawImage(h,0,0);return j}}}
var KindleBadging=KindleBadgingFactory(),KindleRendererAnnotationRenderer=function(){function h(){var a={};return function(b,c){if(a[b]!==void 0)return a[b];var d=c[b];if(!d)return a[b]=!1;if(d.tagName==="IMG")return a[b]=!0;for(;d.tagName!=="BODY";){var g=$(d);if(g){var f=g.css("background-color"),g=g.css("background-image");if(f&&f!=="rgba(0, 0, 0, 0)"&&f!=="transparent"||g&&g!=="none")return a[b]=!0;d=d.parentNode}}return a[b]=!1}}function j(a){var b={};$(a).find("[data-nid]").each(function(a,
c){b[c.getAttribute("data-nid")]=c});return b}function e(b,c,d,g){b.style.top=c.top+a;b.style.height=c.height+a;b.style.left=c.left+a;b.style.width=c.width+a;b.className=d?g+" "+f:g}function d(a,b){var c=a.tagName==="IMG",d=!1,d=b!==void 0?b.tagName==="IMG":!1;return c!==d}function c(a,b,c,g,f,h){var k=a.contentDocument,s=k.createElement("DIV"),j=!1,y=!1,v={isNewLine:!0,isImageBound:!1,lineBounds:{top:0,height:0,left:0,right:0,width:0}},x=!1,H=!0;c.sort(function(b,c){return a.writingMode.clientRectCompare(b.rect,
c.rect)});for(var C=c.length,I=0;I<C;I+=1){var z=c[I].dataNid;j||typeof z==="string"&&h(z,f)&&(j=!0);var H=c[I].rect,B=void 0,z=f[z],w=void 0,E=!1;if(I<C-1)B=c[I+1].rect,w=f[c[I+1].dataNid],y=h(c[I+1].dataNid,f);z&&w&&(E=z.tagName==="IMG"||j,x=d(z,w)||y!==j);if(H=a.writingMode.updateDivIfNewLineOrImageBound(v,H,B,E,x,k.width))e(s,v.lineBounds,j,g),b.appendChild(s),s=k.createElement("DIV"),H=j=!1}}function b(a,b){b!==void 0&&(b.clickable!==void 0&&a.setAttribute(g,b.clickable),b.feedbackAnimation!==
void 0&&a.setAttribute(k,b.feedbackAnimation))}var f="semiTransparentOverlay",a="px",g="data-annotationClickable",k="data-annotationClickFeedback";return{DRAW_AFTER:"after",DRAW_OVER:"over",ANNOTATION_CLICK_ATTRIBUTE:g,ANNOTATION_CLICK_FEEDBACK_ATTRIBUTE:k,createAnnotationElements:function(d,g,f,e,k){var q=[];if(e!==null)for(var t=KindleRendererSettings.getSettings().annotationStyles,s=KindleRendererSettings.getSettings().annotationClick,u,y=u=null,v=null,x=j(d.contentDocument),H=h(),C=0;C<e.length;C+=
1)if(y=e[C],u=y.type,t[u]){var v=s?s[u]:void 0,I=t[y.type].className;if(y.additionalStyles)for(var z in y.additionalStyles)I+=" "+y.additionalStyles[z];if(t[u].drawingType==="over"){u=d;var B=k,w=g,E=y,K=v,v=x,y=H,D=u.contentDocument.createElement("DIV");D.setAttribute("annotationType",E.type);D.setAttribute("annotationStart",E.start);b(D,K);w=KindleRendererWordRectsHelper.createWordBoundaries(E,w,u.contentDocument,u.contentWindow,u.writingMode);c(u,D,w,I,v,y);B.appendChild(D);u=D}else if(t[u].drawingType===
"after"){u=d;var B=k,w=g,E=f,K=v,D=y.start,M=-1,v=void 0;for(E.addBoundsForPosition(u.contentDocument,w,D,u.writingMode);w[D]===void 0&&M<100;)D=y.start+M,E.addBoundsForPosition(u.contentDocument,w,D,u.writingMode),M+=1;if(w[D]!==void 0)v=u.contentDocument.createElement("DIV"),v.setAttribute("annotationType",y.type),v.setAttribute("annotationStart",y.start),b(v,K),E=v,w=w[D].rects[w[D].rects.length-1],y=u.contentDocument,D=y.createElement("DIV"),u.writingMode.positionDivAfterWord(D,w,a,y.width),D.className=
"note-annotation "+I,E.appendChild(D),B.appendChild(v);u=v}else u=null;u&&q.push(u)}return q},removeAnnotationElements:function(a,b){$(a).children('[annotationtype="'+b.type+'"][annotationstart="'+b.start+'"]').remove()}}}(),KindleRenderer=function(){function h(a,b,c){a={status:a};if(b!==void 0)a.errorCode=b;if(c!==void 0)a.errorMsg=c;K!==void 0&&K(a)}function j(a,b){h(o,a,b?b:"no msg")}function e(){E=w=!1;h(t)}function d(){D!==null&&(D.endTimer(),D.log(),D=null);w=!0;h(s)}function c(){E=!1}function b(){E=
!0;h(u)}function f(a){E=!1;j(H,a)}function a(a){w=!1;j(x,a)}function g(a){a=parseInt(a,10);isNaN(a)&&(a=0);return KindleRendererContentDisplay.gotoPosition(a,!0)}function k(){return setTimeout(function(){B||(z=!0,j(y,"Init timed out"))},I)}function m(a){clearTimeout(a);return k()}function l(l,s,o,u){D===null&&(D=KindleMetricsProfiler("Renderer-Load"));K=o.statusCallback;o.contentInterfaceCallbacks&&KindleRendererContentScripts.setCallbacks(o.contentInterfaceCallbacks);z=!1;if(l)if(l.bookInfo&&l.containerId)if(M=
$(document.getElementById(l.containerId)),M.length===0)j(v,"Container not found");else{h(q);KindleRendererDeviceSpecific.initialize();I=KindleRendererDeviceSpecific.rendererInitializationTimeout();var n=k();KindleRendererFragmentLoader.initialize(l.bookInfo).then(function(){z||(n=m(n),KindleRendererSettings.initialize(l.bookInfo).then(function(){if(!z){n=m(n);KindleRendererPositionLoadingCalculator.updateScreenDimensions(M.width(),M.height());var h={waitNotification:e,readyNotification:d,rectsWaitNofification:c,
rectsReadyNotification:b,rectsErrorNotification:f,errorNotification:a,annotationTriggered:o.annotationEventCallback};l.startingPositionDfd.done(function(a){z||(n=m(n),KindleRendererContentDisplay.initialize(M.get(0),h,l.bookInfo,u,a).then(function(){z||(KindleRendererSettings.updateSettings(s),KindleGlyphRenderer.updateSettings(s),KindleRendererContentDisplay.updateSettings(s),B=!0,g(a))},function(a){z||j(y,"Load Failure: "+a)}))})}},function(){z||j(y,"Load Failure: Metadata")}))},function(a){z||
j(y,"Load Failure: "+a)})}else throw{name:"initializationError",message:"required parameters not present"};}function n(){if(!B)throw{name:"initializationError",message:"Please call KindleRenderer.initialize function first"};}var r=0,o=r++,q=r++,t=r++,s=r++,u=r++,y=r++,v=r++,x=r++,H=r++,C=r++,r=r++,I=12E4,z=!1,B=!1,w=!1,E=!1,K=void 0,D=null,M=null;return{STATUS_ERROR:o,STATUS_LOADING:q,STATUS_PAGINATING:t,STATUS_PAGINATED:s,STATUS_DONE:u,ERROR_LOAD_FAILURE:y,ERROR_CONTAINER_NOT_FOUND:v,ERROR_UNABLE_TO_GET_BOOK_CONTENT:x,
ERROR_UNABLE_TO_GET_WORD_RECTS:H,ERROR_TIMEOUT_WHILE_LOADING_BOOK_CONTENT:C,ERROR_UNKNOWN:r,PAGE_LOAD_INCOMPLETE_FLAG_NAME:"PageLoadIncomplete",initialize:function(a,b,c,d){try{l(a,b,c,d)}catch(g){}},shutdown:function(){try{B&&(B=!1,KindleRendererContentDisplay.cleanup(),KindleGlyphRenderer.cleanup(),KindleRendererCanvasInsertion.cleanup())}catch(a){}},getMinimumPosition:function(){n();return KindleRendererFragmentLoader.getMinimumPosition()},getMaximumPosition:function(){n();return KindleRendererFragmentLoader.getMaximumPosition()},
createWordIterator:function(){n();try{return KindleRendererWordIteratorFactory.build()}catch(a){}return null},updateSettings:function(a){try{KindleRendererSettings.updateSettings(a),KindleGlyphRenderer.updateSettings(a),KindleRendererContentDisplay.updateSettings(a)}catch(b){return!1}},gotoPosition:function(a){n();try{return g(a)}catch(b){}return!1},nextScreen:function(){n();try{if(w)return KindleRendererContentDisplay.nextScreen()}catch(a){}return!1},previousScreen:function(){n();try{if(w)return KindleRendererContentDisplay.previousScreen()}catch(a){}return!1},
hasNextScreen:function(){n();try{if(w)return KindleRendererContentDisplay.hasNextScreen()}catch(a){}return!1},hasPreviousScreen:function(){n();try{if(w)return KindleRendererContentDisplay.hasPreviousScreen()}catch(a){}return!1},getPagePositionRange:function(){n();try{if(w)return KindleRendererContentDisplay.getPagePositionRange()}catch(a){}return null},getPageSelectableItemBoundaries:function(){n();try{if(E)return KindleRendererContentDisplay.getSelectableItemBoundaries()}catch(a){}return null},getPageWordPositions:function(){n();
try{if(E)return KindleRendererContentDisplay.getWordPositions()}catch(a){}return null},onWindowResize:function(){if(B)try{KindleRendererPositionLoadingCalculator.updateScreenDimensions(M.width(),M.height()),KindleRendererContentDisplay.onWindowResize()}catch(a){}},handleClick:function(a,b){try{if(w)return KindleRendererContentDisplay.handleClick(a,b)}catch(c){}return null},reloadAnnotations:function(){try{w&&KindleRendererContentDisplay.reloadAnnotations()}catch(a){}},getContentRects:function(){n();
try{if(w)return KindleRendererContentDisplay.getContentRects()}catch(a){}return null},getZoomableAt:function(a,b){n();try{if(w)return KindleRendererContentDisplay.getZoomableAt(a,b)}catch(c){}return null},getZoomableList:function(){n();try{if(w)return KindleRendererContentDisplay.getZoomableList()}catch(a){}return null},clearSelection:function(){if(B)try{w&&KindleRendererContentDisplay.clearSelection()}catch(a){}},getSelection:function(){n();try{if(w)return KindleRendererContentDisplay.getSelection()}catch(a){}}}}(),
KindleRendererWordIteratorFactory=function(){function h(a,b,c,d){for(var f=!0;f;){f=a.getItem();if(f.pos>b){d.resolve(c);return}c+=f.text;f=a.next()}a.getLoadingDfd().then(function(f){f?h(a,b,c,d):d.resolve(c)},d.reject)}function j(a){a.cancelCurrentRequest=function(){if(this.currentRequest)this.currentRequest=null};a.newRequest=function(a,b,c){this.cancelCurrentRequest();this.currentRequest={requestId:KindleRendererRequestId.getUniqueRequestId(),metrics:KindleMetricsProfiler("word-iterator-load"),
position:a,stopPosition:b,direction:c}};a.newRequestDfd=function(){this.currentRequestDfd=new jQuery.Deferred;this.currentRequestReachedTerminal=!1};a.fragmentLoadedCallback=function(a){var b=this;b.loadedRange=a.contentRange;b.wordMapGenerator.createWordMap(a.fragmentRoot,a.positionData).then(function(a){b.createPositionInfo(a)},function(){b.currentRequestDfd.reject()})};a.calculateContinuePosition=function(a){return a===b?this.loadedRange.startPosition-1:this.loadedRange.endPosition+1};a.hasReachedStopPosition=
function(a){if(this.currentRequest&&this.currentRequest.stopPosition!==void 0){var c=this.currentRequest.direction,d=this.currentRequest.stopPosition,a=a?this.positions[this.currPositionIndex]:this.calculateContinuePosition(c);return c===b&&a<d||a>d}return!1};a.createPositionInfo=function(a){this.wordMap=a;a=this.currentRequest.direction;this.positions=[];for(var d in this.wordMap)this.positions.push(parseInt(d,10));this.positions.sort(function(a,b){return a-b});d=this.findPosition(this.currentRequest.position,
a);this.hasReachedStopPosition(d)?this.currentRequestDfd.reject():d?(this.currentRequest=null,this.currentRequestDfd.resolve(!this.currentRequestReachedTerminal)):a===b&&this.startPositionIsLoaded()||this.endPositionIsLoaded()?this.currentRequestReachedTerminal?this.currentRequestDfd.reject():(this.currentRequestReachedTerminal=a!==c,a=a===b?f:b,this.beginLoad(this.calculateContinuePosition(a),this.currentRequest.stopPosition,a)):this.beginLoad(this.calculateContinuePosition(a),this.currentRequest.stopPosition,
a)};a.findPosition=function(a,c){this.currPositionIndex=KindleListUtilities.binarySearch(this.positions,a);return c===b?a>=this.positions[0]:(this.positions[this.currPositionIndex]<a&&++this.currPositionIndex,this.currPositionIndex<this.positions.length)};a.beginLoad=function(a,c,d){var f=this;f.newRequest(a,c,d);a=KindleRendererFragmentLoader.getFragmentIdForPosition(a,d===b);KindleRendererFragmentLoader.getFragmentAtId(a,f.currentRequest).then(function(a,b){f.currentRequest&&f.currentRequest.requestId===
a.requestId&&f.fragmentLoadedCallback(b)},function(){f.currentRequestDfd.reject()})};a.gotoPosition=function(a,b){this.newRequestDfd();if(this.currentRequest===null&&this.loadedRange!==null&&a>=this.loadedRange.startPosition&&a<this.loadedRange.endPosition&&this.findPosition(a,c))return this.currentRequestDfd.resolve(!0),this.currentRequestDfd.promise();this.beginLoad(a,b,c);return this.currentRequestDfd.promise()};a.getItem=function(){if(this.currentRequest===null){var a=this.positions[this.currPositionIndex];
return{pos:a,text:this.wordMap[a].text}}return null};a.previous=function(a){if(this.currPositionIndex===null||this.currentRequest!==null)return!1;this.currPositionIndex--;return this.currPositionIndex<0?(this.startPositionIsLoaded()?(this.currPositionIndex=0,this.newRequestDfd(),this.currentRequestDfd.resolve(!1)):(this.newRequestDfd(),this.beginLoad(this.loadedRange.startPosition-1,a,b)),!1):!0};a.next=function(a){if(this.currPositionIndex===null||this.currentRequest!==null)return!1;this.currPositionIndex++;
return this.currPositionIndex>=this.positions.length?(this.endPositionIsLoaded()?(this.currPositionIndex=this.positions.length-1,this.newRequestDfd(),this.currentRequestDfd.resolve(!1)):(this.newRequestDfd(),this.beginLoad(this.loadedRange.endPosition+1,a,f)),!1):!0};a.getLoadingDfd=function(){return this.currentRequestDfd.promise()};a.startPositionIsLoaded=function(){return this.loadedRange.startPosition<=KindleRendererFragmentLoader.getMinimumPosition()};a.endPositionIsLoaded=function(){return this.loadedRange.endPosition>=
KindleRendererFragmentLoader.getMaximumPosition()}}function e(a,b){a.getItem=function(){return b.getItem()};a.previous=function(a){return b.previous(a)};a.next=function(a){return b.next(a)};a.getLoadingDfd=function(){return b.getLoadingDfd()};a.gotoPosition=function(a,c){var d=Math.max(a,KindleRendererFragmentLoader.getMinimumPosition()),d=Math.min(d,KindleRendererFragmentLoader.getMaximumPosition());return b.gotoPosition(d,c)};a.getText=function(a,b){var c=this,d=new jQuery.Deferred;c.gotoPosition(a).then(function(){h(c,
b,"",d)},d.reject);return d.promise()};a.clear=function(){d(b)}}function d(a){a.currentRequest=null;a.currentRequestDfd=null;a.currentRequestReachedTerminal=null;a.loadedRange=null;a.wordMap=null;a.positions=null;a.currPositionIndex=null}var c="goto",b="prev",f="next";return{build:function(){var a={};a.wordMapGenerator=KindleRendererWordMapGeneratorFactory.buildWordMapGeneratorForWordText();d(a);j(a);var b={};e(b,a);return b}}}(),KindleRendererCanvasInsertion=function(){function h(b,a){for(var c=
b;c<a.length;c++){a[c].innerHTML="";a[c].width=0;for(var d=a[c].attributes.length;--d>=0;)a[c].removeAttribute(a[c].attributes[d].nodeName)}}function j(c,a,g,k){var m=a.getElementsByTagName("html")[0],l=a.getElementsByTagName("body")[0],j=Array.prototype.slice.call(l.getElementsByClassName("k4wc"));if(j.length>0){m.removeChild(l);var r=j.length,o=KindleRendererDeviceSpecific.maximumCanvases();d[c]=0;var q=null;e[c]||(e[c]=[]);var t=function(g){g=j[g];if(d[c]>=o)if(g.parentNode.removeChild(g),g=parseInt(g.id,
10),k){if(q===null||g>q)q=g}else{if(q===null||g<q)q=g}else{var e=b(c,a);e.id=g.id;e.setAttribute("height",g.getAttribute("height"));e.setAttribute("width",g.getAttribute("width"));e.setAttribute("data-nid",e.id);e.innerHTML=g.innerHTML;g.parentNode.replaceChild(e,g)}},s;if(k)for(s=r-1;s>=0;s--)t(s);else for(s=0;s<r;s++)t(s);if(q!==null){r=KindleMetricsProfiler("remove-extra-canvases");if(k){if($(l).find("*").filter(function(){return parseInt(this.getAttribute("id"),10)<q}).remove(),g.startPosition<=
q)g.startPosition=q+1}else if($(l).find("*").filter(function(){return parseInt(this.getAttribute("id"),10)>q}).remove(),g.endPosition>=q)g.endPosition=q-1;r.endTimer();r.log()}h(d[c],e[c]);m.appendChild(l)}}var e=[],d=[],c=0,b=function(){return window.ActiveXObject&&window.XMLHttpRequest?function(b,a){return a.createElement("CANVAS")}:function(b,a){d[b]++;var g=d[b],h=e[b],m=null;g>h.length?(m=a.createElement("CANVAS"),c+=1,h[g-1]=m):m=h[g-1];return m}}();return{changeSpanToCanvas:function(b,a,c,
d){j(b,a,c,d)},cleanup:function(){for(var b in e)for(var a=e[b],c=a.length,d=0;d<c;d+=1){var h=a[d],l=h.parentNode;l!==null&&l!==void 0&&l.removeChild(h)}e=null}}}(),KindleGlyphRenderer=function(){function h(a,b,c,d,g,f,e,h){b=b[d.imgSrc];if(c.getContext&&b!==void 0){var k=new Image,l=d.o;l||(l=[0,0]);k.onload=function(){if(a===r){var b=l,d=c,k=d.getContext("2d"),m=b[0]*g/1440,b=b[1]*g/1440,j={x:m,y:b,w:this.width*f,h:this.height*f};e[d.id]||(e[d.id]=[]);d=e[d.id];d[d.length]=j;k.translate(m,b);k.scale(f,
f);k.drawImage(this,0,0);k.scale(1/f,1/f);k.translate(-m,-b);c=null}setTimeout(h,25)};k.src=b;d=b=b=null}else setTimeout(h,10)}function j(a,b,c,d){if(b.getContext){var g=c.o;g||(g=[0,0]);var f=b.getContext("2d");f.translate(g[0]*d/1440,g[1]*d/1440);f.fillStyle=e(b);for(var h,k,l,m,j,o=c.l.length,n=0;n<o;n++){a:{h=c.l[n][0];l=void 0;for(j=0;j<a.length;j+=1)if(l=a[j].glyphFragmentMetadata,h>=l.startingGlyph&&h<=l.endingGlyph){l=h-l.startingGlyph;h=a[j].glyphData[l];break a}h=null}if(h!==null){l=c.l[n][1]+
c.p[0];m=c.l[n][2]+c.p[1];j=d/h.dpi;l=(l-c.p[0])*d/1440;m=(m-c.p[1])*d/1440;f.translate(l,m);f.scale(j,j);f.beginPath();for(var q=h.c.length,r=0;r<q;r++){var N=h.c[r];f.moveTo(N[0],N[1]);k=N.length-6;for(var F=2;F<k;F+=6)f.bezierCurveTo(N[F],N[F+1],N[F+2],N[F+3],N[F+4],N[F+5]);k=N.length;f.bezierCurveTo(N[k-4],N[k-3],N[k-2],N[k-1],N[0],N[1])}f.closePath();f.fill();f.scale(1/j,1/j);f.translate(-l,-m)}}f.translate(-(g[0]*d/1440),-(g[1]*d/1440));if(b.parentNode.tagName==="A")f.strokeStyle=e(b),f.lineWidth=
t.lineWidth,f.beginPath(),f.moveTo(0,b.height-1),f.lineTo(b.width,b.height-1),f.stroke(),f.closePath()}}function e(a){a=a.parentNode;return a.tagName==="A"?t.linkColor:(a=a.getAttribute("class"))&&a.indexOf("fixedOverlap")>=0?n:t.textColor}function d(a){for(var a=a.getElementsByTagName("CANVAS"),b={},c=0;c<a.length;c+=1)b[a[c].id]=a[c];return b}function c(a,b,c,d,g,f){for(var e={},h=0;h<a.length;h+=1){var k=b[a[h].id];if(k)for(var l=0;l<k.length;l++){var m=g[k[l].id];if(m){var j=d,o=m.parentNode.getAttribute("class");
if(o&&o.indexOf("fixed")>=0){var j=c,o=m,n=f;if(n[o.id])j=n[o.id];else{var q=o.getAttribute("height"),t=o.getAttribute("width"),r=0,L=0,P=1;if(q&&!(q<=0||!t||t<=0))q>j.height&&(r=j.height/q),t>j.width&&(L=j.width/t),r>0&&L>0?P=r<L?r:L:r>0?P=r:L>0&&(P=L),n[o.id]=P;j=P}}if(j!==1&&!e[m.id])e[m.id]=1,m.width=Math.round(j*m.width),m.height=Math.round(j*m.height)}}}}function b(a,c,d,g,f,e,k,l,m,j,n){function q(){a===r?b(a,c,d+1,g,f,e,k,l,m,j,n):setTimeout(n,10)}for(var t=g.length;c<t;){var D=f[g[c].id];
if(D)for(var M=D.length;d<M;){var N=D[d];if(N.imgSrc!==void 0){var F=l[N.id];if(F){t=m[F.id];t=t!==void 0?t:e;h(a,k,F,N,t*o,t,j,q);return}}d+=1}c+=1;d=0}setTimeout(n,10)}function f(a,c,d,g,f,e,h,k,l){b(a,0,0,c,d,g,f,e,h,k,l)}function a(b,c,d,g,f,e,h,k,l,m,n){function q(){b===r?a(b,c,d+1,g,f,e,h,k,l,m,n):setTimeout(n,m.time)}var t=0,D=g.length;for(KindleRendererProcessTuning.startingOperation("GlyphRenderering");c<D;){var M=f[g[c].id];if(M)for(var N=M.length;d<N;){var F=M[d];if(F.l!==void 0&&F.l.length>
0){var L=k[F.id];if(L){var P=l[L.id];j(h,L,F,(P!==void 0?P:e)*o);t+=1;if(t>=m.frequency){KindleRendererProcessTuning.endingOperation("GlyphRenderering",t);setTimeout(q,m.time);return}}}d+=1}c+=1;d=0}KindleRendererProcessTuning.endingOperation("GlyphRenderering",t);setTimeout(n,m.time)}function g(b,c,d,g,f,e,h,k,l){a(b,0,0,c,d,g,f,e,h,k,l)}function k(a,b,e,h,k,l){var m={height:$(a).parent().height()*0.85,width:$(a).parent().width()*0.85},j=d(a.contentDocument),o=[],n=a.contentDocument.getElementsByTagName("html")[0],
w=a.contentDocument.getElementsByTagName("body")[0],w=n.removeChild(w),E=$(w).find("p"),K={},D=k.createSubTimer("resizing-canvases");c(E,e.paraData,m,t.glyphScale,j,K);D.endTimer();D=k.createSubTimer("rendering-all-images");f(b.requestId,E,e.paraData,t.glyphScale,e.imageData,j,K,o,function(){D.endTimer();if(!(r!==b.requestId||a.processingRequestId.id!==b.requestId)){D=k.createSubTimer("rendering-all-glyphs");var c={frequency:KindleRendererProcessTuning.drawYieldFrequency("GlyphRenderering"),time:KindleRendererProcessTuning.drawYieldUpdateTime("GlyphRenderering")};
g(b.requestId,E,e.paraData,t.glyphScale,h,j,K,c,function(){D.endTimer();r!==b.requestId||a.processingRequestId.id!==b.requestId||(n.appendChild(w),q[a.id]=o,j=K=null,setTimeout(l,c.time))})}})}function m(a,b,c,d){var g=new jQuery.Deferred;if(r===null||b.requestId>=r){r=b.requestId;var f=b.metrics.createSubTimer("glyph-rendering");k(a,b,c,d,f,function(){r===b.requestId&&a.processingRequestId.id===b.requestId&&(r=null,f.endTimer(),g.resolve())})}return g.promise()}function l(a){var b={r:parseInt(t.textColor.substring(1,
3),16),g:parseInt(t.textColor.substring(3,5),16),b:parseInt(t.textColor.substring(5,7),16)},c=q[a.id];$(a.contentDocument).find("canvas").each(function(){var a=this.parentNode;if(a.tagName!=="A"&&(a=a.getAttribute("class"),!a||a.indexOf("fixedOverlap")<0)){a=this.getContext("2d");try{var d=a.getImageData(0,0,this.width,this.height),g=this.width*this.height*4,f=c[this.id];if(f){for(var e=this.width,h=0,k=f.length,l=[];h<k;h+=1)for(var m=Math.floor(f[h].x),j=Math.floor(f[h].y),o=Math.ceil(f[h].w),s=
Math.ceil(f[h].h),n=0;n<s;n+=1)for(var q=(e*(j+n)+m)*4,t=q+o*4;q<=t;q+=4)l[q]=1;for(var r=d.data,A=b.r,O=b.g,J=b.b,f=0;f<g;f+=4)r[f+3]>0&&!l[f]&&(r[f]=A,r[f+1]=O,r[f+2]=J)}else{l=d.data;h=b.r;n=b.g;q=b.b;for(r=0;r<g;r+=4)l[r+3]>0&&(l[r]=h,l[r+1]=n,l[r+2]=q)}a.putImageData(d,0,0)}catch(G){}}})}var n="#000000",r=null,o=100,q=[],t={glyphScale:1,textColor:n,linkColor:"#0000ff",lineWidth:1};return{renderAllContent:function(a,b,c,d){return m(a,b,c,d)},updateTextColor:function(a){l(a)},updateSettings:function(a){if(a.glyphScale!==
void 0&&(t.glyphScale=a.glyphScale,t.glyphScale<0.75||t.glyphScale>3))t.glyphScale=Math.max(0.75,Math.min(3,t.glyphScale));if(a.fontColor!==void 0)t.textColor=a.fontColor},clearIframeData:function(a){q[a.id]=void 0},cleanup:function(){q=null}}}(),KindleRendererContentFragmentation=function(){function h(a){a=$.extend(!0,{},a);if(!isFinite(a.startPosition)||!isFinite(a.endPosition))a.startPosition=0,a.endPosition=1E4;if(a.startPosition<0)a.startPosition=0;if(a.endPosition<0)a.endPosition=1E4;return a}
function j(a){return!a||!a.requestData||a.requestData.cancelled===!0}function e(a,b){for(var c=Math.max(l[0].cPos,b.startPosition),d=Math.min(l[l.length-1].ePos,b.endPosition),g=[],f=Infinity,e=-Infinity,h=0;h<l.length;h+=1)if(l[h].sId===a){var k=h===0?l[h].cPos:Math.min(l[h].cPos,l[h-1].ePos+1),m=l[h].ePos;if(!(m<c)){if(k>d)break;k<f&&(f=k);m>e&&(e=m);g.push(h)}}g[0]===1&&l[0].cPos===l[0].ePos&&l[0].cPos===l[1].cPos&&g.push(0);return{fragmentList:g,startPosition:f,endPosition:e}}function d(c,d){if(d!==
null)d.skeletonData=c.skeletonData,d.resourceInfo=c.resourceInfo,b(c),d.fragmentLoadMetrics=d.overallLoadMetrics.createSubTimer("fragments"),n.getBookFragments(function(b){j(d)?(d=null,k(b)):KindleRendererProcessTuning.runAfterYield(KindleRendererDeviceSpecific.yieldTimeOnContentReceived(),d.requestData.type,function(){var c=d;if(c===null||c.loadedFragments===null)k(b);else{c.numFragmentsLoaded+=1;var g=b.fragmentMetadata.id,e=l[g];if(b.wordList)for(var h in b.wordList)b.wordList[h]+=e.cPos;c.loadedFragments[g]=
b;if(!(c.numFragmentsLoaded<c.fragmentsToLoad.length)&&(c.fragmentLoadMetrics.endTimer(),c!==null)){var m,e=c.loadedFragments,g={},j;for(j in e)if(h=e[j].imageRefs)for(var o in h)g[h[o]]=!0;j=[];for(m in g)j.push(m);m=KindleRendererImageRenderer.resolveCompositeResources(j);m.length>0?a(m,c):f(c)}}})},function(){if(d!==null){var a=d.requestData;d.fragmentLoadMetrics.addCount("Failure",1);d.fragmentLoadMetrics.endTimer();var b=d.deferredResult;d.loadedFragments=null;d=d.glyphData=null;b.reject("Error trying to download file fragments.",
a)}},d.fragmentsToLoad)}function c(a){if(a!==void 0&&a!==null&&a.length>0&&o>0){var b=[],c,d,g,f;r=[];d=Math.min(a.length,o);c=o-d;for(g=0;g<a.length&&g<d;++g)f=a[g].glyphFragmentMetadata.id,b[f]=a[g],delete r[f];if(c>0)for(g in r)if(b[g]=r[g],--c===0)break;r=b}}function b(a){if(a.skeletonMetadata){var b=a.skeletonMetadata.id;q[b]===void 0&&(q={},q[b]=a)}}function f(a){function b(c){j(a)&&(a=null);KindleRendererProcessTuning.runAfterYield(KindleRendererDeviceSpecific.yieldTimeOnContentReceived(),
a&&a.requestData.type,function(){var b=a;b===null||b.glyphData===null?(c.glyphData=null,c.glyphFragmentMetadata=null):(b.glyphChunkLoadCnt+=1,b.glyphData.push(c),b.glyphChunkLoadCnt<b.glyphChunksToDownload.length||(b.glyphLoadMetrics.endTimer(),g(b)))})}function c(){if(a!==null&&a.glyphData!==null){var b=a.requestData,d=a.deferredResult;a.glyphLoadMetrics.addCount("Failure",1);a.glyphLoadMetrics.endTimer();a=a.glyphData=null;d.reject("Error trying to download glyph chunks.",b)}}if(a!==null){var d,
f=[],e=[],h;for(h in a.loadedFragments)if(d=m(parseInt(h,10)),d.gCks)for(var k=0;k<d.gCks.length;k+=1)$.inArray(d.gCks[k],e)===-1&&e.push(d.gCks[k]);d=[];for(h=0;h<e.length;h+=1)k=e[h],r[k]===void 0?d.push(k):f.push(r[k]);a.glyphData=f;d.length>0?(f=a.overallLoadMetrics.createSubTimer("glyph-loading"),f.addCount("NumGlyphCunks",d.length),a.glyphChunkLoadCnt=0,a.glyphChunksToDownload=d,a.glyphLoadMetrics=f,n.getGlyphFragments(b,c,d,a)):g(a)}}function a(a,b){var c=b.overallLoadMetrics.createSubTimer("resources");
b.fragmentResources={};b.fragmentResourceLoadCnt=0;b.fragmentResourceToDownload=a;b.fragmentResourceLoadMetrics=c;n.getResourceUrls(function(a){j(b)&&(b=null);KindleRendererProcessTuning.runAfterYield(KindleRendererDeviceSpecific.yieldTimeOnContentReceived(),b&&b.requestData.type,function(){var c=b;c!==null&&(c.fragmentResourceLoadCnt+=1,jQuery.extend(c.fragmentResources,a),c.fragmentResourceLoadCnt<c.fragmentResourceToDownload.length||(c.fragmentResourceLoadMetrics.endTimer(),f(c)))})},function(){if(b!==
null){var a=b.requestData,c=b.deferredResult;b.fragmentResourceLoadMetrics.addCount("Failure",1);b.fragmentResourceLoadMetrics.endTimer();b=null;c.reject("Error trying to download fragment resources.",a)}},a)}function g(a){if(!(a===null||a.loadedFragments===null)){c(a.glyphData);var b,d;for(d in a.loadedFragments)if(a.loadedFragments[d].fragmentMetadata.lId===void 0)b=m(parseInt(d,10)),a.loadedFragments[d].fragmentMetadata.lId=b.lId,a.loadedFragments[d].fragmentMetadata.lt=b.lt,a.loadedFragments[d].fragmentMetadata.nOff=
b.off;b=null;var g=a.deferredResult,f=a.requestData,e={};e.skeletonData=a.skeletonData;e.resourceInfo=a.resourceInfo;e.glyphData=a.glyphData;e.fragmentResources=a.fragmentResources;e.contentRange={skeletonId:a.skeletonId,startPosition:a.fragmentsStartPosition,endPosition:a.fragmentsEndPosition};e.fragmentData=a.loadedFragments;var h=a.overallLoadMetrics;a.glyphData=null;a.fragmentResources=null;var a=a.loadedFragments=null,k=h.createSubTimer("(YIELD) finish-content-fetch");setTimeout(function(){k.endTimer();
h.endTimer();g.resolve(f,e);e=f=null},KindleRendererDeviceSpecific.drawYieldUpdateTime())}}function k(a){a.fragmentData=null;a.fragmentMetadata=null;a.paraData=null}function m(a){return l[a]}var l=null,n=null,r=[],o,q={};return{initialize:function(a){r=[];o=KindleRendererDeviceSpecific.glyphCacheMaxSize();q={};n=a;var b=new jQuery.Deferred;n.getFragmentMap(function(a){l=a.fragmentArray;n.getManifest?n.getManifest(function(c){KindleRendererImageRenderer.initialize(c);b.resolve(a,c)},function(){b.resolve(a,
null)}):b.resolve(a)},function(){b.reject()});return b.promise()},cleanup:function(){n=l=null;r=[];q={};KindleRendererImageRenderer.cleanup()},loadNextFragmentGroup:function(a,b,c){function g(a){j(B)?B=null:(r.endTimer(),d(a,B))}function k(){if(B!==null){var a=B.requestData;B.fragmentLoadMetrics.addCount("Failure",1);B.fragmentLoadMetrics.endTimer();B=null;m.reject("Error trying to download skeleton.",a)}}function l(){w.endTimer();j(B)?B=null:(r=B.overallLoadMetrics.createSubTimer("skeletons"),q[a]!==
void 0?g(q[a]):n.getBookSkeleton(g,k,a))}var m=new jQuery.Deferred,b=h(b),o=c.metrics.createSubTimer("content-fetch"),r,b=e(a,b),b=h(b),z=b.fragmentList.slice(),B={deferredResult:m,skeletonId:a,fragmentsStartPosition:b.startPosition,fragmentsEndPosition:b.endPosition,overallLoadMetrics:o,loadedFragments:{},fragmentsToLoad:z,numFragmentsLoaded:0,requestData:c},w=o.createSubTimer("(YIELD) begin-content-fetch");z.length===0?f(B):setTimeout(l,KindleRendererDeviceSpecific.drawYieldUpdateTime());return m.promise()},
isContentRangeLoaded:function(a,b,c,d){if(a===null||a===void 0||!b||c===null||c===void 0||!d)return!1;if(a!==c)return!1;b=h(b);d=h(d);a=e(a,b);c=e(c,d);if(c.fragmentList.length>a.fragmentList.length)return!1;for(d=0;d<c.fragmentList.length;++d)if(a.fragmentList.indexOf(c.fragmentList[d])===-1)return!1;return!0}}}(),KindleRendererFragmentLoader=function(){function h(a){for(var b=0;b<c.length;b++){var d=c[b];if(d.start<=a&&a<=d.end)return b}return 0}function j(a){f=a;var g=new jQuery.Deferred;KindleRendererContentFragmentation.initialize(f).then(function(a){var f=
[],e,h=a.fragmentArray;for(e=0;e<h.length;e+=1){var j=h[e].sId,o=e===0?h[e].cPos:Math.min(h[e].cPos,h[e-1].ePos+1),q=h[e].ePos,t=f[j];if(t===void 0)f[j]={start:o,end:q};else{if(o<t.start)t.start=o;if(q>t.end)t.end=q}}if(a.skeletonMap!==void 0)for(e=0;e<a.skeletonMap.length;++e)if(f[e])f[e].properties=a.skeletonMap[e].properties;c=f;d=a.fragmentArray;b=a.fragmentMetadata.bookType;g.resolve()},g.reject);return g.promise()}function e(a,b,c){f.getBookFragments(function(a){KindleRendererProcessTuning.runAfterYield(KindleRendererDeviceSpecific.yieldTimeOnContentReceived(),
b.type,function(){var f=a.fragmentMetadata.id,e=d[f],h,j;h=a.fragmentMetadata.lId===void 0||a.fragmentMetadata.lId===null?e.lId:a.fragmentMetadata.lId;j=a.fragmentMetadata.nOff===void 0||a.fragmentMetadata.nOff===null?e.off:a.fragmentMetadata.nOff;var q=document.createElement("DIV");q.id=h;q.setAttribute("data-nid",h);q.innerHTML=a.fragmentData;h=q.childNodes;for(var t=h.length,s=0;s<t;s+=1)h[s].ownChildIndex=j+s;c.resolve(b,{id:f,contentRange:{startPosition:e.cPos,endPosition:e.ePos},fragmentRoot:q,
positionData:{posMap:a.posMap}})})},function(){c.reject("Error trying to download file fragments ID : ",a)},[a])}var d=null,c=null,b=!1,f=null;return{initialize:function(a){return j(a)},cleanup:function(){KindleRendererContentFragmentation.cleanup();c=d=null;b=!1},loadFragments:function(a,b){var c=h(a.focus);return KindleRendererContentFragmentation.loadNextFragmentGroup(c,a,b)},getFragmentAtId:function(a,b){var c=new jQuery.Deferred;f?e(a,b,c):c.reject();return c.promise()},getFragmentIdForPosition:function(a,
b){var c;a:{for(var f=0;f<d.length-1;++f)if(c=b?d[f+1].cPos-1:d[f].ePos,a<=c){c=f;break a}c=d.length-1}return c},needToLoadFragments:function(a,b){var c;if(!a||!b)c=!0;else{c=h(a.startPosition);var d=h(b.focus);c=!KindleRendererContentFragmentation.isContentRangeLoaded(c,a,d,b)}return c},getMaximumPosition:function(){return d[d.length-1].ePos},getMinimumPosition:function(){return d[0].cPos},isPositionAtBeginningOfSkeletonOrDocument:function(a,b){return b<=d[0].cPos||b===c[a].start},isPositionAtEndOfSkeletonOrDocument:function(a,
b){return b>=d[d.length-1].ePos||b===c[a].end},getBookContentType:function(){return b},getSkeletonForPosition:function(a){return h(a)},getSkeletonRange:function(a){return{start:c[a].start,end:c[a].end}},getGroupInfo:function(a){if(c[a].properties&&c[a].properties.group)return c[a].properties.group;var b=a%2===0?a+1:a-1;return b<0||b>=this.getNumSkeletons()||c[b].properties&&c[b].properties.group?{start:a,length:1,spine:!0}:{start:Math.min(a,b),length:2,spine:!0}},isBlankPage:function(a){return!c[a].properties?
!1:c[a].properties.blank===!0},getNumSkeletons:function(){return c.length},getFragmentMap:function(){}}}(),KindleRendererPositionLoadingCalculator=function(){function h(){if(b>0)return b;var c,a;a=KindleRendererSettings.getSettings();if(KindleRendererFragmentLoader.getBookContentType()==="topaz")c=e.width/(25*a.glyphScale),a=e.height/(25*a.glyphScale);else{var d=a.fontSizes[j];c=e.width/(d*0.4);a=e.height/(d*a.lineSpacingMultiplier)}return Math.round(c*a)}var j=2,e={height:1,width:1},d=0,c=[],b=0;
return{updateScreenDimensions:function(c,a){e.width=c;e.height=a;b=_displayedScreenCount=_logSumPositionsDisplayed=0},updateDisplayedPositionRange:function(f){f>0&&(c[d]=f,d=(d+1)%10,b=0,b=Math.max.apply(Math,c))},calculateDesiredFragmentRangeForPageFlip:function(b,a){var c=KindleRendererFragmentLoader.getBookContentType()==="topaz",d=KindleRendererDeviceSpecific.fragmentBufferCapacityForPageFlip(c),e=h();d*=e;var l=Math.ceil(d*0.25),j=Math.ceil(d*0.75),d=KindleRendererFragmentLoader.getMinimumPosition(),
r=KindleRendererFragmentLoader.getMaximumPosition(),l=Math.max(d,b-l),j=Math.min(r,b+j),o=a.currentTopOfPage,q=a.currentBottomOfPage;c?(l=Math.min(l,Math.max(d,o-1)),j=Math.max(j,Math.min(r,q+1))):b<o&&o-b<3*e?j=Math.min(r,q+1):b>q&&b-q<3*e&&(l=Math.max(d,o-1));return{focus:b,startPosition:l,endPosition:j}},calculateDesiredFragmentRangeForGoTo:function(b){var a=h()*KindleRendererDeviceSpecific.fragmentBufferCapacityForGoTo(),c=Math.ceil(a*0.1),a=Math.ceil(a),d=KindleRendererFragmentLoader.getMinimumPosition(),
e=KindleRendererFragmentLoader.getMaximumPosition();return{focus:b,startPosition:Math.max(d,b-c),endPosition:Math.min(e,Math.max(d+a,b+a))}}}}(),KindleRendererRequestId=function(){var h=0;return{getUniqueRequestId:function(){h+=1;return h}}}(),KindleRendererIframeLoading=function(){function h(){window.focus()}function j(a){a.ctrlKey&&a.preventDefault();switch(a.which){case 219:case 221:a.shiftKey||a.preventDefault();break;case 37:case 38:case 33:case 39:case 40:case 34:case 32:case 8:a.preventDefault()}}
function e(a,b){var c=b.ownerDocument.createEvent("CustomEvent");c.initCustomEvent(a.type,!0,!0,a);b.dispatchEvent(c)}function d(a,b){var c=b.ownerDocument.createEvent("MSPointerEvent");c.initPointerEvent(a.type,!0,!0,window.parent,a.detail,a.screenX,a.screenY,a.clientX,a.clientY,a.ctrlKey,a.altKey,a.shiftKey,a.metaKey,a.button,null,a.offsetX,a.offsetY,a.width,a.height,a.pressure,a.rotation,a.tiltX,a.tiltY,a.pointerId,a.pointerType,a.hwTimestamp,a.isPrimary);b.dispatchEvent(c)}function c(a,b){var c;
a.type==="mousewheel"?(a.preventDefault(),c=b.ownerDocument.createEvent("WheelEvent"),c.initWheelEvent(a.type,!0,!0,window.parent,-1*a.wheelDelta,a.screenX,a.screenY,a.clientX,a.clientY,a.button,null,null,a.deltaX,a.deltaY,a.deltaZ,a.deltaMode)):(c=b.ownerDocument.createEvent("MouseEvent"),c.initMouseEvent(a.type,!0,!0,window.parent,a.detail,a.screenX,a.screenY,a.clientX,a.clientY,a.ctrlKey,a.altKey,a.shiftKey,a.metaKey,a.button,null));b.dispatchEvent(c)}function b(a){var b=a.contentDocument.getElementsByTagName("body")[0];
b.className+=" amzUserPref";var f=a.contentDocument.getElementsByTagName("head")[0];KindleRendererDefaults.addCSSRules(f,KindleRendererFragmentLoader.getBookContentType());KindleRendererSettings.addCSSRules(f);KindleRendererContentScripts.addInterfaceScripts(a);b.onmousewheel=function(b){c(b,a);return!1};a.contentWindow.onkeydown=function(b){j(b);e(b,a)};a.contentWindow.onkeyup=function(b){j(b);e(b,a)};a.contentWindow.onkeypress=function(b){j(b);e(b,a)};if(KindleRendererSettings.useNativeSelection()){if(window.navigator.msPointerEnabled)b.onmspointerdown=
function(b){d(b,a)},b.onmspointerup=function(b){d(b,a)},b.onmspointermove=function(b){d(b,a)},b.onmspointerout=function(b){d(b,a)},b.onmspointercancel=function(b){d(b,a)},b.onmspointerover=function(b){d(b,a)},b.onmspointerhover=function(b){d(b,a)},b.addEventListener("MSGestureHold",function(a){a.preventDefault()},!1);b.oncontextmenu=function(b){d(b,a);b.preventDefault()};b.onclick=function(b){c(b,a)};b.ondblclick=function(b){c(b,a)};b.onmousedown=function(b){c(b,a)};b.onmouseup=function(b){c(b,a)};
b.onmousemove=function(b){c(b,a)};b.onmouseover=function(b){c(b,a)};b.onmouseout=function(b){c(b,a)}}else a.contentWindow.onfocus=h,a.contentWindow.onclick=h,b.onselectstart=function(){return!1}}function f(a){if(a=a.getElementsByTagName("body")[0])for(;a.hasChildNodes();)a.removeChild(a.lastChild)}function a(b,c){if(b&&b.nodeType===Node.ELEMENT_NODE){var d=b.getAttribute("data-nid");d!==null&&(c[d]={linkNode:b,typeArray:[b.firstChild,b.nextSibling]});for(var d=b.childNodes,f=d.length,g=0;g<f;g+=1)a(d[g],
c)}}function g(b){var c={};try{if(window.ActiveXObject&&window.XMLHttpRequest)a(b.contentDocument.body,c);else for(var d=(new XPathEvaluator).evaluate("//*[@data-nid]",b.contentDocument,null,XPathResult.UNORDERED_NODE_ITERATOR_TYPE,null),f=d.iterateNext();f;){var g=f.getAttribute("data-nid");c[g]={linkNode:f,typeArray:[f.firstChild,f.nextSibling]};f=d.iterateNext()}}catch(e){a(b.contentDocument.body,c)}return c}function k(a){var b=[],c;for(c in a)b.push(parseInt(c,10));b.sort(function(a,b){return a-
b});return b}function m(a,b,c,d){function f(){if(L!==null)F.insertBefore(L,P),L=null,M.lId=null,M.lt=-1}function g(){h=c.fragmentData[A[O]];l=h.fragmentMetadata;if(M.lId!==l.lId||M.lt!==l.lt){f();M.lId=l.lId;M.lt=l.lt;N=b[l.lId];if(N===void 0){var k=b,G=l.lId,V=a.contentDocument.getElementById(G);k[G]={linkNode:V,typeArray:[V.firstChild,V.nextSibling]};N=b[l.lId]}L=l.lt===0?N.linkNode:N.linkNode.parentNode;F=L.parentNode;P=L.nextSibling;L=F.removeChild(L)}D=a.contentDocument.createElement(L.tagName);
D.innerHTML=h.fragmentData;k=c.fragmentResources;G=h.resList===void 0?h.imageData:h.resList;if(k||G)for(var V=$(D).find("img"),da=0,W=0;W<V.length;W+=1){da=V[W].getAttribute("dataUrl");if(da===void 0||da===null)da=V[W].getAttribute("src");KindleRendererImageRenderer.loadImage(V[W],k,G,da)}for(k=l.nOff;D.hasChildNodes();){G=D.removeChild(D.firstChild);if(G.nodeType===Node.TEXT_NODE)G.ownChildIndex=k;L.insertBefore(G,N.typeArray[l.lt]);k+=1}if(h.posMap!==void 0){n=!0;for(var ca in h.posMap)j[ca]=h.posMap[ca]}h.wordList!==
void 0&&(r=!0,m=m.concat(h.wordList));if(h.paraIds!==void 0&&h.paraIds!==null){K=!0;for(ca=0;ca<h.paraIds.length;ca+=1)w[h.paraIds[ca]]=h.paraData[ca];for(var ea in h.imageData)E[ea]=h.imageData[ea]}h.fragmentData=null;h.imageData=null;h.paraData=null;O+=1;if(O<A.length)O%50===49?setTimeout(g,0):KindleRendererProcessTuning.runAfterYield(KindleRendererDeviceSpecific.yieldTimeLoadNextFragment(),d.type,g);else{f();P=L=F=h=null;ea={positionData:{}};if(n)ea.positionData.posMap=j;if(r)ea.positionData.wordList=
m;if(K)ea.glyphData={paraData:w,imageData:E};e.resolve(ea)}}var e=$.Deferred(),h,l,j={},m=[],n=!1,r=!1,w={},E={},K=!1,D=null,M={lId:null,lt:-1},N=null,F=null,L=null,P=null,A=k(c.fragmentData),O=0;KindleRendererProcessTuning.runAfterYield(KindleRendererDeviceSpecific.yieldTimeLoadNextFragment(),d.type,g);return e.promise()}function l(a,b,c){KindleRendererProcessTuning.runAfterYield(KindleRendererDeviceSpecific.yieldTimeBeforeBulkWriteToIframe(),c.type,function(){KindleHostDeviceDetector.isFirefox&&
KindleHostDeviceDetector.isFirefox()||KindleHostDeviceDetector.isMSEdge&&KindleHostDeviceDetector.isMSEdge()?b.open("text/html","replace"):b.open();b.write(a);KindleRendererProcessTuning.runAfterYield(KindleRendererDeviceSpecific.yieldTimeAfterBulkWriteToIframe(),c.type,function(){b.close()})})}function n(a,c,d,g){if(a.processingRequestId.id===c.requestId){var e=a.contentDocument;a.screenManager=null;f(e);KindleGlyphRenderer.clearIframeData(a);a.onload=function(){KindleRendererProcessTuning.runAfterYield(KindleRendererDeviceSpecific.yieldTimeAfterIframeLoaded(),
c.type,function(){if(a.processingRequestId.id===c.requestId){a.onload=null;var f=KindleRendererSettings.getSettings(),e=$(a).parent(),e={height:e.height(),width:e.width()},h=c.contentLoadMetrics.createSubTimer("css-style-sanitization");KindleRendererContentStyleSanitization.sanitizeCSS(a.contentDocument,f,e);h.endTimer();b(a);a.writingMode=KindleRendererWritingModeFactory.buildIFrameWritingMode(a);a.writingMode.resetIframeDimensions(a);r(a,c,d,g)}})};l(d.skeletonData,e,c)}}function r(a,b,c,d){function f(a){d.reject(b,
a)}var e=g(a),h=b.contentLoadMetrics.createSubTimer("fragment-loading"),k;try{k=m(a,e,c,b)}catch(l){f(l);return}k.then(function(c){h.endTimer();var g=KindleRendererSettings.getSettings(),e=$(a).parent(),e={height:e.height(),width:e.width()},k=b.contentLoadMetrics.createSubTimer("node-style-sanitization");KindleRendererContentStyleSanitization.sanitizeContent(a.contentDocument,g,e).then(function(){k.endTimer();d.resolve(b,c)},f)},f)}return{loadIframe:function(a,b,c){var d=new jQuery.Deferred;a.processingRequestId.id===
b.requestId?n(a,b,c,d):d.reject();return d.promise()},copyIframeContents:function(a,c,d){function g(){KindleRendererProcessTuning.runAfterYield(KindleRendererDeviceSpecific.yieldTimeAfterIframeLoaded(),a.type,function(){if(d.processingRequestId.id===a.requestId)b(d),KindleRendererContentStyleSanitization.copySanitizationData(c.contentDocument,d.contentDocument),KindlePaginator.copyIframe(c,d),d.onload=null,d.writingMode.prepareForPagination(d),e.resolve(a)})}var e=new jQuery.Deferred,h,k;d.processingRequestId.id===
a.requestId?(k=c.contentDocument.getElementsByTagName("html")[0],f(d.contentDocument),d.writingMode.resetHeight(d),d.onload=g,h=k.outerHTML,h===void 0&&(h="<html>"+k.innerHTML+"</html>"),l(h,d.contentDocument,a)):e.reject();return e.promise()},cleanupIframe:function(a){f(a.contentDocument)},updateSettingsInIframe:function(a){if(a&&a.contentDocument){var b=a.contentDocument.getElementsByTagName("head")[0];if(b){KindleRendererSettings.addCSSRules(b);var b=KindleRendererSettings.getSettings(),c={height:$(a).parent().height(),
width:$(a).parent().width()},d=KindleMetricsProfiler("style-sanitization");KindleRendererContentStyleSanitization.sanitizeCSS(a.contentDocument,b,c);KindleRendererContentStyleSanitization.sanitizeContent(a.contentDocument,b,c);d.endTimer()}}}}}(),KindleRendererIframeManagerFactory=function(){function h(d){d.cancelCurrentRequest=function(){if(this.currentRequest)this.currentRequest.cancelled=!0,this.currentRequest=null};d.createNewRequest=function(a,b){this.cancelCurrentRequest();this.currentRequest=
{type:a,requestId:KindleRendererRequestId.getUniqueRequestId(),metrics:KindleMetricsProfiler("iframe-load"),retryCount:0,initialPosition:b};this.currentRequestDfd=new jQuery.Deferred};d.willRetryCurrentRequest=function(){this.currentRequest&&this.currentRequest.retryCount++};d.canRetryCurrentRequest=function(){return this.currentRequest?this.currentRequest.retryCount<a:!0};d.getCurrentProcessDfd=function(){return this.currentRequestDfd.promise()};d.getCurrentProcessId=function(){return this.currentRequest.requestId};
d.createIframe=function(a,b,c){var d=document.createElement("iframe");d.writingMode=KindleRendererWritingModeFactory.buildIFrameWritingMode(d);d.index=c;d.processingRequestId={};d.computingRectsId={};d.setAttribute("frameBorder","0");d.setAttribute("id",b+"_frame_"+c);d.setAttribute("name","book_iframe_"+c);d.setAttribute("scrolling","no");d.setAttribute("tabindex",-1);$(d).css({height:"100%",width:a+"px",position:"absolute","margin-top":"0px",left:"0px",visibility:"hidden","z-index":g});return d};
d.setIframeVisibility=function(a,b){if(this.showContent||!b)if(b){if($(a).css({visibility:"visible","z-index":0,"margin-top":"0px"}),$(a.pageOverflowDiv).css({visibility:"visible","z-index":0}),KindleHostDeviceDetector.hasImageRenderingProblem&&KindleHostDeviceDetector.hasImageRenderingProblem()){var c=a.contentDocument.querySelector("img[data-repaint-on-show]");if(c){var d=function(){c.style.borderColor="#FFF"};setTimeout(d,1);setTimeout(d,1500)}}}else $(a).css({visibility:"hidden","z-index":g,"margin-top":k+
"px"}),$(a.pageOverflowDiv).css({visibility:"hidden","z-index":g})};d.calculateIframePaginationData=function(a,b,c){var d=this,g=KindleRendererFragmentLoader.getBookContentType()==="topaz"?d.currentRequest.type===d.loadedType.PREVIOUS?KindleRendererIframePreparation.CANVAS_INSERTION_PREVIOUS:KindleRendererIframePreparation.CANVAS_INSERTION_NEXT:KindleRendererIframePreparation.CANVAS_INSERTION_NONE;KindleRendererIframePreparation.prepareIframe(a,d.currentRequest,b,c,g).then(function(b){if(a.processingRequestId.id===
b.requestId&&d.currentRequest&&d.currentRequest.requestId===b.requestId)a.processingRequestId.id=null,d.frameIsLoadedAndReady(a);d=null},function(a){d.currentRequest&&d.currentRequest.requestId===a.requestId&&d.currentRequestDfd.reject(f);d=null})};d.loadContentDataIntoIframe=function(a){var c=this;c.currentRequest.contentLoadMetrics=c.currentRequest.metrics.createSubTimer("content-load");var d=c.getIframeToLoad();if(d)c.contentRange[d.index]=a.contentRange,d.processingRequestId.id=c.currentRequest.requestId,
d.computingRectsId.id=null,KindleRendererIframeLoading.loadIframe(d,c.currentRequest,a).then(function(b,f){if(d.processingRequestId.id===b.requestId&&c.currentRequest&&c.currentRequest.requestId===b.requestId)c.positionData[d.index]=f.positionData,c.calculateIframePaginationData(d,a,f);c=null},function(a){c.currentRequest&&c.currentRequest.requestId===a.requestId&&c.currentRequestDfd.reject(b);c=null})};d.loadFragmentsForRange=function(a){var b=this;KindleRendererFragmentLoader.loadFragments(a,b.currentRequest).then(function(a,
c){b.currentRequest&&b.currentRequest.requestId===a.requestId&&b.loadContentDataIntoIframe(c);b=null},function(a,d){b.currentRequest&&b.currentRequest.requestId===d.requestId&&b.currentRequestDfd.reject(c);b=null})};d.resizeWithoutReload=function(a){var b=this,c=this.iframes[a];c.processingRequestId.id=this.currentRequest.requestId;b.setIframeVisibility(c,!1);b.currentRequest.contentLoadMetrics=b.currentRequest.metrics.createSubTimer("content-load");KindleRendererContentReflow.reflow(c,this.currentRequest,
this.positionData[a]).then(function(){b.currentRequest&&b.currentRequest.requestId===c.processingRequestId.id&&(b.frameIsLoadedAndReady(c),b.setIframeVisibility(c,c.index===b.visibleIframeIndex));b=null},function(){b.currentRequest&&b.currentRequest.requestId===c.processingRequestId.id&&(b.setIframeVisibility(c,c.index===b.visibleIframeIndex),b.currentRequestDfd.reject(f));b=null})};d.setCanPreloadNext=function(a){this.canPreloadNext=a};d.setCanPreloadPrevious=function(a){this.canPreloadPrevious=
a};d.getIframeOrigin=function(a){a=$(this.iframes[a]);return{x:parseInt(a.css("left"),10),y:parseInt(a.css("top"),10)}};d.getBoundsWithOffset=function(a,b){if(a.getBoundingClientRect){var c=a.getBoundingClientRect();if(c)return{top:c.top+b.y,right:c.right+b.x,bottom:c.bottom+b.y,left:c.left+b.x,width:c.width,height:c.height}}return null}}function j(a,b){a.gotoPosition=function(a,c){return b.gotoPosition(a,c)};a.nextScreen=function(){return b.nextScreen()};a.previousScreen=function(){return b.previousScreen()};
a.copyIframeData=function(a){return b.copyIframeData(a.internal)};a.hasNextScreen=function(){return b.hasNextScreen()};a.hasPreviousScreen=function(){return b.hasPreviousScreen()};a.getPagePositionRange=function(){return b.getPagePositionRange()};a.getCurrentPosition=function(){return b.getCurrentPosition()};a.getSelectableItemBoundaries=function(){return b.getSelectableItemBoundaries()};a.getWordPositions=function(){return b.getWordPositions()};a.reloadAnnotations=function(){b.reloadAnnotations()};
a.updateGlyphColor=function(){b.updateGlyphColor()};a.handleClick=function(a,c){return b.handleClick(a,c)};a.cleanup=function(){b.cleanup()};a.updateSettings=function(a){b.updateSettings(a)};a.reloadNotification=function(){b.reloadNotification()};a.resizeNotification=function(){b.resizeNotification()};a.setAnnotationEventCallback=function(a){b.setAnnotationEventCallback(a)};a.getCurrentProcessDfd=function(){return b.getCurrentProcessDfd()};a.getComputedRectsDfd=function(){return b.getComputedRectsDfd()};
a.getCurrentProcessId=function(){return b.getCurrentProcessId()};a.show=function(){b.show()};a.hide=function(){b.hide()};a.getContentRects=function(){return b.getContentRects()};a.getZoomableAt=function(a,c,d){return b.getZoomableAt(a,c,d)};a.getZoomableList=function(a){return b.getZoomableList(a)};a.setOverlayManager=function(a){b.setOverlayManager(a)};a.setCanPreloadPrevious=function(a){b.setCanPreloadPrevious(a)};a.setCanPreloadNext=function(a){b.setCanPreloadNext(a)};a.drawWordMap=function(){b.drawWordMap()};
a.drawHeightMaps=function(){b.drawHeightMaps()};a.clearSelection=function(){b.clearSelection()};a.getSelection=function(){return b.getSelection()}}function e(a){a.showContent=!0;a.canPreloadNext=!0;a.canPreloadPrevious=!0}var d=0,c=d++,b=d++,f=d++,a=5,g=-1E3,k=1E4;return{DATA_LOAD_ERROR:c,IFRAME_ERROR_LOADING:b,IFRAME_ERROR_PAGINATING:f,build:function(a){if(KindleRendererSettings.useCSSRegions()){var b={};e(b,a);h(b);KindleRegionIframeManager.build(b,a);a={internal:b}}else KindleRendererSettings.getSettings().fixedContent?
(b={},e(b,a),h(b),KindleRendererIframeManagerFixedFactory.build(b,a),a={}):(b={},e(b,a),h(b),KindleRendererIframeManagerReflowFactory.build(b,a),a={internal:b});j(a,b);return a}}}(),KindleRendererIframeManagerFixedFactory=function(){function h(e){e.findNextNonBlankPage=function(d,c){var b=this.findNextNonBlankPageInDirection(d,c);b===null&&(b=this.findNextNonBlankPageInDirection(d,!c));return b};e.findNextNonBlankPageInDirection=function(d,c){for(var b=d,f=KindleRendererFragmentLoader.getNumSkeletons();b>=
0&&b<f;){if(KindleRendererFragmentLoader.isBlankPage(b)===!1)return b;c?b+=1:b-=1}return null};e.getNeededSkeletonsFrom=function(d,c){for(var b=this.getSkeletonsToShowWith(d,c),f=0;f<b.length;f++)if(KindleRendererFragmentLoader.isBlankPage(b[f])===!1)return b;f=this.findNextNonBlankPage(c?Math.max.apply(Math,b)+1:Math.min.apply(Math,b)-1,c);return f===null?b:this.getSkeletonsToShowWith(f,c)};e.addSkeletonRangeToList=function(d,c,b){for(var f=0;f<b;f+=1)d.push(c+f)};e.getSkeletonsToShowWith=function(d,
c){var b=KindleRendererFragmentLoader.getGroupInfo(d);if(b.length>this.numberOfColumns){var f=[];this.addSkeletonRangeToList(f,d,Math.min(this.numberOfColumns,b.length-(d-b.start)));return f}return this.getGroupsToFillScreen(b,c)};e.getGroupsToFillScreen=function(d,c){var b=[];this.addSkeletonRangeToList(b,d.start,d.length);var f;f=c?d.start+d.length:d.start-1;for(var a=KindleRendererFragmentLoader.getNumSkeletons();b.length<this.numberOfColumns&&f>=0&&f<a;){var g=KindleRendererFragmentLoader.getGroupInfo(f);
if(b.length+g.length<=this.numberOfColumns)this.addSkeletonRangeToList(b,f,g.length);else break;c?f+=g.length:f-=g.length}return b};e.getNeededSkeletonsForGoTo=function(d){return this.getNeededSkeletonsFrom(KindleRendererFragmentLoader.getSkeletonForPosition(d),!0)};e.getNeededSkeletonsForPageFlip=function(d){var c=this.getCurrentlyVisibleSkeletons();return d>0?(d=Math.max.apply(Math,c),d=Math.min(d+1,KindleRendererFragmentLoader.getNumSkeletons()),this.getNeededSkeletonsFrom(d,!0)):(d=Math.min.apply(Math,
c),d=Math.max(d-1,0),this.getNeededSkeletonsFrom(d,!1))};e.clearCacheReservations=function(){for(var d=this.iframeStatus.length,c=0;c<d;c++)if(this.iframeStatus[c]===this.statusType.RESERVED)this.iframeStatus[c]=this.statusType.AVAILABLE};e.getLoadedSkeletons=function(){for(var d={},c=this.contentRange.length,b=0;b<c;b++)this.contentRange[b]&&this.iframes[b].processingRequestId.id===null&&(d[this.contentRange[b].skeletonId]=b);return d};e.reserveSkeletonsInCache=function(d){this.clearCacheReservations();
for(var c=this.getLoadedSkeletons(),b=[],f=0;f<d.length;f++){var a=d[f],g=c[a];if(g===void 0)b.push(a);else if(this.iframeStatus[g]===this.statusType.AVAILABLE)this.iframeStatus[g]=this.statusType.RESERVED}return b};e.getIndicesToShow=function(d){for(var c=this.getLoadedSkeletons(),b=[],f=0;f<d.length;f++)b.push(c[d[f]]);return b};e.shouldShowSpineAfterSkeleton=function(d){var d=this.contentRange[d].skeletonId,c=KindleRendererFragmentLoader.getGroupInfo(d),b=c.start+c.length-1;return c.spine||d===
b?!0:!1};e.getSpineCountForIndicies=function(d){var c=0;for(i=0;i<d.length-1;i++)this.shouldShowSpineAfterSkeleton(d[i])&&c++;return c};e.prepareSpine=function(){var d={position:"absolute",visibility:"visible","background-color":this.spineColor,"z-index":j},c=this.getAvailableSpine();$(c).css(d);return c};e.getAvailableSpine=function(){for(i=0;i<this.spines.length;i++)if(this.spines[i].status===this.statusType.AVAILABLE)return this.spines[i];var d=document.createElement("div");this.parent.appendChild(d);
d.status=this.statusType.RESERVED;this.spines.push(d);return d};e.removeAllSpines=function(){for(i=0;i<this.spines.length;i++)$(this.spines[i]).css("visibility","hidden"),this.spines[i].status=this.statusType.AVAILABLE};e.isRTLProgression=function(){var d=KindleRendererSettings.getSettings().pageProgressionDirection;return d?d.value===d.RTL:!1};e.prepareDisplayElements=function(d,c,b){for(var f,a=[],g=0;g<d.length;g++){f=this.iframes[d[g]];var e=KindleRendererElementFitting.resize(f.contentDocument.body,
c),h=Math.round((c.height-e.height)*0.5)+"px";$(f).css({top:h,height:e.height+"px",width:e.width+"px"});a.push(f);if(g!==d.length-1&&this.shouldShowSpineAfterSkeleton(d[g])){var j=this.prepareSpine();$(j).css({top:h,height:e.height+"px",width:this.columnGap+"px"});a.push(j)}this.iframeStatus[f.index]=this.statusType.VISIBLE;this.setIframeVisibility(f,!0);b[f.index]=!1}return a};e.placeElementsHorizontally=function(d,c){var b=0,f;for(f=0;f<d.length;f++)b+=$(d[f]).width();var a,g=Math.floor((c-b)*0.5);
for(f=0;f<d.length;f++)b=d[f],a=$(b).width(),$(b).css({left:this.isRTLProgression()?c-(g+a):g}),g+=a};e.showSkeletons=function(d){var d=this.getIndicesToShow(d.sort(function(a,b){return a-b})),c=this.getCurrentlyVisibleIndices(),b={},f;for(f=0;f<c.length;f++)b[c[f]]=!0;if(d.length>0){var a=$(this.parent).height(),c=$(this.parent).width(),a={width:Math.round((c-this.columnGap*this.getSpineCountForIndicies(d))/d.length),height:a};this.removeAllSpines();this.placeElementsHorizontally(this.prepareDisplayElements(d,
a,b),c)}for(f in b)if(b[f])this.iframeStatus[f]=this.statusType.AVAILABLE,this.setIframeVisibility(this.iframes[f],!1)};e.getCurrentlyVisibleIndices=function(){for(var d=[],c=this.iframeStatus.length,b=0;b<c;b++)this.iframeStatus[b]===this.statusType.VISIBLE&&d.push(b);return d};e.getSkeletonsFromIndices=function(d){for(var c=[],b=0;b<d.length;b++){var f=this.contentRange[d[b]];f&&c.push(f.skeletonId)}return c};e.getCurrentlyVisibleSkeletons=function(){return this.getSkeletonsFromIndices(this.getCurrentlyVisibleIndices())};
e.getPrioritizedPreloadList=function(d){var c=d.slice(0);if(d.length>0)for(var b=KindleRendererFragmentLoader.getNumSkeletons(),f=this.iframes.length,a=Math.min.apply(Math,d),d=Math.max.apply(Math,d);c.length<f&&(a>0||d<b-1);){var g;for(g=0;g<this.numberOfColumns&&d<b-1&&c.length<f;g++)d++,c.push(d);for(g=0;g<this.numberOfColumns&&a>0&&c.length<f;g++)a--,c.push(a)}return c};e.getLowestPriority=function(d){for(var c=this.iframes.length,b=0,f=-1,a=0;a<c;a++){var g=this.contentRange[a];if(!g)return{iframeIndex:a,
priorityRating:-Infinity};if(this.iframeStatus[a]===this.statusType.AVAILABLE)if(g=$.inArray(g.skeletonId,d),g===-1)return{iframeIndex:a,priorityRating:-Infinity};else g>f&&(f=g,b=a)}return{iframeIndex:b,priorityRating:c-f}};e.pickSkeletonToPreload=function(d){for(var c=this.getLoadedSkeletons(),b=0;b<d.length;b++)if(c[d[b]]===void 0)return{skeletonId:d[b],priorityRating:d.length-b};return null};e.considerLoadingMoreSkeletons=function(){if(!this.currentRequest){var d=this.getPrioritizedPreloadList(this.getCurrentlyVisibleSkeletons()),
c=this.pickSkeletonToPreload(d);if(c!==null&&this.getLowestPriority(d).priorityRating<c.priorityRating)this.createNewRequest(this.loadedType.PRELOAD,null),this.currentRequest.skeletons=[c.skeletonId],this.loadFragmentsForRange(this.getDesiredRangeForSkeleton(c.skeletonId))}};e.updateSettings=function(d){if(d.columns!==void 0){if(d.columns.num!==void 0)this.numberOfColumns=d.columns.num;if(d.columns.gap!==void 0)this.columnGap=d.columns.gap;if(d.columns.spineColor!==void 0)this.spineColor=d.columns.spineColor}};
e.getIframeToLoad=function(){return this.currentRequest?this.iframes[this.getLowestPriority(this.getPrioritizedPreloadList(this.currentRequest.type===this.loadedType.PRELOAD?this.getCurrentlyVisibleSkeletons():this.currentRequest.skeletons)).iframeIndex]:null};e.getDesiredRangeForSkeleton=function(d){d=KindleRendererFragmentLoader.getSkeletonRange(d);return{focus:d.start,startPosition:d.start,endPosition:d.end}};e.frameIsLoadedAndReady=function(){var d=this.currentRequest,c=this.reserveSkeletonsInCache(d.skeletons);
c.length>0?this.loadFragmentsForRange(this.getDesiredRangeForSkeleton(c[0])):(d.type===this.loadedType.PRELOAD&&this.clearCacheReservations(),d.initialPosition!==null&&this.showSkeletons(d.skeletons),d.metrics.endTimer(),d.metrics.log(),this.currentRequest=null,setTimeout(this.currentRequestDfd.resolve,10),d.type!==this.loadedType.PAGE_FLIP&&this.considerLoadingMoreSkeletons())};e.pageFlip=function(d){var d=this.getNeededSkeletonsForPageFlip(d),c=this.reserveSkeletonsInCache(d),b=Math.max.apply(Math,
d);this.currentPosition=KindleRendererFragmentLoader.getSkeletonRange(b).start;if(c.length>0)return this.createNewRequest(this.loadedType.PAGE_FLIP,null),this.currentRequest.skeletons=d,this.loadFragmentsForRange(this.getDesiredRangeForSkeleton(c[0])),!1;this.showSkeletons(d);this.considerLoadingMoreSkeletons();return!0};e.nextScreen=function(){return this.pageFlip(1)};e.previousScreen=function(){return this.pageFlip(-1)};e.gotoPosition=function(d,c){var b=this.getNeededSkeletonsForGoTo(d),f=this.reserveSkeletonsInCache(b);
if(c){var a=Math.max.apply(Math,b);this.currentPosition=KindleRendererFragmentLoader.getSkeletonRange(a).start}if(f.length>0)return this.createNewRequest(this.loadedType.GOTO,d),this.currentRequest.skeletons=b,this.loadFragmentsForRange(this.getDesiredRangeForSkeleton(f[0])),!1;this.clearCacheReservations();this.showSkeletons(b);return!0};e.getPagePositionRange=function(){var d=this.getCurrentlyVisibleIndices();if(d.length===0)return null;for(var c=Infinity,b=-Infinity,f=0;f<d.length;f++)var a=this.contentRange[d[f]],
c=Math.min(c,a.startPosition),b=Math.max(b,a.endPosition);return{currentTopOfPage:c,currentBottomOfPage:b}};e.getCurrentPosition=function(){return this.currentPosition};e.cleanup=function(){this.cancelCurrentRequest();for(var d=0;d<this.iframes.length;d++)KindleRendererIframeLoading.cleanupIframe(this.iframes[d]),KindlePaginator.cleanupIframe(this.iframes[d]),this.contentRange[d]=null,this.positionData[d]=null;this.iframes=null};e.hasNextScreen=function(){for(var d=this.getCurrentlyVisibleSkeletons(),
c=KindleRendererFragmentLoader.getNumSkeletons()-1,b=0;b<d.length;b++)if(d[b]===c)return!1;return!0};e.hasPreviousScreen=function(){for(var d=this.getCurrentlyVisibleSkeletons(),c=0;c<d.length;c++)if(d[c]===0)return!1;return!0};e.getSortedVisibleIndicies=function(){for(var d,c=[],b=this.getCurrentlyVisibleIndices(),f=0;f<b.length;f++){d=b[f];var a=this.contentRange[d].skeletonId;KindleRendererFragmentLoader.isBlankPage(a)||c.push([a,d])}c.sort(function(a,b){return a[0]-b[0]});d=[];for(f=0;f<c.length;f++)d.push(c[f][1]);
return d};e.getContentRects=function(){for(var d=this.getSortedVisibleIndicies(),c=[],b=0;b<d.length;b++){var f=d[b],a=this.iframes[f],f=this.getIframeOrigin(f);c.push(this.getBoundsWithOffset(a.contentDocument.body,f))}return c};e.getZoomableAt=function(d,c,b){for(var f=this.getCurrentlyVisibleIndices(),a=0;a<f.length;a++){var g=f[a],e=$(this.iframes[g]),e={x:d.x+parseInt(e.css("left"),10),y:d.y+parseInt(e.css("top"),10)};if(g=KindleRendererZoomablesFactory.buildFromCoord(this.iframes[g].contentDocument,
e,c,b))return g}return null};e.getZoomableList=function(d){for(var c=[],b=this.getSortedVisibleIndicies(),f=0;f<b.length;f++)var a=b[f],g=$(this.iframes[a]),g={x:d.x+parseInt(g.css("left"),10),y:d.y+parseInt(g.css("top"),10)},c=c.concat(KindleRendererZoomablesFactory.buildList(this.iframes[a].contentDocument,g));return c};e.getSelectableItemBoundaries=function(){return{}};e.getComputedRectsDfd=function(){return null};e.getWordPositions=function(){return null};e.show=function(){this.showContent=!0;
for(var d=this.getCurrentlyVisibleIndices(),c=0;c<d.length;c++)this.setIframeVisibility(this.iframes[d[c]],!0)};e.hide=function(){this.showContent=!1;for(var d=this.getCurrentlyVisibleIndices(),c=0;c<d.length;c++)this.setIframeVisibility(this.iframes[d[c]],!1)};e.handleClick=function(d,c){for(var b=this.getCurrentlyVisibleIndices(),f,a=0;a<b.length;a++){var g=this.iframes[b[a]],e=g.offsetLeft,h=g.offsetTop,j=g.offsetHeight,n=g.offsetWidth;if(d>=e&&d<=e+n&&c>=h&&c<=h+j){f=g;break}}return f?(d-=parseInt(f.offsetLeft,
10),c-=parseInt(f.offsetTop,10),b=KindleRendererUtils.elementFromPoint(f.contentDocument,d,c),KindleRendererEventHandler.handleClick(f.contentDocument,b,{x:d,y:c})):!1};e.resizeNotification=function(){this.reloadNotification()};e.reloadNotification=function(){this.showSkeletons(this.getCurrentlyVisibleSkeletons())};e.reloadAnnotations=function(){};e.updateGlyphColor=function(){};e.setAnnotationEventCallback=function(){};e.setOverlayManager=function(){};e.copyIframeData=function(){}}var j=-1;return{build:function(e,
d){e.loadedType={PRELOAD:0,GOTO:1,PAGE_FLIP:2};e.statusType={AVAILABLE:0,RESERVED:1,VISIBLE:2};e.iframes=[];e.iframeStatus=[];e.contentRange=[];e.positionData=[];e.parent=d;for(var c=0;c<6;c+=1)e.iframes[c]=e.createIframe($(d).width(),d.name,c),e.iframeStatus[c]=e.statusType.AVAILABLE,e.contentRange[c]=null,e.positionData[c]=null,d.appendChild(e.iframes[c]);e.currentPosition=0;e.showContent=!0;e.numberOfColumns=1;e.columnGap=20;e.spineColor="transparent";e.spines=[];h(e)}}}(),KindleRendererIframeManagerReflowFactory=
function(){function h(d){d.getIframeToLoad=function(){return this.iframes[this.hiddenIframeIndex]};d.annotationClickedHandler=function(c){if(this.annotationEventCallback!==void 0){var b=c.currentTarget.parentNode,c=b.getAttribute("annotationType"),b=b.getAttribute("annotationStart");this.annotationEventCallback(c,b)}};d.renderAnnotations=function(c,b){var d=c.contentDocument.getElementById(e);d!==null&&d.parentNode.removeChild(d);if(this.overlayManager&&(d=this.overlayManager.getOverlaysInRange(b.startPosition,
b.endPosition))&&d.length>0)this.createAnnotationElements(c,d),c.writingMode.forceRepaint(c)};d.frameIsLoadedAndReady=function(c){var b=this,d=b.currentRequest;b.iframeLoadStatus[c.index]=d.type;var a=b.contentRange[c.index];b.renderAnnotations(c,a);var g=this.isStartOfSkeletonLoaded(c.index);d.initialPosition!==null?KindlePaginator.scrollToPosition(c,d.initialPosition,g):KindlePaginator.scrollToTop(c,g);if(!KindlePaginator.isIframePaginationValid(c)){if(b.canRetryCurrentRequest()){b.willRetryCurrentRequest();
b.resizeWithoutReload(c.index);return}KindlePaginator.clearIframePaginationValidation(c)}if(!KindlePaginator.hasNextScreen(c)&&!KindleRendererFragmentLoader.isPositionAtEndOfSkeletonOrDocument(a.skeletonId,a.endPosition))if(a=a.endPosition-a.startPosition,a<0)b.currentRequestDfd.reject(DATA_LOAD_ERROR);else{KindleRendererPositionLoadingCalculator.updateDisplayedPositionRange(a+1);var e=d.initialPosition;if(e===null)e=KindlePaginator.getCurrentPagePositionRange(c).currentTopOfPage;setTimeout(function(){b.reloadHiddenFrame(e)},
0)}else d.initialPosition!==null&&c===b.iframes[b.hiddenIframeIndex]&&(b.swapIframes(),this.updateDisplayedPositionsInPage()),d.metrics.endTimer(),d.metrics.log(),b.currentRequest=null,setTimeout(b.currentRequestDfd.resolve,10),c.computingRectsId.id=d.requestId,b.computedRectsDfd[c.index]=b.computeRectsInIframe(b.iframes[c.index],d.requestId),b.computedRectsDfd[c.index].then(function(){b.computedRectsDfd[c.index]=null;c.computingRectsId.id=null;!b.currentRequest&&d.type===b.loadedType.GOTO_POSITION&&
b.considerLoadingMoreFragments();b=null},function(){b=null})};d.reloadHiddenFrame=function(c){this.loadFragmentsForRange(KindleRendererPositionLoadingCalculator.calculateDesiredFragmentRangeForGoTo(c))};d.gotoPosition=function(c){$(this.iframes[this.visibleIframeIndex].contentDocument.body).find("#"+j).empty();this.createNewRequest(this.loadedType.GOTO_POSITION,c);c=KindleRendererPositionLoadingCalculator.calculateDesiredFragmentRangeForGoTo(c);KindleRendererFragmentLoader.needToLoadFragments(this.contentRange[this.visibleIframeIndex],
c)?this.loadFragmentsForRange(c):this.resizeWithoutReload(this.visibleIframeIndex);return!1};d.swapIframes=function(){this.iframeLoadStatus[this.visibleIframeIndex]=this.iframeLoadStatus[this.hiddenIframeIndex]===this.loadedType.NEXT?this.loadedType.PREVIOUS:this.iframeLoadStatus[this.hiddenIframeIndex]===this.loadedType.PREVIOUS?this.loadedType.NEXT:this.loadedType.EMPTY;this.iframeLoadStatus[this.hiddenIframeIndex]=this.loadedType.EMPTY;var c=this.visibleIframeIndex;this.visibleIframeIndex=this.hiddenIframeIndex;
this.hiddenIframeIndex=c;this.setIframeVisibility(this.iframes[this.visibleIframeIndex],!0);this.setIframeVisibility(this.iframes[this.hiddenIframeIndex],!1);this.iframes[this.hiddenIframeIndex].writingMode.resetHeight(this.iframes[this.hiddenIframeIndex])};d.getPagePositionRange=function(){var c=this.contentRange[this.visibleIframeIndex];if(c===null)return null;var b=KindlePaginator.getCurrentPagePositionRange(this.iframes[this.visibleIframeIndex]);if(b.currentTopOfPage===null||b.currentBottomOfPage===
null)b.currentTopOfPage=c.startPosition,b.currentBottomOfPage=c.endPosition;return b};d.getCurrentPosition=function(){var c=this.getPagePositionRange();return c?c.currentTopOfPage:null};d.getSelectableItemBoundaries=function(){return KindlePaginator.getSelectableItemBoundariesForCurrentScreen(this.iframes[this.visibleIframeIndex])};d.computeRectsInIframe=function(c,b){var d=KindleMetricsProfiler("rects-computation"),a=KindleRendererFragmentLoader.getBookContentType();return c.screenManager.wordMapGenerator.computeWordRects(c.contentDocument,
c.screenManager.wordMap,c.screenManager.wordMapKeys,c.writingMode,a,b,c.computingRectsId,d)};d.getComputedRectsDfd=function(){return this.computedRectsDfd[this.visibleIframeIndex]};d.getWordPositions=function(){return KindlePaginator.getWordPositionsForCurrentScreen(this.iframes[this.visibleIframeIndex])};d.causeReflowEventInBrowser=function(){var c=this.iframes[this.visibleIframeIndex].contentDocument.getElementsByTagName("html")[0],b=this.iframes[this.visibleIframeIndex].contentDocument.getElementsByTagName("body")[0];
c.removeChild(b);c.appendChild(b)};d.causeReflowEventInBrowserIfNeeded=function(){if(KindleRendererDeviceSpecific.needsReflowOnPageFlip()){var c=this;setTimeout(function(){c.causeReflowEventInBrowser()},KindleRendererDeviceSpecific.drawYieldUpdateTime())}};d.reloadAnnotations=function(){this.renderAnnotations(this.iframes[this.visibleIframeIndex],this.contentRange[this.visibleIframeIndex]);this.iframes[this.hiddenIframeIndex]!==null&&this.iframeLoadStatus[this.hiddenIframeIndex]!==this.loadedType.EMPTY&&
this.renderAnnotations(this.iframes[this.hiddenIframeIndex],this.contentRange[this.hiddenIframeIndex])};d.loadNextPages=function(){if(this.iframeLoadStatus[this.hiddenIframeIndex]!==this.loadedType.NEXT&&(this.currentRequest===null||this.currentRequest.type!==this.loadedType.NEXT)){var c=this.contentRange[this.visibleIframeIndex].endPosition+1,b=this.getPagePositionRange(),c=KindleRendererPositionLoadingCalculator.calculateDesiredFragmentRangeForPageFlip(c,b);this.createNewRequest(this.loadedType.NEXT,
null);this.loadFragmentsForRange(c)}};d.loadPreviousPages=function(){if(this.iframeLoadStatus[this.hiddenIframeIndex]!==this.loadedType.PREVIOUS&&(this.currentRequest===null||this.currentRequest.type!==this.loadedType.PREVIOUS)){var c=this.contentRange[this.visibleIframeIndex].startPosition-1,b=this.getPagePositionRange(),c=KindleRendererPositionLoadingCalculator.calculateDesiredFragmentRangeForPageFlip(c,b);this.createNewRequest(this.loadedType.PREVIOUS,null);this.loadFragmentsForRange(c)}};d.considerLoadingMoreFragments=
function(c){if(this.canPreloadNext){var b=c!==this.direction.PREVIOUS?4:2;if(KindlePaginator.getApproximateNumNextScreens(this.iframes[this.visibleIframeIndex])<b&&this.hasMoreNextFragments()){this.loadNextPages();return}}this.canPreloadPrevious&&(c=c===this.direction.PREVIOUS?4:2,KindlePaginator.getApproximateNumPreviousScreens(this.iframes[this.visibleIframeIndex])<c&&this.hasMorePreviousFragments()&&this.loadPreviousPages())};d.handleClick=function(c,b){var d=KindleRendererUtils.elementFromPoint(this.iframes[this.visibleIframeIndex].contentDocument,
c,b);return KindleRendererEventHandler.handleClick(this.iframes[this.visibleIframeIndex].contentDocument,d,{x:c,y:b})};d.crossSkeletonBoundary=function(){var c=this.contentRange[this.visibleIframeIndex],b=this.contentRange[this.hiddenIframeIndex];if(this.iframeLoadStatus[this.hiddenIframeIndex]===this.loadedType.NEXT)if(c.skeletonId+1===b.skeletonId)return KindlePaginator.scrollToTop(this.iframes[this.hiddenIframeIndex],!0),this.swapIframes(),!0;else if(c.skeletonId!==b.skeletonId)return this.iframeLoadStatus[this.hiddenIframeIndex]=
this.loadedType.EMPTY,!1;if(this.iframeLoadStatus[this.hiddenIframeIndex]===this.loadedType.PREVIOUS)if(c.skeletonId-1===b.skeletonId)return c=this.hiddenIframeIndex,KindlePaginator.scrollToBottom(this.iframes[c],this.isStartOfSkeletonLoaded(c)),this.swapIframes(),!0;else if(c.skeletonId!==b.skeletonId)this.iframeLoadStatus[this.hiddenIframeIndex]=this.loadedType.EMPTY;return!1};d.cleanup=function(){this.cancelCurrentRequest();KindleRendererIframeLoading.cleanupIframe(this.iframes[this.visibleIframeIndex]);
KindleRendererIframeLoading.cleanupIframe(this.iframes[this.hiddenIframeIndex]);KindlePaginator.cleanupIframe(this.iframes[this.visibleIframeIndex]);KindlePaginator.cleanupIframe(this.iframes[this.hiddenIframeIndex]);this.setOverlayManager(null);this.contentRange=[null,null];this.positionData=[null,null];this.iframes=null};d.hasMoreNextFragments=function(){return this.contentRange[this.visibleIframeIndex].endPosition!==KindleRendererFragmentLoader.getMaximumPosition()};d.hasMorePreviousFragments=
function(){return this.contentRange[this.visibleIframeIndex].startPosition!==KindleRendererFragmentLoader.getMinimumPosition()};d.isAtEndOfDocumentOrSkeleton=function(){var c=this.contentRange[this.visibleIframeIndex];return KindleRendererFragmentLoader.isPositionAtEndOfSkeletonOrDocument(c.skeletonId,c.endPosition)};d.isAtBeginningOfDocumentOrSkeleton=function(){var c=this.contentRange[this.visibleIframeIndex];return KindleRendererFragmentLoader.isPositionAtBeginningOfSkeletonOrDocument(c.skeletonId,
c.startPosition)};d.isStartOfSkeletonLoaded=function(c){c=this.contentRange[c];return KindleRendererFragmentLoader.isPositionAtBeginningOfSkeletonOrDocument(c.skeletonId,c.startPosition)};d.needToWaitForLoadToShowNextPage=function(){return!KindlePaginator.isNextFullScreen(this.iframes[this.visibleIframeIndex])&&this.hasMoreNextFragments()};d.needToWaitForLoadToShowPreviousPage=function(){var c=this.visibleIframeIndex;return!KindlePaginator.isPreviousFullScreen(this.iframes[c],this.isStartOfSkeletonLoaded(c))&&
this.hasMorePreviousFragments()};d.hasNextScreen=function(){return KindlePaginator.hasNextScreen(this.iframes[this.visibleIframeIndex])||this.hasMoreNextFragments()};d.hasPreviousScreen=function(){return KindlePaginator.hasPreviousScreen(this.iframes[this.visibleIframeIndex])||this.hasMorePreviousFragments()};d.updateDisplayedPositionsInPage=function(){var c=KindlePaginator.getCurrentPagePositionRange(this.iframes[this.visibleIframeIndex]);KindleRendererPositionLoadingCalculator.updateDisplayedPositionRange(c.currentBottomOfPage-
c.currentTopOfPage)};d.considerFlippingFrames=function(){var c=this.iframeLoadStatus[this.hiddenIframeIndex],b=this.currentRequest!==null&&this.currentRequest.type===c;if(c!==this.loadedType.EMPTY&&!b){var b=this.getPagePositionRange(),d=this.contentRange[this.hiddenIframeIndex],a=0,g=0;c===this.loadedType.NEXT?g=1:a=1;if(b.currentTopOfPage>=d.startPosition+a&&b.currentBottomOfPage<=d.endPosition-g)if(KindlePaginator.matchFrames(this.iframes[this.visibleIframeIndex],this.iframes[this.hiddenIframeIndex]),
c=KindlePaginator.getCurrentPagePositionRange(this.iframes[this.hiddenIframeIndex]),c.currentTopOfPage===b.currentTopOfPage&&c.currentBottomOfPage===b.currentBottomOfPage)return this.swapIframes(),!0;else if(this.needToWaitForLoadToShowNextPage()||this.needToWaitForLoadToShowPreviousPage())throw"Pagination Error";}return!1};d.nextScreen=function(){if(!KindlePaginator.isIframePaginationValid(this.iframes[this.visibleIframeIndex]))return this.gotoPosition(this.getPagePositionRange().currentTopOfPage);
var c=this.iframeLoadStatus[this.hiddenIframeIndex]===this.loadedType.NEXT;if(c&&this.considerFlippingFrames()===void 0)return!0;var b=this.isAtEndOfDocumentOrSkeleton(),d=KindlePaginator.nextScreen(this.iframes[this.visibleIframeIndex],b);if(!d)if(this.hasMoreNextFragments())if(c&&b&&this.crossSkeletonBoundary())d=!0;else return c=this.getPagePositionRange(),KindleRendererPositionLoadingCalculator.updateDisplayedPositionRange(this.contentRange[this.visibleIframeIndex].endPosition-c.currentBottomOfPage),
this.loadNextPages(),!1;else KindlePaginator.showEndOfDocument(this.iframes[this.visibleIframeIndex]),d=!0;this.considerLoadingMoreFragments(this.direction.NEXT);this.causeReflowEventInBrowserIfNeeded();this.updateDisplayedPositionsInPage();return d};d.previousScreen=function(){if(!KindlePaginator.isIframePaginationValid(this.iframes[this.visibleIframeIndex]))return this.gotoPosition(this.getPagePositionRange().currentTopOfPage);var c=this.iframeLoadStatus[this.hiddenIframeIndex]===this.loadedType.PREVIOUS;
if(c&&this.considerFlippingFrames()===void 0)return!0;var b=this.visibleIframeIndex,d=this.isAtBeginningOfDocumentOrSkeleton(),b=KindlePaginator.previousScreen(this.iframes[b],d,this.isStartOfSkeletonLoaded(b));if(!b&&this.hasMorePreviousFragments())if(c&&d&&this.crossSkeletonBoundary())b=!0;else return c=this.getPagePositionRange(),KindleRendererPositionLoadingCalculator.updateDisplayedPositionRange(c.currentTopOfPage-this.contentRange[this.visibleIframeIndex].startPosition),this.loadPreviousPages(),
!1;this.considerLoadingMoreFragments(this.direction.PREVIOUS);this.causeReflowEventInBrowserIfNeeded();this.updateDisplayedPositionsInPage();return b};d.cancelHiddenIframeLoading=function(){var c=this.iframes[this.hiddenIframeIndex];if(c.processingRequestId.id!==null)c.processingRequestId.id=null,this.cancelCurrentRequest();c.computingRectsId.id=null};d.doGuardedAsyncCopyOf=function(c,b,d){var a=this;b.processingRequestId.id=a.currentRequest.requestId;KindleRendererIframeLoading.copyIframeContents(a.currentRequest,
c,b).done(function(c){if(b.processingRequestId.id===c.requestId&&a.currentRequest&&a.currentRequest.requestId===c.requestId)a.addClickHandlers(b),b.processingRequestId.id=null,d()})};d.copyIframeDataOf=function(c){var b=this;b.cancelHiddenIframeLoading();b.createNewRequest(b.loadedType.GOTO_POSITION,null);b.doGuardedAsyncCopyOf(c.iframes[c.visibleIframeIndex],b.iframes[b.visibleIframeIndex],function(){b.contentRange[b.visibleIframeIndex]=jQuery.extend({},c.contentRange[c.visibleIframeIndex]);b.positionData[b.visibleIframeIndex]=
jQuery.extend({},c.positionData[c.visibleIframeIndex]);var d=b.iframes[b.hiddenIframeIndex],a=c.iframes[c.hiddenIframeIndex];c.iframeLoadStatus[c.hiddenIframeIndex]!==c.loadedType.EMPTY&&a.processingRequestId.id===null?b.doGuardedAsyncCopyOf(a,d,function(){b.contentRange[b.hiddenIframeIndex]=jQuery.extend({},c.contentRange[c.hiddenIframeIndex]);b.positionData[b.hiddenIframeIndex]=jQuery.extend({},c.positionData[c.hiddenIframeIndex]);b.iframeLoadStatus[b.visibleIframeIndex]=c.iframeLoadStatus[c.visibleIframeIndex];
b.iframeLoadStatus[b.hiddenIframeIndex]=c.iframeLoadStatus[c.hiddenIframeIndex];b.currentRequestDfd.resolve()}):(b.iframeLoadStatus=[b.loadedType.EMPTY,b.loadedType.EMPTY],b.currentRequestDfd.resolve())});return b.currentRequestDfd.isResolved()};d.recreateFrame=function(c){var b=this.iframes[c],d=b.writingMode.width(b),a=b.parentNode,g=b.pageOverflowDiv;a.removeChild(b);b=this.createIframe(d,this.parentName,b.index);b.pageOverflowDiv=g;a.appendChild(b);a.appendChild(g);this.iframes[c]=b};d.copyIframeData=
function(c){if(!(this.contentRange[this.visibleIframeIndex]===null||c.contentRange[c.visibleIframeIndex]===null?this.contentRange[this.visibleIframeIndex]===c.contentRange[c.visibleIframeIndex]:this.contentRange[this.visibleIframeIndex].startPosition===c.contentRange[c.visibleIframeIndex].startPosition&&this.contentRange[this.visibleIframeIndex].endPosition===c.contentRange[c.visibleIframeIndex].endPosition))return KindleRendererDeviceSpecific.needsReflowOnPageFlip()&&(this.recreateFrame(0),this.recreateFrame(1),
this.setIframeVisibility(this.iframes[this.visibleIframeIndex],!0)),this.copyIframeDataOf(c);var b=this.iframes[this.visibleIframeIndex],c=c.iframes[c.visibleIframeIndex];b.currentTopOfScreen=c.currentTopOfScreen;b.currentBottomOfScreen=c.currentBottomOfScreen;return!0};d.updateSettingsInIframe=function(c){if(c&&c.contentDocument){var b=c.contentDocument.getElementById(j);b&&c.contentDocument.body.removeChild(b);KindleRendererIframeLoading.updateSettingsInIframe(c);b&&c.contentDocument.body.appendChild(b)}};
d.updateSettings=function(){var c=KindleRendererSettings.getSettings().backgroundColor;$(this.iframes[this.visibleIframeIndex].pageOverflowDiv).css({"background-color":c});$(this.iframes[this.hiddenIframeIndex].pageOverflowDiv).css({"background-color":c});this.updateSettingsInIframe(this.iframes[this.visibleIframeIndex]);this.updateSettingsInIframe(this.iframes[this.hiddenIframeIndex])};d.reloadNotification=function(){this.contentRange=[null,null];this.positionData=[null,null];this.resizeNotification()};
d.resizeNotification=function(){this.cancelHiddenIframeLoading();this.iframeLoadStatus=[this.loadedType.EMPTY,this.loadedType.EMPTY];var c=this.iframes[this.visibleIframeIndex];c.writingMode.resetIframeDimensions(c);c=this.iframes[this.hiddenIframeIndex];c.writingMode.resetIframeDimensions(c)};d.updateGlyphColorForFrameIndex=function(c){this.iframes[c].hasGlyphs&&this.iframes[c].contentDocument&&KindleGlyphRenderer.updateTextColor(this.iframes[c])};d.updateGlyphColor=function(){this.updateGlyphColorForFrameIndex(this.visibleIframeIndex);
this.updateGlyphColorForFrameIndex(this.hiddenIframeIndex)};d.setAnnotationEventCallback=function(c){this.annotationEventCallback=c};d.getContentRects=function(){var c=this.iframes[this.visibleIframeIndex],b=this.getIframeOrigin(this.visibleIframeIndex),c={left:b.x,top:b.y,width:$(c).width(),height:$(c).height()};c.right=c.left+c.width;c.bottom=c.top+c.height;return[c]};d.getZoomableAt=function(c,b,d){var a=this.iframes[this.visibleIframeIndex];return!KindlePaginator.isPointOnVisiblePage(a,b-c.x,
d-c.y)?null:KindleRendererZoomablesFactory.buildFromCoord(a.contentDocument,c,b,d)};d.getZoomableList=function(c){return KindleRendererZoomablesFactory.buildList(this.iframes[this.visibleIframeIndex].contentDocument,c)};d.addClickHandlers=function(c){var b=this,c=c.contentDocument.getElementById(e),c=$(c).find("["+KindleRendererAnnotationRenderer.ANNOTATION_CLICK_ATTRIBUTE+"='true']").children();$(c).unbind("click");$(c).click(function(c){b.annotationClickedHandler(c)})};d.createAnnotationElements=
function(c,b){if(c.contentDocument.getElementsByTagName("body")[0]){var d=KindlePaginator.getWordMap(c),a=c.contentDocument.createDocumentFragment();KindleRendererAnnotationRenderer.createAnnotationElements(c,d,c.screenManager.wordMapGenerator,b,a);d=c.contentDocument.getElementById(e);if(!d){var g=c.contentDocument.getElementById(j),d=c.contentDocument.createElement("DIV");d.id=e;d.setAttribute("class","kindle-annotation-wrapper");g.appendChild(d)}d.appendChild(a);this.addClickHandlers(c)}};d.addAnnotation=
function(c,b,d){c&&b&&d&&b.startPosition<=d.end&&d.start<=b.endPosition&&(this.createAnnotationElements(c,[d]),c.writingMode.forceRepaint(c))};d.removeAnnotation=function(c,b){if(c&&b){var d=c.contentDocument.getElementById(e);d&&(KindleRendererAnnotationRenderer.removeAnnotationElements(d,b),c.writingMode.forceRepaint(c))}};d.onOverlayAdded=function(c){d.addAnnotation(d.iframes[0],d.contentRange[0],c.overlay);d.addAnnotation(d.iframes[1],d.contentRange[1],c.overlay)};d.onOverlayRemoved=function(c){d.removeAnnotation(d.iframes[0],
c.overlay);d.removeAnnotation(d.iframes[1],c.overlay)};d.setOverlayManager=function(c){this.overlayManager&&(this.overlayManager.removeEventListener(this.overlayManager.OVERLAY_ADDED_EVENT,this.onOverlayAdded),this.overlayManager.removeEventListener(this.overlayManager.OVERLAY_REMOVED_EVENT,this.onOverlayRemoved));if(this.overlayManager=c)this.overlayManager.addEventListener(this.overlayManager.OVERLAY_ADDED_EVENT,this.onOverlayAdded),this.overlayManager.addEventListener(this.overlayManager.OVERLAY_REMOVED_EVENT,
this.onOverlayRemoved)};d.show=function(){this.showContent=!0;this.setIframeVisibility(this.iframes[this.visibleIframeIndex],!0)};d.hide=function(){this.showContent=!1;this.setIframeVisibility(this.iframes[this.visibleIframeIndex],!1)};d.drawWordMap=function(){var c=this.iframes[this.visibleIframeIndex];drawWordMap(c,c.screenManager,c.contentDocument.body)};d.drawHeightMaps=function(){drawHeightMaps(this.iframes[this.visibleIframeIndex],this.iframes[this.hiddenIframeIndex])}}var j="content-overlays",
e="annotation-section";return{build:function(d,c){for(var b=[],f=0;f<2;f+=1){b[f]=d.createIframe($(c).width(),c.name,f);c.appendChild(b[f]);var a=b[f],g=c,e=f,j=document.createElement("div");j.setAttribute("id",g.name+"_page_overflow_"+e);$(j).css({position:"absolute",visibility:"hidden","z-index":1});g.appendChild(j);a.pageOverflowDiv=j}d.loadedType={EMPTY:0,GOTO_POSITION:1,NEXT:2,PREVIOUS:3};d.direction={NEXT:2,PREVIOUS:3};d.iframes=b;d.parentName=c.name;d.iframeLoadStatus=[d.loadedType.EMPTY,d.loadedType.EMPTY];
d.contentRange=[null,null];d.positionData=[null,null];d.computedRectsDfd=[null,null];d.visibleIframeIndex=0;d.hiddenIframeIndex=1;d.overlayManager=null;h(d)}}}(),KindleRendererIframePreparation=function(){function h(c,b,d,a){KindleRendererSettings.useCSSRegions()?a.resolve(b):KindleRendererContentReflow.reflow(c,b,d).then(function(){a.resolve(b)},function(){a.reject(b,"reflow took too long")})}function j(c,b,f,a,g,k){g!==d&&KindleRendererCanvasInsertion.changeSpanToCanvas(c.id,c.contentDocument,f.contentRange,
g===e);c.hasGlyphs=a.glyphData!==void 0&&f.glyphData!==void 0;c.hasGlyphs?KindleGlyphRenderer.renderAllContent(c,b,a.glyphData,f.glyphData).then(function(){h(c,b,a.positionData,k)},function(){k.reject(b,"glyph rendering took too long")}):(a.glyphData=null,h(c,b,a.positionData,k))}var e=-1,d=0;return{CANVAS_INSERTION_PREVIOUS:e,CANVAS_INSERTION_NONE:d,CANVAS_INSERTION_NEXT:1,prepareIframe:function(c,b,d,a,g){var e=new jQuery.Deferred;if(c.processingRequestId.id===b.requestId){var h=c.contentDocument.getElementById("content-overlays");
if(!h)h=c.contentDocument.createElement("DIV"),h.id="content-overlays",c.contentDocument.body.appendChild(h);j(c,b,d,a,g,e)}else e.reject();return e.promise()}}}(),KindleRendererColumnManager=function(){function h(){for(var a=0;a<z;a++)w[a].hide()}function j(a){if(D||M){if(a<=x)throw{name:"pagingError",message:"Repeating wait request"};x=a;v<0&&(y.waitNotification&&y.waitNotification(),z>=KindleRendererDeviceSpecific.minColumnsToHide()&&(M=!0,h()));v=a}}function e(a){if((D||M)&&v>=0&&v<=a){F=0;v=
-1;if(M||z>=KindleRendererDeviceSpecific.minColumnsToHide()){for(a=0;a<z;a++)w[a].show();D=!0;M=!1}y.readyNotification&&y.readyNotification()}}function d(){v===-1&&c(0)}function c(a){if(a<z){var b=w[a].getComputedRectsDfd();b?(y.rectsWaitNofification&&y.rectsWaitNofification(),b.then(function(){c(a+1)},function(a){y.rectsErrorNotification&&y.rectsErrorNotification(a)})):c(a+1)}else y.rectsReadyNotification&&y.rectsReadyNotification()}function b(a){return a>z*L?(y.errorNotification&&y.errorNotification("Irrecoverable Error"),
!0):!1}function f(a,b,c){v<=a&&(b!==KindleRendererIframeManagerFactory.DATA_LOAD_ERROR&&F<N?(++F,s(),o(c)):(y.errorNotification&&y.errorNotification(b),v=-1))}function a(c,g){try{if(b(g))return!1;if(w[c].copyIframeData(w[c===0?z-1:c-1])){var h=w[c].nextScreen(),k=c+1;if(h){if(k<z)return a(k,g+1);d();return!0}}var l=w[c].getCurrentProcessId();j(l);w[c].getCurrentProcessDfd().then(function(){a(c,g+1)&&(e(l),d())},function(a){f(l,a,g)})}catch(m){o(g)}return!1}function g(c,h){try{if(b(h))return!1;var l=
w[c===z-1?0:c+1];if(!l.hasPreviousScreen())return k(0,h),!1;if(w[c].copyIframeData(l)){var m=w[c].previousScreen(),l=c-1;if(m)return l>=0?g(l,h+1):a(1,h)}var n=w[c].getCurrentProcessId();j(n);w[c].getCurrentProcessDfd().then(function(){g(c,h+1)&&(e(n),d())},function(a){f(n,a,h)})}catch(u){o(h)}return!1}function k(b,c,g){var h;w[0].gotoPosition(b,g)?(h=KindleRendererRequestId.getUniqueRequestId(),j(h),e(h),d()):(h=w[0].getCurrentProcessId(),j(h),b=w[0].getCurrentProcessDfd(),z===1?b.then(function(){e(h);
d()},function(a){f(h,a,c)}):b.then(function(){a(1)&&(e(h),d())},function(a){f(h,a,c)}));return!1}function m(){try{if(z===1){var b=w[0].nextScreen();if(b)d();else{var c=w[0].getCurrentProcessId();j(c);w[0].getCurrentProcessDfd().then(function(){m();e(c);d()},function(a){f(c,a,0)})}return b}else return a(0,0)}catch(g){return o(0),!1}}function l(){try{if(z===1){var a=w[0].previousScreen();if(a)d();else{var b=w[0].getCurrentProcessId();j(b);w[0].getCurrentProcessDfd().then(function(){l();e(b);d()},function(a){f(b,
a,0)})}return a}else return g(z-1,0)}catch(c){return o(0),!1}}function n(a){for(;a<z;a++)w[a].reloadNotification()}function r(){var a=w[0].getCurrentPosition();a!==null&&(E=a)}function o(a){r();n(0);k(E,a)}function q(a){if(H&&a&&a.length>0){var b=document.getElementById("renderer_translation_div");if(!b)b=document.createElement("div"),b.id="renderer_translation_div",$(b).css({visibility:"hidden","z-index":-1E3}),H.appendChild(b);$(b).css({margin:a});a=window.getComputedStyle(b);return{top:parseFloat(a.marginTop),
bottom:parseFloat(a.marginBottom),left:parseFloat(a.marginLeft),right:parseFloat(a.marginRight)}}return{top:0,bottom:0,left:0,right:0}}function t(){var a=KindleRendererSettings.getSettings().inlineBaseDirection,b=a&&a.value===a.VERTICAL,a=q(C),c,d;b?(a={top:a.left,right:a.bottom,bottom:a.right,left:a.top},c=$(H).height(),d=$(H).width()):(c=$(H).width(),d=$(H).height());return{margins:a,parentWidth:c,parentHeight:d,getStyle:function(a){return b?{top:a.left,left:a.top,width:a.height,height:a.width}:
a}}}function s(){z=Math.max(z,1);for(var a=t(),b=a.parentHeight,c=a.margins,d=I-(c.left+c.right),g=parseInt((a.parentWidth-d*(z-1))/z,10),f=c.top,b=b-c.top-c.bottom,c=0;c<z;c++){if(B[c]===void 0)B[c]=document.createElement("div"),B[c].name="column_"+c,$(B[c]).css("position","absolute"),H.appendChild(B[c]);var e=a.getStyle({top:f,left:c*(g+d),height:b,width:g});e.display="";$(B[c]).css(e);w[c]===void 0&&(w[c]=KindleRendererIframeManagerFactory.build(B[c]),w[c].setAnnotationEventCallback(y.annotationTriggered),
w[c].setOverlayManager(K));w[c].setCanPreloadPrevious(c===0);w[c].setCanPreloadNext(c===z-1)}for(c=z;c<B.length;c++)$(B[c]).hide();D||h()}function u(a){a=$(B[a]);return{x:parseInt(a.css("left"),10),y:parseInt(a.css("top"),10)}}var y={},v=-1,x=-1,H=null,C=0,I=20,z=0,B=[],w=[],E=0,K,D=!0,M=!1,N=3,F=0,L=20;return{initialize:function(a,b,c,d){H=a;y=b;K=c;d>0&&(E=d);s()},cleanup:function(){for(var a=0;a<w.length;a++)w[a].cleanup()},hide:function(){h();M=D=!1},show:function(){M=!0},updateSettings:function(a){if(a.columns!==
void 0)if(KindleRendererSettings.getSettings().fixedContent)z=1,I=0;else{if(a.columns.num!==void 0)z=a.columns.num;a.columns.gap!==void 0&&(I=parseInt(a.columns.gap,10))}if(a.margin!==void 0)C=a.margin;if(H!==null){s();for(var b=a.fontSizes!==void 0||a.lineSpacingMultiplier!==void 0||a.fontSizeUnits!==void 0||a.fontFamily!==void 0||a.margin!==void 0||a.columns!==void 0||a.textAlign!==void 0,c=0;c<z;c++)w[c].updateSettings(a),!b&&a.fontColor!==void 0&&w[0].updateGlyphColor();b&&(D?o(0):n(0))}},gotoPosition:function(a,
b){return k(a,0,b)},nextScreen:function(){return m()},previousScreen:function(){return l()},hasNextScreen:function(){return w[z-1].hasNextScreen()},hasPreviousScreen:function(){return w[0].hasPreviousScreen()},getPagePositionRange:function(){var a;a=w[0].getPagePositionRange();if(z!==1){var b=w[z-1].getPagePositionRange();a={currentTopOfPage:a.currentTopOfPage,currentBottomOfPage:b.currentBottomOfPage}}return a},getSelectableItemBoundaries:function(){for(var a={},b=0;b<z;b++){var c=$(B[b]),d=parseFloat(c.css("top")),
c=parseFloat(c.css("left")),g=w[b].getSelectableItemBoundaries(),f;for(f in g){a[f]=[];for(var e=g[f],h=0;h<e.length;h++)a[f].push({top:e[h].top+d,bottom:e[h].bottom+d,left:e[h].left+c,right:e[h].right+c})}}return a},getWordPositions:function(){for(var a=[],b=0;b<z;b++){var c=w[b].getWordPositions();c&&(a=a.concat(c))}return a.length?a:null},onWindowResize:function(){s();r();w[0].resizeNotification();n(1);k(E,0)},handleClick:function(a,b){for(var c=0;c<z;c++){var d=$(B[c]),g=a-parseInt(d.css("left"),
10),d=b-parseInt(d.css("top"),10);if(w[c].handleClick(g,d))return!0}return!1},reloadAnnotations:function(){for(var a=0;a<z;a++)w[a].reloadAnnotations()},getContentRects:function(){for(var a=[],b=0;b<z;b++){for(var c=w[b].getContentRects(),d=u(b),g=0;g<c.length;g++)c[g].left+=d.x,c[g].right+=d.x,c[g].top+=d.y,c[g].bottom+=d.y;a=a.concat(c)}return a},getZoomableAt:function(a,b){for(var c=0;c<z;c++){var d=u(c);if(d=w[c].getZoomableAt(d,a,b))return d}return null},getZoomableList:function(){for(var a=
[],b=0;b<z;b++)var c=u(b),c=w[b].getZoomableList(c),a=a.concat(c);return a}}}(),KindleRendererContentDisplay=function(){function h(a){b=document.createElement("DIV");$(b).css({position:"absolute",top:0,left:0});a.appendChild(b);f=document.createElement("DIV");var c=$(f);c.css({position:"absolute",top:0,left:0});KindleRendererSettings.useCSSRegions()&&c.css({height:"100%",width:"100%"});a.appendChild(f);j()}function j(){if(!KindleRendererSettings.useCSSRegions()){if(b){var a=$(b.parentNode);$(b).css({width:a.width(),
height:a.height()})}f&&(jContentDivParentNode=$(f.parentNode),$(f).css({width:jContentDivParentNode.width(),height:jContentDivParentNode.height()}))}}function e(a){c!==a&&(c.hide(),c=a,c.show())}var d=null,c,b=null,f=null,a=!1;return{initialize:function(g,e,j,l,n){var r=new jQuery.Deferred;c=d=KindleRendererSettings.useCSSRegions()?KindleRegionContentManager:KindleRendererColumnManager;h(g);KindleRendererCover.initialize(b,e,j);d.initialize(f,e,l,n);KindleRendererContentReflow.initialize();j.hasCover(function(b){a=
b;r.resolve()},r.resolve);return r.promise()},cleanup:function(){KindleRendererCover.cleanup();d.cleanup();f=b=c=null},updateSettings:function(a){d&&(j(),d.updateSettings(a))},gotoPosition:function(b,c){b=parseInt(b,10);b=Math.max(b,0);a&&b===0?(e(KindleRendererCover),KindleRendererCover.showCover()):(e(d),b=Math.min(b,KindleRendererFragmentLoader.getMaximumPosition()));return d.gotoPosition(b,c)},nextScreen:function(){if(c===KindleRendererCover)return e(d),d.gotoPosition(0);else if(c.hasNextScreen())return c.nextScreen();
return!0},previousScreen:function(){if(c===d)if(c.hasPreviousScreen())return c.previousScreen();else a&&(e(KindleRendererCover),KindleRendererCover.showCover());return!0},hasNextScreen:function(){return c.hasNextScreen()},hasPreviousScreen:function(){return a?c!==KindleRendererCover:c.hasPreviousScreen()},getPagePositionRange:function(){return c.getPagePositionRange()},getSelectableItemBoundaries:function(){return c.getSelectableItemBoundaries()},getWordPositions:function(){return c.getWordPositions()},
onWindowResize:function(){j();KindleRendererCover.onWindowResize();d.onWindowResize()},handleClick:function(a,b){return c.handleClick(a,b)},reloadAnnotations:function(){c.reloadAnnotations()},getContentRects:function(){return c.getContentRects()},getZoomableAt:function(a,b){return c.getZoomableAt(a,b)},getZoomableList:function(){return c.getZoomableList()},clearSelection:function(){d.clearSelection&&d.clearSelection()},getSelection:function(){if(d.getSelection)return d.getSelection()}}}(),KindleRendererCover=
function(){function h(c){function g(){++u;u===s&&(e(f),d(f))}var h=c.data||c,k=c.metadata,c=h.split("resources")[0],m=KindleRendererImageRenderer.getCoverImageSlices();if(l=m!==void 0&&m!==null){f=b.ownerDocument.createElement("DIV");for(var h=$(f),s=m.length,u=0,y=0,v=0,x=0;x<s;x++)y=b.ownerDocument.createElement("IMG"),$(y).width(m[x].width),$(y).height(m[x].height),y.onload=g,y.src=c+m[x].name,$(y).appendTo(h),v+=m[x].height;y=m[0].width;$(f).width(y);$(f).height(v);$(f).css("visibility","hidden")}else f=
b.ownerDocument.createElement("IMG"),f.src=h,$(f).css("visibility","hidden"),f.onload=function(){k&&k.map?($(this).css("display","none"),a=KindleRendererImageRenderer.createCanvasImage(this,k.map),a=j(this.parentNode,a),$(this).after(a)):e(this);d(this)};b.appendChild(f)}function j(a,b){var c=$(a),d=c.width(),g=c.height(),f=Math.min(d/b.width,g/b.height),c=b.width*f;f*=b.height;d=Math.round((d-c)*0.5);g=Math.round((g-f)*0.5);$(b).css({top:g+"px",left:d+"px",height:f+"px",width:c+"px",position:"absolute"});
return b}function e(a){if(!(a===null||a===void 0)){var c=$(a),d=$(c.parent()),g=d.width(),f=d.height();c.css("visiblity","hidden");var e=1,d=a.offsetWidth,h=a.offsetHeight;d>0&&h>0?(c.attr("nativeWidth")===void 0&&c.attr("nativeWidth",d),c.attr("nativeHeight")===void 0&&c.attr("nativeHeight",h)):(d=c.attr("nativeWidth")||g,h=c.attr("nativeHeight")||f);e=Math.min(g/d,f/h);d*=e;e*=h;g=Math.round((g-d)*0.5);f=Math.round((f-e)*0.5);l?(c=b.ownerDocument.createElement("IMG"),$(c).css({width:d+"px",height:e+
"px",position:"absolute",left:g+"px",top:f+"px"}),KindleRendererImageRenderer.scaleImageSlices(c,a,!1),$(c).remove()):c.css({height:e+"px",width:d+"px",position:"absolute",left:g+"px",top:f+"px"});$(a).css("visibility","visible")}}function d(){m=!0;g.readyNotification&&g.readyNotification();g.rectsReadyNotification&&g.rectsReadyNotification()}function c(a){g.errorNotification&&g.errorNotification(a)}var b=null,f=null,a=null,g=null,k=null,m=!1,l=!1;return{initialize:function(a,c,d){b=a;g=c;k=d},cleanup:function(){k=
g=f=b=null;l=m=!1},hide:function(){$(b).hide()},show:function(){$(b).show()},showCover:function(){m?(g.readyNotification&&g.readyNotification(),g.rectsReadyNotification&&g.rectsReadyNotification()):(g.waitNotification&&g.waitNotification(),k.getCoverUrl(h,c))},nextScreen:function(){return!0},previousScreen:function(){return!0},hasNextScreen:function(){return!0},hasPreviousScreen:function(){return!1},getPagePositionRange:function(){return{currentTopOfPage:0,currentBottomOfPage:0}},getSelectableItemBoundaries:function(){var a=
{};if(f&&f.getBoundingClientRect){var b=f.getBoundingClientRect();b&&(a[0]=[{left:b.left,top:b.top,right:b.right,bottom:b.bottom}])}return a},getWordPositions:function(){return null},onWindowResize:function(){a?j(a.parentNode,a):e(f)},handleClick:function(){return!1},reloadAnnotations:function(){},getContentRects:function(){var a=$(f),a={left:parseInt(a.css("left"),10),top:parseInt(a.css("top"),10),width:a.width(),height:a.height()};a.right=a.left+a.width;a.bottom=a.top+a.height;return[a]},getZoomableAt:function(){return f?
KindleRendererZoomableReflowableContentFactory.buildFromElement(f,{x:0,y:0}):null},getZoomableList:function(){return[]}}}(),KindleRendererElementFitting=function(){function h(a){return(a.getAttribute("style")||"")+";"}function j(a,b,c,d){var g=0,f=g=0;a>c&&(g=c/a);b>d&&(f=d/b);g=g>0&&f>0?g<f?g:f:g>0?g:f;g!==0&&(a=g*parseInt(a,10),b=g*parseInt(b,10),b=Math.max(1,b),a=Math.max(1,a));return{height:a,width:b,scale:g}}function e(a){var b=a.getAttribute("data-isGaiji");if(b)return b==="true";var b=parseInt($(a).css("width"),
10),c=parseInt($(a).css("height"),10),d=parseInt($(a).css("font-size"),10);if(Math.abs(b-d)<=1&&Math.abs(c-d)<=1)return a.setAttribute("data-isGaiji","true"),!0;a.setAttribute("data-isGaiji","false");return!1}function d(a,b){for(var c={neededCount:0,downloadedCount:0},d=function(){c.downloadedCount+=1;c.downloadedCount===c.neededCount&&setTimeout(b,KindleRendererDeviceSpecific.drawYieldUpdateTime())},g=0;g<a.length;g+=1)if(a[g].src!==""&&(a[g].complete!==void 0&&a[g].complete===!1||a[g].naturalHeight===
0&&a[g].naturalWidth===0))c.neededCount+=1,a[g].onerror=d,a[g].onload=d,a[g].onabort=d;c.neededCount===0&&setTimeout(b,KindleRendererDeviceSpecific.drawYieldUpdateTime())}function c(a,b){var c=a.getElementsByTagName("IMG");c.length>0?d(c,b):b()}function b(b,d,n,r){var o=new jQuery.Deferred,q,t,s=function(){q=r.createSubTimer("element-fitting");if($(b).css("position")==="absolute")KindleRendererImageRenderer.scaleCompositeInlineImages(b),o.resolve();else{var c=b.getElementsByTagName("IMG");if(c.length>
0){var s;for(s=0;s<c.length;s+=1){var v=c[s],x=v,H=$(x),C=H.css("max-height"),H=H.css("max-width"),C=C!=="auto"&&C!=="none",H=H!=="auto"&&H!=="none";if(C||H){var t=h(x);C&&(t+="max-height: none; ");H&&(t+="max-width: none; ");x.setAttribute("style",t)}x=v;x.getAttribute("data-nativeHeight")||x.setAttribute("data-nativeHeight",x.height);x.getAttribute("data-nativeWidth")||x.setAttribute("data-nativeWidth",x.width);x.getAttribute("data-nativeLeftOffset")||x.setAttribute("data-nativeLeftOffset",x.offsetLeft);
x.getAttribute("data-nativeTopOffset")||x.setAttribute("data-nativeTopOffset",x.offsetTop);x=v;if(x.className.indexOf("unsupsvg")>=0&&(x.src=g,x.height=x.getAttribute("data-nativeHeight"),x.width=x.getAttribute("data-nativeWidth"),x.height===0||x.width===0))x.height=k,x.width=k,x.setAttribute("data-nativeHeight",x.height),x.setAttribute("data-nativeWidth",x.width);x=v;t=d.getAvailableSizeForImage(x,n,f);H=parseInt(x.getAttribute("data-nativeWidth"),10)||x.naturalWidth;C=parseInt(x.getAttribute("data-nativeHeight"),
10)||x.naturalHeight;if(!H||!C)KindleDebug.warn("Defaulting image width/height. It'll be scaled down to fit."),C=H=1E3;var H=j(C,H,t.height,t.width),C=H.height,H=H.width,z=x,B=C,w=H,E=t.height,K=t.width,t={},D=0,M=parseInt($(z).css("padding-top"),10),N=parseInt($(z).css("padding-bottom"),10),F=M+N;if(F+B>E)D=B+F-E,B=Math.ceil(M/F*D),D-=B,t.top=M-B,t.bottom=N-D;M=parseInt($(z).css("padding-left"),10);z=parseInt($(z).css("padding-right"),10);N=M+z;if(N+w>K)D=w+N-K,w=Math.ceil(M/N*D),K=D-w,t.left=M-
w,t.right=z-K;w=h(x);w+="height: "+C+"px; width: "+H+"px; ";w+=(t.top!==void 0?"padding-top: "+t.top+"px; ":"")+(t.bottom!==void 0?"padding-bottom: "+t.bottom+"px; ":"")+(t.left!==void 0?"padding-left: "+t.left+"px; ":"")+(t.right!==void 0?"padding-right: "+t.right+"px; ":"");x.setAttribute("style",w);e(v)||d.padImageIfNeeded(v)}v=d.calculateOverlappingImageSets(c,e);for(x=a;x>0&&v.length>0;){for(s=0;s<v.length;s+=1)if(H=v[s],C=H.imgs,H=j(H.height,H.width,n.height*f,n.width*f).scale,H!==0)for(D=0;D<
C.length;D+=1)t=C[D],w=t.height*H,K=t.width*H,w<1||K<1||(z=h(t),z+="height: "+w+"px; width: "+K+"px;",t.setAttribute("style",z));--x;v=d.calculateOverlappingImageSets(c,e)}}if(d.getWritingMode()!=="vertical"){c=b.getElementsByTagName("TABLE");for(s=0;s<c.length;s++){v=c[s];t=n;C=x=0;H=parseInt(v.getAttribute("data-nativeWidth"),10);t=t.parentWidth||t.width;H||(H=$(v).width(),v.setAttribute("data-nativeWidth",H));w=Math.min(parseInt(v.getAttribute("data-nativeLeftOffset"),10),v.offsetLeft);if(!w)w=
v.offsetLeft,v.setAttribute("data-nativeLeftOffset",w);K=$(v.offsetParent).width()||t;K=Math.min(K-w,t*f);H>K&&(C=K/H);C>0&&(x=C);x!==0&&(C="scale("+x+")",x=h(v),x+=" -moz-transform: "+C+"; -webkit-transform:"+C+"; -o-transform:"+C+"; -ms-transform:"+C+"; ms-transform:"+C+"; transform:"+C+"; ",C=$(v).css("float"),H="top ",H+=C==="right"?"right":"left",x+=" -moz-transform-origin: "+H+"; -webkit-transform-origin: "+H+"; -o-transform-origin: "+H+"; -ms-transform-origin "+H+"; ms-transform-origin "+H+
"; transform-origin "+H+"; ",v.setAttribute("style",x))}}setTimeout(o.resolve,10)}};window.ActiveXObject&&window.XMLHttpRequest?$(b.ownerDocument).ready(s):(t=r.createSubTimer("(WAIT) image-loading"),c(b,function(){t.endTimer();s()}));return o.promise().then(function(){q.endTimer()})}var f=0.95,a=3,g="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' version='1.1' viewBox='0 0 100 100'><g><rect x='1%' y='1%' rx='20' ry='20' width='98%' height='98%' style='fill:white; stroke:gray;stroke-width:2;'></rect><text x='50%' y='50%' fill='black' font-size='8px' style='text-anchor: middle; dominant-baseline: central;'>Image Not Supported</text></g></svg>",
k=200;return{fitToViewport:function(a,c,d,g){return b(a,c,d,g)},resize:function(a,b){var c;if($(a).css("position")==="absolute")if(b.width>0&&b.height>0){c=a.offsetWidth>0&&a.offsetHeight>0?Math.min(b.width/a.offsetWidth,b.height/a.offsetHeight):1;var d="scale("+c+")";$(a).css({"-moz-transform":d,"-moz-transform-origin":"left top","-webkit-transform":d,"-webkit-transform-origin":"left top","-o-transform":d,"-o-transform-origin":"left top","ms-transform":d,"ms-transform-origin":"left top","-ms-transform":d,
"-ms-transform-origin":"left top",transform:d,"transform-origin":"left top"});c={width:$(a).width()*c,height:$(a).height()*c}}else c=void 0;return c}}}(),KindleRendererImageRenderer=function(){function h(a,b){for(var c=b.length,d=document.createElement("canvas"),g=0,f=0,e=9999,h=0;h<c;h+=6)g=Math.max(g,b[h+1]+b[h+5]),f=Math.max(f,b[h]+b[h+4]),e=Math.min(e,b[h+2]);d.height=g;d.width=f;j(a,b,d);var h=Math.sqrt(c/6),c=g+h*e*2,e=f+h*e*2,k=$(a).height(),h=$(a).width(),g=k===c?g:k,f=h===e?f:h;$(d).css({height:g,
width:f});return d}function j(a,b,c){for(var d,g,f,e,h,k=b.length,j=c.getContext("2d"),l=0;l<k;l+=6)c=b[l],d=b[l+1],g=b[l+2],f=b[l+3],e=b[l+4],h=b[l+5],j.drawImage(a,g,f,e,h,c,d,e,h)}function e(a){function b(a,c){return parseInt(a.name.match(q),10)-parseInt(c.name.match(q),10)}for(var c in a){var d=a[c].parent;if(r[d]===void 0||r[d]===null)r[d]=[];r[d].push({name:a[c].name,width:a[c].width,height:a[c].height})}for(c in r)r[c].sort(b)}function d(a,b,c,d){var g=b&&b.metadata||c&&c.metadata;if(g&&g.map){$(a).css("display",
"none");var f,e=function(){a.parentNode&&(f?j(a,g.map,f):(f=h(a,g.map),$(a.parentNode).append(f)))},k=KindleHostDeviceDetector.hasMissingImgOnLoadProblem&&KindleHostDeviceDetector.hasMissingImgOnLoadProblem();if(k)var l=t.map(function(a){return setTimeout(e,a)});a.onload=function(){e();k&&l.forEach(function(a){clearTimeout(a)})}}else KindleHostDeviceDetector.hasImageRenderingProblem&&KindleHostDeviceDetector.hasImageRenderingProblem()&&$(a).attr("data-repaint-on-show","1");if(b&&b[d])a.src=b[d];else if(c&&
c[d])a.src=c[d]}function c(a){a=a.split("url(")[1].split(")")[0].split("resources");bgImgFilepath=a[0];bgImgResourceName="resources"+a[a.length-1];return{bgImgFilepath:bgImgFilepath,bgImgResourceName:bgImgResourceName}}function b(a,b,c){var d=0;a.substring(a.length-1,a.length)==="%"?d=b!==0?parseFloat(a)/100*c/b:1:a.substring(a.length-2,a.length)==="px"?(c=parseFloat(a),d=b!==0?c/b:1):d=1;return d}function f(a,c,d,g){var f=c.css("background-size").split(",")[0].trim().split(" "),e,h=!1,k=!1;f[0]===
"auto"?f=e="100%":f[0]==="cover"?(h=!0,f=e="100%"):f[0]==="contain"?(k=!0,f=e="100%"):f.length===1?(e=f[0],f="100%"):(e=f[0],f=f[1]);a.w=b(e,d,c.width());a.h=b(f,g,c.height());if(h)c=a.w>a.h?a.w:a.h,a.w=c,a.h=c;else if(k)c=a.w<a.h?a.w:a.h,a.w=c,a.h=c}function a(a,b,c,d,g,f,e){for(var h=[],k=[],j=0,l=0,m=0,j=0;j<g;j++)h[j]=f*c[j],k[j]=e*d[j],a[j]=Math.round(h[j]),l+=k[j],b[j]=Math.round(l-m),m+=b[j]}function g(a,b){if(a==="top"||a==="left")a="0%";a==="center"&&(a="50%");if(a==="bottom"||a==="right")a=
"100%";var c=0,c=a.substring(a.length-1,a.length)==="%"?parseFloat(a)/100*b:a.substring(a.length-2,a.length)==="px"?parseFloat(a):0;return Math.round(c)}function k(a,b){var c=b.css("background-position").split(",")[0].trim().split(" "),d;c.length===1?(d=c[0],c="50%"):(d=c[0],c=c[1]);a.x=g(d,b.width());a.y=g(c,b.height())}function m(b){function d(){K++;K===l&&g.css("background-image",E)}var g=$(b),e=g.css("background-image");if(!(e==="none"||e==="inherit")){var e=c(e),h=e.bgImgFilepath,j=r[e.bgImgResourceName];
if(j!==void 0&&j!==null){var e=0,l=j.length;g.addClass(n);for(var m=[],o=[],q=0,t=0,E="",q=[],e=0;e<l;e++)q[e]="url("+h+j[e].name+")",m[e]=j[e].width,o[e]=j[e].height,t+=o[e],E+=q[e],e!==l-1&&(E+=",");for(var q=m[0],K=0,e=0;e<l;e++)jqImgSlicedNode=$("<img/>"),jqImgSlicedNode[0].onload=d,jqImgSlicedNode[0].src=h+j[e].name;e={w:1,h:1};f(e,g,q,t);t=[];h=[];a(t,h,m,o,l,e.w,e.h);m="";for(e=0;e<l;e++)m=m+t[e]+"px "+h[e]+"px",e!==l-1&&(m+=",");b.setAttribute("style",(b.style||"")+("; background-size: "+
m+" !important;"));m={x:0,y:0};k(m,g);for(var o=[],t=[],j=0,D=q="",e=0;e<l;e++)o[e]=m.x,t[e]=m.y+j,q=q+o[e]+"px "+t[e]+"px",D+="no-repeat",j+=h[e],e!==l-1&&(q+=",",D+=",");b.setAttribute("style",(b.style||"")+("; background-position: "+q+" !important;"));g.css("background-repeat",D)}}}function l(b,c,d){for(var g=[],f=[],e=[],h=[],k=0,j=0,l=$(c).children(),j=j=0;j<l.length;j++)g[j]=l[j].width,f[j]=l[j].height,k+=f[j];j=g[0];if(!(k===0||j===0)){$(b).css("display","block");var m=parseInt($(b).css("height"),
10),n=parseInt($(b).css("width"),10);n===0&&m===0?(n=j,m=k):m===0?m=Math.round(k/j*n):n===0&&(n=Math.round(j/k*m));$(b).width(n);$(b).height(m);a(e,h,g,f,l.length,n/j,m/k);for(j=0;j<l.length;j++)$(l[j]).width(e[j]),$(l[j]).height(h[j]),$(l[j]).css("top","0px"),$(l[j]).css("left","0px"),$(l[j]).css("position","relative"),$(l[j]).css("border","none"),$(l[j]).css("display","block"),d&&$(l[j]).css("margin-bottom","-1px");$(c).css("line-height",0);$(c).css("display","inline-block");$(c).css("position",
$(b).css("position"));$(c).css("width",$(b).css("width"));$(c).css("height",$(b).css("height"));$(c).css("top",$(b).css("top"));$(c).css("left",$(b).css("left"));$(c).css("bottom",$(b).css("bottom"));$(c).css("right",$(b).css("right"));$(c).css("float",$(b).css("float"));$(c).css("padding",$(b).css("padding"));$(c).css("border",$(b).css("border"))}}var n="amzn-sliced-bgimg-ori",r={},o=null,q=RegExp(/\d+$/),t=[200,500,1E3];return{initialize:function(a){if(a.coverResource!==null&&a.coverResource!==
void 0)o=a.resourceManifest[a.coverResource].name;a=a.compositeResourceManifest;a!==void 0&&a!==null?e(a):r={}},cleanup:function(){r={}},getCompositeData:function(){return r},getCoverImageSlices:function(){return r[o]},resolveCompositeResources:function(a){if(!$.isEmptyObject(r)){for(var b=[],c=0;c<a.length;c++){var d=[],g=d,f=a[c];if(r[f]!==void 0&&r[f]!==null)for(var e=r[f].length,h=0;h<e;h++)g.push(r[f][h].name);b=d.length>0?b.concat(d):b.concat(a[c])}a=b}return a},loadImage:function(a,b,c,g){var f=
r[g];if(f!==void 0&&f!==null){$(a).addClass("amzn-sliced-inimg-ori");(g=a.getAttribute("alt"))&&a.setAttribute("data-alt-text",g);a.removeAttribute("alt");$(a).css("display","none");g=$("<div/>",{"class":"amzn-sliced-inimg-div"});g.insertBefore($(a));g.attr("data-nid",a.getAttribute("data-nid"));for(var e=f.length,h=0;h<e;h++)a=$("<img/>",{"class":"amzn-sliced-inimg-imgslice"}),a.width(f[h].width),a.height(f[h].height),d(a[0],b,c,f[h].name),a.appendTo(g)}else d(a,b,c,g)},scaleCompositeInlineImages:function(a){if(!$.isEmptyObject(r)){for(var b=
a.getElementsByClassName("amzn-sliced-inimg-ori"),a=a.getElementsByClassName("amzn-sliced-inimg-div"),c=b.length,d=0,d=0;d<c;d++){l(b[d],a[d],!0);var g=$(a[d]).children()[0],f=b[d].getAttribute("data-alt-text");f&&g.setAttribute("alt",f)}$(b).remove()}},scaleCompositeBackgroundImages:function(a){if(!$.isEmptyObject(r))for(var a=$(a).find("*"),b=0;b<a.length;b++)m(a[b])},scaleImageSlices:l,createCanvasImage:h,scaleCanvas:function(a,b){for(var c=a,d=c.width,g=c.height;d>b.width&&g>b.height;){var f=
Math.max(b.width,Math.round(d*0.75)),e=Math.max(b.height,Math.round(g*0.75)),h=document.createElement("canvas"),k=h.getContext("2d");h.width=f;h.height=e;$(h).attr("id","c1");k.drawImage(c,0,0,d,g,0,0,f,e);k.globalAlpha=0.5;k.drawImage(a,0,0,a.width,a.height,0,0,f,e);c=h;d=c.width;g=c.height}return c}}}(),KindleRendererWritingModeFactory=function(){function h(c,b,f,a,g){var e=d*Math.min(f,a),h=Math.abs(f-a);return(c<b?c+f-b:b+a-c)>e&&(!g||h<e)}function j(){var c=KindleRendererDeviceSpecific.usesDocRelativeVerticalCoordinates(),
b=0,d=!1;return{getWritingMode:function(){return"vertical"},resetHeight:function(a){$(a).css("width",$(a.parentNode).width()+"px")},resetWidth:function(a){$(a).css("height",$(a.parentNode).height()+"px")},resetIframeDimensions:function(a){$(a).css({width:$(a.parentNode).width()+"px",height:$(a.parentNode).height()+"px"})},padImageIfNeeded:function(a){var b=$(a).css("margin-left");parseInt(b,10)<=1&&$(a).css("margin-left","2px")},getAvailableSizeForImage:function(a,b,c){var d=Math.min(a.getAttribute("data-nativeTopOffset"),
a.offsetTop),f=$(a.offsetParent).outerHeight()||b.height,e=$(a.offsetParent).outerWidth()||b.width,f=Math.min(f-d,b.height*c),e=Math.min(e,b.width*c);$(a).css("float")!=="none"&&(c=$(a).parent(),a=parseInt($(c).css("line-height"),10),c=parseInt($(c).css("font-size"),10),e=Math.min(e,b.width-(a+c)));return{width:e,height:f}},calculateOverlappingImageSets:function(a,b){function c(a,b){return a.offsetLeft-b.offsetLeft}var d=[];if(a.length>1){for(var a=Array.prototype.slice.call(a).sort(c),f=null,e=a[0],
h=e.offsetLeft+e.width,j,q,t=1;t<a.length;++t)if(j=a[t],!b(j)){q=j.offsetLeft+j.width;if(j.offsetLeft<=h){f||(f={left:e.offsetLeft,right:h,imgs:[e]});if(q>f.right)f.right=q;f.imgs.push(j)}else f&&(d.push({height:0,width:f.right-f.left,imgs:f.imgs}),f=null);e=j;h=f?f.right:q}f&&d.push({height:0,width:f.right-f.left,imgs:f.imgs})}return d},forceRepaint:function(a){if(a.contentDocument)a.contentDocument.body.style.top=0,setTimeout(function(){a.contentDocument.body.style.top=""},1)},setHeight:function(a,
b){$(a).css("width",b)},setWidth:function(a,b){$(a).css("height",b)},fitToBottomOfFrame:function(a,b,c){$(b).css({height:"100%",width:$(a).width()-c+1,top:0,left:$(a).position().left-1})},height:function(a){return $(a).width()},width:function(a){return $(a).height()},prepareForPagination:function(a){b=$(a).width();this.scrollToTopOfDocument(a);d=$(a.contentDocument).find("table").length>0},getBorderMap:function(a,c){var d,f,e,h;for(d=0;d<a.length;d++){e=a[d];f=e.getBoundingClientRect();if((h=$(e).css("border-right-style"))&&
h!=="none")if(h=parseInt($(e).css("border-right-width"),10))h={borderStart:b-f.right-h,borderEnd:b-f.right},c.top.push(h);if((h=$(e).css("border-left-style"))&&h!=="none")if(e=parseInt($(e).css("border-left-width"),10))h={borderStart:b-f.left,borderEnd:b-f.left+e},c.bottom.push(h)}},getTransformedClientRects:function(a,c,e){var h=a.length,j=[],n=c&&c.deltaX||0,e=c&&c.fontSize||e&&parseInt(e.fontSize,10)||void 0,r=0;for(a.length>1&&(a[0].height<=1&&++r,a[a.length-1].height<=1&&--h);r<h;r++){var o=
a[r],q=o.right+n-(c&&parseInt(c.ownerDocument.body.style.left,10)||0),t=e&&c.tagName!=="IMG"?e:o.width,o={top:o.top,bottom:o.bottom,height:o.height,left:b-(q-t),right:b-q,width:t},t=c,q=o;if(d){var s=$(t).closest("TBODY")[0];if(s){var u=0,u=$(s).parent(),y=$(u).width(),u=y,v=$(t).closest("TD")[0];v&&(u-=$(v).width());s=y-$(s).width();u+=s;q.left+=u;q.right+=u}}t&&t.getAttribute&&t.getAttribute("data-isTextCombineBlock")&&(s=parseInt($(t).css("font-size"),10),t=q.height-s,s=q.width-s,t>0&&(u=Math.ceil(t/
2),q.top+=u,q.bottom-=u,q.height-=t),s<0&&(t=Math.ceil(s/2),q.left-=t,q.right+=t,q.width-=s));j.push(o)}return j},getRectsAdjustedForAnnotationMarks:function(a,b){for(var c=a.length,d=[],f=Math.ceil(b/2)+1,e=0;e<c;e++){var h=a[e];d.push({top:h.top,bottom:h.bottom,height:h.height,left:h.left,right:h.right-f,width:h.width+f})}return d},unionRect:function(a){for(var b=a[0],b={left:b.top,right:b.bottom,bottom:b.left,top:b.right},c=1;c<a.length;++c)b.top=Math.min(b.top,a[c].right),b.bottom=Math.max(b.bottom,
a[c].left),b.right=Math.max(b.right,a[c].bottom),b.left=Math.min(b.left,a[c].top);return b},clientRectTop:function(a){return a.right},clientRectBottom:function(a){return a.left},clientRectLeft:function(a){return a.top},clientRectRight:function(a){return a.bottom},clientRectWidth:function(a){return a.height},clientRectHeight:function(a){return a.width},clientRectCompare:function(a,b){return h(a.right,b.right,a.width,b.width,!1)?a.top-b.top:a.right-b.right},checkIfRectsOnSameLine:function(a,b){return h(a.right,
b.right,a.width,b.width,!1)},scrollToTopOfDocument:function(a){var d=0;c&&(d=a.contentDocument.width-b);$(a.contentWindow).scrollLeft(d);a.contentDocument.body.style.top=0;a.contentDocument.body.style.left=0},scrollTop:function(a,b){a.contentDocument.body.style.left=b},getRectBoundariesForScreen:function(a,c){for(var d=[],f=a.length,e=0;e<f;e++)d.push({left:b-(a[e].left-c),top:a[e].top,right:b-(a[e].right-c),bottom:a[e].bottom});return d},isPointOnVisiblePage:function(a,b,c){return c>b},checkIfNewLine:function(a,
b,c){return b===void 0||!h(a.right,b.right,a.width,b.width,c)},updateLineBounds:function(a,b,c,d,f){a.left=f-c.left;a.right=f-c.right;a.height=b&&d?d.top-a.top:c.bottom-a.top;a.width=a.right-a.left},updateLineHeightOfBounds:function(a,b){a.left=a.left>=b.left?a.left:b.left;a.right=a.right<=b.right?a.right:b.right;a.top=b.top;a.bottom=b.bottom},updateDivIfNewLineOrImageBound:function(a,b,c,d,f,e){var h=!1;if(a.isNewLine||a.isImageBound)a.lineBounds={top:a.isNewLine?b.top:a.lineBounds.top+a.lineBounds.height,
height:b.height,left:b.left,right:b.right,width:b.width};a.isImageBound=f;a.isNewLine=this.checkIfNewLine(a.lineBounds,c,!0);(h=a.isNewLine||a.isImageBound)&&this.updateLineBounds(a.lineBounds,!a.isNewLine&&!(d||c===void 0),b,c,e);return h},positionDivAfterWord:function(a,b,c,d){a.style.top=b.top+c;a.style.left=d-b.left+b.width+c},getDeltaX:function(a,b){var g;var c,d=0;if(KindleHostDeviceDetector.isiOS()&&parseInt(KindleHostDeviceDetector.getOSMajorVersion(),10)<6){if(a.tagName==="RUBY"){var f=b.createRange();
f.selectNodeContents(a);var f=f.getClientRects(),e=a.getClientRects();e&&f&&e.length&&f.length&&(d=e[0].left-f[0].left)}if(a.parentNode&&a.parentNode.parentNode){f=a.nodeType===Node.TEXT_NODE?a.parentNode:a;e=a.nodeType!==Node.TEXT_NODE&&a.tagName!=="RUBY"&&$(f).css("display")==="inline";c=$(f).css("display")==="inline-block";var h=$(f.parentNode).css("display")==="inline";if((e||c)&&h){d+=-f.getBoundingClientRect().right;e=f;do c=e,e=e.parentNode;while(e&&$(e).css("display")!=="block");c={containingBlock:e,
furthestNonBlockParent:c};if(e=c.containingBlock){g=h=c.furthestNonBlockParent,c=g;do c=c.nextElementSibling;while(c&&$(c).css("display")!=="block");do h=h.previousElementSibling;while(h&&$(h).css("display")!=="block");h=h?h.getBoundingClientRect().left-parseInt($(h).css("margin-left"),10):e.getBoundingClientRect().right;e=c?c.getBoundingClientRect().right+parseInt($(c).css("margin-right"),10):e.getBoundingClientRect().left;f=h-(f.getBoundingClientRect().left-e)}else f=f.getBoundingClientRect().right;
d+=f}}}return d},floatToTopOfIframe:function(a,c){var d=a.document.body,f=d.getBoundingClientRect(),d=a.getComputedStyle(d);$(c).css({position:"absolute",top:parseInt(d.top,10)-f.top,left:parseInt(d.left,10)-(f.left+a.document.width-b)})}}}function e(){return{getWritingMode:function(){return"horizontal"},resetHeight:function(c){$(c).css("height",$(c.parentNode).height()+"px")},resetWidth:function(c){$(c).css("width",$(c.parentNode).width()+"px")},resetIframeDimensions:function(c){$(c).css({height:$(c.parentNode).height()+
"px",width:$(c.parentNode).width()+"px"})},padImageIfNeeded:function(c){var b=$(c).css("margin-bottom");parseInt(b,10)<=1&&$(c).css("margin-bottom","2px")},getAvailableSizeForImage:function(c,b,d){var a=Math.min(c.getAttribute("data-nativeLeftOffset"),c.offsetLeft),g=$(c.offsetParent).outerHeight()||b.height,e=$(c.offsetParent).outerWidth()||b.width,g=Math.min(g,b.height*d),e=Math.min(e-a,b.width*d);$(c).css("float")!=="none"&&(d=$(c).parent(),c=parseInt($(d).css("line-height"),10),d=parseInt($(d).css("font-size"),
10),g=Math.min(g,b.height-(c+d)));return{width:e,height:g}},calculateOverlappingImageSets:function(c,b){function d(a,b){return a.offsetTop-b.offsetTop}var a=[];if(c.length>1){for(var c=Array.prototype.slice.call(c).sort(d),g=null,e=c[0],h=e.offsetTop+e.height,j,n,r=1;r<c.length;++r)if(j=c[r],!b(j)){n=j.offsetTop+j.height;if(j.offsetTop<=h){g||(g={top:e.offsetTop,bottom:h,imgs:[e]});if(n>g.bottom)g.bottom=n;g.imgs.push(j)}else g&&(a.push({height:g.bottom-g.top,width:0,imgs:g.imgs}),g=null);e=j;h=g?
g.bottom:n}g&&a.push({height:g.bottom-g.top,width:0,imgs:g.imgs})}return a},forceRepaint:function(){},setHeight:function(c,b){$(c).css("height",b)},setWidth:function(c,b){$(c).css("width",b)},fitToBottomOfFrame:function(c,b,d){d=$(c).height()-d+1;c=$(c).position().top+$(c).height()-d+1;$(b).css({height:d,width:"100%",top:c,left:0})},height:function(c){return $(c).height()},width:function(c){return $(c).width()},prepareForPagination:function(c){this.scrollToTopOfDocument(c)},getBorderMap:function(c,
b){var d,a,g,e;for(d=0;d<c.length;d++){g=c[d];a=g.getBoundingClientRect();if((e=$(g).css("border-top-style"))&&e!=="none")if(e=parseInt($(g).css("border-top-width"),10))e={borderStart:a.top-e,borderEnd:a.top},b.top.push(e);if((e=$(g).css("border-bottom-style"))&&e!=="none")if(g=parseInt($(g).css("border-bottom-width"),10))e={borderStart:a.bottom,borderEnd:a.bottom+g},b.bottom.push(e)}},getTransformedClientRects:function(c,b){c.length>1&&(c[0].width<=1&&(c=Array.prototype.slice.call(c,1)),c[c.length-
1].width<=1&&(c=Array.prototype.slice.call(c,0,-1)));if(b){var d=[],a=parseInt(b.ownerDocument.body.style.top,10);if(a!==0){for(var g=0;g<c.length;++g){var e=c[g];d.push({top:e.top-a,bottom:e.bottom-a,height:e.height,left:e.left,right:e.right,width:e.width})}c=d}}return c},getRectsAdjustedForAnnotationMarks:function(c,b){for(var d=c.length,a=[],g=Math.ceil(b/2)+1,e=0;e<d;e++){var h=c[e];a.push({top:h.top-g,bottom:h.bottom,height:h.height+g,left:h.left,right:h.right,width:h.width})}return a},unionRect:function(c){for(var b=
c[0],b={top:b.top,bottom:b.bottom,left:b.left,right:b.right},d=1;d<c.length;++d)b.top=Math.min(b.top,c[d].top),b.right=Math.max(b.right,c[d].right),b.bottom=Math.max(b.bottom,c[d].bottom),b.left=Math.min(b.left,c[d].left);return b},clientRectTop:function(c){return c.top},clientRectBottom:function(c){return c.bottom},clientRectLeft:function(c){return c.left},clientRectRight:function(c){return c.right},clientRectWidth:function(c){return c.width},clientRectHeight:function(c){return c.height},clientRectCompare:function(c,
b){return h(c.top,b.top,c.height,b.height,!1)?c.left-b.left:c.top-b.top},checkIfRectsOnSameLine:function(c,b){return h(c.top,b.top,c.height,b.height,!1)},scrollToTopOfDocument:function(c){$(c.contentWindow).scrollTop(0);c.contentDocument.body.style.top=0;c.contentDocument.body.style.left=0},scrollTop:function(c,b){c.contentDocument.body.style.top=-b},getRectBoundariesForScreen:function(c,b){for(var d=[],a=c.length,g=0;g<a;g++)d.push({left:c[g].left,top:c[g].top-b,right:c[g].right,bottom:c[g].bottom-
b});return d},isPointOnVisiblePage:function(c,b,d,a){return a<c-b},checkIfNewLine:function(c,b,d){return b===void 0||!h(c.top,b.top,c.height,b.height,d)},updateLineBounds:function(c,b,d,a){c.top=d.top;c.bottom=d.bottom;c.height=c.bottom-c.top;c.width=b&&a?a.left-c.left:d.right-c.left},updateLineHeightOfBounds:function(c,b){c.top=c.top?c.top<=b.top?c.top:b.top:b.top;c.bottom=c.bottom?c.bottom>=b.bottom?c.bottom:b.bottom:b.bottom;c.left=b.left;c.right=b.right},updateDivIfNewLineOrImageBound:function(c,
b,d,a,g){var e=!1;if(c.isNewLine||c.isImageBound)c.lineBounds={top:b.top,height:b.height,left:c.isNewLine?b.left:c.lineBounds.left+c.lineBounds.width,right:b.right,width:b.width};c.isImageBound=g;c.isNewLine=this.checkIfNewLine(c.lineBounds,d,!0);(e=c.isNewLine||c.isImageBound)&&this.updateLineBounds(c.lineBounds,!c.isNewLine&&!(a||d===void 0),b,d);return e},positionDivAfterWord:function(c,b,d){c.style.top=b.top+d;c.style.left=b.left+b.width+d},getDeltaX:function(){return 0},floatToTopOfIframe:function(c,
b){var d=c.document.body,a=d.getBoundingClientRect(),d=c.getComputedStyle(d);$(b).css({position:"absolute",top:parseInt(d.top,10)-a.top,left:parseInt(d.left,10)-a.left})}}}var d=0.25;return{buildIFrameWritingMode:function(c){if(!c.contentDocument)return e();if(KindleRendererDeviceSpecific.needsWritingModeSpecifiedOnBody()){var b=c.contentDocument,d=b.documentElement,b=b.body;if($(d).css("-webkit-writing-mode")==="vertical-rl"){var a=d.getAttribute("style"),g=b.getAttribute("style"),g=g?g+";":"";d.setAttribute("style",
(a?a+";":"")+"-webkit-writing-mode: vertical-rl !important;");b.setAttribute("style",g+"-webkit-writing-mode: vertical-rl !important;")}}return(c=$(c.contentDocument.body).css("-webkit-writing-mode"))&&c.match(/^vertical/)!==null?j():e()},buildHorizontalWritingMode:e,buildVerticalWritingMode:j}}(),KindleRendererContentReflow=function(){function h(a){a=a.contentDocument.getElementsByTagName("body")[0];return $(a).css("position")==="absolute"}function j(a,b){KindleRendererLanguageOptions.getNeedsPageRefresh()&&
!h(a)?(a.contentDocument.body.style.display="none",setTimeout(function(){a.contentDocument.body.style.display="block";b()},1)):b()}function e(b,c,d,f,e,o){g===null&&(g=KindleRendererWordMapGeneratorFactory.buildWordMapGeneratorForWordBounds());var q=e.createSubTimer("preparation");KindleRendererContentCorrection.applyDocumentWideCorrections(b.contentWindow,b.contentDocument,b.writingMode,q);j(b,function(){b.writingMode.prepareForPagination(b);var t=b.contentDocument.getElementById(a);b.writingMode.floatToTopOfIframe(b.contentWindow,
t);q.endTimer();var s=e.createSubTimer("word-map");g.createWordMap(b.contentDocument,b.contentWindow,c,b.writingMode,d,b.processingRequestId,s).then(function(a,c,d){function f(a){l.endTimer();o(a)}s.endTimer();KindleRendererContentCorrection.cleanup(b.contentDocument.body);var l=e.createSubTimer("height-map");h(b)?KindlePaginatorFixedContent(b.contentDocument,a,$(b).parent().height(),f):KindlePaginatorScreenFragmentation(b.contentDocument,a,c,d,g,b.writingMode.height($(b).parent()),b.writingMode,
f);j(b,function(){})},f.reject)})}function d(a,b,d,f){if(a.processingRequestId.id===b.requestId){a.writingMode.scrollToTopOfDocument(a);a.writingMode.resetHeight(a);var g={height:$(a).parent().height(),width:$(a).parent().width()},e=a.contentDocument.getElementsByTagName("body")[0];if(KindleRendererSettings.getSettings().initialExpandedBodyHeight!==void 0){var h=parseInt($(e).css("margin-top"),10),j=parseInt($(e).css("margin-bottom"),10);e.style.height=parseInt(g.height,10)-h-j+"px"}h=e.getElementsByClassName("k4w-margin");
for(j=0;j<h.length;j+=1){var s=parseInt(h[j].getAttribute("vertical"),10);if(s>0)h[j].style.marginTop=Math.round(s*0.01*g.height)+"px"}KindleRendererElementFitting.fitToViewport(e,a.writingMode,g,b.contentLoadMetrics).then(function(){a.processingRequestId.id!==b.requestId?(b.contentLoadMetrics.addCount("Cancelled",1),b.contentLoadMetrics.endTimer()):c(a,b,d,f)},f.reject)}}function c(a,b,c,d){b.contentLoadMetrics.endTimer();var f=b.metrics.createSubTimer("pagination");e(a,c,b.requestId,d,f,function(c){f.endTimer();
a.processingRequestId.id!==b.requestId?(b.contentLoadMetrics.addCount("Cancelled",1),b.contentLoadMetrics.endTimer()):(a.screenManager=c,b.contentLoadMetrics.endTimer(),d.resolve(b))})}function b(a,b){var c=KindleRendererDeviceSpecific.reflowTimeout();c>0&&setTimeout(function(){if(b.state?b.state()==="pending":!b.isRejected()&&!b.isResolved())a.contentLoadMetrics.addCount("Timeout",1),a.contentLoadMetrics.endTimer(),b.reject()},c)}function f(a,c,f){var g=new jQuery.Deferred;b(c,g);var e=c.contentLoadMetrics.createSubTimer("(YIELD) begin-element-fitting");
setTimeout(function(){e.endTimer();d(a,c,f,g)},KindleRendererDeviceSpecific.drawYieldUpdateTime());return g.promise()}var a="content-overlays",g=null;return{initialize:function(){KindleRendererContentCorrection.initialize()},reflow:function(a,b,c){return f(a,b,c)}}}(),KindlePaginatorFixedContent=function(h,j,e,d){h={minDocTop:0,maxDocTop:0,docBottom:e,wordMap:j};(function(c){c.minPosition=Infinity;c.maxPosition=-Infinity;for(var b in j){var d=parseInt(b,10);if(d>c.maxPosition)c.maxPosition=d;if(d<
c.minPosition)c.minPosition=d}})(h);(function(c){c.hasNextScreen=function(b){return b===0};c.hasPreviousScreen=function(b){return b===e};c.getFirstReadingPositionAtHeight=function(){return null};c.getFirstEmptySpaceBeforeHeight=function(){return 0};c.getTopOfNodeAtPosition=function(){return 0};c.findNextScreen=function(b){return!c.hasNextScreen(b)?null:{topOfScreen:0,bottomOfScreen:e}};c.findPreviousScreen=function(b){return!this.hasPreviousScreen(b)?null:{topOfScreen:0,bottomOfScreen:e}}})(h);d(h)},
KindlePaginatorHeightMapGenerator=function(){function h(a,b,c,d,f,e){c<0&&(c=0);d<0&&(d=0);if(b.previousTop===c&&b.previousBottom===d&&b.previousFontSize===e)return!1;b.previousTop=c;b.previousBottom=d;b.previousFontSize=e;if(c<a.minDocTop)a.minDocTop=c;if(c>a.maxDocTop)a.maxDocTop=c;b=d;if(b>a.docBottom)a.docBottom=b;d-=c;e===void 0&&(e=d);d=c+Math.floor((d-e)/2);e=d+e;a=a.nodeHeightRanges;for(c+=1;c<d;)a[c]>=0||(a[c]=-f),++c;for(;c<e;)a[c]>=0||(a[c]=f),++c;for(;c<b;)a[c]===void 0&&(a[c]=-f),++c;
return!0}function j(a){for(var a=a.nodeHeightRanges,b=a.length,c=0,d,f,e,h,j;c<b;){for(;a[c]<0;)a[c]=-a[c],++c;if(a[c]>=0){for(++c;a[c]>=0;)++c;if(a[c]<0){d=c;h=a[d-1];for(++c;a[c]<0;)++c;f=c-1;j=a[c];if(j>=0){e=Math.floor((d+f)/2);for(delete a[e];d<e;++d)a[d]=h;for(d=e+1;d<=f;++d)a[d]=j}else for(;d<=f;++d)a[d]=h}}++c}}function e(a,b,c,d,f,r,o){function q(){e(a+1,b,c,d,f,r,o)}var t=0;for(KindleRendererProcessTuning.startingOperation("HeightMap");a<b.length;){var s=b[a],u=s.position,y=s.rect,v=d.clientRectTop(y),
y=d.clientRectBottom(y);if(v>0||y>0){var x=Math.round(v);h(c,f,x,x+Math.round(y-v+1),u,s.fontSize)&&t++}if(t>o.count){KindleRendererProcessTuning.endingOperation("HeightMap",t);setTimeout(q,o.interval);return}a++}KindleRendererProcessTuning.endingOperation("HeightMap",t);j(c);setTimeout(r.resolve,o.interval)}function d(a){var b={},a=a.body;b.bodyDimensions={height:a.offsetHeight,width:a.offsetWidth};if(a=a.lastElementChild){var c=$(a),a=c.offset(),d=c.width(),c=c.height();b.lastElementPos={top:a.top,
left:a.left,width:d,height:c}}return b}function c(a,b,c,d,f,h,j,q){if(c){var t=new jQuery.Deferred,s={count:KindleRendererProcessTuning.drawYieldFrequency("HeightMap"),interval:KindleRendererProcessTuning.drawYieldUpdateTime("HeightMap")};e(0,c,d,b,{},t,s);t.promise().then(function(){var c=Array.prototype.slice.call(a.getElementsByTagName("hr")),d,e=[];for(d=0;d<c.length;++d)e.push(c[d].getBoundingClientRect());e=b.getTransformedClientRects(e);for(d=0;d<e.length;++d)h.push(e[d]);c=$(a.body).find("[data-hasCssBorder='true']");
b.getBorderMap(c,j);c=[];c=c.concat(Array.prototype.slice.call(a.getElementsByClassName("page-break")));c=c.concat(Array.prototype.slice.call(a.getElementsByClassName("pagebreak")));d=[];for(e=0;e<c.length;++e)d.push(c[e].getBoundingClientRect());d=b.getTransformedClientRects(d);for(e=0;e<d.length;++e)f.push(Math.round(b.clientRectTop(d[e])));q()},function(){})}}function b(b,c){var d=function(){if(j<b.minDocTop)b.minDocTop=j;if(j>b.maxDocTop)b.maxDocTop=j;if(o>b.docBottom)b.docBottom=o;for(var a=
j;a<o;a++)b.nodeHeightRanges[a]===void 0&&(b.nodeHeightRanges[a]=f)},e,h;e=c.top;h=c.bottom;var j,o,q,t,s;for(q=0;q<e.length;q++){j=Math.round(e[q].borderStart);o=Math.round(e[q].borderEnd);d();s=0;for(t=o;t<b.docBottom;t++)if(b.nodeHeightRanges[t]===void 0&&s<=a)b.nodeHeightRanges[t]=f,s++;else break}for(q=0;q<h.length;q++){j=Math.round(h[q].borderStart);o=Math.round(h[q].borderEnd);d();s=0;for(t=j;t>b.minDocTop;t--)if(b.nodeHeightRanges[t]===void 0&&s<=a)b.nodeHeightRanges[t]=f,s++;else break}}
var f="border-height",a=2;return{getHeightMapTags:function(){return{HARD_PAGE_BREAK:"page-break",HORIZONTAL_RULE:"horizontal-rule",BORDER_HEIGHT:f}},createHeightMap:function(a,f,e,h){var j={nodeHeightRanges:[],minPosition:Infinity,maxPosition:0,minDocTop:Infinity,maxDocTop:0,docBottom:0};j.validationData=d(a);var r=[],o=[],q={top:[],bottom:[]};c(a,f,e,j,r,o,q,function(){for(var a=r,c=0;c<a.length;c++){var d=a[c],g=j.nodeHeightRanges[d];if(g===void 0)j.nodeHeightRanges[d]="page-break";else if(g!==
"page-break")for(var e=1;e<20;e++){if(j.nodeHeightRanges[d-e]!==g){j.nodeHeightRanges[d-e]="page-break";break}if(j.nodeHeightRanges[d+e]!==g){j.nodeHeightRanges[d+e]="page-break";break}}}for(a=0;a<o.length;a++)if(d=Math.round(f.clientRectTop(o[a])),c=Math.round(f.clientRectBottom(o[a])),c>d){if(d<j.minDocTop)j.minDocTop=d;if(d>j.maxDocTop)j.maxDocTop=d;if(c>j.docBottom)j.docBottom=c;for(;d<c;d++)j.nodeHeightRanges[d]===void 0&&(j.nodeHeightRanges[d]="horizontal-rule")}b(j,q,f);r=null;h(j)})}}}(),
KindlePaginator=function(){function h(d,c){if(c!==null)d.currentTopOfScreen=c.topOfScreen,d.currentBottomOfScreen=c.bottomOfScreen,e(d)}function j(d,c){if(c!==null)d.currentTopOfScreen=c.topOfScreen,d.currentBottomOfScreen=c.bottomOfScreen,e(d)}function e(d){var c=KindleRendererDeviceSpecific.animatePageFlip(),b=$(d);c&&(b.removeClass("pageTurnEnd"),b.addClass("pageTurnStart"));d.writingMode.scrollTop(d,d.currentTopOfScreen);d.writingMode.fitToBottomOfFrame(d,d.pageOverflowDiv,d.currentBottomOfScreen-
d.currentTopOfScreen);c&&(b.removeClass("pageTurnStart"),b.addClass("pageTurnEnd"))}return{scrollToTop:function(d,c){var b=d.screenManager.findNextScreen(c||d.screenManager.minDocTop<=1?0:d.screenManager.minDocTop-1);h(d,b)},scrollToBottom:function(d,c){var b=d.screenManager.findPreviousScreen(d.screenManager.docBottom,c);j(d,b)},scrollToPosition:function(d,c,b){c=d.screenManager.getTopOfNodeAtPosition(d.contentDocument,c);c=d.screenManager.getFirstEmptySpaceBeforeHeight(c);b=d.screenManager.findNextScreen(b&&
c<=d.screenManager.minDocTop?0:c);h(d,b)},matchFrames:function(d,c){var b=d.screenManager.getFirstReadingPositionAtHeight(d.currentTopOfScreen),f=d.screenManager.getTopOfNodeAtPosition(d.contentDocument,b)-d.currentTopOfScreen,a=d.currentBottomOfScreen-d.currentTopOfScreen,b=c.screenManager.getTopOfNodeAtPosition(c.contentDocument,b);c.currentTopOfScreen=b-f;c.currentBottomOfScreen=c.currentTopOfScreen+a;e(c)},getApproximateNumPreviousScreens:function(d){var c=d.writingMode.height($(d).parent());
return(d.currentTopOfScreen-d.screenManager.minDocTop)/c},getApproximateNumNextScreens:function(d){var c=d.writingMode.height($(d).parent());return(d.screenManager.maxDocTop-d.currentBottomOfScreen)/c},getCurrentPagePositionRange:function(d){var c=d.screenManager.getFirstReadingPositionAtHeight(d.currentTopOfScreen),d=d.screenManager.getFirstReadingPositionAtHeight(d.currentBottomOfScreen)-1;return{currentTopOfPage:c,currentBottomOfPage:d}},hasPreviousScreen:function(d){return d.screenManager.hasPreviousScreen(d.currentTopOfScreen)},
hasNextScreen:function(d){return d.screenManager.hasNextScreen(d.currentBottomOfScreen)},isPreviousFullScreen:function(d,c){var b=d.screenManager.findPreviousScreen(d.currentTopOfScreen,c);return b!==null?d.screenManager.hasPreviousScreen(b.topOfScreen):!1},isNextFullScreen:function(d){var c=d.screenManager.findNextScreen(d.currentBottomOfScreen);return c!==null?d.screenManager.hasNextScreen(c.bottomOfScreen):!1},nextScreen:function(d,c){var b=d.screenManager.findNextScreen(d.currentBottomOfScreen);
return b!==null&&(c||d.screenManager.hasNextScreen(b.bottomOfScreen))?(h(d,b),!0):!1},previousScreen:function(d,c,b){b=d.screenManager.findPreviousScreen(d.currentTopOfScreen,b);return b!==null&&(c||d.screenManager.hasPreviousScreen(b.topOfScreen))?(j(d,b),!0):!1},getWordMap:function(d){return d.screenManager.wordMap},copyIframe:function(d,c){c.screenManager=d.screenManager;c.writingMode=d.writingMode;c.currentTopOfScreen=d.currentTopOfScreen;c.currentBottomOfScreen=d.currentBottomOfScreen;c.writingMode.resetIframeDimensions(c)},
getSelectableItemBoundariesForCurrentScreen:function(d){for(var c=KindlePaginator.getCurrentPagePositionRange(d),b=d.screenManager.wordMap,f=c.currentBottomOfPage,a={},c=c.currentTopOfPage;c<=f;++c){var g=b[c]&&b[c].rects;if(g!==void 0){var e=b[c].selectableRects;e!==void 0&&(g=e);a[c]=d.writingMode.getRectBoundariesForScreen(g,d.currentTopOfScreen)}}return a},getWordPositionsForCurrentScreen:function(d){var c=KindlePaginator.getCurrentPagePositionRange(d),d=d.screenManager.wordPositions,b=c.currentTopOfPage,
f=c.currentBottomOfPage,c=null;if(d&&d.length>0){var a=KindleListUtilities.binarySearch(d,b),f=KindleListUtilities.binarySearch(d,f,void 0,a);d[a]<b&&++a;c=[];for(b=a;b<=f;++b)c.push(d[b])}return c},isPointOnVisiblePage:function(d,c,b){var f=d.writingMode.height(d),a=d.writingMode.height(d.pageOverflowDiv);return d.writingMode.isPointOnVisiblePage(f,a,c,b)},showEndOfDocument:function(d){d.currentTopOfScreen=d.currentBottomOfScreen;e(d)},isIframePaginationValid:function(d){var c=d.screenManager.validationData;
if(c){var b=d.contentDocument.body,f=c.bodyDimensions,d=$(d).parent(),a=window.navigator.userAgent.indexOf("MSIE")!==-1;if(b.offsetHeight===f.height&&b.offsetWidth===f.width||b.offsetHeight<=d.height()&&b.offsetWidth<=d.width())return!0;else if(a&&(f=Math.abs(b.offsetHeight-f.height),b.offsetWidth===b.offsetWidth&&f<80))return!0;b=b.lastElementChild;return(c=c.lastElementPos)&&b?(d=$(b),b=d.offset(),f=d.width(),d=d.height(),b.top===c.top&&b.left===c.left&&f===c.width&&d===c.height):!1}return!0},clearIframePaginationValidation:function(d){d.screenManager.validationData=
null},cleanupIframe:function(d){d.screenManager=null}}}(),KindlePaginatorScreenFragmentation=function(h,j,e,d,c,b,f,a){function g(a){c.addBoundsForPosition(h,j,a,f)}function k(a){a.hasNextScreen=function(a){return this.maxDocTop>=a};a.hasPreviousScreen=function(a){return a>this.minDocTop};a.getFirstReadingPositionAtHeight=function(a){if(this.nodeHeightRanges.length===0)return null;var b;a:{for(var c=this.nodeHeightRanges,d=a;d<c.length;d+=1)if(b=c[d],b!==void 0&&b!==l&&b!==n&&b!==r){b=Math.abs(b);
break a}b=this.maxPosition+1}g(b);if(this.wordMap[b]===void 0)return b;c=f.unionRect(this.wordMap[b].rects);for(d=b;d>=this.minPosition;d--)if(g(d),this.wordMap[d]!==void 0){var e=f.unionRect(this.wordMap[d].rects);if(f.checkIfRectsOnSameLine(e,c)||e.top>=a)b=d;else break}return b};a.getFirstEmptySpaceBeforeHeight=function(a){for(var b,c=a;c>=0;c-=1)if(b=this.nodeHeightRanges[c],b===void 0||b===l)return c;return a};a.getTopOfNodeAtPosition=function(a,b){if(b<this.minPosition)return this.minDocTop;
if(b>this.maxPosition)return this.maxDocTop;for(;b<=this.maxPosition;){g(b);var c=this.wordMap[b];if(c){for(var c=c.rects,d=Infinity,e=0;e<c.length;e++){var h=f.clientRectTop(c[e]);h<d&&(d=h)}return Math.round(d)}b+=1}return this.minDocTop};a.findBestPaginationNearBottom=function(a,b){var c=this.nodeHeightRanges[b];return c!==void 0&&(g(c),c=this.wordMap[c]&&this.wordMap[c].rects,c!==void 0&&(c=Math.floor(f.clientRectTop(c[0])+1),a<=c&&c<b))?c:b-1};a.findBestPaginationNearTop=function(a,b){var c=
this.nodeHeightRanges[a];return c!==void 0&&(c<0&&(c=-c),g(c),c=this.wordMap[c]&&this.wordMap[c].rects,c!==void 0&&(c=Math.floor(f.clientRectBottom(c[c.length-1])),a<c&&c<=b))?c:a+1};a.findNextScreen=function(a){if(this.nodeHeightRanges.length===0||!this.hasNextScreen(a))return null;var c=this.nodeHeightRanges.length;if(a!==0&&this.nodeHeightRanges[a]!==l)for(var d=a+1;d<=c&&this.nodeHeightRanges[d]===void 0;)a=d++;for(var f=a,g=d=0,e=!1,h=!1,k,g=a;g<=c;g+=1)if(d+=1,k=this.nodeHeightRanges[g],k===
void 0?(f=g,h=e):k!==l&&(e=!0),k===l&&g>a){d=g-a;h=e;break}else if(d>=b){f===a&&(f=this.findBestPaginationNearBottom(a+1,a+b-1),h=e);d=f-a;break}f={topOfScreen:a,bottomOfScreen:0};g<c?f.bottomOfScreen=a+d:(f.bottomOfScreen=g,h=e);return!h?g<c?this.findNextScreen(f.bottomOfScreen):null:f};a.findPreviousScreen=function(a,c){if(this.nodeHeightRanges.length===0||!this.hasPreviousScreen(a))return null;for(var d=a,f=0,g=0,e,h=!1,k=!1,j=a,m=a,o=0,g=a;g>=0;g-=1)if(f+=1,e=this.nodeHeightRanges[g],e===void 0?
(d=g,k=h,m=j,h||++o):e!==l&&(h=!0,j=g),e===l&&g<a){if(h)return this.findNextScreen(g);o=f=0;m=j=d=a=g}else if(f>=b){d===a&&(m=this.findBestPaginationNearTop(a-b,a-1),k=h);break}d=m-1;if(d<=this.minDocTop)if(d=this.findNextScreen(c||this.minDocTop<=1?0:this.minDocTop-1),d.bottomOfScreen>=a-o)return d;else d=d.bottomOfScreen;result={topOfScreen:d,bottomOfScreen:a};return!k?g>0?this.findPreviousScreen(result.topOfScreen,c):null:result}}var m=KindlePaginatorHeightMapGenerator.getHeightMapTags(),l=m.HARD_PAGE_BREAK,
n=m.HORIZONTAL_RULE,r=m.BORDER_HEIGHT,o=function(a){var b=[],c;for(c in a){var d=parseInt(c,10);b.push(d)}b.sort(function(a,b){return a-b});return b}(j);if(d&&d.length)rects=d;else{rects=[];for(m=0;m<o.length;++m){var q=o[m],t=j[q].rects,s=j[q].fontSize,u;for(u in t)rects.push({position:q,rect:t[u],fontSize:s})}}KindlePaginatorHeightMapGenerator.createHeightMap(h,f,rects,function(b){b.wordMap=j;b.lineRects=d;b.wordPositions=e;b.wordMapKeys=o;b.wordMapGenerator=c;if(o.length>0)b.minPosition=o[0],b.maxPosition=
o[o.length-1];k(b);a(b)})},KindleRendererWordMapGeneratorFactory=function(){function h(a,b){if(a&&a.getComputedStyle)return a.getComputedStyle(b)}function j(a,b){for(var c=[],d=0;d<a.length;++d){var f=a[d];b.clientRectWidth(f)>1&&c.push(f)}return c}function e(a,b,c,d){b&&c>=0&&a.push({rect:b,position:c,fontSize:d})}function d(a){if(a<128)return 1;else if(a<2048)return 2;else if(a>=55296&&a<=57343)return 2;return 3}function c(a,b){a.fontSize=b&&parseInt(b.fontSize,10)||0;a.hasTextEmphasis=b?b.webkitTextEmphasisStyle&&
b.webkitTextEmphasisStyle!=="none":!1;if(a.domChildIndex===void 0)for(var c=a.parentNode.firstChild,d=0;c;){if(c.nodeType===Node.TEXT_NODE)c.domChildIndex=d;c=c.nextSibling;++d}}function b(a,c){if(KindleRendererSettings.getSettings().fixedContent){var d=a.className;if(d&&d.match(t))return}if(!(a.tagName==="RT"||a.tagName==="RP"))if(a.nodeType===Node.TEXT_NODE||a.tagName==="IMG")c.push(a);else for(var d=a.childNodes,f=d.length,g=0;g<f;g+=1)b(d[g],c)}function f(a){var c=[];b(a,c);return c}function a(a){if(window.ActiveXObject&&
window.XMLHttpRequest)return f(a.body);else try{var b=(new XPathEvaluator).evaluate("/html/body//text()[not(ancestor::ruby)] | //img[not(ancestor::ruby)] | //ruby",a,null,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null),c;if(b.invalidIteratorState)c=f(a.body);else{for(var d=[],g=b.iterateNext();g;)d.push(g),g=b.iterateNext();c=d}return c}catch(e){return f(a.body)}}function g(a){a.addElementsToWordMap=function(a,b,c,d,f,g,e){function h(){k.addElementsToWordMap(a,b,c+1,d,f,g,e)}var k=this;KindleRendererProcessTuning.startingOperation("ScreenManager");
for(var j=0;c<b.length;){var l=b[c],m=l.id,l=k.getValueForNode(a,l,g);l!==null&&(f[m]=l);j+=1;if(j>=d.interval){KindleRendererProcessTuning.endingOperation("ScreenManager",j);setTimeout(h,d.time);return}c+=1}KindleRendererProcessTuning.endingOperation("ScreenManager",j);setTimeout(function(){e.resolve(f,[],null,0)},d.time)};a.getPositionDataForNode=function(a,b,c){a=a[b+"_"+c];return a===void 0||a.length===0?null:a};a.getNodeId=function(a){var b=a.parentNode,c=b.getAttribute(q),d=0;if(a.ownChildIndex===
void 0)for(;b.childNodes[d]!==a;)d+=1;else d=a.ownChildIndex;return{parentId:c,index:d}};a.getAllBaseNodesInRuby=function(a){a=(new XPathEvaluator).evaluate(".//text()[not(ancestor::rt or ancestor::rp)] | .//img[not(ancestor::rt or ancestor::rp)]",a,null,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null);if(!a.invalidIteratorState){for(var b=[],c=a.iterateNext();c;)c.nodeType===Node.TEXT_NODE&&c.nodeValue.trim().length===0||b.push(c),c=a.iterateNext();return b}};a.addRubyNodeToWordMap=function(a,b,d,f,
g,k,j,l){for(var m=this.getAllBaseNodesInRuby(a),o,q=[],n,t=0;t<m.length;++t)n=m[t],n.deltaX=a.deltaX,n.isRuby=!0,n.nodeType===Node.TEXT_NODE?(o=h(d,n.parentNode),c(n,o),(o=this.addTextNodeToWordMap(this.getNodeId(n),n,b,d,f,g,j))&&this.addTextNodeToLineRects(n,k,g,o,j,l)):(o=h(d,n),n.fontSize=o?parseInt(o.fontSize,10):0,(o=this.addImageNodeToWordMap(n,f,g,j))&&e(k,g[o[0]].rects[0],o[0])),o&&o.length>0&&(q=q.concat(o));return q}}function k(a){a.addTextNodeToWordMap=function(a,b,c,d,f,g,e){var h=b.nodeValue;
if(h&&h.trim().length>0&&(f=this.getPositionDataForNode(f,a.parentId,a.index))){var k=f.length-1,j,l=0,m;a:{m=b;for(var o=0;o<2;o++)if(m.parentNode)if(m.parentNode.getAttribute("data-isTextCombineBlock"))break a;else m=m.parentNode;m=null}if(m){if(m.deltaX===void 0)m.deltaX=e.getDeltaX(m,c);m.parentNode.deltaX=m.deltaX;if(j=this.getValueForNode(d,m.parentNode,e))return l=f[0][1],g[l]=j,[l]}d=0;m=d<k?f[d+1][0]:Infinity;for(var n=l=o=0,q=h.length,t=[],s=0;s<=q;s++)if(j=h.charCodeAt(s),j<128?o+=1:j<
2048?o+=2:j>=55296&&j<=57343?(n+=1,o+=2):o+=3,j=j<=32||j===45,s<q){if(!j){if(n===0)j=this.getValueForWord(c,b,s,s+1,j,a.parentId,e);else if(n===1)continue;else n=0,j=this.getValueForWord(c,b,s-1,s+1,j,a.parentId,e);if(j!==null){for(;l>=m;)d++,m=d<k?f[d+1][0]:Infinity;l=f[d][1]+(l-f[d][0]);g[l]=j;t.push(l)}}l=o}return t}}}function m(a){a.addTextNodeToWordMap=function(a,b,c,d,f,g,e){if((d=b.nodeValue)&&d.trim().length>0)if(f=this.getPositionDataForNode(f,a.parentId,a.index)){for(var h=f.length-1,j=
0,k=j<h?f[j+1][0]:Infinity,l=0,m=0,o=0,l=0,n=d.length,q=[],t=0;t<=n;t++){var s=d.charCodeAt(t);m+=s<128?1:s<2048?2:s>=55296&&s<=57343?2:3;s=s<=32||s===45||s===8212;if(t===n||s){o=this.getValueForWord(c,b,o,t,s,a.parentId,e);if(o!==null){for(;l>=k;)j++,k=j<h?f[j+1][0]:Infinity;l=f[j][1]+(l-f[j][0]);g[l]=o;q.push(l)}o=t+1;l=m}}return q}}}function l(b){b.getValueForWord=function(a,b,c,d,f,g){return d>c?{startOffset:c,endOffset:d,childIndex:b.domChildIndex,fontSize:b.fontSize,dataNid:g}:null};b.getValueForNode=
function(a,b,c){var d=b.getClientRects();if(KindleRendererDeviceSpecific.clientRectsExpire()){for(var f=[],g=0;g<d.length;++g)f.push({top:d[g].top,left:d[g].left,bottom:d[g].bottom,right:d[g].right,width:d[g].width,height:d[g].height});d=f}if(d&&d.length>0){c={rects:c.getTransformedClientRects(d,b)};if(b.tagName==="span")a=h(a,b),c.fontSize=a?parseInt(a.fontSize,10):void 0;c.dataNid=b.getAttribute(q);return c}return null};b.getValueForImage=function(a,b){if(a.getClientRects){var c=a.getClientRects();
if(c&&c.length>0)return c=this.getBoundingAndSelectableRects(a,c,b),{selectableRects:c.selectableRects,rects:c.boundingRects,dataNid:a.getAttribute(q)}}return null};b.getValueForWhitespace=function(a,b,c){b=b.createRange();b.setStart(a,0);b.setEnd(a,a.length);return b.getClientRects?(b=b.getClientRects(),this.getBoundingAndSelectableRects(a,b,c).boundingRects):null};b.getBoundingAndSelectableRects=function(a,b,c){var d=void 0,b=c.getTransformedClientRects(b,a),d=a.hasTextEmphasis||a.isRuby?c.getRectsAdjustedForAnnotationMarks(b,
a.fontSize):b;return{boundingRects:d,selectableRects:b}};b.addBoundsForPosition=function(a,b,c,d,f){var g=b[c];if(g&&g.rects===void 0)f=f||$("["+q+'="'+g.dataNid+'"]',a).contents()[g.childIndex],a=a.createRange(),a.setStart(f,g.startOffset),a.setEnd(f,g.endOffset),(a=a.getClientRects())&&a.length>0&&(a=this.getBoundingAndSelectableRects(f,a,d)),a&&a.boundingRects&&a.boundingRects.length>0?(g.selectableRects=a.selectableRects,g.rects=a.boundingRects):delete b[c]};b.getNextValidPositionIndexInNode=
function(a,b,c,d,f,g){for(var e;e===void 0&&c<b.length;)e=b[c],this.addBoundsForPosition(f,d,e,g,a),e=d[e],++c;return e===void 0?-1:--c};b.addTextNodeToLineRects=function(a,b,c,d,f){if(d.length!==0){var g=a.ownerDocument,h=g.createRange();h.selectNode(a);var k=this.getBoundingAndSelectableRects(a,j(h.getClientRects(),f),f).boundingRects,l=k.length,m=a.fontSize,o=0.25*m;if(l===1)e(b,k[0],d[0],m);else if(l>1){var n;if(d.length===1)for(n=0;n<l;n++)e(b,k[n],d[0],m);else{var q=a.nodeValue.length,t=0;for(n=
0;n<l;++n)t+=f.clientRectWidth(k[n]);var q=t/q,s=t=!1,r=this.getNextValidPositionIndexInNode(a,d,0,c,g,f);if(!(r<0)){var L=r,P=d[L],A=c[P],O=A.endOffset-A.startOffset,P=A.rects.length,J=0;for(n=0;n<l;++n)if(J<P-1)Math.abs(f.clientRectTop(A.rects[J])-f.clientRectTop(k[n]))<o&&(e(b,k[n],d[r],m),++J);else if(J=Math.min(J,P-1),Math.abs(f.clientRectTop(A.rects[J])-f.clientRectTop(k[n]))<o){var G=f.clientRectWidth(k[n]),G=Math.round(G/q);f.clientRectLeft(A.rects[J]);for(f.clientRectLeft(k[n]);L<d.length-
1&&O<G;)++L,A=c[d[L]],O+=A.endOffset-A.startOffset;if(r===L&&(++L,L>=d.length)){e(b,k[n],d[r],m);break}for(h.setStart(a,c[d[r]].startOffset);;)if(h.setEnd(a,c[d[L]].endOffset),A=j(h.getClientRects(),f),A.length>P){if(L<=0)break;--L;if(s)break;t=!0}else if(A.length===P){if(t||L>=d.length-1)break;++L;s=!0}else break;e(b,k[n],d[r],m);if(L>=d.length-1)break;t=s=!1;r=this.getNextValidPositionIndexInNode(a,d,L+1,c,g,f);if(r<0)break;L=r;P=d[L];A=c[P];O=A.endOffset-A.startOffset;P=A.rects.length;J=0;Math.abs(f.clientRectTop(A.rects[0])-
f.clientRectTop(k[n]))<o&&++J}}}}}};b.createBoundsWordMap=function(b,c,d,f,g,e,h){var k=new jQuery.Deferred,j={};d.posMap===void 0||$.isEmptyObject(d.posMap)?this.createWordMapFromElements(b,c,j,f,k):d.posMap!==null?(g={interval:KindleRendererProcessTuning.drawYieldFrequency("WordMapGen"),time:KindleRendererProcessTuning.drawYieldUpdateTime("WordMapGen"),metrics:h||KindleMetricsProfiler("wordMap"),requestId:g,processingRequest:e},this.createWordMapFromNodeList(0,a(b),b,c,d,j,[],f,g,k)):k.resolve(j,
[],[],0);return k.promise()};b.computeAllWordRects=function(a,b,c,d,f,g){function e(){if(f.requestId===f.computingRectsId.id){KindleRendererProcessTuning.startingOperation("WordMapGen");for(var n=0;l<c.length;++l){if((j=b[c[l]])&&j.rects===void 0){if(j.dataNid!==k.dataNid||j.childIndex!==k.childIndex)h=$("["+q+'="'+j.dataNid+'"]',a).contents()[j.childIndex];k=j;m.setStart(h,j.startOffset);m.setEnd(h,j.endOffset);var t=m.getClientRects();t&&t.length>0&&(t=o.getBoundingAndSelectableRects(h,t,d));t&&
t.boundingRects&&t.boundingRects.length>0?(j.selectableRects=t.selectableRects,j.rects=t.boundingRects):delete b[c[l]];++n}if(n>=f.frequency){KindleRendererProcessTuning.endingOperation("WordMapGen",n);setTimeout(e,f.time);return}}KindleRendererProcessTuning.endingOperation("WordMapGen",n)}g.resolve()}var h,k={},j,l=0,m=a.createRange(),o=this;m.getClientRects?e():g.resolve()};b.addImageNodeToWordMap=function(a,b,c,d){d=this.getValueForImage(a,d);if(d!==null&&(a=a.getAttribute(q),a!==null))return b=
b[a],c[b[0][1]]=d,[b[0][1]]};b.createWordMapFromElements=function(a,b,c,d,f){var g=[],g=g.concat(Array.prototype.slice.call(a.getElementsByTagName("IMG"))),g=g.concat(Array.prototype.slice.call(a.getElementsByTagName("CANVAS"))),g=g.concat(Array.prototype.slice.call(a.getElementsByClassName("k4w"))),g=g.concat(Array.prototype.slice.call(a.getElementsByClassName("k4wc"))),a={interval:KindleRendererProcessTuning.drawYieldFrequency("ScreenManager"),time:KindleRendererProcessTuning.drawYieldUpdateTime("ScreenManager")};
this.addElementsToWordMap(b,g,0,a,c,d,f)};b.createWordMapFromNodeList=function(a,b,d,f,g,j,k,l,m,o){function n(){m.requestId===m.processingRequest.id&&q.createWordMapFromNodeList(a+1,b,d,f,g,j,k,l,m,o)}var q=this;KindleRendererProcessTuning.startingOperation("WordMapGen");var t=0,r=b.length,s=null,F=m.numPositionsAdded||0,L=g.wordList&&g.wordList.length;if(L&&!g.imageList)g.imageList=[];for(var P=g.imageList,A,O=m.metrics.createSubTimer("text counters (timeless)");a<r;){var J=b[a],G=j;J.deltaX=l.getDeltaX(J,
d);if(J.nodeType===Node.TEXT_NODE)(A=h(f,J.parentNode))&&A.display==="none"||(c(J,A),s=q.getNodeId(J),s=q.addTextNodeToWordMap(s,J,d,f,g.posMap,j,l),s===void 0?(s=[],G=[{rects:q.getValueForWhitespace(J,d,l)}]):this.addTextNodeToLineRects(J,k,j,s,l,O));else if(J.tagName==="IMG"){if(A=h(f,J),J.fontSize=A?parseInt(A.fontSize,10):0,s=q.addImageNodeToWordMap(J,g.posMap,j,l))e(k,j[s[0]].rects[0],s[0]),L&&P.push(s[0])}else s=q.addRubyNodeToWordMap(J,d,f,g.posMap,j,k,l,O);s&&s.length&&(F+=s.length,KindleRendererContentCorrection.applyNodeLocalCorrections(J,
s,G,f,l,m.metrics));++t;if(t>=m.interval){m.numPositionsAdded=F;KindleRendererProcessTuning.endingOperation("WordMapGen",t);setTimeout(n,m.time);return}++a}r=L?KindleListUtilities.sortedMerge(g.wordList,P):[];delete g.imageList;KindleRendererProcessTuning.endingOperation("WordMapGen",t);o.resolve(j,r,k,F)}}function n(a){a.getValueForWord=function(a,b,c,d,f){return d>c?(a=b.nodeValue,c={text:a.substr(c,f?d-c+1:d-c)},d===a.length&&(c.text+=this.WORD_DELIMITER),c):null};a.findSibling=function(a){return a&&
a.nodeType!==Node.DOCUMENT_NODE?a.nextSibling?a.nextSibling:this.findSibling(a.parentNode):null};a.getValueForNode=function(a,b){if(b.tagName!=="IMG"){var c=b.textContent;if(!/\s/.test(c[c.length-1])){var d=this.findSibling(b);d&&d.className!=="k4w"&&(c+=" ")}return{text:c}}return null};a.getValueForImage=function(){return null};a.WORD_DELIMITER=KindleRendererLanguageOptions.getHasWhitespaceDelimitedWords()?" ":"";a.createTextWordMap=function(a,b){var c=new jQuery.Deferred,d={},g,e,h,j,k;if(b.posMap===
void 0){j=$(a).find("CANVAS,.k4w,.k4wc");j=$.makeArray(j);k=j.length;for(g=0;g<k;g++)h=j[g],e=h.id,h=this.getValueForNode(null,h),h!==null&&(d[e]=h)}else if(b.posMap!==null){j=f(a);k=j.length;for(g=0;g<k;g++)h=j[g],h.nodeType===Node.TEXT_NODE&&(e=this.getNodeId(h),this.addTextNodeToWordMap(e,h,null,null,b.posMap,d))}c.resolve(d);return c.promise()}}function r(a,b){a.createWordMap=function(a,c,d,f,g,e,h){return b.createBoundsWordMap(a,c,d,f,g,e,h)};a.addBoundsForPosition=function(a,c,d,f,g){b.addBoundsForPosition(a,
c,d,f,g)};a.computeWordRects=function(a,c,d,f,g,e,h,j){var k=new jQuery.Deferred;g==="mobi8"&&d&&d.length>0?(g={frequency:KindleRendererProcessTuning.drawYieldFrequency("WordMapGen"),time:KindleRendererProcessTuning.drawYieldUpdateTime("WordMapGen"),requestId:e,computingRectsId:h},b.computeAllWordRects(a,c,d,f,g,k,j)):k.resolve();return k.promise()}}function o(a,b){a.createWordMap=function(a,c){return b.createTextWordMap(a,c)}}var q="data-nid",t=/(?=.*target)(?=.*mag)/i;return{buildWordMapGeneratorForWordBounds:function(){var a=
{},b={};g(a);l(a);r(b,a);KindleRendererLanguageOptions.getHasWhitespaceDelimitedWords()?m(a):k(a);return b},buildWordMapGeneratorForWordText:function(){var a={},b={};g(a);n(a);o(b,a);KindleRendererLanguageOptions.getHasWhitespaceDelimitedWords()?m(a):k(a);return b},countUTF8Bytes:function(a){return d(a)}}}(),KindleRegionAnnotationRenderer=function(){function h(c,b){return c.contentDocument.querySelectorAll("mark[annotationType"+(b?'="'+b.type+'"':"")+"][annotationStart"+(b?'="'+b.start+'"':"")+"]")}
function j(c,b,d){var a,g;if(!c||!b||parseInt(c.id,10)>parseInt(b.id,10)||c.tagName==="MARK"||b.tagName==="MARK")throw"Insertion of <mark> tags failed.";if(c.parentNode===b.parentNode){d=d();a=b.nextSibling;g=c.parentNode;var e=c;do c=e,e=c.nextSibling,g.removeChild(c),d.appendChild(c);while(c!==b);g.insertBefore(d,a)}else KindleRendererUtils.treeDepth(c)>KindleRendererUtils.treeDepth(b)?c.previousElementSibling||KindleRendererUtils.isBlock(c.parentNode)?(a=KindleRendererUtils.previousPositionedNode(c.parentNode),
g=KindleRendererUtils.nextPositionedNode(KindleRendererUtils.followingNode(c.parentNode)),j(c,a,d),j(g,b,d)):j(c.parentNode,b,d):b.nextElementSibling||KindleRendererUtils.isBlock(b.parentNode)?(a=KindleRendererUtils.previousPositionedNode(KindleRendererUtils.precedingNode(b.parentNode)),g=KindleRendererUtils.nextPositionedNode(b.parentNode),j(c,a,d),j(g,b,d)):j(c,b.parentNode,d)}function e(c,b,d){var a=c.contentDocument,c=KindleRendererUtils.findElementAtOrAfterPosition(a,b.start),g=KindleRendererUtils.findElementAtOrBeforePosition(a,
b.end);try{j(c,g,function(){var c=a.createElement("mark");c.className=d;c.setAttribute("annotationType",b.type);c.setAttribute("annotationStart",b.start);return c})}catch(e){}}function d(c,b){for(var d=Array.prototype.slice.call(b),a=0;a<d.length;a++){var g=d[a],e=g.getAttribute("annotationType");if(e==="kindle.highlight"||e==="kindle.search"){for(var e=c.createDocumentFragment(),h=g.firstChild,j;h;)j=h.nextSibling,g.removeChild(h),e.appendChild(h),h=j;h=g.parentNode;j=g.nextSibling;h.removeChild(g);
h.insertBefore(e,j)}else g.parentNode.removeChild(g)}}return{createAnnotationElements:function(c,b){var d;for(d=0;d<b.length;d++){var a=b[d];if(a.type==="kindle.highlight")e(c,a,"highlight");else if(a.type==="kindle.note"){var g=c.contentDocument,j=g.createElement("div");j.className="note-icon";var m=g.createElement("mark");m.className="note";m.setAttribute("annotationType",a.type);m.setAttribute("annotationStart",a.start);m.setAttribute(KindleRendererAnnotationRenderer.ANNOTATION_CLICK_ATTRIBUTE,
"true");m.appendChild(j);a=KindleRendererUtils.findElementAtOrBeforePosition(g,a.start);a.parentNode.insertBefore(m,a.nextSibling)}else a.type==="kindle.search"&&(m=c,h(m,a).length>0||e(m,a,"search-result"))}},removeAnnotationElements:function(c,b){d(c.contentDocument,h(c,b))},removeAllAnnotationElements:function(c){d(c.contentDocument,h(c))}}}(),KindleRegionContentManager=function(){function h(b){if(o||q){if(b<=k)throw{name:"pagingError",message:"Repeating wait request"};k=b;g<0&&a.waitNotification&&
a.waitNotification();g=b}}function j(b){if((o||q)&&g>=0&&g<=b)s=0,g=-1,q&&(o=!0,q=!1),a.readyNotification&&a.readyNotification(),a.rectsReadyNotification&&a.rectsReadyNotification()}function e(b,c,d){g<=b&&(c!==KindleRendererIframeManagerFactory.DATA_LOAD_ERROR&&s<t?(++s,f(d)):(a.errorNotification&&a.errorNotification(c),g=-1))}function d(a){a=l.gotoPosition(a);if(!a){var b=l.getCurrentProcessId();h(b);l.getCurrentProcessDfd().then(function(){j(b)},function(a){e(b,a)})}return a}function c(){try{var a=
l.nextScreen();if(!a){var b=l.getCurrentProcessId();h(b);l.getCurrentProcessDfd().then(function(){c();j(b)},function(a){e(b,a,0)})}return a}catch(d){return KindleDebug.breakPt(),f(),!1}}function b(){try{var a=l.previousScreen();if(!a){var c=l.getCurrentProcessId();h(c);l.getCurrentProcessDfd().then(function(){b();j(c)},function(a){e(c,a,0)})}return a}catch(d){return KindleDebug.breakPt(),f(),!1}}function f(){var a=l.getPagePositionRange();if(a!==null)n=a.currentTopOfPage;l.reloadNotification();d(n)}
var a={},g=-1,k=-1,m=null,l=null,n=0,r,o=!0,q=!1,t=3,s=0;return{initialize:function(b,c,d){m=b;a=c;r=d;n=void 0;l=KindleRendererIframeManagerFactory.build(m);l.setOverlayManager(r);l.setAnnotationEventCallback(a.annotationTriggered)},cleanup:function(){},hide:function(){q=o=!1},show:function(){q=!0},updateSettings:function(a){l.updateSettings(a)},gotoPosition:function(a){return d(a,0)},nextScreen:function(){return c()},previousScreen:function(){return b()},hasNextScreen:function(){return l.hasNextScreen()},
hasPreviousScreen:function(){return l.hasPreviousScreen()},getPagePositionRange:function(){return l.getPagePositionRange()},getSelectableItemBoundaries:function(){return null},getWordPositions:function(){return null},onWindowResize:function(){l.resizeNotification()},handleClick:function(){},reloadAnnotations:function(){l&&l.reloadAnnotations()},getZoomableAt:function(){return null},getZoomableList:function(){return[]},clearSelection:function(){l.clearSelection()},getSelection:function(){return l.getSelection()}}}(),
KindleRegionIframeManager=function(){function h(f){f.cancelCurrentRequest=function(){if(this.currentRequest)this.currentRequest.cancelled=!0,this.currentRequest=null};f.createNewRequest=function(a,b){this.cancelCurrentRequest();this.currentRequest={type:a,requestId:KindleRendererRequestId.getUniqueRequestId(),metrics:KindleMetricsProfiler("renderer-iframe-load"),retryCount:0,initialPosition:b};this.currentRequestDfd=new jQuery.Deferred};f.willRetryCurrentRequest=function(){this.currentRequest&&this.currentRequest.retryCount++};
f.canRetryCurrentRequest=function(){return this.currentRequest?this.currentRequest.retryCount<b:!0};f.calculateIframePaginationData=function(a,b,d){var f=this,e=KindleRendererFragmentLoader.getBookContentType()==="topaz"?f.currentRequest.type?KindleRendererIframePreparation.CANVAS_INSERTION_PREVIOUS:KindleRendererIframePreparation.CANVAS_INSERTION_NEXT:KindleRendererIframePreparation.CANVAS_INSERTION_NONE;KindleRendererIframePreparation.prepareIframe(a,f.currentRequest,b,d,e).then(function(b){if(a.processingRequestId.id===
b.requestId&&f.currentRequest&&f.currentRequest.requestId===b.requestId)a.processingRequestId.id=null,f.frameIsLoadedAndReady(a);f=null},function(a){f.currentRequest&&a&&f.currentRequest.requestId===a.requestId&&f.currentRequestDfd.reject(c);f=null})};f.loadContentDataIntoIframe=function(a){var b=this;b.currentRequest.contentLoadMetrics=b.currentRequest.metrics.createSubTimer("content-load");b.contentRange[this.hiddenIframeIndex]=a.contentRange;var c=this.iframes[this.hiddenIframeIndex];c.processingRequestId.id=
b.currentRequest.requestId;KindleRendererIframeLoading.loadIframe(c,b.currentRequest,a).then(function(f,e){KindleRendererProcessTuning.runAfterYield(KindleRendererDeviceSpecific.yieldTimeAfterIframeLoaded(),f.type,function(){if(c.processingRequestId.id===f.requestId&&b.currentRequest&&b.currentRequest.requestId===f.requestId){b.positionData[b.hiddenIframeIndex]=e.positionData;var h=b.getViewportDimensions(c);b.regionManagers[b.hiddenIframeIndex].computeFilledRegionNodes();b.ensureElementsWillFit(c,
h,b.currentRequest.contentLoadMetrics).then(function(){b.currentRequest.contentLoadMetrics.endTimer();b.calculateIframePaginationData(c,a,e);(KindleHostDeviceDetector.isMetro()||KindleHostDeviceDetector.isIE())&&b.addSelectionListener(c);b=null},function(){b.currentRequest&&b.currentRequestDfd.reject(d);b=null})}else b=null})},function(){b.currentRequest&&b.currentRequestDfd.reject(d)})};f.ensureElementsWillFit=function(a,b,c){a.writingMode.scrollToTopOfDocument(a);a.writingMode.resetHeight(a);var d=
a.contentDocument.getElementsByTagName("body")[0];if(KindleRendererSettings.getSettings().initialExpandedBodyHeight!==void 0){var f=parseInt($(d).css("margin-top"),10),e=parseInt($(d).css("margin-bottom"),10);d.style.height=parseInt(b.height,10)-f-e+"px"}f=d.getElementsByClassName("k4w-margin");for(e=0;e<f.length;e+=1){var h=parseInt(f[e].getAttribute("vertical"),10);if(h>0)f[e].style.marginTop=Math.round(h*0.01*b.height)+"px"}return KindleRendererElementFitting.fitToViewport(d,a.writingMode,b,c)};
f.annotationClickedHandler=function(a){if(this.annotationEventCallback!==void 0){var b=a.currentTarget.parentNode,a=b.getAttribute("annotationType"),b=b.getAttribute("annotationStart");this.annotationEventCallback(a,b)}};f.renderAnnotations=function(a,b){a&&KindleRegionAnnotationRenderer.removeAllAnnotationElements(a);if(this.overlayManager){var c=this.overlayManager.getOverlaysInRange(b.startPosition,b.endPosition);c&&c.length>0&&this.createAnnotationElements(a,c)}};f.frameIsLoadedAndReady=function(a){var b=
this.currentRequest;this.iframeLoadStatus[a.index]=b.type;this.renderAnnotations(a,this.contentRange[a.index]);b&&b.initialPosition!==null&&(this.regionManagers[a.index].updateView(KindleRegionManagerFactory.VIEW_REQUEST.GO_TO_POSITION,{position:b.initialPosition}),a===this.iframes[this.hiddenIframeIndex]&&(this.swapIframes(),this.updateDisplayedPositionsInPage()));b.metrics.addCount("Success",1);b.metrics.endTimer();b.metrics.log();this.currentRequest=null;setTimeout(this.currentRequestDfd.resolve,
10);b.type===this.loadedType.GOTO_POSITION&&this.considerLoadingMoreFragments()};f.loadFragmentsForRange=function(a){var b=this;KindleRendererFragmentLoader.loadFragments(a,b.currentRequest).then(function(a,c){b.currentRequest&&b.currentRequest.requestId===a.requestId&&b.loadContentDataIntoIframe(c);b=null},function(a,c){b.currentRequest&&b.currentRequest.requestId===c.requestId&&b.currentRequestDfd.reject(e);b=null})};f.gotoPosition=function(a){var b=this.iframes[this.visibleIframeIndex];b&&KindleRegionAnnotationRenderer.removeAllAnnotationElements(b);
this.createNewRequest(this.loadedType.GOTO_POSITION,a);a=KindleRendererPositionLoadingCalculator.calculateDesiredFragmentRangeForGoTo(a);if(KindleRendererFragmentLoader.needToLoadFragments(this.contentRange[this.visibleIframeIndex],a))return this.loadFragmentsForRange(a),!1;else this.frameIsLoadedAndReady(this.iframes[this.visibleIframeIndex]);return!0};f.setIframeVisibility=function(a,b){b?this.regionManagers[a].show():this.regionManagers[a].hide()};f.swapIframes=function(){this.iframeLoadStatus[this.visibleIframeIndex]=
this.iframeLoadStatus[this.hiddenIframeIndex]===this.loadedType.NEXT?this.loadedType.PREVIOUS:this.iframeLoadStatus[this.hiddenIframeIndex]===this.loadedType.PREVIOUS?this.loadedType.NEXT:this.loadedType.EMPTY;this.iframeLoadStatus[this.hiddenIframeIndex]=this.loadedType.EMPTY;var a=this.visibleIframeIndex;this.visibleIframeIndex=this.hiddenIframeIndex;this.hiddenIframeIndex=a;this.setIframeVisibility(this.visibleIframeIndex,!0);this.setIframeVisibility(this.hiddenIframeIndex,!1)};f.getPagePositionRange=
function(){return this.regionManagers[this.visibleIframeIndex].getPagePositionRange()};f.reloadAnnotations=function(){this.renderAnnotations(this.iframes[this.visibleIframeIndex],this.contentRange[this.visibleIframeIndex]);this.iframes[this.hiddenIframeIndex]!==null&&this.iframeLoadStatus[this.hiddenIframeIndex]!==this.loadedType.EMPTY&&this.renderAnnotations(this.iframes[this.hiddenIframeIndex],this.contentRange[this.hiddenIframeIndex])};f.loadNextPages=function(){if(this.iframeLoadStatus[this.hiddenIframeIndex]!==
this.loadedType.NEXT&&(this.currentRequest===null||this.currentRequest.type!==this.loadedType.NEXT)){var a=this.contentRange[this.visibleIframeIndex].endPosition+1,b=this.getPagePositionRange(),a=KindleRendererPositionLoadingCalculator.calculateDesiredFragmentRangeForPageFlip(a,b);this.createNewRequest(this.loadedType.NEXT,null);this.loadFragmentsForRange(a)}};f.loadPreviousPages=function(){if(this.iframeLoadStatus[this.hiddenIframeIndex]!==this.loadedType.PREVIOUS&&(this.currentRequest===null||this.currentRequest.type!==
this.loadedType.PREVIOUS)){var a=this.contentRange[this.visibleIframeIndex].startPosition-1,b=this.getPagePositionRange(),a=KindleRendererPositionLoadingCalculator.calculateDesiredFragmentRangeForPageFlip(a,b);this.createNewRequest(this.loadedType.PREVIOUS,null);this.loadFragmentsForRange(a)}};f.considerLoadingMoreFragments=function(a){if(this.canPreloadNext){var b=a!==this.direction.PREVIOUS?4:2;if(this.getApproximateNumNextScreens()<b&&this.hasMoreNextFragments()){this.loadNextPages();return}}this.canPreloadPrevious&&
(a=a===this.direction.PREVIOUS?4:2,this.getApproximateNumPrevScreens()<a&&this.hasMorePreviousFragments()&&this.loadPreviousPages())};f.crossSkeletonBoundary=function(){var a=this.contentRange[this.visibleIframeIndex],b=this.contentRange[this.hiddenIframeIndex];if(this.iframeLoadStatus[this.hiddenIframeIndex]===this.loadedType.NEXT)if(a.skeletonId+1===b.skeletonId)return this.swapIframes(),!0;else if(a.skeletonId!==b.skeletonId)return this.iframeLoadStatus[this.hiddenIframeIndex]=this.loadedType.EMPTY,
!1;if(this.iframeLoadStatus[this.hiddenIframeIndex]===this.loadedType.PREVIOUS)if(a.skeletonId-1===b.skeletonId)return this.swapIframes(),!0;else if(a.skeletonId!==b.skeletonId)this.iframeLoadStatus[this.hiddenIframeIndex]=this.loadedType.EMPTY;return!1};f.cleanup=function(){this.cancelCurrentRequest();KindleRendererIframeLoading.cleanupIframe(this.iframes[this.visibleIframeIndex]);KindleRendererIframeLoading.cleanupIframe(this.iframes[this.hiddenIframeIndex]);this.setOverlayManager(null);this.contentRange=
[null,null];this.positionData=[null,null];this.iframes=null};f.hasMoreNextFragments=function(){return this.contentRange[this.visibleIframeIndex].endPosition!==KindleRendererFragmentLoader.getMaximumPosition()};f.hasMorePreviousFragments=function(){return this.contentRange[this.visibleIframeIndex].startPosition!==KindleRendererFragmentLoader.getMinimumPosition()};f.isAtEndOfDocumentOrSkeleton=function(){var a=this.contentRange[this.visibleIframeIndex];return KindleRendererFragmentLoader.isPositionAtEndOfSkeletonOrDocument(a.skeletonId,
a.endPosition)};f.isAtBeginningOfDocumentOrSkeleton=function(){var a=this.contentRange[this.visibleIframeIndex];return KindleRendererFragmentLoader.isPositionAtBeginningOfSkeletonOrDocument(a.skeletonId,a.startPosition)};f.getApproximateNumNextScreens=function(){return this.regionManagers[this.visibleIframeIndex].getApproximateNumNextScreens(this.isAtEndOfDocumentOrSkeleton())};f.getApproximateNumPrevScreens=function(){return this.regionManagers[this.visibleIframeIndex].getApproximateNumPrevScreens(this.isAtBeginningOfDocumentOrSkeleton())};
f.hasNextScreen=function(){return this.regionManagers[this.visibleIframeIndex].hasNextScreen(this.isAtEndOfDocumentOrSkeleton())||this.hasMoreNextFragments()};f.hasPreviousScreen=function(){return this.regionManagers[this.visibleIframeIndex].hasPreviousScreen(this.isAtBeginningOfDocumentOrSkeleton())||this.hasMorePreviousFragments()};f.updateDisplayedPositionsInPage=function(){var a=this.getPagePositionRange();KindleRendererPositionLoadingCalculator.updateDisplayedPositionRange(a.currentBottomOfPage-
a.currentTopOfPage)};f.considerFlippingFrames=function(){var a=this.iframeLoadStatus[this.hiddenIframeIndex];if(a!==this.loadedType.EMPTY){var b=this.getPagePositionRange(),c=this.contentRange[this.hiddenIframeIndex],d=0,f=0;a===this.loadedType.NEXT?f=1:d=1;if(b.currentTopOfPage>=c.startPosition+d&&b.currentBottomOfPage<=c.endPosition-f){b=this.regionManagers[this.hiddenIframeIndex];c=this.regionManagers[this.visibleIframeIndex].getPagePositionRange();if(a===this.loadedType.NEXT){if(a={position:c.currentBottomOfPage,
allowPartialScreen:this.isAtEndOfDocumentOrSkeleton()},a=b.updateView(KindleRegionManagerFactory.VIEW_REQUEST.NEXT_PAGE,a),!a)return this.requestMoreNextPages(),!1}else if(a={position:c.currentTopOfPage,allowPartialScreen:this.isAtBeginningOfDocumentOrSkeleton()},a=b.updateView(KindleRegionManagerFactory.VIEW_REQUEST.PREVIOUS_PAGE,a),!a)return this.requestMorePreviousPages(),!1;this.swapIframes();return!0}}return!1};f.nextScreen=function(){var a=this.iframeLoadStatus[this.hiddenIframeIndex]===this.loadedType.NEXT;
if(a&&this.considerFlippingFrames())return!0;var b=this.isAtEndOfDocumentOrSkeleton(),c=this.regionManagers[this.visibleIframeIndex].nextScreen(b);if(!c)if(this.hasMoreNextFragments())if(a&&b&&this.crossSkeletonBoundary())c=!0;else return this.requestMoreNextPages(),!1;else c=!0;this.considerLoadingMoreFragments(this.direction.NEXT);this.updateDisplayedPositionsInPage();KindleDebug.log("Next Screen Success:"+c);return c};f.requestMoreNextPages=function(){var a=this.getPagePositionRange(),b=this.contentRange[this.visibleIframeIndex];
a.currentBottomOfPage&&KindleRendererPositionLoadingCalculator.updateDisplayedPositionRange(b.endPosition-a.currentBottomOfPage);this.iframeLoadStatus[this.hiddenIframeIndex]=this.loadedType.EMPTY;this.loadNextPages()};f.requestMorePreviousPages=function(){var a=this.getPagePositionRange(),b=this.contentRange[this.visibleIframeIndex];a.currentTopOfPage&&KindleRendererPositionLoadingCalculator.updateDisplayedPositionRange(a.currentTopOfPage-b.startPosition);this.iframeLoadStatus[this.hiddenIframeIndex]=
this.loadedType.EMPTY;this.loadPreviousPages()};f.previousScreen=function(){KindleDebug.log("****Prev screen****");if(this.iframeLoadStatus[this.hiddenIframeIndex]===this.loadedType.PREVIOUS&&this.considerFlippingFrames())return!0;var a=this.isAtBeginningOfDocumentOrSkeleton(),b=this.regionManagers[this.visibleIframeIndex].previousScreen(a);if(!b&&this.hasMorePreviousFragments())if(a&&this.crossSkeletonBoundary())b=!0;else return this.requestMorePreviousPages(),!1;else!b&&!this.hasMorePreviousFragments()&&
KindleDebug.error("PreviousScreen: Was not able to go to previous screen, and there is no more previous fragments.");this.considerLoadingMoreFragments(this.direction.PREVIOUS);this.updateDisplayedPositionsInPage();return b};f.cancelHiddenIframeLoading=function(){var a=this.iframes[this.hiddenIframeIndex];if(a.processingRequestId.id!==null)a.processingRequestId.id=null,this.cancelCurrentRequest()};f.scaleElementsInIframe=function(a){var b=this.getViewportDimensions(a);if(a&&a.contentDocument&&a.contentDocument.body){a.writingMode=
KindleRendererWritingModeFactory.buildIFrameWritingMode(a);a.writingMode.resetIframeDimensions(a);var c;c=this.currentRequest&&this.currentRequest.contentLoadMetrics?this.currentRequest.contentLoadMetrics:KindleMetricsProfiler("content-load");this.ensureElementsWillFit(a,b,c).then(function(){c.endTimer()})}};f.getViewportDimensions=function(a){var b=$(this.parent).width(),c=this.numColumns-1,d=this.getMargins(this.margin),c=parseInt((b-(this.columnGap-(d.left+d.right))*c)/this.numColumns,10);return{height:$(a).parent().height(),
width:c,parentWidth:b}};f.updateSettings=function(a){var b=this.visibleIframeIndex,c=this.hiddenIframeIndex,d=this.getPagePositionRange().currentTopOfPage;if(a.columns!==void 0){if(a.columns.num!==void 0){this.numColumns=a.columns.num;this.regionManagers[b].computeFilledRegionNodes();this.scaleElementsInIframe(this.iframes[b]);var f=this;setTimeout(function(){f.regionManagers[c].computeFilledRegionNodes();f.scaleElementsInIframe(f.iframes[c]);f=null},0)}if(a.columns.gap!==void 0)this.columnGap=parseInt(a.columns.gap,
10)}if(a.margin!==void 0)this.margin=a.margin;KindleRendererIframeLoading.updateSettingsInIframe(this.iframes[b]);var e=this;setTimeout(function(){KindleRendererIframeLoading.updateSettingsInIframe(e.iframes[c]);e=null},0);d&&(this.regionManagers[b].updateView(KindleRegionManagerFactory.VIEW_REQUEST.GO_TO_POSITION,{position:d}),this.updateDisplayedPositionsInPage())};f.getMargins=function(a){if(this.parent&&a&&a.length>0){var b=document.getElementById("renderer_translation_div");if(!b)b=document.createElement("div"),
b.id="renderer_translation_div",$(b).css({visibility:"hidden","z-index":-1E3}),this.parent.appendChild(b);$(b).css({margin:a});a=window.getComputedStyle(b);return{top:parseFloat(a.marginTop),bottom:parseFloat(a.marginBottom),left:parseFloat(a.marginLeft),right:parseFloat(a.marginRight)}}return{top:0,bottom:0,left:0,right:0}};f.reloadNotification=function(){this.contentRange=[null,null];this.positionData=[null,null];this.cancelHiddenIframeLoading();this.iframeLoadStatus=[this.loadedType.EMPTY,this.loadedType.EMPTY]};
f.resizeNotification=function(){var a=this.getPagePositionRange();this.regionManagers[this.visibleIframeIndex].updateView(KindleRegionManagerFactory.VIEW_REQUEST.GO_TO_POSITION,{position:a.currentTopOfPage});this.updateDisplayedPositionsInPage()};f.updateGlyphColorForFrameIndex=function(a){this.iframes[a].hasGlyphs&&this.iframes[a].contentDocument&&KindleGlyphRenderer.updateTextColor(this.iframes[a])};f.updateGlyphColor=function(){this.updateGlyphColorForFrameIndex(this.visibleIframeIndex);this.updateGlyphColorForFrameIndex(this.hiddenIframeIndex)};
f.setAnnotationEventCallback=function(a){this.annotationEventCallback=a};f.getCurrentProcessDfd=function(){return this.currentRequestDfd.promise()};f.getCurrentProcessId=function(){return this.currentRequest.requestId};f.getZoomableAt=function(a,b,c){return KindleRendererZoomablesFactory.buildFromCoord(this.iframes[this.visibleIframeIndex].contentDocument,a,b,c)};f.getZoomableList=function(a){return KindleRendererZoomablesFactory.buildList(this.iframes[this.visibleIframeIndex].contentDocument,a)};
f.addClickHandlers=function(a){var b=this,a=$("mark["+KindleRendererAnnotationRenderer.ANNOTATION_CLICK_ATTRIBUTE+"='true']",a.contentDocument).children();$(a).unbind("click");$(a).click(function(a){b.annotationClickedHandler(a)})};f.createAnnotationElements=function(a,b){KindleRegionAnnotationRenderer.createAnnotationElements(a,b);this.addClickHandlers(a)};f.addAnnotation=function(a,b,c){a&&b&&c&&b.startPosition<=c.end&&c.start<=b.endPosition&&this.createAnnotationElements(a,[c])};f.removeAnnotation=
function(a,b){a&&b&&KindleRegionAnnotationRenderer.removeAnnotationElements(a,b)};f.onOverlayAdded=function(a){f.addAnnotation(f.iframes[0],f.contentRange[0],a.overlay);f.addAnnotation(f.iframes[1],f.contentRange[1],a.overlay)};f.onOverlayRemoved=function(a){f.removeAnnotation(f.iframes[0],a.overlay);f.removeAnnotation(f.iframes[1],a.overlay)};f.setOverlayManager=function(a){this.overlayManager&&(this.overlayManager.removeEventListener(this.overlayManager.OVERLAY_ADDED_EVENT,this.onOverlayAdded),
this.overlayManager.removeEventListener(this.overlayManager.OVERLAY_REMOVED_EVENT,this.onOverlayRemoved));if(this.overlayManager=a)this.overlayManager.addEventListener(this.overlayManager.OVERLAY_ADDED_EVENT,this.onOverlayAdded),this.overlayManager.addEventListener(this.overlayManager.OVERLAY_REMOVED_EVENT,this.onOverlayRemoved)};f.setCanPreloadNext=function(a){this.canPreloadNext=a};f.setCanPreloadPrevious=function(a){this.canPreloadPrevious=a};f.clearSelection=function(){var a=this.iframes[this.visibleIframeIndex].contentWindow;
if(this.selection)this.selection.select(),this.selection=null;a.window.getSelection&&(a.window.getSelection().empty?a.window.getSelection.empty():a.window.getSelection().removeAllRanges&&a.window.getSelection().removeAllRanges());a.document.selection&&a.document.selection.empty&&a.document.selection.empty()};f.getSelection=function(){var a=this.iframes[this.visibleIframeIndex].contentWindow,b=null,b=KindleHostDeviceDetector.getDevicePlatform(),c=null,d=this.selection;d&&d.select();if((b==="metro"||
b==="metroArm"||KindleHostDeviceDetector.isIE())&&a.document.selection)b=a.document.selection,c=this.createSelectionForIE(b);return c};f.createSelectionForIE=function(a){var b=KindleRendererDeviceSpecific.resolutionScale(),c=this.regionManagers[this.visibleIframeIndex].getOffsetTop()*b,a=a.createRange(),d=a.getClientRects(),f=d[d.length-1].width?d[d.length-1]:d[d.length-2],d=d[0],e={},h=null;a.text.indexOf(" ")!==0&&a.expand("word");e.context=a.text;h=document.createElement("div");h.innerHTML=a.htmlText;
h=this.getSelectionBoundaries(h);e.start=parseInt(h.start,10);e.end=parseInt(h.end,10);e.lowerBounds={};e.lowerBounds.right=f.right/b;e.lowerBounds.bottom=(f.bottom-c)/b;e.lowerBounds.left=f.left/b;e.lowerBounds.top=(f.top-c)/b;e.lowerBounds.width=f.width/b;e.lowerBounds.height=f.height/b;e.upperBounds={};e.upperBounds.left=d.left/b;e.upperBounds.top=(d.top-c)/b;e.upperBounds.right=d.right/b;e.upperBounds.bottom=(d.bottom-c)/b;e.upperBounds.width=d.width/b;e.upperBounds.height=d.height/b;return e};
f.getSelectionBoundaries=function(a){var b=[],c={},b=a.getElementsByTagName("canvas");if(b.length!==0)c.start=b[0].id,c.end=b[b.length-1].id;else if(b=a.getElementsByTagName("span"),b.length!==0){for(a=0;isNaN(b[a].id);)a++;c.start=b[a].id;for(a=1;isNaN(b[b.length-a].id);)a++;c.end=b[b.length-a].id}return c};f.addSelectionListener=function(a){function b(c){if(c.type==="MSPointerDown")f.addPointer(c.pointerId);else if(c.type==="MSGestureTap"&&a.contentWindow.document.selection.type==="Text")d.selection=
null}var c=a.contentDocument.getElementsByTagName("body")[0],d=this;c.onselect=function(b){var c=a.contentWindow.document.selection;if(c&&c.type==="Text"){if(c=c.createRange(),!d.selection||!c.isEqual(d.selection))d.selection=c,c=a.ownerDocument.createEvent("CustomEvent"),c.initCustomEvent(b.type,!0,!0,b),a.dispatchEvent(c)}else d.selection=null};a.contentDocument.onselectionchange=function(b){var c=a.contentWindow.document.selection;if(c&&c.type==="Text"&&(c=c.createRange(),d.selection&&!c.isEqual(d.selection)))d.selection=
null,c=a.ownerDocument.createEvent("CustomEvent"),c.initCustomEvent(b.type,!0,!0,b),a.dispatchEvent(c)};c.onselectstart=function(b){var c=a.contentWindow.document.selection;if(c&&c.type==="None"&&d.selection)d.selection=null,b.preventDefault()};c.ondblclick=function(b){d.selection=null;var c=a.ownerDocument.createEvent("MouseEvent");c.initMouseEvent(b.type,!0,!0,window.parent,b.detail,b.screenX,b.screenY,b.clientX,b.clientY,b.ctrlKey,b.altKey,b.shiftKey,b.metaKey,b.button,null);a.dispatchEvent(c)};
if(window.MSGesture){var f=new MSGesture;f.target=c;c.addEventListener("MSGestureTap",b,!1);c.addEventListener("MSPointerDown",b,!1)}}}var j=0,e=j++,d=j++,c=j++,b=5;return{DATA_LOAD_ERROR:e,IFRAME_ERROR_LOADING:d,IFRAME_ERROR_PAGINATING:c,build:function(b,a){for(var c=[],d=[],e=0;e<2;e+=1){var j,n=e,r=a;j=document.createElement("iframe");var o="flow_"+n;j.index=n;j.processingRequestId={};j.setAttribute("frameBorder","0");j.setAttribute("id","frame_"+n);j.setAttribute("name","book_iframe_"+n);j.setAttribute("scrolling",
"no");j.style.msFlowInto=o;$(j).css({msFlowInto:o,position:"absolute",top:"0px",left:"0px",display:"none"});n=KindleRegionManagerFactory.build(j,o,r);j={iframe:j,regionManager:n};c[e]=j.iframe;d[e]=j.regionManager;a.appendChild(c[e])}b.loadedType={EMPTY:0,GOTO_POSITION:1,NEXT:2,PREVIOUS:3};b.direction={NEXT:2,PREVIOUS:3};b.iframes=c;b.regionManagers=d;b.iframeLoadStatus=[b.loadedType.EMPTY,b.loadedType.EMPTY];b.contentRange=[null,null];b.positionData=[null,null];b.visibleIframeIndex=0;b.hiddenIframeIndex=
1;b.overlayManager=null;b.numColumns=1;b.columnGap=20;b.margin=0;b.parent=a;b.selection=null;h(b)}}}();
function KindleRegionNodeFactory(h){var j=null,e=null,d=null,c=null;return{show:function(){h.style.left="0px"},hide:function(){h.style.left="-9999px"},setPagePositionRange:function(b,c){j=b;e=c},getPagePositionRange:function(){return{topOfPagePosition:j,bottomOfPagePosition:e}},setNumPageBreaks:function(b){d=b},getNumPageBreaks:function(){return d},getRegionContent:function(){return h.msGetRegionContent()},getRegionOverflow:function(){return c=h.msRegionOverflow},getCachedRegionOverflow:function(){return c},
getHeight:function(){return h.clientHeight}}}
function KindleRegionPageBreakPivot(h){var j,e;return{insert:function(d){if(!j){var c=h.contentDocument.createElement("div");c.className="renderer-page-break";for(var b=h.contentWindow.document.getElementById(d);!b.previousSibling&&!KindleRendererUtils.isBlock(b)&&b.parentNode.tagName!=="BODY";)b=b.parentNode;h.contentWindow.document.body.firstElementChild!==b&&(b.parentNode.insertBefore(c,b),e=d,j=c)}},clear:function(){var d=h.contentDocument.getElementsByClassName("renderer-page-break");d&&d.length>
0&&d[0].parentNode.removeChild(d[0]);e=j=null},getPosition:function(){return e}}}
var KindleRegionManagerFactory=function(){function h(b){b.updateView=function(b,a){var c,d=!1,h=a.position,j=a.allowPartialScreen;switch(b){case e.NEXT_PAGE:c=this.findPositionAfter(h);break;case e.PREVIOUS_PAGE:c=this.findPositionBefore(h);if(KindleRendererUtils.isNumeric(c))return this.showPreviousPage(c,j);break;case e.GO_TO_POSITION:this.computeFilledRegionNodes(),c=this.findPositionForGoTo(h)}KindleRendererUtils.isNumeric(c)&&(d=this.showPositionAtStart(c));return d};b.createDocumentFragmentWithRegions=
function(b){for(var a=document.createDocumentFragment(),c=0;c<b;c++){var d=document.createElement("div");$(d).css({msFlowFrom:this.flowName,position:"absolute",top:"0px",left:"-9999px",width:"100%",height:"100%","z-index":"100"});a.appendChild(d)}return a};b.computeFilledRegionNodes=function(){function b(a){for(var c=[],d=0;d<a.length;d++)c.push(KindleRegionNodeFactory(a[d]));return c}var a=this.regions,c;this.regionCount===-1&&(a=this.createDocumentFragmentWithRegions(KindleRendererDeviceSpecific.defaultNumRegions()),
this.container.appendChild(a),a=b(this.container.children),a=Array.prototype.slice.call(a));for(c=a[a.length-1].getRegionOverflow();c==="overflow"||c==="fit";)a=this.createDocumentFragmentWithRegions(a.length/4),this.container.appendChild(a),a=b(this.container.children),a=Array.prototype.slice.call(a),c=a[a.length-1].getRegionOverflow();for(var d=0;d<a.length;d++)if(c=a[d].getRegionOverflow(),c==="empty"){this.regionCount=d;break}this.regions=a};b.getRegionWithPosition=function(b){for(var a=this.regions,
c,d=0;d<this.regionCount;d++)if(c=a[d].getPagePositionRange(),b>=c.topOfPagePosition&&b<=c.bottomOfPagePosition)return d;return null};b.showRegionWithPosition=function(b){var a=this.indexVisible,b=this.getRegionWithPosition(b);return b!==null?(this.hideRegion(a),this.showRegion(b),!0):!1};b.showRegion=function(b){var a=this.regions;return b!==null&&b>=0&&b<this.regionCount?(a[b].show(),this.indexVisible=b,!0):!1};b.hideRegion=function(b){var a=this.regions;return b!==null&&b>=0&&b<a.length?(a[b].hide(),
!0):!1};b.findPositionBefore=function(b){return this.findNearestPosition(b,this.DIRECTION.PREV)};b.findPositionAfter=function(b){return this.findNearestPosition(b,this.DIRECTION.NEXT)};b.findNearestPosition=function(b,a){function c(){for(var g=e.iframe.contentWindow.document.querySelectorAll(d),h=null,j=Infinity,o=0;o<g.length;o++){var m=parseInt(g[o].id,10)-b;!(a===e.DIRECTION.PREV&&m>0)&&!(a===e.DIRECTION.NEXT&&m<0)&&(m=Math.abs(m),m>0&&m<j&&(j=m,h=g[o]))}return h}var e=this,h=null,h=(h=this.iframe.contentWindow.document.getElementById(b))?
a===this.DIRECTION.PREV?KindleRendererUtils.previousPositionedNode(h):a===this.DIRECTION.NEXT?KindleRendererUtils.nextPositionedNode(h):KindleRendererUtils.nextPositionedNode(h)||KindleRendererUtils.previousPositionedNode(h):c(),e=null;return h?parseInt(h.id,10):null};b.showPositionAtStart=function(b){return(b=this.iframe.contentWindow.document.getElementById(b))?(this.pageBreakPivot.clear(),this.pageBreakPivot.insert(b.id),this.computeFilledRegionNodes(),this.computePaginationData(),this.showRegionWithPosition(b.id)):
!1};b.fixPaginationDataHack=function(b,a){if(a>1){var c,d;for(c=0;c<a-1;c++){var e=b[c].getPagePositionRange();if(e.topOfPagePosition!==null)for(d=c+1;d<a;d++){var h=b[d].getPagePositionRange();if(h.topOfPagePosition!==null&&h.bottomOfPagePosition!==null){d=e.topOfPagePosition===h.topOfPagePosition?e.topOfPagePosition:h.topOfPagePosition-1;b[c].setPagePositionRange(e.topOfPagePosition,d);break}}}c=0;for(e=1;e<a;e++)c+=b[e].getNumPageBreaks();b[0].setNumPageBreaks(b[0].getNumPageBreaks()-c)}};b.computePaginationData=
function(){for(var b=this.regions,a=this.regionCount,e=0;e<a;e++){for(var h=b[e],j=h.getRegionContent(),l=[],n=[],r=[],o,q=null,t=null,s=0;s<j.length;s++)r[s]=j[s].cloneContents().querySelectorAll(d),l=l.concat(Array.prototype.slice.call(r[s])),o=j[s].cloneContents().querySelectorAll(c),n=n.concat(Array.prototype.slice.call(o));l.length&&(q=parseInt(l[0].id,10),t=parseInt(l[l.length-1].id,10));h.setPagePositionRange(q,t);h.setNumPageBreaks(n.length)}this.fixPaginationDataHack(b,a)};b.cleanUp=function(){$(this.container).empty();
this.regions=[]};b.getPagePositionRange=function(){var b={},a=this.regions,c=this.indexVisible;a&&c!==null&&(b=a[c].getPagePositionRange(),b={currentTopOfPage:b.topOfPagePosition?b.topOfPagePosition:0,currentBottomOfPage:b.bottomOfPagePosition?b.bottomOfPagePosition:0});return b};b.findNextScreen=function(b,a){for(var c=(KindleRendererUtils.isNumeric(a)?a:this.indexVisible)+1;c<this.regionCount;){var d=this.regions[c].getPagePositionRange();if(d.topOfPagePosition!==null||d.bottomOfPagePosition!==
null){if(b)return c;if(this.findPositionAfter(d.bottomOfPagePosition)===null){for(d=this.iframe.contentWindow.document.getElementById(d.bottomOfPagePosition);d.parentNode&&d.parentNode.tagName!=="BODY";)d=d.parentNode;for(;d.nextSibling;){if(d.nextSibling.nodeName==="DIV"&&d.nextSibling.id!=="content-overlays")return null;d=d.nextSibling}}return c}c++}return null};b.findPreviousScreen=function(b,a){for(var c=(KindleRendererUtils.isNumeric(a)?a:this.indexVisible)-1;c>=0;){var d=this.regions[c].getPagePositionRange();
if(d.topOfPagePosition!==null||d.bottomOfPagePosition!==null){if(b)return c;if(this.findPositionBefore(d.topOfPagePosition)===null){for(d=this.iframe.contentWindow.document.getElementById(d.topOfPagePosition);d.parentNode&&d.parentNode.tagName!=="BODY";)d=d.parentNode;for(;d.previousSibling;){if(d.previousSibling.nodeName==="DIV"&&d.previousSibling.id!=="content-overlays")return null;d=d.previousSibling}}return c}c--}return null};b.hasNextScreen=function(b){return this.findNextScreen(b)!==null};b.hasPreviousScreen=
function(b){return this.findPreviousScreen(b)!==null};b.nextScreen=function(b){var a=!0,a=this.regions,c=this.indexVisible,d=this.findNextScreen(b);this.hideRegion(c);d===null||a[d].getCachedRegionOverflow()!=="overflow"&&!b?(a=!1,KindleDebug.log("NextScreen: No more next screens to show.")):a=this.showRegion(d);return a};b.previousScreen=function(b){var a=!0,c=this.regions,d=this.indexVisible,e=this.findPreviousScreen(b);this.hideRegion(d);if(e===null||c[e].getCachedRegionOverflow()!=="overflow"&&
!b)a=!1,KindleDebug.log("PreviousScreen: No more previous screens to show.");else{if((c=this.pageBreakPivot.getPosition())&&this.getRegionWithPosition(c)-1===e)if(c=this.findPositionBefore(this.getPagePositionRange().currentTopOfPage),KindleRendererUtils.isNumeric(c))return this.showPreviousPage(c,b);else if(b&&e===0)return KindleDebug.log("PreviousScreen: Could not find a position before to show. Assuming it is a cover."),this.pageBreakPivot.clear(),this.computeFilledRegionNodes(),this.computePaginationData(),
this.showRegion(e);wasAbleToGoToNextScreen=this.showRegion(e)}return a};b.getNumColumns=function(){return parseInt(this.iframe.contentWindow.document.body.currentStyle.columnCount,10)};b.showPreviousPage=function(b,a){this.pageBreakPivot.clear();this.computeFilledRegionNodes();this.computePaginationData();var e=this.getRegionWithPosition(b),h=this.regions[e],j=this.getBoundingClientRect(this.iframe.contentWindow.document.getElementById(b)),l=this.container.getBoundingClientRect();if(h.getNumPageBreaks()>
0||h.getPagePositionRange().bottomOfPagePosition===b)return this.showRegionWithPosition(b),!0;var n=this.getNumColumns(),h=j.bottom,r=l.width/n,o=null;if(h-l.top<j.height)return!0;if(n>1)for(l=1;l<=n;l++)if(j.left<r*l){o={start:r*(l-1),end:r*l};break}n=this.findPreviousScreen(a,e);if(n===null)a&&this.showRegionWithPosition(b);else{e=this.regions[n].getRegionContent();if(e.length>0){e=e[0].cloneContents().querySelectorAll(d+","+c);j=null;for(r=l=0;r!==this.regions[n].getNumPageBreaks();){var q=$(e[l]);
(q.hasClass("page-break")||q.hasClass("pagebreak"))&&r++;l++}for(;l<e.length;l++)if(n=this.iframe.contentWindow.document.getElementById(e[l].id),r=this.getBoundingClientRect(n),q=o?r.left>o.start&&r.left<o.end:!0,r.top>h&&q){j=n;break}j&&(this.pageBreakPivot.insert(j.id),this.computeFilledRegionNodes(),this.computePaginationData())}this.showRegionWithPosition(b);return!0}return!1};b.getBoundingClientRect=function(b){var b=b.getBoundingClientRect(),a=KindleRendererDeviceSpecific.resolutionScale();
return{height:b.height/a,width:b.width/a,left:b.left/a,right:b.right/a,top:(b.top%this.container.clientHeight+this.container.getBoundingClientRect().top)/a,bottom:(b.bottom%this.container.clientHeight+this.container.getBoundingClientRect().top)/a}};b.show=function(){this.container.style.left="0px"};b.hide=function(){this.container.style.left="-9999px"};b.getApproximateNumNextScreens=function(b){for(var a=0,c=this.findNextScreen(b,this.indexVisible);c!==null&&c<this.regionCount;)c=this.findNextScreen(b,
c+1),a++;KindleDebug.log("getApproximateNumNextScreens: # of next screens left:"+a);return a};b.getApproximateNumPrevScreens=function(b){for(var a=0,c=this.findPreviousScreen(b,this.indexVisible);c!==null&&c>0;)c=this.findPreviousScreen(b,c-1),a++;KindleDebug.log("getApproximateNumPrevScreens: # of prev screens left:"+a);return a};b.getOffsetTop=function(){return this.regions[this.indexVisible].getHeight()*this.indexVisible};b.findPositionForGoTo=function(b){function a(a){for(var b=a,c=parseInt(b.id,
10),a=a.getClientRects()[0].top;b;)if((b=KindleRendererUtils.previousPositionedNode(b))&&b.getClientRects()[0].top===a)c=parseInt(b.id,10);else break;return c}var c=this.iframe,d=c.contentDocument.getElementById(b);if(!d){var e=this.findPositionAfter(b)||this.findPositionBefore(b);e&&(d=c.contentWindow.document.getElementById(e))}return d?a(d):b}}function j(b){b.nextScreen=function(b){return this.internal.nextScreen(b)};b.previousScreen=function(b){return this.internal.previousScreen(b)};b.hasNextScreen=
function(b){return this.internal.hasNextScreen(b)};b.hasPreviousScreen=function(b){return this.internal.hasPreviousScreen(b)};b.getPagePositionRange=function(){return this.internal.getPagePositionRange()};b.cleanup=function(){this.internal.cleanup()};b.show=function(){this.internal.show()};b.hide=function(){this.internal.hide()};b.updateView=function(b,a){return this.internal.updateView(b,a)};b.getApproximateNumNextScreens=function(b){return this.internal.getApproximateNumNextScreens(b)};b.getApproximateNumPrevScreens=
function(b){return this.internal.getApproximateNumPrevScreens(b)};b.getOffsetTop=function(){return this.internal.getOffsetTop()};b.computeFilledRegionNodes=function(){this.internal.computeFilledRegionNodes()}}var e={GO_TO_POSITION:1,NEXT_PAGE:2,PREVIOUS_PAGE:3},d="span.k4w, canvas.k4wc, img",c=".page-break, .pagebreak";return{VIEW_REQUEST:e,build:function(b,c,a){var d={internal:{}};d.internal.DIRECTION={NEXT:"next",PREV:"prev"};var e=d.internal,m=document.createElement("div");m.id="container_"+c;
$(m).css({position:"absolute",top:"0px",left:"0px",height:"100%",width:"100%"});a.appendChild(m);e.iframe=b;e.flowName=c;e.parent=a;e.container=m;e.regions=[];e.regionCount=-1;e.indexVisible=null;e.pageBreakPivot=KindleRegionPageBreakPivot(b);h(d.internal);j(d);return d}}}(),KindleRendererDeviceSpecific=function(){var h={};return{initialize:function(){var j=KindleHostDeviceDetector.getDevicePlatform();if(j==="desktop"){h.fragmentBufferCapacityForGoTo=2;h.fragmentBufferCapacityForPageFlip=10;h.fragmentBufferCapacityForPageFlipGlyphs=
3;h.drawYieldUpdateTime=25;h.drawYieldScreenManagerFrequency=5E3;h.drawYieldGlyphRendereringFrequency=1E3;h.drawYieldWordMapGenFrequency=5E3;h.drawYieldWordMapGenUpdateTime=25;h.drawYieldHeightMapFrequency=5E3;h.drawYieldHeightMapUpdateTime=25;h.drawYieldSanitizeNodesFrequency=2500;h.drawYieldSanitizeNodesTime=0;h.reflowTimeout=-1;h.minColumnsToHide=2;h.maximumCanvases=4900;h.clientRectsExpire=KindleHostDeviceDetector.isIE();h.rendererInitializationTimeout=6E4;h.glyphCacheMaxSize=15;if(KindleHostDeviceDetector.hasCanvasPerformanceProblem())h.maximumCanvases=
1750,h.drawYieldGlyphRendereringFrequency=200;if(j!=="metro"&&KindleHostDeviceDetector.isIE())h.fragmentBufferCapacityForPageFlip=6,h.drawYieldUpdateTime=0,h.drawYieldScreenManagerFrequency=500,h.drawYieldGlyphRendereringFrequency=200,h.drawYieldWordMapGenFrequency=500,h.drawYieldWordMapGenUpdateTime=0,h.drawYieldHeightMapFrequency=500,h.drawYieldHeightMapUpdateTime=0,h.yieldTimeOnContentReceived=0,h.yieldTimeAfterBulkWriteToIframe=0,h.yieldTimeBeforeBulkWriteToIframe=0,h.yieldTimeAfterIframeLoaded=
0,h.yieldTimeLoadNextFragment=0,h.maximumCanvases=1750,h.clientRectsExpire=!0,h.mightUseCSSRegions=!0,h.defaultNumRegions=25,h.mightUseNativeSelection=!0}else j==="lassen"?(h.fragmentBufferCapacityForGoTo=1.2,h.fragmentBufferCapacityForPageFlip=7,h.fragmentBufferCapacityForPageFlipGlyphs=2,h.drawYieldGlyphRendereringFrequency=200,h.reflowTimeout=2E4,h.maximumCanvases=1750,h.minColumnsToHide=1,h.rendererInitializationTimeout=2E4,h.drawYieldSanitizeNodesFrequency=2500,h.drawYieldSanitizeNodesTime=0,
KindleHostDeviceDetector.isiPhone()?(h.drawYieldWordMapGenFrequency=20,h.drawYieldWordMapGenUpdateTime=10,h.drawYieldHeightMapFrequency=500,h.drawYieldHeightMapUpdateTime=10,h.drawYieldScreenManagerFrequency=250,h.drawYieldUpdateTime=50):(h.drawYieldWordMapGenFrequency=300,h.drawYieldWordMapGenUpdateTime=50,h.drawYieldHeightMapFrequency=500,h.drawYieldHeightMapUpdateTime=20,h.drawYieldScreenManagerFrequency=250,h.drawYieldUpdateTime=10)):j==="metro"?(h.fragmentBufferCapacityForGoTo=2,h.fragmentBufferCapacityForPageFlip=
6,h.fragmentBufferCapacityForPageFlipGlyphs=3,h.drawYieldUpdateTime=0,h.drawYieldScreenManagerFrequency=500,h.drawYieldGlyphRendereringFrequency=200,h.drawYieldWordMapGenFrequency=500,h.drawYieldWordMapGenUpdateTime=0,h.drawYieldHeightMapFrequency=500,h.drawYieldHeightMapUpdateTime=0,h.yieldTimeOnContentReceived=0,h.yieldTimeAfterBulkWriteToIframe=0,h.yieldTimeBeforeBulkWriteToIframe=0,h.yieldTimeAfterIframeLoaded=0,h.yieldTimeLoadNextFragment=0,h.reflowTimeout=-1,h.minColumnsToHide=2,h.maximumCanvases=
1750,h.clientRectsExpire=!0,h.rendererInitializationTimeout=6E4,h.drawYieldSanitizeNodesFrequency=2500,h.drawYieldSanitizeNodesTime=0,h.glyphCacheMaxSize=15,h.clientRectsExpire=!0,h.mightUseCSSRegions=!0,h.defaultNumRegions=25,h.mightUseNativeSelection=!0):j==="metroArm"?(h.fragmentBufferCapacityForGoTo=1.2,h.fragmentBufferCapacityForPageFlip=5,h.fragmentBufferCapacityForPageFlipGlyphs=2,h.drawYieldUpdateTime=0,h.drawYieldScreenManagerFrequency=500,h.drawYieldGlyphRendereringFrequency=200,h.drawYieldWordMapGenFrequency=
500,h.drawYieldWordMapGenUpdateTime=0,h.drawYieldHeightMapFrequency=500,h.drawYieldHeightMapUpdateTime=0,h.yieldTimeOnContentReceived=0,h.yieldTimeAfterBulkWriteToIframe=0,h.yieldTimeBeforeBulkWriteToIframe=0,h.yieldTimeAfterIframeLoaded=0,h.yieldTimeLoadNextFragment=0,h.reflowTimeout=-1,h.minColumnsToHide=2,h.maximumCanvases=1750,h.clientRectsExpire=!0,h.rendererInitializationTimeout=9E4,h.drawYieldSanitizeNodesFrequency=2500,h.drawYieldSanitizeNodesTime=0,h.glyphCacheMaxSize=15,h.clientRectsExpire=
!0,h.animatePageFlip=!1,h.mightUseCSSRegions=!0,h.defaultNumRegions=15,h.mightUseNativeSelection=!0):(h.fragmentBufferCapacityForGoTo=1.2,h.fragmentBufferCapacityForPageFlip=7,h.fragmentBufferCapacityForPageFlipGlyphs=2,h.drawYieldUpdateTime=50,h.drawYieldScreenManagerFrequency=250,h.drawYieldGlyphRendereringFrequency=200,h.drawYieldWordMapGenFrequency=300,h.drawYieldWordMapGenUpdateTime=50,h.drawYieldHeightMapFrequency=5E3,h.drawYieldHeightMapUpdateTime=50,h.drawYieldSanitizeNodesFrequency=2500,
h.drawYieldSanitizeNodesTime=0,h.reflowTimeout=1E4,h.minColumnsToHide=2,h.maximumCanvases=1750,h.rendererInitializationTimeout=9E4,h.animatePageFlip=KindleHostDeviceDetector.isiOS()&&!KindleHostDeviceDetector.isiOS_4x());if(j==="metro")h.minColumnsToHide=1,h.clientRectsExpire=!0;h.needsReflowOnPageFlip=KindleHostDeviceDetector.isiOS_4x()||KindleHostDeviceDetector.isChrome&&KindleHostDeviceDetector.isChrome()&&navigator.userAgent.indexOf("Chrome/18.")>=0;h.usesDocRelativeVerticalCoordinates=KindleHostDeviceDetector.isiOS();
h.needsWritingModeSpecifiedOnBody=KindleHostDeviceDetector.isiOS();h.verticalParagraphsScaleSeparately=KindleHostDeviceDetector.isiPhone();h.needsLanguageSpecificItalicsCheck=KindleHostDeviceDetector.isiOS()&&parseInt(KindleHostDeviceDetector.getOSMajorVersion(),10)===7;h.shouldRotateECJKChar=KindleHostDeviceDetector.isiOS()&&KindleHostDeviceDetector.getOSMajorVersion&&KindleHostDeviceDetector.getOSMinorVersion&&(parseInt(KindleHostDeviceDetector.getOSMajorVersion(),10)<6||parseInt(KindleHostDeviceDetector.getOSMajorVersion(),
10)===6&&parseInt(KindleHostDeviceDetector.getOSMinorVersion(),10)===0)},fragmentBufferCapacityForGoTo:function(){return h.fragmentBufferCapacityForGoTo},fragmentBufferCapacityForPageFlip:function(j){return j?h.fragmentBufferCapacityForPageFlipGlyphs:h.fragmentBufferCapacityForPageFlip},drawYieldUpdateTime:function(){return h.drawYieldUpdateTime},glyphCacheMaxSize:function(){return h.glyphCacheMaxSize||0},drawYieldWordMapGenUpdateTime:function(){return h.drawYieldWordMapGenUpdateTime},drawYieldHeightMapUpdateTime:function(){return h.drawYieldHeightMapUpdateTime},
drawYieldScreenManagerFrequency:function(){return h.drawYieldScreenManagerFrequency},drawYieldGlyphRendereringFrequency:function(){return h.drawYieldGlyphRendereringFrequency},drawYieldWordMapGenFrequency:function(){return h.drawYieldWordMapGenFrequency},drawYieldHeightMapFrequency:function(){return h.drawYieldHeightMapFrequency},drawYieldSanitizeNodesFrequency:function(){return h.drawYieldSanitizeNodesFrequency},yieldTimeOnContentReceived:function(){return h.yieldTimeOnContentReceived},yieldTimeAfterBulkWriteToIframe:function(){return h.yieldTimeAfterBulkWriteToIframe},
yieldTimeBeforeBulkWriteToIframe:function(){return h.yieldTimeBeforeBulkWriteToIframe},yieldTimeAfterIframeLoaded:function(){return h.yieldTimeAfterIframeLoaded},yieldTimeLoadNextFragment:function(){return h.yieldTimeLoadNextFragment},needsReflowOnPageFlip:function(){return h.needsReflowOnPageFlip},shouldRotateECJKChar:function(){return h.shouldRotateECJKChar},needsLanguageSpecificItalicsCheck:function(){return h.needsLanguageSpecificItalicsCheck},usesDocRelativeVerticalCoordinates:function(){return h.usesDocRelativeVerticalCoordinates},
needsWritingModeSpecifiedOnBody:function(){return h.needsWritingModeSpecifiedOnBody},verticalParagraphsScaleSeparately:function(){return h.verticalParagraphsScaleSeparately},reflowTimeout:function(){return h.reflowTimeout},maximumCanvases:function(){return h.maximumCanvases},animatePageFlip:function(){return h.animatePageFlip},clientRectsExpire:function(){return h.clientRectsExpire},minColumnsToHide:function(){return h.minColumnsToHide},rendererInitializationTimeout:function(){return h.rendererInitializationTimeout},
drawYieldSanitizeNodesTime:function(){return h.drawYieldSanitizeNodesTime||0},mightUseCSSRegions:function(){return h.mightUseCSSRegions},mightUseNativeSelection:function(){return h.mightUseNativeSelection},defaultNumRegions:function(){return h.defaultNumRegions||0},resolutionScale:function(){var h=1;screen.deviceXDPI&&(h=screen.deviceXDPI/96);return h}}}(),KindleRendererLanguageOptions=function(){function h(h){var h=h&&h.split("-")[0].toLowerCase()||"en",n={};h==="ja"?(n={fontFamilyRegex:j,sansFont:d,
serifFont:e,defaultFont:e},m={hasWhitespaceDelimitedWords:!1,language:h,lineHeight:"1.75",allowsVerticalLayout:!0,allowsNegativeTextIndent:!0,allowsClearStyle:!1,needsPageRefresh:!0,needsFontSanitization:!0,needsDeviceSpecificItalicsCheck:!0,fontOptions:n}):h==="zh"?(n={fontFamilyRegex:c,sansFont:f,serifFont:b,defaultFont:b},m={hasWhitespaceDelimitedWords:!1,language:h,lineHeight:"1.4",allowsVerticalLayout:!0,allowsNegativeTextIndent:!0,allowsClearStyle:!1,needsPageRefresh:!0,needsFontSanitization:!0,
needsDeviceSpecificItalicsCheck:!1,fontOptions:n}):(n={fontFamilyRegex:a,sansFont:k,serifFont:g,defaultFont:g},m={hasWhitespaceDelimitedWords:!0,language:h,lineHeight:"1.4",allowsVerticalLayout:!1,allowsNegativeTextIndent:!1,allowsClearStyle:!0,needsPageRefresh:!1,needsFontSanitization:!1,needsDeviceSpecificItalicsCheck:!1,fontOptions:n})}var j=/(Hiragino)|(HiraKaku)/,e="'Hiragino Mincho ProN'",d="HiraKakuProN-W3",c=/(Songti)|(Heiti)/,b="'Songti SC'",f="'Heiti SC'",a=/(serif)|(sans-serif)|(gothic)/i,
g="Georgia, serif",k="sans-serif",m={};h("en");return{initialize:h,getHasWhitespaceDelimitedWords:function(){return m.hasWhitespaceDelimitedWords},getLanguage:function(){return m.language},getLineHeight:function(){return m.lineHeight},getAllowsVerticalLayout:function(){return m.allowsVerticalLayout},getAllowsNegativeTextIndent:function(){return m.allowsNegativeTextIndent},getAllowsClearStyle:function(){return m.allowsClearStyle},getNeedsPageRefresh:function(){return m.needsPageRefresh},getNeedsFontSanitization:function(){return m.needsFontSanitization},
getAcceptedFontFamiliesRegex:function(){return m.fontOptions.fontFamilyRegex},getSansFont:function(){return m.fontOptions.sansFont},getSerifFont:function(){return m.fontOptions.serifFont},getDefaultFont:function(){return m.fontOptions.defaultFont},getAllowsItalicFont:function(){return!(m.needsDeviceSpecificItalicsCheck&&KindleRendererDeviceSpecific.needsLanguageSpecificItalicsCheck())}}}(),KindleRendererSettings=function(){function h(b,a,c){try{b.styleSheet&&b.styleSheet.addRule?b.styleSheet.addRule(a,
c):b.sheet&&b.sheet.insertRule&&b.sheet.insertRule(a+"{"+c+"}",0)}catch(d){}}function j(d){var a=new jQuery.Deferred;d.getMetadata(function(d){if(d.hasFixedContent!==void 0)c.fixedContent=d.hasFixedContent;if(d.publisherMetadata!==void 0){var f=d.publisherMetadata;if(f[0]==="metadata"&&(f=f[2],f!==void 0))for(var e=f.length,h=0;h<e;++h){var j=f[h][1];if(j!==void 0)if(j.name==="fixed-layout")c.fixedContent=j.content==="true";else if(j.name==="original-resolution"&&(j=j.content.match(/(\d+)[Xx](\d+)/)))c.originalResolution=
{width:parseInt(j[1],10),height:parseInt(j[2],10)}}}if(d.headerMetadata!==void 0){f=d.headerMetadata;if(f.fixedLayout)c.fixedContent=f.fixedLayout==="true";if(f.originalResolution&&(e=f.originalResolution.match(/(\d+)[Xx](\d+)/)))c.originalResolution={width:parseInt(e[1],10),height:parseInt(e[2],10)};c.pageProgressionDirection={RTL:0,LTR:1};c.inlineBaseDirection={VERTICAL:0,HORIZONTAL:1};if(f.app_PrimaryWritingMode)c.pageProgressionDirection.value=f.app_PrimaryWritingMode==="vertical-rl"||f.app_PrimaryWritingMode===
"horizontal-rl"?c.pageProgressionDirection.RTL:c.pageProgressionDirection.LTR,c.inlineBaseDirection.value=f.app_PrimaryWritingMode.match(/^vertical/)!==null?c.inlineBaseDirection.VERTICAL:c.inlineBaseDirection.HORIZONTAL;d=d.headerMetadata.app_contentLanguageTag}else d="en";KindleRendererLanguageOptions.initialize(d);if(KindleRendererDeviceSpecific.verticalParagraphsScaleSeparately()&&KindleRendererLanguageOptions.getAllowsVerticalLayout()&&!c.fixedContent)c.initialExpandedBodyHeight=b;c.lineSpacingMultiplier=
1;a.resolve()},function(){a.reject()});return a.promise()}function e(){return!c.fixedContent&&KindleRendererDeviceSpecific.mightUseCSSRegions()&&KindleRendererFragmentLoader.getBookContentType()!=="topaz"}function d(){return!c.fixedContent&&KindleRendererDeviceSpecific.mightUseNativeSelection()&&KindleRendererFragmentLoader.getBookContentType()!=="topaz"}var c={},b="500%";return{initialize:function(b){return j(b)},cleanup:function(){c={}},getSettings:function(){return c},updateSettings:function(b){for(var a in b)c[a]=
b[a]},addCSSRules:function(b){var a=c,g=document.getElementById("kindleRendererOptionsStylesheet");g!==void 0&&g!==null&&g.parentNode.removeChild(g);g=document.createElement("style");g.type="text/css";g.id="kindleRendererOptionsStylesheet";if(!(/MSIE ((5\.5)|6|(7\.0))/.test(navigator.userAgent)&&navigator.platform==="Win32"))try{if(b.appendChild(g),a.fixedContent)h(g,"body","position : absolute; margin: 0;"),a.originalResolution&&h(g,"body.amzUserPref","background-size: contain !important; width: "+
a.originalResolution.width+"px; height: "+a.originalResolution.height+"px");else{var j;if(a.fontSizes!==void 0){h(g,"body.amzUserPref","font-size : "+a.fontSizes[2]+a.fontSizeUnits+" !important");h(g,"font","font-size : "+a.fontSizes[2]+a.fontSizeUnits+" !important");for(j=0;j<a.fontSizes.length;j+=1)h(g,".font-size-"+(j+1),"font-size : "+a.fontSizes[j]+a.fontSizeUnits+" !important")}if(a.lineSpacingMultiplier!==void 0){var m=KindleRendererLanguageOptions.getLineHeight()*a.lineSpacingMultiplier;h(g,
"body.amzUserPref","line-height: "+m+"  !important")}a.fontColor!==void 0&&h(g,"body.amzUserPref","color : "+a.fontColor+" !important");a.fontFamily!==void 0&&h(g,"body.amzUserPref","font-family : "+a.fontFamily+" !important");a.backgroundColor!==void 0&&h(g,"body.amzUserPref","background-color : "+a.backgroundColor+" !important");a.textAlign!==void 0&&h(g,"body.amzUserPref","text-align : "+a.textAlign+" !important");a.margin!==void 0&&h(g,"body.amzUserPref","margin : "+a.margin+" !important");a.selectionColor!==
void 0&&h(g,"div.amazon-selection","background-color : "+a.selectionColor);a.insertBgColor!==void 0&&h(g,".insert","background-color : "+a.insertBgColor);if(a.annotationStyles!==void 0)for(var l in a.annotationStyles){var n=a.annotationStyles[l],r=n.htmlElementTag?n.htmlElementTag+"."+n.className:"div."+n.className;h(g,r,n.style);if(n.additionalStyles)for(var o in n.additionalStyles){var q=n.additionalStyles[o];h(g,r+"."+q.className,q.style)}}a.clickableElementFeedbackStyles!==void 0&&h(g,"."+a.clickableElementFeedbackStyles.className,
a.clickableElementFeedbackStyles.classStyle);if(a.keyframes!==void 0){var t=a.keyframes,s;for(s in t)h(g,s,t[s])}e()&&a.columns!==void 0&&(h(g,"body","column-count : "+a.columns.num),h(g,"body","column-gap : "+a.columns.gap),h(g,"body","column-fill: auto"),g.styleSheet.cssText+="@media screen and (max-width:320px) { body { column-count: 1 } }");d()&&h(g,"::selection","background-color : "+a.selectionColor);if(a.additionalRules!==void 0&&a.additionalRules.length!==void 0)for(j=0;j<a.additionalRules.length;j+=
1)h(g,a.additionalRules[j].selector,a.additionalRules[j].style)}}catch(u){}},useCSSRegions:e,useNativeSelection:d}}(),KindleRendererContentCorrection=function(){function h(a,b,c){if(c.getWritingMode()==="vertical"){a=$(b.body).find(".azn-ECJK");for(b=0;b<a.length;b++)c=a[b].firstChild.nodeValue.charCodeAt(0),(c>=65307&&c<=65308||c===65310||c===65293)&&(c="rotate(90deg) translateX("+(c===65293?s:"0.5")+"em)",$(a[b]).css({display:"inline-block","-webkit-transform":c,width:"1em",height:"1em","text-indent":"0px",
"vertical-align":"text-top"}))}}function j(a,b){var c=a.getComputedStyle(b.body).fontFamily,c=KindleRendererFontHelper.sanitizeFontFamily(c);b.body.setAttribute("style",(b.body.getAttribute("style")||"")+("; font-family: "+c))}function e(a,b){for(var c=$(b.body).find(".azn-UNB"),d=0;d<c.length;++d){var f=c[d].firstChild.nodeValue.charCodeAt(0);if(f===8213||f===8212||f===9472){if(f!==9472)f=String.fromCharCode(9472),c[d].innerHTML=f+f;$(c[d]).css("-webkit-transform","scaleY(.9)")}}}function d(a,b,
c){if(c.getWritingMode()==="vertical"){a=$(b.body).find(".azn-NTE");for(b=0;b<a.length;b++){c=a[b].firstChild.nodeValue.charCodeAt(0);switch(c){case 8220:c=12317;break;case 8221:c=12319}a[b].firstChild.nodeValue=String.fromCharCode(c)}}}function c(a,b,c){if(c.getWritingMode()==="vertical"){a=$("img",b.body).filter(function(){return $(this).css("float")!=="none"&&$(this).parent().css("display")!=="block"});for(b=0;b<a.length;b++)$(a[b]).parent().css("display","block")}}function b(a,b,c){if(c.getWritingMode()===
"horizontal"){a=$('img[data-isGaiji="true"]',b.body);for(b=0;b<a.length;b++)$(a[b]).css("vertical-align","text-top")}}function f(a,b,c){var d={position:"absolute",height:a.height,width:a.width};b?$.extend(d,{top:a.top,left:a.left+1,borderLeft:"1px solid "+c}):$.extend(d,{top:a.top-1,left:a.left,borderBottom:"1px solid "+c});return d}function a(a,b,c){var d={position:"absolute",height:a.height,width:a.width};b?$.extend(d,{top:a.top,left:a.left-1,borderRight:"1px solid "+c}):$.extend(d,{top:a.top+1,
left:a.left,borderTop:"1px solid "+c});return d}function g(a,b,c){var d={position:"absolute",top:a.top,left:a.left};b?$.extend(d,{height:a.height,width:Math.floor(a.width/2),borderRight:"1px solid "+c}):$.extend(d,{height:Math.floor(a.height/2),width:a.width,borderBottom:"1px solid "+c});return d}function k(a,b){for(var c,d=$('span:not([class*="azn-"])',b.body),f=0;f<d.length;++f)if(currNode=d[f],c=a.getComputedStyle(currNode),c.webkitTextCombine==="horizontal"&&c.webkitWritingMode==="vertical-rl"&&
currNode.textContent.length>1&&currNode.textContent.length<5){currNode.setAttribute("data-isTextCombineBlock","true");var e=currNode;c=parseInt(c.fontSize,10);$(e).css("-webkit-text-combine","none");var g=e.getClientRects();if(g.length>0){var h=g[0].height,g=-Math.floor((h-c)/2)+"px";c=h>c?" scaleY("+c/h+")":"";$(e).css({"-webkit-transform":"rotate(270deg)"+c,margin:g+" 0px"})}}}function m(a,b){var c=function(a,b){var c=$(a).css("border-"+b+"-style");return c&&c!=="none"},d=$('a, span:not([class*="azn-"])',
b.body),f,e,g,h,j;for(f=0;f<d.length;f++)currNode=d[f],e=c(currNode,"top"),g=c(currNode,"bottom"),h=c(currNode,"left"),j=c(currNode,"right"),(e||g||h||j)&&currNode.setAttribute("data-hasCssBorder","true")}function l(a,b){for(var c=$("rt",b.body),d=0;d<c.length;d++)$(c[d]).css("font-size","")}function n(b,c,d,e,h,j){if(c.webkitWritingMode.match(j.getWritingMode())!==null){var k=h.document,l=k.getElementById(q),m;a:{var n=b;m=c;var s;s=(s=$(n).attr("class"))&&s.match(/azn-/)?3:2;for(var r=0;r<=s;++r){if(!n)break;
m=n.getAttribute(t)||m.textDecoration;if(!m||m==="none"){n=n.parentElement;if(!n)break;m=h.getComputedStyle(n)}else{m={node:n,decoration:m};break a}}m=void 0}n={underline:f,overline:a,"line-through":g};if(!m||!n[m.decoration])l&&l.lastChild&&$(l.lastChild).removeData(t);else{if(!l){s=k.getElementById(o);if(!s)return;l=k.createElement("DIV");l.id=q;l.style.position="relative";l.style.zIndex="-8";s.appendChild(l)}n=n[m.decoration];m.node.setAttribute(t,m.decoration);if(b.tagName==="IMG")e=e[d[0]].rects;
else{b={};b.start=d[0];b.end=d[d.length-1];d=KindleRendererWordRectsHelper.createWordBoundaries(b,e,k,h,j);e=[];for(h=0;h<d.length;h++)e.push(d[h].rect);e=e.sort(j.clientRectCompare)}d=k.createDocumentFragment();h=l.lastChild;m=m.node;b=c.webkitWritingMode==="vertical-rl";s=k.createElement("DIV");var r=!0,u=null,v=null,y;if(h&&e.length>0){var A=$(h).data(t);if(A){var O=m===A.node,J=j.checkIfNewLine(A.line,e[0],!1),O=O&&!J;$(h).removeData(t);if(O)r=!1,u=A.line,s=h,y=A.maxHeight}}for(h=0;h<e.length;h+=
1)A=e[h],r&&(u={top:A.top,height:A.height,left:A.left,right:A.right,width:A.width},y={top:Infinity,right:Infinity,bottom:-Infinity,left:-Infinity}),v=$.extend({},u),r=j.checkIfNewLine(u,e[h+1],!1),j.updateLineHeightOfBounds(y,A),r&&(j.updateLineBounds(u,!1,y,e[h+1],k.width),$(s).css(n(u,b,c.color)),d.appendChild(s),s=k.createElement("DIV"));c={line:v,maxHeight:y,node:m};$(d.lastChild).data(t,c);l.appendChild(d)}}}function r(a){for(var a=a.querySelectorAll("["+t+"]"),b=0;b<a.length;++b){var c=$(a[b]);
c.attr("style",c.attr("style")+"; text-decoration: none !important")}}var o="content-overlays",q="text-decoration-correction",t="data-cjktextdecoration",s=".425",u=[],y=[],v=[];return{initialize:function(){var a=KindleRendererLanguageOptions.getLanguage();a==="ja"?(u.push(e),u.push(d),u.push(c),u.push(b),u.push(m),u.push(l),KindleRendererDeviceSpecific.shouldRotateECJKChar()&&u.push(h),document.body&&document.body.style.webkitWritingMode!==void 0&&(u.push(k),y.push(n)),v.push(r)):a==="zh"&&(u.push(b),
u.push(l));KindleRendererLanguageOptions.getNeedsFontSanitization()&&u.push(j)},applyDocumentWideCorrections:function(a,b,c,d){for(var d=d.createSubTimer("correction"),f=0;f<u.length;++f)u[f](a,b,c);d.endTimer()},applyNodeLocalCorrections:function(a,b,c,d,f,e){if(!(y.length===0||!b||b.length===0)){for(var e=e.createSubTimer("correction"),a=a.nodeType===Node.TEXT_NODE?a.parentNode:a,g=d.getComputedStyle(a),h=0;h<y.length;++h)y[h](a,g,b,c,d,f);e.endTimer()}},cleanup:function(a){for(var b=0;b<v.length;++b)v[b](a)}}}(),
KindleRendererDefaults=function(){function h(h,e,d){h.styleSheet&&h.styleSheet.addRule?h.styleSheet.addRule(e,d):h.sheet&&h.sheet.insertRule&&h.sheet.insertRule(e+"{"+d+"}",h.sheet.cssRules?h.sheet.cssRules.length:h.sheet.rules.length)}return{addCSSRules:function(j,e){if(e==="mobi8"){var d=document.createElement("style");d.type="text/css";d.id="kindleReaderStylesheetDefaults";try{j.insertBefore(d,j.firstChild);h(d,"html","font-size: 15px;");h(d,"table","color: inherit; font-size: inherit; line-height: inherit; font-weight: inherit; font-variant:inherit; font-style:inherit; white-space: inherit; word-wrap: inherit;");
KindleRendererDeviceSpecific.needsWritingModeSpecifiedOnBody()&&h(d,"body","-webkit-writing-mode: horizontal-tb");KindleRendererLanguageOptions.getDefaultFont()&&h(d,"body","font-family: "+KindleRendererLanguageOptions.getDefaultFont()+";");KindleRendererLanguageOptions.getLineHeight()&&h(d,"body","line-height: "+KindleRendererLanguageOptions.getLineHeight()+";");var c=KindleRendererSettings.getSettings().initialExpandedBodyHeight;c!==void 0&&h(stylesheet,"body","height: "+c+";")}catch(b){}}d=document.createElement("style");
d.type="text/css";d.id="kindleReaderStylesheetOverrides";try{j.appendChild(d),e==="mobi7"&&(h(d,"body","font-family: Georgia, serif; word-wrap: break-word;"),h(d,"p","margin-top: 0px; margin-bottom: 0px; text-indent:2em"),h(d,".was-a-p","margin-top: 0px; margin-bottom: 0px; text-indent:2em;"),h(d,"hr","margin-top: 15px; margin-bottom: 15px;"),h(d,"center,dd,div,dl,dt,li,ol,pre,table,ul,hr,h1,h2,h3,h4,h5,h6","margin-top: 0px; margin-bottom: 0px;"),h(d,"blockquote","text-indent: 0px; margin-top: 0px; margin-bottom: 0px;"),
h(d,"ul","list-style-type: disc;"),h(d,"ol, ul, li .was-a-p","text-indent: 0;"),h(d,"table.amazon-table-style-0","border-collapse:collapse; font-size: inherit;"),h(d,"table.amazon-table-style-0 tr td","border:none; padding:1px;"),h(d,"table.amazon-table-style-0 tr th","border:none; padding:1px; text-align:justify"),h(d,"table.amazon-table-style-1","border-collapse:collapse; font-size: inherit;"),h(d,"table.amazon-table-style-1 tr td","border:1px solid black; padding:1px;"),h(d,"table.amazon-table-style-1 tr th",
"border:1px solid black; padding:1px; text-align:justify")),e==="mobi8"&&(h(d,"body","word-wrap: break-word; padding: 0px !important;"),h(d,".azn-FWURG","-webkit-text-orientation: upright;"),h(d,".azn-NTE","-webkit-text-emphasis: none !important"),h(d,".azn-UNB","letter-spacing: 0em !important; display: inline-block; text-indent: 0px !important; -webkit-text-orientation: vertical-right !important;"),h(d,".azn-JPLB","display:inline-block; text-indent: 0px !important;")),h(d,".semiTransparentOverlay",
"z-index: 10 !important; opacity: 0.5"),h(d,"svg img","display: none;"),h(d,".page-break","display:block; padding:1px"),h(d,".pagebreak","display:block; padding:1px"),h(d,".defaultHighlight","background-color:#ffff9b"),h(d,".noDisplay","display:none"),h(d,"body","cursor: default; position: relative;"),KindleRendererSettings.getSettings().fixedContent||(h(d,"body","background: none !important; background-color: transparent !important;"),h(d,"html, body","width: auto; height: auto;")),KindleRendererSettings.useCSSRegions()&&
(h(d,".was-a-p","orphans:0; widows:0"),h(d,".page-break","break-before:column"),h(d,".pagebreak","break-before:column"),h(d,".renderer-page-break","width:0px; height:0px; break-before:always")),KindleRendererSettings.useNativeSelection()?h(d,"body","-webkit-user-select:text; -moz-user-select:text; -ms-user-select:text; unselectable: off;"):h(d,"body","-webkit-user-select:none; -moz-user-select:none; -ms-user-select:none; unselectable: on;"),h(d,".kindle-annotation-wrapper, .kindle-annotation-wrapper *",
"margin: auto; padding: 0"),h(d,"div#content-overlays","margin: 0px; padding: 0px;")}catch(f){}}}}(),KindleRendererContentStyleSanitization=function(){function h(a,b){var c=a[b];if(c===void 0){var d=m.exec(b);d!==null&&d.length>=3&&(b=d[1]+d[2].substring(0,1).toUpperCase()+d[2].substring(1),c=a[b])}return c}function j(a,b,c){if(b==="float")return c.hasFloat=!0;if(b==="position")return a=h(a,b),!(a==="inherit"||a==="static")?c.isPositioned=!0:!1;if(b==="width"){a=h(a,b);if(a!==void 0){if(!c.widths)c.widths=
{percent:[],fixed:[]};a.indexOf("%")>=0?c.widths.percent.push(a):c.widths.fixed.push(a);return!0}return!1}if(b==="height"){a=h(a,b);if(a!==void 0){if(!c.heights)c.heights={percent:[],fixed:[]};a.indexOf("%")>=0?c.heights.percent.push(a):c.heights.fixed.push(a);return!0}return!1}if(b==="max-width"||b==="max-height"){a=h(a,b);if(a!==void 0&&a.indexOf("%")>=0){if(!c.prcntMaxDimension)c.prcntMaxDimension=[];c.prcntMaxDimension.push(a);return!0}return!1}if(b==="font-size")return a=h(a,b),a!==void 0&&!l.test(a)?
(n.test(a)?c.remFontValue=a.trim():c.absFontValue=a.trim(),!0):!1;if(b==="line-height")return a=h(a,b),a!==void 0?(c.lineHeight=a,!0):!1;if(b==="background-color")return a=h(a,b),a!==void 0?(c.backgroundColorRgb=KindleRendererColorHelper.toRgbArray(a.trim()),!0):!1;if(b==="text-indent")return!KindleRendererLanguageOptions.getAllowsNegativeTextIndent()&&(a=h(a,b),a!==void 0)?(c.textIndent=a,!0):!1;if(b==="color")return c.hasTextColor=!0;if(b==="clear")return!KindleRendererLanguageOptions.getAllowsClearStyle()?
c.hasClearStyle=!0:!1;if(b==="-webkit-text-combine")return c.textCombine=h(a,b),!0;if(b==="font-family"&&KindleRendererLanguageOptions.getNeedsFontSanitization())return c.langFontFamily=h(a,b),!0;if(b==="font-style")return c.fontStyle=h(a,b),!0;if(b==="display")c.display=h(a,b);return!1}function e(a){try{for(var b={},c=a.style.length,d=!1,f=0;f<c;f++)d|=j(a.style,a.style[f],b);if(d)return b}catch(e){}return null}function d(a,b){for(var c=a.rules?a.rules:a.cssRules,f=c&&c.length||0,g=0;g<f;g++){var h=
c[g];if(!h.style&&h.media&&h.media.mediaText==="all")d(h,b);else{if(h=e(c[g]))h.selectorText=c[g].selectorText,b.push(h);h=c[g];if(h.selectorText!==void 0&&h.selectorText==="span")h.selectorText='span:not([class*="azn-"])';for(var h=[],j=0;j<h.length;++j)b.push(h[j])}}}function c(a,b){var c=KindleRendererScaleHelper.convertLength(a,"px");return c?(c=parseFloat(c),c=Math.floor(c),c=Math.min(c,b),c+"px"):a}function b(a,b,d,f,e,g,h,j){var k="",l=0;if(a.widths){for(var m=a.widths.percent,n=a.widths.fixed,
B=0.95*j.width,l=0;l<m.length;l++)k+="width: auto; ",a.display==="inline-block"&&parseInt(m[l],10)>95&&(k+="display: block; ");for(l=0;l<n.length;l++)m=c(n[l],B),k+=parseInt(m,10)<1?"width: auto; ":"width: "+m+"; "}if(a.heights){m=a.heights.percent;n=a.heights.fixed;B=0.95*j.height;for(l=0;l<m.length;l++)k+="height: auto; ",a.display==="inline-block"&&parseInt(m[l],10)>95&&(k+="display: block; ");for(l=0;l<n.length;l++)m=c(n[l],B),k+=parseInt(m,10)<1?"height: auto; ":"height: "+m+"; "}a.lineHeight&&
(l=parseFloat(a.lineHeight),k+=a.lineHeight.indexOf("%")>0&&l>=e*100?"line-height : "+l*g+"%; ":/^\d*(\.\d+)?$/.test(a.lineHeight.trim())&&l>=e?"line-height : "+l*g+"; ":"line-height : "+e*g+"; ");if(a.prcntMaxDimension)for(l=0;l<a.prcntMaxDimension.length;l++)k+=a.prcntMaxDimension[l]+": none; ";a.hasFloat&&(k+="line-height : "+(e+r)+"; ");a.isPositioned&&(k+="position: inherit; ");a.backgroundColorRgb&&!a.hasTextColor&&b&&(b=KindleRendererColorHelper.calculateTextColorForBackground(b,a.backgroundColorRgb))&&
(k+="color : rgb("+b[0]+", "+b[1]+", "+b[2]+"); ");a.absFontValue&&(b=KindleRendererScaleHelper.scaleFont(a.absFontValue,d,f)||a.absFontValue,k+="font-size: "+b+"; ");a.remFontValue&&(h=Math.round(parseFloat(a.remFontValue)*parseInt(h,10))+"px",d=KindleRendererScaleHelper.scaleFont(h,d,f)||a.absFontValue,k+="font-size: "+d+"; ");a.textIndent&&parseInt(a.textIndent,10)<0&&(j=0.9*j.width,d=a.textIndent.replace(/-/g,""),d.indexOf("%")>0?(d=parseFloat(d,10)/100,d*=j,d=Math.min(d,j),d=Math.floor(d),d=
Math.max(d,1),j=d+"px"):j=c(d,j),d=j,k+="text-indent: -"+d+"; padding-left: "+d+"; ");a.hasClearStyle&&(k+="clear:none");a.textCombine&&(k+="-webkit-text-combine: "+a.textCombine+"; display: inline-block; text-indent: 0px; height: auto;");a.langFontFamily&&(j=KindleRendererFontHelper.sanitizeFontFamily(a.langFontFamily),k+="font-family: "+j+";");a.fontStyle&&a.fontStyle==="italic"&&!KindleRendererLanguageOptions.getAllowsItalicFont()&&(k+="font-style: normal;");a.styleString&&(k+=a.styleString);return k}
function f(a){var b=a.styleSheets,a=$(a).find('link[rel*="stylesheet"][href], style');if(b.length<a.length)for(var a=a.filter("link"),b=$.makeArray(b),c=$.map(b,function(a){return a.ownerNode}),d=0;d<a.length;++d){var f=a[d],e=f.sheet||f.styleSheet;e&&(e.rules?e.rules:e.cssRules)&&c.indexOf(f)<0&&b.push(e)}return b}function a(a){function b(){var a,h,j=0;e++;for(KindleRendererProcessTuning.startingOperation("SanitizeNodes");f.length&&j<g;)if(a=f.pop(),j++,a&&a.nodeType===Node.ELEMENT_NODE){(h=a.getAttribute("style"))&&
h.length>0&&a.tagName!=="IMG"&&d.push(a);a=a.childNodes;for(h=0;h<a.length;h++)f.push(a[h])}KindleRendererProcessTuning.endingOperation("SanitizeNodes",j);f.length?setTimeout(b,processTimeout):c.resolve(d,e)}var c=$.Deferred(),d=[],f=[],e=0,g=KindleRendererProcessTuning.drawYieldFrequency("SanitizeNodes");processTimeout=KindleRendererProcessTuning.drawYieldUpdateTime("SanitizeNodes");f.push(a);b();return c.promise()}function g(b){var c=[];if(window.ActiveXObject&&window.XMLHttpRequest)return b=b.querySelectorAll("[style]:not(IMG)"),
$.Deferred().resolve(b);else try{for(var d=(new XPathEvaluator).evaluate("/html/body//*[@style]",b,null,XPathResult.UNORDERED_NODE_ITERATOR_TYPE,null),f=d.iterateNext();f;)f.style.length>0&&f.tagName!=="IMG"&&c.push(f),f=d.iterateNext()}catch(e){return a(b.body)}return $.Deferred().resolve(c)}function k(a){var b=$(a).attr("style");b&&$(a).attr("style",b.replace(/!\s*important/g,""))}var m=/^(\w*)-(\w*)(-value)?$/,l=/%|[^r]em|smaller|larger/,n=/rem/,r=0.2;return{sanitizeCSS:function(a,c,e){for(var g=
$('link[type="text/css"][title]',a.head),h=0;h<g.length;++h)g[h].removeAttribute("title");if(!c.fixedContent){h=!1;g=a.getElementById("kindleReaderSanitizationStylesheet");if(!g){g=a.createElement("style");g.id="kindleReaderSanitizationStylesheet";g.type="text/css";for(var h=g,j=f(a),k=[],l=j.length,m=0;m<l;m++)d(j[m],k);h.sanitizationRules=k;h=!0}if(g.sanitizationRules.length>0){for(var j=g.sanitizationRules,k=c.fontColor?KindleRendererColorHelper.toRgbArray(c.fontColor):null,l=c.fontSizes,m=c.fontSizeUnits,
n=KindleRendererLanguageOptions.getLineHeight(),c=c.lineSpacingMultiplier,r=getComputedStyle(a.documentElement).fontSize,z="",B=j.length,w=0;w<B;w++)z+=j[w].selectorText+" { ",z+=b(j[w],k,l,m,n,c,r,e),z+=" } ";g.innerHTML=z}h&&a.head.appendChild(g)}},sanitizeContent:function(a,c,d){var f=$.Deferred();if(c.fixedContent)return f.resolve();k(a.body);g(a).done(function(g){for(var h=c.fontColor?KindleRendererColorHelper.toRgbArray(c.fontColor):null,j=c.fontSizes,k=c.fontSizeUnits,l=KindleRendererLanguageOptions.getLineHeight(),
m=c.lineSpacingMultiplier,n=getComputedStyle(a.documentElement).fontSize,r=g.length,B=0;B<r;B++){var w=g[B],E=w,K=E.getAttribute("data-origStyle");K?E.setAttribute("style",K):E.setAttribute("data-origStyle",E.getAttribute("style"));if(E=e(g[B]))K=w.getAttribute("style")||"",K+="; ",K+=b(E,h,j,k,l,m,n,d),w.setAttribute("style",K)}f.resolve()});return f.promise()},copySanitizationData:function(a,b){var c=a.getElementById("kindleReaderSanitizationStylesheet"),d=b.getElementById("kindleReaderSanitizationStylesheet");
if(c&&d)d.sanitizationRules=c.sanitizationRules}}}(),KindleRendererColorHelper=function(){function h(b){if(b.charAt(0)==="#")return b.length===4?[parseInt(b.charAt(1)+b.charAt(1),16),parseInt(b.charAt(2)+b.charAt(2),16),parseInt(b.charAt(3)+b.charAt(3),16)]:b.length===7?[parseInt(b.charAt(1)+b.charAt(2),16),parseInt(b.charAt(3)+b.charAt(4),16),parseInt(b.charAt(5)+b.charAt(6),16)]:null;var b=b.toUpperCase(),c=d[b];if(c)return c;b=e.exec(b);return b!==null&&b.length===4?[parseInt(b[1],10),parseInt(b[2],
10),parseInt(b[3],10)]:null}function j(b){return c[0]*b[0]+c[1]*b[1]+c[2]*b[2]}var e=/RGB\s*\(\s*(\d*)\s*,\s*(\d*)\s*,\s*(\d*)\s*\)/,d={ALICEBLUE:[240,248,255],ANTIQUEWHITE:[250,235,215],AQUA:[0,255,255],AQUAMARINE:[127,255,212],AZURE:[240,255,255],BEIGE:[245,245,220],BISQUE:[255,228,196],BLACK:[0,0,0],BLANCHEDALMOND:[255,235,205],BLUE:[0,0,255],BLUEVIOLET:[138,43,226],BROWN:[165,42,42],BURLYWOOD:[222,184,135],CADETBLUE:[95,158,160],CHARTREUSE:[127,255,0],CHOCOLATE:[210,105,30],CORAL:[255,127,80],
CORNFLOWERBLUE:[100,149,237],CORNSILK:[255,248,220],CRIMSON:[220,20,60],CYAN:[0,255,255],DARKBLUE:[0,0,139],DARKCYAN:[0,139,139],DARKGOLDENROD:[184,134,11],DARKGRAY:[169,169,169],DARKGREY:[169,169,169],DARKGREEN:[0,100,0],DARKKHAKI:[189,183,107],DARKMAGENTA:[139,0,139],DARKOLIVEGREEN:[85,107,47],DARKORANGE:[255,140,0],DARKORCHID:[153,50,204],DARKRED:[139,0,0],DARKSALMON:[233,150,122],DARKSEAGREEN:[143,188,143],DARKSLATEBLUE:[72,61,139],DARKSLATEGRAY:[47,79,79],DARKSLATEGREY:[47,79,79],DARKTURQUOISE:[0,
206,209],DARKVIOLET:[148,0,211],DEEPPINK:[255,20,147],DEEPSKYBLUE:[0,191,255],DIMGRAY:[105,105,105],DIMGREY:[105,105,105],DODGERBLUE:[30,144,255],FIREBRICK:[178,34,34],FLORALWHITE:[255,250,240],FORESTGREEN:[34,139,34],FUCHSIA:[255,0,255],GAINSBORO:[220,220,220],GHOSTWHITE:[248,248,255],GOLD:[255,215,0],GOLDENROD:[218,165,32],GRAY:[128,128,128],GREY:[128,128,128],GREEN:[0,128,0],GREENYELLOW:[173,255,47],HONEYDEW:[240,255,240],HOTPINK:[255,105,180],INDIANRED:[205,92,92],INDIGO:[75,0,130],IVORY:[255,
255,240],KHAKI:[240,230,140],LAVENDER:[230,230,250],LAVENDERBLUSH:[255,240,245],LAWNGREEN:[124,252,0],LEMONCHIFFON:[255,250,205],LIGHTBLUE:[173,216,230],LIGHTCORAL:[240,128,128],LIGHTCYAN:[224,255,255],LIGHTGOLDENRODYELLOW:[250,250,210],LIGHTGRAY:[211,211,211],LIGHTGREY:[211,211,211],LIGHTGREEN:[144,238,144],LIGHTPINK:[255,182,193],LIGHTSALMON:[255,160,122],LIGHTSEAGREEN:[32,178,170],LIGHTSKYBLUE:[135,206,250],LIGHTSLATEGRAY:[119,136,153],LIGHTSLATEGREY:[119,136,153],LIGHTSTEELBLUE:[176,196,222],
LIGHTYELLOW:[255,255,224],LIME:[0,255,0],LIMEGREEN:[50,205,50],LINEN:[250,240,230],MAGENTA:[255,0,255],MAROON:[128,0,0],MEDIUMAQUAMARINE:[102,205,170],MEDIUMBLUE:[0,0,205],MEDIUMORCHID:[186,85,211],MEDIUMPURPLE:[147,112,216],MEDIUMSEAGREEN:[60,179,113],MEDIUMSLATEBLUE:[123,104,238],MEDIUMSPRINGGREEN:[0,250,154],MEDIUMTURQUOISE:[72,209,204],MEDIUMVIOLETRED:[199,21,133],MIDNIGHTBLUE:[25,25,112],MINTCREAM:[245,255,250],MISTYROSE:[255,228,225],MOCCASIN:[255,228,181],NAVAJOWHITE:[255,222,173],NAVY:[0,
0,128],OLDLACE:[253,245,230],OLIVE:[128,128,0],OLIVEDRAB:[107,142,35],ORANGE:[255,165,0],ORANGERED:[255,69,0],ORCHID:[218,112,214],PALEGOLDENROD:[238,232,170],PALEGREEN:[152,251,152],PALETURQUOISE:[175,238,238],PALEVIOLETRED:[216,112,147],PAPAYAWHIP:[255,239,213],PEACHPUFF:[255,218,185],PERU:[205,133,63],PINK:[255,192,203],PLUM:[221,160,221],POWDERBLUE:[176,224,230],PURPLE:[128,0,128],RED:[255,0,0],ROSYBROWN:[188,143,143],ROYALBLUE:[65,105,225],SADDLEBROWN:[139,69,19],SALMON:[250,128,114],SANDYBROWN:[244,
164,96],SEAGREEN:[46,139,87],SEASHELL:[255,245,238],SIENNA:[160,82,45],SILVER:[192,192,192],SKYBLUE:[135,206,235],SLATEBLUE:[106,90,205],SLATEGRAY:[112,128,144],SLATEGREY:[112,128,144],SNOW:[255,250,250],SPRINGGREEN:[0,255,127],STEELBLUE:[70,130,180],TAN:[210,180,140],TEAL:[0,128,128],THISTLE:[216,191,216],TOMATO:[255,99,71],TURQUOISE:[64,224,208],VIOLET:[238,130,238],WHEAT:[245,222,179],WHITE:[255,255,255],WHITESMOKE:[245,245,245],YELLOW:[255,255,0],YELLOWGREEN:[154,205,50]},c=[0.2126/255,0.7152/
255,0.0722/255];return{toRgbArray:function(b){return h(b)},calculateTextColorForBackground:function(b,c){var a=Math.abs(j(c)-j(b));if(a<0.3)var d=j(c),e=j(b),d=d<0.5?e<d?160:80:e>d?-160:-80,d=[Math.max(0,Math.min(255,b[0]+d)),Math.max(0,Math.min(255,b[1]+d)),Math.max(0,Math.min(255,b[2]+d))],a=Math.abs(j(d)-j(c))>a?d:null;else a=null;return a}}}(),KindleRendererContentScripts=function(){function h(e){e=e.contentWindow.KindleContentInterface;typeof j.gotoPosition==="function"&&(e.gotoPosition=function(d,
c){j.gotoPosition(c);return!1});typeof j.openStoreDP==="function"&&(e.buyNow=e.showDetails=function(){j.openStoreDP();return!1})}var j;return{addInterfaceScripts:function(e){var d=e.contentDocument.getElementsByTagName("head")[0],c=document.createElement("script");c.language="Javascript";c.type="text/javascript";c.id="kindleContentInterface";if(!(/MSIE ((5\.5)|6|(7\.0))/.test(navigator.userAgent)&&navigator.platform==="Win32"))try{d.appendChild(c),d="var KindleContentInterface = function() { return { ",
d+=" gotoPosition : function(frm, pos) {parent.KindleReaderUI.gotoPosition(pos); return false;}, ",d+=" buyNow : function() {parent.KindleReaderUI.openStoreDP();return false;}, ",d+=" showDetails : function() {parent.KindleReaderUI.openStoreDP();  return false;} ",d+=" };}();",c.text=d,j&&h(e)}catch(b){}},setCallbacks:function(e){j=e}}}(),KindleRendererEventHandler=function(){function h(e){var d=KindleRendererSettings.getSettings().clickableElementFeedbackStyles;if(d!==void 0){var c=d.className,e=
$(e),d=function(){var b=$(this);b.unbind("animationend");b.unbind("webkitAnimationEnd");b.removeClass(c)};e.bind("animationend",d);e.bind("webkitAnimationEnd",d);e.addClass(c)}}function j(e){var d=document.createEvent("MouseEvents");d.initEvent("click",!0,!0);e.dispatchEvent(d)}return{handleClick:function(e,d,c){var b,f;if(f=d)a:{for(f=d;f!==null;){if(f.getAttribute!==void 0){var a=f.getAttribute("onclick")||f.getAttribute("href");if(a!==null&&a.length>0){f=!0;break a}}f=f.parentNode}f=!1}f&&(h(d),
j(d),b=!0);if(!(d=b)){e=e.getElementById("annotation-section");e=$(e).find("["+KindleRendererAnnotationRenderer.ANNOTATION_CLICK_ATTRIBUTE+"='true']").children();d=null;b=-Infinity;f=e.length;for(a=0;a<f;a+=1){var g=e[a],k=$(g).offset();k.top-10<c.y&&c.y<k.top+$(g).height()+10&&k.left-10<c.x&&c.x<k.left+$(g).width()+10&&(k=parseInt($(g).css("z-index"),10),isNaN(k)&&(k=0),k>b&&(b=k,d=g))}if(c=d){if((e=c.parentNode)&&e.getAttribute(KindleRendererAnnotationRenderer.ANNOTATION_CLICK_FEEDBACK_ATTRIBUTE)!==
"false"){e=e.childNodes;for(d=0;d<e.length;d++)h(e[d])}j(c);d=!0}else d=!1}return d}}}(),KindleRendererFontHelper=function(){var h=/(sans)|(gothic)/i,j=/serif/i;return{sanitizeFontFamily:function(e){var d=e.split(",");if(KindleRendererLanguageOptions.getNeedsFontSanitization()&&!e.match(KindleRendererLanguageOptions.getAcceptedFontFamiliesRegex())){for(var e="",c=0;c<d.length;++c){var b=d[c];e+=b.match(h)?KindleRendererLanguageOptions.getSansFont()+", "+b:b.match(j)?KindleRendererLanguageOptions.getSerifFont()+
", "+b:b;c<d.length-1&&(e+=",")}e.match(KindleRendererLanguageOptions.getAcceptedFontFamiliesRegex())||(e+=","+KindleRendererLanguageOptions.getDefaultFont());e+=" !important"}return e}}}(),KindleListUtilities=function(){return{binarySearch:function(h,j,e,d,c){if(!h.length)return 0;var b=h.length-1,f=0,a=0,g=null,k=0;d>f&&d<=b&&(f=d);for(c>=f&&c<b&&(b=c);f<=b;)if(a=Math.floor((f+b)/2),g=h[a],k=0,e===void 0?g>j?k=1:g<j&&(k=-1):k=e(j,g),k>0)b=a-1;else if(k<0)f=a+1;else return a;return a===0||k<0?a:
a-1},sortedMerge:function(h,j){var e=[],d=h.length,c=j.length,b=0,f=0;if(d){if(!c)return h}else return j;for(var a,g;b<d&&f<c;)a=h[b],g=j[f],a<g?(e.push(a),++b):(e.push(g),++f);for(;b<d;)e.push(h[b++]);for(;f<c;)e.push(j[f++]);return e},first:function(h){return h[0]},last:function(h){return h[h.length-1]}}}(),KindleRendererProcessTuning=function(){function h(e){var d,c=j[e];if(c){if(!c.unitTime)return c.frequency;e=c.frequency*c.unitTime;if(e>100){if(d=Math.floor(Math.max(100/c.unitTime,c.minimumFrequency)),
d<c.frequency)c.frequency=d}else if(e<50){if(d=Math.ceil(Math.max(50/c.unitTime,c.minimumFrequency)),d>c.frequency)c.frequency=d}else d=c.frequency}else d=KindleRendererDeviceSpecific["drawYield"+e+"Frequency"]?KindleRendererDeviceSpecific["drawYield"+e+"Frequency"]():100,c=KindleRendererDeviceSpecific["drawYield"+e+"UpdateTime"]?KindleRendererDeviceSpecific["drawYield"+e+"UpdateTime"]():KindleRendererDeviceSpecific.drawYieldUpdateTime(),j[e]={frequency:d,minimumFrequency:d/4,yieldTime:c};return d}
var j={};return{runAfterYield:function(e,d,c){d>=2&&e>=0?(d=KindleMetricsProfiler("(YIELD)"),setTimeout(c,e),d.endTimer()):c()},startingOperation:function(e){var d=j[e];d||(h(e),d=j[e]);d.startTime=Date.now()},endingOperation:function(e,d){var c,b=j[e];b||(h(e),b=j[e]);if(b.startTime){var f=Date.now()-b.startTime;if(!(d<1)){var a=j[e];f/=d;if(a.unitTime){var g=0.1*d/a.frequency;a.unitTime=g*f+(1-g)*a.unitTime}else a.unitTime=f}b.startTime=0}else c=void 0;return c},drawYieldFrequency:function(e){return h(e)},
drawYieldUpdateTime:function(e){var d=j[e];d||(h(time),d=j[e]);return d.yieldTime}}}(),KindleRendererScaleHelper=function(){function h(c,a){if(!b[a])return null;var e=c.match(d);return e?(e=b[e[1]],parseFloat(c,10)*e/b[a]):null}function j(b,a,d){if((b=b.match(e))&&a.length>0){var b=c[b[1]],h=Math.floor((a.length-1)/2),j=parseFloat(a[0],10),h=parseFloat(a[h],10),a=parseFloat(a[a.length-1],10);return Math.min(a,Math.max(j,b*h))+d}return null}var e=/(xx-small|x-small|small|medium|large|x-large|xx-large)/,
d=/(mm|cm|in|pt|pc|px)/,c={"xx-small":0.6,"x-small":0.75,small:0.889,medium:1,large:1.2,"x-large":1.5,"xx-large":2},b={mm:2.835,cm:28.346,"in":72,pt:1,pc:6,px:1.25};return{scaleFont:function(b,a,e){if(e=e.match(d)){var e=e[1],k;if(!(k=j(b,a,e)))k=(b=h(b,"pt"))?j(b<=c["xx-small"]*25?"xx-small":b<=c["x-small"]*25?"x-small":b<=c.small*25?"small":b<=c.medium*25?"medium":b<=c.large*25?"large":b<=c["x-large"]*25?"x-large":"xx-large",a,e):null;a=k}else a=b;return a},convertLength:function(b,a){var c=h(b,
a);return c?c+a:null}}}(),KindleRendererUtils=function(){function h(b){if(b)if(b.firstChild)return b.firstChild;else if(b.nextSibling)return b.nextSibling;else{do b=b.parentNode;while(b&&!b.nextSibling);return b&&b.nextSibling}else return null}function j(b){if(b)if(b.lastChild)return b.lastChild;else if(b.previousSibling)return b.previousSibling;else{do b=b.parentNode;while(b&&!b.previousSibling);return b&&b.previousSibling}else return null}function e(b){return b?/^(SPAN|CANVAS|IMG)$/i.test(b.tagName)&&
isFinite(b.id):!1}var d=/metro/i,c=/desktop/i,b={};return{nextPositionedNode:function(b){for(b=h(b);b;){if(e(b))return b;b=h(b)}return null},previousPositionedNode:function(b){for(b=j(b);b;){if(e(b))return b;b=j(b)}return null},followingNode:function(b){var a;if(b){for(a=b.nextSibling;b&&!a;)b=b.parentNode,a=b.nextSibling;return a}else return null},precedingNode:function(b){var a;if(b){for(a=b.previousSibling;b&&!a;)b=b.parentNode,a=b.previousSibling;return a}else return null},isBlock:function(b){return b?
/^(ADDRESS|ARTICLE|ASIDE|AUDIO|BLOCKQUOTE|DD|DIV|DL|FIELDSET|FIGCAPTION|FIGURE|FOOTER|FORM|H[1-6]|HEADER|HGROUP|HR|NOSCRIPT|OL|OUTPUT|P|PRE|SECTION|TABLE|TFOOT|UL|VIDEO)$/i.test(b.tagName):!1},findElementAtOrAfterPosition:function(b,a){for(var c=b.querySelectorAll("span.k4w, canvas.k4wc, img"),d=0;c[d];){if(parseInt(c[d].id,10)>=a)return c[d];d++}return null},findElementAtOrBeforePosition:function(b,a){for(var c=b.querySelectorAll("span.k4w, canvas.k4wc, img"),d=null,e=0;c[e]&&parseInt(c[e].id,10)<=
a;)d=c[e],e++;return d},treeDepth:function(b){for(var a=0;b.parentNode;)a++,b=b.parentNode;return a},elementFromPoint:function(b,a,e){var h=KindleHostDeviceDetector.getDevicePlatform(),j=h&&h.match(d),h=h&&h.match(c)&&KindleHostDeviceDetector.isIE();return j||h?b.msElementsFromPoint(a,e)[0]:b.elementFromPoint(a,e)},isNumeric:function(b){return!isNaN(parseFloat(b))&&isFinite(b)},count:function(c,a,d){if(c){var e=b[c]||0;d||b[c]===void 0?b[c]=a:a&&(b[c]+=a);return e}}}}(),KindleRendererWordRectsHelper=
function(){function h(h,e,d){if(e)for(var c=e.length,b=0;b<c;b++)h.push({rect:e[b],dataNid:d})}return{createWordBoundaries:function(j,e,d,c,b){var f=[],a={},g=!1,k,m;for(m=j.start;m<=j.end;m+=1)if(e[m])if(e[m].rects)h(f,e[m].selectableRects||e[m].rects,e[m].dataNid),g=!0;else{var l=e[m];if(g||a[k]===void 0||a[k].dataNid!==l.dataNid||a[k].childIndex!==l.childIndex)a[m]={startOffset:l.startOffset,endOffset:l.endOffset,dataNid:l.dataNid,childIndex:l.childIndex},k=m;else{g=a[k].startOffset;if(g===void 0||
g>l.startOffset)a[k].startOffset=l.startOffset;g=a[k].endOffset;if(g===void 0||g<l.endOffset)a[k].endOffset=l.endOffset}g=!1}for(m in a){var g=j=a[m],n=d,e=c;k=b;l=n.querySelector("[data-nid='"+g.dataNid+"']").childNodes[g.childIndex];n=n.createRange();n.setStart(l,g.startOffset);n.setEnd(l,g.endOffset);g=n.getClientRects();n=void 0;e&&e.getComputedStyle&&(n=e.getComputedStyle(l.parentNode));e=k.getTransformedClientRects(g,l,n);h(f,e,j.dataNid)}return f}}}(),KindleRendererZoomableFixedContentFactory=
function(){function h(b,a){return b.data&&a.data?b.data.ordinal!==void 0&&a.data.ordinal!==void 0?b.data.ordinal-a.data.ordinal:b.data.ordinal===void 0&&a.data.ordinal===void 0?0:b.data.ordinal!==void 0?-1:1:!b.data&&!a.data?0:b.data?-1:1}function j(b,a){if(b.getBoundingClientRect){var c=b.getBoundingClientRect();if(c)return{top:c.top+a.y,right:c.right+a.x,bottom:c.bottom+a.y,left:c.left+a.x,width:c.width,height:c.height}}return null}function e(b){b.setActive=function(a){if(this.sourceElement){var b=
this.sourceElement.ownerDocument;if(b&&this.data.targetId){var c=$(b).find("#"+this.data.targetId),d=null;a?(this.data.sourceId&&(d=$(b).find("#"+this.data.sourceId),c.html().trim().length===0&&(a=d.clone(),a.css({visibility:"visible",color:"black"}),$(c).append(a)),d.hide()),c.show()):(c.hide(),this.data.sourceId&&(d=$(b).find("#"+this.data.sourceId),d.show()))}}};b.isSame=function(a){return a.internalComparison(this.sourceElement)};b.internalComparison=function(a){return this.sourceElement===a};
b.getBounds=function(){if(this.sourceElement){var a=this.sourceElement.ownerDocument;if(a&&this.data.targetId&&(a=$(a).find("#"+this.data.targetId),a.is(":visible"))){var b=a.children(".target-mag"),a=b.length===1?b:a;return j(a.get(0),this.origin)}return j(this.sourceElement,this.origin)}return null}}function d(b,a){b.activate=function(){return a.setActive(!0)};b.deactivate=function(){return a.setActive(!1)};b.isSame=function(b){return a.isSame(b)};b.getBounds=function(){return a.getBounds()};b.internalComparison=
function(b){return a.internalComparison(b)}}function c(c,a,d){c.origin=a;c.sourceElement=d;a=d.getAttribute(b);c.data=jQuery.parseJSON(a)}var b="data-app-amzn-magnify";return{buildList:function(b,a){for(var g=[],j=$(b).find(".app-amzn-magnify").get(),m=0;m<j.length;m++)try{var l={};c(l,a,j[m]);e(l);g.push(l)}catch(n){}g.sort(h);j=[];for(m=0;m<g.length;m++)l={},d(l,g[m]),j.push(l);return j},buildFromCoord:function(b,a,g,h){a:{for(b=KindleRendererUtils.elementFromPoint(b,g-a.x,h-a.y);b;){if($(b).hasClass("app-amzn-magnify")){g=
b;break a}b=b.parentNode}g=null}if(g)try{return b={},c(b,a,g),e(b),a={},d(a,b),a}catch(j){}return null}}}(),KindleRendererZoomableReflowableContentFactory=function(){function h(d){for(;d;){if(d.tagName==="IMG")return d;d=d.parentNode}return null}function j(d){d.clone=function(){if(this.sourceElement)return $(this.sourceElement).clone().get(0)};d.getBounds=function(){var c;if(this.sourceElement){var b=this.sourceElement;c=this.origin;c=b.getBoundingClientRect&&(b=b.getBoundingClientRect())?{top:b.top+
c.y,right:b.right+c.x,bottom:b.bottom+c.y,left:b.left+c.x,width:b.width,height:b.height}:null}else c=null;return c}}function e(d,c){d.clone=function(){return c.clone()};d.getBounds=function(){return c.getBounds()}}return{buildFromCoord:function(d,c,b,f){b-=c.x;f-=c.y;var a=KindleRendererUtils.elementFromPoint(d,b,f);if(a&&a.className.match(/amazon-highlight/)){var g=a;g.style.display="none";a=KindleRendererUtils.elementFromPoint(d,b,f);g.style.display="block"}if(b=h(a))try{return d={},d.origin=c,
d.sourceElement=b,j(d),c={},e(c,d),c}catch(k){}return null},buildFromElement:function(d,c){var b=h(d);if(b)try{var f={};f.origin=c;f.sourceElement=b;j(f);b={};e(b,f);return b}catch(a){}return null}}}(),KindleRendererZoomablesFactory=function(){return{buildList:function(h,j){return $(h.body).css("position")==="absolute"?KindleRendererZoomableFixedContentFactory.buildList(h,j):[]},buildFromCoord:function(h,j,e,d){return $(h.body).css("position")==="absolute"?KindleRendererZoomableFixedContentFactory.buildFromCoord(h,
j,e,d):KindleRendererZoomableReflowableContentFactory.buildFromCoord(h,j,e,d)}}}();_KReW_build_id="538ce3c6b5a1c0f1a24e08f9073628f9bd8265c1";
