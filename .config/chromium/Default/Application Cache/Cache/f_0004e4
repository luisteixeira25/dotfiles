/*
 * Copyright (c) 2014 Amazon.com, Inc. All rights reserved.
 */
(function(){var f=Handlebars.template,h=Handlebars.templates=Handlebars.templates||{};h.KindleLibraryAppCacheFailDialog=f(function(e,d,c,a,g){this.compilerInfo=[2,">= 1.0.0-rc.3"];var c=c||e.helpers,g=g||{},e="",b,j=c.helperMissing,k=this.escapeExpression;e+='<div id=\'kindle_dialog_appCacheFail\'>\n    <div class="box-top">&nbsp;</div>\n    <div class="content-container">\n        <div id="content">\n            <h2> ';a={hash:{},data:g};e+=k((b=c.str,b?b.call(d,"k_dialog_appCache_title_text",a):
j.call(d,"str","k_dialog_appCache_title_text",a)))+"</h2>\n            <p> ";a={hash:{},data:g};e+=k((b=c.str,b?b.call(d,"k_dialog_appCache_message_text",a):j.call(d,"str","k_dialog_appCache_message_text",a)))+' </p>\n            <div id="appCacheDialogFail_toggler" class="toggler"> \n                <span id="appCacheDialogFail_arrow" class="kindleLibrary_arrowClosed">\n                </span>\n                <span class = "boldText"> \n                  ';a={hash:{},data:g};e+=k((b=c.str,b?b.call(d,
"k_dialog_appCache_readmore_text",a):j.call(d,"str","k_dialog_appCache_readmore_text",a)))+" \n                </span>\n            </div>\n            <br/>\n            <div id=\"appCacheDialogFail_content\" style='display:none'>\n                    <span class='appCacheFail_label boldText'>";a={hash:{},data:g};e+=k((b=c.str,b?b.call(d,"k_dialog_appCache_step1_text",a):j.call(d,"str","k_dialog_appCache_step1_text",a)))+"</span> <span class='appCacheFail_field'>";a={hash:{},data:g};e+=k((b=c.str,
b?b.call(d,"k_dialog_appCache_instruction1_text",a):j.call(d,"str","k_dialog_appCache_instruction1_text",a)))+"</span><br/>\n                    <span class='appCacheFail_label boldText'>";a={hash:{},data:g};e+=k((b=c.str,b?b.call(d,"k_dialog_appCache_step2_text",a):j.call(d,"str","k_dialog_appCache_step2_text",a)))+"</span> <span class='appCacheFail_field'>";a={hash:{},data:g};e+=k((b=c.str,b?b.call(d,"k_dialog_appCache_instruction2_text",a):j.call(d,"str","k_dialog_appCache_instruction2_text",a)))+
"</span><br/>\n                    <span class='appCacheFail_label boldText'>";a={hash:{},data:g};e+=k((b=c.str,b?b.call(d,"k_dialog_appCache_step3_text",a):j.call(d,"str","k_dialog_appCache_step3_text",a)))+"</span> <span class='appCacheFail_field'>";a={hash:{},data:g};e+=k((b=c.str,b?b.call(d,"k_dialog_appCache_instruction3_text",a):j.call(d,"str","k_dialog_appCache_instruction3_text",a)))+"</span><br/>\n                    <span class='appCacheFail_label boldText'>";a={hash:{},data:g};e+=k((b=
c.str,b?b.call(d,"k_dialog_appCache_step4_text",a):j.call(d,"str","k_dialog_appCache_step4_text",a)))+"</span> <span class='appCacheFail_field'>";a={hash:{},data:g};e+=k((b=c.str,b?b.call(d,"k_dialog_appCache_instruction4_text",a):j.call(d,"str","k_dialog_appCache_instruction4_text",a)))+"</span><br/>\n                    <span class='appCacheFail_label boldText'>";a={hash:{},data:g};e+=k((b=c.str,b?b.call(d,"k_dialog_appCache_step5_text",a):j.call(d,"str","k_dialog_appCache_step5_text",a)))+"</span> <span class='appCacheFail_field'>";
a={hash:{},data:g};e+=k((b=c.str,b?b.call(d,"k_dialog_appCache_instruction5_text",a):j.call(d,"str","k_dialog_appCache_instruction5_text",a)))+'</span><br/><br/>\n           </div>\n        </div>\n    </div>\n    <div class="box-bottom">\n        <p>\n            <span class="primary_btn" id="kindle_appCacheDialog_button">';a={hash:{},data:g};e+=k((b=c.str,b?b.call(d,"k_dialog_appCache_button_text",a):j.call(d,"str","k_dialog_appCache_button_text",a)))+"</span>\n        </p>\n    </div>\n</div>";
return e});h.KindleLibraryBookContainer=f(function(e,d,c,a,g){this.compilerInfo=[2,">= 1.0.0-rc.3"];var c=c||e.helpers,g=g||{},e="",b=this.escapeExpression;e+='<div id="';(a=c.asin)?a=a.call(d,{hash:{},data:g}):(a=d.asin,a=typeof a==="function"?a.apply(d):a);e+=b(a)+'" class="book_container">\n    <div class="book_cover">\n        <img class="book_image book_click_area" src="';(a=c.src)?a=a.call(d,{hash:{},data:g}):(a=d.src,a=typeof a==="function"?a.apply(d):a);e+=b(a)+'" title="';(a=c.title)?a=a.call(d,
{hash:{},data:g}):(a=d.title,a=typeof a==="function"?a.apply(d):a);e+=b(a)+'">\n        <div class="alt_title book_click_area"></div>\n    </div>\n    <div class="book_details">\n        <div class="book_title book_click_area">';(a=c.title)?a=a.call(d,{hash:{},data:g}):(a=d.title,a=typeof a==="function"?a.apply(d):a);e+=b(a)+'</div>\n        <div class="book_author book_click_area">';(a=c.author)?a=a.call(d,{hash:{},data:g}):(a=d.author,a=typeof a==="function"?a.apply(d):a);e+=b(a)+"</div>\n    </div>\n</div>";
return e});h.KindleLibraryControlBar=f(function(e,d,c,a,g){this.compilerInfo=[2,">= 1.0.0-rc.3"];var c=c||e.helpers,g=g||{},e="",b,j,a=c.helperMissing,k=this.escapeExpression;e+='<div id="view_sort_size_controls">\n    <div id="view_toggle">\n        <div id="view_buttons">\n            <div id="view_grid" class="btn_set btn_set_left" value="grid" title=\'';j={hash:{},data:g};e+=k((b=c.str,b?b.call(d,"k_L_toolbar_grid_button",j):a.call(d,"str","k_L_toolbar_grid_button",j)))+'\'>\n                <div id="view_grid_icon" value="grid"></div>\n            </div>\n            <div id="view_list" class="btn_set btn_set_right" value="list" title=\'';
j={hash:{},data:g};e+=k((b=c.str,b?b.call(d,"k_L_toolbar_list_button",j):a.call(d,"str","k_L_toolbar_list_button",j)))+'\'>\n                <div id="view_list_icon" value="list"></div>\n            </div>\n        </div>\n    </div>\n    <div id="view_sort">\n        <div id="kindleLibrary_button_sort" class="btn_set btn_set_left btn_set_right" title=\'';j={hash:{},data:g};e+=k((b=c.str,b?b.call(d,"k_L_toolbar_sort_button",j):a.call(d,"str","k_L_toolbar_sort_button",j)))+'\'>\n            <div id="kindleLibrary_button_sort_label" style="display: inline">';
(j=c.sortParam)?j=j.call(d,{hash:{},data:g}):(j=d.sortParam,j=typeof j==="function"?j.apply(d):j);e+=k(j)+'</div>\n            <div id="kindleLibrary_button_sort_arrow"></div>\n        </div>\n    </div>\n    <div id="view_state">\n       <div id="view_state_buttons">\n        <div id="view_cloud"      class="btn_set btn_set_left" value="cloud"\n        title=\'';j={hash:{},data:g};e+=k((b=c.str,b?b.call(d,"k_L_toolbar_cloud_button",j):a.call(d,"str","k_L_toolbar_cloud_button",j)))+"'>";j={hash:{},
data:g};e+=k((b=c.str,b?b.call(d,"k_L_toolbar_cloud_label",j):a.call(d,"str","k_L_toolbar_cloud_label",j)))+'</div>\n        <div id="view_downloaded" class="btn_set btn_set_right"\n        value="downloaded" title=\'';j={hash:{},data:g};e+=k((b=c.str,b?b.call(d,"k_L_toolbar_downloaded_button",j):a.call(d,"str","k_L_toolbar_downloaded_button",j)))+"'>";j={hash:{},data:g};e+=k((b=c.str,b?b.call(d,"k_L_toolbar_downloaded_label",j):a.call(d,"str","k_L_toolbar_downloaded_label",j)))+'</div>\n       </div>\n       <div id="cache_state">\n            <div id="cache_icon">\n                <div id="kindleLibrary_cache_spinner" class="spinner">\n                    <div class="bar1"></div>\n                    <div class="bar2"></div>\n                    <div class="bar3"></div>\n                    <div class="bar4"></div>\n                    <div class="bar5"></div>\n                    <div class="bar6"></div>\n                    <div class="bar7"></div>\n                    <div class="bar8"></div>\n                    <div class="bar9"></div>\n                    <div class="bar10"></div>\n                    <div class="bar11"></div>\n                    <div class="bar12"></div>\n                </div>\n                <div id="cache_image"></div>\n            </div>\n            <span id="cache_message">';
j={hash:{},data:g};e+=k((b=c.str,b?b.call(d,"k_L_caching",j):a.call(d,"str","k_L_caching",j)))+"</span>\n       </div>\n    </div>\n</div>";return e});h.KindleLibraryHeaderBar=f(function(e,d,c,a,g){this.compilerInfo=[2,">= 1.0.0-rc.3"];var c=c||e.helpers,g=g||{},e="",b,j=c.helperMissing,k=this.escapeExpression;e+="<div id='page_header'>\n    <div id='kindleLibrary_kindleLogo'></div>\n    <div id='header_left' class='libraryControls'>\n\n        <div\n            id='kindleLibrary_button_notebook'\n            class='header_bar_icon'\n            btnLbl='";
a={hash:{},data:g};e+=k((b=c.str,b?b.call(d,"k_L_toolbar_notebook_button",a):j.call(d,"str","k_L_toolbar_notebook_button",a)))+"'\n            title='";a={hash:{},data:g};e+=k((b=c.str,b?b.call(d,"k_L_toolbar_notebook_button_tooltip",a):j.call(d,"str","k_L_toolbar_notebook_button_tooltip",a)))+"'\n        ></div>\n\n        <div\n            id='kindleLibrary_button_sync'\n            class='header_bar_icon'\n            btnLbl='";a={hash:{},data:g};e+=k((b=c.str,b?b.call(d,"k_L_toolbar_sync_button",
a):j.call(d,"str","k_L_toolbar_sync_button",a)))+"'\n            title='";a={hash:{},data:g};e+=k((b=c.str,b?b.call(d,"k_L_toolbar_sync_button_tooltip",a):j.call(d,"str","k_L_toolbar_sync_button_tooltip",a)))+"'\n        ></div>\n\n        <div\n            id='kindleLibrary_button_manage'\n            class='header_bar_icon'\n            btnLbl='";a={hash:{},data:g};e+=k((b=c.str,b?b.call(d,"k_L_toolbar_manage_button",a):j.call(d,"str","k_L_toolbar_manage_button",a)))+"'\n            title='";a=
{hash:{},data:g};e+=k((b=c.str,b?b.call(d,"k_L_toolbar_manage_button_tooltip",a):j.call(d,"str","k_L_toolbar_manage_button_tooltip",a)))+"'\n        ></div>\n\n    </div>\n\n    <div id='kindleLibrary_search' class='search libraryControls'>\n\n        <div\n            id='kindleLibrary_button_search'\n            class='search header_bar_icon large'\n            btnLbl='";a={hash:{},data:g};e+=k((b=c.str,b?b.call(d,"k_L_toolbar_search_button",a):j.call(d,"str","k_L_toolbar_search_button",a)))+"'\n            title='";
a={hash:{},data:g};e+=k((b=c.str,b?b.call(d,"k_L_toolbar_search_button_tooltip",a):j.call(d,"str","k_L_toolbar_search_button_tooltip",a)))+"'\n        ></div>\n\n        <input\n            id='kindleLibrary_bar_search'\n            disabled='disabled'\n            class='search'/>\n\n        <div\n            id='kindleLibrary_clear_search'\n            class='search'\n        ></div>\n\n    </div>\n\n   <div id='header_right' class='libraryControls'>\n        <div\n            class='kbtn header_bar_icon'\n            id='kindleLibrary_button_store'\n            btnLbl='";
a={hash:{},data:g};e+=k((b=c.str,b?b.call(d,"k_L_toolbar_store_button",a):j.call(d,"str","k_L_toolbar_store_button",a)))+"'\n            title='";a={hash:{},data:g};e+=k((b=c.str,b?b.call(d,"k_L_toolbar_store_button_tooltip",a):j.call(d,"str","k_L_toolbar_store_button_tooltip",a)))+"'\n        >\n                ";a={hash:{},data:g};e+=k((b=c.str,b?b.call(d,"k_L_toolbar_store_button",a):j.call(d,"str","k_L_toolbar_store_button",a)))+"\n        </div>\n    </div>\n\n    <div id='header_center'></div>\n</div>";
return e});h.KindleLibraryHomeScreenPopup=f(function(){this.compilerInfo=[2,">= 1.0.0-rc.3"];return'<div id="kindleAddToHomeScreen" class=\'ui-corner-all\'>\n    <div class="addToHomeIcon"></div>\n    <div class="arrow"></div>\n    <div class="addToHomeText"></div>\n</div>'});h.KindleLibraryImageSlider=f(function(e,d,c,a,g){this.compilerInfo=[2,">= 1.0.0-rc.3"];var c=c||e.helpers,g=g||{},e="",b,a=c.helperMissing,j=this.escapeExpression;e+='<div id="scaleHolder">\n<div class="kindleLibrary_scaleHolder" style="position: absolute" /> \n    <div id="view_scale">\n        <div id="kindleLibrary_coverImage_slider"\n        title=\'';
g={hash:{},data:g};e+=j((b=c.str,b?b.call(d,"k_L_toolbar_cover_slider",g):a.call(d,"str","k_L_toolbar_cover_slider",g)))+"'>\n        </div>\n    </div>\n</div>";return e});h.KindleLibraryJPMerchandiseContent=f(function(e,d,c,a,g){this.compilerInfo=[2,">= 1.0.0-rc.3"];var c=c||e.helpers,g=g||{},e="",b,j=this.escapeExpression,k=c.helperMissing;e+='<p class="kindleLibrary_jp_merchandise_message">';a={hash:{},data:g};e+=j((b=c.str,b?b.call(d,"k_L_jp_merchandise_dialog_message",a):k.call(d,"str","k_L_jp_merchandise_dialog_message",
a)))+'</p>\n<div id="kindleLibrary_jp_merchandise_scrollWrapper">\n    <div id="kindleLibrary_jp_merchandise_scrollPane">\n        ';if((d=c.each.call(d,d.bookList,{hash:{},inverse:this.noop,fn:this.program(1,function(b){var a="",c;a+='\n            <div class="book_container">\n                <img class="book_merch_image" src="'+j((c=b.imgUrl,typeof c==="function"?c.apply(b):c))+'" title="'+j((c=b.title,typeof c==="function"?c.apply(b):c))+'" data-asin="'+j((c=b.asin,typeof c==="function"?c.apply(b):
c))+'">\n            </div>\n        ';return a},g),data:g}))||d===0)e+=d;e+="\n    </div>\n</div>\n";return e});h.KindleLibraryJPMerchandiseDialog=f(function(e,d,c,a,g){this.compilerInfo=[2,">= 1.0.0-rc.3"];var c=c||e.helpers,g=g||{},e="",b,a=c.helperMissing,j=this.escapeExpression;e+='<div id="kindleLibrary_jp_merchandise_pane">\n    <div id="kindleLibrary_jp_merchandise_header">';g={hash:{},data:g};e+=j((b=c.str,b?b.call(d,"k_L_jp_merchandise_dialog_title",g):a.call(d,"str","k_L_jp_merchandise_dialog_title",
g)))+'</div>\n    <div id="kindleLibrary_jp_merchandise_content">\n    </div>\n</div>';return e});h.KindleLibraryMessagePane=f(function(e,d,c,a,g){this.compilerInfo=[2,">= 1.0.0-rc.3"];var c=c||e.helpers,g=g||{},e="",b,j=c.helperMissing,k=this.escapeExpression;e+='<div id=\'empty_library_messages\'>\n\t<div id="empty-lib-box"> \n\t\t<div id="empty-lib-msg"> \n\t\t\t<p class="title"> ';a={hash:{},data:g};e+=k((b=c.str,b?b.call(d,"k_empty_library_title",a):j.call(d,"str","k_empty_library_title",a)))+
' </p>\n\t\t\t<p class="main"></p> \n\t\t\t<p class="free">';a={hash:{},data:g};e+=k((b=c.str,b?b.call(d,"k_empty_library_free",a):j.call(d,"str","k_empty_library_free",a)))+' </p>\n            <p class="button"><span class="primary_btn">';a={hash:{},data:g};e+=k((b=c.str,b?b.call(d,"k_empty_library_shop",a):j.call(d,"str","k_empty_library_shop",a)))+'</span></p>\n\t\t\t<p class="legal">';a={hash:{},data:g};e+=k((b=c.str,b?b.call(d,"k_empty_library_legal",a):j.call(d,"str","k_empty_library_legal",
a)))+' </p>\n\t\t</div> \n\t</div>\n    <div id="empty_search_box">\n        <div id="empty_search_text"></div>\n        <div id="empty_search_detail"></div>\n    </div>\n</div>';return e});h.KindleLibraryNoDownloadedMessage=f(function(e,d,c,a,g){this.compilerInfo=[2,">= 1.0.0-rc.3"];var c=c||e.helpers,g=g||{},e="",b,j=c.helperMissing,k=this.escapeExpression;e+="<div id='kindleLibrary_noDownloadedMessage_div' class='kindleLibrary_noDownloadsMsg'>\n    <div class='kindleLibrary_noDownloadedTitle'>";
a={hash:{},data:g};e+=k((b=c.str,b?b.call(d,"k_noDownloadedBooks_title",a):j.call(d,"str","k_noDownloadedBooks_title",a)))+'</div>\n    <div class="kindleLibrary_noDownloadedToggle"> \n    \t<span class="kindleLibrary_noDownloadedArrow kindleLibrary_arrowClosed">\n\t\t</span>\n\t\t<span class="download-hdr"> \n\t\t\t';a={hash:{},data:g};e+=k((b=c.str,b?b.call(d,"k_noDownloadedBooks_showmore",a):j.call(d,"str","k_noDownloadedBooks_showmore",a)))+" \n\t\t</span>\n    </div>\n    <div class='kindleLibrary_noDownloadedContent' style='display:none'>\n\t\t<span class=\"download-txt\">\n\t\t\t";
a={hash:{},data:g};e+=k((b=c.str,b?b.call(d,"k_noDownloadedBooks_msg",a):j.call(d,"str","k_noDownloadedBooks_msg",a)))+"\n\t\t</span>\n\t</div>\n</div>";return e});h.KindleLibraryProgressDialog=f(function(e,d,c,a,g){this.compilerInfo=[2,">= 1.0.0-rc.3"];var c=c||e.helpers,g=g||{},e="",b,j=c.helperMissing,k=this.escapeExpression;e+="<div id='kindleLibrary_dialog_progress'>\n    <p id='kindleLibrary_dialog_progressTitle' class='kindle_dialog_title_text'>";a={hash:{},data:g};e+=k((b=c.str,b?b.call(d,
"k_L_progress_dialog_title",a):j.call(d,"str","k_L_progress_dialog_title",a)))+"</p>\n    <p id='kindleLibrary_dialog_progressMessage' class='kindle_dialog_text'>";a={hash:{},data:g};e+=k((b=c.str,b?b.call(d,"k_L_progress_dialog_message",a):j.call(d,"str","k_L_progress_dialog_message",a)))+"</p>\n\t<div id='kindleLibrary_progressbar_div'></div>\n</div>";return e});h.KindleLibraryScrollBar=f(function(){this.compilerInfo=[2,">= 1.0.0-rc.3"];return'<div id="kindleLibrarySliderBar">\n    <a id="kindleLibrarySliderUpArrow" class="library_slider_arrow"></a>\n    <div id="KindleLibrarySliderContainer">\n        <div id="KindleLibrarySliderDiv">\n            <div id="KindleLibraryProgress"></div>\n        </div>\n    </div>\n    <a id="kindleLibrarySliderDownArrow" class="library_slider_arrow"></a>\n</div>'});
h.KindleUnsupportedContentDialog=f(function(e,d,c,a,g){this.compilerInfo=[2,">= 1.0.0-rc.3"];var c=c||e.helpers,g=g||{},e="",b=c.helperMissing,j=this.escapeExpression;e+='<div id="unsupportedContent_dialog">\n    ';if((d=c["if"].call(d,d.isiPad,{hash:{},inverse:this.program(3,function(a,d){var e="",g,f;e+='\n        <div id="unsupportedContent_text"> \n            ';f={hash:{},data:d};if((f=(g=c.str,g?g.call(a,"k_L_text_me_widget_Text",f):b.call(a,"str","k_L_text_me_widget_Text",f)))||f===0)e+=f;
e+='\n        </div>\n        <div id="unsupportedContent_instruction">';f={hash:{},data:d};e+=j((g=c.str,g?g.call(a,"k_L_text_me_wdiget_Instruction",f):b.call(a,"str","k_L_text_me_wdiget_Instruction",f)))+'</div>\n        <div id="unsupportedContent_text_me_widget_wrapper"></div>\n    ';return e},g),fn:this.program(1,function(a,e){var d="",g,f;d+='\n        <div id="unsupportedContent_text"> \n            ';f={hash:{},data:e};if((f=(g=c.str,g?g.call(a,"k_L_text_me_widget_Text",f):b.call(a,"str",
"k_L_text_me_widget_Text",f)))||f===0)d+=f;d+=' \n        </div>\n        <a id="unsupportedContent_get_app_button" target="_blank" href="';(f=c.getAppLink)?f=f.call(a,{hash:{},data:e}):(f=a.getAppLink,f=typeof f==="function"?f.apply(a):f);d+=j(f)+'">';f={hash:{},data:e};d+=j((g=c.str,g?g.call(a,"k_text_me_widget_GetApp",f):b.call(a,"str","k_text_me_widget_GetApp",f)))+"</a>\n    ";return d},g),data:g}))||d===0)e+=d;e+="\n</div>";return e})})();
function KindleModuleManagerFactory(){function f(a,b){if(q[a])throw"Duplicate registration of module "+a;if(!b)throw"Module is not initialized with an object "+a;q[a]=b;o[a].resolve(b)}function h(a){if(q.hasOwnProperty(a))throw"Duplicate registration of module "+a;q[a]=void 0}function e(a,b){o[a]||(o[a]=new jQuery.Deferred);f(a,b)}function d(a,b){h(a);o[a]||(o[a]=new jQuery.Deferred);b(o[a]);o[a].done(function(b){f(a,b)})}function c(a,b){d(a,function(a){b.done(a.resolve).fail(a.reject)})}function a(a){o[a]||
(o[a]=new jQuery.Deferred);return o[a].promise()}function g(a){if(!q[a])throw"Trying to get uninitialized module "+a;return q[a]}function b(a){return q.hasOwnProperty(a)}function j(a,b){q[a]=b}function k(a){var b=q[a];return{done:function(a){a(b)},fail:function(){},when:function(a){a(b)}}}function m(a){for(var b={},c=0;c<a.length;c++)b[name]=q[a];return{done:function(a){a(b)},fail:function(){},when:function(a){a(b)}}}function l(){q={}}var p={CONSTANTS:"Constants",DB_CLIENT:"DBClient",RESOURCE_BUNDLE:"ResourceBundle",
METRICS_MANAGER:"metrics_manager",SERVICE_CLIENT:"ServiceClient",APP_REGISTRATION:"Registration",JOURNAL_MANAGER:"JournalManager",BOOK_METADATA:"book_metaData",BOOK_FRAGMAP:"book_fragmap",EMBEDDED_HOSTINTERFACE:"embeddedHostInterface",CONTENT_MIGRATION:"contentMigration",NETWORK:"network",LINK_URLS:"linkUrls"},q={},o={};return{CONSTANTS:p.CONSTANTS,DB_CLIENT:p.DB_CLIENT,RESOURCE_BUNDLE:p.RESOURCE_BUNDLE,METRICS_MANAGER:p.METRICS_MANAGER,SERVICE_CLIENT:p.SERVICE_CLIENT,APP_REGISTRATION:p.APP_REGISTRATION,
JOURNAL_MANAGER:p.JOURNAL_MANAGER,BOOK_METADATA:p.BOOK_METADATA,BOOK_FRAGMAP:p.BOOK_FRAGMAP,EMBEDDED_HOSTINTERFACE:p.EMBEDDED_HOSTINTERFACE,CONTENT_MIGRATION:p.CONTENT_MIGRATION,NETWORK:p.NETWORK,LINK_URLS:p.LINK_URLS,ERROR_CODE_CANCEL:"canceled",registerModule:e,registerModuleList:function(a){for(var b in a)e(b,a[b])},registerModuleWithInitializer:d,registerModuleWithDeferred:c,detachModule:function(a){var b=q[a],c=o[a];c&&!c.isResolved()&&c.reject("canceled");delete q[a];delete o[a];return b},getModule:a,
getModuleList:function(b){var c=new jQuery.Deferred,d,e=[];for(d=0;d<b.length;d++)e.push(a(b[d]));$.when.apply($,e).done(function(){var a,d={};for(a=0;a<b.length;a++)d[b[a]]=arguments[a];c.resolve(d)}).fail(c.reject);return c.promise()},getModuleSync:g,isModuleInitialized:function(a){return q[a]!==void 0},isModuleRegistered:b,switchToTestMode:function(){this.registerModuleTest=j;this.getModule=k;this.getModuleSync=g;this.getModuleList=m;this.clear=l;delete this.registerModuleWithDeferred;delete this.registerModuleWithInitializer},
define:function(d,e,g){if(!b(d)){var j=[],k=$.Deferred();c(d,k);e&&e.length&&e.forEach(function(b){j.push(b&&$.isFunction(b.promise)?b:a(b))});$.when.apply($,j).then(function(){var a;typeof g==="function"?(a=$.makeArray(arguments),a=g.apply(g,a)):a=g;a&&$.isFunction(a.promise)?a.then(k.resolve,function(){k.reject()}):k.resolve(a)},function(){k.reject()})}},require:function(b,c){$.isArray(b)||(b=[b]);var d,e,g=[];b.forEach(function(b){g.push(b&&$.isFunction(b.promise)?b:a(b))});c||(e=$.Deferred(),
d=e.promise());$.when.apply($,g).then(function(){var a=$.makeArray(arguments);c?c.apply(c,a):e.resolve.apply(e,a)},function(){e&&e.reject()});return d}}}
var KindleModuleManager=KindleModuleManagerFactory(),BookChunk=function(){var f=Object.freeze?function(c){return Object.freeze(c)}:function(c){return c},h=["fragment","glyph","skeleton","resource","locationMap"],e={};h.forEach(function(c){e[c]={}});e.resource.huge=!0;var d={types:f(h),properties:f(e),getId:function(c){if(c.fragmentMetadata!==void 0)return c.fragmentMetadata.id;else if(c.skeletonMetadata!==void 0)return c.skeletonMetadata.id;else if(c.glyphFragmentMetadata!==void 0)return c.glyphFragmentMetadata.id;
else if(c.metadata!==void 0)return c.metadata.id;else KindleAssert(!1,"Can't get id from book chunk: unrecognizable metadata.")}};h.forEach(function(c){d[c.toUpperCase()+"_TYPE"]=c});return f(d)}(),BookDownloadController=function(){function f(e){if(!this instanceof f)return new f(e);var d={downloading:!1,waiting:!1,total:0,remaining:0,scaleFactor:1};Object.defineProperty(this,"downloading",{get:function(){return d.downloading},set:function(a){d.downloading=!!a},enumerable:!0});Object.defineProperty(this,
"waiting",{get:function(){return d.waiting},set:function(a){d.waiting=!!a},enumerable:!0});Object.defineProperty(this,"total",{get:function(){return d.total},set:function(a){d.total=a},enumerable:!0});Object.defineProperty(this,"scaledTotal",{get:function(){return d.total*d.scaleFactor},enumerable:!0});Object.defineProperty(this,"remaining",{get:function(){return d.remaining},set:function(a){d.remaining=a},enumerable:!0});Object.defineProperty(this,"scaledRemaining",{get:function(){return d.remaining*
d.scaleFactor},enumerable:!0});Object.defineProperty(this,"scaleFactor",{get:function(){return d.scaleFactor},set:function(a){d.scaleFactor=a},enumerable:!0});var e=e||{},c;for(c in e)e[c]!==void 0&&e.hasOwnProperty(c)&&d.hasOwnProperty(c)&&(d[c]=e[c])}var h={glyph:7,resource:20,sidecar:10,valueFor:function(e){return h.hasOwnProperty(e)?h[e]:1}};return{create:function(e){function d(){function a(b){if(m[b].waiting)return m[b].waiting=!1,m[b].downloading=!0,m[b].start(),!0}var b=!1,c=!1,d=!1;BookChunk.types.forEach(function(a){b=
b||m[a].downloading;d=d||m[a].waiting});l.forEach(function(a){b=b||m[a].downloading;c=c||m[a].waiting});d?BookChunk.types.some(a):!b&&!c?(KindleDebug.log("done downloading"),k.resolve()):!b&&c&&l.some(a)}function c(b){var c=new $.Deferred;if(m[b].remaining<=0)return g(b),c.resolve();b=e.downloaders[b];b.addEventListener("onProgress",a);b.addEventListener("onCompleted",function(a){g(a);c.resolve()});b.addEventListener("onFailed",function(a,b,d){m[a].waiting=!1;j(b,d);c.reject()});b.start();return c.promise()}
function a(a,b){if(b!==m[a].remaining){m[a].remaining=b;var c=0,d=0;BookChunk.types.forEach(function(a){c+=m[a].scaledRemaining;d+=m[a].scaledTotal});l.forEach(function(a){c+=m[a].scaledRemaining;d+=m[a].scaledTotal});k.notify(c,d)}}function g(a){m[a].downloading=!1;m[a].waiting=!1;d()}function b(b){function c(){KindleDebug.log("Finished downloading sidecar: "+b);m[j].downloading=!1;a(j,0);d()}function g(c){KindleDebug.error("Error downloading sidecar '"+b+"': "+c);m[j].downloading=!1;a(j,0);d()}
var j="SC:"+b;l.push(j);m[j]=new f({scaleFactor:h.valueFor("sidecar"),total:1,remaining:1,waiting:!0});m[j].start=function(){KindleDebug.log("Downloading sidecar: "+b);e.sidecarManager.download(b).then(c,g)}}function j(a,b){a=a||Kindle.ERROR.CANCELLED;BookChunk.types.forEach(function(a){if(m[a].downloading)e.downloaders[a].cancel(),m[a].downloading=!1});k.reject(a,b)}var k=$.Deferred(),m={},l=[];BookChunk.types.forEach(function(a){m[a]=new f({scaleFactor:h.valueFor(a)})});return{startDownload:function(){var a=
e.downloadingContentProvider;$.when(a.getBookinfo(),a.computeCacheQuota(),KindleModuleManager.getModule(Kindle.MODULE.SidecarManager)).done(function(a){var g=a.context.cacheState||a.cacheState;if(g===Kindle.BookInfo.CachedState.CACHED||g===Kindle.BookInfo.CachedState.PINNED)k.resolve();else{var j={skeleton:(Number(a.fragmap.fragmentMetadata.numberOfSkeletons)||1)-1,fragment:Number(a.fragmap.fragmentMetadata.numberOfFragments)-1,glyph:(Number(a.metadata.numOfGlyphFragments)||0)-1,resource:a.manifest&&
a.manifest.resourceManifest?Number(Math.max.apply(Math,Object.keys(a.manifest.resourceManifest))):-1,locationMap:a.metadata.locationsInfo&&a.metadata.locationsInfo.numOfLocations?Math.floor((Number(a.metadata.locationsInfo.numOfLocations)-1)/Number(a.metadata.locationsInfo.mapSize)):-1};BookChunk.types.forEach(function(a){var b=e.downloaders[a];b.init(j[a],e.fast);m[a].waiting=!0;m[a].remaining=m[a].total=b.getNumIds();m[a].start=function(){c(a)}});Object.keys(e.sidecarManager.names).forEach(b);d()}})},
failDownload:j,cancelDownload:j,pauseDownload:function(){BookChunk.types.forEach(function(a){m[a].downloading&&e.downloaders[a].pause()})},resumeDownload:function(){BookChunk.types.forEach(function(a){m[a].downloading&&e.downloaders[a].resume()})},whenDownloadComplete:function(){return k.promise()}}}}}();
function KindleBookDownloaderFactory(f){var h=5E3,e=0,d=1E3,c=$.Deferred().resolve(),a={};f.downloader=a;a.type=f.type;a.cache=f.cache;a.throttle=f.throttle;a.readAheadActive=!1;a.readAheadPauseCount=0;a.dbPutter=f.dbPutter;a.dbGetIdList=f.dbGetIdList;a.dbOosHandler=f.dbOosHandler;a.dbCheckCache=f.dbCheckCache;a.dbIsCached=f.dbIsCached;a.dbIsOos=f.dbIsOos;a.netGetter=f.netGetter;a.urlGetter=f.urlGetter;a.fileGetter=f.fileGetter;a.fileProgress=f.fileProgress;a.downloadError=f.downloadError;a.isIdRequired=
f.isIdRequired||function(){return!0};a.numIds=0;a.pauseReadAhead=function(){this.readAheadPauseCount++};a.resumeReadAhead=function(){this.readAheadPauseCount=Math.max(0,--this.readAheadPauseCount)};a.setNextId=function(a){if(a!==void 0&&this.readAheadActive)this.nextReadAheadId=a};a.removeIdFromReadAhead=function(a){if(this.readAheadActive){var b;for(b=0;b<this.readAheadIds.length;b++)if(this.readAheadIds[b]===a){this.readAheadIds.splice(b,1);break}for(b=0;b<this.readAheadUrls.length;b++)if(this.readAheadUrls[b].id===
a){this.readAheadUrls.splice(b,1);break}}};a.freeDbSpace=function(){var a=this;if(c&&c.state()==="pending")return c.promise();c=new $.Deferred;a.dbCheckCache();a.dbOosHandler(c.resolve,function(){if(a.readAheadActive)a.readAheadActive=!1,a.dbIsOos();c.reject()});return c.promise()};a.isStillActive=function(a){return!this.readAheadActive||this.readAheadGeneration!==a?!1:!0};a.readAheadOne=function(a){function b(){l.isStillActive(a)&&(l.numReadAheadNetRequests--,l.readAheadUrls.length===0?l.numReadAheadNetRequests===
0&&setTimeout(function(){l.getReadAheadUrls(a)},l.interReadWait):setTimeout(function(){l.readAheadOne(a)},l.interReadWait))}function d(a){var b=l.numReadAhead,a=a&&(a.data||JSON.stringify(a)).length||0,c=Math.max(Date.now()-f,1),c=(a/c*1E3).toFixed(),e=l.readAheadThroughput;a>4E4&&(e=(l.readAheadThroughput*0.8+c*0.2).toFixed(),c>1E5?b=Math.min(b+1,l.maxReadAhead):c<1E4&&(b=Math.max(b-1,1)));b>l.numReadAhead?l.numReadAheadIncreased++:b<l.numReadAhead&&l.numReadAheadDecreased++;l.highestReadAhead=Math.max(l.highestReadAhead,
b);l.numReadAhead=b;l.readAheadThroughput=e}function e(c,k){if(l.isStillActive(a)){if(k==="timeout")l.throttle?d(null):l.numReadAhead>1&&l.numReadAhead--;else if(k==="error"&&KindleModuleManager.getModuleSync(KindleModuleManager.NETWORK).isOnline()===!1){l.downloadError(Kindle.ERROR.NETWORK,Kindle.ERROR_CODE.OFFLINE);l.readAheadActive=!1;return}b()}}function m(e){function k(){l.isStillActive(a)&&(l.readAheadRemaining--,l.fileProgress(l.readAheadRemaining),b())}function m(d){function e(){if(l.readAheadActive)l.readAheadActive=
!1,l.dbIsOos();c.reject()}function j(){l.readAheadActive&&(KindleHostDeviceDetector.isIE()||l.dbPutter(p,k,e),k())}l.isStillActive(a)&&(d=d||{},!(d.code===Kindle.DB.CONSTRAINT_ERR||d.message==="constraint failed")&&d.code===Kindle.DB.QUOTA_ERR?l.freeDbSpace().then(j):b())}if(l.isStillActive(a)){l.throttle&&d(e);var f=BookChunk.getId(e),p=[];p[f]=e;$.when(c).then(function(){l.dbPutter(p,k,m)})}}var l=this,f=Date.now();if(l.isStillActive(a))if(l.readAheadStillAlive++,this.readAheadPauseCount>0)setTimeout(function(){l.readAheadOne(a)},
l.startReadWait);else if(l.readAheadUrls.length===0&&l.numReadAheadNetRequests===0)l.getReadAheadUrls(a);else for(;l.numReadAheadNetRequests<l.numReadAhead&&l.readAheadUrls.length>0;){l.numReadAheadNetRequests++;var q=l.readAheadUrls.shift();l.fileGetter(q,m,e)}};a.getReadAheadUrls=function(a){function b(b){e.readAheadUrls=b;setTimeout(function(){e.isStillActive(a)&&e.readAheadOne(a)},e.interReadWait)}function c(){e.downloadError(Kindle.ERROR.NETWORK,Kindle.ERROR_CODE.NO_URL)}function d(){if(e.dbCheckCache())e.getReadAheadUrls(a);
else if(e.isStillActive(a))e.readAheadActive=!1,e.dbIsOos()}var e=this;if(e.isStillActive(a))if(e.dbCheckCache()){e.readAheadStillAlive++;for(var l=[],f=0;f<e.readAheadIds.length&&e.readAheadIds[f]<e.nextReadAheadId;)f++;f===e.readAheadIds.length&&(f=0);l=e.readAheadIds.splice(f,e.numReadAheadUrls);l.length===0?e.refreshReadAheadList(a):(e.nextReadAheadId=f<e.readAheadIds.length?e.readAheadIds[f]:0,e.urlGetter(l,b,c))}else e.freeDbSpace().then(d)};a.refreshReadAheadList=function(c){function b(b){function e(){d.readAheadActive&&
d.getReadAheadUrls(c)}if(d.readAheadActive){var j=f.createSubTimer("success");d.readAheadStillAlive++;var h,n=[];for(h in b)n[b[h]]=!0;d.readAheadIds=[];for(h=0;h<=d.maxReadAheadId;h++)!n[h]&&a.isIdRequired(h)&&d.readAheadIds.push(h);j.addCount("needed",d.readAheadIds.length);j.addCount("total",d.maxReadAheadId+1);j.endTimer();f.endTimer();f.log();if(d.readAheadIds.length>0){if(d.readAheadRemaining=d.readAheadIds.length,d.readAheadRemaining!==d.readAheadRemainingPrev)d.readAheadRemainingPrev=d.readAheadRemaining,
setTimeout(e,d.startReadWait)}else d.readAheadActive=!1,d.dbIsCached()}}function e(){f.endTimer();d.downloadError(Kindle.ERROR.UNKNOWN_DB_ERROR)}var d=this;if(c===this.readAheadGeneration){var f;this.readAheadActive&&(f=KindleMetricsProfiler("bookDownloader.getIdList"),this.dbGetIdList(b,e))}};a.readAheadWatchdog=function(){var a=this;if(this.readAheadActive){if(this.readAheadStillAlive===0&&(this.readAheadPauseCount===0||this.readAheadGeneration===0))this.readAheadGeneration++,this.readAheadRemaining<
this.generationReadAheadRemaining?(this.numReadAheadNetRequests=0,this.generationReadAheadRemaining=this.readAheadRemaining,this.readAheadRemainingPrev=this.readAheadRemaining+1,this.watchDogTimeout=3E4,this.refreshReadAheadList(this.readAheadGeneration)):this.timeoutRetry?(this.generationReadAheadRemaining=this.readAheadRemaining+1,this.watchDogTimeout=12E4):this.downloadError(Kindle.ERROR.TIMEOUT);setTimeout(function(){a.readAheadWatchdog()},this.watchDogTimeout)}this.readAheadStillAlive=0};a.initialize=
function(c,b){if(this.cache){this.fastest=b;this.readAheadUrls=[];this.readAheadIds=[];this.numReadAheadNetRequests=this.nextReadAheadId=0;this.maxReadAheadId=c;this.readAheadActive=!0;this.readAheadGeneration=this.readAheadStillAlive=0;this.watchDogTimeout=3E4;for(var j=this.numIds=0;j<=c;j++)a.isIdRequired(j)&&this.numIds++;this.readAheadRemaining=this.numIds+1;this.readAheadRemainingPrev=this.readAheadRemaining+1;this.generationReadAheadRemaining=this.numIds+2;this.fastest?(this.startReadWait=
this.interReadWait=this.startReadAheadWait=0,this.numReadAhead=8,this.numReadAheadUrls=200):(this.startReadAheadWait=h,this.interReadWait=e,this.startReadWait=d,this.numReadAhead=4,this.numReadAheadUrls=20,this.timeoutRetry=!0);if(this.throttle)this.maxReadAhead=this.numReadAhead,this.highestReadAhead=1,this.numReadAheadDecreased=this.numReadAheadIncreased=0,this.numReadAhead=1,this.readAheadThroughput=0,this.numReadAheadUrls=40;this.debugCounter=15}else this.readAheadActive=!1;this.initialized=!0};
a.startReadAhead=function(){var a=this;KindleAssert(a.initialized,"Failed to call initialize before startReadAhead");a.cache?setTimeout(function(){a.readAheadWatchdog()},a.startReadAheadWait):a.readAheadActive=!1};a.cancelReadAhead=function(){this.readAheadActive=!1;this.readAheadGeneration=-1;this.readAheadIds=this.readAheadUrls=null};a.setReadAheadTimersForTestMode=function(){d=e=h=0};return a}
function KindleReaderBookInfoProviderFactory(){var f="book_context",h="book_metaData",e="book_manifest",d="book_key",c="book_fragmap",a="book_ok_to_download",g="book_skeleton_builder",b="book_resource_urls";return{BookInfo:function(j,k){function m(a,b){ka&&ka(b-a,b)}function l(){var a=new jQuery.Deferred;KindleLibraryBookCover.getOfflineCover(T).then(function(b){s.getModuleSync(KindleModuleManager.DB_CLIENT).getBookDb().getTable("covers").insertRecord({asin:T,coverData:b}).then(a.resolve,a.reject)},
a.reject);return a.promise()}function p(a){function b(){var c=s.getModuleSync(f);C.updateBookinfo({cacheState:a,context:c}).then(d.resolve,d.reject)}function c(){d.reject(Kindle.ERROR.NETWORK,Kindle.ERROR_CODE.CACHED_STATE)}var d=new jQuery.Deferred;D().done(function(){var e;s.isModuleInitialized(f)?(e=s.getModuleSync(f),e.isSample?b():(e={asin:T,kindleSessionId:e.kindleSessionId,isOffline:a===Kindle.BookInfo.CachedState.PINNED},s.getModuleSync(s.SERVICE_CLIENT).setOfflineStatus(e).then(b,c))):d.reject()});
return d.promise()}function q(){U&&(U.endTimer(),U.log(),U=null);var a=F!==ga&&F!==Kindle.BookInfo.CachedState.PINNED?p(ga):!0;$.when(a).then(function(){l().then(R.resolve,R.resolve)},function(a){a===Kindle.ERROR.NETWORK?R.reject(a,Kindle.ERROR_CODE.CACHED_STATE):R.reject(Kindle.ERROR.UNKNOWN_DB_ERROR)});var b=[];if(a=y.getBookType())b.push("::"+a),a===Kindle.BookInfo.BookType.MOBI8&&(y.isContentScrambled()===!0?b.push("::mobi8::scrambled"):y.isContentScrambled()===!1&&b.push("::mobi8::unscrambled"));
C.getBookStatistics().then(function(a){N&&(a.fragments!==void 0&&(v.increaseSubCounter(N,"fragmentCount",a.fragments.count),v.increaseSubCounter(N,"fragmentsSize",a.fragments.size)),a.glyphs!==void 0&&(v.increaseSubCounter(N,"glyphCount",a.glyphs.count),v.increaseSubCounter(N,"glyphsSize",a.glyphs.size)),v.endMetrics(N,b))},function(){N&&v.endMetrics(N,b)})}function o(){function a(){KindleModuleManager.getModuleSync(Kindle.MODULE.DB_CLIENT).removeEventListener(Kindle.ERROR.DB_LINGERING_WRITE,c);q()}
function b(a){KindleModuleManager.getModuleSync(Kindle.MODULE.DB_CLIENT).removeEventListener(Kindle.ERROR.DB_LINGERING_WRITE,c);R.reject(a)}function c(a){a.type===Kindle.ERROR.DB_LINGERING_WRITE&&(a.stalled?K.downloadController.pauseDownload():K.downloadController.resumeDownload())}K.downloadController?(KindleModuleManager.getModuleSync(Kindle.MODULE.DB_CLIENT).addEventListener(Kindle.ERROR.DB_LINGERING_WRITE,c),K.downloadController.startDownload(),K.downloadController.whenDownloadComplete().then(a,
b,[m,R.progress])):ca?b():R.reject(Kindle.CACHING.DISABLED)}function n(){if(!s.isModuleRegistered(c)){v.startSubTimer(J,"getFragMap");var a=H.getFragmap();a.done(function(){v.endSubTimer(J,"getFragMap")});s.registerModuleWithDeferred(c,a)}return s.getModule(c)}function r(a){var b;a.cpr!==void 0&&(b={},KindleCompression.lzAddStringsToDictionary(a.cpr,b),KindleCompression.lzAddNumbersToDictionary(b),ba=KindleCompression.lzGetDecompressionDictionary(b));a.cprJson!==void 0&&(b={},KindleCompression.lzAddStringsToDictionary(a.cprJson,
b,256),KindleCompression.lzAddNumbersToDictionary(b,256),ha=KindleCompression.lzGetDecompressionDictionary(b))}function t(){function a(b){H.getMetadata().then(function(a){v.endSubTimer(J,"getMetadata");r(a);b.resolve(a)},b.reject)}s.isModuleRegistered(h)||(v.startSubTimer(J,"getMetadata"),s.registerModuleWithInitializer(h,a));return s.getModule(h)}function u(){if(!s.isModuleRegistered(e)){v.startSubTimer(J,"getManifest");var a=H.getManifest();a.done(function(){v.endSubTimer(J,"getManifest")});s.registerModuleWithDeferred(e,
a)}return s.getModule(e)}function G(){var a,b;b={resource:{isIdRequired:function(b){return b in a}}};var c={bookinfo:y,moduleManager:s,contentCache:C,kcrFree:j.kcrFree};P=s.getModuleSync(Kindle.MODULE.SidecarManager).create(c);H=NetworkContentProvider.create({context:s.getModuleSync(f),bookInfo:y,asin:T});u().done(function(b){a=b.resourceManifest||{}});ca?(b={asin:T,source:H,cache:C,tweaks:b,readAheadAgressively:la,sidecarManager:P},K=I=DownloadingContentProvider.create(b),KindleLocalStorage.getItem(Kindle.CACHING.CACHING)!==
Kindle.CACHING.ENABLED&&(v.emit([{name:z.ENABLED,params:{breakdown:["Browser"]}}]),KindleLocalStorage.setItem(Kindle.CACHING.CACHING,Kindle.CACHING.ENABLED))):(K=H,KindleLocalStorage.getItem(Kindle.CACHING.CACHING)!==Kindle.CACHING.DISABLED&&(v.emit([{name:z.DISABLED,params:{breakdown:["Browser"]}}]),KindleLocalStorage.setItem(Kindle.CACHING.CACHING,Kindle.CACHING.DISABLED)));$.when(u(),n()).done(function(a,b){ContentPrefetchOptimizations.modify(K,a,b);x();B()})}function x(){function a(b){s.getModuleList([h,
e]).done(function(a){a=KindleBookSkeletonBuilderFactory(K[BookChunk.SKELETON_TYPE],K[BookChunk.RESOURCE_TYPE],a[e],ba);v.endSubTimer(J,"getSkeletonBuilder");b.resolve(a)}).fail(b.fail)}s.isModuleRegistered(g)||(v.startSubTimer(J,"getSkeletonBuilder"),s.registerModuleWithInitializer(g,a))}function B(){function a(b){s.getModule(e).done(function(a){a=KindleBookResourceUrlTranslator(K[BookChunk.RESOURCE_TYPE],a,y);v.endSubTimer(J,"getResourceUrlTranslator");b.resolve(a)}).fail(b.fail)}s.isModuleRegistered(b)||
(v.startSubTimer(J,"getResourceUrlTranslator"),s.registerModuleWithInitializer(b,a))}function D(){function a(b){var g=b.context&&b.metadata&&b.fragmap?b:null;if(b.cacheState){F=b.cacheState;if(F===Kindle.BookInfo.CachedState.PINNING)ga=Kindle.BookInfo.CachedState.PINNED;Kindle.BookInfo.CachedState.isFullyDownloaded(F)&&s.registerModule(d,!0)}b.context!==void 0&&s.registerModule(f,b.context);b.metadata!==void 0&&(r(b.metadata),s.registerModule(h,b.metadata));b.manifest!==void 0?s.registerModule(e,
b.manifest):s.registerModule(e,{});b.fragmap!==void 0&&s.registerModule(c,b.fragmap);da.resolve(g)}function b(a){function c(){window.location.reload(!0)}a&&a.code===Kindle.DB.DATABASE_ERR&&a.message.indexOf("no such table")>=0&&v.emit("App::DatabaseGoneOnGetBookInfo",{breakdown:["Browser"]}).then(c,c);da.resolve()}if(!da){da=new jQuery.Deferred;if(j.contentProvider)C=j.contentProvider;else{var g=s.getModuleSync(s.DB_CLIENT);g.getBookDb()&&(g=g.getBookDb().BookInfoDB(T),C=DatabaseContentCache.create({bookinfoDb:g,
asin:T}))}C?C.queryBookinfo().then(a,b):(ca=!1,b())}return da.promise()}function w(){N=v.startMetrics("BookDownload::Reading",{breakdown:["Browser"]});s.getModuleList([f,h,e,c,a]).done(function(a){var b=$.extend({},a[f]);delete b.kindleSessionId;a={metadata:a[h],manifest:a[e],fragmap:a[c],context:b,cacheState:S};ca?(I.putBookinfo(a),KindleLocalStorage.getItem(Kindle.CACHING.CACHING)!==Kindle.CACHING.ENABLED&&(v.emit([{name:z.ENABLED,params:{breakdown:["Browser"]}}]),KindleLocalStorage.setItem(Kindle.CACHING.CACHING,
Kindle.CACHING.ENABLED))):KindleLocalStorage.getItem(Kindle.CACHING.CACHING)!==Kindle.CACHING.DISABLED&&(v.emit([{name:z.DISABLED,params:{breakdown:["Browser"]}}]),KindleLocalStorage.setItem(Kindle.CACHING.CACHING,Kindle.CACHING.DISABLED))})}function A(k){function l(a){var j,k=new jQuery.Deferred,m=v.createTimer();if(a)F=Kindle.BookInfo.CachedState.PARTIAL,j=Kindle.ERROR.FORCE_DELETE;else if(F===Kindle.BookInfo.CachedState.PINNED)S=F=Kindle.BookInfo.CachedState.PINNING,ga=Kindle.BookInfo.CachedState.PINNED,
j=Kindle.ERROR.PINNED_CONTENT_UPGRADE;else if(F===Kindle.BookInfo.CachedState.CACHED)F=Kindle.BookInfo.CachedState.PARTIAL,j=Kindle.ERROR.CONTENT_UPGRADE;(C?C.deleteBooksData():$.Deferred().resolve()).fail(k.reject).done(function(){s.detachModule(d);s.detachModule(c);s.detachModule(h);s.detachModule(e);s.detachModule(f);s.detachModule(g);s.detachModule(b);r=null;m.emit(a?"BookDownload::ForceDelete":"BookDownload::ContentUpgrade");k.resolve(j)});return k.promise()}function m(b){function g(){var k;
if(b.downloadRestrictionReason)V=b.downloadRestrictionReason.reasonCode,X=b,O.reject(y);else{k=ja.createSubTimer("finishStartReading");j.contentProvider&&j.contentProvider.initMetadata({version:b.contentVersion,acr:b.formatVersion});if(s.isModuleInitialized(f)){var l=s.getModuleSync(f),m=!1;if(l.originType==="FreeTrial"&&l.expirationDate!==b.expirationDate)l.expirationDate=b.expirationDate,m=!0;if(l.contentVersion===b.contentVersion&&l.lastPageReadData&&b.lastPageReadData&&l.lastPageReadData.position!==
b.lastPageReadData.position)l.lastPageReadData=b.lastPageReadData,m=!0;if(l.isOwned===void 0)l.isOwned=b.isOwned!==void 0?b.isOwned:!0,m=!0;if(l.contentType===void 0)l.contentType=b.contentType||(l.isSample?Kindle.CONTENT_TYPE.EBSP:Kindle.CONTENT_TYPE.EBOK),m=!0;m&&C.updateBookinfo({context:l});l.kindleSessionId=b.kindleSessionId;X=l}else X=b,s.registerModule(f,b);if(b.originType==="FreeTrial"&&(KindleBadging.pushAsinForBadgeUpdate(y.getAsin()),b.expirationDate<=Date.now())){V=Kindle.ERROR.FREE_TRIAL_EXPIRED;
O.reject(y);return}if(b.contentType===Kindle.CONTENT_TYPE.EBSP)!W&&!b.isOwned&&(ca=!1,C=null),s.isModuleInitialized(d)||s.registerModule(d,!0);else if(j.isSample){k.endTimer();ja.endTimer();ja.log();V=Kindle.ERROR.UNKNOWN_ERR;O.reject(y);return}b.contentChecksum&&!s.isModuleInitialized(d)&&s.registerModule(d,b.contentChecksum);r||(B=!0,G(),w());$.when(t(),u(),n()).done(function(){k.endTimer();k=ja.createSubTimer("resolve");O.resolve(y);k.endTimer();ja.endTimer();ja.log()}).fail(function(){V=Kindle.ERROR.OPEN_BOOK_LOAD_FAILURE;
O.reject(y)});P.getPageNumbers().done(function(a){a&&(Y=a,Y.arePageNumbersAvailable()&&typeof KindleReaderUI!=="undefined"&&KindleReaderUI.initializePageNumbers(Y))});s.getModuleList([f,h,e,c,a]).done(o).fail(R.reject)}}M=!0;A.endTimer();v.endSubTimer(J,"StartReading");var k=r&&b.contentVersion&&b.contentVersion!==r.context.contentVersion,p=r&&b.formatVersion&&b.formatVersion!==r.context.formatVersion,q=b.downloadRestrictionReason&&b.downloadRestrictionReason.reasonCode,q=q===Kindle.ERROR.CONTENT_LOAN_ENDED||
q===Kindle.ERROR.CONTENT_RENTAL_EXPIRED;Z=k||p;k||p||q?l(q).then(g,function(a){V=a;O.reject(y)}):g()}function p(a){M=!1;v.endSubTimer(J,"StartReading");r?(X=r.context,O.resolve(y)):(V=a,O.reject(y));Kindle.BookInfo.CachedState.isFullyDownloaded(F)?(P.getPageNumbers().done(function(a){a&&(Y=a,Y.arePageNumbersAvailable()&&typeof KindleReaderUI!=="undefined"&&KindleReaderUI.initializePageNumbers(Y))}),R.resolve()):R.reject(Kindle.ERROR.NETWORK,Kindle.ERROR_CODE.START_READING)}function q(a){x.endTimer();
r=a;v.endSubTimer(J,"CheckDB");v.startMetrics("Reader::StartReading");A=ja.createSubTimer("startReading");a=$.extend({asin:T},j);if(r&&r.context&&F===Kindle.BookInfo.CachedState.PINNED)a.kindleSessionId=r.context.kindleSessionId;v.startSubTimer(J,"MetadataLoaded");O.always(function(){v.endSubTimer(J,"MetadataLoaded");v.renameSubTimer(J,"MetadataLoaded","MetadataLoaded::"+(B?"RemoteContent":"LocalContent"))});v.startSubTimer(J,"StartReading");H=Q(a);r&&G();H.then(m,p)}var r,ja,x,A,H;R=new jQuery.Deferred;
J=k;ja=KindleMetricsProfiler("bookInfo.startReading");x=ja.createSubTimer("getInfoFromDB");v.startSubTimer(J,"CheckDB");if(j.kcrFree==="only")j.isSample=!0;var B=!1;j.isSample&&!W?(ca=!1,q(null)):D().done(q);return O.promise()}var z={DISABLED:"Book::Caching::Disabled",ENABLED:"Book::Caching::Enabled"},H=null,C=null,I=null,P=null,K=null,N,O=$.Deferred(),y,T=j.asin,W=j.cacheSample,s=k||KindleModuleManager,v=s.getModuleSync(s.METRICS_MANAGER),Z,aa=null,Y=null,da=null,F=null,ba=null,ha=null,ca=!0,R=null,
ka=null,ga=Kindle.BookInfo.CachedState.CACHED,la=!1,S=Kindle.BookInfo.CachedState.PARTIAL,U=null,J=null,M,V,X,ia=!1,L=!1,Q=function(a){var b=new jQuery.Deferred;s.getModuleSync(s.SERVICE_CLIENT).startReading(a).pipe(function(b){var c=b.downloadRestrictionReason&&b.downloadRestrictionReason.reasonCode,d=[Kindle.ERROR.CONTENT_LOANED,Kindle.ERROR.CONTENT_LOAN_ENDED,Kindle.ERROR.CONTENT_LICENSE_EXCEEDED,Kindle.ERROR.CONTENT_RENTAL_EXPIRED,Kindle.ERROR.SESSION_LIMIT_EXCEEDED];return a.kcrFree&&b&&b.contentType!==
Kindle.CONTENT_TYPE.EBSP&&d.indexOf(c)>=0?(a.isSample=!0,s.getModuleSync(s.SERVICE_CLIENT).startReading(a)):b}).pipe(function(c){var d=c.isSample||!1;if(c.isOwned===void 0)c.isOwned=!d;if(c.contentType===void 0)c.contentType=d?Kindle.CONTENT_TYPE.EBSP:Kindle.CONTENT_TYPE.EBOK;if(a.kcrFree)c.kcrFree=!0;b.resolve(c)},function(){b.reject("timeout")});return b.promise()};return y={getBookInfoDfd:function(){return O.promise()},getAsin:function(){return T},getRefEmId:function(){var a=s.getModuleSync(h);
return a.refEmId||a.referenceEmbeddedId||a.guid},isOpenedOnline:function(){return M},getOpenError:function(){return V},getContext:function(){return X},startReading:function(b,c){s.registerModuleWithDeferred(a,c);return A(b)},doneReading:function(){K.close(Kindle.ERROR.USER_CLOSED_BOOK)},getImageBaseUrl:function(){return s.getModuleSync(f).imageBaseUrl+"/"},getKindleSessionId:function(){return s.getModuleSync(f).kindleSessionId},getFragmentMap:function(a,b){setTimeout(function(){s.getModule(c).then(a,
b)},15)},getBookType:function(){return s.getModuleSync(c).fragmentMetadata.bookType},getBookSkeleton:function(a,b,c){s.getModule(g).then(function(d){d.buildSkeleton(c).then(a,b)},b)},getBookFragments:function(a,b,c){K[BookChunk.FRAGMENT_TYPE].getChunks(c,function(b){if(b.fragmentMetadata.compression===1||b.fragmentMetadata.compression===2){b.fragmentData=KindleCompression.lzExpandWithStaticDictionary(b.fragmentData,ba);if(b.paraData!==void 0&&typeof b.paraData==="string"){var c=KindleCompression.lzExpandWithStaticDictionary(b.paraData,
ha,256);b.paraData=JSON.parse(c)}delete b.fragmentMetadata.compression}a(b)},b)},getGlyphFragments:function(a,b,c){K[BookChunk.GLYPH_TYPE].getChunks(c,function(b){if(b.glyphFragmentMetadata.compression===1||typeof b.glyphData==="string"){var c=KindleCompression.lzExpandWithStaticDictionary(b.glyphData,ha,256);b.glyphData=JSON.parse(c);delete b.glyphFragmentMetadata.compression}a(b)},b)},getMetadata:function(a,b){return s.getModule(h).then(a,b)},getResourceUrls:function(a,c,d){s.getModule(b).then(function(b){b.getResourceUrls(d,
a,c)},c)},UNKNOWN_FPR:-1,getFurthestPositionReadData:function(){return s.getModuleSync(f).lastPageReadData||{}},getLocationConverter:function(){function a(b){var c=jQuery.Deferred();K[BookChunk.LOCATIONMAP_TYPE].getChunks([b],c.resolve,c.reject);return c}if(aa===null){var b={},d=s.getModuleSync(c),e=s.getModuleSync(h);b.locationsInfo=e.locationsInfo;b.minPosition=d.fragmentArray[0].cPos;b.maxPosition=d.fragmentArray[d.fragmentArray.length-1].ePos;b.mapGetter=a;aa=KindleUserLocationConverter.getLocationConverter(d.fragmentMetadata.bookType,
b)}return aa},getPageNumberConverter:function(){return Y},hasCover:function(a,b){var c=$.Deferred();s.getModuleSync(f).manifestUrl?s.getModule(e).then(function(a){a=a.coverResource;c.resolve(a!==void 0&&a!==null)},c.reject):c.resolve(!1);return c.promise().then(a,b)},isContentScrambled:function(){return ia},updateContentScrambledFlag:function(a){a.metadata.map&&(ia=!0)},setNetworkAccessed:function(a){L=a},isNetworkAccessed:function(){return L},getCoverUrl:function(a,b){var c=$.Deferred();s.getModuleSync(f).manifestUrl?
s.getModule(e).then(function(a){a=a.coverResource;a!==void 0&&a!==null&&K[BookChunk.RESOURCE_TYPE].getChunks(a,function(a){c.resolve(a)},c.reject)},c.reject):c.resolve(null);return c.promise().then(a,b)},getCachedAnnotations:function(){return!C?$.Deferred().reject():C.getAnnotations()},cacheAnnotations:function(a){return!C?$.Deferred().reject():C.putAnnotations(a)},getCachedPageNumbers:function(){return!C?$.Deferred().reject():C.getPageNumbers()},cachePageNumbers:function(a){return!C?$.Deferred().reject():
C.putPageNumbers(a)},getBookPositions:function(){var a=new jQuery.Deferred;s.getModule(h).then(function(b){var c=KindleModuleManager.getModuleSync(f);a.resolve({toc:b.positions.toc,srl:c.srl||b.positions.srl,cover:b.positions.cover})},a.reject);return a.promise()},getSearchIndex:function(){return P.getSearchIndex()},startDownloading:function(b,c){[Kindle.MODULE.SidecarManager,Kindle.MODULE.SearchIndexManager,Kindle.MODULE.PageNumberManager].forEach(function(a){s.isModuleRegistered(a)||(KindleDebug.log("Copying registration of "+
a),s.registerModule(a,KindleModuleManager.getModuleSync(a)))});KindleReaderAnnotationManager.clear();ga=Kindle.BookInfo.CachedState.PINNED;la=!0;s.registerModuleWithDeferred(a,c);var d=A(b);R.always(KindleReaderAnnotationManager.clear);return d},cancelDownloading:function(a){K.downloadController&&K.downloadController.failDownload(a||Kindle.ERROR.CANCELLED)},pauseDownloading:function(){I&&I.downloadController.pauseDownload()},resumeDownloading:function(){I&&I.downloadController.resumeDownload()},getDownloadComplete:function(a){ka=
a;return R.promise()},isBookDownloaded:function(){return F===Kindle.BookInfo.CachedState.CACHED||F===Kindle.BookInfo.CachedState.PINNED},setCachedState:p,getSizeInfo:function(){var a=new jQuery.Deferred;$.when(s.getModule(h),C.computeQuota()).then(function(b,c){a.resolve({bookSize:b.bookSize,quota:c})},a.reject);return a.promise()},isUpdated:function(){return!!Z}}}}}var KindleReaderBookInfoProvider=KindleReaderBookInfoProviderFactory();
function KindleBookSkeletonBuilderFactory(f,h,e,d){function c(a,b){b&&(a=a.replace(/\burl\s*\(\s*(?:'([^']*)'|"([^"]*)")\s*\)/gi,function(a,c,d){return(c=b[c||d])?'url("'+c+'")':c===null?"none":a}));return a}function a(a,b,c,d){a=a.includes;if(a!==void 0){for(var e,g=0;g<a.length;g++){var f=d[a[g]],n=b[f.metadata.id];if(n.type==="text/css")e=e||{},e[n.name]=f.data}if(e)c.skeletonData=c.skeletonData.replace(/<link\s(?:[^\/>'"]|'[^']*'|"[^"]*")*href\s*=\s*(?:'([^']*)'|"([^"]*)")(?:[^\/>'"]|'[^']*'|"[^"]*")*(?:\/>|>\s*<\/link>)/gi,
function(a,b,c){return(b=e[b||c])?'<style type="text/css">'+b+"</style>":a})}}function g(b,d,e,g){if(e!==null){var f=b.resourceManifest,b=b.skeletonManifest[d.skeletonMetadata.id],h;for(h in e){var o=e[h],n=f[o.metadata.id].includes;if(n!==void 0){for(var r={},t=0;t<n.length;t++){var u=e[n[t]];r[f[n[t]].name]=u===void 0?null:u.data}o.data=c(o.data,r)}}a(b,f,d,e);e=b.depends;if(e!==void 0){h=[];for(b=0;b<e.length;b++)o=f[e[b]],o.resInfo!==void 0&&h.push(o.resInfo);d.resourceInfo=h}}g.resolve(d)}var b=
{};b.skeletonManager=f;b.resourceManger=h;b.manifest=e;b.dictionary=d;b.buildSkeleton=function(a){function b(a){a.data=c(a.data,a.resList);r[a.metadata.id]=a;h++;n!==null&&h>=f&&g(t,n,r,d)}var d=new jQuery.Deferred,e=this.dictionary,f=0,h=0,o=[];if(this.manifest.skeletonManifest!==void 0&&this.manifest.skeletonManifest[a]!==void 0&&this.manifest.skeletonManifest[a].depends!==null)o=this.manifest.skeletonManifest[a].depends.slice(),f=o.length;var n=null,r=null,t=this.manifest;this.skeletonManager.getChunks([a],
function(a){if(a.skeletonMetadata.compression===1)a.skeletonData=KindleCompression.lzExpandWithStaticDictionary(a.skeletonData,e),delete a.skeletonMetadata.compression;h>=f?g(t,a,r,d):n=a},d.reject);f>0&&(r={},this.resourceManger.getChunks(o,b,d.reject));return d.promise()};return b}
var KindleCompression=function(){function f(b,c,d){var e,d=d>0?d:a;for(e in c)c[e]>=d&&(d=c[e]+1);e=d;for(var g in b)for(var d=b[g],j=2;j<=d.length;j++){var f=d.substr(0,j);c.hasOwnProperty(f)||(c[f]=e++)}return c}function h(c,e){var f,p=a;f="";for(var h=0;h<e.length;){var o=e.charAt(h);h++;o.charCodeAt(0)<=d?c.hasOwnProperty(f+o)?f+=o:(f.length>0&&p<g&&(c[f+o]=p,p++,p===b&&(p=j)),f=o):f=""}return c}function e(){if(defaultDictionary===void 0||defaultDictionary==={})defaultDictionary=h({},defaultDictionaryString);
return defaultDictionary}var d=9983,c=d+1,a=c+100+1,g=65533,b=55295,j=57344;return{lzCompress:function(e){var f={},l=[],p,h=a,o,n,r;o=p="";for(var t=0;t<e.length;){var u=e.charAt(t);t++;if(u.charCodeAt(0)<=d){for(;o.length>0;){n=Math.min(100,o.length);r=o.substr(0,n);o=o.substr(n);l.push(c+n);for(n=0;n<r.length;n++)l.push(r.charCodeAt(n))}f.hasOwnProperty(p+u)?p+=u:(p.length>0&&(l.push(p.length===1?p.charCodeAt(0):f[p]),h<g&&(f[p+u]=h,h++,h===b&&(h=j))),p=u)}else p.length>0&&(l.push(p.length===1?
p.charCodeAt(0):f[p]),p=""),o+=u}for(p.length>0&&l.push(p.length===1?p.charCodeAt(0):f[p]);o.length>0;){n=Math.min(100,o.length);r=o.substr(0,n);o=o.substr(n);l.push(c+n);for(n=0;n<r.length;n++)l.push(r.charCodeAt(n))}for(i=0;i<l.length;i++)l[i]=String.fromCharCode(l[i]);return l.join("")},lzExpand:function(e){for(var f={},l=[],h,q=a,o="",n,r=0;r<e.length;){h=e.charCodeAt(r);r++;if(h<=d)h=String.fromCharCode(h);else if(h>=a)(h=f[h])||(h=o+n);else{o=h-c;l.push(e.substr(r,o));r+=o;o="";continue}l.push(h);
n=h.charAt(0);q<g&&o.length>0&&(f[q]=o+n,q++,q===b&&(q=j));o=h}return l.join("")},lzBuildDictionary:h,lzGetDecompressionDictionary:function(a){var b=[],c;for(c in a)b[a[c]]=c;return b},lzAddStringsToDictionary:f,lzAddNumbersToDictionary:function(a,b){for(var c=[],d=100;d<1E3;d++)c.push(""+d);return f(c,a,b)},lzCompressWithStaticDictionary:function(a,b){if(b===void 0||b==={})b=e();var g=[],j,f,h,n;f=j="";for(var r=0;r<a.length;){var t=a.charAt(r);r++;if(t.charCodeAt(0)<=d){for(;f.length>0;){h=Math.min(100,
f.length);n=f.substr(0,h);f=f.substr(h);g.push(c+h);for(h=0;h<n.length;h++)g.push(n.charCodeAt(h))}b.hasOwnProperty(j+t)?j+=t:(j.length>0&&g.push(j.length===1?j.charCodeAt(0):b[j]),j=t)}else j.length>0&&(g.push(j.length===1?j.charCodeAt(0):b[j]),j=""),f+=t}for(j.length>0&&g.push(j.length===1?j.charCodeAt(0):b[j]);f.length>0;){h=Math.min(100,f.length);n=f.substr(0,h);f=f.substr(h);g.push(c+h);for(h=0;h<n.length;h++)g.push(n.charCodeAt(h))}for(i=0;i<g.length;i++)g[i]=String.fromCharCode(g[i]);return g.join("")},
lzExpandWithStaticDictionary:function(b,g,j){if(g===void 0||g===[]){if(defaultDeDictionary===void 0||defaultDeDictionary===[]){e();defaultDeDictionary=[];for(var f in defaultDictionary)defaultDeDictionary[defaultDictionary[f]]=f}g=defaultDeDictionary}f=d;var h=a;j!==void 0&&(f=j-1,h=j);for(var j=[],o=0;o<b.length;){var n=b.charCodeAt(o);o++;n<=f?j.push(String.fromCharCode(n)):n>=h?j.push(g[n]):(n-=c,j.push(b.substr(o,n)),o+=n)}return j.join("")}}}(),ContentMigration=function(){function f(c){function a(a){var b=
"get"+(a.substr(0,1).toUpperCase()+a.substr(1))+"Ids";return c.source[b]().pipe(function(b){function d(){var j=b.splice(0,100);if(j.length===0)e.then(g.resolve,g.reject);else{var f="get"+(a.substr(0,1).toUpperCase()+a.substr(1))+"s",j=c.source[f](j);$.when(j,e).then(function(b){var g={};b.forEach(function(a,b){g[b]=a});e=c.target("putChunksNonT",c.asin,a,g);setTimeout(d,100)},g.reject)}}var e=$.Deferred().resolve(),g=$.Deferred();d();return g.promise()})}function d(){var c=BookChunk.types[e++];c?
a(c).then(d,b.reject):b.resolve()}var b=$.Deferred(),e=0,f=c.timer.createSubTimer("chunks");d();b.done(function(){f.endTimer()});return b.promise()}function h(c){var a=$.Deferred(),d=c.timer.createSubTimer("annotations");c.source.getAnnotations().then(function(b){c.target("putAnnotations",c.asin,b).then(a.resolve,a.reject)},a.reject);a.done(function(){d.endTimer()});return a.promise()}function e(c){var a=$.Deferred(),d=c.timer.createSubTimer("pageNumbers");c.source.getPageNumbers().then(function(b){c.target("putPageNumbers",
c.asin,b).then(a.resolve,a.reject)},a.reject);a.done(function(){d.endTimer()});return a.promise()}function d(c){var a=$.Deferred(),d=c.timer.createSubTimer("bookinfo");c.source.getBookInfo().then(function(b){c.target("putBookinfo",c.asin,b).then(a.resolve,a.reject)},a.reject);a.done(function(){d.endTimer()});return a.promise()}return{initialize:function(){KindleModuleManager.define(KindleModuleManager.CONTENT_MIGRATION,[Kindle.MODULE.DB_CLIENT,KindleModuleManager.EMBEDDED_HOSTINTERFACE],function(c,
a){return{moveBook:function(g){var b=$.Deferred(),j=c.getBookDb();if(!g)return b.reject("Need ASIN as param").promise();var k={timer:KindleMetricsProfiler("Migrate "+g),asin:g,target:a.contentProvider,source:j.BookInfoDB(g)},g=$.when(f(k),h(k),e(k),d(k));g.then(function(){k.timer.endTimer();k.timer.log()});g.then(b.resolve,b.reject);return b.promise()},notifyMigrationStatus:function(a){var b=$.Deferred();if(!a||!a.status)return b.reject("Need param.status as param").promise();a.status==="done"?c.getBookDb().dropTables().then(b.resolve,
b.reject):b.reject("this status is not handled");return b.promise()}}})}}}(),DatabaseContentCache=function(){return{create:function(f){var h=$.Deferred(),e=f.bookinfoDb,d={};BookChunk.types.forEach(function(c){var a=c.substr(0,1).toUpperCase()+c.substr(1);d[c]={getChunks:function(c,b,d){e["get"+a+"s"](c).then(b,d)},putChunks:function(c,b,d){e["put"+a+"s"](c).then(b,d)},getCachedIds:function(c,b){e["get"+a+"Ids"]().then(c,b)}}});d.queryBookinfo=function(){return e.getBookInfo().pipe(function(c){h.resolve(c);
return c})};d.getBookinfo=function(){return h.promise()};d.putBookinfo=function(c){h.resolve(c);return e.insertBookInfo(c)};d.updateBookinfo=e.updateBookInfo;d.getAnnotations=e.getAnnotations;d.putAnnotations=e.putAnnotations;d.getPageNumbers=e.getPageNumbers;d.putPageNumbers=e.putPageNumbers;d.getSearchIndex=e.getSearchIndex;d.putSearchIndex=e.putSearchIndex;d.computeQuota=function(){return e.computeCacheQuota()};d.getBookStatistics=e.getBookStatistics;d.checkCache=function(){return!0};d.deleteOldestBook=
function(c,a){e.deleteOldestBookData(f.asin).then(c,a)};d.deleteBooksData=function(){bookInfo=void 0;h.state()!=="pending"&&(h=$.Deferred());return e.deleteBooksData([f.asin])};return d}}}(),DownloadingContentProvider=function(){function f(e){function d(d,e,f){function h(a){var c;if(!b){for(c in a)e(a[c]),g.removeId(c);var d=[],j;for(j=0;j<t.length;j++)c=t[j],a[c]===void 0&&(G=c,d.push(c));t=d;d.length>0?r(d):n()}}function p(){b||r(t)}function q(c){function d(){b||e(c)}if(!b){var g=BookChunk.getId(c);
if(a){var j=[];j[g]=c;a.putChunks(j,d,d);--u===0&&n()}else e(c)}}function o(a,d,e,g){var j;b||(Object.prototype.toString.call(g)==="[object Array]"?(j=g,g="list"):j=[g],x[g]=x[g]+1||1,x[g]<=2?c.getChunks(j,q,o):(f(a,d,e),--u===0&&n()))}function n(){g.setNextId(G);setTimeout(flowControl.resume,0)}function r(a){u=a.length;c.getChunks(a,q,o)}Object.prototype.toString.call(d)!=="[object Array]"&&(d=[d]);var t=d.slice(0),u=0,G=Math.max.apply(Math,t)+1,x=[];a?(flowControl.pause(),a.getChunks(d,h,p)):r(d)}
var c,a,g,b=!1;c=e.source;a=e.cache;g=e.downloader;flowControl=e.flowControl;return{getChunks:d,getPieces:function(a,b,c){return d(a,b,c)},close:function(){b=!0}}}function h(e,d){var c=KindleBookDownloaderFactory({type:d,cache:!0,throttle:BookChunk.properties[d].huge,netGetter:e.source[d].getChunks,urlGetter:e.source[d].getUrls,fileGetter:e.source[d].getChunkFromUrl,dbPutter:e.cache[d].putChunks,dbGetIdList:e.cache[d].getCachedIds,dbCheckCache:e.cache.checkCache,dbOosHandler:e.cache.deleteOldestBook,
fileProgress:function(c){a.callEventListeners("onProgress",d,c)},dbIsCached:function(){a.callEventListeners("onCompleted",d)},dbIsOos:function(){a.callEventListeners("onFailed",d,Kindle.ERROR.OUT_OF_SPACE)},downloadError:function(c,b){a.callEventListeners("onFailed",d,c,b)},isIdRequired:e.tweaks&&e.tweaks[d]&&e.tweaks[d].isIdRequired}),a=ListenerManager();return{init:function(a,b){c.initialize(a,b)},start:function(){c.startReadAhead()},cancel:function(){c.cancelReadAhead()},pause:function(){c.pauseReadAhead()},
resume:function(){c.resumeReadAhead()},setNextId:function(a){c.setNextId(a)},removeId:function(a){c.removeIdFromReadAhead(a)},getNumIds:function(){return c.numIds},addEventListener:function(c,b){a.addEventListener(c,b)}}}return{create:function(e){var d={},c={},a={},g={},b={pause:function(){g.pauseDownload()},resume:function(){g.resumeDownload()}};BookChunk.types.forEach(function(a){c[a]=h(e,a);d[a]=f({type:a,source:e.source[a],cache:e.cache[a],downloader:c[a],flowControl:b})});a={downloadingContentProvider:d,
fast:e.readAheadAgressively,downloaders:c,sidecarManager:e.sidecarManager};g=BookDownloadController.create(a);d.queryBookinfo=e.cache.queryBookinfo;d.getBookinfo=e.cache.getBookinfo;d.putBookinfo=e.cache.putBookinfo;d.computeCacheQuota=e.cache.computeQuota;d.downloadController={startDownload:g.startDownload,failDownload:g.failDownload,cancelDownload:g.failDownload,pauseDownload:g.pauseDownload,resumeDownload:g.resumeDownload,whenDownloadComplete:g.whenDownloadComplete};d.close=function(a){e.source.close();
g.failDownload(a);BookChunk.types.forEach(function(a){d[a].close()})};return d}}}(),ContentPrefetchOptimizations=function(){function f(c,d,e){function j(c){function f(a){for(ix=0;ix<b.length;ix++)if(b[ix].skeleton===a)return b[ix];return null}var k=f(c);k&&k.getSkeleton()!=="rejected"?k.getSkeleton().then(a(d),e):(b.splice(0,b.length-g),k=h(c),k.getSkeleton().then(a(d),e),b.push(k),++c<p.fragmentMetadata.numberOfSkeletons&&((k=f(c))||b.push(h(c))))}c.length>1||c[0]===0?m(c,d,e):j(c[0])}function h(a){var b=
e(a),g=b.fragmentIds,b=b.resourceIds,j=$.Deferred(),f={},k={};g.forEach(function(a){f[a]=$.Deferred()});b.forEach(function(a){k[a]=$.Deferred()});m(a,function(a){j.resolve(a)},function(a,b,c,d){j.reject(a,b,c,d)});d(g,function(a){f[a.fragmentMetadata.id].resolve(a)},function(a,b,c,d){f[d].reject(a,b,c,d)});c(b,function(a){k[a.metadata.id].resolve(a)},function(a,b,c,d){k[d].reject(a,b,c,d)});return{skeleton:a,getSkeleton:function(){return j},getFragmentById:function(a){return f[a]},getResourceById:function(a){return k[a]}}}
function e(a){var b=function(){return p.fragmentArray.filter(function(b){return b.sId===a}).map(function(a){return a.fId})}(),c=l.skeletonManifest[a].depends;l.fragmentManifest&&b.forEach(function(a){l.fragmentManifest[a]&&l.fragmentManifest[a].includes&&c.push.apply(c,l.fragmentManifest[a].includes)});return{fragmentIds:b,resourceIds:c}}function d(c,d,e){$.isArray(c)||(c=[c]);c=c.filter(function(c){for(var g=0;g<b.length;g++){var j=b[g].getFragmentById(c);if(j&&j.state!=="rejected")return j.then(a(d),
e),!1}return!0});c.length>0&&k(c,d,e)}function c(c,d,e){$.isArray(c)||(c=[c]);c=c.filter(function(c){for(var g=0;g<b.length;g++){var j=b[g].getResourceById(c);if(j&&j.state!=="rejected")return j.then(a(d),e),!1}return!0});c.length>0&&j(c,d,e)}function a(a){return function(b){b=jQuery.extend(!0,{},b);a(b)}}var g=40,b=[],j,k,m,l,p;return{modify:function(a,b,e){l=b;p=e;m=a[BookChunk.SKELETON_TYPE].getChunks;k=a[BookChunk.FRAGMENT_TYPE].getChunks;j=a[BookChunk.RESOURCE_TYPE].getChunks;a[BookChunk.SKELETON_TYPE].getChunks=
f;a[BookChunk.FRAGMENT_TYPE].getChunks=d;a[BookChunk.RESOURCE_TYPE].getChunks=c}}}(),KindleO_Aaa=function(){function f(a){for(var b=[],c,e,f,h,p,q,o=0;o<a.length;)f=a.charCodeAt(o++)&255,c=a.charCodeAt(o++),h=c&255,e=a.charCodeAt(o++),p=e&255,q=f>>2,f=(f&3)<<4|h>>4,h=(h&15)<<2|p>>6,p&=63,isNaN(c)?h=p=64:isNaN(e)&&(p=64),b.push(d.charAt(q)+d.charAt(f)+d.charAt(h)+d.charAt(p));return b.join("")}function h(a){for(var b=[],d,e,f,h,p,q=0;q<a.length;)d=c[a.charCodeAt(q++)],e=c[a.charCodeAt(q++)],h=c[a.charCodeAt(q++)],
p=c[a.charCodeAt(q++)],d=d<<2|e>>4,e=(e&15)<<4|h>>2,f=(h&3)<<6|p,b.push(String.fromCharCode(d)),h!==64&&b.push(String.fromCharCode(e)),p!==64&&b.push(String.fromCharCode(f));return b.join("")}function e(a,b){var c=[];c.length=256;for(var d=0;d<256;d++)c[d]=d;for(var e=0,f,d=0;d<256;d++)e=e+c[d]+b[d%b.length]&255,f=c[d],c[d]=c[e],c[e]=f;for(var e=d=0,h=[],q=0;q<a.length;q++)d=d+1&255,e=e+c[d]&255,f=c[d],c[d]=c[e],c[e]=f,h.push(String.fromCharCode(a.charCodeAt(q)^c[c[d]+c[e]&255]));return h.join("")}
for(var d="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",c=[],a=0;a<d.length;a+=1)c[d.charCodeAt(a)]=a;return{o_aaa:f,o_aag:h,o_aac:function(c,b){var d;d=c.replace(/\x0d\x0a/g,"\n");for(var k=[],h=0;h<d.length;h++){var l=d.charCodeAt(h);l<128?k.push(String.fromCharCode(l)):(l>127&&l<2048?k.push(String.fromCharCode(l>>6|192)):(k.push(String.fromCharCode(l>>12|224)),k.push(String.fromCharCode(l>>6&63|128))),k.push(String.fromCharCode(l&63|128)))}d=k.join("");k=b;k+="00000000000000000000000000000000".substring(0,
32-k.length);h=[];for(a=0;a<k.length;a+=2)h.push(parseInt(k.substring(a,a+2),16));return f(e(d,h))},o_aad:function(a,b){for(var c=h(a),d=[],f=0;f<b.length;f++)d.push(b.charCodeAt(f));for(var c=e(c,d),d=[],f=0,l,p,q;f<c.length;)l=c.charCodeAt(f),l<128?(d.push(String.fromCharCode(l)),f++):l>191&&l<224?(p=c.charCodeAt(f+1),d.push(String.fromCharCode((l&31)<<6|p&63)),f+=2):(p=c.charCodeAt(f+1),q=c.charCodeAt(f+2),d.push(String.fromCharCode((l&15)<<12|(p&63)<<6|q&63)),f+=3);return d.join("")}}}(),KindleReaderAnnotationManager=
function(){function f(a,b){return a.start-b.start}function h(a){for(var b=0;b<a.length;b++)if(a[b].guid&&!a[b].refEmId)a[b].refEmId=a[b].guid}function e(a){function b(){d(a).then(e.resolve,e.reject)}function c(){q(a).then(b,e.reject)}var e=new jQuery.Deferred;e.then(function(){for(var b=0;b<a.length;b++)s.emit(g(a[b]))},function(){for(var b=0;b<a.length;b++)s.emit(g(a[b],"Fail"))});k(a);for(var f=0;f<a.length;f++){if(a[f].asin===void 0||a[f].refEmId===void 0||a[f].start===void 0||a[f].type===void 0)return s.emit(g(a[f],
"Invalid")),KindleDebug.error("Tried to delete an invalid annotation."),e.reject().promise();if(a[f].note)a[f].note=n(a[f].note)}Z.acquire().done(function(){v=Date.now();W.saveToJournal(a).then(c,e.reject);e.then(Z.release,Z.release)});return e.promise()}function d(a){function b(){for(var e,g=!1,j,k=0;k<a.length;k++)j=a[k],e=c(j.type,j.start),j.action===w?e===-1&&(y.push(j),g=!0):j.action===A?e!==-1&&(y.splice(e,1),y.push(j),g=!0):j.action===z&&e!==-1&&y.splice(e,1);g&&y.sort(f);d.resolve();P.cacheAnnotations(y)}
var d=new jQuery.Deferred;t().then(b,b);return d.promise()}function c(a,b){for(var c in y){var d=y[c];if(d.type===a&&d.start===b)return c}return-1}function a(a,b){return y[c(a,Number(b))]||null}function g(a,b){var c="Reader::"+C[a.action]+C[a.type];b&&(c+=b);return c}function b(a){for(var b=(new Date).getTime(),c=0;c<a.length;c++)a[c].asin=K,a[c].refEmId=N,a[c].action=w,a[c].modifiedTimestamp=b;return a}function j(a){for(var b=(new Date).getTime(),c=0;c<a.length;c++)a[c].action=z,a[c].modifiedTimestamp=
b;return a}function k(a){for(var b=0;b<a.length;b++)a[b].positionType=O;return a}function m(a){b(a);return e(a)}function l(a){for(var b=(new Date).getTime(),c=0;c<a.length;c++)a[c].action=A,a[c].modifiedTimestamp=b;return e(a)}function p(a){j(a);return e(a)}function q(a){function b(){function e(a){j.context=a;b()}for(var g,f,j;d<a.length&&!(a[d].action===w&&(a[d].type===x||a[d].type===D));)++d;if(d<a.length){j=a[d++];switch(j.type){case x:g=j.position;f=j.position+H;break;case D:g=j.start,f=j.end}o(g,
f).then(e,b)}else c.resolve()}var c=new jQuery.Deferred,d=0;b();return c.promise()}function o(a,b){aa===null&&(aa=KindleRenderer.createWordIterator());return aa.getText(a,b)}function n(a){a.length>Kindle.opt.maxNoteChars&&(s.emit("Reader::NoteLengthLimitExceeded",{submetrics:[{name:"ResultSize",value:a.length}]}),a=a.substr(0,Kindle.opt.maxNoteChars));return a}function r(a,c,d,g){var f=KindleReaderAnnotationManager.getAnnotationsInRange(a,c,D),k=f.length,h={type:D,start:a,position:d,end:c},l=[];g&&
l.push.apply(l,b([{type:B,start:c,position:d,end:c,note:g}]));if(f.length===1&&a>=f[0].start&&c<=f[0].end){if(l.length===0)return(new jQuery.Deferred).resolve([f[0]])}else{if(k>0)h.start=Math.min(a,f[0].start),h.end=Math.max(c,f[k-1].end),l.push.apply(l,j(f));l.push.apply(l,b([h]))}return e(l)}function t(){var a=new jQuery.Deferred;P.getCachedAnnotations().then(function(b){b&&b.length!==void 0&&(y=b,h(y));a.resolve()},a.reject);return a.promise()}function u(){function a(){c.resolve()}function b(){c.resolve()}
var c=new jQuery.Deferred;T.getAnnotations(K,N).then(function(c){y=c.annotations;h(y);P.cacheAnnotations(y).then(a,b)},c.reject);return c.promise()}function G(){function a(){t().then(c.reject,c.reject)}function b(){u().then(c.resolve,a)}var c=new jQuery.Deferred;W.uploadJournal().then(b,b);return c.promise()}var x="kindle.bookmark",B="kindle.note",D="kindle.highlight",w="create",A="modify",z="delete",H=100,C={};C[x]="Bookmark";C[B]="Note";C[D]="Highlight";C[w]="Create";C[A]="Modify";C[z]="Delete";
var I,P=null,K=null,N=null,O=null,y=null,T=null,W=null,s,v=Date.now(),Z=Lock(),aa=null;return{BOOKMARK:x,NOTE:B,NOTE_ICON:"kindle.note.icon",HIGHLIGHT:D,POPULAR_HIGHLIGHT:"kindle.popular",getLastUpdateTime:function(){return v},deferredInitialize:function(a,b){function c(){I.resolve(e)}function d(a){T=a[b.SERVICE_CLIENT];W=a[b.JOURNAL_MANAGER];s=a[b.METRICS_MANAGER];G().then(c,c)}var e,g;I||(b=b||KindleModuleManager,I=$.Deferred(),e=this,g=[b.SERVICE_CLIENT,b.JOURNAL_MANAGER,b.METRICS_MANAGER],y=[],
a.then(function(a){P=a;K=P.getAsin();N=P.getRefEmId();O=P.getBookType();P.getContext().isOwned?b.getModuleList(g).then(d,I.reject):I.reject()},I.reject));return I.promise()},clear:function(){var a=I;I=null;y=[];K=N=O=null;a&&a.reject()},getAnnotation:a,getAllAnnotations:function(){return y.slice()},getAnnotationsInRange:function(a,b,c){var d=[],e;for(e in y){var g=y[e];(g.start<=b&&g.end>=a||g.start>=a&&g.start<=b)&&(!c||c===g.type)&&d.push(g)}return d},createBookmark:function(a){return m([{type:x,
start:a,position:a,end:a,context:""}])},createNote:r,modifyNote:function(b,c,d){var e=new jQuery.Deferred;(b=a(B,b))?(b.note=d,b.position=c,l([b]).then(e.resolve,e.reject)):e.reject();return e.promise()},createHighlight:function(a,b,c){return r(a,b,c,null)},deleteAnnotations:p,getContext:o,updateAnnotations:function(a){for(var b,c=[],d=[],e=[],g=[],f=0;f<a.length;f++)switch(b=a[f],b.action){case w:c.push(b);break;case A:e.push(b);break;case z:d.push(b)}c.length>0&&g.push(m(c));e.length>0&&g.push(l(e));
d.length>0&&g.push(p(d));return $.when.apply($,g)}}}(),NetworkContentProvider=function(){var f=3E4;return{create:function(h){function e(a,b){var c=new jQuery.Deferred;$.jsonp({url:a,callback:b,cache:!0,timeout:f,error:function(a,b){c.reject(a,b)},success:function(a){c.resolve(a)}});return c.promise()}function d(a,b,c){function d(a,b,c){var e,g;if(a&&a.length)for(e=0;e<a.length;e++)g=b+a[e].id,c(a[e].signedUrl,g,a[e].id)}h.bookInfo.setNetworkAccessed(!0);d(a.skeletonUrls,"loadSkeleton",function(a,
d,g){e(a,d).then(function(a){if(a.skeletonMetadata!==void 0&&a.skeletonMetadata.encryption===1){var c=KindleO_Aaa.o_aad(a.skeletonData,j);a.skeletonData=c;delete a.skeletonMetadata.encryption}b(a)},function(a,b){c(null,b,null,g)})});d(a.fragmentUrls,"loadFragment",function(a,d,g){e(a,d).then(function(a){if(a.fragmentMetadata!==void 0&&a.fragmentMetadata.encryption===1){var c=KindleO_Aaa.o_aad(a.fragmentData,j);a.fragmentData=c;delete a.fragmentMetadata.encryption}b(a)},function(a,b){c(null,b,null,
g)})});d(a.glyphUrls,"loadGlyphFragment",function(a,d,g){e(a,d).then(function(a){if(a.glyphFragmentMetadata!==void 0)a.glyphFragmentMetadata.id=g;b(a)},function(a,b){c(null,b,null,g)})});d(a.resourceUrls,"loadResource",function(a,d,g){e(a,d).then(function(a){h.bookInfo.updateContentScrambledFlag(a);b(a)},function(a,b){c(null,b,null,g)})});d(a.locationMapUrls,"loadMobiLocationMap",function(a,d,g){e(a,d).then(b,function(a,b){c(null,b,null,g)})})}function c(a,c){var d={asin:h.asin,contentVersion:b.contentVersion,
formatVersion:b.formatVersion,isSample:b.isSample};if(b.kindleSessionId)d.kindleSessionId=b.kindleSessionId;if(b.kcrFree)d.kcrFree=!0;d[a+"Ids"]=c;return g.getFileUrl(d)}function a(a,b,e,g){Object.prototype.toString.call(b)!=="[object Array]"&&(b=[b]);c(a,b).then(function(a){k||d(a,e,g)},function(a,c,d){g(a,c,d,b)})}var g,b,j,k=!1;b=h.context;j=b.contentChecksum;g=KindleModuleManager.getModuleSync(Kindle.MODULE.SERVICE_CLIENT);var m={};BookChunk.types.forEach(function(b){m[b]={getChunks:function(c,
d,e){a(b,c,d,e)},getUrls:function(a,d,e){c(b,a).then(function(a){d(a[b+"Urls"])},e)},getChunkFromUrl:function(a,c,e){var g={};g[b+"Urls"]=[a];d(g,c,e)}}});m.getFragmap=function(){var a=$.Deferred();e(b.fragmentMapUrl,"loadFragmap").then(function(b){a.resolve(b)},function(b,c){a.reject(c)});return a.promise()};m.getMetadata=function(){var a=$.Deferred();e(b.metadataUrl,"loadMetadata").then(function(b){a.resolve(b)},function(b,c){a.reject(c)});return a.promise()};m.getManifest=function(){function a(b){d.resolve(b)}
function c(){d.resolve({})}var d=$.Deferred();b.manifestUrl?e(b.manifestUrl,"loadManifest").then(a,c):d.resolve({});return d.promise()};m.close=function(){k=!0};return m}}}(),RemoteContentCache=function(){return{create:function(f){function h(a){g=a;if(!e||e.state!=="pending")e=$.Deferred();e.resolve(g)}var e=$.Deferred(),d=f.asin,c=f.contentProvider,a=f.contentRemover,g,b={};BookChunk.types.forEach(function(a){b[a]={getChunks:function(b,e,g){c("getChunks",d,a,b).then(e,g)},putChunks:function(b,e,
g){var f={};b.forEach(function(a,b){f[b]=a});c("putChunks",d,a,f).then(e,g)},getCachedIds:function(b,e){c("getChunkIds",d,a).then(b,e)}}});b.queryBookinfo=function(){return c("getBookinfo",d).pipe(function(a){h(a);return a})};b.getBookinfo=function(){return e.promise()};b.putBookinfo=function(a){h(a);return c("putBookinfo",d,a)};b.updateBookinfo=function(a){if(!g)return $.Deferred().reject("bad state");$.extend(g,a);return c("updateBookinfo",d,a)};b.getAnnotations=function(){return c("getAnnotations",
d)};b.putAnnotations=function(a){return c("putAnnotations",d,a)};b.getPageNumbers=function(){return c("getPageNumbers",d)};b.putPageNumbers=function(a){return c("putPageNumbers",d,a)};b.computeQuota=function(){return $.Deferred().resolve(0)};b.getBookStatistics=function(){return $.Deferred().reject()};b.checkCache=function(){return!0};b.deleteOldestBook=function(a,b){b()};b.deleteBooksData=function(){g=void 0;e.state()!=="pending"&&(e=$.Deferred());return a({asin:d})};b.downloadSearchIndex=function(a){return c("getSearchIndexReader",
d,a)};b.initMetadata=function(a){return c("initMetadata",d,a)};return b}}}();
function KindleBookResourceUrlTranslator(f,h,e){var d={};d.bookInfo=e;d.resourceManger=f;d.resourceManifest=h.resourceManifest;d.reverseLookup={};for(var c in d.resourceManifest)d.reverseLookup[d.resourceManifest[c].name]=c;d.getResourceUrls=function(a,c,b){function e(a){var b=p[a.metadata.id].name;d.bookInfo.updateContentScrambledFlag(a);var f={};f[b]=a.data;if(a.metadata)f.metadata=a.metadata;c(f)}for(var f=[],h=0;h<a.length;h++){var l=this.reverseLookup[a[h]];l!==void 0&&f.push(l)}var p=this.resourceManifest;
f.length!==a.length&&b();f.length>0?this.resourceManger.getChunks(f,e,b):c({})};return d}
(function(){function f(a){function b(e){for(var g={},f,j=0;j<e.length;j++)if(f=e[j].filename,f.endsWith(l.words))g.words=e[j].data;else if(f.endsWith(l.properties))g.properties=e[j].data;else if(f.endsWith(l.positions))g.positions=e[j].data;g.asin=a.asin;d.endTimer();d.log();c.notify("finished");c.resolve(g)}var c=new $.Deferred,d=KindleMetricsProfiler("unzip search index");if(a.length>1)return KindleDebug.error("Cannot Unzip: We have too many array buffers"),c.reject("Index too large");KindleZip.unzip(a[0]).pipe(b,
b);return c.promise()}function h(a,b){for(var c=KindleMetricsProfiler("decrypt search index"),d=b.decryptionIV,e=b.decryptionKey,g=[],f,j=0;j<a.length;j++)f=KindleCrypto.decrypt(a[j],e,d),f=f.buffer,g.push(f);g.asin=b.asin;c.endTimer();c.log();return g}function e(b){function c(a){function d(){w.endTimer();K.push(z.response);I+=H;I<P?(C-=Date.now(),C<k?H*=2:C>m&&(H/=2),h()):(A.endTimer(),A.log(),N.resolve(K,l))}function e(a){a.lengthComputable?(a=Math.floor(100*a.loaded/a.total),a!==q&&(q=a)):KindleDebug.log("progress unknown")}
function g(){KindleDebug.error("An error occurred while transferring the file.");N.reject("failed")}function f(){KindleDebug.error("The transfer has been canceled by the user.");N.reject("cancelled")}function h(){C=Date.now();w=A.createSubTimer("@"+I);var a=Math.min(I+H-1,P);z=new XMLHttpRequest;z.open("GET",D);z.setRequestHeader("Range","bytes="+I+"-"+a);z.responseType="arraybuffer";z.addEventListener("progress",e,!1);z.addEventListener("load",d,!1);z.addEventListener("error",g,!1);z.addEventListener("abort",
f,!1);z.send(null)}var l=a;if(l.s3Url===null)return $.Deferred().reject(Kindle.ERROR.SITB_INDEX_NOT_AVAILABLE);l.asin=b.asin;var q=-1,D=l.s3Url.replace(/http:\/\//,"https://"),w,A=KindleMetricsProfiler("download search index"),z,H=j,C,I=0,P=l.indexSize-1,K=[],N=$.Deferred();h();return N}return KindleHostDeviceDetector.isOnline()?a.getSearchIndexInfo(b).pipe(c,function(a){return a.status===0?$.Deferred().reject(Kindle.ERROR.SITB_OFFLINE):$.Deferred().reject(Kindle.ERROR.SITB_COMMON_ERROR)}):$.Deferred().reject(Kindle.ERROR.SITB_OFFLINE)}
function d(a){function c(b){return!a.contentCache?$.Deferred().resolve(b):a.contentCache.putSearchIndex(b)}if(!KindleDeviceCapabilities.searchInTheBook())return $.Deferred().reject("Unsupported OS");if(b[a.asin])return b[a.asin];b={};b[a.asin]=(!a.contentCache?$.Deferred().reject("no db"):a.contentCache.getSearchIndex()).pipe(null,function(){return e(a).pipe(h).pipe(f).pipe(c)}).pipe(g.openSearchIndex);return b[a.asin]}function c(a){return a.contentCache.downloadSearchIndex({asin:a.asin})}var a,g,
b={},j=16777216,k=1E4,m=2E4,l={words:".words",positions:".positions",properties:".properties"};KindleModuleManager.define(Kindle.MODULE.SearchIndexManager,[Kindle.MODULE.SERVICE_CLIENT,Kindle.MODULE.DB_CLIENT,"SearchIndexParser"],function(b,e,f){a=b;g=f;return{getSearchIndex:KindleHostDeviceDetector.isMetro()?c:d}})})();
(function(){function f(e){function d(){return KindleDebug.assert.apply(KindleDebug,arguments)}function c(){return KindleDebug.log.apply(KindleDebug,arguments)}function a(){return $.Deferred().reject.apply($,arguments)}function g(a){for(var a=new Uint8Array(e[a]),b=[],c=0;c<a.byteLength;c++)b.push(String.fromCharCode(a[c]));a=b.join("");return $.Deferred().resolve(a)}function b(b,c,e,g,f){b=b.cloneStream();b.seek(c);return b.readAsync(e).pipe(function(c){function e(){switch(g){case 1:return j.readByte()+
f;case 2:return j.readInt16()+f;case 3:return(j.readByte()<<16)+j.readUInt16()+f;case 4:return j.readInt32()+f;default:d("Got unexpected bytes-per-entity:"+g)}}try{for(var j=c,c=[];j.unconsumedBufferLength>0;)c.push(e());j.close();b.close();return c}catch(h){return b.close(),a(h)}},b.close)}function f(a,c){var d=a.directory.BytesPerEntity;return b(a.positionsStream,a.directory.Positions.offset+c.o*d,c.n*d,d,a.directory.MinimumTitleEntityValue)}var k={magicLength:4,magic:"AZSA",headerOffset:-28,directoryOffset:-24,
stringEntries:["Magic","WhereIndexed","IndexerHelperClassName"],wordsFilename:"index.words",positionsFilename:"index.positions",propertiesFilename:"index.properties"},m=$.Deferred();(function(b){var c,d,e,g=b.positionsStream,f=Math.min(g.size,Math.abs(k.headerOffset));g.seek(Math.max(0,g.size+k.headerOffset));return b.positionsStream.readAsync(f).pipe(function(c){try{var g=c.readInt32();d=c.readInt32();e=c.readInt32();c.close();if(g!==b.positionsStream.size)return a("bad header size");b.positionsStream.seek(d);
return b.positionsStream.readAsync(e)}catch(f){return a(f)}}).pipe(function(d){try{c={Magic:{offset:0,length:k.magicLength,isString:!0}};for(var e,g,f,j;d.unconsumedBufferLength>0;)if(e=d.readInt32(),g=d.readInt32(),f=d.readByte(),j=d.readString(f),c[j]={offset:e,length:g},k.stringEntries.indexOf(j)>=0)c[j].isString=!0;d.close();var h=c.SearchBoundaryPositions.offset;b.positionsStream.seek(0);return b.positionsStream.readAsync(h)}catch(m){return a(m)}}).pipe(function(d){function e(a){for(var b=Object.keys(c),
d=0;d<b.length;++d)if(c[b[d]].offset===a)return b[d]}try{for(var g,f=0;d.unconsumedBufferLength>0;){g=e(f);if(!g)return d.close(),a("Can't read directory entries");f+=c[g].length;if(c[g].isString)c[g]=d.readString(c[g].length);else if(c[g].length===1)c[g]=d.readByte();else if(c[g].length===4)c[g]=d.readInt32();else return d.close(),a("Bad size for numeric entry")}d.close();if(c.Magic!==k.magic)return a("bad magic");b.directory=c;return b}catch(j){return a(j)}})})({getPositionsForWord:function(a){var b=
$.Deferred(),d=this.wordList[a],e={word:a,searchBoundaryPositions:this.searchBoundaryPositions,positions:[]};d?f(this,d).pipe(function(d){c('Word "'+a+'" has '+d.length+" occurances");e.positions=d;b.resolve(e)},function(){b.reject(Kindle.ERROR.SITB_INDEX_UNREADABLE)}):b.resolve(e);return b.promise()},getProperty:function(a){return this.properties[a]},close:function(){this.positionsStream=null},positionsStream:new h(e.positions)}).pipe(function(a){return g("words").pipe(function(b){var c={};b.split("\n").forEach(function(a){a=
a.split(":");c[a[2]]={o:a[0],n:a[1]}});a.wordList=c;return a})}).pipe(function(a){return g("properties").pipe(function(b){var c={},d=/(.*?)=(.*)/;b.split("\n").forEach(function(a){a&&(a=d.exec(a),a.length===3&&(c[a[1]]=a[2]))});a.properties=c;return a})}).pipe(function(a){return b(a.positionsStream,a.directory.SearchBoundaryPositions.offset,a.directory.SearchBoundaryPositions.length,a.directory.BytesPerEntity,a.directory.MinimumTitleEntityValue).pipe(function(b){a.searchBoundaryPositions=b;return a})}).pipe(m.resolve,
function(){m.reject(Kindle.ERROR.SITB_INDEX_UNREADABLE)});return m.promise()}var h;KindleModuleManager.define("SearchIndexParser",["SearchIndexUtilities"],function(e){h=e.Stream;return{openSearchIndex:f}})})();
(function(){function f(e){if(!(this instanceof f)){var d=Object.create(f.prototype);return f.apply(d,arguments)}this.bytes=new Uint8Array(e);this.position=0;this.size=this.bytes.length;return this}function h(e,d,c){if(!(this instanceof h)){var a=Object.create(h.prototype);return h.apply(a,arguments)}this.uBytes=e.bytes;this.bytes=new Int8Array(this.uBytes);this.base=d!==void 0?d:0;this.position=0;this.unconsumedBufferLength=this.size=c!==void 0?c:this.uBytes.length-this.base;return this}if(!Uint8Array.prototype.subarray)Uint8Array.prototype.subarray=
function(e,d){for(var e=e===void 0?0:e,d=d===void 0||d>copy.length?copy.length:d,c=new Uint8Array(d-e),a=0;a<c.length;a++)c[a]=this[a+e];return c};f.prototype.seek=function(e){this.position=Math.min(Math.max(e,0),this.size)};f.prototype.readAsync=function(e){return $.Deferred().resolve(new h(this,this.position,Math.min(e,this.size-this.position)))};f.prototype.cloneStream=function(){var e=new f(this.bytes);e.position=this.position;return e};f.prototype.close=function(){this.bytes=null};h.prototype.seek=
function(e){this.position=Math.min(Math.max(e,0),this.size);this.unconsumedBufferLength=this.size-this.position};h.prototype.getPosition=function(){return this.position};h.prototype.readByte=function(){if(this.unconsumedBufferLength<1)throw Error("Out of data");var e=this.uBytes[this.base+this.position];this.position++;this.unconsumedBufferLength--;return e};h.prototype.readInt8=function(){if(this.unconsumedBufferLength<1)throw Error("Out of data");var e=this.bytes[this.base+this.position];this.position++;
this.unconsumedBufferLength--;return e};h.prototype.readInt16=function(){if(this.unconsumedBufferLength<2)throw Error("Out of data");var e=this.base+this.position,e=(this.bytes[e]<<8)+this.uBytes[e+1];this.position+=2;this.unconsumedBufferLength-=2;return e};h.prototype.readUInt16=function(){if(this.unconsumedBufferLength<2)throw Error("Out of data");var e=this.base+this.position,e=(this.uBytes[e]<<8)+this.uBytes[e+1];this.position+=2;this.unconsumedBufferLength-=2;return e};h.prototype.readInt32=
function(){return(this.readInt16()<<16)+this.readUInt16()};h.prototype.readUInt32=function(){return(this.readUInt16()<<16)+this.readUInt16()};h.prototype.readString=function(e){if(this.unconsumedBufferLength<e)throw Error("Out of data");var d=this.base+this.position,c;try{c=String.fromCharCode.apply(null,this.uBytes.subarray(d,d+e))}catch(a){c=[];for(var g=d;g<d+e;g++)c.push(String.fromCharCode(this.uBytes[g]));c=c.join("")}this.position+=e;this.unconsumedBufferLength-=e;return c};h.prototype.close=
function(){this.unconsumedBufferLength=0;this.uBytes=this.bytes=null};KindleModuleManager.define("SearchIndexUtilities",null,{Stream:f,Buffer:h})})();
(function(){function f(d){function c(){if(!b)if(n.seek(0),g=n.readInt16(),g!==1)KindleDebug.warn("Unsupported page numbering file format version "+g);else if(f=n.readInt16(),f===0)KindleDebug.log("PageNumbers File for this book is revoked by the service"),b=Kindle.ERROR.PN_REVOKED;else{k=[];for(var a=0;a<f;a++)k[a]=n.readUInt32();a=n.readUInt32();b=a>0?n.readString(a):"";m=[];q=[];l=[];p=[]}}function a(a){c();var b;a>=f||a<=-1?(KindleDebug.log("The requested page numbering edition at index "+a+" is out of bounds for the available count of editions "+
f),b=!1):b=!0;if(b&&!p[a])if(n.seek(k[a]),b=n.readInt16(),b!==1)KindleDebug.log("Unsupported edition pagination format "+b+" for edition "+a);else{b=n.readInt16();var d=n.readInt16(),e=n.readInt16();if(e>32)KindleDebug.log("Unsupported pagination format position width "+e+" for edition "+a);else{var g;b>0&&(g=n.readString(b));m[a]=parseInt(n.getPosition(),10);q[a]=d;l[a]=e;p[a]=g;return!0}}}var g,b,f,k,m,l,p,q,o=[],d=new e(d),n=new h(d,0,d.size);return{getHeaderMetadata:function(){c();return b},getEditionMetadata:function(b){return a(b)?
p[b]:!1},getOrdinalPagePositions:function(b){a(b);var c=q[b],d=l[b]/8;o.length=c+1;n.seek(m[b]);for(b=1;b<=c;b++){var e=d===2?n.readUInt16():d===4?n.readUInt32():0;o[b]=parseInt(e,10)}for(c=1;c<o.length;c++)o[c-1]>o[c]&&KindleDebug.log("Invalid position value at index "+c+": "+o[c]+", previous position: "+o[c-1]);return o},getEditionCount:function(){return f},getTotalPageCount:function(a){return q[a]}}}var h,e;KindleModuleManager.define("BinaryPageLabelSidecarReader",["SearchIndexUtilities"],function(d){h=
d.Buffer;e=d.Stream;return{openReader:f}})})();
var PageLabelIndexer=function(){return{create:function(f,h){function e(b){var c=0,d;for(d in a)a[d].getPageLabelType()===b&&a[d].getEndingOrdinalPageNumber()>c&&(c=a[d].getEndingOrdinalPageNumber());return c}function d(c){var d,e;c<1||c>b?e=void 0:(e=PageNumberUtilities.binarySearchPosition(g,c),e=a[g[e]]);e&&(c-=e.getStartingOrdinalPageNumber(),c=e.getStartingPageLabel()+c,d=e.getPageLabelAtSeriesIndex(c));return d}var c="",a,g,b;if(f==="")KindleDebug.log("pageLabelIndexString cannot be blank, pageLabelIndexString = "+c);
else if(h<0)KindleDebug.log("TotalPages cannot be less than 0, total pages = "+h);else{c=f.toString();b=h;var j=0,k=null;for(a={};j<c.length;){if(c.charAt(j)!=="("){KindleDebug.log("Each page number scheme must start with '('; was given: "+c.substring(j));return}var m=c.indexOf(")",j);if(m<0)break;j=c.substring(j+1,m);j=PageLabelSeq.create(j);k!==null&&k.setEndingOrdinalPageNumber(j.getStartingOrdinalPageNumber()-1);k=a[parseInt(j.getStartingOrdinalPageNumber(),10)]=j;j=m+1;j<c.length&&c.charAt(j)===
","&&j++}k.setEndingOrdinalPageNumber(h);g=[];var c=0,l;for(l in a)a.hasOwnProperty(l)&&(g[c]=a[l].getStartingOrdinalPageNumber(),c++);g.sort(function(a,b){return a-b});return{getLabelSequences:function(){return a},getOrdinalPageForPageLabelText:function(b){var c=null,d=0,e;for(e in a){var g=a[e];if(g.isLabeled()){g.getStartingOrdinalPageNumber()<=d&&(c=null);var f=g.getOrdinalPageForPageLabelText(b);f>=0&&(c=g,d=f)}}return c===null||d>h?0:d},getPageLabelTextForOrdinalPage:d,getHighestPageLabel:function(){var a=
e("a");a===0&&(a=e("r"));var b="";a>0&&(b=d(a));return b},getPageNumberRanges:function(){var b={},c;for(c in a){var d=a[c],e=PageLabelType[d.getPageLabelType()],g=b[e];g?(g.minPage=Math.min(g.minPage,d.getStartingPageLabel()),g.maxPage=Math.max(g.maxPage,d.getEndingPageLabel())):(g={},g.minPage=d.getStartingPageLabel(),g.maxPage=d.getEndingPageLabel());b[e]=g}return b}}}}}}(),PageLabelSeq=function(){return{create:function(f){function h(){return c}function e(){return a}function d(){return a+j-c}var c,
a,g,b,j,f=f.split(",");j=c=parseInt(f[0],10);g=f[1].charAt(0);if(g===null)console.error("Unknown Page Numbering scheme");else return a=0,b=null,g==="c"?(b=f[2].split("|"),a=1):g!=="i"?a=parseInt(f[2],10):f[2]&&(a=parseInt(f[2],10)),{getStartingPageLabel:e,getStartingOrdinalPageNumber:h,getPageLabelType:function(){return g},getEndingPageLabel:d,getDisplayPageRange:function(){return[a,d()]},getEndingOrdinalPageNumber:function(){return j},setEndingOrdinalPageNumber:function(a){j<c&&console.error("ending ordinal page number must be >= than starting ordinal page number,endingOrdinalPageNumber  = "+
j+", startingOrdinalPageNumber = "+c);j=a},isLabeled:function(){return g!=="i"},getPageLabelAtSeriesIndex:function(a){var c;g==="a"?c=a.toString():g==="r"?c=PageNumberUtilities.toRomanNumeral(a).toString().toLowerCase():g==="i"?c="":g==="c"&&(a-=1,c=a<b.length?b[a]:"");return c},getOrdinalPageForPageLabelText:function(d){var e=0,f=!1;if(g==="a")try{e=parseInt(d,10),f=e>=a}catch(j){e=0,f=!1}g==="r"&&PageNumberUtilities.isValidRomanNumeral(d)&&(e=PageNumberUtilities.parseRomanNumeral(d),f=e>=a);g===
"c"&&b!==null&&(b[d]&&(e=b[d]+1),e>0&&(f=!0));return!f?-1:c+(e-a)}}}}}(),PageNumberProvider=function(){return{create:function(f){var h=!1,e,d=[],c=-1,a=0;if(f){d=f.oPNToPosition;a=f.totalPages;e=PageLabelIndexer.create(f.pageMapString,a);var f=e.getLabelSequences(),g=a=null,b;for(b in f){if(f[b]===null){KindleDebug.log("Page number sidecar edition doesn't contain a valid page label index");return}a===null&&(a=f[b]);g=f[b]}h=!0;c=a.getStartingOrdinalPageNumber();g.getEndingOrdinalPageNumber()}return{arePageNumbersAvailable:function(){return h},
pageNumberFromPosition:function(a){var b;if(a>=d[c]){a=PageNumberUtilities.binarySearchPosition(d,a);a<c&&(a=c);var g;a>=1&&(g=e.getPageLabelTextForOrdinalPage(a));b=g}return b},positionFromPageNumber:function(a){var b=e.getOrdinalPageForPageLabelText(a);b<=0&&parseInt(a,10);if(b<=0)return-1;b>=d.length&&(b=d.length-1);return d[b]},getMaxPageNumberLabel:function(){return e.getHighestPageLabel()},getPageNumberRanges:function(){return e.getPageNumberRanges()}}}}}();
(function(){function f(a){function c(){e.endTimer();f.emit("Service::GetPageNumber");j.resolve(h.response)}function d(){KindleDebug.error("An error occurred while transferring the file.");j.reject(Kindle.ERROR.PN_DOWNLOAD_FAIL)}var e,f,j,h;return function(a){j=$.Deferred();h=new XMLHttpRequest;h.open("GET",a);h.responseType="arraybuffer";h.addEventListener("load",c,!1);h.addEventListener("error",d,!1);e=b.createSubTimer("download page numbers");f=g.createTimer();h.send(null);return j.promise()}(a)}
function h(a){var b=$.Deferred();a.getCachedPageNumbers().then(function(a){a?b.resolve(a):b.reject()},b.reject);return b.promise()}function e(a){var b=a.getContext().pageNumberUrl;return!b?(g.emit("PageNumber::Unavailable"),$.Deferred().resolve()):h(a).pipe(null,function(){return f(b).pipe(c).done(a.cachePageNumbers)}).pipe(function(a){g.emit("PageNumber::Success");return a},function(a){a===Kindle.ERROR.PN_DOWNLOAD_FAIL&&g.emit("PageNumber::DownloadFailure");g.emit("PageNumber::Fail")})}function d(a){var c=
a.getAsin();if(!j[c]){if(!KindleDeviceCapabilities.showPageNumbers())return $.Deferred().reject("Unsupported OS");b=KindleMetricsProfiler("get page numbers");j={};j[c]=e(a).pipe(function(a){var c;a&&(c=PageNumberProvider.create(a));b.endTimer();b.log();return c})}return j[c]}function c(c){function d(a){a===Kindle.ERROR.PN_REVOKED?g.emit("PageNumber::RevokedData"):g.emit("PageNumber::CorruptData");return $.Deferred().reject()}var e=g.createTimer(),f=b.createSubTimer("parse page number file"),c=a.openReader(c),
j=c.getHeaderMetadata();if(j){if(j===Kindle.ERROR.PN_REVOKED)return d(Kindle.ERROR.PN_REVOKED)}else return KindleDebug.log("Corrupt Header Data for Page Number."),d();if(!JSON.parse(j).fileRevisionId)return KindleDebug.log("Page number sidecar header doesn't contain appropriate metadata (missing fileRevisionId)."),d();if(c.getEditionCount()>0){j=c.getEditionMetadata(0);if(!j)return KindleDebug.log("Edition Header corrupted for Page Number."),d();j=JSON.parse(j);if(!j.pageMap)return KindleDebug.log("Page number sidecar edition doesn't contain appropriate metadata (missing pageMap)."),
d();c={oPNToPosition:c.getOrdinalPagePositions(0),pageMapString:j.pageMap,totalPages:c.getTotalPageCount(0)};e.emit("PageNumber::FileParse");f.endTimer();return c}else return d()}var a,g,b,j={};KindleModuleManager.define(Kindle.MODULE.PageNumberManager,[Kindle.MODULE.DB_CLIENT,Kindle.MODULE.METRICS_MANAGER,"BinaryPageLabelSidecarReader"],function(b,c,e){g=c;a=e;return{getPageNumbers:d}})})();
var PageLabelType={r:"roman",a:"arabic",c:"custom",i:"insert"},PageNumberUtilities=function(){var f={M:1E3,CM:900,D:500,CD:400,C:100,XC:90,L:50,XL:40,X:10,IX:9,V:5,IV:4,I:1},h=["M","CM","D","CD","C","XC","L","XL","X","IX","V","IV","I"];return{toRomanNumeral:function(e){for(var d="",e=parseInt(e,10),c=0;c<h.length;c++)for(var a=h[c];e>=f[a];)d+=a,e-=f[a];return d},parseRomanNumeral:function(e){for(var e=e.toUpperCase(),d=0,c=0;c<e.length-1;)f[e.charAt(c)]<f[e.charAt(c+1)]?d-=f[e.charAt(c)]:d+=f[e.charAt(c)],
c++;d+=f[e[c]];return d},binarySearchPosition:function(e,d){for(var c=0,a=e.length-1,g;c<=a;)if(g=Math.floor((c+a)/2),e[g]<d)c=g+1;else if(e[g]>d)a=g-1;else return g;return a>=0?a:c},isValidRomanNumeral:function(e){return/^M{0,4}(CM|CD|D?C{0,3})(XC|XL|L?X{0,3})(IX|IV|V?I{0,3})$/.exec(e.toString().toUpperCase())?!0:!1}}}();
(function(){function f(a){function g(){return KindleReaderAnnotationManager.deferredInitialize(a.bookinfo.getBookInfoDfd(),a.moduleManager)}function b(){var b;return a.bookinfo.getBookInfoDfd().pipe(function(a){b=a;return b.getMetadata()}).pipe(function(c){var e=b.getContext(),g=b.getAsin();return c.headerMetadata&&(c.headerMetadata.bookType===Kindle.BookInfo.PublisherMetadata.COMIC||c.headerMetadata.bookType===Kindle.BookInfo.PublisherMetadata.CHILDREN)?$.Deferred().resolve():d.getSearchIndex({asin:g,
formatVersion:e.formatVersion,contentVersion:e.contentVersion,contentCache:a.contentCache,kcrFree:a.kcrFree})})}function f(){return a.bookinfo.getBookInfoDfd().pipe(c.getPageNumbers)}return{names:Object.freeze(e),getAnnotations:g,getSearchIndex:b,getPageNumbers:f,download:function(a){switch(a){case "annotations":return g();case "searchIndex":return b();case "pageNumbers":return f();default:return $.Deferred().reject("Unknown sidecar")}}}}var h={annotations:{},pageNumbers:{},searchIndex:{}},e={};Object.keys(h).forEach(function(a){h[a].name=
a;e[a]=a});var d,c;KindleModuleManager.define(Kindle.MODULE.SidecarManager,[Kindle.MODULE.SearchIndexManager,Kindle.MODULE.PageNumberManager],function(a,e){d=a;c=e;return{create:f}})})();function AssertionError(f){Error.call(this,f)}AssertionError.prototype=Error();AssertionError.prototype.name="AssertionError";function KindleAssert(){}
var KindleAuthor=function(){var f=["phd","md","sir"];return{getDisplayableString:function(h){for(var e="",d=h.length,c=0;c<d;c++){for(var a=h[c].split(","),g=[],b=[],j=0;j<a.length;j++){var k=$.trim(a[j]);f.indexOf(k.toLowerCase())>-1?g.push(k):b.unshift(k)}if(b.length===2){e+=b[0]+" "+b[1];for(a=0;a<g.length;a++)e+=", ",e+=g[a]}else e+=h[c];d>1&&(c===d-2?e+=ResourceBundle.getLocalizedString("k_author_conjunction"):c<d-2&&(e+=", "))}return e},getLegacyDisplayableString:function(f){for(var e="",d=
f.length,c=0;c<d;c++)e+=f[c],c<d-1&&(e+="; ");return e}}}(),KindleDebug=function(){return{error:function(){},log:function(){},warn:function(){},saveLogs:function(){saveLog=!0}}}(),KindleDeviceCapabilities=function(){function f(){return KindleHostDeviceDetector.isMetro()||KindleHostDeviceDetector.isIE()?!0:!1}var h;return{searchInTheBook:function(){return!KindleHostDeviceDetector.isiOS_4x()},showPageNumbers:function(){return!KindleHostDeviceDetector.isiOS_4x()},multiColumnMode:function(){return!0},
useNativeSelection:f,useCSSRegions:function(){return f()},useLocaleCompare:function(){if(h===void 0){try{"a".localeCompare("b","i")}catch(e){return h=e.name==="RangeError"}h=!1}return h},showFirstRunDialog:function(){return!KindleHostDeviceDetector.isMSEdge()},hasPageResizeIssues:function(){return KindleHostDeviceDetector.isiOS_9x()?!0:!1},hasSplitView:function(){return KindleHostDeviceDetector.isiOS()&&KindleHostDeviceDetector.getOSMajorVersion()>=9}}}(),KindleHostDeviceDetector=function(){function f(){return navigator.platform.indexOf("iPad")!==
-1}function h(){return navigator.platform.indexOf("iPhone")!==-1||navigator.platform.indexOf("iPod")!==-1}function e(){return f()||h()||k()}function d(){var a=-1;e()&&(a=navigator.userAgent.match(/OS (\d+)_/)[1]);return a}function c(){return(f()||h())&&parseInt(d(),10)===7}function a(){return(f()||h())&&parseInt(d(),10)>=8}function g(){return(f()||h())&&parseInt(d(),10)>=9}function b(){return navigator.userAgent.indexOf("Firefox")!==-1&&navigator.userAgent.indexOf("Trident")<0}function j(a){var b=
navigator.userAgent.match(/Version\/(\d+\.\d+)(?:\.\d+)*(?: Mobile\/\S+)? Safari/);return!b?!1:!a?!0:Number(b[1])>=Number(a)}function k(){return navigator.userAgent.indexOf("Cloud9")!==-1}function m(){return navigator.userAgent.indexOf("MSAppHost")!==-1}function l(){return m()&&p()}function p(){return!!/arm/i.test(navigator.cpuClass)}function q(){return b()?navigator.onLine:KindleModuleManager.getModuleSync(KindleModuleManager.NETWORK).isOnline()}function o(){return navigator.userAgent.indexOf("MSIE")!==
-1||navigator.userAgent.indexOf("Trident")!==-1}function n(){return navigator.userAgent.indexOf("Chrome")!==-1&&navigator.userAgent.indexOf("Safari")!==-1&&navigator.userAgent.indexOf("Edg")!==-1}function r(){return"standalone"in navigator&&navigator.standalone}function t(){return window.chrome&&Kindle.top.chrome.app&&Kindle.top.chrome.app.isInstalled}function u(){return window.navigator.msMaxTouchPoints>=1}return{isiOS:e,isiPad:f,isiPhone:h,isiOS_4x:function(){return(f()||h())&&navigator.userAgent.indexOf("OS 4")!==
-1},isiOS_5xOrGreater:function(){return(f()||h())&&parseInt(d(),10)>=5},isiOS_7x:c,isiOS_8x:a,isiOS_9x:g,hasiOSInnerHeightBug:function(){return!g()&&(c()||a())},hasCanvasSizeLimitProblem:function(){return e()},isMacintosh:function(){return navigator.userAgent.indexOf("(Macintosh;")!==-1},isFirefox:b,hasHangingDbPrompt:function(){if(!b())return!1;var a=/Firefox\/(\d+)/.exec(navigator.userAgent);return a.length>=1&&a[1]>=17},isSafari:j,isMetro:m,isMetroArm:l,isMetroSnappedView:function(){return m()&&
window.outerWidth===320},isIE:o,isIE10:function(){return o()&&navigator.userAgent.indexOf("Trident/6.0")!==-1},isIE11:function(){return o()&&(navigator.userAgent.indexOf("Trident/7.0")!==-1||navigator.userAgent.indexOf("Trident/8.0")!==-1)},isMSEdge:n,isArm:p,isCloud9:k,isTablet:function(){return f()||m()},isOnline:q,isPageVisibilityApiSupported:function(){var a;typeof document.hidden!=="undefined"?a="hidden":typeof document.msHidden!=="undefined"?a="msHidden":typeof document.webkitHidden!=="undefined"&&
(a="webkitHidden");return a!==void 0&&typeof document.addEventListener!=="undefined"},getPageVisibilityApiTerms:function(){var a,b;typeof document.hidden!=="undefined"?(a="hidden",b="visibilitychange"):typeof document.msHidden!=="undefined"?(a="msHidden",b="msvisibilitychange"):typeof document.webkitHidden!=="undefined"&&(a="webkitHidden",b="webkitvisibilitychange");return{hidden:a,visibilityChange:b}},isNetworkAvailable:function(){if(!q())return(new jQuery.Deferred).reject().promise();var a=$.Deferred();
$.ajax({url:"/ping",error:function(){a.reject()},timeout:5E3}).then(a.resolve,a.reject);return a.promise()},isNetworkAvailableSync:function(){if(!q())return!1;var a=!0;$.ajax({url:"/ping",error:function(){a=!1},timeout:50,async:!1});return a},isChrome:function(){return window.chrome&&!n()},isiOSAppMode:r,isChromeApp:t,isFirefoxAppSupported:function(){return!!KindleHostDeviceDetector.isFirefox()&&window.navigator.mozApps},isInAppMode:function(){return r()||t()},isCookieEnabled:function(){return navigator.cookieEnabled},
areWebWorkersSupported:function(){return typeof Worker!=="undefined"},isLocalStorageEnabled:function(){return KindleLocalStorage.isLocalStorageEnabled()},hasArrayLikeApply:function(){return!e()||parseInt(KindleHostDeviceDetector.getOSMajorVersion(),10)>=6},isWebSQLSupported:function(){return!!window.openDatabase},isIndexedDBSupported:function(){return!!window.mozIndexedDB||!!window.indexedDB},isMSTouchEnabledDevice:u,isTouchDevice:function(){return e()||u()},getDevicePlatform:function(){return f()?
"iPad":h()?"iPhone":k()?"otter":l()?"metroArm":m()?"metro":"desktop"},hasCanvasPerformanceProblem:function(){return f()&&KindleHostPadDetector.isPad1(r())||l()},hasMissingImgOnLoadProblem:function(){return j()||r()||b()},hasImageRenderingProblem:function(){return j()||r()},getDeviceType:function(){return m()?Kindle.DeviceType.Metro:Kindle.DeviceType.KCR},getClientName:function(){return m()?Kindle.ClientName.Metro:Kindle.ClientName.KCR},getOSMajorVersion:d,getOSMinorVersion:function(){var a=-1;e()&&
(a=navigator.userAgent.match(/OS (\d+)_(\d+_?(\d+)?)/)[2]);return a},getBrowserLanguage:function(){return navigator.language||navigator.userLanguage}}}(),KindleHostPadDetector=function(){return{isPad1:function(f){if(KindleLocalStorage.getItem("definitelyNotPad1"))return!1;var h=0,e=1E3,d=0,c;for(i=0;i<3;i++)c=SunSpiderBenchmark.get3DSpeed(),c>h?h=c:c<e&&(e=c),d+=c;h=d/3;if(h>=200&&f)return!0;if(h>=100&&!f)return!0;KindleLocalStorage.setItem("definitelyNotPad1","true");return!1}}}();
function KindleInterfacesFactory(){function f(f,e){for(var d in e)if(e.hasOwnProperty(d)&&typeof f[d]!==typeof e[d])return!1;return!0}return{IKindleLibrary:{onReaderOpenStatus:function(){},onReaderClose:function(){},onStoreOpenStatus:function(){},libraryUpdateNeeded:function(){}},IKindleReader:{openBook:function(){},unloadReader:function(){},onStoreOpenStatus:function(){},pauseReader:function(){},resumeReader:function(){},setToolbarVisible:function(){},downloadBook:function(){},removeBook:function(){}},
IKindleAppForLibrary:{storeIsTOS:function(){},openStore:function(){},openBook:function(){},onLibraryLoaded:function(){},getQueryParameters:function(){}},IKindleAppForReader:{onReaderReady:function(){},closeReader:function(){},onStartReadingStatus:function(){},onRendererLoaded:function(){},openStore:function(){},pinBookToStart:function(){},onReaderTapped:function(){},onUserAction:function(){},hideAppBar:function(){}},checkImplements:f,assertImplements:function(h,e){f(h,e)||KindleAssert(!1,"Object fails to provide all properties of interface prototype")}}}
var KindleInterfaces=KindleInterfacesFactory(),KindlJournalManager=function(){function f(a){var c=[],d;for(d in a){var e=a[d].entry;e.guid=e.guid||e.refEmId;delete e.refEmId;e&&c.push(e)}return c}function h(b){var d=[],e;for(e in b)d.push({entry:b[e]});return a.getAppDb().getTable(c).insertList(d)}function e(b){function c(){var p,q=KindleModuleManager.getModuleSync(KindleModuleManager.RESOURCE_BUNDLE).getLocalTimeOffset();e<b.length?(h=Math.min(e+100,b.length),p=Array.prototype.slice.call(b,e,h),
e=h,g.updateAnnotations(f(p),q).then(function(){a.getAppDb().deleteJournalEntries(p).then(c,d.reject)},d.reject)):d.resolve()}var d=new jQuery.Deferred,e=0,h;c();return d.promise()}function d(){var b=new jQuery.Deferred;a.getAppDb().getTable(c).getRecord().then(function(a){a.length>0?e(a).then(b.resolve,b.reject):b.resolve()},b.reject);return b.promise()}var c="journal",a=null,g=null;return{initialize:function(){var b=new jQuery.Deferred,c=this;KindleModuleManager.getModuleList([KindleModuleManager.SERVICE_CLIENT,
KindleModuleManager.DB_CLIENT]).then(function(d){g=d[KindleModuleManager.SERVICE_CLIENT];a=d[KindleModuleManager.DB_CLIENT];b.resolve(c)},b.reject);return b.promise()},saveToJournal:function(a){var c=new jQuery.Deferred;h(a).then(function(){d().then(c.resolve,c.resolve)},c.reject);return c.promise()},uploadJournal:d}}(),KindleLegacyDeviceTokenStorage=function(){return{hasDeviceTokenFromStorage:function(){return KindleLocalStorage.getItem("kindleDeviceToken")!==null},getDeviceTokenFromStorage:function(){return KindleLocalStorage.getItem("kindleDeviceToken")},
setDeviceToken:function(f){KindleLocalStorage.setItem("kindleDeviceToken",f)},clearDeviceTokenFromStorage:function(){KindleLocalStorage.removeItem("kindleDeviceToken")}}}(),KindleMetricsProfiler=function(f){function h(d){for(var c=0,a=0;a<d.length;a+=1)c+=d[a].end-d[a].start;return c}var e={};e.name=f;e.counters=null;e.subTimers=null;e.runs=[{start:(new Date).getTime(),end:null}];e.endTimer=function(){var d=this.runs[this.runs.length-1];if(d.end===null)d.end=(new Date).getTime()};e.addCount=function(d,
c){if(this.counters===null)this.counters={};this.counters[d]===void 0?this.counters[d]=c:this.counters[d]+=c};e.createSubTimer=function(d){if(this.subTimers===null)this.subTimers={};this.subTimers[d]===void 0?this.subTimers[d]=KindleMetricsProfiler(d):this.subTimers[d].runs.push({start:(new Date).getTime(),end:null});return this.subTimers[d]};e.log=function(){this.logAsPercentageOfTime("",h(this.runs))};e.logAsPercentageOfTime=function(d,c){var a=d+":"+this.name,e,b=h(this.runs);KindleDebug.log(a+
":Time: "+b+"ms - ("+(c?b/c*100:100).toFixed(2)+"%)");for(e in this.counters)KindleDebug.log(a+":"+e+" : "+this.counters[e]);for(e in this.subTimers)this.subTimers[e].logAsPercentageOfTime(a,c)};return e},KindleRemoteClient=function(){return{uploadFeedback:function(f){if(!f)return(new $.Deferred.reject).promise();var h=KindleLibrarySetting.getSettings(),h={DevicePlatform:KindleHostDeviceDetector.getDevicePlatform(),UserAgent:navigator.userAgent,WindowHeight:window.innerHeight,WindowWidth:window.innerWidth,
AppCached:!!KindleLocalStorage.getItem("cached"),AppCacheStatus:window.applicationCache.status,TouchEnabled:KindleHostDeviceDetector.isTouchDevice(),ApplicationMode:KindleHostDeviceDetector.isInAppMode(),Language:navigator.language,LocalStorageEnabled:KindleHostDeviceDetector.isLocalStorageEnabled(),LibrarySort:h.sortParam,LibraryView:h.viewState,TLD:Kindle.URL.getAmazonDomain()||"unknown"};return function(e){return KindleModuleManager.getModule(KindleModuleManager.DB_CLIENT).pipe(function(d){try{var c=
d.getAppDb(),a=c.getCachedAsins(Kindle.BookInfo.CachedState.FULLY_DOWNLOADED),g=c.getAllBooks();e.info.OfflineStorageEnabled=!!d.bookDbEnabled();return $.when(a,g)}catch(b){return $.Deferred.reject()}}).pipe(function(d,c){$.extend(e.info,{TotalBookCount:c.length,TotalBookDownloaded:d.length});return e.eid?e.eid:KindleModuleManager.getModuleSync(Kindle.MODULE.SERVICE_CLIENT).getEID()}).pipe(function(d){e.eid=d;return e},function(){return $.Deferred().resolve(e)})}({version:KindleVersion.getVersionString(),
message:f.text,deviceType:KindleHostDeviceDetector.getDeviceType(),info:h}).pipe(function(e){e={url:"/remote/feedback",type:"POST",processData:!1,contentType:"application/json",data:JSON.stringify(e)};return $.ajax(e)})}}}(),KindleTemplateManager=function(){return{initialize:function(){Handlebars.registerHelper("str",function(f){return ResourceBundle.getLocalizedString(f)})}}}(),KindleUserAgentMetricsInfo=function(){function f(){function a(){var b=/MSAppHost\/([0-9\.]+)/.exec(navigator.userAgent);
if(b)return b[1]}var c;if(!(c=function(){var a;if(["ipad","iphone"].indexOf(e)!==-1&&(e="ios",(a=/CPU OS ([0-9_]+) /.exec(navigator.userAgent))&&a.length>=2))return a[1]}())){var d;KindleHostDeviceDetector.isIE()&&(d=KindleHostDeviceDetector.isIE10()?"10":KindleHostDeviceDetector.isIE11()?"11":"unknown");c=d||a()||GoogleUserAgent.browserVersionString.toLowerCase()}return c}var h,e,d,c,a,g={chrome:14,firefox:7,safari:5,metro:1,ie:10,ios:4,edge:16};return{browserWithVersionString:function(){if(!h){e=
GoogleUserAgent.browserName.toLowerCase();d=f();a:{if(d){var b=/^0*([0-9]+)/.exec(d);if(b&&b.length>=2){c=parseInt(b[1],10);break a}else KindleDebug.error("Bad regex on versionString: "+d)}c=void 0}a="undefined"===typeof c?"other":g[e]?[e,c].join("@"):"other";h=!0}return a}}}(),KindleVersion=function(){var f="011213999";window.location.hostname==="k4w-dev.aka.amazon.com"&&(f="999999998");if(f.length!==9)throw{name:"BadVersion",message:"bad version number. got: "+f};var h=null,e=null;return{getMetricsVersionString:function(){e||
(e=parseInt(f.slice(0,2),10),e+=".",e+=parseInt(f.slice(2,4),10),e+=".",e+=parseInt(f.slice(4,6),10));return e},getVersionString:function(){h||(h=parseInt(f.slice(0,2),10),h+=".",h+=parseInt(f.slice(2,4),10),h+=".",h+=parseInt(f.slice(4,6),10),h+=".",h+=parseInt(f.slice(6),10));return h},getVersionNumber:function(){return Number(f)},parseVersionString:function(d){return d&&(d=/(\d{1,2})\.(\d{1,2})\.(\d{1,2})\.(\d{1,3})/.exec(d))?Number(d[1])*1E7+Number(d[2])*1E5+Number(d[3])*1E3+Number(d[4]):NaN}}}(),
LinkUrls=function(){function f(){d||(Kindle.URL.isPreProd()?(e=(e=Kindle.URL.getPreProdCountryCode())?e:"us",d=Kindle.CountryToDomainMap[e]):(d=Kindle.URL.getAmazonDomain(),e=Kindle.DomainToCountryMap[d]))}function h(d){return $.Deferred().resolve(function(){var e;e=c+Kindle.CountryToDomainMap.us+a;e+="?"+b.DeviceType+"="+Kindle.DeviceType.KCR+"&"+b.Eid+"="+(k||"")+"&"+b.Method+"="+d;return e}())}var e,d,c="https://www.",a="/gp/kindle/kcp/links",g={Help:{NodeId:"200701430"},OfflineReading:{NodeId:"201255020"},
IncreaseOfflineStorage:{NodeId:"201265520"},TroubleShooting:{NodeId:"200732370"},License:{NodeId:"200701450",RefTag:"kcr_legalnotices_menu"},KCPLanding:{DocId:{us:"1000493771",uk:"1000425503",de:"1000482783",fr:"1000538763",it:"1000576423",es:"1000576363",jp:"3077089376",au:"3077705566",cn:"98968","in":"1000659093",ca:"1000817631",br:"1000828031",mx:"1001216041"},iTunesURL:"https://itunes.apple.com/",iTunesEndPoint:"/app/apple-store/id302584613?mt=8",DesktopEndpoint:"/gp/feature.html",DesktopQueryParam:"?ie=UTF8&docId="}},
b={DeviceType:"deviceType",Eid:"eid",Method:"method",Asin:"a"},j={Help:"Help",Legal:"License",Terms:"TermsCond",Store:"StoreFront",Privacy:"Privacy",DetailPage:"DetailPage"},k;return{getStoreUrl:function(a){if(k&&!a.kcrFree)return h(j.Store).pipe(function(b){a.tag&&(b+="&tag="+a.tag);a.refTag&&(b+="&ref_="+a.refTag);return b});else{f();var b=c+d+"?ref_="+a.refTag;a.tag&&(b+="&tag="+a.tag+"&at="+a.tag);return $.Deferred().resolve(b)}},getPrivacyUrl:function(){f();return c+d+"/privacy"},getTermsOfUseUrl:function(){return"http://www.kindle.com/support/terms"},
getLegalUrl:function(){f();return c+d+"/gp/help/customer/display.html?nodeId="+g.License.NodeId+"ref="+g.License.RefTag},getHelpUrl:function(){f();return c+d+"/gp/help/customer/display.html?nodeId="+g.Help.NodeId},getOfflineReadingUrl:function(){f();return c+d+"/gp/help/customer/display.html?nodeId="+g.OfflineReading.NodeId},getIncreaseOfflineStorageUrl:function(){f();return c+d+"/gp/help/customer/display.html?nodeId="+g.IncreaseOfflineStorage.NodeId},getTroubleShootingUrl:function(){f();return c+
d+"/gp/help/customer/display.html?nodeId="+g.TroubleShooting.NodeId},getDetailPage:function(a){if(k&&!a.kcrFree)return h(j.DetailPage).pipe(function(c){c+="&"+b.Asin+"="+a.asin;a.tag&&(c+="&tag="+a.tag);a.refTag&&(c+="&ref_="+a.refTag);return c});else{f();var e=c+d+"/dp/"+a.asin+("?ref_="+(a.refTag||Kindle.RefTag.Values.StoreSample));a.tag&&(e+="&tag="+a.tag+"&at="+a.tag);return $.Deferred().resolve(e)}},getKCPLandingPageLink:function(a){(!d||!e)&&f();var b;KindleHostDeviceDetector.isiPad()?b=g.KCPLanding.iTunesURL+
e+g.KCPLanding.iTunesEndPoint:(b=c+d+g.KCPLanding.DesktopEndpoint,b=a?b+"/ref="+a:b,b+=g.KCPLanding.DesktopQueryParam+g.KCPLanding.DocId[e]);return b},getDownloadLink:function(a){(!d||!e)&&f();var b=c+d+"/gp/kindle/kcpApp.html";return a?b+"/ref="+a:b},getAmazonDomainURL:function(){(!d||!e)&&f();return c+d},getRTEServiceURL:function(){(!d||!e)&&f();if(Kindle.URL.isPreProd()){var a="https://kindlestore-preprod";if(e==="it"||e==="es"||e==="in")a+="-eux";return a+"."+d+"/kindle-dbs/ajax/SendSMSorEmail"}return this.getAmazonDomainURL()+
"/kindle-dbs/ajax/SendSMSorEmail"},getNotebookURL:function(a,b){var c=Kindle.URL.getHostURL()+"/notebook",d=[];a&&d.push("asin="+a);b&&d.push("ref_="+b);return c=d?c+"?"+d.join("&"):c},initializeEid:function(a){k=a}}}(),KindleChromeInstaller=function(){function f(){function e(){window.location.reload(!1)}Kindle.top.chrome.webstore.install(void 0,function(){KindleDebug.log("install success");setTimeout(e,250)},function(d){KindleDebug.error(d)})}function h(){return window.chrome&&Kindle.top.chrome.webstore&&
Kindle.top.chrome.webstore.install}return{install:function(){h()?window.parent.document.getElementById("inlineInstallProxy").click():KindleMessageDialog.showError(Kindle.ERROR.OUTDATED_CHROME)},initialize:function(){if(KindleHostDeviceDetector.isChrome()&&h()){var e=document.createElement("button");e.id="inlineInstallProxy";e.style.display="none";$(e).click(f);$("body").append(e)}}}}(),KindleFirefoxInstaller=function(){function f(){return Kindle.URL.getHostURL()+"/offline/kcr_ff.webapp"}function h(){if(!KindleHostDeviceDetector.isFirefoxAppSupported())return $.Deferred().reject().promise();
var e=$.Deferred(),d=navigator.mozApps.getInstalled();d.onsuccess=function(){var c=!1,a=f();d.result.forEach(function(d){d.manifestURL===a&&(c=!0)});e.resolve(c)};d.onerror=function(){KindleDebug.error("Error checking installation status: "+this.error.message);e.reject()};return e.promise()}return{install:function(){var e=$.Deferred();h().done(function(d){d?e.reject():(d=navigator.mozApps.install(f()),d.onsuccess=function(){KindleDebug.log("Firefox App successfully installed.");e.resolve()},d.onerror=
function(){KindleDebug.error("Firefox App failed to install.");e.reject()})}).fail(e.reject);return e.promise()}}}(),KindleJPMerchandiseManager=function(){return{getBookList:function(){return $.ajax({url:"/kcpextservice_jp/external-service?method=getCampaign&slotName=right-3&deviceType="+Kindle.DeviceType.KCR+"&userCode=KcrKin&storeType=ebooks",dataType:"json"}).pipe(function(f){return f&&f.data&&f.data.items?f.data.items:[]},function(){return[]})}}}(),KindleLibrary=function(){function f(){KindleLibraryHomeScreenPopup.show();
KindleLibraryControlBar.setCacheDone()}function h(){KindleLibraryScrollPane.checkForBadgeUpdates();v().getAllBooks().done(x)}function e(a){KindleSpinner.hide();a===Kindle.STORE.OFFLINE_ERROR?F(Kindle.ERROR.STORE_OPEN_OFFLINE_FAILED):a===Kindle.STORE.GENERIC_ERROR&&F(Kindle.ERROR.STORE_OPEN_FAILED)}function d(){U||(KindleHostDeviceDetector.isiOS()?KindleLibraryHeaderBar.dismissKeyboard():KindleLibraryHeaderBar.deactivateSearch());return!1}function c(){var b={breakdown:["Browser"]};KindleLocalStorage.getItem(Kindle.App.LIBRARY_FAIL_FLAG)?
E.emit("Library::OpenLibraryFail",b):KindleLocalStorage.setItem(Kindle.App.LIBRARY_FAIL_FLAG,"true");M=E.startMetrics("Library::OpenLibrary",b);KindleSpinner.show();KindleLibrarySetting.initialize();J=KindleHostDeviceDetector.isiPad();KindleLibraryContentList.addChangeListener(a);g().then(function(){v().getBookDataLastSyncTime(o);KindleHostDeviceDetector.isiOS_5xOrGreater()?$("body",Kindle.top.document).bind("orientationchange.library",m):$(window).resize(m);$(window).keydown(l);$(window).keyup(p);
KindleWindowSizeWatcher.setMetricsContext("Library");KindleDeviceCapabilities.hasSplitView()&&KindleWindowSizeWatcher.startPolling();KindleHostDeviceDetector.isiOS()?$("#page_body").bind("touchstart",d):$("#page_body").bind("click",d);KindleHostDeviceDetector.hasiOSInnerHeightBug()&&$("body").addClass("iosInnerHeightBug");KindleHostDeviceDetector.isiOS()||$(window).focus(function(){ea.checkTokenConsistency()});KindleOffline.isEnabled()?v().getCachedAsins(void 0).then(function(a){var b,c,d={};d[Kindle.BookInfo.CachedState.CACHED]=
0;d[Kindle.BookInfo.CachedState.PINNED]=0;for(b in a)c=a[b],d[c.cacheState]++;d[Kindle.BookInfo.CachedState.CACHED]&&E.increaseSubCounter(M,"booksCached",d[Kindle.BookInfo.CachedState.CACHED]);d[Kindle.BookInfo.CachedState.PINNED]&&E.increaseSubCounter(M,"booksPinned",d[Kindle.BookInfo.CachedState.PINNED])}):E.increaseSubCounter(M,"noOffline",1)})}function a(a,b){KindleLibraryScrollPane.setLayout(KindleLibrarySetting.getLastLayoutView());var c=KindleLibraryScrollPane.displayBooks(a,b);b&&c===0?KindleLibraryMessagePane.showEmptySearchMessage(!KindleHostDeviceDetector.isOnline()):
KindleLibraryMessagePane.hideEmptySearchMessage()}function g(){var a;C();I();a=KindleLibrarySetting.getSettings();a=KindleLibraryScrollPane.initialize(a,s,w,A,z);D();if(KindleDeviceCapabilities.hasSplitView())KindleWindowSizeWatcher.onWindowResized();KindleLibrarySetting.getLastLibraryView()==="downloaded"&&(KindleLibraryScrollPane.setView("downloaded"),KindleLibrarySetting.setLibraryView("downloaded"));!J&&!KindleHostDeviceDetector.isIE()&&P();return a}function b(){KindleLibraryHeaderBar.setSyncButtonDisabled(!0);
KindleSpinner.show();v().getBookDataLastSyncTime(o)}function j(){fa=!0;b()}function k(){Q.openNotebook()}function m(){S?X=!0:(KindleLibraryContextMenu&&KindleLibraryContextMenu.hide(),da())}function l(a){if(!S)switch(a.which){case 38:KindleLibraryScrollBar.moveStart(!0);break;case 40:KindleLibraryScrollBar.moveStart(!1)}}function p(a){if(!S)switch(a.which){case 33:KindleLibraryScrollBar.movePage(!0);break;case 34:KindleLibraryScrollBar.movePage(!1);break;case 27:KindleLibraryHeaderBar.deactivateSearch(!0);
break;default:KindleLibraryScrollBar.moveEnd()}}function q(a){fa?(B(),KindleHostDeviceDetector.isOnline()?F(Kindle.ERROR.SYNC_FAILED):F(Kindle.ERROR.SYNC_FAILED_OFFLINE)):a?v().getAllBooks().done(u):KindleMessageDialog.showError(Kindle.ERROR.LIBRARY_LOAD_FAILED,function(){o(Kindle.DB.NEVER)},ResourceBundle.getLocalizedString("k_dialog_message_retryButton_text"))}function o(a){var b=a===Kindle.DB.NEVER?null:a;KindleHostDeviceDetector.isOnline()?(M&&b!==null&&E.modifyMetricsMethod(M,"Library::OpenLibraryCached"),
ea.getOwnedContent(b,fa?"Customer":b?"KindleForegrounded":"Registration").then(function(a){ia.getBookDb()&&a.asinsToAdd&&!$.isEmptyObject(a.asinsToAdd)&&n(a.asinsToAdd);v().updateBookData(a.asinsToRemove,a.asinsToAdd,a.syncTime).then(t,r)},function(){q(b!==null)})):(M&&E.modifyMetricsMethod(M,"Library::OpenLibraryOffline"),q(b!==null))}function n(a){v().getCachedAsins(Kindle.BookInfo.CachedState.FULLY_DOWNLOADED,!0).then(function(b){if(b.length>0){var c={};b.forEach(function(b){if(a[b.asin]&&a[b.asin].contentType===
Kindle.CONTENT_TYPE.EBOK&&b.context.contentType===Kindle.CONTENT_TYPE.EBSP){var d=b.context;d.contentType=a[b.asin].contentType;c[b.asin]={cacheState:b.cacheState===Kindle.BookInfo.CachedState.PINNED?Kindle.BookInfo.CachedState.PINNING:Kindle.BookInfo.CachedState.PARTIAL,cachedSize:null,context:d}}});$.isEmptyObject(c)||ia.getBookDb().updateBookInfos(c)}},function(){})}function r(){KindleLibraryHeaderBar.setSyncButtonDisabled(!1)}function t(a){fa&&a===0?B():v().getAllBooks().done(function(b){var c=
[];b.forEach(function(a,b,d){if(a.title===void 0||a.authors===void 0)c.push({operation:Kindle.DB.DELETE_RECORD_OPERATION,tableName:"bookdata",params:[{asin:a.asin}]}),delete d[b]});c.length>0&&v().batchTransaction(c);u(b,a===0)})}function u(a,b){U&&y(U);v().getCachedAsins(Kindle.BookInfo.CachedState.FULLY_DOWNLOADED).then(function(c){a.length===0?KindleLibraryMessagePane.showEmptyLibraryMessage():(KindleLibraryMessagePane.hideEmptyLibraryMessage(),$.isEmptyObject(c)?KindleLibraryNoDownloadedMessage.show():
KindleLibraryNoDownloadedMessage.hide(),KindleLibraryScrollPane.updateCachedAsins(c),KindleLibraryContentList.handleBookData(a,b));B();M&&(E.increaseSubCounter(M,KindleLibrarySetting.getLastLayoutView(),1),E.increaseSubCounter(M,KindleLibrarySetting.getLastLibraryView(),1),E.increaseSubCounter(M,"bookCount",la.length),E.endMetrics(M),M=void 0)})}function G(a){if(a&&a.length>0)for(var b=0;b<a.length;b++)if(a[b].contentType==="EBOK")return!0;return!1}function x(a){a=!G(a);Kindle.URL.isJPDomain()&&a&&
KindleJPMerchandiseManager.getBookList().then(function(a){function b(a){W({asin:a,openInNewTab:!0,refTag:Kindle.RefTag.Values.StorePromoMangaJP});E.emitNow("Library::JPMerch::ClickBookCoverToStore")}function c(){E.emitNow("Library::JPMerch::Closed")}a&&a.length>3?(KindleLibraryJPMerchandiseDialog.open(a,b,c),E.emitNow("Library::JPMerch::Shown")):E.emitNow("Library::JPMerch::getCampaignEmpty");E.emitNow("Library::JPMerch::getCampaignSuccess")},function(){E.emitNow("Library::JPMerch::getCampaignFail")})}
function B(){fa=!1;U=void 0;KindleSpinner.hide();KindleLibraryHeaderBar.setSyncButtonDisabled(!1);ma&&(ma=!1,v().getAllBooks().done(x));Q.onLibraryLoaded();KindleLocalStorage.removeItem(Kindle.App.LIBRARY_FAIL_FLAG)}function D(){KindleLibraryMessagePane.initialize(function(a){$("#message_container").append(a)},function(){Kindle.URL.isJPDomain()?L.gotoURL("http://www.amazon.co.jp/gp/feature.html?docId=3077720936&ref_="+Kindle.RefTag.Values.StorePromoMangaJP,!0):W({isSourceEmptyLibBtn:!0})},Kindle.URL.isJPDomain())}
function w(a,b){function c(a,b){return s(a.asin,b)}function d(a){var b={asin:a.asin},c=E.startMetrics("Library::SaveBook",{breakdown:["Browser"]});v().getBookDataLastSyncTime(o);KindleOffline.pinBook(b,F).then(function(b,d){var e=["::"+b];b===Kindle.BookInfo.BookType.MOBI8&&(d?e.push("::mobi8::scrambled"):e.push("::mobi8::unscrambled"));E.endMetrics(c,e);y(a.asin)},function(){E.cancelMetrics(c)})}function e(a){KindleOffline.removeBook({asin:a.asin},function(){y(a.asin)},function(a){F(a===Kindle.ERROR.NETWORK?
Kindle.ERROR.REMOVE_NETWORK_FAILURE:Kindle.ERROR.REMOVE_FAILURE)})}function g(a){E.emit("Library::RemoveOwnershipDialog::Shown");(function(){var b=$.Deferred();KindleMessageDialog.open(ResourceBundle.getLocalizedString("k_L_dialog_delete_prompt_title"),ResourceBundle.getLocalizedString("k_L_dialog_delete_prompt",{bookTitle:a.title}),null,null,[{buttonText:ResourceBundle.getLocalizedString("k_L_dialog_delete_cancel"),callback:b.reject},{buttonText:ResourceBundle.getLocalizedString("k_L_dialog_delete"),
callback:b.resolve}]);return b.promise()})().done(function(){E.emit("Library::RemoveOwnershipDialog::Initiated");ea.removeOwnership(a.asin,a.contentType).done(function(){var b=[];b.push({asin:a.asin});v().updateBookData(b,[]).done(t)}).fail(function(){F(Kindle.ERROR.REVOKE_FAILED)})}).fail(function(){E.emit("Library::RemoveOwnershipDialog::Cancelled")})}U||v().getBookCachedState(a.asin).done(function(f){var j=KindleOffline.isEnabled()?KindlePopupMenu.ITEM_ENABLED:KindlePopupMenu.ITEM_DISABLED,h=KindlePopupMenu.ITEM_ENABLED,
k=KindlePopupMenu.ITEM_HIDDEN,j=KindleHostDeviceDetector.isOnline()?j:KindlePopupMenu.ITEM_DISABLED,l=Kindle.CONTENT_TYPE.EBSP===a.contentType,n="unknown";if(f&&f.length>0)n=f[0].cacheState;switch(n){case Kindle.BookInfo.CachedState.PINNED:f=[h,k,j,k,l?h:k];break;case Kindle.BookInfo.CachedState.CACHED:f=[h,j,j,k,l?h:k];break;default:f=[h,k,k,j,l?h:k]}KindleLibraryContextMenu.show(a,f,b,[c,d,e,d,g])})}function A(a,b,c){J||(c>=a?$("#slide_container").removeClass("scrollbar_shown"):($("#slide_container").addClass("scrollbar_shown"),
KindleLibraryScrollBar.updateValueRange(a,b,c)))}function z(a){KindleLibraryScrollBar.updateValue(a)}function H(){KindleLibrarySettingsMenu.show(Q.openExternalLink)}function C(){var a,b,c=KindleLibraryHeaderBar,d={},e={};d[c.EVENT_NOTEBOOK_CLICKED]=k;d[c.EVENT_SYNC_CLICKED]=j;d[c.EVENT_MANAGE_CLICKED]=H;d[c.EVENT_STORE_CLICKED]=function(){W({})};e[c.SEARCH_CALLBACK.ENABLE]=function(){a=!KindleHostDeviceDetector.isOnline()?"downloaded":"cloud";KindleLibraryControlBar.hideViewTabs();b=KindleLibraryScrollPane.setView(a)};
e[c.SEARCH_CALLBACK.SEARCH]=KindleUtils.debounce(function(b){KindleLibraryContentList.setSearchString(b);KindleLibraryScrollPane.setView(a)},200);e[c.SEARCH_CALLBACK.DISABLE]=function(){KindleLibraryMessagePane.hideEmptySearchMessage();KindleLibraryContentList.setSearchString(null);KindleLibraryScrollPane.setView(b);KindleLibraryControlBar.showViewTabs()};c.initialize(function(a){$("body").append(a);na.resolve()},d,e)}function I(){var a=KindleLibraryControlBar;a.setRetryCallback(R);a.setAppCacheStatusGetter(L.getSharedModuleSync(Kindle.MODULE.APPCACHE_EVENTHANDLER).getCacheStatus);
var b={};b[a.EVENT_LIBRARY_SORT_CLICKED]=ha;b[a.EVENT_LIBRARY_LAYOUT_CLICKED]=ca;b[a.EVENT_LIBRARY_IMAGE_CHANGING]=N;b[a.EVENT_LIBRARY_IMAGE_CHANGED]=O;b[a.EVENT_LIBRARY_VIEW_CLICKED]=T;a.initialize(function(a){$("#page_body_content_containers").prepend(a)},KindleLibrarySetting.getSettings(),b)}function P(){KindleLibraryScrollBar.initialize(function(a){$("#slide_container").append(a)},K)}function K(a,b){KindleLibraryScrollPane.setScrollValue(a,b)}function N(a,b){KindleLibraryScrollPane.updateCoverSize(b.value,
!1)}function O(a,b){var c=b.value;KindleLibrarySetting.setCoverSize(c);KindleLibraryScrollPane.updateCoverSize(c,!0)}function y(a){v().getBookCachedState(a).done(function(b){KindleLibraryScrollPane.updateBookCacheState(a,b.length>0?b[0].cacheState:"");KindleLibraryScrollPane.checkForBadgeUpdates();v().getCachedAsins(Kindle.BookInfo.CachedState.FULLY_DOWNLOADED).then(function(a){$.isEmptyObject(a)?KindleLibraryNoDownloadedMessage.show():KindleLibraryNoDownloadedMessage.hide()})})}function T(a){function b(){KindleLibraryScrollPane.setView(a);
KindleLibrarySetting.setLibraryView(a);KindleLibraryControlBar.setViewState(a)}a!==KindleLibrarySetting.getLastLibraryView()&&(!KindleHostDeviceDetector.isOnline()&&a==="cloud"?F(Kindle.ERROR.BOOK_NOT_AVAILABLE):a==="downloaded"&&!KindleOffline.isEnabled()?KindleHostDeviceDetector.isFirefox()?KindleOffline.enableOfflineMessage().done(b):KindleOffline.firstRunMessage().done(b):b())}function W(a){KindleSpinner.show();d();Q.openStore(a)}function s(a,b){a!==null&&!S&&(V=b,KindleHostDeviceDetector.isOnline()?
Z(a):v().getBookCachedState(a).done(function(b){b.length>0&&Kindle.BookInfo.CachedState.isMaybeDownloaded(b[0].cacheState)?Z(a):(E.emit("Library::OpenBookNotAvailable"),F(Kindle.ERROR.BOOK_NOT_AVAILABLE),V&&V())}))}function v(){return ia.getAppDb()}function Z(a){oa=U=a;Q.openBook({asin:a})}function aa(){KindleLibraryHeaderBar.deactivateSearch(!0);KindleDeviceCapabilities.hasSplitView()&&KindleWindowSizeWatcher.stopPolling();V&&V()}function Y(){KindleTouchEventsToggler.isRequired()&&KindleTouchEventsToggler.allowTouchEvents();
X&&(da(),X=!1);b();S=!1}function da(){KindleLibraryScrollPane.resizeScrollPane();if(KindleDeviceCapabilities.hasSplitView())KindleWindowSizeWatcher.onWindowResized()}function F(a,b){a===Kindle.ERROR.FREE_TRIAL_EXPIRED?ga():a===Kindle.ERROR.CONTENT_RENTAL_EXPIRED?ka():a===Kindle.ERROR.CONTENT_UNSUPPORTED?KindleUnsupportedContentDialog.open():(b&&(a={name:a,code:b}),KindleMessageDialog.showError(a))}function ba(a,b,c){a?(S=!0,KindleSpinner.hide(),KindleTouchEventsToggler.isRequired()&&KindleTouchEventsToggler.disallowTouchEvents(),
setTimeout(aa,500)):(F(b,c),V&&V(),Y())}function ha(){var a;a=KindleHostDeviceDetector.isiOS()?"up":"down";KindleLibrarySortMenu.show(a,function(a){if(a!==KindleLibrarySetting.getLastSortParam())document.getElementById("kindleLibrary_button_sort_label").innerHTML=ResourceBundle.getLocalizedString(KindleLibrarySort.getLabel(a)),KindleLibraryContentList.sort(a)})}function ca(a){KindleLibraryScrollPane.setLayout(a);KindleLibrarySetting.setLayoutView(a)}function R(){E.emit("KindleApp:AppCacheError:RetryClicked",
{breakdown:["Browser"]});KindleLibraryAppCacheFailDialog.hasBeenShownThisSession()?(KindleLibraryAppCacheFailDialog.open(),E.emit("KindleApp:AppCacheError:RetryClickedAfterRebootDialogShown",{breakdown:["Browser"]})):Kindle.top.location.reload(!1)}function ka(){var a=!0;E.emit("Library::Rentals:ExpiredDialogShown");var b=function(){var b=U;return function(){a&&(a=!1,E.emit("Library::Rentals:BuyOrRentAgainClicked"));if(b!==void 0){var c="https://www.amazon.com/dp/"+b+"/ref=kcr_store_expired";KindleHostDeviceDetector.isiPad()?
(c+="_ipad",Q.openExternalLink(c)):(c+="_desktop",Kindle.top.location=c)}else KindleDebug.error("no asin selected for BuyOrRentAgainClicked")}}();KindleMessageDialog.showError(Kindle.ERROR.CONTENT_RENTAL_EXPIRED,function(){a&&(a=!1,E.emit("Library::Rentals:DismissClicked"))},ResourceBundle.getLocalizedString("k_dialog_rental_expired_dismiss_button_text"),[{buttonText:ResourceBundle.getLocalizedString("k_common_cancel_button")},{buttonText:ResourceBundle.getLocalizedString("k_dialog_rental_expired_extend_button_text"),
callback:b}])}function ga(){KindleLibraryScrollPane.checkForBadgeUpdates();KindleMessageDialog.showError(Kindle.ERROR.FREE_TRIAL_EXPIRED,null,ResourceBundle.getLocalizedString("k_endOfFreeTrial_Text"),[{buttonText:ResourceBundle.getLocalizedString("k_common_cancel_button")},{buttonText:ResourceBundle.getLocalizedString("k_endOfFreeTrial_buyfullversion_button"),callback:function(){var a="https://www.amazon.com/dp/"+oa+"/ref=kcr_freetrial_expired";KindleHostDeviceDetector.isiPad()?(a+="_ipad",Q.openExternalLink(a)):
(a+="_desktop",Kindle.top.location=a)}}])}var la=[],S=!1,U,J,M,V,X=!1,ia=null,L,Q,E,ea,fa=!1,ma=!0,na,oa;return{initialize:function(){na||(na=jQuery.Deferred());L=window.parent.KindleApp;KindleTouchEventsToggler.isRequired()&&KindleTouchEventsToggler.initialize();L&&($("body").bind("touchmove.elastic",KindleIOSScrollStopper.stopScroll),Q=L.getAppInterfaceForLibrary(),Kindle=L.getSharedModuleSync(KindleModuleManager.CONSTANTS),ResourceBundle=L.getSharedModuleSync(KindleModuleManager.RESOURCE_BUNDLE),
KindleTemplateManager.initialize(),L.setLibraryInterface({onReaderOpenStatus:ba,onReaderClose:Y,onStoreOpenStatus:e,libraryUpdateNeeded:b,onShowLibrary:h}),L.registerEventCallback(Kindle.APP_CACHE.CACHE_PROGRESS,function(a){KindleLibraryControlBar.setCacheProgress(a.progressRatio)}),L.registerEventCallback(Kindle.APP_CACHE.CACHE_CACHED,f),L.registerEventCallback(Kindle.APP_CACHE.CACHE_DONE,f),L.registerEventCallback(Kindle.APP_CACHE.CACHE_NEEDS_RETRY,function(){KindleLibraryControlBar.setCacheNeedsRetry()}),
L.registerEventCallback(Kindle.APP_CACHE.CACHE_NEEDS_BROWSER_RESTART,function(){KindleLibraryControlBar.setCacheNeedsRetry()}),L.registerEventCallback(Kindle.APP_CACHE.CACHE_NEEDS_BROWSER_RESTART,function(){KindleLibraryAppCacheFailDialog.open()}),L.getSharedModules().done(function(a){KindleModuleManager.registerModuleList(a);KindleOffline.isFirstTime()&&!L.getQueryParams().asin&&KindleDeviceCapabilities.showFirstRunDialog()&&KindleOffline.firstRunMessage();!KindleOffline.isFirstTime()&&!KindleLocalStorage.getItem("haveDB")&&
KindleHostDeviceDetector.isFirefox()&&KindleOffline.enableOfflineMessage();E=a[KindleModuleManager.METRICS_MANAGER];ia=a[KindleModuleManager.DB_CLIENT];ea=a[KindleModuleManager.SERVICE_CLIENT];c()}),KindleHostDeviceDetector.isIE()&&document.body.addEventListener("MSHoldVisual",function(a){a.preventDefault()},!1),$("body").bind("contextmenu",function(a){a.preventDefault()}),Q&&Q.getQueryParameters())},registerControlHotkey:function(a,b,c){$(document).keydown(function(d){if(d.keyCode===a.charCodeAt(0)&&
(d.ctrlKey||d.metaKey)&&!d.shiftKey)return d.preventDefault(),b.apply(this,c),!1})},register:function(a,b){return Q.register(a,b)},deregister:function(a,b){return Q.deregister(a,b)},onStoreLinkClicked:function(a){var b={};b[a]=!0;W(b);KindleNotificationDialog.hide();return!1}}}(),KindleX=KindleLibrary,KindleLibraryBookCover=function(){function f(){b||(b=KindleHostDeviceDetector.isiPad()?a:c);return b}function h(a){g||(g=d,g=g.replace("{width}",f().width),g=g.replace("{height}",f().height));var b=
g;return b=b.replace("{asin}",a)}function e(a){var b=$.Deferred(),c=new XMLHttpRequest;c.open("GET",a);c.responseType="arraybuffer";c.onload=function(){var a=c.response,d,e;if(a){if(KindleHostDeviceDetector.hasArrayLikeApply())try{d=[],e=new Uint8Array(a),d.push(String.fromCharCode.apply(null,e))}catch(g){d=null}if(!d){d=[];e=new Uint8Array(a);for(a=0;a<e.length;a++)d.push(String.fromCharCode(e[a]))}d="data:image/jpeg;base64,"+KindleO_Aaa.o_aaa(d.join(""));b.resolve(d)}else b.reject()};c.onerror=
function(){b.reject(c)};c.send();return b.promise()}var d="https://images-na.ssl-images-amazon.com/images/P/{asin}.01._SX{width}_SY{height}_TTXW_SCLZZZZZZZ_.jpg",c={width:255,height:255},a={width:255,height:255},g=null,b=null;return{getBookCoverUrl:h,getOfflineCover:function(a){a=h(a);return KindleHostDeviceDetector.isMSEdge()?KindleImageUtil.getDataUriFromImage(a,"image/jpeg"):e(a)}}}(),KindleLibraryContentList=function(){var f=function(){var d=[],c=[];return{addChangeListener:function(a){c.push(a)},
handleBookData:function(a,e){d=a;c.forEach(function(a){a(d,e)})}}}(),h=function(){function d(b,d,f){var h=c[0];c=b;KindleLibrarySort.sortBookList(c,f);b=c[0];(d||f!==e||h&&b&&h.asin!==b.asin)&&a.forEach(function(a){a(c)});e=f}var c=[],a=[],e;f.addChangeListener(function(a,c){var e=KindleLibrarySetting.getLastSortParam();d(a,c,e)});return{addChangeListener:function(b){a.push(b)},sort:function(a){KindleLibrarySetting.setSortParam(a);d(c,!1,a)}}}(),e=function(){function d(c,d){var f;d?(f=KindleLibrarySearch.doLibrarySearch(d,
c),a=f.set):a=c;e=d;b.forEach(function(b){b(a,d)})}var c=[],a=[],e,b=[];h.addChangeListener(function(a){c=a;d(c,e)});return{addChangeListener:function(a){b.push(a)},setSearchString:function(b){var f;typeof b==="string"||b instanceof String?(b=b.replace(RegExp("[.\\\\+*?\\[\\^\\]$(){}=!<>|:\\-]","g"),"\\$&"),b=$.trim(b)):b="";if(!e||!(e.source&&b===e.source)){if(b)f=RegExp(b,"gi"),b=a&&e&&e.source&&b.search(e)===0?a:c;else{if(a===c)return;e=f=null;b=c}d(b,f)}}}}();return{addChangeListener:e.addChangeListener,
handleBookData:function(d,c){f.handleBookData(d,c)},sort:function(d){h.sort(d)},setSearchString:function(d){e.setSearchString(d)}}}(),KindleLibraryScroller=function(){function f(f,e){var d=new iScroll(f,e),c=d._momentum;d._momentum=function(a,d,b,e,f){a=a===0?0:Math.max(25,Math.abs(a))*(a<0?-1:1);return c(a,d,b,e,f)};return d}return{createScrollerObject:function(h,e){return new f(h,e)}}}(),KindleLibraryScrollPane=function(){function f(){var a=document.styleSheets[2].cssRules;if(a===void 0)a=document.styleSheets[2].rules;
y={};for(var b=0;b<a.length;b++){var c=a[b];if(c.selectorText===".grid_container .book_container")y.grid_style_container=c;if(c.selectorText===".grid_container .book_cover")y.grid_style_bookCover=c;if(c.selectorText===".grid_container .book_is_pinned")y.grid_style_pinned=c;if(c.selectorText===".grid_container .book_sample_badge")y.grid_style_sample_font=c}}function h(){for(var a=0;a<X;a++){var b=J[a],c=U[M+a],d=S[c].find(".book_image");b.height>1&&b.width>1?(d.attr("src",b.src),b.width>b.height&&
(d.removeClass("book_image").addClass("book_image_wide"),S[c].find(".book_image_container").length===1&&KindleBadging.adjustBadge(S[c]))):(d.attr("src",D),W&&(b=S[c].find(".book_title").text(),S[c].find(".alt_title").text(b).show()),ma.emit("Library::UsedBlankCoverImageFallback"))}M+=X;M>=U.length-1?(J=[],U=[],M=0):g();k()}function e(a){var b=M+X-1;a>=M&&a<=b&&(V++,V===X&&(clearTimeout(ia),h()))}function d(a){return function(){e(a)}}function c(a){return function(){ma.emit("Library::ErrorLoadingCoverImage");
e(a)}}function a(){h()}function g(){V=0;ia=setTimeout(a,K);X=Math.min(C,U.length-M);for(var b=0;b<X;b++){var e=M+b,f=U[e];J[b]||(J[b]=new Image);J[b].onload=d(e);J[b].onerror=c(e);J[b].src=la[f]||KindleLibraryBookCover.getBookCoverUrl(f)}}function b(a,b){function c(){var d=a.find(".book_image, .book_image_wide");!ha&&!KindleLibraryContextMenu.isVisible()&&(ha=!0,d.addClass("opening"),ca(b.asin,function(){d.removeClass("opening");ha=!1}))}var d=a.find("."+H);d.click(c).tap(c);var e=a.find(".book_image, .book_image_wide");
W?(a.tapHold(function(a){R(b,[a.x,a.y-100]);s._unbind("touchmove");s._unbind("touchend");s._unbind("touchcancel")}),d.activate(function(){e.addClass("opening");setTimeout(function(){e.removeClass("opening")},P)})):(d.bind("contextmenu",function(a){L&&clearTimeout(L);R(b,[a.pageX,a.pageY]);a.preventDefault()}),d.mousedown(function(a){e.addClass("held");if(!L)Q.x=a.pageX,Q.y=a.pageY,L=setTimeout(function(){R(b,[Q.x,Q.y]);clearTimeout(L);L=null},I)}),d.mouseup(function(){clearTimeout(L);e.removeClass("held");
L=null;return!0}),d.mouseout(function(){clearTimeout(L);e.removeClass("held");L=null;return!1}),d.mousemove(function(a){Q.x=a.pageX;Q.y=a.pageY}));return a}function j(a,b){var c=S[a];if(c)switch(c.removeClass("book_is_pinned book_is_cached"),b){case Kindle.BookInfo.CachedState.PINNED:c.addClass("book_is_pinned");break;case Kindle.BookInfo.CachedState.CACHED:c.addClass("book_is_cached")}}function k(){(KindleHostDeviceDetector.isFirefox()||KindleHostDeviceDetector.isIE())&&N==="grid"?$(".book_image_container ."+
z).each(function(){var a=this.nextElementSibling;this.parentElement.style.width=$(a).hasClass("book_image_wide")?"auto":a.clientWidth+"px"}):KindleHostDeviceDetector.isiOS()&&$(".book_image_container ."+z).each(function(){var a=this.nextElementSibling;a.style.display="block";setTimeout(function(){a.style.display="inline-block"},0)})}function m(){KindleHostDeviceDetector.isFirefox()&&$(".book_image_container ."+z).each(function(){this.parentElement.style.width="auto"})}function l(){v=r*O;y.grid_style_container.style.height=
v+t+"px";y.grid_style_bookCover.style.width=v+"px";y.grid_style_bookCover.style.height=v+"px";y.grid_style_pinned.style.backgroundPosition="center "+(v+3)+"px";y.grid_style_sample_font.style.fontSize=O*x+"px";y.grid_style_sample_font.style.lineHeight=v*0.13+"px"}function p(a,b){var c=-b*B;Z&&(c=F.scrollTop()+c,c=Math.min(c,Z-F.height()),c=Math.max(c,0),o(c,!0),ga(c))}function q(){W?s?s.refresh():s=KindleLibraryScroller.createScrollerObject("titles_container",{hScroll:!1,lockDirection:!1,hScrollbar:!1,
vScrollbar:!1}):(N==="grid"?(aa=v+t,Y=Math.floor(F.width()/(v+u)),y.grid_style_container.style.width=100/Y+"%"):(aa=G,Y=1),o(Math.floor(da/Y)*aa,!1),Z=F[0].scrollHeight,ka(Z,F.scrollTop(),F.height()));$("#"+A).find(".book_image_container").each(function(){$(this).find(".book_image_wide").length===1&&$(this).addClass("wide");this.style.display="block";this.clientWidth=this.clientWidth;this.style.display="inline-block"});$("#"+A).css("font-size",v+"px");k()}function o(a,b){F.scrollTop(a);b&&(da=Math.round(a/
aa)*Y)}function n(a){KindleHostDeviceDetector.isIE()&&a.addClass("ie_scrollable")}var r=21.25,t=100,u=20,G=86,x=1.3,B=75,D="./images/override/library/blank_cover.png",w="book_highlightsearch",A="titles_inner_wrapper",z="book_sample_badge",H="book_click_area",C=30,I=1E3,P=500,K=6E4,N,O,y,T,W,s,v,Z,aa,Y,da=0,F,ba,ha,ca,R,ka,ga,la,S={},U=[],J=[],M=0,V=0,X=0,ia,L=null,Q={x:0,y:0},E=null,ea=null,fa,ma;return{initialize:function(a,b,c,d,e){var g=$.Deferred(),j=$.Deferred();N=a.layoutState;O=a.coverSize;
W=KindleHostDeviceDetector.isiOS();ha=!1;ca=b;R=c;ka=d;ga=e;F=$("#titles_container");ba=$("#slide_container");ma=KindleModuleManager.getModuleSync([KindleModuleManager.METRICS_MANAGER]);f();ba.mousewheel(p);n(F);W||l();a=KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).getAppDb().getCachedCovers();a.then(function(a){la=a});KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).getAppDb().getAllBooks().done(function(a){fa=a});KindleUXComponentManager.initializeTemplate("KindleLibraryBookContainer",
j.resolve);$.when(a,j).then(g.resolve);return g.promise()},updateCoverSize:function(a,b){!W&&!b&&(O=a,l(),q())},setLayout:function(a){N=a;ba.removeClass("grid_container list_container").addClass(a+"_container");a==="list"&&m();q()},setView:function(a){var b=ba.hasClass("download_view")?"downloaded":"cloud";a==="downloaded"?ba.addClass("download_view"):ba.removeClass("download_view");q();return b},setScrollValue:o,updateBookCacheState:j,updateCachedAsins:function(a){T={};a.forEach(function(a){T[a.asin]=
a.cacheState;j(a.asin,a.cacheState)})},resizeScrollPane:function(){q()},displayBooks:function(a,c){function d(a,b){var c=[],e=[],f={};if(c=b.match(a)){for(var g=c.length,j=0;j<g;j++)f[c[j]]=c[j];for(j in f)e.push(RegExp(f[j],"g"));return e.sort().reverse()}else return e}function e(a,b){for(var c=a,d=b.length,f=0;f<d;f++)c=c.replace(b[f],'<span class="'+w+'">'+b[f].source+"</span>");return c}s&&(s.destroy(),s=null);var f=0,h=KindleHostDeviceDetector.isOnline(),k=$("#"+A),l=!c||c.source==="(?:)"||!c.source;
k.empty();var m=document.createDocumentFragment();a.forEach(function(a){var g,k,n;(h||T[a.asin])&&f++;if(S[a.asin])g=S[a.asin];else{g=KindleUXComponentManager.renderTemplate("KindleLibraryBookContainer",{asin:a.asin,title:a.title,author:KindleAuthor.getDisplayableString(a.authors),src:"./images/override/library/img_alt_cover.png"});if(a.contentType===Kindle.CONTENT_TYPE.EBSP){k=g;n=ResourceBundle.getLocalizedString("k_L_sample_badge_text");var p="<div class='"+z+" "+H+"'>"+n+"</div>";E=E===null?KindleBadging.createCanvasElement():
KindleBadging.cloneCanvasForBadge(E);k.addClass("sample");KindleBadging.drawBadge(E,n,"#333333");KindleBadging.addBadgeToBookContainer(p,E,k)}else{a:{k=a.asin;n=JSON.parse(KindleLocalStorage.getItem("listOfAsinsForBadging"));for(p in n)if(n[p]===k){k=!0;break a}k=!1}k&&(k=g,n=ResourceBundle.getLocalizedString("k_L_trial_badge_text"),p="<div class='book_trial_badge "+H+"'>"+n+"</div>",ea=ea===null?KindleBadging.createCanvasElement():KindleBadging.cloneCanvasForBadge(ea),k.addClass("trial"),KindleBadging.drawBadge(ea,
n,"#333333"),KindleBadging.addBadgeToBookContainer(p,ea,k))}g=b(g,a);S[a.asin]=g;U.push(a.asin);j(a.asin,T[a.asin])}a.contentType===Kindle.CONTENT_TYPE.EBOK&&g.find("."+z).remove();l||(g=g.clone(),k=d(c,a.title),k=e(a.title,k),n=d(c,a.displayableAuthorsString),n=e(a.displayableAuthorsString,n),g.find(".book_title").html(k),g.find(".book_author").html(n));g=b(g,a);m.appendChild(g[0])});k.append(m);g();n(k);q();return f},checkForBadgeUpdates:function(){var a,c=JSON.parse(KindleLocalStorage.getItem("listOfAsinsForBadging")),
d;for(d in c)if(a=$("#"+c[d]),a.find(".canvas_for_badge").length===0){var e=a,f="book_image",g=document.createElement("div");g.className="book_image_container";var j=KindleBadging.createCanvasElement();KindleBadging.drawBadge(j,ResourceBundle.getLocalizedString("k_L_trial_badge_text"),"#333333");e.find("."+H).hasClass("book_image_wide")&&(f="book_image_wide");e.find(".book_cover").append(g);f=e.find("."+f).remove();e.find(".book_image_container").append(f);$(j).removeClass("canvas_for_badge");g.appendChild($("<div>",
{className:"book_badge_container canvas_for_badge"}).appendChild(j));e.find("."+H).hasClass("book_image_wide")&&KindleBadging.adjustBadge(e);e.find(".canvas_for_badge").addClass(H);e=a;g=ResourceBundle.getLocalizedString("k_L_trial_badge_text");g="<div class='book_trial_badge "+H+"'>"+g+"</div>";e.addClass("trial");e.find(".book_details").append(g);S[c[d]]=a;var h,k;for(k in fa)if(a[0].id===fa[k].asin){h=fa[k];break}b(a,h)}}}}(),KindleLibrarySearch=function(){return{doLibrarySearch:function(f,h){var e=
[],d=-1,c=-1,a=-1,g,b=0,j;for(j in h){g=h[j];if(!g.displayableAuthorsString)g.displayableAuthorsString=KindleAuthor.getDisplayableString(g.authors);f.source?(a=g.asin.toLowerCase()===f.source.toLowerCase()?1:-1,d=g.title.search(f),c=g.displayableAuthorsString.search(f)):d=0;d!==-1||c!==-1||a!==-1?(g.hidden=!1,e[b]=g,b++):g.hidden=!0}return{set:e,queryPattern:f}}}}(),KindleLibrarySetting=function(){function f(a){a in o||(o[a]=KindleLocalStorage.getItem(a));return o[a]}function h(a,b){o[a]=b;return KindleLocalStorage.setItem(a,
b)}function e(){return f(m)}function d(a){h(m,a)}function c(){return f(p)}function a(a){h(p,a)}function g(){return f(q)}function b(a){h(q,a)}function j(){return f(l)}function k(a){h(l,a)}var m="last_layout_view",l="last_opened_view",p="last_sort_param",q="last_cover_size",o={};return{initialize:function(){var f=e(),h=c(),l=g(),m=j();f||d("grid");h||a("recent");l||b(9);KindleHostDeviceDetector.isOnline()?m||k("cloud"):k("downloaded")},getLastLayoutView:e,setLayoutView:d,getLastSortParam:c,setSortParam:a,
getLastCoverSize:g,setCoverSize:b,getLastLibraryView:j,setLibraryView:k,getSettings:function(){var a={};a.layoutState=e();a.viewState=j();a.coverSize=g();a.sortParam=c();return a}}}(),KindleLibrarySort=function(){function f(c,a){if(!c.sortTitle){if(c.lastReadTime===void 0)c.lastReadTime=-1;var d=c.titlePronunciation;d&&d!=="null"?d=KindleStringUtilities.replaceAccentedChars(d,"ja"):(d=c.title,d=KindleDeviceCapabilities.useLocaleCompare()?KindleStringUtilities.removeQuotes(d):KindleStringUtilities.replaceAccentedChars(d,
a));d=d.trim();d=d.toLowerCase();a:for(var b=ResourceBundle.getLocalizedArticles(),e,f=0;f<b.length;f++)if(e=b[f],d.indexOf(e)===0){d=d.substring(e.length);break a}c.sortTitle=d;c.sortAuthors=[];for(e=0;e<c.authors.length;e++)d=c.authors[e],(b=c.authorPronunciations&&c.authorPronunciations[d])?b=KindleStringUtilities.replaceAccentedChars(b,"ja"):(b=d,b=KindleDeviceCapabilities.useLocaleCompare()?KindleStringUtilities.removeQuotes(b):KindleStringUtilities.replaceAccentedChars(b,a,!0)),b=b.trim(),b=
b.toLowerCase(),c.sortAuthors[e]=b}}function h(c,a,d){d=typeof d==="undefined"?ResourceBundle.getLanguage():d;return KindleDeviceCapabilities.useLocaleCompare()?c.sortTitle.localeCompare(a.sortTitle,d):c.sortTitle<a.sortTitle?-1:c.sortTitle>a.sortTitle?1:0}function e(c,a){var d=(a.lastTimeRead>0?a.lastTimeRead:a.purchaseDate)-(c.lastTimeRead>0?c.lastTimeRead:c.purchaseDate);return d===0?h(c,a):d}function d(c,a,d){var d=typeof d==="undefined"?ResourceBundle.getLanguage():d,b=0,e,f,m;for(e=0;e<c.authors.length&&
e<a.authors.length&&b===0;e++)f=c.sortAuthors[e],m=a.sortAuthors[e],KindleDeviceCapabilities.useLocaleCompare()?b=f.localeCompare(m,d):f<m?b=-1:f>m&&(b=1);b===0&&(b=c.authors.length-a.authors.length);return b===0?h(c,a):b}return{SORT_BY_AUTHOR:"author",SORT_BY_TITLE:"title",SORT_BY_RECENT:"recent",SORT_BY_AUTHOR_LABEL:"k_L_sort_author_label",SORT_BY_TITLE_LABEL:"k_L_sort_title_label",SORT_BY_RECENT_LABEL:"k_L_sort_recent_label",sortBookList:function(c,a,g){var g=typeof g==="undefined"?ResourceBundle.getLanguage():
g,b;for(b in c)f(c[b],g);switch(a){case "title":c.sort(function(a,b){return h(a,b,g)});break;case "author":c.sort(function(a,b){return d(a,b,g)});break;case "recent":c.sort(e);break;default:KindleDebug.error("Trying to sort by invalid type "+a)}},compareBooks:function(c,a,f){var b;switch(f){case "recent":b=e(c,a);break;case "title":b=h(c,a);break;case "author":b=d(c,a);break;default:KindleDebug.error("Trying to compare by invalid type "+f)}return b},getLabel:function(c){switch(c){case "title":return"k_L_sort_title_label";
case "author":return"k_L_sort_author_label";case "recent":return"k_L_sort_recent_label";default:return"Invalid Sort Type"}}}}(),KindleCrypto=function(){return{decrypt:function(f,h,e){h=CryptoJS.enc.Base64.parse(h);e=CryptoJS.enc.Base64.parse(e);f=new Uint8Array(f);f=CryptoJS.lib.WordArray.create(f);f=CryptoJS.lib.CipherParams.create({ciphertext:f,algorithm:CryptoJS.algo.AES,mode:CryptoJS.mode.CBC,padding:CryptoJS.pad.PKCS5});return function(d){for(var c=d.words,a=d.sigBytes,e=new Uint8Array(a),b=
0;b<a;b++)d=c[b>>>2]>>>24-b%4*8&255,e[b]=d;return e}(CryptoJS.AES.decrypt(f,h,{iv:e}))}}}(),KindleZip=function(){if(zip.workerScriptsPath==="")zip.workerScriptsPath="./js/Worker/";zip.useWebWorkers=KindleHostDeviceDetector.areWebWorkersSupported()&&!KindleHostDeviceDetector.isiOS();if(!ArrayBuffer.prototype.slice)ArrayBuffer.prototype.slice=function(f,h){for(var e=new Uint8Array(this),f=f===void 0?0:f,h=h===void 0?e.length:h,d=new ArrayBuffer(h-f),c=new Uint8Array(d),a=0;a<c.length;a++)c[a]=e[a+f];
return d};return{unzip:function(f){var h=$.Deferred(),e=[],f=new zip.ArrayBufferReader(f);zip.createReader(f,function(d){d.getEntries(function(c){function a(a){return function(b){f++;e.push({filename:c[a].filename,data:b});f===c.length&&d.close(function(){h.resolve(e)})}}for(var f=0,b=0;b<c.length;b++)c[b].getData(new zip.ArrayBufferWriter,a(b))})},function(d){KindleDebug.error("createReader failed when trying to unzip: "+d);h.reject(d)});return h.promise()}}}(),KindleErrorMap=function(){var f,h;
return{getErrorText:function(e){if(!f){var d=KindleModuleManager.getModuleSync(KindleModuleManager.LINK_URLS);f={};f[Kindle.ERROR.OUT_OF_SPACE]={title:"k_L_saveBookOutOfSpace_Title",text:"k_L_saveBookOutOfSpace_Text",textParams:{linkStart:"<a href='"+d.getIncreaseOfflineStorageUrl()+"' target='_blank'>",linkEnd:"</a>"}};f[Kindle.ERROR.TIMEOUT]={title:"k_L_openBookTimeoutError_Title",text:"k_L_openBookTimeoutError_Text"};f[Kindle.ERROR.LOAD_FAILURE]={title:"k_L_openBookLoadFailure_Title",text:"k_L_openBookLoadFailure_Text"};
f[Kindle.ERROR.REMOVE_FAILURE]={title:"k_L_removeBookError_Title",text:"k_L_removeBookError_Text"};f[Kindle.ERROR.REMOVE_NETWORK_FAILURE]={title:"k_L_removeBookNetworkError_Title",text:"k_L_removeBookNetworkError_Text"};f[Kindle.ERROR.CONTENT_LOANED]={title:"k_L_openBookContentLoanedError_Title",text:"k_L_openBookContentLoanedError_Text"};f[Kindle.ERROR.CONTENT_LOAN_ENDED]={title:"k_L_openBookContentLoanEndedError_Title",text:"k_L_openBookContentLoanEndedError_Text"};f[Kindle.ERROR.CONTENT_LICENSE_EXCEEDED]=
{title:"k_L_openBookContentLicenseExceededError_Title",text:"k_L_openBookContentLicenseExceededError_Text"};f[Kindle.ERROR.CONTENT_UNSUPPORTED]={title:"k_L_openBookContentUnsupportedError_Title",text:"k_L_openBookContentUnsupportedError_Text"};f[Kindle.ERROR.CONTENT_UNSUPPORTED_METRO]={title:"k_L_openBookContentUnsupportedErrorMetro_Title",text:"k_L_openBookContentUnsupportedErrorMetro_Text"};f[Kindle.ERROR.CONTENT_RENTAL_EXPIRED]={title:"k_L_openBookContentRentalExpiredError_Title",text:"k_L_openBookContentRentalExpiredError_Text"};
f[Kindle.ERROR.CONTENT_RENTAL_EXPIRED_METRO]={title:"k_L_openBookContentRentalExpiredErrorMetro_Title",text:"k_L_openBookContentRentalExpiredErrorMetro_Text",textParams:{link:"<a href='http://kindle.amazon.com/' target='_blank'>http://kindle.amazon.com/</a>"}};f[Kindle.ERROR.OPEN_BOOK_ASIN_NOT_SPECIFIED]={title:"k_L_openBookAsinNotSpecified_Title",text:"k_L_openBookAsinNotSpecified_Text"};f[Kindle.ERROR.GEOLOCATION_NOT_ALLOWED]={title:"k_L_openBookGeoLocationNotAllowed_Title",text:"k_L_openBookGeoLocationNotAllowed_Text"};
f[Kindle.ERROR.FREE_TRIAL_EXPIRED]={title:"k_endOfFreeTrial_Title",text:"k_endOfFreeTrial_Text"};f[Kindle.ERROR.CONTENT_UPGRADE]={title:"k_L_openBookContentUpgrade_Title",text:"k_L_openBookContentUpgrade_Text"};f[Kindle.ERROR.SESSION_LIMIT_EXCEEDED]={title:"k_L_openBookSessionLimitExceededError_Title",text:"k_L_openBookSessionLimitExceededError_Text"};f[Kindle.ERROR.BOOK_NOT_AVAILABLE]={title:"k_L_bookNotAvailable_Title",text:"k_L_bookNotAvailable_Text"};f[Kindle.ERROR.REVOKE_FAILED]={title:"k_L_revokeFailed_Title",
text:"k_L_revokeFailed_Text"};f[Kindle.ERROR.STORE_NOT_AVAILABLE]={title:"k_L_storeNotAvailable_Title",text:"k_L_storeNotAvailable_Text"};f[Kindle.ERROR.STORE_OPEN_FAILED]={title:"k_store_open_failed_Error_Title",text:"k_store_open_failed_Error_Text"};f[Kindle.ERROR.STORE_OPEN_OFFLINE_FAILED]={title:"k_store_open_failed_offline_Error_Title",text:"k_store_open_failed_offline_Error_Text"};f[Kindle.ERROR.SYNC_FAILED]={title:"k_L_syncFailedError_Title",text:"k_L_syncFailedError_Text"};f[Kindle.ERROR.SYNC_FAILED_OFFLINE]=
{title:"k_L_syncFailedOfflineError_Title",text:"k_L_syncFailedOfflineError_Text"};f[Kindle.ERROR.NOT_IMPLEMENTED]={title:"k_lib_unimplementedFeature_Error_Title",text:"k_lib_unimplementedFeature_Error_Text"};f[Kindle.ERROR.LIBRARY_LOAD_FAILED]={title:"k_L_loadFailedError_Title",text:"k_L_loadFailedError_Text"};f[Kindle.ERROR.NETWORK]={title:"k_L_openBookNetworkError_Title",text:"k_L_openBookNetworkError_Text"};f[Kindle.ERROR.UNKNOWN_ERR]={title:"k_L_unknownError_Title",text:"k_L_unknownError_Text"};
f[Kindle.ERROR.OUTDATED_CHROME]={title:"k_L_outdatedChrome_Title",text:"k_L_outdatedChrome_Text",textParams:{linkStart:"<a href='https://www.google.com/chrome/' target='_blank'>",linkEnd:"</a>"}};f[Kindle.ERROR.SITB_OFFLINE]={title:"k_R_sitb_error_offline_title",text:"k_R_sitb_error_offline_message"};f[Kindle.ERROR.SITB_LANGUAGE_NOT_SUPPORTED]={title:"k_R_sitb_error_language_not_supported_title",text:"k_R_sitb_error_language_not_supported_message"};f[Kindle.ERROR.SITB_INDEX_NOT_AVAILABLE]={title:"k_R_sitb_error_index_not_available_title",
text:"k_R_sitb_error_index_not_available_message"};f[Kindle.ERROR.SITB_COMMON_ERROR]={title:"k_R_sitb_error_common_title",text:"k_R_sitb_error_common_message"};f[Kindle.ERROR.SITB_LANGUAGE_UNDEFINED]={title:"k_R_sitb_error_language_undefined_title",text:"k_R_sitb_error_language_undefined_message"};h={};h[Kindle.ERROR.CONTENT_UNSUPPORTED]=Kindle.ERROR.CONTENT_UNSUPPORTED_METRO;h[Kindle.ERROR.CONTENT_RENTAL_EXPIRED]=Kindle.ERROR.CONTENT_RENTAL_EXPIRED_METRO}KindleHostDeviceDetector.isMetro()&&(e=h[e]||
e);(e=f[e])||(e=f[Kindle.ERROR.UNKNOWN_ERR]);return{title:ResourceBundle.getLocalizedString(e.title,e.titleParams),text:ResourceBundle.getLocalizedString(e.text,e.textParams)}}}}(),KindleIOSScrollStopper={stopScroll:function(f){f.preventDefault()}},KindleListUtilities=function(){return{binarySearch:function(f,h,e){if(!f.length)return 0;for(var d=f.length-1,c=0,a=0,g=null,b=0;c<=d;)if(a=Math.floor((c+d)/2),g=f[a],b=0,e===void 0?g>h?b=1:g<h&&(b=-1):b=e(h,g),b>0)d=a-1;else if(b<0)c=a+1;else return a;
return a===0||b<0?a:a-1},first:function(f){return f[0]},last:function(f){return f[f.length-1]}}}(),KindleOffline=function(){function f(a){var b=new jQuery.Deferred;setTimeout(b.resolve,a);return b.promise()}function h(a,b,d){if(a.indexOf(c)>=0&&KindleHostDeviceDetector.hasCanvasPerformanceProblem()){var e=KindleModuleManager.getModuleSync(KindleModuleManager.METRICS_MANAGER),f=e.startMetrics("Reader::UnoptimizedBookOpen");KindleUnoptimizedFormatDialog.openPinning(function(a){a?(e.increaseSubCounter(f,
"Continue",1),e.endMetrics(f),e=null,b()):(e.increaseSubCounter(f,"Cancel",1),e.endMetrics(f),e=null,d())})}else b()}function e(a,b){if(b){var c=KindleModuleManager.getModuleSync(KindleModuleManager.METRICS_MANAGER),d="BookDownload::Fail::"+b,e=d;switch(a){case Kindle.ERROR.CANCELLED:e+="::Cancelled";break;case Kindle.ERROR.OUT_OF_SPACE:e+="::DBFull";break;case Kindle.ERROR.UNKNOWN_DB_ERROR:e+="::UnknownDBError";break;case Kindle.ERROR.NETWORK:e+="::Network";break;case Kindle.ERROR.TIMEOUT:e+="::Timeout";
break;case Kindle.ERROR.USER_CLOSED_BOOK:e+="::UserClosedBook";break;case Kindle.ERROR.USER_CANCELLED_PIN:e+="::UserCancelledPin";break;default:e+="::Unknown"}c.emit([{name:d,params:{breakdown:["Browser"]}},{name:e,params:{breakdown:["Browser"]}}])}}function d(){return window.localStorage.getItem("haveRun")?!1:!0}var c="topaz",a=null;return{isFirstTime:d,isEnabled:function(){return KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).bookDbEnabled()},firstRunMessage:function(){var a=new jQuery.Deferred;
KindleFirstRunDialog.open({continueCB:function(){KindleHostDeviceDetector.isIE()||KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).enableFullDb().then(a.resolve,a.reject);KindleLocalStorage.setItem(Kindle.App.HAVE_RUN,"true")},onDialogOpenCB:function(){KindleHostDeviceDetector.isIE()&&KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).enableFullDb().then(function(){a.resolve();var b=KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).getBookDb();b&&d()&&
b.BookInfoDB().reserveStorage(10)},a.reject)}});return a.promise()},enableOfflineMessage:function(){var a=new jQuery.Deferred;KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).enableFullDb().then(a.resolve,a.reject);setTimeout(function(){a.isRejected()&&KindleEnableOfflineDialog.open()},500);return a.promise()},pinBook:function(a,b){function c(a){if(a.type===Kindle.ERROR.DB_LINGERING_WRITE)if(a.stalled)KindleFirefoxPromptingDialog.open(),n.getModuleSync(n.METRICS_MANAGER).emit("Pinning::FirefoxPrompting::Open");
else{KindleFirefoxPromptingDialog.close();var b="Pinning::FirefoxPrompting::Close::";b+=a.writeOk?"ok":"no";n.getModuleSync(n.METRICS_MANAGER).emit(b)}}function d(){n.getModuleSync(Kindle.MODULE.DB_CLIENT).removeEventListener(Kindle.ERROR.DB_LINGERING_WRITE,c);n.getModuleSync(n.METRICS_MANAGER).cancelMetrics(t);t=null;r.cancelDownloading(Kindle.ERROR.USER_CANCELLED_PIN);KindleLibraryProgressDialog.close();q.reject()}function m(){n.getModuleSync(Kindle.MODULE.DB_CLIENT).removeEventListener(Kindle.ERROR.DB_LINGERING_WRITE,
c);n.getModuleSync(n.METRICS_MANAGER).endMetrics(t);KindleLibraryProgressDialog.updateValue(100);$.when(o,f(200)).then(function(){KindleLibraryProgressDialog.close();q.resolve(r.getBookType(),r.isContentScrambled())})}function l(a,d){var f=!1;n.getModuleSync(Kindle.MODULE.DB_CLIENT).removeEventListener(Kindle.ERROR.DB_LINGERING_WRITE,c);t&&n.getModuleSync(n.METRICS_MANAGER).endMetrics(t);KindleLibraryProgressDialog.close();a&&(a.getContext&&a.getContext().downloadRestrictionReason&&(f=!0),a.getOpenError&&
(a=a.getOpenError()));a!==Kindle.ERROR.USER_CANCELLED_PIN&&a!==Kindle.ERROR.CANCELLED&&a!==Kindle.ERROR.USER_CLOSED_BOOK&&b(a,d);f||e(a,"Library");q.reject(a)}function p(){function a(b,c){var d=Math.round(100*Math.min(b,c)/Math.max(1,c)),d=Math.max(1,d);KindleLibraryProgressDialog.updateValue(d)}r.getSizeInfo().then(function(b){b.bookSize*1.53>b.quota?(u.reject(),l(Kindle.ERROR.OUT_OF_SPACE)):r.getBookInfoDfd().then(function(){var b=r.getBookType();h(b,function(){n.getModuleSync(Kindle.MODULE.DB_CLIENT).addEventListener(Kindle.ERROR.DB_LINGERING_WRITE,
c);u.resolve(!0);r.getDownloadComplete(a).then(m,l)},function(){u.reject();d()})})})}var q,o,n,r,t,u;Date.now();q=new jQuery.Deferred;if(!KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).bookDbEnabled())return q.reject(),q.promise();n=KindleModuleManagerFactory();window.parent.KindleApp.getSharedModules().done(function(b){n.registerModuleList(b);t=n.getModuleSync(n.METRICS_MANAGER).startMetrics("Pin");r=KindleReaderBookInfoProvider.BookInfo(a,n);o=f(1500);u=new jQuery.Deferred;KindleLibraryProgressDialog.open(d);
r.startDownloading(t,u).then(p,l)});return q.promise()},downloadBook:function(c,b,d,h){function m(){n.getModuleSync(n.METRICS_MANAGER).endMetrics(r);$.when(o,f(200)).then(function(){q.resolve();d()})}function l(a){var b=!1;n.getModuleSync(n.METRICS_MANAGER).cancelMetrics(r);a&&(a.getContext&&a.getContext().downloadRestrictionReason&&(b=!0),a.getOpenError&&(a=a.getOpenError()));if(a!==Kindle.ERROR.CANCELLED){if(a===Kindle.ERROR.CONTENT_UNSUPPORTED&&KindleHostDeviceDetector.isMetro())a=Kindle.ERROR.CONTENT_UNSUPPORTED_METRO;
var c=KindleErrorMap.getErrorText(a);c.code=a;h(c)}b||e(a,"Library");q.reject(a)}function p(){function c(a,d){b(Math.round(100*Math.min(a,d)/Math.max(1,d)))}a.getSizeInfo().then(function(b){b.quota>0&&b.bookSize*1.53>b.quota?l(Kindle.ERROR.OUT_OF_SPACE):(t.resolve(!0),a.getDownloadComplete(c).then(m,l))})}var q,o,n,r,t;q=new jQuery.Deferred;if(!KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).bookDbEnabled())return q.reject(),q.promise();n=KindleModuleManagerFactory();window.parent.KindleApp.getSharedModules().done(function(b){n.registerModuleList(b);
r=n.getModuleSync(n.METRICS_MANAGER).startMetrics("Pin");a=KindleReaderBookInfoProvider.BookInfo(c,n);o=f(1500);t=new jQuery.Deferred;a.startDownloading(r,t).then(p,l)});return q.promise()},removeBook:function(a,b,c){function d(a){q.endMetrics(o);c(a)}function e(){q.endMetrics(o);b()}function f(b){b.cacheState!==Kindle.BookInfo.CachedState.PINNED||b.context.isSample?b=!0:KindleHostDeviceDetector.isOnline()?(b={asin:a.asin,kindleSessionId:b.context.kindleSessionId,isOffline:!1},b=KindleModuleManager.getModuleSync(KindleModuleManager.SERVICE_CLIENT).setOfflineStatus(b)):
b=(new $.Deferred).reject(Kindle.ERROR.NETWORK).promise();return b}var h,q,o;q=KindleModuleManager.getModuleSync(KindleModuleManager.METRICS_MANAGER);o=q.startMetrics("Unpin");h=KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).getBookDb();h.getRecord("bookinfo",{asin:a.asin},{cacheState:!0,context:!0}).then(function(b){b&&b.length>0?$.when(f(b[0])).fail(d).done(function(){h.deleteBooksData([a.asin]).then(e,d)}):e()},d)},cancelBookDownload:function(){a.cancelDownloading()},sendDownloadFailMetric:e}}(),
KindleKatakana=function(){function f(c){var a=c.substring(0,1);return e[a]?a+e[a].v:c}var h={"\u3042":"\u30a2","\u3044":"\u30a4","\u3046":"\u30a6","\u3048":"\u30a8","\u304a":"\u30aa","\u304b":"\u30ab","\u304d":"\u30ad","\u304f":"\u30af","\u3051":"\u30b1","\u3053":"\u30b3","\u3055":"\u30b5","\u3057":"\u30b7","\u3059":"\u30b9","\u305b":"\u30bb","\u305d":"\u30bd","\u305f":"\u30bf","\u3061":"\u30c1","\u3064":"\u30c4","\u3066":"\u30c6","\u3068":"\u30c8","\u306a":"\u30ca","\u306b":"\u30cb","\u306c":"\u30cc",
"\u306d":"\u30cd","\u306e":"\u30ce","\u306f":"\u30cf","\u3072":"\u30d2","\u3075":"\u30d5","\u3078":"\u30d8","\u307b":"\u30db","\u307e":"\u30de","\u307f":"\u30df","\u3080":"\u30e0","\u3081":"\u30e1","\u3082":"\u30e2","\u3084":"\u30e4","\u3086":"\u30e6","\u3088":"\u30e8","\u3089":"\u30e9","\u308a":"\u30ea","\u308b":"\u30eb","\u308c":"\u30ec","\u308d":"\u30ed","\u308f":"\u30ef","\u3092":"\u30f2","\u3093":"\u30f3","\u304c":"\u30ac","\u304e":"\u30ae","\u3050":"\u30b0","\u3052":"\u30b2","\u3054":"\u30b4",
"\u3056":"\u30b6","\u3058":"\u30b8","\u305a":"\u30ba","\u305c":"\u30bc","\u305e":"\u30be","\u3060":"\u30c0","\u3062":"\u30c2","\u3065":"\u30c5","\u3067":"\u30c7","\u3069":"\u30c9","\u3070":"\u30d0","\u3073":"\u30d3","\u3076":"\u30d6","\u3079":"\u30d9","\u307c":"\u30dc","\u3071":"\u30d1","\u3074":"\u30d4","\u3077":"\u30d7","\u307a":"\u30da","\u307d":"\u30dd","\u3094":"\u30f4","\u3041":"\u30a1","\u3043":"\u30a3","\u3045":"\u30a5","\u3047":"\u30a7","\u3049":"\u30a9","\u3063":"\u30c3","\u3083":"\u30e3",
"\u3085":"\u30e5","\u3087":"\u30e7","\u308e":"\u30ee"},e={"\u30a2":{v:"\u30a2"},"\u30a4":{v:"\u30a4"},"\u30a6":{v:"\u30a6"},"\u30a8":{v:"\u30a8"},"\u30aa":{v:"\u30aa"},"\u30ab":{v:"\u30a2"},"\u30ad":{v:"\u30a4"},"\u30af":{v:"\u30a6"},"\u30b1":{v:"\u30a8"},"\u30b3":{v:"\u30aa"},"\u30b5":{v:"\u30a2"},"\u30b7":{v:"\u30a4"},"\u30b9":{v:"\u30a6"},"\u30bb":{v:"\u30a8"},"\u30bd":{v:"\u30aa"},"\u30bf":{v:"\u30a2"},"\u30c1":{v:"\u30a4"},"\u30c4":{v:"\u30a6"},"\u30c6":{v:"\u30a8"},"\u30c8":{v:"\u30aa"},"\u30ca":{v:"\u30a2"},
"\u30cb":{v:"\u30a4"},"\u30cc":{v:"\u30a6"},"\u30cd":{v:"\u30a8"},"\u30ce":{v:"\u30aa"},"\u30cf":{v:"\u30a2"},"\u30d2":{v:"\u30a4"},"\u30d5":{v:"\u30a6"},"\u30d8":{v:"\u30a8"},"\u30db":{v:"\u30aa"},"\u30de":{v:"\u30a2"},"\u30df":{v:"\u30a4"},"\u30e0":{v:"\u30a6"},"\u30e1":{v:"\u30a8"},"\u30e2":{v:"\u30aa"},"\u30e4":{v:"\u30a2"},"\u30e6":{v:"\u30a6"},"\u30e8":{v:"\u30aa"},"\u30e9":{v:"\u30a2"},"\u30ea":{v:"\u30a4"},"\u30eb":{v:"\u30a6"},"\u30ec":{v:"\u30a8"},"\u30ed":{v:"\u30aa"},"\u30ef":{v:"\u30a2"},
"\u30f0":{v:"\u30a4"},"\u30f1":{v:"\u30a8"},"\u30f2":{v:"\u30aa"},"\u30f3":{v:"\u30a2"},"\u30ac":{v:"\u30a2",nq:"\u30ab"},"\u30ae":{v:"\u30a4",nq:"\u30ad"},"\u30b0":{v:"\u30a6",nq:"\u30af"},"\u30b2":{v:"\u30a8",nq:"\u30b1"},"\u30b4":{v:"\u30aa",nq:"\u30b3"},"\u30b6":{v:"\u30a2",nq:"\u30b5"},"\u30b8":{v:"\u30a4",nq:"\u30b7"},"\u30ba":{v:"\u30a6",nq:"\u30b9"},"\u30bc":{v:"\u30a8",nq:"\u30bb"},"\u30be":{v:"\u30aa",nq:"\u30bd"},"\u30c0":{v:"\u30a2",nq:"\u30bf"},"\u30c2":{v:"\u30a4",nq:"\u30c1"},"\u30c5":{v:"\u30a6",
nq:"\u30c4"},"\u30c7":{v:"\u30a8",nq:"\u30c6"},"\u30c9":{v:"\u30aa",nq:"\u30c8"},"\u30d0":{v:"\u30a2",nq:"\u30cf"},"\u30d3":{v:"\u30a4",nq:"\u30d2"},"\u30d6":{v:"\u30a6",nq:"\u30d5"},"\u30d9":{v:"\u30a8",nq:"\u30d8"},"\u30dc":{v:"\u30aa",nq:"\u30db"},"\u30d1":{v:"\u30a2",nq:"\u30cf"},"\u30d4":{v:"\u30a4",nq:"\u30d2"},"\u30d7":{v:"\u30a6",nq:"\u30d5"},"\u30da":{v:"\u30a8",nq:"\u30d8"},"\u30dd":{v:"\u30aa",nq:"\u30db"},"\u30f4":{v:"\u30af",nq:"\u30a6"},"\u30f7":{v:"\u30a2",nq:"\u30ef"},"\u30f8":{v:"\u30a4",
nq:"\u30f0"},"\u30f9":{v:"\u30a8",nq:"\u30f1"},"\u30fa":{v:"\u30aa",nq:"\u30f2"},"\u30a1":{v:"\u30a2"},"\u30a3":{v:"\u30a4"},"\u30a5":{v:"\u30a6"},"\u30a7":{v:"\u30a8"},"\u30a9":{v:"\u30aa"},"\u30c3":{v:"\u30a6"},"\u30e3":{v:"\u30a2"},"\u30e5":{v:"\u30a6"},"\u30e7":{v:"\u30aa"},"\u30ee":{v:"\u30a2"}},d=/.\u30fc/g;return{normalizeKatakana:function(c){c=c.replace(/[\u3040-\u30ff]/g,function(a){a=h[a]||a;return a=e[a]&&e[a].nq||a});return c=c.replace(d,f)},hasHiraganaKatakana:function(c){return c.search(/[\u3040-\u30ff]/)>=
0}}}(),KindleImageUtil=function(){return{getDataUriFromImage:function(f,h){var e=$.Deferred(),d=new Image;d.crossOrigin="Anonymous";d.onload=function(){var c;c=document.createElement("CANVAS");c.height=this.height;c.width=this.width;ctx=c.getContext("2d");ctx.drawImage(this,0,0);c=c.toDataURL(h);e.resolve(c)};d.onerror=e.reject;d.src=f;return e.promise()}}}(),KindleStringUtilities=function(){var f={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"},h=RegExp("["+Object.keys(f).join("")+
"]","g"),e={"\u2019":"'","\uff07":"'","'":"'","\u00e0":"a","\u00e1":"a","\u00e2":"a","\u00e3":"a","\u00e4":"a","\u00e5":"a","\u00c0":"a","\u00c1":"a","\u00c2":"a","\u00c3":"a","\u00c4":"a","\u00c5":"a","\u0100":"a","\u0101":"a","\u0102":"a","\u0103":"a","\u0104":"a","\u0105":"a","\u00e8":"e","\u00e9":"e","\u00ea":"e","\u00eb":"e","\u00c8":"e","\u00c9":"e","\u00ca":"e","\u00cb":"e","\u0112":"e","\u0113":"e","\u0114":"e","\u0115":"e","\u0116":"e","\u0117":"e","\u0118":"e","\u0119":"e","\u011a":"e",
"\u011b":"e","\u00ec":"i","\u00ed":"i","\u00ee":"i","\u00ef":"i","\u00cc":"i","\u00cd":"i","\u00ce":"i","\u00cf":"i","\u0128":"i","\u0129":"i","\u012a":"i","\u012b":"i","\u012c":"i","\u012d":"i","\u012e":"i","\u012f":"i","\u0130":"i","\u00f2":"o","\u00f3":"o","\u00f4":"o","\u00f5":"o","\u00f6":"o","\u00d2":"o","\u00d3":"o","\u00d4":"o","\u00d5":"o","\u00d6":"o","\u014c":"o","\u014d":"o","\u014e":"o","\u014f":"o","\u0150":"o","\u0151":"o","\u00f9":"u","\u00fa":"u","\u00fb":"u","\u00fc":"u","\u00d9":"u",
"\u00da":"u","\u00db":"u","\u00dc":"u","\u0168":"u","\u0169":"u","\u016a":"u","\u016b":"u","\u016c":"u","\u016d":"u","\u016e":"u","\u016f":"u","\u0170":"u","\u0171":"u","\u0172":"u","\u0173":"u","\u00fd":"y","\u00ff":"y","\u00dd":"y","\u0176":"y","\u0177":"y","\u0178":"y","\u00e7":"c","\u00c7":"c","\u0106":"c","\u0107":"c","\u0108":"c","\u0109":"c","\u010a":"c","\u010b":"c","\u010c":"c","\u010d":"c","\u00d0":"d","\u010e":"d","\u010f":"d","\u00f0":"d","\u011c":"g","\u011d":"g","\u011e":"g","\u011f":"g",
"\u0120":"g","\u0121":"g","\u0122":"g","\u0123":"g","\u0124":"h","\u0125":"h","\u0134":"j","\u0135":"j","\u0136":"k","\u0137":"k","\u0139":"l","\u013a":"l","\u013b":"l","\u013c":"l","\u013d":"l","\u013e":"l","\u00f1":"n","\u00d1":"n","\u0143":"n","\u0144":"n","\u0145":"n","\u0146":"n","\u0147":"n","\u0148":"n","\u0154":"r","\u0155":"r","\u0156":"r","\u0157":"r","\u0158":"r","\u0159":"r","\u015a":"s","\u015b":"s","\u015c":"s","\u015d":"s","\u015e":"s","\u015f":"s","\u0160":"s","\u0161":"s","\u0162":"t",
"\u0163":"t","\u0164":"t","\u0165":"t","\u0174":"w","\u0175":"w","\u0179":"z","\u017a":"z","\u017b":"z","\u017c":"z","\u017d":"z","\u017e":"z","\u00df":"s","\u00e6":"a","\u00c6":"a","\u00de":"t","\u00fe":"t","\u00d8":"o","\u00f8":"o"},d={'"':"","'":"","\u00b4":"","\u2018":"","\u2019":"","\u201c":"","\u201d":""},c={fr:{},de:{"\u00df":"ss"},it:{},es:{"\u00d1":"OAAAAA","\u00f1":"oaaaaa"},en:e};return{replaceAccentedChars:function(a,d){var b,f=c[d]||[];b=a.replace(/[^A-Za-z0-9 ]/g,function(a){return f[a]||
e[a]||a});KindleKatakana.hasHiraganaKatakana(b)&&(b=KindleKatakana.normalizeKatakana(b));return b},removeQuotes:function(a){return a=a.replace(/[^A-Za-z0-9 ]/g,function(a){var b=d[a];return b===""?b:a})},escapeForHTML:function(a){return a.replace(h,function(a){return f[a]})},substitute:function(a,c){return a.replace(/\{\{([A-Za-z0-9\_]+)\}\}/g,function(a,d){return d in c?c[d]:a})}}}(),KindleTouchEventsToggler=function(){function f(b){if(g)for(var c=$(":hasTouchEvent"),d=0;d<c.length;d++){var e=c[d];
if((!b||!b(e))&&e._listeners)for(var f=e._listeners.slice(0),h=0;h<f.length;h++){var q=f[h][0];if(q==="touchstart"||q==="touchmove"||q==="touchend")q={element:e,type:q,func:f[h][1],useCapture:f[h][2]},a.push(q),e.removeEventListener(q.type,q.func,q.useCapture)}}}function h(){if(g){for(var b=0;b<a.length;b++){var c=a[b];c.element.addEventListener(c.type,c.func,c.useCapture)}a=[]}}var e=null,d=null,c=!1,a=[],g=!1;return{initialize:function(){if(!c)e=HTMLElement.prototype.addEventListener,HTMLElement.prototype.addEventListener=
function(){if(!this._listeners)this._listeners=[];this._listeners.push(arguments);e.apply(this,arguments)},d=HTMLElement.prototype.removeEventListener,HTMLElement.prototype.removeEventListener=function(){function a(b,c){try{return typeof b==="function"&&typeof c==="function"?b===c:b.handleEvent===c.handleEvent}catch(d){}return!1}if(this._listeners)for(var c=0;c<this._listeners.length;++c)if(this._listeners[c][0]===arguments[0]&&a(this._listeners[c][1],arguments[1])){this._listeners.splice(c,1);break}d.apply(this,
arguments)},g=c=!0,$.expr[":"].hasTouchEvent=function(a){if(a._listeners)for(var c=0;c<a._listeners.length;c++){var d=a._listeners[c][0];if(d==="touchstart"||d==="touchmove"||d==="touchend")return!0}return!1},$.expr[":"].hasListeners=function(a){return a._listeners!==void 0}},deInitialize:function(){if(c){var b=0;$(":hasListeners").each(function(a,c){for(var d=c._listeners.slice(0),e=0;e<d.length;e++)c.removeEventListener(d[e][0],d[e][1]),b++});HTMLElement.prototype.addEventListener=e;HTMLElement.prototype.removeEventListener=
d;a=[];c=!1}},on:h,off:f,disallowTouchEvents:function(){g=!0;f();g=!1},allowTouchEvents:function(){g=!0;h()},isRequired:function(){return KindleHostDeviceDetector.isiOS()&&!KindleHostDeviceDetector.isiOS_7x()&&!KindleHostDeviceDetector.isiOS_8x()}}}();
(function(f){var h=["tap","tapHold","swipeLeft","swipeRight","activate","pinch","zoom","doubletap"];f.each(h,function(e,d){f.fn[d]=function(c,a){a=a||{};return d==="tap"?KindleHostDeviceDetector.isTouchDevice()?c?gt(this).on(d,c,f.extend(a,{expire:700,moveThreshold:10})):this.trigger(d):c?this.click(c):this.trigger("click"):c?gt(this).on(d,c,a):this.trigger(d)};f.attrFn[d]=!0});f.each(h,function(e,d){var c="unbind"+d.slice(0,1).toUpperCase()+d.slice(1);f.fn[c]=function(a){return d==="tap"&&!KindleHostDeviceDetector.isTouchDevice()?
a?this.unbind("click",a):this.unbind("click"):gt(this).off(d,a)};f.attrFn[c]=!0})})(jQuery);
var KindleUXComponentManager=function(){function f(a){if(a.callbacks.onDialogOpen)a.callbacks.onDialogOpen(a.component);a.callbacks.onOverlayClicked&&$(".ui-widget-overlay").tap(a.callbacks.onOverlayClicked).bind("contextmenu",function(b){a.callbacks.onOverlayClicked();b.preventDefault()})}function h(a,b,c){g(a,function(){var d;d=$(Handlebars.templates[a](c));k[a]={component:d};b(d)})}function e(a){a.stopPropagation()}function d(a,b,d,g){var h=k[a];h.callbacks=d;if(d.onInitializationDone)d.onInitializationDone(b);
if(d.getDialogSettings)h.dialogSettings=d.getDialogSettings();if(h.dialogSettings.width===void 0){if(KindleHostDeviceDetector.isiPad())a=l;else if(KindleHostDeviceDetector.isMetro()){if(a=q,h.dialogSettings.dialogClass="wide-dialog",!g)h.dialogSettings.k4w_transparent_modal_overlay=!1}else a=p;h.dialogSettings.width=a}h.dialogSettings.modal&&b.keydown(e).keyup(e);if(KindleHostDeviceDetector.isiOS_5xOrGreater()){a=h.dialogSettings;if(a.modal)a.modal=!1,a.k4w_modal=!0;b=b.dialog(a)}else b=b.dialog(h.dialogSettings);
h.component=b;if(!g&&!KindleHostDeviceDetector.isiOS_5xOrGreater()){var j=b.dialog("option","position");$(window).resize(function(){b.dialog("option","position",j)})}b.bind("dialogopen",function(){f(h)});b.bind("dialogclose",function(){if(h.callbacks.onDialogClose)h.callbacks.onDialogClose(h.component);h.dialogSettings.k4w_modal&&KindleDialogOverlay.removeOverlay()});b.bind("dialogbeforeclose",function(){$(".ui-widget-overlay").unbindTap();h.dialogSettings.modal&&o&&o(!0);h.callbacks.beforeDialogClose&&
h.callbacks.beforeDialogClose(h.component)});c(h)}function c(a){a.component.dialog("isOpen")||(a.dialogSettings.k4w_transparent_modal_overlay?$("body").addClass(m):$("body").removeClass(m),a.callbacks.beforeDialogOpen&&a.callbacks.beforeDialogOpen(a.component),a.dialogSettings.modal&&o&&o(!1),a.dialogSettings.k4w_modal&&KindleDialogOverlay.showOverlay(a),a.component.dialog("open"))}function a(a){k[a]&&k[a].component.dialog("isOpen")&&k[a].component.dialog("close")}function g(a,c){b(a).then(function(){j[a]||
c()},function(){KindleDebug.error("Template "+a+" is missing")})}function b(a){var b=$.Deferred();(a=Handlebars.templates[a])?b.resolve(a):b.reject();return b.promise()}function j(a){return!!Handlebars.templates[a]}var k=[],m="transparent_overlay",l=475,p=400,q="100%",o;return{initializeTemplate:g,hasTemplate:j,renderTemplate:function(a,b){if(!Handlebars.templates[a])throw{name:"initializationError",message:"Please call KindleUXComponentManager.initializeTemplate function first"};return $(Handlebars.templates[a](b))},
initializeComponent:h,openDialog:function(a,b,e){var f=k[a];f?c(f):f!==null&&(k[a]=null,h(a,function(c){d(a,c,b)},e))},closeDialog:a,isVisible:function(a){return k[a]&&k[a].component.dialog("isOpen")?!0:!1},showMenu:function(a,b){var e;b||(e=k[a.componentName]);e?(a.buttonID||KindlePopupMenu.updatePosition(a.componentName,a.position),a.enabledFlags&&KindlePopupMenu.updateMenu(e.component,a.enabledFlags,a.componentName),c(e)):(a.doneCallback=function(b,c){a.enabledFlags&&KindlePopupMenu.updateMenu(b,
a.enabledFlags,a.componentName);k[a.componentName]={component:b};d(a.componentName,b,c,!0)},KindlePopupMenu.initialize(a))},updateMenu:function(a,b){var c=k[a];c&&KindlePopupMenu.updateMenu(c.component,b,a)},hideMenu:a,registerKeyEventsEnabledCallback:function(a){o=a}}}(),KindleWindowSizeWatcher=function(){function f(){p||(p=!0,r.emit(j+"::"+k+"::"+n))}function h(){o||(o=!0,r.emit(j+"::"+m+"::"+n))}function e(){var d=$(window).width();0<d&&d<a?!p&&!o&&KindleSmallWindowDialog.open({onDialogIgnoreCB:h,
onDialogOpenCB:f}):p&&(KindleSmallWindowDialog.close(),p=!1);q&&c(b)}function d(){l!==null&&(clearTimeout(l),l=null)}function c(){var a=g;d();l=setTimeout(e,a)}var a=720,g=200,b=500,j="SmallWindowDialog",k="Shown",m="Ignored",l=null,p=!1,q=!1,o=!1,n,r;return{setMetricsContext:function(a){r||(r=KindleModuleManager.getModuleSync(KindleModuleManager.METRICS_MANAGER));n=a},onWindowResized:c,startPolling:function(){q=!0;var a=b;d();l=setTimeout(e,a)},stopPolling:function(){q=!1}}}(),KindleDialogOverlay=
function(){return{showOverlay:function(f){$("body").append("<div class='ui-widget-overlay ui-widget-overlay-kcr-ios-hack'></div>");$(".ui-widget-overlay-kcr-ios-hack").attr("style","z-index: 1000;");(function(){var h=f.component.dialog("option","position");$("body",Kindle.top.document).bind("orientationchange.dialog",function(){f.dialogSettings.k4w_transparent_modal_overlay&&$(".ui-widget-overlay-kcr-ios-hack").css({width:0,height:0});f.component.dialog("option","position",h)})})();(function(){f.callbacks.onOverlayClicked&&
$(".ui-widget-overlay-kcr-ios-hack").tap(function(f){f.preventDefault()})})()},removeOverlay:function(){$(".ui-widget-overlay-kcr-ios-hack").remove();$("body",Kindle.top.document).unbind("orientationchange.dialog")}}}(),KindleEnableOfflineDialog=function(){function f(){KindleUXComponentManager.closeDialog(h)}var h="KindleEnableOfflineDialog",e={BUTTON_TEXT:"k_dialog_enableOffline_button_text",OFFLINE_TITLE:"k_dialog_enable_offline_title",FIREFOX_MSG:"k_dialog_enable_offline_firefox_msg"},d={DIALOG:"kindle_dialog_enableOffline",
CONTENT:"kindle_dialog_enableOffline_content",BUTTON:"kindle_dialog_enableOffline_button"},c={TITLE:"enable_offline_title",TOP_MSG:"enable_offline_top_msg"},a,g={getDialogSettings:function(){return{autoOpen:!1,width:626,modal:!0,draggable:!1,resizable:!1,dialogClass:"enableOfflineDialog"}},beforeDialogOpen:function(b){a=b;var g,h;KindleHostDeviceDetector.isFirefox()&&(g=ResourceBundle.getLocalizedString(e.OFFLINE_TITLE),h=ResourceBundle.getLocalizedString(e.FIREFOX_MSG,{linkStart:"<a href='"+LinkUrls.getOfflineReadingUrl()+
"' target='_blank'>",linkEnd:"</a>"}));b={title:g,topInstruction:h,topInstructionClass:void 0};a.find("#"+c.TITLE).html(b.title);a.find("#"+c.TOP_MSG).html(b.topInstruction);b.topInstructionClass&&a.find("#"+c.TOP_MSG).addClass(b.topInstructionClass);b=a.find("#"+d.BUTTON);b.html(ResourceBundle.getLocalizedString(e.BUTTON_TEXT));b.one("click",f)},onDialogOpen:function(){var a=$("#"+d.DIALOG);a.parents(".ui-dialog:first").removeClass("ui-widget ui-widget-content ui-corner-all");a.removeClass("ui-dialog-content ui-widget-content")}};
return{open:function(){KindleUXComponentManager.openDialog(h,g)},close:function(){KindleUXComponentManager.closeDialog(h)}}}(),KindleFirefoxPromptingDialog=function(){function f(){KindleHostDeviceDetector.hasHangingDbPrompt()&&KindleUXComponentManager.closeDialog(h)}var h="KindleFirefoxPromptingDialog",e={CLOSE_BUTTON:"k_common_close_button",MESSAGE:"k_dialog_ffPrompting_Text"},d={DIALOG:"kindle_dialog_ffPrompting",IMAGE:"ffPrompting_img",MESSAGE:"kindle_dialog_ffPrompting_text"},c,a={getDialogSettings:function(){return{autoOpen:!1,
modal:!0,draggable:!1,resizable:!1,k4w_transparent_modal_overlay:!1}},beforeDialogOpen:function(a){var b={linkStart:"<a href='"+LinkUrls.getIncreaseOfflineStorageUrl()+"' target='_blank'>",linkEnd:"</a>"};c=a;c.find("#kindle_dialog_ffPrompting_url").text(parent.window.location);c.find("#kindle_dialog_ffPrompting_tab_title").text(parent.document.title);a={};b=ResourceBundle.getLocalizedString(e.MESSAGE,b);c.find("#"+d.MESSAGE).html(b);a[ResourceBundle.getLocalizedString(e.CLOSE_BUTTON)]=f;c.dialog("option",
"buttons",a)}};return{open:function(){KindleHostDeviceDetector.hasHangingDbPrompt()&&KindleUXComponentManager.openDialog(h,a)},close:f}}(),KindleFirstRunDialog=function(){function f(){KindleUXComponentManager.closeDialog(d);j&&j()}function h(){var a,b;if(KindleHostDeviceDetector.isChromeApp())return null;else if(KindleHostDeviceDetector.isChrome())a=ResourceBundle.getLocalizedString(c.OFFLINE_TITLE),b=ResourceBundle.getLocalizedString(c.CHROME_MSG);else if(KindleHostDeviceDetector.isiOS())a=ResourceBundle.getLocalizedString(c.OFFLINE_TITLE),
b=ResourceBundle.getLocalizedString(c.IOS_PROMPT_MSG);else if(KindleHostDeviceDetector.isFirefox())return null;else KindleHostDeviceDetector.isIE()?(a=ResourceBundle.getLocalizedString(c.OFFLINE_TITLE),b=ResourceBundle.getLocalizedString(c.IE_PROMPT_MSG)):(a=ResourceBundle.getLocalizedString(c.OFFLINE_TITLE),b=ResourceBundle.getLocalizedString(c.SAFARI_PROMPT_MSG));return{title:a,topInstruction:b}}function e(){KindleUXComponentManager.closeDialog(d)}var d="KindleFirstRunDialog",c={BUTTON_TEXT:"k_dialog_firstRun_button_text",
BUTTON_TEXT_CHROME:"k_dialog_firstRun_button_text_chrome",CRX_BUTTON_TEXT:"k_dialog_firstRun_button_crx_text",INSTALLING_BUTTON_TEXT:"k_dialog_firstRun_button_installing_text",INSTALLED_BUTTON_TEXT:"k_dialog_firstRun_button_installed_text",CONTINUE_BUTTON_TEXT:"k_dialog_firstRun_button_text_chrome_done",OFFLINE_TITLE:"k_dialog_firstRun_offline_title",CHROME_APP_TITLE:"k_dialog_firstRun_chrome_app_title",CHROME_APP_MSG:"k_dialog_firstRun_chrome_app_msg",CHROME_MSG:"k_dialog_firstRun_chrome_msg",FIREFOX_MSG:"k_dialog_firstRun_firefox_msg",
IOS_PROMPT_MSG:"k_dialog_firstRun_ios_prompt_msg",SAFARI_PROMPT_MSG:"k_dialog_firstRun_safari_prompt_msg",IE_PROMPT_MSG:"k_dialog_firstRun_ie_prompt_msg"},a={DIALOG:"kindle_dialog_firstRun",CONTENT:"kindle_dialog_firstRun_content",BUTTON:"kindle_dialog_firstRun_button",CRX_BUTTON:"kindle_dialog_firstRun_button_crx"},g={TITLE:"first_run_title",TOP_MSG:"first_run_top_msg",TOP_IMG:"first_run_top_img",BOTTOM_IMG:"first_run_bottom_img"},b,j,k,m,l={getDialogSettings:function(){return{autoOpen:!1,width:626,
modal:!0,draggable:!1,resizable:!1,dialogClass:"firstRunDialog"}},beforeDialogOpen:function(b){function d(){KindleChromeInstaller.install();e()}k=b;k.find("#"+g.TITLE).html(m.title);k.find("#"+g.TOP_MSG).html(m.topInstruction);b=k.find("#"+a.BUTTON);b.html(ResourceBundle.getLocalizedString(c.BUTTON_TEXT));b.one("click",f);KindleHostDeviceDetector.isChrome()&&!KindleHostDeviceDetector.isChromeApp()&&(b.removeClass("primary_btn").addClass("chrome_btn").html(ResourceBundle.getLocalizedString(c.BUTTON_TEXT_CHROME)),
b=k.find("#"+a.CRX_BUTTON),b.removeClass("disabled").html(ResourceBundle.getLocalizedString(c.CRX_BUTTON_TEXT)),b.unbind("click"),b.one("click",d),b.show())},onDialogOpen:function(){var c=$("#"+a.DIALOG);c.parents(".ui-dialog:first").removeClass("ui-widget ui-widget-content ui-corner-all");c.removeClass("ui-dialog-content ui-widget-content");b&&b()}};return{open:function(a){(m=h())?(j=a&&a.continueCB,b=a&&a.onDialogOpenCB,KindleUXComponentManager.openDialog(d,l)):a&&a.continueCB&&a.continueCB()},
close:e}}(),KindleMessageDialog=function(){function f(a){if((a.keyCode||a.which)===27)return j(),a.stopImmediatePropagation(),!1}var h={TITLE_ID:"kindle_dialog_message_title_text",TEXT_ID:"kindle_dialog_message_text"},e={dismiss:"k_dialog_message_dismissButton_text"},d,c,a,g,b,j=function(){KindleUXComponentManager.closeDialog("KindleMessageDialog")},k={getDialogSettings:function(){return{autoOpen:!1,modal:!0,draggable:!1,resizable:!1,k4w_transparent_modal_overlay:!0}},beforeDialogOpen:function(d){function k(a){return function(){j();
"function"===typeof a.callback&&a.callback()}}var m={};if(b)for(var o=0;o<b.length;o++){var n=b[o];m[n.buttonText]=k(n)}else g=g?g:ResourceBundle.getLocalizedString(e.dismiss),m[g]=j;d.dialog("option","buttons",m);d.find("#"+h.TITLE_ID).empty().append(a);d.find("#"+h.TEXT_ID).empty().append(c);if(KindleHostDeviceDetector.isMetro())$(".ui-dialog").on("keydown",f)},beforeDialogClose:function(){KindleHostDeviceDetector.isMetro()&&$(".ui-dialog").off("keydown")},onDialogClose:function(){d&&d()}},m=function(e,
f,h,j,m){a=e;c=f;d=h;g=j;b=m;KindleUXComponentManager.openDialog("KindleMessageDialog",k)};return{open:m,close:j,showError:function(a,b,c,d){var e=a;if(a&&a.name)e=a.name;e=KindleErrorMap.getErrorText(e);a&&a.code&&(e.text+=" ["+a.code+"]");m(e.title,e.text,b,c,d)}}}(),KindleNotificationDialog=function(){function f(a){$(window).unbind("touchstart.notification mousedown.notification");KindleHostDeviceDetector.isiOS_5xOrGreater()?$("body",top.document).unbind("orientationchange.notification"):$(window).unbind("resize.notification");
a.removeClass(k.SHOWN);setTimeout(function(){a.remove()},o)}function h(a){function c(d){var e,f,g,h;if(e=b[d.optionProperty])if(typeof e==="string"?f=e:(f=e.id,g=e.localizationParams,h=e.htmlClass),e=ResourceBundle.getLocalizedString(f,g))d=$(d.tag).addClass(d.htmlClass).html(e),h&&d.addClass(h),a.find("."+k.CONTAINER).append(d)}a.find("."+k.CONTAINER).empty();c(k.PRETITLE);c(k.TITLE);c(k.BODY);c(k.LEGAL)}function e(a,b){var c=$("#kindleNotificationArrow"),d=$("#"+b.targetElementId),e=0,f=0;b.targetAlignment===
"right"?(e=d.offset().left+d.outerWidth(),e-=a.outerWidth()):(e=d.offset().left+d.outerWidth()/2,e-=a.outerWidth()/2);(function(){var b=$("body").outerWidth();e+a.outerWidth()>b&&(e=b-a.outerWidth());e<0&&(e=0)})();(function(){var a=b.targetBeakOffset||0;f=d.offset().left-e+d.outerWidth()/2+a})();a.css("left",e+"px");c.css("left",f+"px")}function d(a){function c(){e(a,b);KindleHostDeviceDetector.isiOS()&&a.show();h=null}function d(){h?clearTimeout(h):KindleHostDeviceDetector.isiOS()&&a.hide();h=setTimeout(c,
n)}function g(){u=!0;t&&G.increment();f(a)}var h;$(window).bind("touchstart.notification mousedown.notification",function(a){(!a.srcElement||!a.srcElement.id||!b.clickIdsToIgnore||!b.clickIdsToIgnore[a.srcElement.id])&&setTimeout(g,q)});KindleHostDeviceDetector.isiOS_5xOrGreater()?$("body",top.document).bind("orientationchange.notification",d):$(window).bind("resize.notification",d);setTimeout(g,p)}function c(a){d(a);$("body").append(a);e(a,b);setTimeout(function(){u||(a.addClass(k.SHOWN),setTimeout(function(){t=
!0},l))},m)}function a(a){h(a);c(a)}function g(a){var b=$("<canvas id='kindleNotificationArrow' width='32' height='32'></canvas>"),c=b[0].getContext("2d");c.beginPath();c.moveTo(0,24);c.lineTo(0,25);c.lineTo(32,25);c.lineTo(32,24);c.lineTo(16,0);c.closePath();c.fillStyle="#eee";c.fill();c.beginPath();c.moveTo(0,24);c.lineTo(16,0);c.lineTo(32,24);c.strokeStyle="rgba(32,32,32,0.8)";c.stroke();b.css("top","-24px");b.css("left","50%");b.css("margin-left","-16px");b.css("position","absolute");a.prepend(b);
r.resolve(a)}var b={},j={},k={BODY:{htmlClass:"notificationBodyText",tag:"<div></div>",optionProperty:"bodyId"},LEGAL:{htmlClass:"notificationLegalText",tag:"<div></div>",optionProperty:"legalId"},TITLE:{htmlClass:"notificationTitleText",tag:"<span></span>",optionProperty:"titleId"},PRETITLE:{htmlClass:"notificationPreTitleText",tag:"<span></span>",optionProperty:"preTitleId"},CONTAINER:"notificationContainer",SHOWN:"shown"},m=2E3,l=1E3,p=2E4,q=250,o=3E3,n=100,r=null,t=!1,u=!1,G;return{show:function(c){b=
$.extend({},j,c);G=LocalStorageCounter("kcrNotifications."+b.notificationId);c=b.notificationCount|1;G.getValue()<c&&(r||(r=new jQuery.Deferred,KindleUXComponentManager.initializeComponent("KindleNotificationDialog",g)),r.done(a))},hide:function(){var a=$("#kindleNotification");f(a)}}}(),KindlePopupMenu=function(){function f(a){var c=KindleUXComponentManager.renderTemplate(j),d=c.find(m),e=B[a].menuItems,f=!0,g,k=q;if(B[a].isAppBarMenu){k+=" "+n;var l=B[a].title;if(l){var o=document.createElement("div"),
l=document.createTextNode(l);o.appendChild(l);o.setAttribute("class",r);d.append(o)}}for(var p in e)g=$(document.createElement("div")).addClass(k).addClass(t).text(e[p].content).attr("id",e[p].elementId),f&&(g.addClass(u),f=!1),g.tap(h(g,e[p].clickHandler)),KindleEventBroker.subscribe(e[p].elementId,e[p].clickHandler),d.append(g);g.addClass(G);KindleHostDeviceDetector.isiOS()&&"onorientationchange"in window&&$("body",Kindle.top.document).bind("orientationchange",function(){KindleUXComponentManager.hideMenu(a)});
B[a].doneCallback(c,b(a))}function h(a,b){return function(){a.hasClass(t)&&b()}}function e(a,b,c){var d=[];b?(b=$("#"+b),c==="down"?(c=b.offset(),b=c.top+b.outerHeight(),d[0]=KindleHostDeviceDetector.isMetro()?c.left+23:c.left,d[1]=KindleHostDeviceDetector.isMetro()?b+10:b):(d[0]="right",d[1]="bottom")):d=c;a.dialog("option","position",d)}function d(){w&&(w.removeClass(x),w=null)}function c(a,b,c){var a=a.find(m).children(),d=b;do{if(c==="next")d?(d=d.next(),d.length<=0&&(d=a.first())):d=a.first();
else if(c==="prev")d?(d=d.prev(),d.length<=0&&(d=a.last())):d=a.last();else break;if(d===b)break}while(!d.hasClass(t));return d}function a(a,b){e(a,B[b].buttonID,B[b].position);$(".ui-dialog").on("keydown",function(e){var f=e.keyCode||e.which;KindleEventUtil.preventKeyScroll(e);switch(f){case 38:w&&w.removeClass(x);w=c(a,w,"prev");w.addClass(x);e.stopPropagation();break;case 40:w&&w.removeClass(x);w=c(a,w,"next");w.addClass(x);e.stopPropagation();break;case 13:w&&(e.stopPropagation(),w.removeClass(x),
e=w.attr("id"),KindleEventBroker.fire(e),d());break;case 9:d();D&&KindleUXComponentManager.hideMenu(b);break;case 27:d(),KindleUXComponentManager.hideMenu(b),e.preventDefault(),e.stopPropagation()}});a.find(m).children().each(function(a,b){$(b).on("mouseover",function(a){a=$(a.currentTarget);a.hasClass(t)&&(w?w!==a&&(w.removeClass(x),w=a,a.addClass(x)):(w=a,w.addClass(x)))})})}function g(a){$(".ui-dialog").off("keydown");a.find(m).children().each(function(a,b){$(b).off("mouseover")})}function b(b){return{getDialogSettings:function(){var a=
B[b],c=k;a.isAppBarMenu&&(c+=" "+o);a.buttonID&&(c+=" "+(a.position==="down"?l:p));return{autoOpen:!1,draggable:!1,resizable:!1,modal:!0,minHeight:0,width:"auto",dialogClass:c,k4w_transparent_modal_overlay:!0}},beforeDialogOpen:function(c){a(c,b)},beforeDialogClose:function(a){g(a,b)},onDialogOpen:function(){D=!0},onDialogClose:function(){D=!1},onOverlayClicked:function(){D&&KindleUXComponentManager.hideMenu(b);d()}}}var j="KindlePopupMenu",k="kindle_menu",m="#kindle_menu_border",l="down_menu",p=
"up_menu",q="kindle_menu_button",o="kindle_appbar_menu",n="appbar_menu_button",r="appbar_menu_title",t="button_enabled",u="ui-corner-top",G="ui-corner-bottom",x="selected",B={},D=!1,w=null;return{MENU_POSITION_CONSTANTS:{APPBAR_MENU_MARGIN_PX:5,APPBAR_HEIGHT_PX:102,APPBAR_HEIGHT_SNAPVIEW_PX:70},ITEM_ENABLED:0,ITEM_DISABLED:1,ITEM_HIDDEN:2,initialize:function(a){B[a.componentName]={menuItems:a.menuItems,doneCallback:a.doneCallback,buttonID:a.buttonID,position:a.position,title:a.title,isAppBarMenu:a.isAppBarMenu};
KindleUXComponentManager.hasTemplate(j)?f(a.componentName):KindleUXComponentManager.initializeTemplate(j,function(){f(a.componentName)})},updateMenu:function(a,b,c){for(var d,e,f=0;f<b.length;f++)b[f]!==2&&(d===void 0&&(d=f),e=f);var g=B[c].isAppBarMenu;a.find("."+q).each(function(a){var c=q;if(g||$(this).hasClass(n))c+=" "+n;$(this).attr("class",c);switch(b[a]){case 0:$(this).addClass(t);break;case 1:$(this).addClass("button_disabled");break;case 2:$(this).addClass("button_hidden")}a===d&&$(this).addClass(u);
a===e&&$(this).addClass(G)})},updatePosition:function(a,b){B[a].position=b}}}(),KindlePromptDialog=function(){var f={OK_BUTTON_STRING_ID:"k_common_confirm_button",CANCEL_BUTTON_STRING_ID:"k_common_cancel_button"},h={TEXT_LABEL_ID:"kindle_dialog_prompt_label"},e,d,c,a=function(){c="ok";KindleUXComponentManager.closeDialog("KindlePromptDialog")},g=function(){c="cancel";KindleUXComponentManager.closeDialog("KindlePromptDialog")},b={getDialogSettings:function(){var b={};b[ResourceBundle.getLocalizedString(f.CANCEL_BUTTON_STRING_ID)]=
g;b[ResourceBundle.getLocalizedString(f.OK_BUTTON_STRING_ID)]=a;return{autoOpen:!1,modal:!0,draggable:!1,resizable:!1,buttons:b,k4w_transparent_modal_overlay:!0}},beforeDialogOpen:function(a){var b=ResourceBundle.getLocalizedString(d);a.find("#"+h.TEXT_LABEL_ID).empty().append(b)},onDialogClose:function(){e(c)}};return{open:function(a,f){e=f;c=!1;d=a;KindleUXComponentManager.openDialog("KindlePromptDialog",b)}}}(),KindleSigningOutDialog=function(){var f={getDialogSettings:function(){return{autoOpen:!1,
modal:!0,draggable:!1,resizable:!1,width:"450px"}}};return{show:function(){KindleUXComponentManager.openDialog("KindleSigningOutDialog",f)},hide:function(){KindleUXComponentManager.closeDialog("KindleSigningOutDialog")}}}(),KindleSmallWindowDialog=function(){function f(){KindleUXComponentManager.closeDialog(h);a&&a()}var h="KindleSmallWindowDialog",e={BUTTON_TEXT:"k_dialog_smallWindow_button_ignore",TITLE:"k_dialog_smallWindow_title",DESCRIPTION:"k_dialog_smallWindow_msg"},d={DIALOG:"kindle_dialog_smallWindow",
CONTENT:"kindle_dialog_firstRun_content",TITLE:"small_window_title",DESCRIPTION:"small_window_description",BUTTON:"kindle_dialog_smallWindow_button"},c,a,g,b,j={getDialogSettings:function(){return{autoOpen:!1,width:"auto",modal:!0,draggable:!1,resizable:!1,dialogClass:"smallWindowDialog"}},beforeDialogOpen:function(a){g=a;g.find("#"+d.TITLE).html(b.title);g.find("#"+d.DESCRIPTION).html(b.description);a=g.find("#"+d.BUTTON);a.html(ResourceBundle.getLocalizedString(e.BUTTON_TEXT));a.one("click",f)},
onDialogOpen:function(){var a=$("#"+d.DIALOG);a.parents(".ui-dialog:first").removeClass("ui-widget ui-widget-content ui-corner-all");a.removeClass("ui-dialog-content ui-widget-content");c&&c()}};return{open:function(d){b={title:ResourceBundle.getLocalizedString(e.TITLE),description:ResourceBundle.getLocalizedString(e.DESCRIPTION)};a=d&&d.onDialogIgnoreCB;c=d&&d.onDialogOpenCB;KindleUXComponentManager.openDialog(h,j)},close:function(){KindleUXComponentManager.closeDialog(h)}}}(),KindleUnoptimizedFormatDialog=
function(){var f={TEXT_LABEL_STRING_ID:"k_R_dialog_unoptimizedFormat_message",METRO_TEXT_LABEL_STRING_ID:"k_R_dialog_unoptimizedFormat_metro_message",CLOSE_BUTTON_STRING_ID:"k_R_dialog_unoptimizedFormat_close",STOP_BUTTON_STRING_ID:"k_R_dialog_unoptimizedFormat_stopSave",CONTINUE_BUTTON_STRING_ID:"k_R_dialog_unoptimizedFormat_continue"},h={TEXT_LABEL_ID:"kindleReader_dialog_unoptimizedFormat_message_id"},e,d,c,a=function(){KindleUXComponentManager.closeDialog("KindleUnoptimizedFormatDialog")},g=function(){d=
!0;KindleUXComponentManager.closeDialog("KindleUnoptimizedFormatDialog")},b={getDialogSettings:function(){var b={};b[ResourceBundle.getLocalizedString(f.CLOSE_BUTTON_STRING_ID)]=a;b[ResourceBundle.getLocalizedString(f.CONTINUE_BUTTON_STRING_ID)]=g;return{autoOpen:!1,modal:!0,draggable:!1,resizable:!1,buttons:b,k4w_transparent_modal_overlay:!0}},beforeDialogOpen:function(a){var b=KindleHostDeviceDetector.isMetro()?f.METRO_TEXT_LABEL_STRING_ID:f.TEXT_LABEL_STRING_ID,b=ResourceBundle.getLocalizedString(b,
{linkStart:"<a href='http://itunes.apple.com/us/app/kindle/id302584613?mt=8'>",linkEnd:"</a>"});a.find("#"+h.TEXT_LABEL_ID).empty().append(b);$(a[0].parentNode).find(".ui-button-text").first().text(c)},onDialogClose:function(){e(d)}};return{open:function(a){c=ResourceBundle.getLocalizedString(f.CLOSE_BUTTON_STRING_ID);e=a;d=!1;KindleUXComponentManager.openDialog("KindleUnoptimizedFormatDialog",b)},openPinning:function(a){c=ResourceBundle.getLocalizedString(f.STOP_BUTTON_STRING_ID);e=a;d=!1;KindleUXComponentManager.openDialog("KindleUnoptimizedFormatDialog",
b)}}}(),KindleLibraryAppCacheFailDialog=function(){function f(){KindleUXComponentManager.closeDialog(h)}var h="KindleLibraryAppCacheFailDialog",e={DIALOG:"kindle_dialog_appCacheFail",IMG_ARROW_ID:"appCacheDialogFail_arrow",CONTENT_TEXT_ID:"appCacheDialogFail_content",TOGGLER_ID:"appCacheDialogFail_toggler",BUTTON:"kindle_appCacheDialog_button"},d=!1,c=!1,a,g={onDialogOpen:function(a){var c=$("#"+e.DIALOG);c.parents(".ui-dialog:first").removeClass("ui-widget ui-widget-content ui-corner-all");c.removeClass("ui-dialog-content ui-widget-content");
d=!0;a.dialog("option","position","center")},getDialogSettings:function(){return{autoOpen:!1,modal:!0,draggable:!1,resizable:!1,width:626,position:"center",k4w_transparent_modal_overlay:!0}},onInitializationDone:function(b){a=KindleModuleManager.getModuleSync(KindleModuleManager.METRICS_MANAGER);b.find("#"+e.BUTTON).bind("click",f);var d=b.find("#"+e.TOGGLER_ID),g=b.find("#"+e.IMG_ARROW_ID),h=b.find("#"+e.CONTENT_TEXT_ID);d.tap(function(){h.slideToggle("fast",function(){b.dialog("option","position",
"center")});g.hasClass("kindleLibrary_arrowClosed")?g.switchClass("kindleLibrary_arrowClosed","kindleLibrary_arrowOpen",0):g.switchClass("kindleLibrary_arrowOpen","kindleLibrary_arrowClosed",0);c||a.emit("KindleApp:AppCacheError:BrowserRebootPrompt:ExpandClicked",{breakdown:["Browser"]});c=!0})}};return{hasBeenShownThisSession:function(){return d},open:function(){KindleUXComponentManager.openDialog(h,g)},close:f}}(),KindleLibraryContextMenu=function(){function f(a){return function(){e();a(c)}}function h(c){function d(a,
b,c){return{elementId:a,content:b,clickHandler:c}}a={};var e=0,h;for(h in b)a[b[h]]=d(b[h],ResourceBundle.getLocalizedString(g[h]),f(c[e])),e++}function e(){KindleUXComponentManager.hideMenu(d)}var d="KindleLibraryContextMenu",c,a,g={ITEM_OPEN_BOOK:"k_L_context_read",ITEM_PIN:"k_L_context_pin",ITEM_REMOVE:"k_L_context_remove",ITEM_DOWNLOAD_PIN:"k_L_context_download_pin",ITEM_REVOKE_SAMPLE:"k_L_context_revoke_sample"},b={ITEM_OPEN_BOOK:"kindleLibrary_contextMenuItem_open_book",ITEM_PIN:"kindleLibrary_contextMenuItem_pin",
ITEM_REMOVE:"kindleLibrary_contextMenuItem_remove",ITEM_DOWNLOAD_PIN:"kindleLibrary_contextMenuItem_download_pin",ITEM_REVOKE_SAMPLE:"kindleLibrary_contextMenuItem_revoke"};return{isVisible:function(){return KindleUXComponentManager.isVisible(d)},show:function(b,e,f,g){c=b;a=null;h(g);KindleUXComponentManager.showMenu({componentName:d,menuItems:a,buttonID:null,position:f,title:null,isAppBarMenu:!1,enabledFlags:e})},hide:e}}(),KindleLibraryControlBar=function(){function f(a,b){var c=A.find("#"+a).children(),
d,e;for(d=0;d<c.length;d++)e=c[d].id,e===b?$(c[d]).addClass(D.ACTIVE):$(c[d]).removeClass(D.ACTIVE)}function h(a,b,c){var d=a.find("#"+b);d.tap(function(){if(c)return c(d[0]),!1})}function e(e){A=e;A.find("#view_"+k).addClass(D.ACTIVE);A.find("#view_"+m).addClass(D.ACTIVE);var l=b[q],p=b[t],u=b[o];h(e,x.VIEW_GRID_ID,function(a){f(x.LAYOUT_BUTTONS_ID,x.VIEW_GRID_ID);z&&z.show();l(a.getAttribute("value"))});h(e,x.VIEW_LIST_ID,function(a){f(x.LAYOUT_BUTTONS_ID,x.VIEW_LIST_ID);z&&z.hide();l(a.getAttribute("value"))});
h(e,x.SORT_BUTTON_ID,function(){u()});$.each(x.VIEW,function(a,b){h(e,b,function(a){!KindleHostDeviceDetector.isOnline()&&a.id===x.VIEW.CLOUD_ID||!KindleOffline.isEnabled()&&a.id===x.VIEW.DOWNLOAD_ID||f(x.VIEW_BUTTONS_ID,a.id);p(a.getAttribute("value"))})});switch(G()){case Kindle.APP_CACHE.CACHE_NEEDS_BROWSER_RESTART:c();break;case Kindle.APP_CACHE.CACHE_NEEDS_RETRY:c();break;case Kindle.APP_CACHE.CACHE_PROGRESS:d(H);break;case Kindle.APP_CACHE.CACHE_CACHED:a();break;case Kindle.APP_CACHE.CACHE_DONE:a()}if(KindleHostDeviceDetector.isiOS())g(e);
else{z=KindleLibraryImageSlider;var w={};w[z.EVENT_LIBRARY_IMAGE_CHANGING]=b[n];w[z.EVENT_LIBRARY_IMAGE_CHANGED]=b[r];z.initialize(function(a){a.insertAfter(A.find("#"+x.VIEW_TOGGLE_ID));g(e)},j,k,w)}}function d(a){H=a;A&&A.addClass(D.CACHING)}function c(){if(A){A.removeClass(D.CACHE_SUCCESS).addClass(D.CACHE_ERROR);var a=KindleHostDeviceDetector.isiPad()?B.CACHE_ERROR_MESSAGE_PAD:B.CACHE_ERROR_MESSAGE;A.find("#"+x.MESSAGE_ID).empty().append(ResourceBundle.getLocalizedString(a)).tap(u)}}function a(){A&&
(A.find("#"+x.MESSAGE_ID).empty().append(ResourceBundle.getLocalizedString(B.CACHE_DONE_MESSAGE)),A.removeClass(D.CACHE_ERROR).addClass(D.CACHE_SUCCESS),setTimeout(function(){A.removeClass(D.CACHING)},w))}var g,b,j,k,m,l,p=0,q=p++,o=p++,n=p++,r=p++,t=p++,u,G,x={VIEW_GRID_ID:"view_grid",VIEW_LIST_ID:"view_list",SORT_BUTTON_ID:"kindleLibrary_button_sort",VIEW:{DOWNLOAD_ID:"view_downloaded",CLOUD_ID:"view_cloud"},VIEW_BUTTONS_ID:"view_state_buttons",CONTAINER_ID:"view_sort_size_controls",LAYOUT_BUTTONS_ID:"view_buttons",
SORT_BUTTONS_ID:"view_sort",VIEW_TOGGLE_ID:"view_toggle",MESSAGE_ID:"cache_message"},B={CACHE_MESSAGE:"k_L_caching",CACHE_DONE_MESSAGE:"k_L_cached",CACHE_ERROR_MESSAGE:"k_L_cacheError",CACHE_ERROR_MESSAGE_PAD:"k_L_cacheError_pad"},D={ACTIVE:"btn_set_active",CACHING:"caching",CACHE_ERROR:"cacheError",CACHE_SUCCESS:"cacheSuccess"},w=3E3,A,z,H=1;return{EVENT_LIBRARY_LAYOUT_CLICKED:q,EVENT_LIBRARY_SORT_CLICKED:o,EVENT_LIBRARY_IMAGE_CHANGING:n,EVENT_LIBRARY_IMAGE_CHANGED:r,EVENT_LIBRARY_VIEW_CLICKED:t,
CONTAINER_HEIGHT:45,initialize:function(a,c,d){g=a;b=d;j=c.coverSize;k=c.layoutState;m=c.viewState;l=c.sortParam;KindleModuleManager.getModuleSync(KindleModuleManager.METRICS_MANAGER);a=ResourceBundle.getLocalizedString(KindleLibrarySort.getLabel(l));KindleUXComponentManager.initializeComponent("KindleLibraryControlBar",e,{sortParam:a})},setViewState:function(a){m=a;f(x.VIEW_BUTTONS_ID,"view_"+a)},setCacheProgress:d,setCacheNeedsRetry:c,setCacheDone:a,setRetryCallback:function(a){u=a},setAppCacheStatusGetter:function(a){G=
a},hideViewTabs:function(){$("#page_body").addClass("search_mode",200)},showViewTabs:function(){$("#page_body").removeClass("search_mode",200)}}}(),KindleLibraryHeaderBar=function(){function f(a,b){a.find("#"+r[b]).tap(function(){var a=A[t[b]];a&&a();return!1})}function h(b){z=b;H=$(b.find("#"+r.SYNC_BUTTON_ID)[0]);var c=A[t.SYNC_BUTTON_ID];A[t.SYNC_BUTTON_ID]=function(){C||c()};b.find(":not(.search)").click(function(){B&&a(!0)});var d=b.find("#"+r.SEARCH_BAR_ID),h=b.find("#"+r.CLEAR_BUTTON_ID);d.keydown(function(a){a.keyCode===
13&&a.preventDefault()});KindleLibrary.registerControlHotkey("F",e);d.keyup(function(){var a=d.attr("value");if(x[G.SEARCH]&&(!KindleHostDeviceDetector.isArm()||a.length>1||a.length===0))x[G.SEARCH](a);a&&!D?h.fadeIn(200):!a&&D&&h.fadeOut(420);D=a});A[t.CLEAR_BUTTON_ID]=g;b.find("#"+r.SEARCH_BUTTON_ID).click(e);b.find("#"+r.CLEAR_BUTTON_ID).click(g);for(var j in r)r[j]===r.SEARCH_BUTTON_ID||r[j]===r.SEARCH_BAR_ID||r[j]===r.CLEAR_BUTTON_ID||f(b,j);KindleTouchEventsToggler.isRequired()&&(d.focus(function(){KindleTouchEventsToggler.off(function(a){return a&&
a.tagName==="BODY"?!1:!0})}),d.blur(function(){KindleTouchEventsToggler.on()}));setTimeout(function(){var a=b.find("#kindleLibrary_search"),c=b.find("#header_right"),a=a.position().left+a.outerWidth()+c.outerWidth()-$(document).width();a>0&&(a=d.width()-a,a>100&&d.width(a))},0);w(b)}function e(){B?a(!0):d()}function d(){if(!I){I=!0;var a=$("#"+r.SEARCH_BAR_ID),b=$("#"+r.SEARCH_BUTTON_ID);B=!0;if(x[G.ENABLE])x[G.ENABLE]();a.attr("value","");a.show();a.prop("disabled",!1);a.focus();a.css("opacity",
100);a.hide();b.fadeOut(150,function(){b.removeClass("header_bar_icon large");b.addClass("small");b.fadeIn(100);a.fadeIn(420,function(){I=!1;a.focus()})})}}function c(){if(KindleHostDeviceDetector.isiOS()){var a=$("#"+r.SEARCH_BUTTON_ID),b=$("#"+r.SEARCH_BAR_ID);b.detach();a.after(b)}}function a(a){if(B&&!I){var b=$("#"+r.SEARCH_BAR_ID);if(!b.val().trim()||a){var d=$("#"+r.SEARCH_BUTTON_ID);I=!0;c();b.blur();B=!1;g();if(x[G.DISABLE])x[G.DISABLE]();b.fadeOut(333,function(){b.attr("disabled","disabled");
b.css("opacity",0);d.hide();d.removeClass("small");d.addClass("header_bar_icon large");d.fadeIn(150,function(){I=!1})})}}}function g(){$("#"+r.SEARCH_BAR_ID).attr("value","");D="";$("#"+r.CLEAR_BUTTON_ID).fadeOut(420);B&&$("#"+r.SEARCH_BAR_ID).focus();if(x[G.SEARCH])x[G.SEARCH]("")}var b=0,j=b++,k=b++,m=b++,l=b++,p=b++,q=b++,o=b++,n=b++,r={KINDLE_LOGO_ID:"kindleLibrary_kindleLogo",NOTEBOOK_BUTTON_ID:"kindleLibrary_button_notebook",SEARCH_BUTTON_ID:"kindleLibrary_button_search",SYNC_BUTTON_ID:"kindleLibrary_button_sync",
MANAGE_BUTTON_ID:"kindleLibrary_button_manage",STORE_BUTTON_ID:"kindleLibrary_button_store",SEARCH_BAR_ID:"kindleLibrary_bar_search",CLEAR_BUTTON_ID:"kindleLibrary_clear_search"},t={KINDLE_LOGO_ID:j,SEARCH_BUTTON_ID:k,SEARCH_BAR_ID:m,CLEAR_BUTTON_ID:l,NOTEBOOK_BUTTON_ID:q,SYNC_BUTTON_ID:p,MANAGE_BUTTON_ID:o,STORE_BUTTON_ID:n},b=0,l=b++,u=b++,b=b++,G={ENABLE:l,SEARCH:u,DISABLE:b},x,B=!1,D="",w,A,z,H,C=!1,I=!1;return{EVENT_LOGO_CLICKED:j,EVENT_SEARCH_CLICKED:k,EVENT_BAR_CLICKED:m,EVENT_NOTEBOOK_CLICKED:q,
EVENT_SYNC_CLICKED:p,EVENT_MANAGE_CLICKED:o,EVENT_STORE_CLICKED:n,SEARCH_CALLBACK:G,initialize:function(a,b,c){w=a;A=b;x=c;KindleUXComponentManager.initializeComponent("KindleLibraryHeaderBar",h)},setSyncButtonDisabled:function(a){z&&(a?H.addClass("disabled"):H.removeClass("disabled"),C=a)},activateSearch:d,deactivateSearch:a,dismissKeyboard:function(){B&&($("#"+r.SEARCH_BAR_ID).attr("value")===""?a():c())},clearSearch:g}}(),KindleLibraryHomeScreenPopup=function(){function f(b){var f=$(document.createElement("span")).addClass(e.STRONG_TEXT_CLASS).text(ResourceBundle.getLocalizedString(d.STRONG_TEXT_ID)).context.outerHTML;
b.find("."+e.TEXT_CLASS).append(ResourceBundle.getLocalizedString(d.TEXT_ID,{addToHomeText:f}));$("body").append(b);KindleHostDeviceDetector.isiOS_7x()?$("#"+e.POPUP_ID).addClass(e.IOS7):KindleHostDeviceDetector.isiOS_8x()&&$("#"+e.POPUP_ID).addClass(e.IOS8);setTimeout(function(){b.addClass(h);b.tap(function(){KindleHostDeviceDetector.isiOS_5xOrGreater()&&KindleLibraryHeaderBar.deactivateSearch();b.removeClass(h)});setTimeout(function(){b.removeClass(h)},a);setTimeout(function(){b.remove()},g)},c)}
var h="shown",e={IMAGE_CLASS:"addToHomeActionIcon",TEXT_CLASS:"addToHomeText",STRONG_TEXT_CLASS:"addToHomeStrongText",POPUP_ID:"kindleAddToHomeScreen",IOS7:"ios7",IOS8:"ios8"},d={TEXT_ID:"k_addToHomeScreen_text",STRONG_TEXT_ID:"k_addToHomeScreen_strong_text"},c=5E3,a=14E3,g=17E3,b;return{show:function(){!b&&KindleHostDeviceDetector.isiOS()&&!KindleHostDeviceDetector.isInAppMode()&&(b=!0,KindleUXComponentManager.initializeComponent("KindleLibraryHomeScreenPopup",f))}}}(),KindleLibraryImageSlider=function(){function f(){k&&
k.hide()}function h(g){k=g;var h=c[b],q=c[j],o=k.find("#"+m.IMAGE_SLIDER_ID);o.slider({range:"min",value:e,max:12,min:6,step:1,animate:!0,slide:h,change:q});o.find(".ui-slider-handle").removeAttr("href");o.find(".ui-slider-handle").attr("id",m.IMAGE_SLIDER_HANDLE_ID);d==="list"&&f();a(g)}var e,d,c,a,g=0,b=g++,j=g++,k,m={IMAGE_SLIDER_ID:"kindleLibrary_coverImage_slider",IMAGE_SLIDER_HANDLE_ID:"kindleLibrary_coverImage_slider_handle"};return{EVENT_LIBRARY_IMAGE_CHANGING:b,EVENT_LIBRARY_IMAGE_CHANGED:j,
initialize:function(b,f,g,j){a=b;d=g;c=j;e=f;KindleUXComponentManager.initializeComponent("KindleLibraryImageSlider",h)},show:function(){k&&k.show()},hide:f}}(),KindleLibraryJPMerchandiseDialog=function(){function f(){KindleUXComponentManager.closeDialog(j);t()}function h(a){a&&(a=(a.target||a.srcElement).getAttribute("data-asin"),r(a))}function e(a){if(a&&a.length>0){var b=$("#"+l.ContentContainer);b.empty();var d=KindleUXComponentManager.renderTemplate(k,{bookList:a});b.append(d);b=d.find("."+p.BookCover);
b.on("click",h);var e=0,f=a.length;b.bind("load",function(){e++;e===f&&c()}).each(function(){this.complete&&$(this).load()})}}function d(){var b=$("#"+l.Pane),d=a();b.dialog("option","height",d.height);b.dialog("option","width",d.width);b.dialog("option","position",{my:"center",at:"center",of:window});c()}function c(){var a=$("#"+l.ScrollPane);o?a.jScrollPane({showArrows:!0,verticalGutter:35}):q?n?n.refresh():n=new iScroll(l.ScrollWrapper,{vScrollbar:!1}):a.addClass("ie_scrollable");$("#"+l.ScrollPane).focus()}
function a(){var a;a=KindleHostDeviceDetector.isiOS()?$("body",Kindle.top.document).height()-100:KindleHostDeviceDetector.isMetro()?window.outerHeight-250:window.innerHeight-100;var b=window.outerWidth<960?Math.max(720,window.outerWidth):960,b=KindleHostDeviceDetector.isiOS()?"80%":b-30+"px";return{height:a,width:b}}function g(){var b={};b[ResourceBundle.getLocalizedString(m.CLOSE_BUTTON_STRING_ID)]=f;var c={},c=a();return c={autoOpen:!1,width:c.width,height:c.height,modal:!0,draggable:!1,resizable:!1,
buttons:b}}function b(){clearTimeout(u);u=setTimeout(d,50)}var j="KindleLibraryJPMerchandiseDialog",k="KindleLibraryJPMerchandiseContent",m={CLOSE_BUTTON_STRING_ID:"k_common_close_button"},l={Pane:"kindleLibrary_jp_merchandise_pane",ContentContainer:"kindleLibrary_jp_merchandise_content",ScrollPane:"kindleLibrary_jp_merchandise_scrollPane",ScrollWrapper:"kindleLibrary_jp_merchandise_scrollWrapper"},p={BookCover:"book_merch_image"},q=KindleHostDeviceDetector.isiOS(),o=!q&&!KindleHostDeviceDetector.isIE(),
n,r,t,u;return{open:function(a,c,d){r=c;t=d;KindleUXComponentManager.openDialog(j,{onDialogOpen:function(){e(a);$(window).on("resize",b)},onDialogClose:function(){$(window).off("resize",b)},getDialogSettings:g})}}}(),KindleLibraryMessagePane=function(){function f(b){g=!1;b.find(h.EMPTY_LIBRARY_BOX).tap(function(){a();return!0});var f=ResourceBundle.getLocalizedString(d.EMPTY_SEARCH_MSG);b.find("#"+h.EMPTY_SEARCH_TEXT).text(f);f=ResourceBundle.getLocalizedString(d.EMPTY_SEARCH_OFFLINE);b.find("#"+
h.EMPTY_SEARCH_DETAIL).text(f);f=ResourceBundle.getLocalizedString(d.EMPTY_LIBRARY_storeName);f=ResourceBundle.getLocalizedString(j?d.EMPTY_LIBRARY_MANGA_MSG:d.EMPTY_LIBRARY_MSG,{storeName:f});b.find(h.EMPTY_LIBRARY_MAIN).text(f);j&&(f=ResourceBundle.getLocalizedString(d.EMPTY_LIBRARY_MANGA_BUTTON),b.find("."+e.EMPTY_LIBRARY_BUTTON).text(f));c(b)}var h={EMPTY_LIBRARY_BOX:"#empty-lib-box",EMPTY_LIBRARY_MAIN:"#empty-lib-box p.main",EMPTY_LIBRARY_FREE:"#empty-lib-box p.free",EMPTY_SEARCH_BOX:"#empty_search_box",
EMPTY_SEARCH_TEXT:"#empty_search_text",EMPTY_SEARCH_DETAIL:"#empty_search_detail"},e={EMPTY_LIBRARY_STORENAME:"store-name",EMPTY_LIBRARY_BUTTON:"primary_btn"},d={EMPTY_SEARCH_MSG:"k_empty_search_msg",EMPTY_SEARCH_OFFLINE:"k_empty_search_offline",EMPTY_LIBRARY_MSG:"k_empty_library_main",EMPTY_LIBRARY_storeName:"k_empty_library_store_name",EMPTY_LIBRARY_MANGA_MSG:"k_empty_library_manga_msg",EMPTY_LIBRARY_MANGA_BUTTON:"k_empty_library_manga_button"},c,a,g,b,j;return{initialize:function(b,d,e){c=b;a=
d;j=e;KindleUXComponentManager.initializeComponent("KindleLibraryMessagePane",f)},showEmptyLibraryMessage:function(){function a(){var c=b[0].getClientRects()[0].top,d=b.find(".legal")[0].getClientRects()[0].bottom,e=parseInt(b.css("padding-bottom"),10),c=d-c-e;c>200&&b.css({height:c})}var b=$(h.EMPTY_LIBRARY_BOX);g||($("#page_body_content_containers").hide(),b.show(),g=!0,a())},hideEmptyLibraryMessage:function(){g&&($("#page_body_content_containers").show(),$(h.EMPTY_LIBRARY_BOX).hide(),g=!1)},showEmptySearchMessage:function(a){!b&&
!g&&($("#page_body_content_containers").hide(),$(h.EMPTY_SEARCH_BOX).show(),$(h.EMPTY_SEARCH_TEXT).show(),a?$(h.EMPTY_SEARCH_DETAIL).show():$(h.EMPTY_SEARCH_DETAIL).hide(),b=!0)},hideEmptySearchMessage:function(){b&&($("#page_body_content_containers").show(),$(h.EMPTY_SEARCH_BOX).hide(),$(h.EMPTY_SEARCH_TEXT).hide(),$(h.EMPTY_SEARCH_DETAIL).hide(),b=!1)}}}(),KindleLibraryNoDownloadedMessage=function(){function f(f){c=f;var f=c.find("."+d.TOGGLER_CLASS),b=c.find("."+d.IMG_ARROW_CLASS),j=c.find("."+
d.CONTENT_TEXT_CLASS);f.tap(function(){j.slideToggle("fast");b.hasClass(h)?b.switchClass(h,e,0):b.switchClass(e,h,0)});a.resolve()}var h="kindleLibrary_arrowClosed",e="kindleLibrary_arrowOpen",d={TOGGLER_CLASS:"kindleLibrary_noDownloadedToggle",CONTENT_TEXT_CLASS:"kindleLibrary_noDownloadedContent",IMG_ARROW_CLASS:"kindleLibrary_noDownloadedArrow"},c,a;return{show:function(){a||(a=new jQuery.Deferred,KindleUXComponentManager.initializeComponent("KindleLibraryNoDownloadedMessage",f));a.promise().then(function(){$("#kindleLibrary_noDownloadsMsg").length<=
0&&$("#titles_container").append(c)})},hide:function(){a&&c.detach()}}}(),KindleLibraryProgressDialog=function(){function f(){KindleUXComponentManager.closeDialog(e);a()}function h(a){g&&a>=0&&a<=100&&g.find("#"+c.PROGRESS_DIV_ID).slider("option","value",a)}var e="KindleLibraryProgressDialog",d={DIALOG_CANCEL_BTN_ID:"k_common_cancel_button"},c={PROGRESS_DIV_ID:"kindleLibrary_progressbar_div"},a,g,b={getDialogSettings:function(){var a={};a[ResourceBundle.getLocalizedString(d.DIALOG_CANCEL_BTN_ID)]=
f;return{autoOpen:!1,modal:!0,draggable:!1,resizable:!1,buttons:a,k4w_transparent_modal_overlay:!0}},beforeDialogOpen:function(){h(0)},onInitializationDone:function(a){g=a;g.find("#"+c.PROGRESS_DIV_ID).slider({range:"min",value:0,disabled:!0,max:100,min:0,step:1,animate:!0});g.find(".ui-slider-range").addClass("ui-corner-all")}};return{open:function(c){a=c;KindleUXComponentManager.openDialog(e,b)},close:function(){KindleUXComponentManager.closeDialog(e)},updateValue:h}}(),KindleLibraryScrollBar=function(){function f(a){u=
a;g(u.find("#"+m.UP_ARROW_ID),!0);g(u.find("#"+m.DOWN_ARROW_ID),!1);D&&k();r(u)}function h(a,b){w=z-b.value;t(w,!1)}function e(a,b){w=z-b.value;t(w,!0)}function d(a){w=a;u.find("#"+m.PROGRESS_ID).slider("option","value",z-a)}function c(a){a=w+a;a=Math.min(a,z);a=Math.max(a,0);d(a);t(a,!0)}function a(){u.find("#"+m.PROGRESS_ID).slider({orientation:"vertical",animate:!0,slide:h,stop:e});u.find("."+l).removeAttr("href");u.find("."+l).attr("id",m.SLIDER_HANDLE_ID);u.find("#"+m.SLIDER_CONTAINER_ID).tap(function(a){w=
a.clientY<a.currentTarget.offsetHeight/2?0:z;d(w);t(w,!0)});G=!0}function g(a,c){a.bind({mousedown:function(){b(c)},mouseup:j,mouseleave:j})}function b(a){j();var b=a?-p:p;c(b);B=0;x=setInterval(function(){B++;B>=o&&c(b)},q)}function j(){clearInterval(x)}function k(){G||a();var b=u.find("#"+m.SLIDER_CONTAINER_ID).height(),b=Math.max(b*A/D,n);u.find("#"+m.SLIDER_DIV_ID).css({top:b/2+"px",bottom:b/2+"px"});z=D-A;u.find("#"+m.PROGRESS_ID).slider("option","min",0).slider("option","max",z);d(w);u.find("."+
l).css({"margin-bottom":-b/2+"px",height:b+"px"})}var m={SLIDER_CONTAINER_ID:"KindleLibrarySliderContainer",SLIDER_DIV_ID:"KindleLibrarySliderDiv",SLIDER_HANDLE_ID:"kindleLibrarySliderHandle",PROGRESS_ID:"KindleLibraryProgress",UP_ARROW_ID:"kindleLibrarySliderUpArrow",DOWN_ARROW_ID:"kindleLibrarySliderDownArrow"},l="ui-slider-handle",p=80,q=100,o=5,n=20,r,t,u,G,x,B,D,w,A,z;return{initialize:function(a,b){r=a;t=b;KindleUXComponentManager.initializeComponent("KindleLibraryScrollBar",f)},updateValueRange:function(a,
b,c){D=a;w=b;A=c;u&&k()},updateValue:function(a){w=a;u&&d(a)},moveStart:b,moveEnd:j,movePage:function(a){c(a?-A:A)}}}(),KindleLibrarySettingsMenu=function(){function f(){d();KindleSigningOutDialog.show();KindleX.deregister(null,!0).progress(function(b){var c=KindleModuleManager.getModuleSync(KindleModuleManager.LINK_URLS);b&&(b.clearDbAttempts>=1?(KindleMessageDialog.open(ResourceBundle.getLocalizedString(a.PREV_SIGNOUT_FAILED_TITLE),ResourceBundle.getLocalizedString(a.PREV_SIGNOUT_FAILED_TEXT),null,
null,[{buttonText:ResourceBundle.getLocalizedString(a.OK_ID)},{buttonText:ResourceBundle.getLocalizedString(a.HELP_ID),callback:function(){window.open(c.getTroubleshootingUrl())}}]),KindleModuleManager.getModuleSync(KindleModuleManager.METRICS_MANAGER).emit("Library::SignOut::PrevAttemptFailed",{breakdown:["Browser"]})):b.blocked&&KindleMessageDialog.open(ResourceBundle.getLocalizedString(a.DB_BLOCKED_TITLE),ResourceBundle.getLocalizedString(a.DB_BLOCKED_TEXT)))}).fail(function(){KindleSigningOutDialog.hide();
KindleMessageDialog.open(ResourceBundle.getLocalizedString(a.OFFLINE_LOGOUT_TITLE),ResourceBundle.getLocalizedString(a.OFFLINE_LOGOUT_TEXT))})}function h(){function b(a,c,d){return{elementId:a,content:c,clickHandler:d}}var c={},d=KindleModuleManager.getModuleSync(KindleModuleManager.LINK_URLS);c.ITEM_HELP=b(g.ITEM_HELP,ResourceBundle.getLocalizedString(a.HELP_ID),e(d.getHelpUrl(),g.ITEM_HELP));c.ITEM_TERMS=b(g.ITEM_TERMS,ResourceBundle.getLocalizedString(a.TERM_OF_USE_ID),e(d.getTermsOfUseUrl(),g.ITEM_TERMS));
c.ITEM_LEGAL=b(g.ITEM_LEGAL,ResourceBundle.getLocalizedString(a.LEGAL_NOTICE_ID),e(d.getLegalUrl(),g.ITEM_LEGAL));c.ITEM_PRIVACY=b(g.ITEM_PRIVACY,ResourceBundle.getLocalizedString(a.PRIVACY_ID),e(d.getPrivacyUrl(),g.ITEM_PRIVACY));c.ITEM_CONTACT_US=b(g.ITEM_CONTACT_US,ResourceBundle.getLocalizedString(a.CONTACT_US_ID),e("mailto:cloud-reader-feedback@amazon.com",g.ITEM_CONTACT_US));c.ITEM_DEREGISTER=b(g.ITEM_DEREGISTER,ResourceBundle.getLocalizedString(a.DEREGISTER_ID),f);return c}function e(a,c){var e=
KindleModuleManager.getModuleSync(KindleModuleManager.METRICS_MANAGER);return function(){switch(c){case g.ITEM_HELP:e.emit("Library::Open::HelpLink");break;case g.ITEM_TERMS:e.emit("Library::Open::TermsLink");break;case g.ITEM_LEGAL:e.emit("Library::Open::Legal");break;case g.ITEM_PRIVACY:e.emit("Library::Open::PrivacyLink");break;case g.ITEM_CONTACT_US:e.emit("Library::Open::ContactUs")}d();b(a)}}function d(){KindleUXComponentManager.hideMenu(c)}var c="KindleLibrarySettingsMenu",a={OK_ID:"k_common_confirm_button",
HELP_ID:"k_L_help",TERM_OF_USE_ID:"k_L_terms_of_use",LEGAL_NOTICE_ID:"k_L_legal_notices",PRIVACY_ID:"k_L_privacy",DEREGISTER_ID:"k_L_deregister_title",CONTACT_US_ID:"k_L_contact_us",OFFLINE_LOGOUT_TITLE:"k_dialog_offlineLogout_Title",OFFLINE_LOGOUT_TEXT:"k_dialog_offlineLogout_Text",DB_BLOCKED_TITLE:"k_dialog_dbBlocked_Title",DB_BLOCKED_TEXT:"k_dialog_dbBlocked_Text",PREV_SIGNOUT_FAILED_TITLE:"k_dialog_prevSignOutFailed_Title",PREV_SIGNOUT_FAILED_TEXT:"k_dialog_prevSignOutFailed_Text"},g={ITEM_HELP:"kindleLibrary_settingsMenu_item_help",
ITEM_TERMS:"kindleLibrary_settingsMenu_item_terms",ITEM_LEGAL:"kindleLibrary_settingsMenu_item_legal",ITEM_PRIVACY:"kindleLibrary_settingsMenu_item_privacy",ITEM_CONTACT_US:"kindleLibrary_settingsMenu_item_contactUs",ITEM_DEREGISTER:"kindleLibrary_settingsMenu_item_signOut"},b;return{show:function(a){b=a;a={componentName:c,menuItems:h(),buttonID:"kindleLibrary_button_manage",position:"down",title:null,isAppBarMenu:!1,enabledFlags:null};KindleUXComponentManager.showMenu(a)},hide:d}}(),KindleLibrarySortMenu=
function(){function f(d){function c(a,b,c){return{elementId:a,content:b,clickHandler:c}}var a={};a.ITEM_SORT_RECENT=c(e.ITEM_SORT_RECENT,ResourceBundle.getLocalizedString(h.SORT_RECENT),function(){KindleLibrarySortMenu.hide();d("recent")});a.ITEM_SORT_AUTHOR=c(e.ITEM_SORT_AUTHOR,ResourceBundle.getLocalizedString(h.SORT_AUTHOR),function(){KindleLibrarySortMenu.hide();d("author")});a.ITEM_SORT_TITLE=c(e.ITEM_SORT_TITLE,ResourceBundle.getLocalizedString(h.SORT_TITLE),function(){KindleLibrarySortMenu.hide();
d("title")});return a}var h={SORT_RECENT:"k_L_sort_recent",SORT_AUTHOR:"k_L_sort_author",SORT_TITLE:"k_L_sort_title"},e={ITEM_SORT_RECENT:"kindleLibrary_sortMenuItem_sortByRecent",ITEM_SORT_AUTHOR:"kindleLibrary_sortMenuItem_sortByAuthor",ITEM_SORT_TITLE:"kindleLibrary_sortMenuItem_sortByTitle"};return{show:function(d,c){var a={componentName:"KindleLibrarySortMenu",menuItems:f(c),buttonID:"kindleLibrary_button_sort",position:d,title:null,isAppBarMenu:!1,enabledFlags:null};KindleUXComponentManager.showMenu(a)},
hide:function(){KindleUXComponentManager.hideMenu("KindleLibrarySortMenu")}}}(),KindleUnsupportedContentDialog=function(){function f(){KindleUXComponentManager.closeDialog(e)}function h(){c.emit("UnsupportedContentDialog::GetAppLink")}var e="KindleUnsupportedContentDialog",d=KindleHostDeviceDetector.isiOS(),c,a={textMeWidgetWrapper:"#unsupportedContent_text_me_widget_wrapper",getApp:"#unsupportedContent_get_app_button"},g={getDialogSettings:function(){var a={};a[ResourceBundle.getLocalizedString("k_common_close_button")]=
f;return{width:"500px",autoOpen:!1,modal:!0,draggable:!1,resizable:!1,buttons:a}},beforeDialogOpen:function(b){if(b.find(".textMe_widget").length===0){var c=new KindleTextMeWidget({showAppleLogo:!0,showWindowsLogo:!1,showAmazonLogo:!0,showAndroidLogo:!0},e);b.find(a.textMeWidgetWrapper).append(c);b.find("#"+a.getApp).click(h)}}};return{open:function(){var a=KindleModuleManager.getModuleSync(KindleModuleManager.LINK_URLS);c||(c=KindleModuleManager.getModuleSync(KindleModuleManager.METRICS_MANAGER));
a={getAppLink:a.getKCPLandingPageLink(),isiPad:d};KindleUXComponentManager.openDialog(e,g,a)}}}();
function KindleBadgingFactory(){return{drawBadge:function(f,h,e){var d=Math.PI/180,c=36/Math.sqrt(2),a=(c-10)/2,g=f.getContext("2d");g.fillStyle=e;g.beginPath();g.rotate(45*d);g.fillRect(0,0,500,-c);g.stroke();g.beginPath();g.fillStyle="#FFFFFF";g.font="10pt Helvetica";g.opacity=0.95;g.fillText(h,f.width/2-(h.length>5?(h.length-5)*4:0),-a);g.stroke()},createCanvasElement:function(){var f=document.createElement("canvas");f.className="canvas_for_badge";f.height=100;f.width=100;return f},pushAsinForBadgeUpdate:function(f){var h=
JSON.parse(KindleLocalStorage.getItem("listOfAsinsForBadging"));if(h){var e;a:{for(e in h)if(h[e]===f){e=!0;break a}e=!1}e||(h[h.length]=f,KindleLocalStorage.setItem("listOfAsinsForBadging",JSON.stringify(h)))}else h=[],h[0]=f,KindleLocalStorage.setItem("listOfAsinsForBadging",JSON.stringify(h))},addBadgeToBookContainer:function(f,h,e){e.find(".book_cover").append("<div class='book_image_container'></div>");e.find(".book_image").appendTo(e.find(".book_image_container"));var d=$("<div>").addClass("book_badge_container");
d.append(h);e.find(".book_image_container").append(d);e.find(".book_details").append(f);e.find(".canvas_for_badge").addClass("book_click_area")},adjustBadge:function(f){f.find(".book_image_container").find(".book_click_area").hasClass("book_image_wide")&&f.find(".book_image_container").addClass("wide")},cloneCanvasForBadge:function(f){var h=document.createElement("canvas"),e=h.getContext("2d");h.width=f.width;h.height=f.height;h.className=f.className;e.drawImage(f,0,0);return h}}}
var KindleBadging=KindleBadgingFactory();
